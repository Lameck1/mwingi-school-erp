[{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\.dependency-cruiser.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\__mocks__\\fileMock.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\__tests__\\integration\\workflows.integration.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\__tests__\\ipc-handlers.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\__tests__\\modular-ipc.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\__tests__\\security.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\backup-service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\migrations\\current\\0001_initial_schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\migrations\\current\\0010_seed_core_data.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\migrations\\current\\0020_seed_academic_data.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\migrations\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\schema\\000_initial_schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\schema\\fragments\\010_core_schema.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'up' has too many lines (745). Maximum allowed is 80.","line":3,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":857,"endColumn":2},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (765). Maximum allowed is 500.","line":584,"column":1,"nodeType":null,"messageId":"exceed","endLine":879,"endColumn":1}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type Database } from 'better-sqlite3';\r\n\r\nexport function up(db: Database): void {\r\n  console.warn('Running Migration 001: Initial Schema');\r\n\r\n  // ============================================================================\r\n  // 1. CORE SYSTEM & SCHOOL SETTINGS\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS school_settings (\r\n      id INTEGER PRIMARY KEY DEFAULT 1 CHECK (id = 1),\r\n      school_name TEXT NOT NULL DEFAULT 'Mwingi Adventist School',\r\n      school_motto TEXT, address TEXT, phone TEXT, email TEXT, logo_path TEXT,\r\n      mpesa_paybill TEXT, sms_api_key TEXT, sms_api_secret TEXT, sms_sender_id TEXT,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n    \r\n    CREATE TABLE IF NOT EXISTS user (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT NOT NULL UNIQUE,\r\n      password_hash TEXT NOT NULL, full_name TEXT NOT NULL, email TEXT,\r\n      role TEXT NOT NULL CHECK(role IN ('ADMIN', 'ACCOUNTS_CLERK', 'AUDITOR', 'TEACHER', 'PRINCIPAL', 'DEPUTY_PRINCIPAL')),\r\n      is_active BOOLEAN DEFAULT 1, last_login DATETIME,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS audit_log (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER NOT NULL,\r\n      action_type TEXT NOT NULL, table_name TEXT NOT NULL, record_id INTEGER,\r\n      old_values TEXT, new_values TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (user_id) REFERENCES user(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS backup_log (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, backup_path TEXT NOT NULL,\r\n      backup_size INTEGER, backup_type TEXT NOT NULL, status TEXT DEFAULT 'SUCCESS',\r\n      error_message TEXT, created_by_user_id INTEGER, created_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n    \r\n    CREATE TABLE IF NOT EXISTS message_template (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, template_name TEXT NOT NULL UNIQUE,\r\n      template_type TEXT NOT NULL CHECK(template_type IN ('SMS', 'EMAIL')),\r\n      category TEXT CHECK(category IN ('FEE_REMINDER', 'PAYMENT_RECEIPT', 'ATTENDANCE', 'GENERAL', 'PAYSLIP')),\r\n      subject TEXT, body TEXT NOT NULL, placeholders TEXT, is_active BOOLEAN DEFAULT 1,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS message_log (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, template_id INTEGER,\r\n      recipient_type TEXT NOT NULL, recipient_id INTEGER, recipient_contact TEXT NOT NULL,\r\n      message_type TEXT NOT NULL, subject TEXT, message_body TEXT NOT NULL,\r\n      status TEXT DEFAULT 'PENDING', external_id TEXT, error_message TEXT,\r\n      sent_by_user_id INTEGER NOT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS system_config (\r\n        key TEXT PRIMARY KEY,\r\n        value TEXT NOT NULL,\r\n        is_encrypted BOOLEAN DEFAULT 0,\r\n        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n  `);\r\n\r\n  // ============================================================================\r\n  // 2. ACADEMIC STRUCTURE (Years, Terms, Streams, Students)\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS academic_year (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, year_name TEXT NOT NULL UNIQUE,\r\n      start_date DATE NOT NULL, end_date DATE NOT NULL, is_current BOOLEAN DEFAULT 0,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS term (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, academic_year_id INTEGER NOT NULL,\r\n      term_number INTEGER NOT NULL, term_name TEXT NOT NULL,\r\n      start_date DATE NOT NULL, end_date DATE NOT NULL, is_current BOOLEAN DEFAULT 0,\r\n      status TEXT DEFAULT 'OPEN' CHECK(status IN ('OPEN', 'CLOSED')),\r\n      FOREIGN KEY (academic_year_id) REFERENCES academic_year(id), UNIQUE(academic_year_id, term_number)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS stream (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, stream_code TEXT NOT NULL UNIQUE,\r\n      stream_name TEXT NOT NULL, level_order INTEGER NOT NULL,\r\n      is_junior_secondary BOOLEAN DEFAULT 0, is_active BOOLEAN DEFAULT 1,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS student (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, admission_number TEXT NOT NULL UNIQUE,\r\n      first_name TEXT NOT NULL, middle_name TEXT, last_name TEXT NOT NULL,\r\n      date_of_birth DATE, gender TEXT CHECK(gender IN ('M', 'F')),\r\n      student_type TEXT NOT NULL CHECK(student_type IN ('DAY_SCHOLAR', 'BOARDER')),\r\n      admission_date DATE NOT NULL, guardian_name TEXT, guardian_phone TEXT,\r\n      guardian_email TEXT, guardian_relationship TEXT, address TEXT, photo_path TEXT,\r\n      is_active BOOLEAN DEFAULT 1, notes TEXT,\r\n      credit_balance INTEGER DEFAULT 0,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n    CREATE INDEX IF NOT EXISTS idx_student_admission ON student(admission_number);\r\n\r\n    CREATE TABLE IF NOT EXISTS enrollment (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, student_id INTEGER NOT NULL,\r\n      academic_year_id INTEGER NOT NULL, term_id INTEGER NOT NULL, stream_id INTEGER NOT NULL,\r\n      student_type TEXT NOT NULL CHECK(student_type IN ('DAY_SCHOLAR', 'BOARDER')),\r\n      enrollment_date DATE NOT NULL, status TEXT DEFAULT 'ACTIVE',\r\n      notes TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (student_id) REFERENCES student(id),\r\n      FOREIGN KEY (academic_year_id) REFERENCES academic_year(id),\r\n      FOREIGN KEY (stream_id) REFERENCES stream(id)\r\n    );\r\n    \r\n    CREATE TABLE IF NOT EXISTS staff (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, staff_number TEXT NOT NULL UNIQUE,\r\n      first_name TEXT NOT NULL, middle_name TEXT, last_name TEXT NOT NULL,\r\n      id_number TEXT, kra_pin TEXT, nhif_number TEXT, nssf_number TEXT,\r\n      phone TEXT, email TEXT, bank_name TEXT, bank_account TEXT,\r\n      department TEXT, job_title TEXT, employment_date DATE,\r\n      basic_salary INTEGER DEFAULT 0, is_active BOOLEAN DEFAULT 1,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n  `);\r\n\r\n  // ============================================================================\r\n  // 3. FINANCE - CHART OF ACCOUNTS & LEDGER\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS gl_account (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      account_code TEXT NOT NULL UNIQUE,\r\n      account_name TEXT NOT NULL,\r\n      account_type TEXT NOT NULL CHECK(account_type IN ('ASSET', 'LIABILITY', 'EQUITY', 'REVENUE', 'EXPENSE')),\r\n      account_subtype TEXT,\r\n      parent_account_id INTEGER,\r\n      is_system_account BOOLEAN DEFAULT 0,\r\n      is_active BOOLEAN DEFAULT 1,\r\n      requires_subsidiary BOOLEAN DEFAULT 0,\r\n      normal_balance TEXT NOT NULL CHECK(normal_balance IN ('DEBIT', 'CREDIT')),\r\n      description TEXT,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (parent_account_id) REFERENCES gl_account(id)\r\n    );\r\n    CREATE INDEX IF NOT EXISTS idx_gl_account_code ON gl_account(account_code);\r\n\r\n    CREATE TABLE IF NOT EXISTS journal_entry (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      entry_ref TEXT NOT NULL UNIQUE,\r\n      entry_date DATE NOT NULL,\r\n      entry_type TEXT NOT NULL CHECK(entry_type IN (\r\n        'FEE_PAYMENT', 'EXPENSE', 'SALARY', 'REFUND', \r\n        'OPENING_BALANCE', 'ADJUSTMENT', 'ASSET_PURCHASE', \r\n        'ASSET_DISPOSAL', 'LOAN_DISBURSEMENT', 'LOAN_REPAYMENT'\r\n      )),\r\n      description TEXT NOT NULL,\r\n      student_id INTEGER,\r\n      staff_id INTEGER,\r\n      term_id INTEGER,\r\n      is_posted BOOLEAN DEFAULT 0,\r\n      posted_by_user_id INTEGER, posted_at DATETIME,\r\n      is_voided BOOLEAN DEFAULT 0, voided_reason TEXT, voided_by_user_id INTEGER, voided_at DATETIME,\r\n      requires_approval BOOLEAN DEFAULT 0,\r\n      approval_status TEXT DEFAULT 'PENDING' CHECK(approval_status IN ('PENDING', 'APPROVED', 'REJECTED')),\r\n      approved_by_user_id INTEGER, approved_at DATETIME,\r\n      created_by_user_id INTEGER NOT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (student_id) REFERENCES student(id),\r\n      FOREIGN KEY (staff_id) REFERENCES staff(id),\r\n      FOREIGN KEY (term_id) REFERENCES term(id),\r\n      FOREIGN KEY (created_by_user_id) REFERENCES user(id)\r\n    );\r\n    CREATE INDEX IF NOT EXISTS idx_journal_entry_ref ON journal_entry(entry_ref);\r\n\r\n    CREATE TABLE IF NOT EXISTS journal_entry_line (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      journal_entry_id INTEGER NOT NULL,\r\n      line_number INTEGER NOT NULL,\r\n      gl_account_id INTEGER NOT NULL,\r\n      debit_amount INTEGER DEFAULT 0,\r\n      credit_amount INTEGER DEFAULT 0,\r\n      description TEXT,\r\n      FOREIGN KEY (journal_entry_id) REFERENCES journal_entry(id) ON DELETE CASCADE,\r\n      FOREIGN KEY (gl_account_id) REFERENCES gl_account(id),\r\n      CHECK (debit_amount >= 0 AND credit_amount >= 0)\r\n    );\r\n    \r\n    CREATE TABLE IF NOT EXISTS opening_balance (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      academic_year_id INTEGER NOT NULL,\r\n      gl_account_id INTEGER,\r\n      student_id INTEGER,\r\n      debit_amount INTEGER DEFAULT 0,\r\n      credit_amount INTEGER DEFAULT 0,\r\n      description TEXT,\r\n      imported_from TEXT, imported_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      imported_by_user_id INTEGER NOT NULL,\r\n      is_verified BOOLEAN DEFAULT 0, verified_by_user_id INTEGER, verified_at DATETIME,\r\n      FOREIGN KEY (academic_year_id) REFERENCES academic_year(id),\r\n      FOREIGN KEY (gl_account_id) REFERENCES gl_account(id),\r\n      FOREIGN KEY (student_id) REFERENCES student(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS ledger_reconciliation (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      reconciliation_date DATE NOT NULL,\r\n      gl_account_id INTEGER NOT NULL,\r\n      opening_balance INTEGER NOT NULL,\r\n      total_debits INTEGER NOT NULL, total_credits INTEGER NOT NULL,\r\n      closing_balance INTEGER NOT NULL, calculated_balance INTEGER NOT NULL,\r\n      variance INTEGER NOT NULL, is_balanced BOOLEAN DEFAULT 0,\r\n      reconciled_by_user_id INTEGER NOT NULL, notes TEXT,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (gl_account_id) REFERENCES gl_account(id),\r\n      FOREIGN KEY (reconciled_by_user_id) REFERENCES user(id)\r\n    );\r\n    \r\n    CREATE TABLE IF NOT EXISTS approval_rule (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      rule_name TEXT NOT NULL, transaction_type TEXT NOT NULL,\r\n      min_amount INTEGER, max_amount INTEGER, days_since_transaction INTEGER,\r\n      required_approver_role TEXT NOT NULL, is_active BOOLEAN DEFAULT 1,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n    \r\n    CREATE TABLE IF NOT EXISTS transaction_approval (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      journal_entry_id INTEGER NOT NULL, approval_rule_id INTEGER NOT NULL,\r\n      requested_by_user_id INTEGER NOT NULL, requested_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      status TEXT DEFAULT 'PENDING' CHECK(status IN ('PENDING', 'APPROVED', 'REJECTED')),\r\n      reviewed_by_user_id INTEGER, reviewed_at DATETIME, review_notes TEXT,\r\n      FOREIGN KEY (journal_entry_id) REFERENCES journal_entry(id),\r\n      FOREIGN KEY (approval_rule_id) REFERENCES approval_rule(id),\r\n      FOREIGN KEY (requested_by_user_id) REFERENCES user(id)\r\n    );\r\n  `);\r\n\r\n  // ============================================================================\r\n  // 4. FEES & BILLING\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS fee_category (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, category_name TEXT NOT NULL UNIQUE,\r\n      description TEXT, is_active BOOLEAN DEFAULT 1,\r\n      gl_account_id INTEGER REFERENCES gl_account(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS fee_structure (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, academic_year_id INTEGER NOT NULL,\r\n      stream_id INTEGER NOT NULL, student_type TEXT NOT NULL CHECK(student_type IN ('DAY_SCHOLAR', 'BOARDER')),\r\n      term_id INTEGER, fee_category_id INTEGER NOT NULL, amount INTEGER NOT NULL,\r\n      description TEXT, \r\n      condition_type TEXT DEFAULT 'ALL',\r\n      frequency TEXT DEFAULT 'PER_TERM',\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (academic_year_id) REFERENCES academic_year(id),\r\n      FOREIGN KEY (stream_id) REFERENCES stream(id),\r\n      FOREIGN KEY (fee_category_id) REFERENCES fee_category(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS fee_invoice (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, invoice_number TEXT NOT NULL UNIQUE,\r\n      student_id INTEGER NOT NULL, term_id INTEGER NOT NULL,\r\n      invoice_date DATE NOT NULL, due_date DATE NOT NULL,\r\n      total_amount INTEGER NOT NULL, amount_paid INTEGER DEFAULT 0,\r\n      status TEXT DEFAULT 'PENDING', notes TEXT, created_by_user_id INTEGER NOT NULL,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (student_id) REFERENCES student(id), FOREIGN KEY (created_by_user_id) REFERENCES user(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS invoice_item (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, invoice_id INTEGER NOT NULL,\r\n      fee_category_id INTEGER NOT NULL, description TEXT NOT NULL, amount INTEGER NOT NULL,\r\n      FOREIGN KEY (invoice_id) REFERENCES fee_invoice(id)\r\n    );\r\n\r\n    -- Legacy support: ledger_transaction (mapped to Journal Entry ideally, but kept for compatibility)\r\n    CREATE TABLE IF NOT EXISTS transaction_category (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, category_name TEXT NOT NULL,\r\n      category_type TEXT NOT NULL CHECK(category_type IN ('INCOME', 'EXPENSE')),\r\n      parent_category_id INTEGER, is_system BOOLEAN DEFAULT 0, is_active BOOLEAN DEFAULT 1\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS ledger_transaction (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, transaction_ref TEXT NOT NULL UNIQUE,\r\n      transaction_date DATE NOT NULL,\r\n      transaction_type TEXT NOT NULL CHECK(transaction_type IN ('FEE_PAYMENT', 'DONATION', 'GRANT', 'EXPENSE', 'SALARY_PAYMENT', 'REFUND', 'OPENING_BALANCE', 'ADJUSTMENT')),\r\n      category_id INTEGER NOT NULL, amount INTEGER NOT NULL,\r\n      debit_credit TEXT NOT NULL CHECK(debit_credit IN ('DEBIT', 'CREDIT')),\r\n      student_id INTEGER, staff_id INTEGER, invoice_id INTEGER,\r\n      payment_method TEXT CHECK(payment_method IN ('CASH', 'MPESA', 'BANK_TRANSFER', 'CHEQUE')),\r\n      payment_reference TEXT, description TEXT, term_id INTEGER,\r\n      recorded_by_user_id INTEGER NOT NULL, is_voided BOOLEAN DEFAULT 0,\r\n      voided_reason TEXT, voided_by_user_id INTEGER, voided_at DATETIME,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (category_id) REFERENCES transaction_category(id),\r\n      FOREIGN KEY (student_id) REFERENCES student(id),\r\n      FOREIGN KEY (invoice_id) REFERENCES fee_invoice(id),\r\n      FOREIGN KEY (recorded_by_user_id) REFERENCES user(id)\r\n    );\r\n    CREATE INDEX IF NOT EXISTS idx_ledger_date ON ledger_transaction(transaction_date);\r\n    CREATE INDEX IF NOT EXISTS idx_ledger_student ON ledger_transaction(student_id);\r\n\r\n    CREATE TABLE IF NOT EXISTS receipt (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, receipt_number TEXT NOT NULL UNIQUE,\r\n      transaction_id INTEGER NOT NULL UNIQUE, receipt_date DATE NOT NULL,\r\n      student_id INTEGER NOT NULL, amount INTEGER NOT NULL,\r\n      amount_in_words TEXT, payment_method TEXT NOT NULL, payment_reference TEXT,\r\n      printed_count INTEGER DEFAULT 0, created_by_user_id INTEGER NOT NULL,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (transaction_id) REFERENCES ledger_transaction(id),\r\n      FOREIGN KEY (student_id) REFERENCES student(id)\r\n    );\r\n  `);\r\n\r\n  // ============================================================================\r\n  // 5. PAYROLL\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS payroll_period (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, period_name TEXT NOT NULL,\r\n      month INTEGER NOT NULL, year INTEGER NOT NULL,\r\n      start_date DATE NOT NULL, end_date DATE NOT NULL,\r\n      status TEXT DEFAULT 'DRAFT', approved_by_user_id INTEGER, approved_at DATETIME,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP, UNIQUE(month, year)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS payroll (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, period_id INTEGER NOT NULL, staff_id INTEGER NOT NULL,\r\n      basic_salary INTEGER NOT NULL, gross_salary INTEGER NOT NULL,\r\n      total_deductions INTEGER NOT NULL, net_salary INTEGER NOT NULL,\r\n      payment_status TEXT DEFAULT 'PENDING', payment_date DATE, transaction_id INTEGER,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (period_id) REFERENCES payroll_period(id), FOREIGN KEY (staff_id) REFERENCES staff(id),\r\n      UNIQUE(period_id, staff_id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS payroll_deduction (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, payroll_id INTEGER NOT NULL,\r\n      deduction_name TEXT NOT NULL, amount INTEGER NOT NULL,\r\n      FOREIGN KEY (payroll_id) REFERENCES payroll(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS payroll_allowance (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, payroll_id INTEGER NOT NULL,\r\n      allowance_name TEXT NOT NULL, amount INTEGER NOT NULL,\r\n      FOREIGN KEY (payroll_id) REFERENCES payroll(id)\r\n    );\r\n    \r\n    CREATE TABLE IF NOT EXISTS statutory_rates (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, rate_type TEXT NOT NULL,\r\n      min_amount DECIMAL(12, 2), max_amount DECIMAL(12, 2),\r\n      rate DECIMAL(6, 4), fixed_amount DECIMAL(12, 2),\r\n      effective_from DATE NOT NULL, effective_to DATE, is_current BOOLEAN DEFAULT 1\r\n    );\r\n  `);\r\n\r\n  // ============================================================================\r\n  // 6. INVENTORY\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS inventory_category (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, category_name TEXT NOT NULL UNIQUE,\r\n      description TEXT, is_active BOOLEAN DEFAULT 1\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS supplier (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, supplier_name TEXT NOT NULL,\r\n      contact_person TEXT, phone TEXT, email TEXT, address TEXT,\r\n      is_active BOOLEAN DEFAULT 1, created_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS inventory_item (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, item_code TEXT NOT NULL UNIQUE,\r\n      item_name TEXT NOT NULL, category_id INTEGER NOT NULL, unit_of_measure TEXT NOT NULL,\r\n      current_stock DECIMAL(12, 2) DEFAULT 0, reorder_level DECIMAL(12, 2) DEFAULT 0,\r\n      unit_cost DECIMAL(12, 2) DEFAULT 0, is_active BOOLEAN DEFAULT 1,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (category_id) REFERENCES inventory_category(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS stock_movement (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, item_id INTEGER NOT NULL,\r\n      movement_type TEXT NOT NULL CHECK(movement_type IN ('IN', 'OUT', 'ADJUSTMENT')),\r\n      quantity DECIMAL(12, 2) NOT NULL, unit_cost DECIMAL(12, 2), total_cost DECIMAL(12, 2),\r\n      reference_number TEXT, supplier_id INTEGER, description TEXT, movement_date DATE NOT NULL,\r\n      recorded_by_user_id INTEGER NOT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (item_id) REFERENCES inventory_item(id)\r\n    );\r\n  `);\r\n\r\n  // ============================================================================\r\n  // 7. ACADEMIC & CBC FEATURES\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS subject (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      code TEXT NOT NULL UNIQUE, name TEXT NOT NULL, \r\n      curriculum TEXT NOT NULL CHECK(curriculum IN ('8-4-4', 'CBC', 'ECDE')), \r\n      is_compulsory BOOLEAN DEFAULT 0, is_active BOOLEAN DEFAULT 1,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS subject_allocation (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      academic_year_id INTEGER NOT NULL, term_id INTEGER NOT NULL,\r\n      stream_id INTEGER NOT NULL, subject_id INTEGER NOT NULL, teacher_id INTEGER NOT NULL,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (stream_id) REFERENCES stream(id), FOREIGN KEY (teacher_id) REFERENCES staff(id),\r\n      FOREIGN KEY (subject_id) REFERENCES subject(id), UNIQUE(academic_year_id, term_id, stream_id, subject_id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS grading_scale (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      curriculum TEXT NOT NULL CHECK(curriculum IN ('8-4-4', 'CBC', 'ECDE')),\r\n      grade TEXT NOT NULL, min_score INTEGER NOT NULL, max_score INTEGER NOT NULL,\r\n      points INTEGER, remarks TEXT, is_active BOOLEAN DEFAULT 1\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS exam (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      exam_name TEXT NOT NULL,\r\n      academic_year_id INTEGER NOT NULL, term_id INTEGER NOT NULL,\r\n      start_date DATE, end_date DATE,\r\n      is_active BOOLEAN DEFAULT 1,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (academic_year_id) REFERENCES academic_year(id)\r\n    );\r\n  `);\r\n\r\n  // ============================================================================\r\n  // 8. REPORTING & SCHEDULING\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS scheduled_report (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      report_name TEXT NOT NULL,\r\n      report_type TEXT NOT NULL,\r\n      parameters TEXT, -- JSON configuration\r\n      schedule_type TEXT NOT NULL CHECK(schedule_type IN ('DAILY', 'WEEKLY', 'MONTHLY', 'TERM_END', 'YEAR_END')),\r\n      day_of_week INTEGER, -- 0-6 (Sunday-Saturday)\r\n      day_of_month INTEGER, -- 1-31\r\n      time_of_day TEXT NOT NULL, -- HH:mm\r\n      recipients TEXT NOT NULL, -- JSON array of emails\r\n      export_format TEXT DEFAULT 'PDF' CHECK(export_format IN ('PDF', 'EXCEL', 'CSV')),\r\n      is_active BOOLEAN DEFAULT 1,\r\n      last_run_at DATETIME,\r\n      next_run_at DATETIME,\r\n      created_by_user_id INTEGER NOT NULL,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (created_by_user_id) REFERENCES user(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS report_execution_log (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      scheduled_report_id INTEGER NOT NULL,\r\n      execution_time DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      status TEXT NOT NULL CHECK(status IN ('SUCCESS', 'FAILED')),\r\n      recipients_notified INTEGER DEFAULT 0,\r\n      error_message TEXT,\r\n      file_path TEXT,\r\n      FOREIGN KEY (scheduled_report_id) REFERENCES scheduled_report(id) ON DELETE CASCADE\r\n    );\r\n    CREATE INDEX IF NOT EXISTS idx_scheduled_report_active ON scheduled_report(is_active);\r\n    CREATE INDEX IF NOT EXISTS idx_report_log_report ON report_execution_log(scheduled_report_id);\r\n  `);\r\n\r\n  // ============================================================================\r\n  // 9. EXAM RESULTS & CBC FEATURES\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS exam_result (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      exam_id INTEGER NOT NULL, student_id INTEGER NOT NULL, subject_id INTEGER NOT NULL,\r\n      score DECIMAL(5, 2), competency_level INTEGER, teacher_remarks TEXT,\r\n      entered_by_user_id INTEGER, created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (exam_id) REFERENCES exam(id), FOREIGN KEY (student_id) REFERENCES student(id),\r\n      FOREIGN KEY (subject_id) REFERENCES subject(id), UNIQUE(exam_id, student_id, subject_id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS report_card_summary (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      exam_id INTEGER NOT NULL, student_id INTEGER NOT NULL,\r\n      total_marks DECIMAL(6, 2), mean_score DECIMAL(5, 2), mean_grade TEXT,\r\n      stream_position INTEGER, class_position INTEGER,\r\n      class_teacher_remarks TEXT, principal_remarks TEXT,\r\n      generated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (exam_id) REFERENCES exam(id), FOREIGN KEY (student_id) REFERENCES student(id),\r\n      UNIQUE(exam_id, student_id)\r\n    );\r\n    \r\n    CREATE TABLE IF NOT EXISTS cbc_strand (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT, code TEXT NOT NULL UNIQUE,\r\n      name TEXT NOT NULL, description TEXT, budget_gl_account_code TEXT,\r\n      is_active BOOLEAN NOT NULL DEFAULT 1,\r\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS fee_category_strand (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      fee_category_id INTEGER NOT NULL, cbc_strand_id INTEGER NOT NULL,\r\n      allocation_percentage REAL NOT NULL DEFAULT 100.0,\r\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (fee_category_id) REFERENCES fee_category(id) ON DELETE CASCADE,\r\n      FOREIGN KEY (cbc_strand_id) REFERENCES cbc_strand(id) ON DELETE CASCADE,\r\n      UNIQUE(fee_category_id, cbc_strand_id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS cbc_strand_expense (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      cbc_strand_id INTEGER NOT NULL, gl_account_code TEXT NOT NULL,\r\n      fiscal_year INTEGER NOT NULL, allocated_budget INTEGER NOT NULL DEFAULT 0,\r\n      spent_amount INTEGER NOT NULL DEFAULT 0, description TEXT,\r\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (cbc_strand_id) REFERENCES cbc_strand(id) ON DELETE CASCADE\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS student_activity_participation (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      student_id INTEGER NOT NULL, cbc_strand_id INTEGER NOT NULL,\r\n      academic_year INTEGER NOT NULL, term INTEGER NOT NULL CHECK (term IN (1, 2, 3)),\r\n      participation_level TEXT NOT NULL CHECK (participation_level IN ('PRIMARY', 'SECONDARY', 'INTEREST')),\r\n      notes TEXT,\r\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (student_id) REFERENCES student(id) ON DELETE CASCADE,\r\n      FOREIGN KEY (cbc_strand_id) REFERENCES cbc_strand(id) ON DELETE CASCADE,\r\n      UNIQUE(student_id, cbc_strand_id, academic_year, term)\r\n    );\r\n  `);\r\n\r\n  // ============================================================================\r\n  // 10. MERIT LISTS & AWARDS\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS merit_list (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      academic_year_id INTEGER NOT NULL, term_id INTEGER NOT NULL,\r\n      stream_id INTEGER NOT NULL, exam_id INTEGER,\r\n      list_type TEXT NOT NULL CHECK(list_type IN ('overall', 'subject')),\r\n      subject_id INTEGER, generated_date TEXT NOT NULL, generated_by_user_id INTEGER,\r\n      total_students INTEGER, remarks TEXT,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (academic_year_id) REFERENCES academic_year(id),\r\n      FOREIGN KEY (term_id) REFERENCES term(id),\r\n      FOREIGN KEY (stream_id) REFERENCES stream(id),\r\n      FOREIGN KEY (exam_id) REFERENCES exam(id),\r\n      FOREIGN KEY (subject_id) REFERENCES subject(id),\r\n      UNIQUE(academic_year_id, term_id, stream_id, exam_id, list_type)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS merit_list_entry (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      merit_list_id INTEGER NOT NULL, student_id INTEGER NOT NULL,\r\n      position INTEGER NOT NULL, total_marks REAL NOT NULL,\r\n      average_marks REAL NOT NULL, grade TEXT, percentage REAL NOT NULL,\r\n      class_position INTEGER, stream_position INTEGER, tied_count INTEGER DEFAULT 1,\r\n      remarks TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (merit_list_id) REFERENCES merit_list(id),\r\n      FOREIGN KEY (student_id) REFERENCES student(id),\r\n      UNIQUE(merit_list_id, student_id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS subject_merit_entry (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      subject_id INTEGER NOT NULL, academic_year_id INTEGER NOT NULL,\r\n      term_id INTEGER NOT NULL, exam_id INTEGER NOT NULL,\r\n      student_id INTEGER NOT NULL, stream_id INTEGER NOT NULL,\r\n      position INTEGER NOT NULL, marks REAL NOT NULL, percentage REAL NOT NULL,\r\n      grade TEXT, teacher_id INTEGER, subject_difficulty_index REAL, remarks TEXT,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (subject_id) REFERENCES subject(id),\r\n      FOREIGN KEY (academic_year_id) REFERENCES academic_year(id),\r\n      FOREIGN KEY (term_id) REFERENCES term(id),\r\n      FOREIGN KEY (exam_id) REFERENCES exam(id),\r\n      FOREIGN KEY (student_id) REFERENCES student(id),\r\n      FOREIGN KEY (stream_id) REFERENCES stream(id),\r\n      UNIQUE(exam_id, student_id, subject_id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS award_category (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      name TEXT NOT NULL UNIQUE,\r\n      category_type TEXT NOT NULL CHECK(category_type IN ('academic_excellence', 'improvement', 'discipline', 'sports', 'arts', 'agriculture', 'other')),\r\n      description TEXT, criteria TEXT, minimum_threshold REAL,\r\n      is_automatic BOOLEAN DEFAULT 0, requires_approval BOOLEAN DEFAULT 1,\r\n      is_active BOOLEAN DEFAULT 1, sort_order INTEGER DEFAULT 0,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS student_award (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      student_id INTEGER NOT NULL, \r\n      award_category_id INTEGER NOT NULL,\r\n      academic_year_id INTEGER NOT NULL, \r\n      term_id INTEGER,\r\n      awarded_date TEXT DEFAULT (datetime('now')), \r\n      certificate_number TEXT, \r\n      remarks TEXT,\r\n      approval_status TEXT DEFAULT 'pending' CHECK(approval_status IN ('pending', 'approved', 'rejected')),\r\n      assigned_by_user_id INTEGER,\r\n      approved_by_user_id INTEGER,\r\n      approved_at DATETIME,\r\n      rejection_reason TEXT,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (student_id) REFERENCES student(id),\r\n      FOREIGN KEY (award_category_id) REFERENCES award_category(id),\r\n      FOREIGN KEY (assigned_by_user_id) REFERENCES user(id),\r\n      FOREIGN KEY (approved_by_user_id) REFERENCES user(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS performance_improvement (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      student_id INTEGER NOT NULL, subject_id INTEGER,\r\n      academic_year_id INTEGER NOT NULL, term_id INTEGER NOT NULL,\r\n      previous_exam_id INTEGER, current_exam_id INTEGER,\r\n      previous_score REAL, current_score REAL, deviation REAL,\r\n      improvement_percentage REAL, is_significant BOOLEAN DEFAULT 0,\r\n      FOREIGN KEY (student_id) REFERENCES student(id),\r\n      FOREIGN KEY (subject_id) REFERENCES subject(id),\r\n      UNIQUE(student_id, current_exam_id, subject_id)\r\n    );\r\n  `);\r\n\r\n  // ============================================================================\r\n  // 11. BUDGETING\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS budget (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      budget_name TEXT NOT NULL,\r\n      academic_year_id INTEGER NOT NULL,\r\n      term_id INTEGER,\r\n      status TEXT DEFAULT 'DRAFT' CHECK(status IN ('DRAFT', 'SUBMITTED', 'APPROVED', 'REJECTED', 'ACTIVE', 'CLOSED')),\r\n      total_amount INTEGER DEFAULT 0,\r\n      notes TEXT,\r\n      created_by_user_id INTEGER NOT NULL,\r\n      approved_by_user_id INTEGER,\r\n      approved_at DATETIME,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      deleted_at DATETIME DEFAULT NULL,\r\n      FOREIGN KEY (academic_year_id) REFERENCES academic_year(id),\r\n      FOREIGN KEY (term_id) REFERENCES term(id),\r\n      FOREIGN KEY (created_by_user_id) REFERENCES user(id),\r\n      FOREIGN KEY (approved_by_user_id) REFERENCES user(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS budget_line_item (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      budget_id INTEGER NOT NULL,\r\n      category_id INTEGER NOT NULL,\r\n      description TEXT NOT NULL,\r\n      budgeted_amount INTEGER NOT NULL DEFAULT 0,\r\n      actual_amount INTEGER DEFAULT 0,\r\n      variance INTEGER GENERATED ALWAYS AS (budgeted_amount - actual_amount) STORED,\r\n      notes TEXT,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (budget_id) REFERENCES budget(id) ON DELETE CASCADE,\r\n      FOREIGN KEY (category_id) REFERENCES transaction_category(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS budget_revision (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      budget_id INTEGER NOT NULL,\r\n      revision_number INTEGER NOT NULL,\r\n      previous_amount INTEGER NOT NULL,\r\n      new_amount INTEGER NOT NULL,\r\n      reason TEXT NOT NULL,\r\n      revised_by_user_id INTEGER NOT NULL,\r\n      approved_by_user_id INTEGER,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (budget_id) REFERENCES budget(id),\r\n      FOREIGN KEY (revised_by_user_id) REFERENCES user(id),\r\n      FOREIGN KEY (approved_by_user_id) REFERENCES user(id)\r\n    );\r\n  `);\r\n\r\n  // ============================================================================\r\n  // 12. BANK RECONCILIATION\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS bank_account (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      account_name TEXT NOT NULL,\r\n      account_number TEXT NOT NULL,\r\n      bank_name TEXT NOT NULL,\r\n      branch TEXT,\r\n      swift_code TEXT,\r\n      currency TEXT DEFAULT 'KES',\r\n      opening_balance INTEGER DEFAULT 0,\r\n      current_balance INTEGER DEFAULT 0,\r\n      is_active BOOLEAN DEFAULT 1,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS bank_statement (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      bank_account_id INTEGER NOT NULL,\r\n      statement_date DATE NOT NULL,\r\n      opening_balance INTEGER NOT NULL,\r\n      closing_balance INTEGER NOT NULL,\r\n      statement_reference TEXT,\r\n      file_path TEXT,\r\n      status TEXT DEFAULT 'PENDING' CHECK(status IN ('PENDING', 'RECONCILED', 'PARTIAL')),\r\n      reconciled_by_user_id INTEGER,\r\n      reconciled_at DATETIME,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (bank_account_id) REFERENCES bank_account(id),\r\n      FOREIGN KEY (reconciled_by_user_id) REFERENCES user(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS bank_statement_line (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      bank_statement_id INTEGER NOT NULL,\r\n      transaction_date DATE NOT NULL,\r\n      description TEXT NOT NULL,\r\n      reference TEXT,\r\n      debit_amount INTEGER DEFAULT 0,\r\n      credit_amount INTEGER DEFAULT 0,\r\n      running_balance INTEGER,\r\n      is_matched BOOLEAN DEFAULT 0,\r\n      matched_transaction_id INTEGER,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (bank_statement_id) REFERENCES bank_statement(id) ON DELETE CASCADE,\r\n      FOREIGN KEY (matched_transaction_id) REFERENCES ledger_transaction(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS reconciliation_adjustment (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      bank_statement_id INTEGER NOT NULL,\r\n      adjustment_type TEXT NOT NULL CHECK(adjustment_type IN ('BANK_CHARGE', 'INTEREST', 'ERROR', 'TIMING', 'OTHER')),\r\n      amount INTEGER NOT NULL,\r\n      description TEXT NOT NULL,\r\n      created_by_user_id INTEGER NOT NULL,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (bank_statement_id) REFERENCES bank_statement(id),\r\n      FOREIGN KEY (created_by_user_id) REFERENCES user(id)\r\n    );\r\n  `);\r\n\r\n  // ============================================================================\r\n  // 13. APPROVAL WORKFLOWS\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS approval_workflow (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      workflow_name TEXT NOT NULL UNIQUE,\r\n      entity_type TEXT NOT NULL UNIQUE,\r\n      is_active BOOLEAN DEFAULT 1,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS approval_request (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      workflow_id INTEGER NOT NULL,\r\n      entity_type TEXT NOT NULL,\r\n      entity_id INTEGER NOT NULL,\r\n      current_step INTEGER DEFAULT 1,\r\n      status TEXT NOT NULL DEFAULT 'PENDING' CHECK (status IN ('PENDING','APPROVED','REJECTED','CANCELLED')),\r\n      requested_by_user_id INTEGER NOT NULL,\r\n      final_approver_user_id INTEGER,\r\n      completed_at DATETIME,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (workflow_id) REFERENCES approval_workflow(id),\r\n      FOREIGN KEY (requested_by_user_id) REFERENCES user(id),\r\n      FOREIGN KEY (final_approver_user_id) REFERENCES user(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS approval_history (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      approval_request_id INTEGER NOT NULL,\r\n      action TEXT NOT NULL CHECK (action IN ('REQUESTED','APPROVED','REJECTED','CANCELLED')),\r\n      action_by INTEGER NOT NULL,\r\n      action_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      previous_status TEXT,\r\n      new_status TEXT,\r\n      notes TEXT,\r\n      FOREIGN KEY (approval_request_id) REFERENCES approval_request(id) ON DELETE CASCADE,\r\n      FOREIGN KEY (action_by) REFERENCES user(id)\r\n    );\r\n  `);\r\n  // ============================================================================\r\n  // 14. RECOVERED MISSING TABLES\r\n  // ============================================================================\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS attendance (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      student_id INTEGER NOT NULL,\r\n      stream_id INTEGER NOT NULL,\r\n      academic_year_id INTEGER NOT NULL,\r\n      term_id INTEGER NOT NULL,\r\n      attendance_date DATE NOT NULL,\r\n      status TEXT NOT NULL CHECK(status IN ('PRESENT', 'ABSENT', 'LATE', 'EXCUSED')),\r\n      notes TEXT,\r\n      marked_by_user_id INTEGER NOT NULL,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (student_id) REFERENCES student(id),\r\n      FOREIGN KEY (stream_id) REFERENCES stream(id),\r\n      FOREIGN KEY (academic_year_id) REFERENCES academic_year(id),\r\n      FOREIGN KEY (term_id) REFERENCES term(id),\r\n      FOREIGN KEY (marked_by_user_id) REFERENCES user(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS financial_period (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      period_name TEXT NOT NULL,\r\n      period_type TEXT NOT NULL CHECK(period_type IN ('MONTHLY', 'QUARTERLY', 'YEARLY')),\r\n      start_date DATE NOT NULL,\r\n      end_date DATE NOT NULL,\r\n      academic_year_id INTEGER,\r\n      term_id INTEGER,\r\n      is_locked BOOLEAN DEFAULT 0,\r\n      locked_at DATETIME,\r\n      locked_by_user_id INTEGER,\r\n      unlock_reason TEXT,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (academic_year_id) REFERENCES academic_year(id),\r\n      FOREIGN KEY (term_id) REFERENCES term(id),\r\n      FOREIGN KEY (locked_by_user_id) REFERENCES user(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS asset_category (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      category_name TEXT NOT NULL UNIQUE,\r\n      depreciation_method TEXT DEFAULT 'STRAIGHT_LINE' CHECK(depreciation_method IN ('STRAIGHT_LINE', 'DECLINING_BALANCE', 'NONE')),\r\n      useful_life_years INTEGER DEFAULT 5,\r\n      depreciation_rate DECIMAL(5,2),\r\n      is_active BOOLEAN DEFAULT 1\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS fixed_asset (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      asset_code TEXT NOT NULL UNIQUE,\r\n      asset_name TEXT NOT NULL,\r\n      category_id INTEGER NOT NULL,\r\n      description TEXT,\r\n      serial_number TEXT,\r\n      location TEXT,\r\n      acquisition_date DATE NOT NULL,\r\n      acquisition_cost INTEGER NOT NULL,\r\n      current_value INTEGER NOT NULL,\r\n      accumulated_depreciation INTEGER DEFAULT 0,\r\n      status TEXT DEFAULT 'ACTIVE' CHECK(status IN ('ACTIVE', 'DISPOSED', 'WRITTEN_OFF', 'TRANSFERRED')),\r\n      disposed_date DATE,\r\n      disposed_value INTEGER,\r\n      disposal_reason TEXT,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (category_id) REFERENCES asset_category(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS staff_allowance (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      staff_id INTEGER NOT NULL,\r\n      allowance_name TEXT NOT NULL,\r\n      amount INTEGER NOT NULL DEFAULT 0,\r\n      is_active BOOLEAN DEFAULT 1,\r\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n      FOREIGN KEY (staff_id) REFERENCES staff(id)\r\n    );\r\n  `);\r\n}\r\n\r\nexport function down(db: Database): void {\r\n  const tables = [\r\n    'attendance', 'financial_period', 'fixed_asset', 'asset_category', 'staff_allowance',\r\n    'performance_improvement', 'student_award', 'award_category', 'subject_merit_entry', 'merit_list_entry', 'merit_list',\r\n    'student_activity_participation', 'cbc_strand_expense', 'fee_category_strand', 'cbc_strand',\r\n    'report_card_summary', 'exam_result', 'exam', 'grading_scale', 'subject_allocation', 'subject',\r\n    'stock_movement', 'inventory_item', 'supplier', 'inventory_category',\r\n    'payroll_allowance', 'payroll_deduction', 'payroll', 'payroll_period', 'statutory_rates',\r\n    'receipt', 'ledger_transaction', 'transaction_category', 'invoice_item', 'fee_invoice', 'fee_structure', 'fee_category',\r\n    'transaction_approval', 'approval_rule', 'ledger_reconciliation', 'opening_balance', 'journal_entry_line', 'journal_entry', 'gl_account',\r\n    'staff', 'enrollment', 'student', 'stream', 'term', 'academic_year',\r\n    'message_log', 'message_template', 'backup_log', 'audit_log', 'user', 'school_settings',\r\n    'budget_revision', 'budget_line_item', 'budget', 'reconciliation_adjustment', 'bank_statement_line', 'bank_statement', 'bank_account',\r\n    'approval_history', 'approval_request', 'approval_workflow'\r\n  ];\r\n\r\n  for (const table of tables) {\r\n    db.exec(`DROP TABLE IF EXISTS ${table}`);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\schema\\fragments\\020_academic_updates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\schema\\fragments\\030_production_alignment.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'up' has too many lines (231). Maximum allowed is 80.","line":20,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":287,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type Database } from 'better-sqlite3';\n\nfunction tableExists(db: Database, tableName: string): boolean {\n  const row = db.prepare(`SELECT name FROM sqlite_master WHERE type = 'table' AND name = ?`).get(tableName) as { name?: string } | undefined;\n  return Boolean(row?.name);\n}\n\nfunction columnExists(db: Database, tableName: string, columnName: string): boolean {\n  const columns = db.prepare(`PRAGMA table_info(${tableName})`).all() as { name: string }[];\n  return columns.some(col => col.name === columnName);\n}\n\nfunction addColumnIfMissing(db: Database, tableName: string, columnDef: string, columnName: string): void {\n  if (!tableExists(db, tableName)) {return;}\n  if (!columnExists(db, tableName, columnName)) {\n    db.exec(`ALTER TABLE ${tableName} ADD COLUMN ${columnDef}`);\n  }\n}\n\nexport function up(db: Database): void {\n  console.warn('Running Migration 004: Production Alignment');\n\n  // ============================================================================\n  // Fixed Assets alignment\n  // ============================================================================\n  addColumnIfMissing(db, 'fixed_asset', 'supplier_id INTEGER', 'supplier_id');\n  addColumnIfMissing(db, 'fixed_asset', 'warranty_expiry DATE', 'warranty_expiry');\n  addColumnIfMissing(db, 'fixed_asset', 'created_by_user_id INTEGER', 'created_by_user_id');\n  addColumnIfMissing(db, 'fixed_asset', 'deleted_at DATETIME', 'deleted_at');\n\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS asset_depreciation (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      asset_id INTEGER NOT NULL,\n      depreciation_date DATE NOT NULL,\n      amount INTEGER NOT NULL,\n      book_value_before INTEGER NOT NULL,\n      book_value_after INTEGER NOT NULL,\n      financial_period_id INTEGER,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (asset_id) REFERENCES fixed_asset(id) ON DELETE CASCADE\n    );\n  `);\n\n  // ============================================================================\n  // Inventory alignment\n  // ============================================================================\n  addColumnIfMissing(db, 'inventory_item', 'unit_price INTEGER DEFAULT 0', 'unit_price');\n  addColumnIfMissing(db, 'inventory_item', 'supplier_id INTEGER', 'supplier_id');\n  addColumnIfMissing(db, 'inventory_item', 'description TEXT', 'description');\n  addColumnIfMissing(db, 'inventory_item', 'updated_at DATETIME DEFAULT CURRENT_TIMESTAMP', 'updated_at');\n\n  // ============================================================================\n  // CBC Strand alignment (columns for expense + participation)\n  // ============================================================================\n  addColumnIfMissing(db, 'fee_category_strand', 'created_by INTEGER', 'created_by');\n  addColumnIfMissing(db, 'cbc_strand_expense', 'expense_date DATE', 'expense_date');\n  addColumnIfMissing(db, 'cbc_strand_expense', 'amount_cents INTEGER DEFAULT 0', 'amount_cents');\n  addColumnIfMissing(db, 'cbc_strand_expense', 'term INTEGER', 'term');\n  addColumnIfMissing(db, 'cbc_strand_expense', 'receipt_number TEXT', 'receipt_number');\n  addColumnIfMissing(db, 'cbc_strand_expense', 'created_by INTEGER', 'created_by');\n\n  addColumnIfMissing(db, 'student_activity_participation', 'activity_name TEXT', 'activity_name');\n  addColumnIfMissing(db, 'student_activity_participation', 'start_date DATE', 'start_date');\n  addColumnIfMissing(db, 'student_activity_participation', 'end_date DATE', 'end_date');\n  addColumnIfMissing(db, 'student_activity_participation', 'is_active BOOLEAN DEFAULT 1', 'is_active');\n\n  // ============================================================================\n  // JSS tables (missing from active migrations)\n  // ============================================================================\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS jss_fee_structure (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      grade INTEGER NOT NULL CHECK (grade IN (7, 8, 9)),\n      fiscal_year INTEGER NOT NULL,\n      tuition_fee_cents INTEGER NOT NULL DEFAULT 0,\n      boarding_fee_cents INTEGER DEFAULT 0,\n      activity_fee_cents INTEGER DEFAULT 0,\n      exam_fee_cents INTEGER DEFAULT 0,\n      library_fee_cents INTEGER DEFAULT 0,\n      lab_fee_cents INTEGER DEFAULT 0,\n      ict_fee_cents INTEGER DEFAULT 0,\n      is_active BOOLEAN NOT NULL DEFAULT 1,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      UNIQUE(grade, fiscal_year)\n    );\n  `);\n\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS grade_transition (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      student_id INTEGER NOT NULL,\n      from_grade INTEGER NOT NULL CHECK (from_grade BETWEEN 1 AND 12),\n      to_grade INTEGER NOT NULL CHECK (to_grade BETWEEN 1 AND 12),\n      transition_date DATE NOT NULL,\n      new_fee_structure_id INTEGER,\n      outstanding_balance_cents INTEGER NOT NULL DEFAULT 0,\n      boarding_status_change TEXT,\n      transition_notes TEXT,\n      processed_by INTEGER NOT NULL,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (student_id) REFERENCES student(id) ON DELETE CASCADE,\n      FOREIGN KEY (new_fee_structure_id) REFERENCES jss_fee_structure(id),\n      FOREIGN KEY (processed_by) REFERENCES user(id)\n    );\n  `);\n\n  // ============================================================================\n  // Report Cards (CBC)\n  // ============================================================================\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS report_card (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      exam_id INTEGER NOT NULL,\n      student_id INTEGER NOT NULL,\n      stream_id INTEGER NOT NULL,\n      generated_by_user_id INTEGER NOT NULL,\n      overall_grade TEXT,\n      total_marks INTEGER,\n      average_marks REAL,\n      position_in_class INTEGER,\n      position_in_stream INTEGER,\n      attendance_days_present INTEGER,\n      attendance_days_absent INTEGER,\n      attendance_percentage REAL,\n      class_teacher_remarks TEXT,\n      principal_remarks TEXT,\n      qr_code_token TEXT,\n      generated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      email_sent_at DATETIME,\n      FOREIGN KEY (exam_id) REFERENCES exam(id),\n      FOREIGN KEY (student_id) REFERENCES student(id),\n      FOREIGN KEY (stream_id) REFERENCES stream(id),\n      FOREIGN KEY (generated_by_user_id) REFERENCES user(id)\n    );\n\n    CREATE TABLE IF NOT EXISTS report_card_subject (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      report_card_id INTEGER NOT NULL,\n      subject_id INTEGER NOT NULL,\n      marks REAL,\n      grade TEXT,\n      percentage REAL,\n      teacher_comment TEXT,\n      competency_level TEXT,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (report_card_id) REFERENCES report_card(id) ON DELETE CASCADE,\n      FOREIGN KEY (subject_id) REFERENCES subject(id),\n      UNIQUE(report_card_id, subject_id)\n    );\n  `);\n\n  // ============================================================================\n  // Operations: Boarding, Transport, Grants, Student Cost\n  // ============================================================================\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS boarding_facility (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      name TEXT NOT NULL,\n      capacity INTEGER NOT NULL DEFAULT 0,\n      current_occupancy INTEGER NOT NULL DEFAULT 0,\n      matron_id INTEGER,\n      is_active BOOLEAN NOT NULL DEFAULT 1,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (matron_id) REFERENCES staff(id)\n    );\n\n    CREATE TABLE IF NOT EXISTS boarding_expense (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      facility_id INTEGER NOT NULL,\n      gl_account_code TEXT NOT NULL,\n      fiscal_year INTEGER NOT NULL,\n      term INTEGER NOT NULL CHECK (term IN (1, 2, 3)),\n      amount_cents INTEGER NOT NULL,\n      expense_type TEXT NOT NULL CHECK (expense_type IN ('FOOD', 'UTILITIES', 'BEDDING', 'STAFF', 'MAINTENANCE', 'OTHER')),\n      description TEXT,\n      recorded_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      recorded_by INTEGER NOT NULL,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (facility_id) REFERENCES boarding_facility(id) ON DELETE CASCADE,\n      FOREIGN KEY (recorded_by) REFERENCES user(id)\n    );\n\n    CREATE TABLE IF NOT EXISTS transport_route (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      route_name TEXT NOT NULL,\n      distance_km REAL NOT NULL DEFAULT 0,\n      estimated_students INTEGER NOT NULL DEFAULT 0,\n      budget_per_term_cents INTEGER NOT NULL DEFAULT 0,\n      driver_id INTEGER,\n      vehicle_registration TEXT,\n      is_active BOOLEAN NOT NULL DEFAULT 1,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (driver_id) REFERENCES staff(id)\n    );\n\n    CREATE TABLE IF NOT EXISTS transport_route_expense (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      route_id INTEGER NOT NULL,\n      gl_account_code TEXT NOT NULL,\n      fiscal_year INTEGER NOT NULL,\n      term INTEGER NOT NULL CHECK (term IN (1, 2, 3)),\n      amount_cents INTEGER NOT NULL,\n      expense_type TEXT NOT NULL CHECK (expense_type IN ('FUEL', 'MAINTENANCE', 'INSURANCE', 'PERMITS', 'DRIVER_SALARY', 'OTHER')),\n      description TEXT,\n      recorded_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      recorded_by INTEGER NOT NULL,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (route_id) REFERENCES transport_route(id) ON DELETE CASCADE,\n      FOREIGN KEY (recorded_by) REFERENCES user(id)\n    );\n\n    CREATE TABLE IF NOT EXISTS student_route_assignment (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      student_id INTEGER NOT NULL,\n      route_id INTEGER NOT NULL,\n      academic_year INTEGER NOT NULL,\n      term INTEGER NOT NULL CHECK (term IN (1, 2, 3)),\n      pickup_location TEXT,\n      is_active BOOLEAN NOT NULL DEFAULT 1,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (student_id) REFERENCES student(id) ON DELETE CASCADE,\n      FOREIGN KEY (route_id) REFERENCES transport_route(id) ON DELETE CASCADE\n    );\n\n    CREATE TABLE IF NOT EXISTS government_grant (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      grant_name TEXT NOT NULL,\n      grant_type TEXT NOT NULL CHECK (grant_type IN ('CAPITATION', 'FREE_DAY_SECONDARY', 'SPECIAL_NEEDS', 'INFRASTRUCTURE', 'FEEDING_PROGRAM', 'OTHER')),\n      fiscal_year INTEGER NOT NULL,\n      amount_allocated INTEGER NOT NULL DEFAULT 0,\n      amount_received INTEGER NOT NULL DEFAULT 0,\n      date_received DATE,\n      nemis_reference_number TEXT,\n      conditions TEXT,\n      is_utilized BOOLEAN NOT NULL DEFAULT 0,\n      utilization_percentage REAL NOT NULL DEFAULT 0,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP\n    );\n\n    CREATE TABLE IF NOT EXISTS grant_utilization (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      grant_id INTEGER NOT NULL,\n      gl_account_code TEXT,\n      amount_used INTEGER NOT NULL,\n      utilization_date DATE NOT NULL,\n      description TEXT NOT NULL,\n      journal_entry_id INTEGER,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (grant_id) REFERENCES government_grant(id) ON DELETE CASCADE\n    );\n\n    CREATE TABLE IF NOT EXISTS student_cost_snapshot (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      academic_year INTEGER NOT NULL,\n      term INTEGER NOT NULL CHECK (term IN (1, 2, 3)),\n      total_students INTEGER NOT NULL,\n      total_expenses INTEGER NOT NULL,\n      cost_per_student INTEGER NOT NULL,\n      teaching_cost_per_student INTEGER NOT NULL DEFAULT 0,\n      facilities_cost_per_student INTEGER NOT NULL DEFAULT 0,\n      activities_cost_per_student INTEGER NOT NULL DEFAULT 0,\n      administration_cost_per_student INTEGER NOT NULL DEFAULT 0,\n      snapshot_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      UNIQUE(academic_year, term)\n    );\n  `);\n\n  db.exec(`\n    CREATE INDEX IF NOT EXISTS idx_boarding_expense_facility ON boarding_expense(facility_id);\n    CREATE INDEX IF NOT EXISTS idx_boarding_expense_year_term ON boarding_expense(fiscal_year, term);\n    CREATE INDEX IF NOT EXISTS idx_transport_expense_route ON transport_route_expense(route_id);\n    CREATE INDEX IF NOT EXISTS idx_transport_expense_year_term ON transport_route_expense(fiscal_year, term);\n    CREATE INDEX IF NOT EXISTS idx_student_route_assignment_year_term ON student_route_assignment(academic_year, term);\n    CREATE INDEX IF NOT EXISTS idx_grant_year ON government_grant(fiscal_year);\n    CREATE INDEX IF NOT EXISTS idx_grant_utilization_grant ON grant_utilization(grant_id);\n    CREATE INDEX IF NOT EXISTS idx_student_cost_snapshot_year_term ON student_cost_snapshot(academic_year, term);\n  `);\n\n  console.warn('Migration 004: Production alignment applied successfully');\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\schema\\fragments\\040_archive_restorations.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'up' has too many lines (395). Maximum allowed is 80.","line":21,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":460,"endColumn":2},{"ruleId":"max-statements","severity":1,"message":"Function 'up' has too many statements (45). Maximum allowed is 30.","line":21,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":460,"endColumn":2},{"ruleId":"complexity","severity":1,"message":"Function 'up' has a complexity of 17. Maximum allowed is 12.","line":21,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":21,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type Database } from 'better-sqlite3'\n\nfunction tableExists(db: Database, tableName: string): boolean {\n  const row = db.prepare(`SELECT name FROM sqlite_master WHERE type = 'table' AND name = ?`).get(tableName) as { name?: string } | undefined\n  return Boolean(row?.name)\n}\n\nfunction columnExists(db: Database, tableName: string, columnName: string): boolean {\n  if (!tableExists(db, tableName)) {return false}\n  const columns = db.prepare(`PRAGMA table_info(${tableName})`).all() as { name: string }[]\n  return columns.some(col => col.name === columnName)\n}\n\nfunction addColumnIfMissing(db: Database, tableName: string, columnDef: string, columnName: string): void {\n  if (!tableExists(db, tableName)) {return}\n  if (!columnExists(db, tableName, columnName)) {\n    db.exec(`ALTER TABLE ${tableName} ADD COLUMN ${columnDef}`)\n  }\n}\n\nexport function up(db: Database): void {\n  console.warn('Running Migration 006: Archive Restorations')\n\n  // ========================================================================\n  // Credits, Proration, Scholarships, NEMIS\n  // ========================================================================\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS credit_transaction (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      student_id INTEGER NOT NULL,\n      amount INTEGER NOT NULL,\n      transaction_type TEXT NOT NULL CHECK(transaction_type IN ('CREDIT_RECEIVED', 'CREDIT_APPLIED', 'CREDIT_REFUNDED')),\n      reference_invoice_id INTEGER,\n      notes TEXT NOT NULL,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (student_id) REFERENCES student(id),\n      FOREIGN KEY (reference_invoice_id) REFERENCES fee_invoice(id)\n    );\n    CREATE INDEX IF NOT EXISTS idx_credit_transaction_student ON credit_transaction(student_id);\n    CREATE INDEX IF NOT EXISTS idx_credit_transaction_type ON credit_transaction(transaction_type);\n    CREATE INDEX IF NOT EXISTS idx_credit_transaction_date ON credit_transaction(created_at);\n  `)\n\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS pro_ration_log (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      invoice_id INTEGER NOT NULL,\n      student_id INTEGER NOT NULL,\n      full_amount INTEGER NOT NULL,\n      pro_rated_amount INTEGER NOT NULL,\n      discount_percentage REAL NOT NULL,\n      enrollment_date TEXT NOT NULL,\n      term_start TEXT NOT NULL,\n      term_end TEXT NOT NULL,\n      days_in_term INTEGER NOT NULL,\n      days_enrolled INTEGER NOT NULL,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (invoice_id) REFERENCES fee_invoice(id),\n      FOREIGN KEY (student_id) REFERENCES student(id)\n    );\n    CREATE INDEX IF NOT EXISTS idx_proration_invoice ON pro_ration_log(invoice_id);\n    CREATE INDEX IF NOT EXISTS idx_proration_student ON pro_ration_log(student_id);\n  `)\n\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS scholarship (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      name TEXT NOT NULL UNIQUE,\n      description TEXT NOT NULL,\n      scholarship_type TEXT NOT NULL CHECK(scholarship_type IN ('MERIT', 'NEED_BASED', 'SPORTS', 'PARTIAL', 'FULL')),\n      amount INTEGER NOT NULL,\n      percentage REAL,\n      total_amount INTEGER NOT NULL,\n      allocated_amount INTEGER NOT NULL DEFAULT 0,\n      available_amount INTEGER NOT NULL DEFAULT 0,\n      current_beneficiaries INTEGER NOT NULL DEFAULT 0,\n      max_beneficiaries INTEGER NOT NULL,\n      total_allocated INTEGER NOT NULL DEFAULT 0,\n      eligibility_criteria TEXT NOT NULL,\n      status TEXT NOT NULL DEFAULT 'ACTIVE' CHECK(status IN ('ACTIVE', 'SUSPENDED', 'EXPIRED')),\n      valid_from TEXT NOT NULL,\n      valid_to TEXT NOT NULL,\n      sponsor_name TEXT,\n      sponsor_contact TEXT,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP\n    );\n    CREATE INDEX IF NOT EXISTS idx_scholarship_status ON scholarship(status);\n    CREATE INDEX IF NOT EXISTS idx_scholarship_type ON scholarship(scholarship_type);\n    CREATE INDEX IF NOT EXISTS idx_scholarship_validity ON scholarship(valid_from, valid_to);\n  `)\n\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS student_scholarship (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      scholarship_id INTEGER NOT NULL,\n      student_id INTEGER NOT NULL,\n      amount_allocated INTEGER NOT NULL,\n      amount_utilized INTEGER NOT NULL DEFAULT 0,\n      allocation_notes TEXT,\n      status TEXT NOT NULL DEFAULT 'ACTIVE' CHECK(status IN ('ACTIVE', 'FULLY_UTILIZED', 'EXPIRED', 'REVOKED')),\n      effective_date TEXT NOT NULL,\n      expiry_date TEXT NOT NULL,\n      allocated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (scholarship_id) REFERENCES scholarship(id),\n      FOREIGN KEY (student_id) REFERENCES student(id)\n    );\n    CREATE INDEX IF NOT EXISTS idx_student_scholarship_student ON student_scholarship(student_id);\n    CREATE INDEX IF NOT EXISTS idx_student_scholarship_status ON student_scholarship(status);\n  `)\n\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS nemis_export (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      export_type TEXT NOT NULL,\n      format TEXT NOT NULL,\n      record_count INTEGER NOT NULL,\n      file_path TEXT NOT NULL,\n      file_size INTEGER,\n      exported_by INTEGER,\n      status TEXT NOT NULL DEFAULT 'COMPLETED' CHECK(status IN ('COMPLETED', 'FAILED')),\n      error_message TEXT,\n      exported_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP\n    );\n  `)\n\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS academic_term (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      term_name TEXT NOT NULL,\n      term_number INTEGER NOT NULL CHECK(term_number IN (1, 2, 3)),\n      academic_year TEXT NOT NULL,\n      start_date TEXT NOT NULL,\n      end_date TEXT NOT NULL,\n      status TEXT NOT NULL DEFAULT 'UPCOMING' CHECK(status IN ('UPCOMING', 'ACTIVE', 'COMPLETED', 'OPEN', 'CLOSED')),\n      is_current BOOLEAN DEFAULT 0,\n      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      UNIQUE(term_number, academic_year)\n    );\n  `)\n\n  const termHasCreatedAt = columnExists(db, 'term', 'created_at')\n  const termCreatedAtExpression = termHasCreatedAt ? 't.created_at' : 'CURRENT_TIMESTAMP'\n  const termNewCreatedAtExpression = termHasCreatedAt ? 'NEW.created_at' : 'CURRENT_TIMESTAMP'\n\n  // Sync existing term records into academic_term (id mapping to term.id)\n  if (tableExists(db, 'term') && tableExists(db, 'academic_year')) {\n    db.exec(`\n      INSERT OR IGNORE INTO academic_term (id, term_name, term_number, academic_year, start_date, end_date, status, is_current, created_at, updated_at)\n      SELECT t.id, t.term_name, t.term_number, ay.year_name, t.start_date, t.end_date, t.status, t.is_current, ${termCreatedAtExpression}, ${termCreatedAtExpression}\n      FROM term t\n      JOIN academic_year ay ON ay.id = t.academic_year_id\n    `)\n  }\n\n  // Keep academic_term in sync with term\n  if (tableExists(db, 'term') && tableExists(db, 'academic_year')) {\n    db.exec(`\n      CREATE TRIGGER IF NOT EXISTS trg_term_insert_academic_term\n      AFTER INSERT ON term\n      BEGIN\n        INSERT OR IGNORE INTO academic_term (id, term_name, term_number, academic_year, start_date, end_date, status, is_current, created_at, updated_at)\n        VALUES (\n          NEW.id,\n          NEW.term_name,\n          NEW.term_number,\n          (SELECT year_name FROM academic_year WHERE id = NEW.academic_year_id),\n          NEW.start_date,\n          NEW.end_date,\n          NEW.status,\n          NEW.is_current,\n          ${termNewCreatedAtExpression},\n          ${termNewCreatedAtExpression}\n        );\n      END;\n\n      CREATE TRIGGER IF NOT EXISTS trg_term_update_academic_term\n      AFTER UPDATE ON term\n      BEGIN\n        UPDATE academic_term\n        SET term_name = NEW.term_name,\n            term_number = NEW.term_number,\n            academic_year = (SELECT year_name FROM academic_year WHERE id = NEW.academic_year_id),\n            start_date = NEW.start_date,\n            end_date = NEW.end_date,\n            status = NEW.status,\n            is_current = NEW.is_current,\n            updated_at = CURRENT_TIMESTAMP\n        WHERE id = NEW.id;\n      END;\n    `)\n  }\n\n  // ========================================================================\n  // Asset Hire + Exemptions\n  // ========================================================================\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS hire_client (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      client_name TEXT NOT NULL,\n      contact_phone TEXT,\n      contact_email TEXT,\n      organization TEXT,\n      address TEXT,\n      notes TEXT,\n      is_active INTEGER DEFAULT 1,\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n    );\n\n    CREATE TABLE IF NOT EXISTS hire_asset (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      asset_name TEXT NOT NULL,\n      asset_type TEXT NOT NULL CHECK (asset_type IN ('VEHICLE', 'FACILITY', 'EQUIPMENT', 'OTHER')),\n      registration_number TEXT,\n      description TEXT,\n      default_rate INTEGER,\n      rate_type TEXT CHECK (rate_type IN ('PER_DAY', 'PER_KM', 'PER_HOUR', 'FIXED')),\n      is_active INTEGER DEFAULT 1,\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n    );\n\n    CREATE TABLE IF NOT EXISTS hire_booking (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      booking_number TEXT UNIQUE NOT NULL,\n      asset_id INTEGER NOT NULL REFERENCES hire_asset(id),\n      client_id INTEGER NOT NULL REFERENCES hire_client(id),\n      hire_date DATE NOT NULL,\n      return_date DATE,\n      hire_start_time TEXT,\n      hire_end_time TEXT,\n      purpose TEXT,\n      destination TEXT,\n      distance_km REAL,\n      hours REAL,\n      total_amount INTEGER NOT NULL,\n      amount_paid INTEGER DEFAULT 0,\n      status TEXT DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'CONFIRMED', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED')),\n      notes TEXT,\n      recorded_by_user_id INTEGER REFERENCES user(id),\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n    );\n\n    CREATE TABLE IF NOT EXISTS hire_payment (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      booking_id INTEGER NOT NULL REFERENCES hire_booking(id),\n      receipt_number TEXT UNIQUE NOT NULL,\n      amount INTEGER NOT NULL,\n      payment_method TEXT NOT NULL,\n      payment_reference TEXT,\n      payment_date DATE NOT NULL,\n      notes TEXT,\n      is_voided INTEGER DEFAULT 0,\n      void_reason TEXT,\n      recorded_by_user_id INTEGER REFERENCES user(id),\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP\n    );\n\n    CREATE TABLE IF NOT EXISTS fee_exemption (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      student_id INTEGER NOT NULL REFERENCES student(id),\n      academic_year_id INTEGER NOT NULL REFERENCES academic_year(id),\n      term_id INTEGER REFERENCES term(id),\n      fee_category_id INTEGER REFERENCES fee_category(id),\n      exemption_type TEXT NOT NULL CHECK (exemption_type IN ('FULL', 'PARTIAL')),\n      exemption_percentage REAL NOT NULL CHECK (exemption_percentage > 0 AND exemption_percentage <= 100),\n      exemption_reason TEXT NOT NULL,\n      supporting_document TEXT,\n      notes TEXT,\n      approved_by_user_id INTEGER REFERENCES user(id),\n      approved_at DATETIME,\n      status TEXT DEFAULT 'ACTIVE' CHECK (status IN ('ACTIVE', 'REVOKED')),\n      revoked_by_user_id INTEGER REFERENCES user(id),\n      revoked_at DATETIME,\n      revoke_reason TEXT,\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n    );\n\n    CREATE INDEX IF NOT EXISTS idx_hire_booking_date ON hire_booking(hire_date);\n    CREATE INDEX IF NOT EXISTS idx_hire_booking_status ON hire_booking(status);\n    CREATE INDEX IF NOT EXISTS idx_hire_booking_client ON hire_booking(client_id);\n    CREATE INDEX IF NOT EXISTS idx_hire_booking_asset ON hire_booking(asset_id);\n    CREATE INDEX IF NOT EXISTS idx_fee_exemption_student ON fee_exemption(student_id);\n    CREATE INDEX IF NOT EXISTS idx_fee_exemption_year_term ON fee_exemption(academic_year_id, term_id);\n    CREATE INDEX IF NOT EXISTS idx_fee_exemption_status ON fee_exemption(status);\n  `)\n\n  addColumnIfMissing(db, 'invoice_item', 'exemption_id INTEGER', 'exemption_id')\n  addColumnIfMissing(db, 'invoice_item', 'original_amount INTEGER', 'original_amount')\n  addColumnIfMissing(db, 'invoice_item', 'exemption_amount INTEGER DEFAULT 0', 'exemption_amount')\n\n  // ========================================================================\n  // Voids / Audit\n  // ========================================================================\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS void_audit (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      transaction_id INTEGER NOT NULL,\n      transaction_type TEXT NOT NULL,\n      original_amount INTEGER NOT NULL,\n      student_id INTEGER,\n      description TEXT,\n      void_reason TEXT NOT NULL,\n      voided_by INTEGER NOT NULL,\n      voided_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      approval_request_id INTEGER,\n      recovered_amount INTEGER,\n      recovered_method TEXT,\n      recovered_at TEXT,\n      recovered_by INTEGER,\n      notes TEXT,\n      FOREIGN KEY (voided_by) REFERENCES user(id),\n      FOREIGN KEY (recovered_by) REFERENCES user(id),\n      FOREIGN KEY (student_id) REFERENCES student(id),\n      FOREIGN KEY (approval_request_id) REFERENCES approval_request(id)\n    );\n  `)\n\n  // ========================================================================\n  // Exam scheduling + analytics tables (aligned to current services)\n  // ========================================================================\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS exam_timetable (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      academic_year_id INTEGER,\n      term_id INTEGER,\n      exam_id INTEGER NOT NULL,\n      exam_date TEXT,\n      start_time TEXT NOT NULL,\n      end_time TEXT NOT NULL,\n      subject_id INTEGER NOT NULL,\n      stream_id INTEGER,\n      duration_minutes INTEGER,\n      venue_id INTEGER,\n      venue_name TEXT,\n      capacity INTEGER,\n      invigilators_count INTEGER,\n      max_capacity INTEGER DEFAULT 0,\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (academic_year_id) REFERENCES academic_year(id),\n      FOREIGN KEY (term_id) REFERENCES term(id),\n      FOREIGN KEY (exam_id) REFERENCES exam(id),\n      FOREIGN KEY (subject_id) REFERENCES subject(id),\n      FOREIGN KEY (stream_id) REFERENCES stream(id)\n    );\n\n    CREATE TABLE IF NOT EXISTS exam_invigilator (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      exam_id INTEGER,\n      slot_id INTEGER NOT NULL,\n      staff_id INTEGER NOT NULL,\n      role TEXT CHECK(role IN ('chief', 'assistant', 'relief')),\n      assigned_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (exam_id) REFERENCES exam(id),\n      FOREIGN KEY (slot_id) REFERENCES exam_timetable(id),\n      FOREIGN KEY (staff_id) REFERENCES staff(id),\n      UNIQUE(slot_id, staff_id)\n    );\n\n    CREATE TABLE IF NOT EXISTS report_card_strand (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      report_card_id INTEGER NOT NULL,\n      strand_id INTEGER NOT NULL,\n      strand_name TEXT,\n      competency_level TEXT,\n      teacher_comment TEXT,\n      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n      FOREIGN KEY (report_card_id) REFERENCES report_card(id) ON DELETE CASCADE\n    );\n\n    CREATE TABLE IF NOT EXISTS exam_subject_analysis (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      exam_id INTEGER NOT NULL,\n      subject_id INTEGER NOT NULL,\n      stream_id INTEGER,\n      teacher_id INTEGER,\n      total_students INTEGER,\n      pass_count INTEGER,\n      fail_count INTEGER,\n      mean_score REAL,\n      median_score REAL,\n      mode_score REAL,\n      std_deviation REAL,\n      min_score REAL,\n      max_score REAL,\n      pass_rate REAL,\n      fail_rate REAL,\n      difficulty_index REAL,\n      discrimination_index REAL,\n      analysis_date TEXT,\n      FOREIGN KEY (exam_id) REFERENCES exam(id),\n      FOREIGN KEY (subject_id) REFERENCES subject(id),\n      FOREIGN KEY (stream_id) REFERENCES stream(id)\n    );\n\n    CREATE TABLE IF NOT EXISTS student_exam_performance (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      student_id INTEGER NOT NULL,\n      academic_year_id INTEGER NOT NULL,\n      exam_id INTEGER NOT NULL,\n      stream_position INTEGER,\n      class_position INTEGER,\n      total_marks REAL,\n      average_marks REAL,\n      grade TEXT,\n      pass_count INTEGER,\n      fail_count INTEGER,\n      best_subject_id INTEGER,\n      worst_subject_id INTEGER,\n      improvement_index REAL,\n      analysis_date TEXT,\n      FOREIGN KEY (student_id) REFERENCES student(id),\n      FOREIGN KEY (academic_year_id) REFERENCES academic_year(id),\n      FOREIGN KEY (exam_id) REFERENCES exam(id)\n    );\n  `)\n\n  // ========================================================================\n  // Compatibility columns for legacy services\n  // ========================================================================\n  addColumnIfMissing(db, 'academic_term', 'start_date TEXT', 'start_date')\n  addColumnIfMissing(db, 'academic_term', 'end_date TEXT', 'end_date')\n\n  if (tableExists(db, 'academic_term') && columnExists(db, 'academic_term', 'term_start')) {\n    db.exec(`UPDATE academic_term SET start_date = term_start WHERE start_date IS NULL`)\n  }\n  if (tableExists(db, 'academic_term') && columnExists(db, 'academic_term', 'term_end')) {\n    db.exec(`UPDATE academic_term SET end_date = term_end WHERE end_date IS NULL`)\n  }\n  addColumnIfMissing(db, 'enrollment', 'academic_term_id INTEGER', 'academic_term_id')\n  addColumnIfMissing(db, 'fee_invoice', 'academic_term_id INTEGER', 'academic_term_id')\n  addColumnIfMissing(db, 'fee_invoice', 'amount INTEGER', 'amount')\n  addColumnIfMissing(db, 'fee_invoice', 'amount_due INTEGER', 'amount_due')\n  addColumnIfMissing(db, 'fee_invoice', 'original_amount INTEGER', 'original_amount')\n  addColumnIfMissing(db, 'fee_invoice', 'is_prorated INTEGER DEFAULT 0', 'is_prorated')\n  addColumnIfMissing(db, 'fee_invoice', 'proration_percentage REAL', 'proration_percentage')\n  addColumnIfMissing(db, 'fee_invoice', 'invoice_type TEXT', 'invoice_type')\n  addColumnIfMissing(db, 'fee_invoice', 'class_id INTEGER', 'class_id')\n  addColumnIfMissing(db, 'fee_invoice', 'fee_type TEXT', 'fee_type')\n  addColumnIfMissing(db, 'fee_invoice', 'description TEXT', 'description')\n  addColumnIfMissing(db, 'fee_invoice', 'updated_at DATETIME DEFAULT CURRENT_TIMESTAMP', 'updated_at')\n\n  if (tableExists(db, 'enrollment') && columnExists(db, 'enrollment', 'term_id')) {\n    db.exec(`UPDATE enrollment SET academic_term_id = term_id WHERE academic_term_id IS NULL`)\n  }\n\n  if (tableExists(db, 'fee_invoice') && columnExists(db, 'fee_invoice', 'total_amount')) {\n    db.exec(`UPDATE fee_invoice SET amount = total_amount WHERE amount IS NULL`)\n    db.exec(`UPDATE fee_invoice SET amount_due = total_amount WHERE amount_due IS NULL`)\n  }\n\n  if (tableExists(db, 'fee_invoice') && columnExists(db, 'fee_invoice', 'term_id')) {\n    db.exec(`UPDATE fee_invoice SET academic_term_id = term_id WHERE academic_term_id IS NULL`)\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\security.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\seeds\\academic_seed.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\seeds\\core_seed.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'up' has too many lines (157). Maximum allowed is 80.","line":3,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":175,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Database } from 'better-sqlite3'\n\nexport function up(db: Database): void {\n  console.warn('Running Seed: Core Data')\n\n  db.exec(`\n    INSERT OR IGNORE INTO school_settings (id, school_name, school_motto, address, phone, email) \n    VALUES (1, 'Mwingi Adventist School', 'Education for Eternity', 'P.O. Box 212-90400, Mwingi, Kenya', '0725064785', 'mwingiadventist@gmail.com');\n  `)\n\n  if (process.env.SEED_DEFAULT_ADMIN === 'true' || process.env.SEED_DEFAULT_ADMIN === '1') {\n    db.exec(`\n      INSERT OR IGNORE INTO user (username, password_hash, full_name, email, role) VALUES \n      ('admin', '$2a$10$RicmEoNAtBI5Kfx9Z1YcA.09l63qLqDPXes6IH.09Gd7vy4Ilwqte', 'System Administrator', 'admin@mwingiadventist.ac.ke', 'ADMIN');\n    `)\n  }\n\n  db.exec(`\n    INSERT OR IGNORE INTO academic_year (year_name, start_date, end_date, is_current) VALUES ('2026', '2026-01-06', '2026-11-28', 1);\n  `)\n\n  const year2026 = db.prepare(`SELECT id FROM academic_year WHERE year_name = '2026'`).get() as { id: number } | undefined\n  if (year2026) {\n    db.exec(`\n        INSERT OR IGNORE INTO term (academic_year_id, term_number, term_name, start_date, end_date, is_current, status) VALUES\n        (${year2026.id}, 1, 'Term 1', '2026-01-06', '2026-04-11', 1, 'OPEN'),\n        (${year2026.id}, 2, 'Term 2', '2026-04-28', '2026-08-08', 0, 'OPEN'),\n        (${year2026.id}, 3, 'Term 3', '2026-08-25', '2026-11-28', 0, 'OPEN');\n      `)\n  }\n\n  db.exec(`\n    INSERT OR IGNORE INTO stream (stream_code, stream_name, level_order, is_junior_secondary) VALUES \n    ('BABY', 'Baby Class', 1, 0), ('PP1', 'Pre-Primary 1', 2, 0), ('PP2', 'Pre-Primary 2', 3, 0),\n    ('G1', 'Grade 1', 4, 0), ('G2', 'Grade 2', 5, 0), ('G3', 'Grade 3', 6, 0),\n    ('G4', 'Grade 4', 7, 0), ('G5', 'Grade 5', 8, 0), ('G6', 'Grade 6', 9, 0),\n    ('G7', 'Grade 7', 10, 1), ('G8', 'Grade 8', 11, 1), ('G9', 'Grade 9', 12, 1);\n  `)\n\n  db.exec(`\n    INSERT OR IGNORE INTO inventory_category (category_name) VALUES \n    ('Stationery'), ('Food Supplies'), ('Uniforms'), ('Cleaning'), ('Furniture'), ('Electronics');\n  `)\n\n  db.exec(`\n    INSERT OR IGNORE INTO transaction_category (category_name, category_type, is_system) VALUES \n    ('School Fees', 'INCOME', 1), ('Donations', 'INCOME', 1), ('Grants', 'INCOME', 1),\n    ('Other Income', 'INCOME', 0), ('Salaries', 'EXPENSE', 1), ('Utilities', 'EXPENSE', 0),\n    ('Supplies', 'EXPENSE', 0), ('Maintenance', 'EXPENSE', 0);\n  `)\n\n  db.exec(`\n    INSERT OR IGNORE INTO statutory_rates (rate_type, min_amount, max_amount, fixed_amount, effective_from) VALUES\n    ('NSSF_TIER_I', 0, 7000, 720, '2024-02-01'),\n    ('NSSF_TIER_II', 7001, 36000, 1440, '2024-02-01');\n    INSERT OR IGNORE INTO statutory_rates (rate_type, rate, effective_from) VALUES\n    ('HOUSING_LEVY', 0.015, '2023-07-01');\n    INSERT OR IGNORE INTO statutory_rates (rate_type, rate, effective_from) VALUES\n    ('SHIF', 0.0275, '2024-10-01');\n    INSERT OR IGNORE INTO statutory_rates (rate_type, min_amount, max_amount, rate, effective_from) VALUES\n    ('PAYE_BAND', 0, 24000, 0.1, '2024-01-01'),\n    ('PAYE_BAND', 24001, 32333, 0.25, '2024-01-01'),\n    ('PAYE_BAND', 32334, 500000, 0.3, '2024-01-01'),\n    ('PAYE_BAND', 500001, 800000, 0.325, '2024-01-01'),\n    ('PAYE_BAND', 800001, 99999999, 0.35, '2024-01-01');\n    INSERT OR IGNORE INTO statutory_rates (rate_type, fixed_amount, effective_from) VALUES\n    ('PERSONAL_RELIEF', 2400, '2024-01-01');\n  `)\n\n  const standardAccounts = [\n    { code: '1010', name: 'Cash on Hand', type: 'ASSET', balance: 'DEBIT', system: 1 },\n    { code: '1020', name: 'Bank Account - KCB', type: 'ASSET', balance: 'DEBIT', system: 1 },\n    { code: '1030', name: 'Bank Account - Equity', type: 'ASSET', balance: 'DEBIT', system: 1 },\n    { code: '1100', name: 'Accounts Receivable - Students', type: 'ASSET', balance: 'DEBIT', system: 1 },\n    { code: '1200', name: 'Inventory - Supplies', type: 'ASSET', balance: 'DEBIT', system: 1 },\n    { code: '1300', name: 'Fixed Assets - Buildings', type: 'ASSET', balance: 'DEBIT', system: 1 },\n    { code: '1310', name: 'Fixed Assets - Vehicles', type: 'ASSET', balance: 'DEBIT', system: 1 },\n    { code: '1320', name: 'Fixed Assets - Furniture', type: 'ASSET', balance: 'DEBIT', system: 1 },\n    { code: '1390', name: 'Accumulated Depreciation', type: 'ASSET', balance: 'CREDIT', system: 1 },\n    { code: '2010', name: 'Accounts Payable', type: 'LIABILITY', balance: 'CREDIT', system: 1 },\n    { code: '2020', name: 'Student Credit Balances', type: 'LIABILITY', balance: 'CREDIT', system: 1 },\n    { code: '2100', name: 'Salary Payable', type: 'LIABILITY', balance: 'CREDIT', system: 1 },\n    { code: '2110', name: 'PAYE Payable', type: 'LIABILITY', balance: 'CREDIT', system: 1 },\n    { code: '2120', name: 'NSSF Payable', type: 'LIABILITY', balance: 'CREDIT', system: 1 },\n    { code: '2130', name: 'NHIF/SHIF Payable', type: 'LIABILITY', balance: 'CREDIT', system: 1 },\n    { code: '2140', name: 'Housing Levy Payable', type: 'LIABILITY', balance: 'CREDIT', system: 1 },\n    { code: '2200', name: 'Loans Payable', type: 'LIABILITY', balance: 'CREDIT', system: 1 },\n    { code: '3010', name: 'Capital', type: 'EQUITY', balance: 'CREDIT', system: 1 },\n    { code: '3020', name: 'Retained Earnings', type: 'EQUITY', balance: 'CREDIT', system: 1 },\n    { code: '3030', name: 'Current Year Surplus/Deficit', type: 'EQUITY', balance: 'CREDIT', system: 1 },\n    { code: '4010', name: 'Tuition Fees', type: 'REVENUE', balance: 'CREDIT', system: 1 },\n    { code: '4020', name: 'Boarding Fees', type: 'REVENUE', balance: 'CREDIT', system: 1 },\n    { code: '4030', name: 'Transport Fees', type: 'REVENUE', balance: 'CREDIT', system: 1 },\n    { code: '4040', name: 'Activity Fees', type: 'REVENUE', balance: 'CREDIT', system: 1 },\n    { code: '4050', name: 'Exam Fees', type: 'REVENUE', balance: 'CREDIT', system: 1 },\n    { code: '4100', name: 'Government Grants - Capitation', type: 'REVENUE', balance: 'CREDIT', system: 1 },\n    { code: '4200', name: 'Donations', type: 'REVENUE', balance: 'CREDIT', system: 1 },\n    { code: '4300', name: 'Other Income', type: 'REVENUE', balance: 'CREDIT', system: 1 },\n    { code: '5010', name: 'Salaries - Teaching Staff', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5020', name: 'Salaries - Non-Teaching Staff', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5030', name: 'Statutory Deductions - NSSF', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5040', name: 'Statutory Deductions - NHIF/SHIF', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5050', name: 'Statutory Deductions - Housing Levy', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5100', name: 'Food & Catering - Boarding', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5200', name: 'Transport - Fuel & Maintenance', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5210', name: 'Transport - Driver Salaries', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5300', name: 'Utilities - Electricity', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5310', name: 'Utilities - Water', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5400', name: 'Supplies - Stationery', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5410', name: 'Supplies - Cleaning', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5500', name: 'Repairs & Maintenance', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5600', name: 'Depreciation Expense', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5700', name: 'Bank Charges', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5800', name: 'Professional Fees', type: 'EXPENSE', balance: 'DEBIT', system: 1 },\n    { code: '5900', name: 'Miscellaneous Expenses', type: 'EXPENSE', balance: 'DEBIT', system: 1 }\n  ]\n\n  const insertGLStmt = db.prepare(`\n    INSERT OR IGNORE INTO gl_account (account_code, account_name, account_type, normal_balance, is_system_account, is_active)\n    VALUES (?, ?, ?, ?, ?, 1)\n  `)\n\n  for (const account of standardAccounts) {\n    insertGLStmt.run(account.code, account.name, account.type, account.balance, account.system)\n  }\n\n  db.exec(`\n    INSERT OR IGNORE INTO approval_rule (rule_name, transaction_type, min_amount, required_approver_role, is_active)\n    VALUES ('High Value Void', 'VOID', 50000, 'FINANCE_MANAGER', 1);\n    INSERT OR IGNORE INTO approval_rule (rule_name, transaction_type, days_since_transaction, required_approver_role, is_active)\n    VALUES ('Aged Transaction Void', 'VOID', 7, 'FINANCE_MANAGER', 1);\n    INSERT OR IGNORE INTO approval_rule (rule_name, transaction_type, min_amount, required_approver_role, is_active)\n    VALUES ('Large Payment', 'FEE_PAYMENT', 100000, 'FINANCE_MANAGER', 1);\n    INSERT OR IGNORE INTO approval_rule (rule_name, transaction_type, required_approver_role, is_active)\n    VALUES ('All Refunds', 'REFUND', 'FINANCE_MANAGER', 1);\n  `)\n\n  const categories = [\n    { name: 'Tuition', desc: 'Tuition Fees', gl: '4010' },\n    { name: 'Feeding', desc: 'Meals/Feeding Fees', gl: '4020' },\n    { name: 'Maintenance', desc: 'Maintenance Fees', gl: '5500' },\n    { name: 'Boarding', desc: 'Boarding Fees', gl: '4020' },\n    { name: 'Activity', desc: 'Activity Fees', gl: '4040' },\n    { name: 'Exams', desc: 'Exam Fees', gl: '4050' },\n    { name: 'Medical', desc: 'Medical/Emergency Fees', gl: '4300' },\n    { name: 'Transport', desc: 'Transport Fees', gl: '4030' },\n    { name: 'Textbook', desc: 'Books and materials', gl: '4300' },\n    { name: 'Interview', desc: 'Interview fee', gl: '4300' },\n    { name: 'Motivation', desc: 'Motivation fee', gl: '4300' },\n    { name: 'Admission', desc: 'One-time admission fee', gl: '4300' }\n  ]\n\n  const getGLId = db.prepare('SELECT id FROM gl_account WHERE account_code = ?')\n  const insertCatStmt = db.prepare(`INSERT OR IGNORE INTO fee_category (category_name, description, gl_account_id) VALUES (?, ?, ?)`)\n  const updateCatStmt = db.prepare(`UPDATE fee_category SET gl_account_id = ? WHERE category_name = ?`)\n\n  for (const cat of categories) {\n    const glRow = getGLId.get(cat.gl) as { id: number } | undefined\n    const glId = glRow ? glRow.id : null\n    insertCatStmt.run(cat.name, cat.desc, glId)\n    if (glId) {updateCatStmt.run(glId, cat.name)}\n  }\n\n  db.exec(`\n    INSERT OR IGNORE INTO award_category (name, category_type, description, is_automatic, requires_approval, is_active, sort_order) VALUES\n    ('Academic Excellence', 'academic_excellence', 'Awarded to top performing students', 0, 1, 1, 1),\n    ('Most Improved Student', 'improvement', 'Awarded to students showing significant improvement', 0, 1, 1, 2),\n    ('Best in Discipline', 'discipline', 'Awarded for exemplary behavior and discipline', 0, 1, 1, 3),\n    ('Sports Achievement', 'sports', 'Awarded for outstanding performance in sports', 0, 1, 1, 4),\n    ('Arts & Culture', 'arts', 'Awarded for excellence in arts and cultural activities', 0, 1, 1, 5),\n    ('Agriculture Award', 'agriculture', 'Awarded for excellence in agricultural activities', 0, 1, 1, 6),\n    ('Leadership Award', 'other', 'Awarded for outstanding leadership qualities', 0, 1, 1, 7),\n    ('Perfect Attendance', 'other', 'Awarded to students with perfect attendance', 1, 0, 1, 8);\n  `)\n}\n\nexport function down(): void {\n  console.warn('Reverting Seed: Core Data (No Action Taken)')\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\utils\\audit.ts","messages":[{"ruleId":"max-params","severity":1,"message":"Function 'logAudit' has too many parameters (6). Maximum allowed is 5.","line":3,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":3,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../index'\r\n\r\nexport function logAudit(userId: number, actionType: string, tableName: string, recordId: number | null, oldValues: unknown, newValues: unknown): void {\r\n    const db = getDatabase()\r\n    try {\r\n        db.prepare(`INSERT INTO audit_log (\r\n            user_id, action_type, table_name, record_id, old_values, new_values\r\n        ) VALUES (?, ?, ?, ?, ?, ?)`).run(\r\n            userId, actionType, tableName, recordId, \r\n            oldValues ? JSON.stringify(oldValues) : null, \r\n            newValues ? JSON.stringify(newValues) : null\r\n        )\r\n    } catch (error) {\r\n        console.error('Failed to log audit:', error)\r\n    }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\utils\\migration-runner.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\database\\verify_migrations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\electron-env.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\index.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":153,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4588,4591],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4588,4591],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":161,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":161,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4927,4930],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4927,4930],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\academic\\academic-handlers.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'registerAcademicHandlers' has too many lines (152). Maximum allowed is 80.","line":19,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":192,"endColumn":2},{"ruleId":"max-lines-per-function","severity":1,"message":"Async function 'generateSchedule' has too many lines (109). Maximum allowed is 80.","line":250,"column":1,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":369,"endColumn":2},{"ruleId":"max-statements","severity":1,"message":"Async function 'generateSchedule' has too many statements (31). Maximum allowed is 30.","line":250,"column":1,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":369,"endColumn":2},{"ruleId":"complexity","severity":1,"message":"Async function 'generateSchedule' has a complexity of 16. Maximum allowed is 12.","line":250,"column":1,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":250,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\nimport { ipcMain } from '../../electron-env'\nimport { renderHtmlToPdfBuffer, resolveOutputPath, writePdfBuffer } from '../../utils/pdf'\n\ninterface ExportPdfPayload {\n    html?: string\n    filename?: string\n    title?: string\n    content?: string\n}\n\ninterface AcademicYearCreateData {\n    year_name: string\n    start_date: string\n    end_date: string\n    is_current: boolean\n}\n\nexport function registerAcademicHandlers(): void {\n    const db = getDatabase()\n\n    // ======== ACADEMIC YEAR & TERMS ========\n    ipcMain.handle('academicYear:getAll', async () => {\n        return db.prepare('SELECT * FROM academic_year ORDER BY year_name DESC').all()\n    })\n\n    ipcMain.handle('academicYear:getCurrent', async () => {\n        return db.prepare('SELECT * FROM academic_year WHERE is_current = 1').get()\n    })\n\n    ipcMain.handle('academicYear:create', async (_event, data: AcademicYearCreateData) => {\n        try {\n            db.transaction(() => {\n                if (data.is_current) {\n                    db.prepare('UPDATE academic_year SET is_current = 0').run()\n                }\n                const stmt = db.prepare('INSERT INTO academic_year (year_name, start_date, end_date, is_current) VALUES (?, ?, ?, ?)')\n                stmt.run(data.year_name, data.start_date, data.end_date, data.is_current ? 1 : 0)\n            })()\n            return { success: true }\n        } catch (error) {\n            console.error('Failed to create academic year:', error)\n            throw error\n        }\n    })\n\n    ipcMain.handle('academicYear:activate', async (_event, id: number) => {\n        try {\n            db.transaction(() => {\n                db.prepare('UPDATE academic_year SET is_current = 0').run()\n                db.prepare('UPDATE academic_year SET is_current = 1 WHERE id = ?').run(id)\n            })()\n            return { success: true }\n        } catch (error) {\n            console.error('Failed to activate academic year:', error)\n            throw error\n        }\n    })\n\n    ipcMain.handle('term:getByYear', async (_event, yearId: number) => {\n        return db.prepare('SELECT * FROM term WHERE academic_year_id = ? ORDER BY term_number').all(yearId)\n    })\n\n    ipcMain.handle('term:getCurrent', async () => {\n        return db.prepare('SELECT * FROM term WHERE is_current = 1').get()\n    })\n\n    // ======== STREAMS ========\n    ipcMain.handle('stream:getAll', async () => {\n        return db.prepare('SELECT * FROM stream WHERE is_active = 1 ORDER BY level_order').all()\n    })\n\n    // ======== EXAMS LIST ========\n    ipcMain.handle('academic:getExamsList', async (_event, filters: { academicYearId?: number; termId?: number }) => {\n        let query = 'SELECT id, name FROM academic_exam WHERE 1=1'\n        const params: Array<number> = []\n\n        if (filters.academicYearId) {\n            query += ' AND academic_year_id = ?'\n            params.push(filters.academicYearId)\n        }\n        if (filters.termId) {\n            query += ' AND term_id = ?'\n            params.push(filters.termId)\n        }\n\n        query += ' ORDER BY created_at DESC'\n        return db.prepare(query).all(...params)\n    })\n\n    // ======== PDF EXPORT (Placeholder) ========\n    ipcMain.handle('export:pdf', async (_event, data: ExportPdfPayload) => {\n        try {\n            const html = data.html || `\n              <html>\n                <head>\n                  <meta charset=\"utf-8\" />\n                  <style>\n                    body { font-family: Arial, sans-serif; padding: 24px; }\n                    h1 { font-size: 20px; margin-bottom: 8px; }\n                    p { font-size: 12px; color: #4b5563; }\n                    pre { background: #f9fafb; padding: 12px; border-radius: 6px; }\n                  </style>\n                </head>\n                <body>\n                  <h1>${data.title || 'Export'}</h1>\n                  <p>Generated: ${new Date().toLocaleString()}</p>\n                  <pre>${data.content || ''}</pre>\n                </body>\n              </html>\n            `\n            const buffer = await renderHtmlToPdfBuffer(html)\n            const filename = data.filename || `export_${Date.now()}.pdf`\n            const filePath = resolveOutputPath(filename, 'pdf')\n            writePdfBuffer(filePath, buffer)\n            return { success: true, filePath }\n        } catch (error) {\n            console.error('PDF export failed:', error)\n            return { success: false, error: error instanceof Error ? error.message : 'Unknown error' }\n        }\n    })\n\n    // ======== FEE CATEGORIES ========\n    ipcMain.handle('feeCategory:getAll', async () => {\n        return db.prepare('SELECT * FROM fee_category WHERE is_active = 1').all()\n    })\n\n    // ======== EXAM SCHEDULER (Stubs) ========\n    ipcMain.handle('schedule:generate', async (_event, data: { examId?: number; startDate?: string; endDate?: string }) => {\n        return generateSchedule(db, data.examId, data.startDate, data.endDate)\n    })\n\n    ipcMain.handle('schedule:detectClashes', async (_event, data: { examId?: number }) => {\n        if (!data.examId) {return []}\n        const generated = await generateSchedule(db, data.examId)\n        return detectClashes(db, data.examId, generated.slots)\n    })\n\n    ipcMain.handle('schedule:exportPDF', async (_event, data: { examId?: number; slots?: Array<Record<string, unknown>> }) => {\n        try {\n            const slots = data.slots || []\n            const rows = slots.map(slot => `\n              <tr>\n                <td>${slot['subject_name'] || ''}</td>\n                <td>${slot['start_date'] || ''}</td>\n                <td>${slot['start_time'] || ''} - ${slot['end_time'] || ''}</td>\n                <td>${slot['venue_name'] || ''}</td>\n              </tr>\n            `).join('')\n\n            const html = `\n              <html>\n                <head>\n                  <meta charset=\"utf-8\" />\n                  <style>\n                    body { font-family: Arial, sans-serif; padding: 24px; }\n                    h1 { font-size: 18px; }\n                    table { width: 100%; border-collapse: collapse; margin-top: 12px; }\n                    th, td { border: 1px solid #e5e7eb; padding: 8px; font-size: 12px; }\n                    th { background: #f3f4f6; text-align: left; }\n                  </style>\n                </head>\n                <body>\n                  <h1>Exam Timetable</h1>\n                  <p>Generated: ${new Date().toLocaleString()}</p>\n                  <table>\n                    <thead>\n                      <tr>\n                        <th>Subject</th>\n                        <th>Date</th>\n                        <th>Time</th>\n                        <th>Venue</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      ${rows}\n                    </tbody>\n                  </table>\n                </body>\n              </html>\n            `\n            const buffer = await renderHtmlToPdfBuffer(html)\n            const filename = `exam_timetable_${data.examId || 'export'}.pdf`\n            const filePath = resolveOutputPath(filename, 'timetables')\n            writePdfBuffer(filePath, buffer)\n            return { success: true, filePath }\n        } catch (error) {\n            console.error('Export timetable PDF failed:', error)\n            return { success: false, error: error instanceof Error ? error.message : 'Unknown error' }\n        }\n    })\n}\n\nfunction detectClashes(\n    db: ReturnType<typeof getDatabase>,\n    examId: number,\n    slots: Array<{ subject_id: number; start_date: string; start_time: string }>\n): Array<{ subject1_id: number; subject1_name: string; subject2_id: number; subject2_name: string; clash_type: string; affected_students: number }> {\n    const slotMap = new Map<number, string>()\n    for (const slot of slots) {\n        slotMap.set(slot.subject_id, `${slot.start_date} ${slot.start_time}`)\n    }\n\n    const results = db.prepare(`\n        SELECT student_id, subject_id\n        FROM exam_result\n        WHERE exam_id = ?\n    `).all(examId) as { student_id: number; subject_id: number }[]\n\n    const subjects = db.prepare(`SELECT id, name FROM subject`).all() as { id: number; name: string }[]\n    const subjectName = new Map(subjects.map(s => [s.id, s.name]))\n\n    const studentMap = new Map<number, number[]>()\n    for (const row of results) {\n        if (!studentMap.has(row.student_id)) {studentMap.set(row.student_id, [])}\n        studentMap.get(row.student_id)?.push(row.subject_id)\n    }\n\n    const clashCounts = new Map<string, number>()\n    for (const [_studentId, subjectIds] of studentMap.entries()) {\n        for (let i = 0; i < subjectIds.length; i += 1) {\n            for (let j = i + 1; j < subjectIds.length; j += 1) {\n                const s1 = subjectIds[i]\n                const s2 = subjectIds[j]\n                const slot1 = slotMap.get(s1)\n                const slot2 = slotMap.get(s2)\n                if (slot1 && slot2 && slot1 === slot2) {\n                    const key = `${s1}|${s2}|${slot1}`\n                    clashCounts.set(key, (clashCounts.get(key) || 0) + 1)\n                }\n            }\n        }\n    }\n\n    return Array.from(clashCounts.entries()).map(([key, count]) => {\n        const [s1, s2] = key.split('|')\n        const subject1Id = Number(s1)\n        const subject2Id = Number(s2)\n        return {\n            subject1_id: subject1Id,\n            subject1_name: subjectName.get(subject1Id) || 'Unknown',\n            subject2_id: subject2Id,\n            subject2_name: subjectName.get(subject2Id) || 'Unknown',\n            clash_type: 'TIME_CONFLICT',\n            affected_students: count\n        }\n    })\n}\n\nasync function generateSchedule(\n    db: ReturnType<typeof getDatabase>,\n    examId?: number,\n    startDate?: string,\n    endDate?: string\n): Promise<{\n    slots: Array<{\n        id: number\n        subject_id: number\n        subject_name: string\n        start_date: string\n        end_date: string\n        start_time: string\n        end_time: string\n        venue_id: number\n        venue_name: string\n        max_capacity: number\n        enrolled_students: number\n    }>,\n    clashes: Array<unknown>,\n    stats: { total_slots: number; total_students: number; venues_used: number; average_capacity_usage: number }\n}> {\n    if (!examId) {\n        return { slots: [], clashes: [], stats: { total_slots: 0, total_students: 0, venues_used: 0, average_capacity_usage: 0 } }\n    }\n\n    const exam = db.prepare('SELECT * FROM exam WHERE id = ?').get(examId) as { start_date?: string; end_date?: string } | undefined\n    const start = startDate || exam?.start_date || new Date().toISOString().slice(0, 10)\n    const end = endDate || exam?.end_date || new Date(Date.now() + 4 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10)\n\n    const subjects = db.prepare(`\n        SELECT DISTINCT s.id, s.name\n        FROM subject s\n        JOIN exam_result er ON er.subject_id = s.id\n        WHERE er.exam_id = ?\n        ORDER BY s.name\n    `).all(examId) as { id: number; name: string }[]\n\n    const subjectList = subjects.length > 0 ? subjects : (db.prepare(`SELECT id, name FROM subject ORDER BY name`).all() as { id: number; name: string }[])\n\n    const totalStudentsRow = db.prepare(`\n        SELECT COUNT(DISTINCT student_id) as count\n        FROM exam_result\n        WHERE exam_id = ?\n    `).get(examId) as { count: number } | undefined\n    const totalStudents = totalStudentsRow?.count || 0\n\n    const venues = [\n        { id: 1, name: 'Main Hall', capacity: Math.max(150, totalStudents) },\n        { id: 2, name: 'Classroom A', capacity: 60 },\n        { id: 3, name: 'Classroom B', capacity: 60 }\n    ]\n\n    const dateRange: string[] = []\n    const current = new Date(start)\n    const endDateObj = new Date(end)\n    while (current <= endDateObj) {\n        dateRange.push(current.toISOString().slice(0, 10))\n        current.setDate(current.getDate() + 1)\n    }\n\n    const timeSlots = [\n        { start: '09:00', end: '11:00' },\n        { start: '13:00', end: '15:00' }\n    ]\n\n    const slots: Array<{\n        id: number\n        subject_id: number\n        subject_name: string\n        start_date: string\n        end_date: string\n        start_time: string\n        end_time: string\n        venue_id: number\n        venue_name: string\n        max_capacity: number\n        enrolled_students: number\n    }> = []\n\n    let slotId = 1\n    let subjectIndex = 0\n    for (const day of dateRange) {\n        for (const time of timeSlots) {\n            if (subjectIndex >= subjectList.length) {break}\n            const subject = subjectList[subjectIndex]\n            const venue = venues[subjectIndex % venues.length]\n            slots.push({\n                id: slotId++,\n                subject_id: subject.id,\n                subject_name: subject.name,\n                start_date: day,\n                end_date: day,\n                start_time: time.start,\n                end_time: time.end,\n                venue_id: venue.id,\n                venue_name: venue.name,\n                max_capacity: venue.capacity,\n                enrolled_students: totalStudents\n            })\n            subjectIndex += 1\n        }\n    }\n\n    const clashes = detectClashes(db, examId, slots)\n    const avgUsage = slots.length > 0\n        ? (slots.reduce((sum, slot) => sum + (slot.max_capacity > 0 ? (slot.enrolled_students / slot.max_capacity) : 0), 0) / slots.length) * 100\n        : 0\n\n    return {\n        slots,\n        clashes,\n        stats: {\n            total_slots: slots.length,\n            total_students: totalStudents,\n            venues_used: venues.length,\n            average_capacity_usage: avgUsage\n        }\n    }\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\academic\\academic-system-handlers.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'registerAcademicSystemHandlers' has too many lines (125). Maximum allowed is 80.","line":38,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":191,"endColumn":2},{"ruleId":"max-statements","severity":1,"message":"Async arrow function has too many statements (34). Maximum allowed is 30.","line":91,"column":52,"nodeType":"ArrowFunctionExpression","messageId":"exceed","endLine":143,"endColumn":6}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { jsPDF } from 'jspdf'\nimport fs from 'node:fs'\nimport path from 'node:path'\n\nimport { getDatabase } from '../../database'\nimport { ipcMain , app } from '../../electron-env'\nimport {\n    AcademicSystemService,\n    type CreateExamDTO,\n    type SubjectAllocation,\n    type ExamResult,\n    type SubjectCreateData,\n    type SubjectUpdateData\n} from '../../services/academic/AcademicSystemService'\nimport { NotificationService } from '../../services/notifications/NotificationService'\n\nimport type { IpcMainInvokeEvent } from 'electron'\n\n\n\n\nlet cachedService: AcademicSystemService | null = null\nconst getService = () => {\n    if (!cachedService) {\n        cachedService = new AcademicSystemService()\n    }\n    return cachedService\n}\n\nlet cachedNotificationService: NotificationService | null = null\nconst getNotificationService = () => {\n    if (!cachedNotificationService) {\n        cachedNotificationService = new NotificationService()\n    }\n    return cachedNotificationService\n}\n\nexport function registerAcademicSystemHandlers(): void {\n    ipcMain.handle('academic:getSubjects', async () => {\n        return getService().getAllSubjects()\n    })\n\n    ipcMain.handle('academic:getSubjectsAdmin', async () => {\n        return getService().getAllSubjectsAdmin()\n    })\n\n    ipcMain.handle('academic:createSubject', async (_event: IpcMainInvokeEvent, data: SubjectCreateData, userId: number) => {\n        return getService().createSubject(data, userId)\n    })\n\n    ipcMain.handle('academic:updateSubject', async (_event: IpcMainInvokeEvent, id: number, data: SubjectUpdateData, userId: number) => {\n        return getService().updateSubject(id, data, userId)\n    })\n\n    ipcMain.handle('academic:setSubjectActive', async (_event: IpcMainInvokeEvent, id: number, isActive: boolean, userId: number) => {\n        return getService().setSubjectActive(id, isActive, userId)\n    })\n\n    ipcMain.handle('academic:getExams', async (_event: IpcMainInvokeEvent, academicYearId: number, termId: number) => {\n        return getService().getAllExams(academicYearId, termId)\n    })\n\n    ipcMain.handle('academic:createExam', async (_event: IpcMainInvokeEvent, data: unknown, userId: number) => {\n        return getService().createExam(data as CreateExamDTO, userId)\n    })\n\n    ipcMain.handle('academic:deleteExam', async (_event: IpcMainInvokeEvent, id: number, userId: number) => {\n        return getService().deleteExam(id, userId)\n    })\n\n    ipcMain.handle('academic:allocateTeacher', async (_event: IpcMainInvokeEvent, data: unknown, userId: number) => {\n        return getService().allocateTeacher(data as Omit<SubjectAllocation, 'id'>, userId)\n    })\n\n    ipcMain.handle('academic:getAllocations', async (_event: IpcMainInvokeEvent, academicYearId: number, termId: number, streamId?: number) => {\n        return getService().getAllocations(academicYearId, termId, streamId)\n    })\n\n    ipcMain.handle('academic:saveResults', async (_event: IpcMainInvokeEvent, examId: number, results: unknown[], userId: number) => {\n        return getService().saveResults(examId, results as Omit<ExamResult, 'id' | 'exam_id'>[], userId)\n    })\n\n    ipcMain.handle('academic:getResults', async (_event: IpcMainInvokeEvent, examId: number, subjectId: number, streamId: number, userId: number) => {\n        return getService().getResults(examId, subjectId, streamId, userId)\n    })\n\n    ipcMain.handle('academic:processResults', async (_event: IpcMainInvokeEvent, examId: number, userId: number) => {\n        return getService().processResults(examId, userId)\n    })\n\n    ipcMain.handle('academic:generateCertificate', async (_event: IpcMainInvokeEvent, data: {\n        studentId: number;\n        studentName: string;\n        awardCategory: string;\n        academicYearId: number;\n        improvementPercentage: number;\n    }) => {\n        const certificatesDir = path.join(app.getPath('userData'), 'certificates')\n        if (!fs.existsSync(certificatesDir)) {\n            fs.mkdirSync(certificatesDir, { recursive: true })\n        }\n\n        const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' })\n        const pageWidth = doc.internal.pageSize.getWidth()\n        let y = 30\n\n        doc.setFont('helvetica', 'bold')\n        doc.setFontSize(26)\n        doc.text('Certificate of Achievement', pageWidth / 2, y, { align: 'center' })\n        y += 15\n\n        doc.setFont('helvetica', 'normal')\n        doc.setFontSize(14)\n        doc.text('This certificate is proudly presented to', pageWidth / 2, y, { align: 'center' })\n        y += 12\n\n        doc.setFont('helvetica', 'bold')\n        doc.setFontSize(22)\n        doc.text(data.studentName, pageWidth / 2, y, { align: 'center' })\n        y += 12\n\n        doc.setFont('helvetica', 'normal')\n        doc.setFontSize(13)\n        doc.text(`for outstanding improvement in ${data.awardCategory.replace('_', ' ')}`, pageWidth / 2, y, { align: 'center' })\n        y += 10\n\n        doc.text(`Improvement: ${data.improvementPercentage.toFixed(1)}%`, pageWidth / 2, y, { align: 'center' })\n        y += 15\n\n        doc.setFontSize(11)\n        doc.text(`Academic Year ID: ${data.academicYearId}`, pageWidth / 2, y, { align: 'center' })\n        y += 8\n\n        doc.setFontSize(10)\n        doc.text(`Generated: ${new Date().toLocaleDateString()}`, pageWidth / 2, y, { align: 'center' })\n\n        const filename = `certificate-${data.studentId}-${Date.now()}.pdf`\n        const filePath = path.join(certificatesDir, filename)\n        const pdfBytes = doc.output('arraybuffer')\n        fs.writeFileSync(filePath, Buffer.from(pdfBytes))\n\n        return { success: true, filePath }\n    })\n\n    ipcMain.handle('academic:emailParents', async (_event: IpcMainInvokeEvent, data: {\n        students: Array<{ student_id: number; student_name: string; improvement_percentage: number }>;\n        awardCategory: string;\n        templateType: string;\n    }, userId: number) => {\n        const db = getDatabase()\n        let sent = 0\n        let failed = 0\n        const errors: string[] = []\n\n        for (const student of data.students) {\n            const record = db.prepare('SELECT guardian_email, guardian_name FROM student WHERE id = ?').get(student.student_id) as { guardian_email?: string; guardian_name?: string } | undefined\n            const email = record?.guardian_email\n            if (!email) {\n                failed++\n                errors.push(`${student.student_name}: missing guardian email`)\n                continue\n            }\n\n            const subject = `Recognition: ${student.student_name} - ${data.awardCategory.replace('_', ' ')}`\n            const message = `\n                <p>Dear ${record.guardian_name || 'Parent/Guardian'},</p>\n                <p>We are pleased to inform you that <strong>${student.student_name}</strong> has been recognized for outstanding improvement.</p>\n                <p><strong>Award:</strong> ${data.awardCategory.replace('_', ' ')}</p>\n                <p><strong>Improvement:</strong> ${student.improvement_percentage.toFixed(1)}%</p>\n                <p>Congratulations!</p>\n            `\n\n            const result = await getNotificationService().send({\n                recipientType: 'GUARDIAN',\n                recipientId: student.student_id,\n                channel: 'EMAIL',\n                to: email,\n                subject,\n                message\n            }, userId)\n\n            if (result.success) {sent++}\n            else {\n                failed++\n                errors.push(`${student.student_name}: ${result.error || 'failed'}`)\n            }\n        }\n\n        return { success: failed === 0, sent, failed, errors }\n    })\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\academic\\attendance-handlers.ts","messages":[{"ruleId":"max-params","severity":1,"message":"Async arrow function has too many parameters (7). Maximum allowed is 5.","line":33,"column":7,"nodeType":"ArrowFunctionExpression","messageId":"exceed","endLine":33,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ipcMain } from '../../electron-env'\r\nimport { AttendanceService, type DailyAttendanceEntry } from '../../services/academic/AttendanceService'\n\nimport type { IpcMainInvokeEvent } from 'electron'\n\nlet cachedService: AttendanceService | null = null\nconst getService = () => {\n    if (!cachedService) {\n        cachedService = new AttendanceService()\n    }\n    return cachedService\n}\n\r\nexport function registerAttendanceHandlers(): void {\r\n    ipcMain.handle('attendance:getByDate', async (\r\n        _event: IpcMainInvokeEvent,\r\n        streamId: number,\r\n        date: string,\r\n        academicYearId: number,\r\n        termId: number\r\n    ) => {\r\n        return getService().getAttendanceByDate(streamId, date, academicYearId, termId)\n    })\n\r\n    ipcMain.handle('attendance:markAttendance', async (\r\n        _event: IpcMainInvokeEvent,\r\n        entries: DailyAttendanceEntry[],\r\n        streamId: number,\r\n        date: string,\r\n        academicYearId: number,\r\n        termId: number,\r\n        userId: number\r\n    ) => {\r\n        return getService().markAttendance(entries, streamId, date, academicYearId, termId, userId)\n    })\n\r\n    ipcMain.handle('attendance:getStudentSummary', async (\r\n        _event: IpcMainInvokeEvent,\r\n        studentId: number,\r\n        academicYearId: number,\r\n        termId?: number\r\n    ) => {\r\n        return getService().getStudentAttendanceSummary(studentId, academicYearId, termId)\n    })\n\r\n    ipcMain.handle('attendance:getClassSummary', async (\r\n        _event: IpcMainInvokeEvent,\r\n        streamId: number,\r\n        date: string,\r\n        academicYearId: number,\r\n        termId: number\r\n    ) => {\r\n        return getService().getClassAttendanceSummary(streamId, date, academicYearId, termId)\n    })\n\r\n    ipcMain.handle('attendance:getStudentsForMarking', async (\r\n        _event: IpcMainInvokeEvent,\r\n        streamId: number,\r\n        academicYearId: number,\r\n        termId: number\r\n    ) => {\r\n        return getService().getStudentsForAttendance(streamId, academicYearId, termId)\n    })\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\academic\\awards-handlers.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'registerAwardsHandlers' has too many lines (172). Maximum allowed is 80.","line":30,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":230,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database';\r\nimport { ipcMain } from '../../electron-env';\n\r\nimport type { IpcMainInvokeEvent } from 'electron';\r\n\r\n// Roles that can approve awards\r\nconst APPROVER_ROLES = ['ADMIN', 'PRINCIPAL', 'DEPUTY_PRINCIPAL'];\r\n\r\ninterface AwardAssignParams {\r\n  studentId: number;\r\n  categoryId: number;\r\n  academicYearId: number;\r\n  termId?: number;\r\n  userId: number;\r\n  userRole: string;\r\n  remarks?: string;\r\n}\r\n\r\ninterface AwardApproveParams {\r\n  awardId: number;\r\n  userId: number;\r\n}\r\n\r\ninterface AwardRejectParams {\r\n  awardId: number;\r\n  userId: number;\r\n  reason: string;\r\n}\r\n\r\nexport function registerAwardsHandlers() {\r\n  const db = getDatabase();\r\n\r\n  // Assign award to student\r\n  ipcMain.handle('awards:assign', async (_event: IpcMainInvokeEvent, params: AwardAssignParams) => {\r\n    try {\r\n      // Auto-approve if user is ADMIN/PRINCIPAL/DEPUTY_PRINCIPAL\r\n      const autoApprove = APPROVER_ROLES.includes(params.userRole);\r\n      const status = autoApprove ? 'approved' : 'pending';\r\n      const approvedAt = autoApprove ? new Date().toISOString() : null;\r\n      const approvedBy = autoApprove ? params.userId : null;\r\n\r\n      const result = db.prepare(`\r\n        INSERT INTO student_award (\r\n          student_id, award_category_id, academic_year_id, term_id,\r\n          awarded_date, remarks, approval_status, assigned_by_user_id,\r\n          approved_by_user_id, approved_at\r\n        )\r\n        VALUES (?, ?, ?, ?, datetime('now'), ?, ?, ?, ?, ?)\r\n      `).run(\r\n        params.studentId, params.categoryId, params.academicYearId, params.termId || null,\r\n        params.remarks || null, status, params.userId, approvedBy, approvedAt\r\n      );\r\n\r\n      return {\r\n        id: result.lastInsertRowid,\r\n        status: 'success',\r\n        approval_status: status,\r\n        auto_approved: autoApprove\r\n      };\r\n    } catch (error: unknown) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      throw new Error(`Failed to assign award: ${message}`);\r\n    }\r\n  });\r\n\r\n  // Get all awards with filtering\r\n  ipcMain.handle('awards:getAll', async (_event: IpcMainInvokeEvent, params?: {\r\n    status?: string;\r\n    categoryId?: number;\r\n    academicYearId?: number;\r\n    termId?: number;\r\n  }) => {\r\n    try {\r\n      let query = `\r\n        SELECT \r\n          sa.*,\r\n          ac.name as category_name, \r\n          ac.category_type,\r\n          st.admission_number, \r\n          st.first_name, \r\n          st.last_name,\r\n          st.first_name || ' ' || st.last_name as student_name,\r\n          u1.full_name as assigned_by_name,\r\n          u2.full_name as approved_by_name\r\n        FROM student_award sa\r\n        JOIN award_category ac ON sa.award_category_id = ac.id\r\n        JOIN student st ON sa.student_id = st.id\r\n        LEFT JOIN user u1 ON sa.assigned_by_user_id = u1.id\r\n        LEFT JOIN user u2 ON sa.approved_by_user_id = u2.id\r\n        WHERE 1=1\r\n      `;\r\n      const args: (string | number)[] = [];\r\n\r\n      if (params?.status && params.status !== 'all') {\r\n        query += ` AND sa.approval_status = ?`;\r\n        args.push(params.status);\r\n      }\r\n\r\n      if (params?.categoryId) {\r\n        query += ` AND sa.award_category_id = ?`;\r\n        args.push(params.categoryId);\r\n      }\r\n\r\n      if (params?.academicYearId) {\r\n        query += ` AND sa.academic_year_id = ?`;\r\n        args.push(params.academicYearId);\r\n      }\r\n\r\n      if (params?.termId) {\r\n        query += ` AND sa.term_id = ?`;\r\n        args.push(params.termId);\r\n      }\r\n\r\n      query += ` ORDER BY sa.created_at DESC`;\r\n\r\n      return db.prepare(query).all(...args);\r\n    } catch (error: unknown) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      throw new Error(`Failed to get awards: ${message}`);\r\n    }\r\n  });\r\n\r\n  // Approve an award\r\n  ipcMain.handle('awards:approve', async (_event: IpcMainInvokeEvent, params: AwardApproveParams) => {\r\n    try {\r\n      db.prepare(`\r\n        UPDATE student_award \r\n        SET approval_status = 'approved', \r\n            approved_by_user_id = ?, \r\n            approved_at = datetime('now')\r\n        WHERE id = ?\r\n      `).run(params.userId, params.awardId);\r\n\r\n      return { status: 'success', message: 'Award approved successfully' };\r\n    } catch (error: unknown) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      throw new Error(`Failed to approve award: ${message}`);\r\n    }\r\n  });\r\n\r\n  // Reject an award\r\n  ipcMain.handle('awards:reject', async (_event: IpcMainInvokeEvent, params: AwardRejectParams) => {\r\n    try {\r\n      db.prepare(`\r\n        UPDATE student_award \r\n        SET approval_status = 'rejected', \r\n            approved_by_user_id = ?, \r\n            approved_at = datetime('now'),\r\n            rejection_reason = ?\r\n        WHERE id = ?\r\n      `).run(params.userId, params.reason, params.awardId);\r\n\r\n      return { status: 'success', message: 'Award rejected' };\r\n    } catch (error: unknown) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      throw new Error(`Failed to reject award: ${message}`);\r\n    }\r\n  });\r\n\r\n  // Get pending awards count (for badge/notification)\r\n  ipcMain.handle('awards:getPendingCount', async () => {\r\n    try {\r\n      const result = db.prepare(`\r\n        SELECT COUNT(*) as count FROM student_award WHERE approval_status = 'pending'\r\n      `).get() as { count: number };\r\n      return result.count;\r\n    } catch (error: unknown) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      throw new Error(`Failed to get pending count: ${message}`);\r\n    }\r\n  });\r\n\r\n  // Get student awards\r\n  ipcMain.handle('awards:getStudentAwards', async (_event: IpcMainInvokeEvent, studentId: number) => {\r\n    try {\r\n      return db.prepare(`\r\n        SELECT sa.*, ac.name as category_name, ac.category_type\r\n        FROM student_award sa\r\n        JOIN award_category ac ON sa.award_category_id = ac.id\r\n        WHERE sa.student_id = ?\r\n        ORDER BY sa.awarded_date DESC\r\n      `).all(studentId);\r\n    } catch (error: unknown) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      throw new Error(`Failed to get student awards: ${message}`);\r\n    }\r\n  });\r\n\r\n  // Get award by ID\r\n  ipcMain.handle('awards:getById', async (_event: IpcMainInvokeEvent, awardId: number) => {\r\n    try {\r\n      return db.prepare(`\r\n        SELECT sa.*, ac.name as category_name, ac.category_type, \r\n               st.admission_number, st.first_name, st.last_name\r\n        FROM student_award sa\r\n        JOIN award_category ac ON sa.award_category_id = ac.id\r\n        JOIN student st ON sa.student_id = st.id\r\n        WHERE sa.id = ?\r\n      `).get(awardId);\r\n    } catch (error: unknown) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      throw new Error(`Failed to get award: ${message}`);\r\n    }\r\n  });\r\n\r\n  // Delete award\r\n  ipcMain.handle('awards:delete', async (_event: IpcMainInvokeEvent, awardId: number) => {\r\n    try {\r\n      db.prepare(`DELETE FROM student_award WHERE id = ?`).run(awardId);\r\n      return { status: 'success', message: 'Award deleted' };\r\n    } catch (error: unknown) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      throw new Error(`Failed to delete award: ${message}`);\r\n    }\r\n  });\r\n\r\n  // Get award categories\r\n  ipcMain.handle('awards:getCategories', async () => {\r\n    try {\r\n      return db.prepare(`\r\n        SELECT * FROM award_category\r\n        WHERE is_active = 1\r\n        ORDER BY sort_order ASC, name ASC\r\n      `).all();\r\n    } catch (error: unknown) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      throw new Error(`Failed to get award categories: ${message}`);\r\n    }\r\n  });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\academic\\cbc-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\academic\\exam-analysis-handlers.ts","messages":[{"ruleId":"sonarjs/arguments-order","severity":1,"message":"Arguments 'subjectId' and 'examId' have the same names but not the same order as the function parameters.","line":15,"column":52,"nodeType":null,"endLine":15,"endColumn":69}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ipcMain } from '../../electron-env';\r\nimport { ExamAnalysisService } from '../../services/academic/ExamAnalysisService';\n\nlet cachedService: ExamAnalysisService | null = null;\nconst getService = () => {\n  if (!cachedService) {\n    cachedService = new ExamAnalysisService();\n  }\n  return cachedService;\n};\n\r\nexport function registerExamAnalysisHandlers() {\r\n  ipcMain.handle('exam-analysis:getSubjectAnalysis', async (_event, subjectId: number, examId: number) => {\r\n    try {\r\n      return await getService().getSubjectAnalysis(subjectId, examId);\n    } catch (error) {\r\n      throw new Error(`Failed to analyze subject: ${error.message}`);\r\n    }\r\n  });\r\n\r\n  ipcMain.handle('exam-analysis:analyzeAllSubjects', async (_event, examId: number) => {\r\n    try {\r\n      return await getService().analyzeAllSubjects(examId);\n    } catch (error) {\r\n      throw new Error(`Failed to analyze all subjects: ${error.message}`);\r\n    }\r\n  });\r\n\r\n  ipcMain.handle('exam-analysis:getTeacherPerf', async (_event, teacherId: number, examId?: number) => {\r\n    try {\r\n      return await getService().getTeacherPerformance(teacherId, examId);\n    } catch (error) {\r\n      throw new Error(`Failed to get teacher performance: ${error.message}`);\r\n    }\r\n  });\r\n\r\n  ipcMain.handle('exam-analysis:getStudentPerf', async (_event, studentId: number, examId: number) => {\r\n    try {\r\n      return await getService().getStudentPerformance(studentId, examId);\n    } catch (error) {\r\n      throw new Error(`Failed to get student performance: ${error.message}`);\r\n    }\r\n  });\r\n\r\n  ipcMain.handle('exam-analysis:getStruggling', async (_event, examId: number, threshold?: number) => {\r\n    try {\r\n      return await getService().getStrugglingStudents(examId, threshold ?? 50);\n    } catch (error) {\r\n      throw new Error(`Failed to get struggling students: ${error.message}`);\r\n    }\r\n  });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\academic\\jss-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\academic\\merit-list-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\academic\\performance-analysis-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\academic\\promotion-handlers.ts","messages":[{"ruleId":"max-params","severity":1,"message":"Async arrow function has too many parameters (8). Maximum allowed is 5.","line":51,"column":7,"nodeType":"ArrowFunctionExpression","messageId":"exceed","endLine":51,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ipcMain } from '../../electron-env'\r\nimport { PromotionService } from '../../services/academic/PromotionService'\n\nimport type { IpcMainInvokeEvent } from 'electron'\n\nlet cachedService: PromotionService | null = null\nconst getService = () => {\n    if (!cachedService) {\n        cachedService = new PromotionService()\n    }\n    return cachedService\n}\n\r\nexport function registerPromotionHandlers(): void {\r\n    ipcMain.handle('promotion:getStreams', async () => {\r\n        return getService().getStreams()\n    })\n\r\n    ipcMain.handle('promotion:getStudentsForPromotion', async (\r\n        _event: IpcMainInvokeEvent,\r\n        streamId: number,\r\n        academicYearId: number\r\n    ) => {\r\n        return getService().getStudentsForPromotion(streamId, academicYearId)\n    })\n\r\n    ipcMain.handle('promotion:promoteStudent', async (\r\n        _event: IpcMainInvokeEvent,\r\n        data: {\r\n            student_id: number\r\n            from_stream_id: number\r\n            to_stream_id: number\r\n            from_academic_year_id: number\r\n            to_academic_year_id: number\r\n            to_term_id: number\r\n        },\r\n        userId: number\r\n    ) => {\r\n        return getService().promoteStudent(data, userId)\n    })\n\r\n    ipcMain.handle('promotion:batchPromote', async (\r\n        _event: IpcMainInvokeEvent,\r\n        studentIds: number[],\r\n        fromStreamId: number,\r\n        toStreamId: number,\r\n        fromAcademicYearId: number,\r\n        toAcademicYearId: number,\r\n        toTermId: number,\r\n        userId: number\r\n    ) => {\r\n        return getService().batchPromote(\n            studentIds, fromStreamId, toStreamId,\n            fromAcademicYearId, toAcademicYearId, toTermId, userId\n        )\n    })\n\r\n    ipcMain.handle('promotion:getStudentHistory', async (\r\n        _event: IpcMainInvokeEvent,\r\n        studentId: number\r\n    ) => {\r\n        return getService().getStudentPromotionHistory(studentId)\n    })\n\r\n    ipcMain.handle('promotion:getNextStream', async (\r\n        _event: IpcMainInvokeEvent,\r\n        currentStreamId: number\r\n    ) => {\r\n        return getService().getNextStream(currentStreamId)\n    })\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\academic\\report-card-analytics-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\academic\\reportcard-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\audit\\audit-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\auth\\auth-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\backup\\backup-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\data\\import-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\exemption\\exemption-handlers.ts","messages":[{"ruleId":"max-params","severity":1,"message":"Async arrow function has too many parameters (6). Maximum allowed is 5.","line":26,"column":181,"nodeType":"ArrowFunctionExpression","messageId":"exceed","endLine":26,"endColumn":183}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ipcMain } from '../../electron-env'\nimport { ExemptionService, type ExemptionCreateData } from '../../services/finance/ExemptionService'\n\r\nimport type { IpcMainInvokeEvent } from 'electron'\n\r\nexport function registerExemptionHandlers(): void {\r\n    const exemptionService = new ExemptionService()\r\n\r\n    ipcMain.handle('exemption:getAll', async (_event: IpcMainInvokeEvent, filters?: {\r\n        studentId?: number;\r\n        academicYearId?: number;\r\n        termId?: number;\r\n        status?: string\r\n    }) => {\r\n        return exemptionService.getExemptions(filters)\r\n    })\r\n\r\n    ipcMain.handle('exemption:getById', async (_event: IpcMainInvokeEvent, id: number) => {\r\n        return exemptionService.getExemptionById(id)\r\n    })\r\n\r\n    ipcMain.handle('exemption:getStudentExemptions', async (_event: IpcMainInvokeEvent, studentId: number, academicYearId: number, termId: number) => {\r\n        return exemptionService.getStudentExemptions(studentId, academicYearId, termId)\r\n    })\r\n\r\n    ipcMain.handle('exemption:calculate', async (_event: IpcMainInvokeEvent, studentId: number, academicYearId: number, termId: number, categoryId: number, originalAmount: number) => {\r\n        return exemptionService.calculateExemption(studentId, academicYearId, termId, categoryId, originalAmount)\r\n    })\r\n\r\n    ipcMain.handle('exemption:create', async (_event: IpcMainInvokeEvent, data: ExemptionCreateData, userId: number) => {\r\n        return exemptionService.createExemption(data, userId)\r\n    })\r\n\r\n    ipcMain.handle('exemption:revoke', async (_event: IpcMainInvokeEvent, id: number, reason: string, userId: number) => {\r\n        return exemptionService.revokeExemption(id, reason, userId)\r\n    })\r\n\r\n    ipcMain.handle('exemption:getStats', async (_event: IpcMainInvokeEvent, academicYearId?: number) => {\r\n        return exemptionService.getExemptionStats(academicYearId)\r\n    })\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\finance\\approval-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\finance\\bank-handlers.ts","messages":[{"ruleId":"max-params","severity":1,"message":"Async arrow function has too many parameters (6). Maximum allowed is 5.","line":52,"column":7,"nodeType":"ArrowFunctionExpression","messageId":"exceed","endLine":52,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ipcMain } from '../../electron-env'\r\nimport { BankReconciliationService } from '../../services/finance/BankReconciliationService'\n\nimport type { IpcMainInvokeEvent } from 'electron'\n\nlet cachedService: BankReconciliationService | null = null\nconst getService = () => {\n    if (!cachedService) {\n        cachedService = new BankReconciliationService()\n    }\n    return cachedService\n}\n\r\nexport function registerBankReconciliationHandlers(): void {\r\n    // Bank Accounts\r\n    ipcMain.handle('bank:getAccounts', async () => {\r\n        return getService().getBankAccounts()\n    })\n\r\n    ipcMain.handle('bank:getAccountById', async (_event: IpcMainInvokeEvent, id: number) => {\r\n        return getService().getBankAccountById(id)\n    })\n\r\n    ipcMain.handle('bank:createAccount', async (_event: IpcMainInvokeEvent, data: {\r\n        account_name: string\r\n        account_number: string\r\n        bank_name: string\r\n        branch?: string\r\n        swift_code?: string\r\n        currency?: string\r\n        opening_balance: number\r\n    }) => {\r\n        return getService().createBankAccount(data)\n    })\n\r\n    // Bank Statements\r\n    ipcMain.handle('bank:getStatements', async (_event: IpcMainInvokeEvent, bankAccountId?: number) => {\r\n        return getService().getStatements(bankAccountId)\n    })\n\r\n    ipcMain.handle('bank:getStatementWithLines', async (_event: IpcMainInvokeEvent, statementId: number) => {\r\n        return getService().getStatementWithLines(statementId)\n    })\n\r\n    ipcMain.handle('bank:createStatement', async (\r\n        _event: IpcMainInvokeEvent,\r\n        bankAccountId: number,\r\n        statementDate: string,\r\n        openingBalance: number,\r\n        closingBalance: number,\r\n        reference?: string\r\n    ) => {\r\n        return getService().createStatement(bankAccountId, statementDate, openingBalance, closingBalance, reference)\n    })\n\r\n    ipcMain.handle('bank:addStatementLine', async (\r\n        _event: IpcMainInvokeEvent,\r\n        statementId: number,\r\n        line: {\r\n            transaction_date: string\r\n            description: string\r\n            reference?: string | null\r\n            debit_amount: number\r\n            credit_amount: number\r\n            running_balance?: number | null\r\n        }\r\n    ) => {\r\n        return getService().addStatementLine(statementId, {\n            ...line,\n            reference: line.reference ?? null,\n            running_balance: line.running_balance ?? null\n        })\n    })\n\r\n    // Reconciliation\r\n    ipcMain.handle('bank:matchTransaction', async (\r\n        _event: IpcMainInvokeEvent,\r\n        lineId: number,\r\n        transactionId: number\r\n    ) => {\r\n        return getService().matchTransaction(lineId, transactionId)\n    })\n\r\n    ipcMain.handle('bank:unmatchTransaction', async (_event: IpcMainInvokeEvent, lineId: number) => {\r\n        return getService().unmatchTransaction(lineId)\n    })\n\r\n    ipcMain.handle('bank:getUnmatchedTransactions', async (\r\n        _event: IpcMainInvokeEvent,\r\n        startDate: string,\r\n        endDate: string\r\n    ) => {\r\n        return getService().getUnmatchedLedgerTransactions(startDate, endDate)\n    })\n\r\n    ipcMain.handle('bank:markReconciled', async (\r\n        _event: IpcMainInvokeEvent,\r\n        statementId: number,\r\n        userId: number\r\n    ) => {\r\n        return getService().markStatementReconciled(statementId, userId)\n    })\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\finance\\budget-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\finance\\finance-handlers.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'registerFinanceHandlers' has too many lines (418). Maximum allowed is 80.","line":15,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":539,"endColumn":2},{"ruleId":"max-statements","severity":1,"message":"Function 'registerFinanceHandlers' has too many statements (36). Maximum allowed is 30.","line":15,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":539,"endColumn":2},{"ruleId":"max-lines-per-function","severity":1,"message":"Async arrow function has too many lines (100). Maximum allowed is 80.","line":248,"column":45,"nodeType":"ArrowFunctionExpression","messageId":"exceed","endLine":387,"endColumn":6},{"ruleId":"max-statements","severity":1,"message":"Arrow function has too many statements (34). Maximum allowed is 30.","line":299,"column":44,"nodeType":"ArrowFunctionExpression","messageId":"exceed","endLine":377,"endColumn":10},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":395,"column":88,"nodeType":"Literal","endLine":395,"endColumn":103}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type PaymentData, type PaymentResult, type TransactionData, TransactionFilters as _TransactionFilters, type InvoiceData, type InvoiceItem, type FeeStructureItemData, type FeeInvoiceDB, type FeeInvoiceWithDetails, type FeeStructureWithDetails, type InvoiceItemCreation } from './types'\nimport { getDatabase } from '../../database'\nimport { logAudit } from '../../database/utils/audit'\nimport { ipcMain } from '../../electron-env'\nimport { CashFlowService } from '../../services/finance/CashFlowService'\nimport { CreditAutoApplicationService } from '../../services/finance/CreditAutoApplicationService'\nimport { ExemptionService } from '../../services/finance/ExemptionService'\nimport { FeeProrationService } from '../../services/finance/FeeProrationService'\nimport { PaymentService } from '../../services/finance/PaymentService'\nimport { ScholarshipService, type ScholarshipData, type AllocationData } from '../../services/finance/ScholarshipService'\nimport { validateAmount, validateId, validateDate as _validateDate, sanitizeString } from '../../utils/validation'\n\nimport type { IpcMainInvokeEvent } from 'electron'\n\nexport function registerFinanceHandlers(): void {\n    const db = getDatabase()\n    const exemptionService = new ExemptionService()\n    const paymentService = new PaymentService(db)\n    const getOrCreateCategoryId = (name: string, type: 'INCOME' | 'EXPENSE' = 'INCOME'): number => {\n        const row = db.prepare('SELECT id FROM transaction_category WHERE category_name = ? LIMIT 1').get(name) as { id: number } | undefined\n        if (row?.id) {return row.id}\n        const res = db.prepare('INSERT INTO transaction_category (category_name, category_type, is_system, is_active) VALUES (?, ?, 1, 1)').run(name, type)\n        return res.lastInsertRowid as number\n    }\n\n    // Cash Flow & Forecasting\n    ipcMain.handle('finance:getCashFlow', async (_event: IpcMainInvokeEvent, startDate: string, endDate: string) => {\n        return CashFlowService.getCashFlowStatement(startDate, endDate)\n    })\n\n    ipcMain.handle('finance:getForecast', async (_event: IpcMainInvokeEvent, months: number) => {\n        return CashFlowService.getForecast(months)\n    })\n\n    // ======== FEE PAYMENTS ========\n    ipcMain.handle('payment:record', async (_event: IpcMainInvokeEvent, data: PaymentData, userId: number): Promise<PaymentResult | { success: false, message: string }> => {\n        // --- VALIDATION ---\n        const vAmount = validateAmount(data.amount)\n        if (!vAmount.success) {return { success: false, message: vAmount.error! }}\n\n        const vStudent = validateId(data.student_id, 'Student')\n        if (!vStudent.success) {return { success: false, message: vStudent.error! }}\n\n        const amountCents = vAmount.data!\n        const description = sanitizeString(data.description) || 'Tuition Fee Payment'\n        const paymentRef = sanitizeString(data.payment_reference)\n\n        try {\n            const result = paymentService.recordPayment({\n                student_id: data.student_id,\n                amount: amountCents,\n                transaction_date: data.transaction_date,\n                payment_method: data.payment_method,\n                payment_reference: paymentRef,\n                description,\n                recorded_by_user_id: userId,\n                invoice_id: data.invoice_id,\n                term_id: data.term_id || 0, // Ensure term_id is passed, default to 0 if missing (should be validated upstream)\n                amount_in_words: data.amount_in_words\n            })\n\n            if (result.success) {\n                return {\n                    success: true,\n                    transactionRef: result.transactionRef!,\n                    receiptNumber: result.receiptNumber!\n                }\n            } else {\n                return {\n                    success: false,\n                    message: result.message\n                }\n            }\n        } catch (error) {\n            console.error('Payment processing error:', error)\n            return { success: false, message: error instanceof Error ? error.message : 'Unknown payment error' }\n        }\n    })\n\n    ipcMain.handle('invoice:getItems', async (_event: IpcMainInvokeEvent, invoiceId: number) => {\n        const items = db.prepare(`\n            SELECT ii.*, fc.category_name \n            FROM invoice_item ii\n            JOIN fee_category fc ON ii.fee_category_id = fc.id\n            WHERE ii.invoice_id = ?\n        `).all(invoiceId) as InvoiceItem[]\n\n        return items.map(item => ({\n            ...item,\n            amount: item.amount\n        }))\n    })\n\n    ipcMain.handle('payment:getByStudent', async (_event: IpcMainInvokeEvent, studentId: number) => {\n        const payments = db.prepare(`SELECT lt.*, r.receipt_number FROM ledger_transaction lt\n      LEFT JOIN receipt r ON lt.id = r.transaction_id\n      WHERE lt.student_id = ? AND lt.transaction_type = 'FEE_PAYMENT' AND lt.is_voided = 0\n      ORDER BY lt.transaction_date DESC`).all(studentId) as (TransactionData & { receipt_number: string, id: number })[]\n\n        return payments.map(p => ({\n            ...p,\n            amount: p.amount\n        }))\n    })\n\n    ipcMain.handle('payment:payWithCredit', async (_event: IpcMainInvokeEvent, data: { studentId: number, invoiceId: number, amount: number }, userId: number) => {\n        return db.transaction(() => {\n            // 1. Get current credit balance\n            const student = db.prepare('SELECT credit_balance FROM student WHERE id = ?').get(data.studentId) as { credit_balance: number }\n            const currentCredit = student.credit_balance || 0\n            const amountCents = data.amount\n\n            if (currentCredit < amountCents) {\n                return { success: false, message: 'Insufficient credit balance' }\n            }\n\n            // 2. Create transaction record\n            const txnRef = `TXN-CREDIT-${Date.now()}`\n            const categoryId = getOrCreateCategoryId('School Fees', 'INCOME')\n            const txnStmt = db.prepare(`INSERT INTO ledger_transaction (\n                transaction_ref, transaction_date, transaction_type, category_id, amount, debit_credit,\n                student_id, payment_method, payment_reference, description, recorded_by_user_id, invoice_id\n            ) VALUES (?, ?, 'FEE_PAYMENT', ?, ?, 'CREDIT', ?, 'CASH', 'CREDIT_BALANCE', 'Payment via Credit Balance', ?, ?)`)\n\n            const txnResult = txnStmt.run(\n                txnRef, new Date().toISOString().slice(0, 10), categoryId, amountCents,\n                data.studentId, userId, data.invoiceId\n            )\n\n            // 3. Update Invoice\n            db.prepare(`UPDATE fee_invoice SET amount_paid = amount_paid + ?, \n                status = CASE WHEN amount_paid + ? >= total_amount THEN 'PAID' ELSE 'PARTIAL' END \n                WHERE id = ?`).run(amountCents, amountCents, data.invoiceId)\n\n            // 4. Deduct from Credit Balance\n            db.prepare('UPDATE student SET credit_balance = credit_balance - ? WHERE id = ?').run(amountCents, data.studentId)\n\n            logAudit(userId, 'CREATE', 'ledger_transaction', txnResult.lastInsertRowid as number, null, { action: 'PAY_WITH_CREDIT', amount: amountCents, invoiceId: data.invoiceId })\n\n            return { success: true }\n        })()\n    })\n\n    // ======== INVOICES ========\n    ipcMain.handle('invoice:create', async (_event: IpcMainInvokeEvent, data: InvoiceData, items: InvoiceItem[], userId: number) => {\n        return db.transaction(() => {\n            const invNum = `INV-${new Date().toISOString().slice(0, 10).replace(/-/g, '')}-${String(Date.now()).slice(-6)}`\n            // Items are expected to be in cents\n            const itemsInCents = items.map(i => ({ ...i, amount: i.amount }))\n            const totalCents = itemsInCents.reduce((sum: number, item) => sum + item.amount, 0)\n\n            const invStmt = db.prepare(`INSERT INTO fee_invoice (\n                invoice_number, student_id, term_id, academic_term_id, invoice_date, due_date,\n                total_amount, amount, amount_due, original_amount, created_by_user_id\n            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`)\n\n            const invResult = invStmt.run(\n                invNum,\n                data.student_id,\n                data.term_id,\n                data.term_id,\n                data.invoice_date,\n                data.due_date,\n                totalCents,\n                totalCents,\n                totalCents,\n                totalCents,\n                userId\n            )\n\n            logAudit(userId, 'CREATE', 'fee_invoice', invResult.lastInsertRowid as number, null, { ...data, total: totalCents, items: itemsInCents })\n\n            const itemStmt = db.prepare('INSERT INTO invoice_item (invoice_id, fee_category_id, description, amount) VALUES (?, ?, ?, ?)')\n            for (const item of itemsInCents) {\n                itemStmt.run(invResult.lastInsertRowid, item.fee_category_id, item.description, item.amount)\n            }\n\n            return { success: true, invoiceNumber: invNum, id: invResult.lastInsertRowid }\n        })()\n    })\n\n    ipcMain.handle('invoice:getByStudent', async (_event: IpcMainInvokeEvent, studentId: number) => {\n        const invoices = db.prepare('SELECT * FROM fee_invoice WHERE student_id = ? ORDER BY invoice_date DESC').all(studentId) as FeeInvoiceDB[]\n        return invoices\n    })\n\n    ipcMain.handle('invoice:getAll', async (_event: IpcMainInvokeEvent) => {\n        const invoices = db.prepare(`\n            SELECT fi.*, \n                   s.first_name || ' ' || s.last_name as student_name,\n                   t.term_name\n            FROM fee_invoice fi\n            JOIN student s ON fi.student_id = s.id\n            JOIN term t ON fi.term_id = t.id\n            ORDER BY fi.invoice_date DESC\n        `).all() as FeeInvoiceWithDetails[]\n\n        return invoices.map(inv => ({\n            ...inv,\n            total_amount: inv.total_amount,\n            amount_paid: inv.amount_paid,\n            balance: (inv.total_amount - inv.amount_paid)\n        }))\n    })\n\n    // ======== FEE STRUCTURE & BATCH INVOICING ========\n\n    ipcMain.handle('fee:getCategories', async (_event: IpcMainInvokeEvent) => {\n        return db.prepare('SELECT * FROM fee_category WHERE is_active = 1').all()\n    })\n\n    ipcMain.handle('fee:createCategory', async (_event: IpcMainInvokeEvent, name: string, description: string) => {\n        const stmt = db.prepare('INSERT INTO fee_category (category_name, description) VALUES (?, ?)')\n        const result = stmt.run(name, description)\n        return { success: true, id: result.lastInsertRowid }\n    })\n\n    ipcMain.handle('fee:getStructure', async (_event: IpcMainInvokeEvent, academicYearId: number, termId: number) => {\n        const structure = db.prepare(`\n            SELECT fs.*, fc.category_name, s.stream_name \n            FROM fee_structure fs\n            JOIN fee_category fc ON fs.fee_category_id = fc.id\n            JOIN stream s ON fs.stream_id = s.id\n            WHERE fs.academic_year_id = ? AND fs.term_id = ?\n        `).all(academicYearId, termId) as FeeStructureWithDetails[]\n\n        return structure\n    })\n\n    ipcMain.handle('fee:saveStructure', async (_event: IpcMainInvokeEvent, data: FeeStructureItemData[], academicYearId: number, termId: number) => {\n        const deleteStmt = db.prepare('DELETE FROM fee_structure WHERE academic_year_id = ? AND term_id = ?')\n        const insertStmt = db.prepare(`\n            INSERT INTO fee_structure (academic_year_id, term_id, stream_id, student_type, fee_category_id, amount)\n            VALUES (?, ?, ?, ?, ?, ?)\n        `)\n\n        const transaction = db.transaction((items: FeeStructureItemData[]) => {\n            deleteStmt.run(academicYearId, termId)\n            for (const item of items) {\n                insertStmt.run(academicYearId, termId, item.stream_id, item.student_type, item.fee_category_id, item.amount)\n            }\n        })\n\n        transaction(data)\n        return { success: true }\n    })\n\n    ipcMain.handle('invoice:generateBatch', async (_event: IpcMainInvokeEvent, academicYearId: number, termId: number, userId: number) => {\n        // 1. Get Fee Structure\n        const structure = db.prepare(`\n            SELECT * FROM fee_structure \n            WHERE academic_year_id = ? AND term_id = ?\n        `).all(academicYearId, termId) as Array<{ id: number; academic_year_id: number; term_id: number; stream_id: number; student_type: string; fee_category_id: number; amount: number; fee_items: string; total_amount: number; created_at: string }>\n\n        if (structure.length === 0) {return { success: false, message: 'No fee structure defined for this term' }}\n\n        // 2. Get Active Students with Enrollment\n        // Ideally, we check enrollment for the specific term, but if not exists, fallback to active students\n        // For simplicity, let's assume all active students are enrolled in their current stream\n        // In a real app, we should promote students to new streams/terms first.\n        // Let's use the 'student' table and assume their current stream is valid.\n        // Wait, 'student' table doesn't have stream_id directly? \n        // Let's check schema... 'enrollment' table links student to stream/term.\n\n        // Let's look for enrollments in this academic year/term\n        const enrollments = db.prepare(`\n            SELECT e.*, s.first_name, s.last_name \n            FROM enrollment e\n            JOIN student s ON e.student_id = s.id\n            WHERE e.academic_year_id = ? AND e.term_id = ? AND e.status = 'ACTIVE'\n        `).all(academicYearId, termId) as Array<{ id: number; student_id: number; academic_year_id: number; term_id: number; stream_id: number; student_type: string; class_id: number; status: string; first_name: string; last_name: string }>\n\n        if (enrollments.length === 0) {\n            // Fallback: If no specific enrollment for this term, try to find active students and enroll them?\n            // Or just fail and tell user to enroll students first.\n            // Better: Auto-enroll based on previous term? Too complex.\n            // Let's assume the user has promoted students or enrolled them.\n            // If 0 enrollments, maybe they haven't set up the term enrollments yet.\n            return { success: false, message: 'No active enrollments found for this term. Please enroll students first.' }\n        }\n\n        let count = 0\n        // const errors = []\n\n        const checkInvoiceStmt = db.prepare('SELECT id FROM fee_invoice WHERE student_id = ? AND term_id = ?')\n        const insertInvoiceStmt = db.prepare(`\n            INSERT INTO fee_invoice (\n              invoice_number, student_id, term_id, academic_term_id,\n              invoice_date, due_date, total_amount, amount, amount_due, original_amount, created_by_user_id\n            )\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n        `)\n        // Updated to include exemption fields\n        const insertItemStmt = db.prepare(`\n            INSERT INTO invoice_item (invoice_id, fee_category_id, description, amount, exemption_id, original_amount, exemption_amount) \n            VALUES (?, ?, ?, ?, ?, ?, ?)\n        `)\n\n        const transaction = db.transaction(() => {\n            for (const enrollment of enrollments) {\n                // Skip if invoice exists\n                const existing = checkInvoiceStmt.get(enrollment.student_id, enrollment.term_id)\n                if (existing) {continue}\n\n                // Find applicable fees\n                const fees = structure.filter(f =>\n                    f.stream_id === enrollment.stream_id &&\n                    f.student_type === enrollment.student_type\n                )\n\n                if (fees.length === 0) {continue}\n\n                // Fetch student exemptions for this term\n                const exemptions = exemptionService.getStudentExemptions(enrollment.student_id, academicYearId, termId)\n\n                let invoiceTotal = 0\n                let originalTotal = 0\n                const invoiceItems: InvoiceItemCreation[] = []\n\n                for (const fee of fees) {\n                    const originalAmount = fee.amount\n                    let finalAmount = originalAmount\n                    let exemptionAmount = 0\n                    let exemptionId: number | null = null\n\n                    // Check for invalid exemption (blanket or specific category)\n                    // Prioritize specific category exemption over blanket\n                    const specificExemption = exemptions.find(e => e.fee_category_id === fee.fee_category_id && e.status === 'ACTIVE')\n                    const blanketExemption = exemptions.find(e => !e.fee_category_id && e.status === 'ACTIVE')\n                    const activeExemption = specificExemption || blanketExemption\n\n                    if (activeExemption) {\n                        const percentage = activeExemption.exemption_percentage\n                        exemptionAmount = Math.round((originalAmount * percentage) / 100)\n                        finalAmount = originalAmount - exemptionAmount\n                        exemptionId = activeExemption.id\n                    }\n\n                    invoiceTotal += finalAmount\n                    originalTotal += originalAmount\n                    invoiceItems.push({\n                        fee_category_id: fee.fee_category_id,\n                        description: 'Term Fee', // Could be more specific based on category name\n                        amount: finalAmount,\n                        exemption_id: exemptionId,\n                        original_amount: originalAmount,\n                        exemption_amount: exemptionAmount\n                    })\n                }\n\n                const invNum = `INV-${academicYearId}-${termId}-${enrollment.student_id}-${Date.now().toString().slice(-4)}`\n                const dueDate = new Date().toISOString().slice(0, 10) // Today for now, or term start date\n\n                const invResult = insertInvoiceStmt.run(\n                    invNum,\n                    enrollment.student_id,\n                    enrollment.term_id,\n                    enrollment.term_id,\n                    new Date().toISOString().slice(0, 10),\n                    dueDate,\n                    invoiceTotal,\n                    invoiceTotal,\n                    invoiceTotal,\n                    originalTotal,\n                    userId\n                )\n                const invoiceId = invResult.lastInsertRowid\n\n                for (const item of invoiceItems) {\n                    insertItemStmt.run(\n                        invoiceId, item.fee_category_id, item.description,\n                        item.amount, item.exemption_id, item.original_amount, item.exemption_amount\n                    )\n                }\n                count++\n            }\n        })\n\n        try {\n            transaction()\n            return { success: true, count }\n        } catch (e: unknown) {\n            console.error(e)\n            const errorMessage = e instanceof Error ? e.message : 'Unknown error occurred'\n            return { success: false, message: errorMessage }\n        }\n    })\n    // ======== PHASE 3: CREDIT AUTO-APPLICATION ========\n    const creditService = new CreditAutoApplicationService()\n\n    ipcMain.handle('finance:allocateCredits', async (_event: IpcMainInvokeEvent, studentId: number, userId: number) => {\n        try {\n            return await creditService.allocateCreditsToInvoices(studentId, userId)\n        } catch (error) {\n            return { success: false, message: error instanceof Error ? error.message : 'Unknown error' }\n        }\n    })\n\n    ipcMain.handle('finance:getCreditBalance', async (_event: IpcMainInvokeEvent, studentId: number) => {\n        try {\n            return await creditService.getStudentCreditBalance(studentId)\n        } catch (error) {\n            throw new Error(error instanceof Error ? error.message : 'Failed to get credit balance')\n        }\n    })\n\n    ipcMain.handle('finance:getCreditTransactions', async (_event: IpcMainInvokeEvent, studentId: number, limit?: number) => {\n        try {\n            return await creditService.getCreditTransactions(studentId, limit)\n        } catch (error) {\n            throw new Error(error instanceof Error ? error.message : 'Failed to get credit transactions')\n        }\n    })\n\n    ipcMain.handle('finance:addCredit', async (_event: IpcMainInvokeEvent, studentId: number, amount: number, notes: string, userId: number) => {\n        try {\n            return await creditService.addCreditToStudent(studentId, amount, notes, userId)\n        } catch (error) {\n            return { success: false, message: error instanceof Error ? error.message : 'Unknown error' }\n        }\n    })\n\n    // ======== PHASE 3: FEE PRORATION ========\n    const prorationService = new FeeProrationService()\n\n    ipcMain.handle('finance:calculateProRatedFee', async (\n        _event: IpcMainInvokeEvent,\n        fullAmount: number,\n        termStartDate: string,\n        termEndDate: string,\n        enrollmentDate: string\n    ) => {\n        try {\n            return prorationService.calculateProRatedFee(fullAmount, termStartDate, termEndDate, enrollmentDate)\n        } catch (error) {\n            throw new Error(error instanceof Error ? error.message : 'Failed to calculate pro-rated fee')\n        }\n    })\n\n    ipcMain.handle('finance:validateEnrollmentDate', async (\n        _event: IpcMainInvokeEvent,\n        termStartDate: string,\n        termEndDate: string,\n        enrollmentDate: string\n    ) => {\n        try {\n            return prorationService.validateEnrollmentDate(termStartDate, termEndDate, enrollmentDate)\n        } catch (error) {\n            throw new Error(error instanceof Error ? error.message : 'Failed to validate enrollment date')\n        }\n    })\n\n    ipcMain.handle('finance:generateProRatedInvoice', async (\n        _event: IpcMainInvokeEvent,\n        studentId: number,\n        templateInvoiceId: number,\n        enrollmentDate: string,\n        userId: number\n    ) => {\n        try {\n            return await prorationService.generateProRatedInvoice(studentId, templateInvoiceId, enrollmentDate, userId)\n        } catch (error) {\n            return { success: false, message: error instanceof Error ? error.message : 'Unknown error' }\n        }\n    })\n\n    ipcMain.handle('finance:getProRationHistory', async (_event: IpcMainInvokeEvent, studentId: number) => {\n        try {\n            return await prorationService.getStudentProRationHistory(studentId)\n        } catch (error) {\n            throw new Error(error instanceof Error ? error.message : 'Failed to get proration history')\n        }\n    })\n\n    // ======== PHASE 3: SCHOLARSHIPS ========\n    const scholarshipService = new ScholarshipService()\n\n    ipcMain.handle('finance:createScholarship', async (_event: IpcMainInvokeEvent, data: ScholarshipData, userId: number) => {\n        try {\n            return await scholarshipService.createScholarship(data, userId)\n        } catch (error) {\n            return { success: false, message: error instanceof Error ? error.message : 'Unknown error' }\n        }\n    })\n\n    ipcMain.handle('finance:allocateScholarship', async (_event: IpcMainInvokeEvent, allocationData: AllocationData, userId: number) => {\n        try {\n            return await scholarshipService.allocateScholarshipToStudent(allocationData, userId)\n        } catch (error) {\n            return { success: false, message: error instanceof Error ? error.message : 'Unknown error' }\n        }\n    })\n\n    ipcMain.handle('finance:validateScholarshipEligibility', async (_event: IpcMainInvokeEvent, studentId: number, scholarshipId: number) => {\n        try {\n            return await scholarshipService.validateScholarshipEligibility(studentId, scholarshipId)\n        } catch (error) {\n            throw new Error(error instanceof Error ? error.message : 'Failed to validate eligibility')\n        }\n    })\n\n    ipcMain.handle('finance:getActiveScholarships', async (_event: IpcMainInvokeEvent) => {\n        try {\n            return await scholarshipService.getActiveScholarships()\n        } catch (error) {\n            throw new Error(error instanceof Error ? error.message : 'Failed to get scholarships')\n        }\n    })\n\n    ipcMain.handle('finance:getStudentScholarships', async (_event: IpcMainInvokeEvent, studentId: number) => {\n        try {\n            return await scholarshipService.getStudentScholarships(studentId)\n        } catch (error) {\n            throw new Error(error instanceof Error ? error.message : 'Failed to get student scholarships')\n        }\n    })\n\n    ipcMain.handle('finance:getScholarshipAllocations', async (_event: IpcMainInvokeEvent, scholarshipId: number) => {\n        try {\n            return await scholarshipService.getScholarshipAllocations(scholarshipId)\n        } catch (error) {\n            throw new Error(error instanceof Error ? error.message : 'Failed to get allocations')\n        }\n    })\n\n    ipcMain.handle('finance:applyScholarshipToInvoice', async (\n        _event: IpcMainInvokeEvent,\n        studentScholarshipId: number,\n        invoiceId: number,\n        amountToApply: number,\n        userId: number\n    ) => {\n        try {\n            return await scholarshipService.applyScholarshipToInvoice(studentScholarshipId, invoiceId, amountToApply, userId)\n        } catch (error) {\n            return { success: false, message: error instanceof Error ? error.message : 'Unknown error' }\n        }\n    })\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\finance\\fixed-asset-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\finance\\gl-account-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\finance\\opening-balance-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\finance\\reconciliation-budget-handlers.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'registerReconciliationAndBudgetHandlers' has too many lines (86). Maximum allowed is 80.","line":16,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":141,"endColumn":2},{"ruleId":"max-params","severity":1,"message":"Async arrow function has too many parameters (6). Maximum allowed is 5.","line":66,"column":7,"nodeType":"ArrowFunctionExpression","messageId":"exceed","endLine":66,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ipcMain } from '../../electron-env';\r\nimport { BudgetEnforcementService } from '../../services/accounting/BudgetEnforcementService';\r\nimport { ReconciliationService } from '../../services/accounting/ReconciliationService';\n\r\nimport type { IpcMainInvokeEvent } from 'electron';\n\r\n/**\r\n * Reconciliation and Budget IPC Handlers\r\n * \r\n * Provides frontend access to:\r\n * - Reconciliation checks and reports\r\n * - Budget enforcement and validation\r\n * - Budget variance reports\r\n */\r\n\r\nexport function registerReconciliationAndBudgetHandlers(): void {\r\n  const reconciliationService = new ReconciliationService();\r\n  const budgetService = new BudgetEnforcementService();\r\n\r\n  // ======== RECONCILIATION ========\r\n\r\n  /**\r\n   * Run all reconciliation checks\r\n   */\r\n  ipcMain.handle(\r\n    'reconciliation:runAll',\r\n    async (_event: IpcMainInvokeEvent, userId: number) => {\r\n      return await reconciliationService.runAllChecks(userId);\r\n    }\r\n  );\r\n\r\n  /**\r\n   * Get reconciliation history\r\n   */\r\n  ipcMain.handle(\r\n    'reconciliation:getHistory',\r\n    async (_event: IpcMainInvokeEvent, limit: number = 30) => {\r\n      return await reconciliationService.getReconciliationHistory(limit);\r\n    }\r\n  );\r\n\r\n  /**\r\n   * Get latest reconciliation summary\r\n   */\r\n  ipcMain.handle(\r\n    'reconciliation:getLatest',\r\n    async () => {\r\n      return await reconciliationService.getLatestReconciliationSummary();\r\n    }\r\n  );\r\n\r\n  // ======== BUDGET ENFORCEMENT ========\r\n\r\n  /**\r\n   * Set budget allocation for GL account\r\n   */\r\n  ipcMain.handle(\r\n    'budget:setAllocation',\r\n    async (\r\n      _event: IpcMainInvokeEvent,\r\n      glAccountCode: string,\r\n      fiscalYear: number,\r\n      allocatedAmount: number,\r\n      department: string | null,\r\n      userId: number\r\n    ) => {\r\n      return await budgetService.setBudgetAllocation(\r\n        glAccountCode,\r\n        fiscalYear,\r\n        allocatedAmount,\r\n        department,\r\n        userId\r\n      );\r\n    }\r\n  );\r\n\r\n  /**\r\n   * Validate transaction against budget\r\n   */\r\n  ipcMain.handle(\r\n    'budget:validateTransaction',\r\n    async (\r\n      _event: IpcMainInvokeEvent,\r\n      glAccountCode: string,\r\n      amount: number,\r\n      fiscalYear: number,\r\n      department: string | null = null\r\n    ) => {\r\n      return await budgetService.validateTransaction(\r\n        glAccountCode,\r\n        amount,\r\n        fiscalYear,\r\n        department\r\n      );\r\n    }\r\n  );\r\n\r\n  /**\r\n   * Get all budget allocations for a fiscal year\r\n   */\r\n  ipcMain.handle(\r\n    'budget:getAllocations',\r\n    async (_event: IpcMainInvokeEvent, fiscalYear: number) => {\r\n      return await budgetService.getBudgetAllocations(fiscalYear);\r\n    }\r\n  );\r\n\r\n  /**\r\n   * Generate budget variance report\r\n   */\r\n  ipcMain.handle(\r\n    'budget:getVarianceReport',\r\n    async (_event: IpcMainInvokeEvent, fiscalYear: number) => {\r\n      return await budgetService.generateBudgetVarianceReport(fiscalYear);\r\n    }\r\n  );\r\n\r\n  /**\r\n   * Get budget alerts\r\n   */\r\n  ipcMain.handle(\r\n    'budget:getAlerts',\r\n    async (\r\n      _event: IpcMainInvokeEvent,\r\n      fiscalYear: number,\r\n      thresholdPercentage: number = 80\r\n    ) => {\r\n      return await budgetService.getBudgetAlerts(fiscalYear, thresholdPercentage);\r\n    }\r\n  );\r\n\r\n  /**\r\n   * Deactivate budget allocation\r\n   */\r\n  ipcMain.handle(\r\n    'budget:deactivateAllocation',\r\n    async (_event: IpcMainInvokeEvent, allocationId: number, userId: number) => {\r\n      return await budgetService.deactivateBudgetAllocation(allocationId, userId);\r\n    }\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\finance\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\hire\\hire-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\index.ts","messages":[{"ruleId":"max-statements","severity":1,"message":"Function 'registerAllIpcHandlers' has too many statements (40). Maximum allowed is 30.","line":43,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":85,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { registerAcademicHandlers } from './academic/academic-handlers'\r\nimport { registerAcademicSystemHandlers } from './academic/academic-system-handlers'\r\nimport { registerAttendanceHandlers } from './academic/attendance-handlers'\r\nimport { registerAwardsHandlers } from './academic/awards-handlers'\r\n// Previously unregistered handler modules (audit fix)\r\nimport { registerCBCHandlers } from './academic/cbc-handlers'\r\nimport { registerExamAnalysisHandlers } from './academic/exam-analysis-handlers'\r\nimport { registerJSSHandlers } from './academic/jss-handlers'\r\nimport { registerMeritListHandlers } from './academic/merit-list-handlers'\r\nimport { registerPerformanceAnalysisHandlers } from './academic/performance-analysis-handlers'\r\nimport { registerPromotionHandlers } from './academic/promotion-handlers'\r\nimport { registerReportCardAnalyticsHandlers } from './academic/report-card-analytics-handlers'\r\nimport { registerReportCardHandlers } from './academic/reportcard-handlers'\r\nimport { registerAuditHandlers } from './audit/audit-handlers'\r\nimport { registerAuthHandlers } from './auth/auth-handlers'\r\nimport { registerBackupHandlers } from './backup/backup-handlers'\r\nimport { registerDataImportHandlers } from './data/import-handlers'\r\nimport { registerExemptionHandlers } from './exemption/exemption-handlers'\r\nimport { registerFinanceApprovalHandlers } from './finance/approval-handlers'\r\nimport { registerBankReconciliationHandlers } from './finance/bank-handlers'\r\nimport { registerBudgetHandlers } from './finance/budget-handlers'\r\nimport { registerFinanceHandlers } from './finance/finance-handlers'\r\nimport { registerFixedAssetHandlers } from './finance/fixed-asset-handlers'\r\nimport { registerGLAccountHandlers } from './finance/gl-account-handlers'\r\nimport { registerOpeningBalanceHandlers } from './finance/opening-balance-handlers'\r\nimport { registerReconciliationAndBudgetHandlers } from './finance/reconciliation-budget-handlers'\r\nimport { registerHireHandlers } from './hire/hire-handlers'\r\nimport { registerInventoryHandlers } from './inventory/inventory-handlers'\r\nimport { registerMessageHandlers } from './messaging/message-handlers'\r\nimport { registerNotificationHandlers } from './notifications/notification-handlers'\r\nimport { registerCbcOperationsHandlers } from './operations/cbc-operations-handlers'\r\nimport { registerOperationsHandlers } from './operations/operations-handlers'\r\nimport { registerPayrollHandlers } from './payroll/payroll-handlers'\r\nimport { registerFinancialReportsHandlers } from './reports/financial-reports-handlers'\r\nimport { registerReportsHandlers } from './reports/reports-handlers'\r\nimport { registerReportSchedulerHandlers } from './reports/scheduler-handlers'\r\nimport { registerSettingsHandlers } from './settings/settings-handlers'\r\nimport { registerStaffHandlers } from './staff/staff-handlers'\r\nimport { registerStudentHandlers } from './student/student-handlers'\r\nimport { registerTransactionsHandlers } from './transactions/transactions-handlers'\r\nimport { registerApprovalHandlers } from './workflow/approval-handlers'\r\n\r\nexport function registerAllIpcHandlers(): void {\r\n    registerAuthHandlers()\r\n    registerAcademicHandlers()\r\n    registerStudentHandlers()\r\n    registerFinanceHandlers()\r\n    registerStaffHandlers()\r\n    registerInventoryHandlers()\r\n    registerReportsHandlers()\r\n    registerSettingsHandlers()\r\n    registerTransactionsHandlers()\r\n    registerPayrollHandlers()\r\n    registerAuditHandlers()\r\n    registerBackupHandlers()\r\n    registerMessageHandlers()\r\n    registerBudgetHandlers()\r\n    registerBankReconciliationHandlers()\r\n    registerApprovalHandlers()\r\n    registerPromotionHandlers()\r\n    registerAttendanceHandlers()\r\n    registerAcademicSystemHandlers()\r\n    registerReportCardHandlers()\r\n    registerNotificationHandlers()\r\n    registerReportSchedulerHandlers()\r\n    registerDataImportHandlers()\r\n    registerFixedAssetHandlers()\r\n    registerHireHandlers()\r\n    registerExemptionHandlers()\r\n    registerMeritListHandlers()\r\n    registerAwardsHandlers()\r\n    // Previously unregistered handlers (audit fix)\r\n    registerGLAccountHandlers()\r\n    registerOpeningBalanceHandlers()\r\n    registerReconciliationAndBudgetHandlers()\r\n    registerExamAnalysisHandlers()\r\n    registerPerformanceAnalysisHandlers()\r\n    registerReportCardAnalyticsHandlers()\r\n    registerCBCHandlers()\r\n    registerJSSHandlers()\r\n    registerOperationsHandlers()\r\n    registerCbcOperationsHandlers()\r\n    registerFinanceApprovalHandlers()\r\n    registerFinancialReportsHandlers()\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\inventory\\inventory-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\inventory\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\messaging\\message-handlers.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always truthy.","line":85,"column":29,"nodeType":"TSAsExpression","messageId":"alwaysTruthy","endLine":85,"endColumn":86}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[397,400],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[397,400],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[525,528],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[525,528],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[871,874],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[871,874],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database';\nimport { logAudit as _logAudit } from '../../database/utils/audit';\nimport { ipcMain } from '../../electron-env';\nimport { NotificationService } from '../../services/notifications/NotificationService';\n\nexport function registerMessageHandlers(): void {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const db = new Proxy({} as any, {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        get: (_target, prop) => (getDatabase() as any)[prop]\n    });\n\n    // ======== MESSAGE TEMPLATES ========\n    ipcMain.handle('message:getTemplates', async () => {\n        return db.prepare('SELECT * FROM message_template WHERE is_active = 1').all();\n    });\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    ipcMain.handle('message:saveTemplate', async (_, template: any) => {\n        if (template.id) {\n            db.prepare(`UPDATE message_template SET \n        template_name = ?, template_type = ?, subject = ?, body = ?, placeholders = ? \n        WHERE id = ?`\n            ).run(\n                template.template_name, template.template_type, template.subject,\n                template.body, template.placeholders, template.id\n            );\n            return { success: true, id: template.id };\n        } else {\n            const result = db.prepare(`INSERT INTO message_template \n        (template_name, template_type, subject, body, placeholders) \n        VALUES (?, ?, ?, ?, ?)`\n            ).run(\n                template.template_name, template.template_type, template.subject,\n                template.body, template.placeholders\n            );\n            return { success: true, id: result.lastInsertRowid };\n        }\n    });\n\n    // ======== SENDING SMS ========\n    ipcMain.handle('message:sendSms', async (event, options: { to: string, message: string, recipientId?: number, recipientType?: string, userId: number }) => {\n        const settings = db.prepare('SELECT sms_api_key, sms_api_secret, sms_sender_id FROM school_settings WHERE id = 1').get() as { sms_api_key: string; sms_api_secret: string; sms_sender_id: string } | undefined;\n\n        // Create log entry as PENDING\n        const logStmt = db.prepare(`INSERT INTO message_log \n      (recipient_type, recipient_id, recipient_contact, message_type, message_body, status, sent_by_user_id) \n      VALUES (?, ?, ?, 'SMS', ?, 'PENDING', ?)`);\n\n        const result = logStmt.run(\n            options.recipientType || 'OTHER',\n            options.recipientId || null,\n            options.to,\n            options.message,\n            options.userId\n        );\n        const logId = result.lastInsertRowid;\n\n        try {\n            // IMPLEMENTATION NOTE: Africa's Talking / Twilio integration would go here\n            // For now, we simulate success if credentials exist, or return failure for missing config\n            if (!settings?.sms_api_key) {\n                throw new Error('SMS API Key not configured in settings');\n            }\n\n            // Simulation of async API call\n            // In production: const response = await africastalking.send(...)\n\n            db.prepare('UPDATE message_log SET status = ?, external_id = ? WHERE id = ?')\n                .run('SENT', `SIM-${Date.now()}`, logId);\n\n            return { success: true, messageId: `SIM-${Date.now()}` };\n        } catch (error: unknown) {\n            const errorMessage = error instanceof Error ? error.message : String(error);\n            db.prepare(\"UPDATE message_log SET status = 'FAILED', error_message = ? WHERE id = ?\")\n                .run(errorMessage, logId);\n            return { success: false, error: errorMessage };\n        }\n    });\n\n    // ======== SENDING EMAIL ========\n    ipcMain.handle('message:sendEmail', async (_event, options: { to: string; subject: string; body: string; recipientId?: number; recipientType?: string; userId: number }) => {\n        const service = new NotificationService();\n        const result = await service.send({\n            recipientType: (options.recipientType as 'STUDENT' | 'STAFF' | 'GUARDIAN') || 'GUARDIAN',\n            recipientId: options.recipientId || 0,\n            channel: 'EMAIL',\n            to: options.to,\n            subject: options.subject,\n            message: options.body\n        }, options.userId);\n        return result;\n    });\n\n    // ======== MESSAGE LOGS ========\n    ipcMain.handle('message:getLogs', async (_, limit = 50) => {\n        return db.prepare('SELECT * FROM message_log ORDER BY created_at DESC LIMIT ?').all(limit);\n    });\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\notifications\\notification-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\operations\\cbc-operations-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\operations\\operations-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\payroll\\payroll-handlers.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'registerPayrollHandlers' has too many lines (102). Maximum allowed is 80.","line":26,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":172,"endColumn":2},{"ruleId":"max-statements","severity":1,"message":"Arrow function has too many statements (52). Maximum allowed is 30.","line":31,"column":31,"nodeType":"ArrowFunctionExpression","messageId":"exceed","endLine":133,"endColumn":10},{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 19. Maximum allowed is 12.","line":31,"column":34,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":31,"endColumn":36},{"ruleId":"sonarjs/no-nested-functions","severity":1,"message":"Refactor this code to not nest functions more than 4 levels deep.","line":38,"column":60,"nodeType":null,"endLine":38,"endColumn":62}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\r\nimport { logAudit } from '../../database/utils/audit'\r\nimport { ipcMain } from '../../electron-env'\n\r\nimport type { StaffMember } from './types'\r\nimport type { IpcMainInvokeEvent } from 'electron'\n\r\ninterface StaffAllowanceRow {\r\n    id: number\r\n    staff_id: number\r\n    allowance_name: string\r\n    amount: number\r\n    is_active: number\r\n}\r\n\r\ninterface StatutoryRate {\r\n    id: number\r\n    rate_type: string\r\n    min_amount: number\r\n    max_amount?: number\r\n    rate: number\r\n    fixed_amount: number\r\n    is_current: number\r\n}\r\n\r\nexport function registerPayrollHandlers(): void {\r\n    const db = getDatabase()\r\n\r\n    // ======== PAYROLL ========\r\n    ipcMain.handle('payroll:run', async (_event: IpcMainInvokeEvent, month: number, year: number, userId: number) => {\r\n        return db.transaction(() => {\r\n            // 1. Check if payroll already exists\r\n            const existing = db.prepare('SELECT id FROM payroll_period WHERE month = ? AND year = ?').get(month, year) as { id: number } | undefined\r\n            if (existing) {return { success: false, error: 'Payroll for this period already exists' }}\r\n\r\n            // 2. Fetch Active Statutory Rates\r\n            const rates = db.prepare('SELECT * FROM statutory_rates WHERE is_current = 1').all() as StatutoryRate[]\r\n            const getRate = (type: string) => rates.find(r => r.rate_type === type)\r\n            const payeBands = rates.filter(r => r.rate_type === 'PAYE_BAND').sort((a, b) => a.min_amount - b.min_amount)\r\n\r\n            // 3. Create Payroll Period\r\n            const periodName = `${new Date(year, month - 1).toLocaleString('default', { month: 'long' })} ${year}`\r\n            const startDate = `${year}-${String(month).padStart(2, '0')}-01`\r\n            const endDate = new Date(year, month, 0).toISOString().split('T')[0]\r\n\r\n            const periodResult = db.prepare(`INSERT INTO payroll_period (\r\n                period_name, month, year, start_date, end_date, status, created_at\r\n            ) VALUES (?, ?, ?, ?, ?, 'DRAFT', CURRENT_TIMESTAMP)`).run(periodName, month, year, startDate, endDate)\r\n\r\n            const periodId = periodResult.lastInsertRowid\r\n\r\n            logAudit(userId, 'CREATE', 'payroll_period', periodId as number, null, { month, year, periodName })\r\n\r\n            // 4. Get Active Staff\r\n            const staffList = db.prepare('SELECT * FROM staff WHERE is_active = 1').all() as StaffMember[]\r\n\r\n            const payrollStmt = db.prepare(`INSERT INTO payroll (\r\n                period_id, staff_id, basic_salary, gross_salary, total_deductions, net_salary\r\n            ) VALUES (?, ?, ?, ?, ?, ?)`)\r\n\r\n            const deductionStmt = db.prepare('INSERT INTO payroll_deduction (payroll_id, deduction_name, amount) VALUES (?, ?, ?)')\r\n            const allowanceStmt = db.prepare('INSERT INTO payroll_allowance (payroll_id, allowance_name, amount) VALUES (?, ?, ?)')\r\n\r\n            const results = []\r\n\r\n            for (const staff of staffList) {\r\n                const basic = staff.basic_salary || 0\r\n                const staffAllowances = db.prepare('SELECT * FROM staff_allowance WHERE staff_id = ? AND is_active = 1').all(staff.id) as StaffAllowanceRow[]\r\n                const totalAllowances = staffAllowances.reduce((sum, a) => sum + a.amount, 0)\r\n                const gross = basic + totalAllowances\r\n\r\n                // --- ROBUST STATUTORY CALCULATIONS ---\r\n\r\n                // 1. NSSF (Tier I + II)\r\n                const nssfTier1 = getRate('NSSF_TIER_I')?.fixed_amount || 720\r\n                const nssfTier2 = getRate('NSSF_TIER_II')?.fixed_amount || 1440\r\n                const nssf = nssfTier1 + (gross > 7000 ? nssfTier2 : 0)\r\n\r\n                // 2. Housing Levy (1.5%)\r\n                const housingLevyRate = getRate('HOUSING_LEVY')?.rate || 0.015\r\n                const housingLevy = gross * housingLevyRate\r\n\r\n                // 3. SHIF (2.75%)\r\n                const shifRate = getRate('SHIF')?.rate || 0.0275\r\n                const shif = gross * shifRate\r\n\r\n                // 4. PAYE Calculation\r\n                const taxablePay = gross - nssf\r\n                let paye = 0\r\n                let remainingTaxable = taxablePay\r\n\r\n                for (const band of payeBands) {\r\n                    const bandRange = (band.max_amount || 99999999) - band.min_amount\r\n                    const amountInBand = Math.min(remainingTaxable, bandRange)\r\n                    if (amountInBand > 0) {\r\n                        paye += amountInBand * band.rate\r\n                        remainingTaxable -= amountInBand\r\n                    }\r\n                }\r\n\r\n                // Apply Personal Relief\r\n                const personalRelief = getRate('PERSONAL_RELIEF')?.fixed_amount || 2400\r\n                paye = Math.max(0, paye - personalRelief)\r\n\r\n                const totalDeductions = Math.round(nssf + housingLevy + shif + paye)\r\n                const net = gross - totalDeductions\r\n\r\n                // Save Payroll\r\n                const payrollResult = payrollStmt.run(periodId, staff.id, basic, gross, totalDeductions, net)\r\n                const payrollId = payrollResult.lastInsertRowid\r\n\r\n                // Save Deductions Breakdown\r\n                deductionStmt.run(payrollId, 'NSSF', nssf)\r\n                deductionStmt.run(payrollId, 'Housing Levy', housingLevy)\r\n                deductionStmt.run(payrollId, 'SHIF', shif)\r\n                deductionStmt.run(payrollId, 'PAYE', paye)\r\n\r\n                for (const allowance of staffAllowances) {\r\n                    allowanceStmt.run(payrollId, allowance.allowance_name, allowance.amount)\r\n                }\r\n\r\n                results.push({\r\n                    staff_name: `${staff.first_name} ${staff.last_name}`.trim(),\r\n                    staff_number: staff.staff_number,\r\n                    gross_salary: gross,\r\n                    nssf, housing_levy: housingLevy, shif, paye,\r\n                    total_deductions: totalDeductions,\r\n                    net_salary: net\r\n                })\r\n            }\r\n\r\n            return { success: true, periodId, results }\r\n        })()\r\n    })\r\n\r\n    ipcMain.handle('payroll:getHistory', async () => {\r\n        return db.prepare('SELECT * FROM payroll_period ORDER BY year DESC, month DESC').all()\r\n    })\r\n\r\n    ipcMain.handle('payroll:getDetails', async (_event: IpcMainInvokeEvent, periodId: number) => {\r\n        const period = db.prepare('SELECT * FROM payroll_period WHERE id = ?').get(periodId)\r\n        if (!period) {return { success: false, error: 'Period not found' }}\r\n\r\n        const results = db.prepare(`\r\n            SELECT p.*, \r\n                   (s.first_name || ' ' || COALESCE(s.middle_name || ' ', '') || s.last_name) as staff_name, \r\n                   s.staff_number, s.department, s.job_title, s.phone\r\n            FROM payroll p\r\n            JOIN staff s ON p.staff_id = s.id\r\n            WHERE p.period_id = ?\r\n        `).all(periodId)\r\n\r\n        return { success: true, period, results }\r\n    })\r\n\r\n    // ======== STAFF ALLOWANCES ========\r\n    ipcMain.handle('staff:getAllowances', async (_event: IpcMainInvokeEvent, staffId: number) => {\r\n        return db.prepare('SELECT * FROM staff_allowance WHERE staff_id = ? AND is_active = 1 ORDER BY allowance_name').all(staffId)\r\n    })\r\n\r\n    ipcMain.handle('staff:addAllowance', async (_event: IpcMainInvokeEvent, staffId: number, allowanceName: string, amount: number) => {\r\n        const result = db.prepare(\r\n            'INSERT INTO staff_allowance (staff_id, allowance_name, amount) VALUES (?, ?, ?)'\r\n        ).run(staffId, allowanceName, amount)\r\n        return { success: true, id: result.lastInsertRowid }\r\n    })\r\n\r\n    ipcMain.handle('staff:deleteAllowance', async (_event: IpcMainInvokeEvent, allowanceId: number) => {\r\n        db.prepare('UPDATE staff_allowance SET is_active = 0 WHERE id = ?').run(allowanceId)\r\n        return { success: true }\r\n    })\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\payroll\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\reports\\financial-reports-handlers.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'registerFinancialReportsHandlers' has too many lines (119). Maximum allowed is 80.","line":17,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":166,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ipcMain } from '../../electron-env';\nimport { DoubleEntryJournalService } from '../../services/accounting/DoubleEntryJournalService';\r\nimport { OpeningBalanceService } from '../../services/accounting/OpeningBalanceService';\r\nimport { ProfitAndLossService } from '../../services/accounting/ProfitAndLossService';\r\n\r\n/**\r\n * IPC Handlers for Financial Reports\r\n * Refactored: wrapped in registration function to prevent side-effects at import time\r\n *\r\n * Provides access to:\r\n * - Balance Sheet\r\n * - Profit & Loss Statement\r\n * - Trial Balance\r\n * - General Ledger\r\n */\r\n\r\nexport function registerFinancialReportsHandlers(): void {\r\n  const journalService = new DoubleEntryJournalService();\r\n  const plService = new ProfitAndLossService();\r\n  const obService = new OpeningBalanceService();\r\n\r\n  // ============================================================================\r\n  // BALANCE SHEET\r\n  // ============================================================================\r\n\r\n  ipcMain.handle('reports:getBalanceSheet', async (_event, asOfDate: string) => {\r\n    try {\r\n      const balanceSheet = await journalService.getBalanceSheet(asOfDate);\r\n      return {\r\n        success: true,\r\n        data: balanceSheet\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to generate balance sheet: ${(error as Error).message}`\r\n      };\r\n    }\r\n  });\r\n\r\n  // ============================================================================\r\n  // PROFIT & LOSS STATEMENT\r\n  // ============================================================================\r\n\r\n  ipcMain.handle('reports:getProfitAndLoss', async (_event, startDate: string, endDate: string) => {\r\n    try {\r\n      const profitAndLoss = await plService.generateProfitAndLoss(startDate, endDate);\r\n      return {\r\n        success: true,\r\n        data: profitAndLoss\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to generate P&L: ${(error as Error).message}`\r\n      };\r\n    }\r\n  });\r\n\r\n  ipcMain.handle(\r\n    'reports:getComparativeProfitAndLoss',\r\n    async (_event, currentStart: string, currentEnd: string, priorStart: string, priorEnd: string) => {\r\n      try {\r\n        const comparative = await plService.generateComparativeProfitAndLoss(\r\n          currentStart,\r\n          currentEnd,\r\n          priorStart,\r\n          priorEnd\r\n        );\r\n        return {\r\n          success: true,\r\n          data: comparative\r\n        };\r\n      } catch (error) {\r\n        return {\r\n          success: false,\r\n          message: `Failed to generate comparative P&L: ${(error as Error).message}`\r\n        };\r\n      }\r\n    }\r\n  );\r\n\r\n  // ============================================================================\r\n  // TRIAL BALANCE\r\n  // ============================================================================\r\n\r\n  ipcMain.handle('reports:getTrialBalance', async (_event, startDate: string, endDate: string) => {\r\n    try {\r\n      const trialBalance = await journalService.getTrialBalance(startDate, endDate);\r\n      return {\r\n        success: true,\r\n        data: trialBalance\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to generate trial balance: ${(error as Error).message}`\r\n      };\r\n    }\r\n  });\r\n\r\n  // ============================================================================\r\n  // STUDENT LEDGER\r\n  // ============================================================================\r\n\r\n  ipcMain.handle(\r\n    'reports:getStudentLedger',\r\n    async (_event, studentId: number, academicYearId: number, startDate: string, endDate: string) => {\r\n      try {\r\n        const studentLedger = await obService.getStudentLedger(\r\n          studentId,\r\n          academicYearId,\r\n          startDate,\r\n          endDate\r\n        );\r\n        return {\r\n          success: true,\r\n          data: studentLedger\r\n        };\r\n      } catch (error) {\r\n        return {\r\n          success: false,\r\n          message: `Failed to generate student ledger: ${(error as Error).message}`\r\n        };\r\n      }\r\n    }\r\n  );\r\n\r\n  // ============================================================================\r\n  // REVENUE BREAKDOWN\r\n  // ============================================================================\r\n\r\n  ipcMain.handle('reports:getRevenueBreakdown', async (_event, startDate: string, endDate: string) => {\r\n    try {\r\n      const breakdown = await plService.getRevenueBreakdown(startDate, endDate);\r\n      return {\r\n        success: true,\r\n        data: breakdown\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to get revenue breakdown: ${(error as Error).message}`\r\n      };\r\n    }\r\n  });\r\n\r\n  // ============================================================================\r\n  // EXPENSE BREAKDOWN\r\n  // ============================================================================\r\n\r\n  ipcMain.handle('reports:getExpenseBreakdown', async (_event, startDate: string, endDate: string) => {\r\n    try {\r\n      const breakdown = await plService.getExpenseBreakdown(startDate, endDate);\r\n      return {\r\n        success: true,\r\n        data: breakdown\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to get expense breakdown: ${(error as Error).message}`\r\n      };\r\n    }\r\n  });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\reports\\reports-handlers.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'registerReportsHandlers' has too many lines (290). Maximum allowed is 80.","line":21,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":363,"endColumn":2},{"ruleId":"sonarjs/no-misleading-array-reverse","severity":1,"message":"Move this array \"reverse\" operation to a separate statement or replace it with \"toReversed\".","line":134,"column":51,"nodeType":"CallExpression","messageId":"moveMethod","endLine":134,"endColumn":67,"suggestions":[{"messageId":"suggestMethod","data":{"suggestedMethod":"toReversed"},"fix":{"range":[5524,5531],"text":"toReversed"},"desc":"Replace with \"toReversed\" method"}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[729,732],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[729,732],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[859,862],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[859,862],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":339,"column":98,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":339,"endColumn":101,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14286,14289],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14286,14289],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":356,"column":100,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":356,"endColumn":103,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15060,15063],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15060,15063],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\r\nimport { ipcMain } from '../../electron-env'\r\nimport { NEMISExportService } from '../../services/reports/NEMISExportService'\n\r\nimport type { IpcMainInvokeEvent } from 'electron'\n\r\ninterface CountResult { count: number }\r\ninterface TotalResult { total: number }\r\ninterface TransactionRow {\r\n    transaction_date: string\r\n    transaction_type: string\r\n    amount: number\r\n    debit_credit: string\r\n    description: string\r\n    payment_method: string\r\n    receipt_number: string\r\n    invoice_number: string\r\n    term_name: string\r\n}\r\n\r\nexport function registerReportsHandlers(): void {\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const db = new Proxy({} as any, {\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        get: (_target, prop) => (getDatabase() as any)[prop]\r\n    });\r\n\r\n    // ======== REPORTS ========\r\n    ipcMain.handle('report:defaulters', async (_event: IpcMainInvokeEvent, termId?: number) => {\r\n        // SQL Injection Protection: Query is structured with parameterized values\r\n        // Added s.guardian_phone for SMS functionality\r\n        let query = `SELECT s.id, s.admission_number, s.first_name, s.last_name, \r\n            s.guardian_phone, st.stream_name, fi.invoice_number, fi.total_amount, fi.amount_paid,\r\n            (fi.total_amount - fi.amount_paid) as balance, fi.due_date\r\n        FROM student s\r\n        JOIN fee_invoice fi ON s.id = fi.student_id\r\n        LEFT JOIN enrollment e ON s.id = e.student_id AND e.id = (\r\n            SELECT MAX(id) FROM enrollment WHERE student_id = s.id\r\n        )\r\n        LEFT JOIN stream st ON e.stream_id = st.id\r\n        WHERE fi.status != 'PAID' AND fi.status != 'CANCELLED'`\r\n\r\n        const params: (number | string)[] = []\r\n        if (termId) {\r\n            query += ` AND fi.term_id = ?`\r\n            params.push(termId)\r\n        }\r\n\r\n        query += ` ORDER BY balance DESC`\r\n        return db.prepare(query).all(...params)\r\n    })\r\n\r\n    ipcMain.handle('report:financialSummary', async (_event: IpcMainInvokeEvent, startDate: string, endDate: string) => {\r\n        // Standardize Income: FEE_PAYMENT + DONATION + GRANT + INCOME\r\n        const income = db.prepare(`\r\n            SELECT SUM(amount) as total FROM ledger_transaction \r\n            WHERE (transaction_type IN ('INCOME', 'FEE_PAYMENT', 'DONATION', 'GRANT'))\r\n            AND is_voided = 0 \r\n            AND transaction_date BETWEEN ? AND ?\r\n        `).get(startDate, endDate) as TotalResult | undefined\r\n\r\n        const expenses = db.prepare(`\r\n            SELECT SUM(amount) as total FROM ledger_transaction \r\n            WHERE (transaction_type IN ('EXPENSE', 'SALARY_PAYMENT'))\r\n            AND is_voided = 0 \r\n            AND transaction_date BETWEEN ? AND ?\r\n        `).get(startDate, endDate) as TotalResult | undefined\r\n\r\n        const feePayments = db.prepare(`\r\n            SELECT SUM(amount) as total FROM ledger_transaction \r\n            WHERE transaction_type = 'FEE_PAYMENT' AND is_voided = 0 \r\n            AND transaction_date BETWEEN ? AND ?\r\n        `).get(startDate, endDate) as TotalResult | undefined\r\n\r\n        return {\r\n            totalIncome: income?.total || 0,\r\n            totalExpense: expenses?.total || 0,\r\n            feePayments: feePayments?.total || 0,\r\n            netBalance: (income?.total || 0) - (expenses?.total || 0)\r\n        }\r\n    })\r\n\r\n    ipcMain.handle('report:studentLedger', async (_event: IpcMainInvokeEvent, studentId: number) => {\r\n        const student = db.prepare('SELECT * FROM student WHERE id = ?').get(studentId)\r\n        if (!student) {return { success: false, error: 'Student not found' }}\r\n\r\n        // UNION ALL to get both Invoices (charges) and Transactions (payments)\r\n        // We use standardized column names for the union\r\n        const items = db.prepare(`\r\n            SELECT \r\n                invoice_date as date, \r\n                'DEBIT' as dc, \r\n                total_amount as amount, \r\n                'Invoice: ' || invoice_number as description,\r\n                invoice_number as ref\r\n            FROM fee_invoice \r\n            WHERE student_id = ?\r\n            \r\n            UNION ALL\r\n            \r\n            SELECT \r\n                lt.transaction_date as date, \r\n                lt.debit_credit as dc, \r\n                lt.amount as amount, \r\n                lt.description,\r\n                r.receipt_number as ref\r\n            FROM ledger_transaction lt\r\n            LEFT JOIN receipt r ON lt.id = r.transaction_id\r\n            WHERE lt.student_id = ? AND lt.is_voided = 0\r\n            \r\n            ORDER BY date ASC\r\n        `).all(studentId, studentId) as TransactionRow[]\n\r\n        const openingBalance = 0\r\n        let runningBalance = openingBalance\r\n\r\n        const ledger = items.map((item) => {\r\n            // Standard accounting: Debit increases what you owe, Credit decreases it.\r\n            // For the balance calculation:\r\n            const signedAmount = item.dc === 'DEBIT' ? item.amount : -item.amount\r\n            runningBalance += signedAmount\r\n\r\n            return {\r\n                transaction_date: item.date,\r\n                debit_credit: item.dc,\r\n                // We keep original positive amount for extraction in UI columns\r\n                amount: item.amount,\r\n                description: item.description,\r\n                ref: item.ref,\r\n                runningBalance\r\n            }\r\n        })\r\n\r\n        return { student, openingBalance, ledger: ledger.reverse(), closingBalance: runningBalance }\r\n    })\r\n\r\n    ipcMain.handle('report:attendance', async (_event: IpcMainInvokeEvent, startDate: string, endDate: string, streamId?: number) => {\r\n        let query = `\r\n            SELECT \r\n                s.id, s.admission_number, s.first_name, s.last_name,\r\n                st.stream_name,\r\n                COUNT(a.id) as total_days,\r\n                SUM(CASE WHEN a.status = 'PRESENT' THEN 1 ELSE 0 END) as present_days,\r\n                SUM(CASE WHEN a.status = 'ABSENT' THEN 1 ELSE 0 END) as absent_days,\r\n                SUM(CASE WHEN a.status = 'LATE' THEN 1 ELSE 0 END) as late_days\r\n            FROM student s\r\n            LEFT JOIN enrollment e ON s.id = e.student_id AND e.id = (\r\n                SELECT MAX(id) FROM enrollment WHERE student_id = s.id\r\n            )\r\n            LEFT JOIN stream st ON e.stream_id = st.id\r\n            LEFT JOIN attendance a ON s.id = a.student_id AND a.attendance_date BETWEEN ? AND ?\r\n            WHERE s.is_active = 1\r\n        `\r\n\r\n        const params: unknown[] = [startDate, endDate]\r\n\r\n        if (streamId) {\r\n            query += ` AND e.stream_id = ?`\r\n            params.push(streamId)\r\n        }\r\n\r\n        query += ` GROUP BY s.id ORDER BY st.stream_name, s.admission_number`\r\n        return db.prepare(query).all(...params)\r\n    })\r\n\r\n    ipcMain.handle('report:inventoryValuation', async () => {\r\n        return db.prepare(`\r\n            SELECT \r\n                i.item_code, i.item_name, c.category_name,\r\n                i.current_stock, i.unit_cost, (i.current_stock * i.unit_cost) as total_value,\r\n                i.reorder_level\r\n            FROM inventory_item i\r\n            LEFT JOIN inventory_category c ON i.category_id = c.id\r\n            WHERE i.is_active = 1\r\n            ORDER BY total_value DESC\r\n        `).all()\r\n    })\r\n\r\n    ipcMain.handle('report:staffPayroll', async (_event: IpcMainInvokeEvent, periodId: number) => {\r\n        const period = db.prepare('SELECT * FROM payroll_period WHERE id = ?').get(periodId)\r\n        if (!period) {return { success: false, error: 'Payroll period not found' }}\r\n\r\n        const payroll = db.prepare(`\r\n            SELECT \r\n                p.*, s.first_name, s.last_name, s.staff_number, s.department, s.job_title\r\n            FROM payroll p\r\n            JOIN staff s ON p.staff_id = s.id\r\n            WHERE p.period_id = ?\r\n            ORDER BY s.department, s.staff_number\r\n        `).all(periodId)\r\n\r\n        const summary = db.prepare(`\r\n            SELECT \r\n                SUM(gross_salary) as total_gross,\r\n                SUM(total_deductions) as total_deductions,\r\n                SUM(net_salary) as total_net,\r\n                COUNT(*) as staff_count\r\n            FROM payroll\r\n            WHERE period_id = ?\r\n        `).get(periodId)\r\n\r\n        return { period, payroll, summary }\r\n    })\r\n\r\n    ipcMain.handle('report:feeCollection', async (_event: IpcMainInvokeEvent, startDate: string, endDate: string) => {\r\n        return db.prepare(`\r\n            SELECT \r\n                DATE(transaction_date) as payment_date, \r\n                SUM(amount) as amount,\r\n                payment_method, \r\n                COUNT(*) as count \r\n            FROM ledger_transaction\r\n            WHERE transaction_type = 'FEE_PAYMENT' AND is_voided = 0\r\n            AND transaction_date BETWEEN ? AND ? \r\n            GROUP BY DATE(transaction_date), payment_method\r\n            ORDER BY DATE(transaction_date) ASC\r\n        `).all(startDate, endDate)\r\n    })\r\n\r\n    ipcMain.handle('report:dashboard', async () => {\r\n        const totalStudents = db.prepare('SELECT COUNT(*) as count FROM student WHERE is_active = 1').get() as CountResult | undefined\r\n        const totalStaff = db.prepare('SELECT COUNT(*) as count FROM staff WHERE is_active = 1').get() as CountResult | undefined\r\n        const feeCollected = db.prepare(`SELECT COALESCE(SUM(amount), 0) as total FROM ledger_transaction \r\n      WHERE transaction_type = 'FEE_PAYMENT' AND is_voided = 0`).get() as TotalResult | undefined\r\n        const outstandingBalance = db.prepare(`SELECT COALESCE(SUM(total_amount - amount_paid), 0) as total \r\n      FROM fee_invoice WHERE status IN ('PENDING', 'PARTIAL')`).get() as TotalResult | undefined\r\n\r\n        return {\r\n            totalStudents: totalStudents?.count || 0,\r\n            totalStaff: totalStaff?.count || 0,\r\n            feeCollected: feeCollected?.total || 0,\r\n            outstandingBalance: outstandingBalance?.total || 0\r\n        }\r\n    })\r\n\r\n    ipcMain.handle('report:revenueByCategory', async (_event: IpcMainInvokeEvent, startDate: string, endDate: string) => {\r\n        return db.prepare(`\r\n            SELECT \r\n                tc.category_name as name, \r\n                SUM(lt.amount) as value\r\n            FROM ledger_transaction lt\r\n            JOIN transaction_category tc ON lt.category_id = tc.id\r\n            WHERE lt.transaction_type IN ('INCOME', 'FEE_PAYMENT', 'DONATION', 'GRANT')\r\n            AND lt.is_voided = 0\r\n            AND lt.transaction_date BETWEEN ? AND ?\r\n            GROUP BY tc.id, tc.category_name\r\n            HAVING value > 0\r\n            ORDER BY value DESC\r\n        `).all(startDate, endDate)\r\n    })\r\n\r\n    ipcMain.handle('report:expenseByCategory', async (_event: IpcMainInvokeEvent, startDate: string, endDate: string) => {\r\n        return db.prepare(`\r\n            SELECT \r\n                tc.category_name as name, \r\n                SUM(lt.amount) as value\r\n            FROM ledger_transaction lt\r\n            JOIN transaction_category tc ON lt.category_id = tc.id\r\n            WHERE lt.transaction_type IN ('EXPENSE', 'SALARY_PAYMENT', 'REFUND')\r\n            AND lt.is_voided = 0\r\n            AND lt.transaction_date BETWEEN ? AND ?\r\n            GROUP BY tc.id, tc.category_name\r\n            HAVING value > 0\r\n            ORDER BY value DESC\r\n        `).all(startDate, endDate)\r\n    })\r\n\r\n    ipcMain.handle('report:dailyCollection', async (_event: IpcMainInvokeEvent, date: string) => {\n        return db.prepare(`\n            SELECT \n                lt.transaction_date as date,\n                s.admission_number,\n                s.first_name || ' ' || s.last_name as student_name,\n                st.stream_name,\n                lt.payment_method,\n                lt.payment_reference,\n                lt.amount,\n                lt.description\n            FROM ledger_transaction lt\n            JOIN student s ON lt.student_id = s.id\n            LEFT JOIN enrollment e ON s.id = e.student_id AND e.id = (\n                SELECT MAX(id) FROM enrollment WHERE student_id = s.id\n            )\n            LEFT JOIN stream st ON e.stream_id = st.id\n            WHERE lt.transaction_type = 'FEE_PAYMENT'\n            AND lt.is_voided = 0\n            AND lt.transaction_date = ?\n            ORDER BY lt.created_at ASC\n        `).all(date)\n    })\r\n\r\n    ipcMain.handle('report:feeCategoryBreakdown', async () => {\r\n        return db.prepare(`\r\n            SELECT \r\n                tc.category_name as name, \r\n                SUM(lt.amount) as value\r\n            FROM ledger_transaction lt\r\n            JOIN transaction_category tc ON lt.category_id = tc.id\r\n            WHERE lt.transaction_type = 'FEE_PAYMENT'\r\n            AND lt.is_voided = 0\r\n            GROUP BY tc.id, tc.category_name\r\n            HAVING value > 0\r\n            ORDER BY value DESC\r\n        `).all()\r\n    })\r\n\r\n    // ======== PHASE 3: NEMIS EXPORT ========\r\n    const nemisService = new NEMISExportService()\r\n\r\n    ipcMain.handle('reports:extractStudentData', async (_event: IpcMainInvokeEvent, filters?: {\r\n        academicYear?: string;\r\n        streamId?: number;\r\n        status?: string\r\n    }) => {\r\n        try {\r\n            return await nemisService.extractStudentData(filters)\r\n        } catch (error) {\r\n            throw new Error(error instanceof Error ? error.message : 'Failed to extract student data')\r\n        }\r\n    })\r\n\r\n    ipcMain.handle('reports:extractStaffData', async (_event: IpcMainInvokeEvent) => {\r\n        try {\r\n            return await nemisService.extractStaffData()\r\n        } catch (error) {\r\n            throw new Error(error instanceof Error ? error.message : 'Failed to extract staff data')\r\n        }\r\n    })\r\n\r\n    ipcMain.handle('reports:extractEnrollmentData', async (_event: IpcMainInvokeEvent, academicYear: string) => {\r\n        try {\r\n            return await nemisService.extractEnrollmentData(academicYear)\r\n        } catch (error) {\r\n            throw new Error(error instanceof Error ? error.message : 'Failed to extract enrollment data')\r\n        }\r\n    })\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    ipcMain.handle('reports:createNEMISExport', async (_event: IpcMainInvokeEvent, exportConfig: any, userId: number) => {\r\n        try {\r\n            return await nemisService.createExport(exportConfig, userId)\r\n        } catch (error) {\r\n            return { success: false, message: error instanceof Error ? error.message : 'Unknown error' }\r\n        }\r\n    })\r\n\r\n    ipcMain.handle('reports:getNEMISExportHistory', async (_event: IpcMainInvokeEvent, limit?: number) => {\r\n        try {\r\n            return await nemisService.getExportHistory(limit)\r\n        } catch (error) {\r\n            throw new Error(error instanceof Error ? error.message : 'Failed to get export history')\r\n        }\r\n    })\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    ipcMain.handle('reports:validateNEMISStudentData', async (_event: IpcMainInvokeEvent, student: any) => {\r\n        try {\r\n            return nemisService.validateStudentData(student)\r\n        } catch (error) {\r\n            throw new Error(error instanceof Error ? error.message : 'Failed to validate student data')\r\n        }\r\n    })\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\reports\\scheduler-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\settings\\settings-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\staff\\staff-handlers.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'registerStaffHandlers' has too many lines (89). Maximum allowed is 80.","line":49,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":144,"endColumn":2},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 18. Maximum allowed is 12.","line":64,"column":67,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":64,"endColumn":69},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 19. Maximum allowed is 12.","line":95,"column":93,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":95,"endColumn":95},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":133,"column":46,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":133,"endColumn":68}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\nimport { logAudit as _logAudit } from '../../database/utils/audit'\nimport { ipcMain } from '../../electron-env'\nimport { TaxCalculator as _TaxCalculator } from '../../tax/TaxStrategy'\n\ninterface StaffMember {\n  id: number\n  staff_number: string\n  first_name: string\n  middle_name: string\n  last_name: string\n  id_number: string\n  kra_pin: string\n  nhif_number: string\n  nssf_number: string\n  phone: string\n  email: string\n  bank_name: string\n  bank_account: string\n  department: string\n  job_title: string\n  employment_date: string\n  basic_salary: number\n  is_active: boolean\n  created_at: string\n  updated_at: string\n}\n\ninterface StaffCreateData {\n  staff_number?: string\n  first_name?: string\n  middle_name?: string | null\n  last_name?: string\n  id_number?: string | null\n  kra_pin?: string | null\n  nhif_number?: string | null\n  nssf_number?: string | null\n  phone?: string | null\n  email?: string | null\n  bank_name?: string | null\n  bank_account?: string | null\n  department?: string | null\n  job_title?: string | null\n  employment_date?: string | null\n  basic_salary?: number | null\n  is_active?: boolean\n}\n\nexport function registerStaffHandlers(): void {\n  const db = getDatabase()\n\n  // ======== STAFF ========\n  ipcMain.handle('staff:getAll', async (_, activeOnly = true) => {\n    const query = activeOnly\n      ? 'SELECT * FROM staff WHERE is_active = 1 ORDER BY staff_number'\n      : 'SELECT * FROM staff ORDER BY staff_number'\n    return db.prepare(query).all() as StaffMember[]\n  })\n\n  ipcMain.handle('staff:getById', async (_event, id: number) => {\n    return db.prepare('SELECT * FROM staff WHERE id = ?').get(id) as StaffMember | undefined\n  })\n\n  ipcMain.handle('staff:create', async (_, data: StaffCreateData) => {\n    if (!data.staff_number || !data.first_name || !data.last_name) {\n      throw new Error('Staff number, first name, and last name are required')\n    }\n    const stmt = db.prepare(`INSERT INTO staff (\n      staff_number, first_name, middle_name, last_name, id_number, kra_pin,\n      nhif_number, nssf_number, phone, email, bank_name, bank_account,\n      department, job_title, employment_date, basic_salary, is_active\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`)\n    const result = stmt.run(\n      data.staff_number,\n      data.first_name,\n      data.middle_name ?? null,\n      data.last_name,\n      data.id_number ?? null,\n      data.kra_pin ?? null,\n      data.nhif_number ?? null,\n      data.nssf_number ?? null,\n      data.phone ?? null,\n      data.email ?? null,\n      data.bank_name ?? null,\n      data.bank_account ?? null,\n      data.department ?? null,\n      data.job_title ?? null,\n      data.employment_date ?? null,\n      data.basic_salary ?? 0,\n      data.is_active === false ? 0 : 1\n    )\n    return { success: true, id: result.lastInsertRowid }\n  })\n\n  ipcMain.handle('staff:update', async (_event, id: number, data: Partial<StaffCreateData>) => {\n    db.prepare(`\n      UPDATE staff SET\n        staff_number = COALESCE(?, staff_number),\n        first_name = COALESCE(?, first_name),\n        middle_name = COALESCE(?, middle_name),\n        last_name = COALESCE(?, last_name),\n        id_number = COALESCE(?, id_number),\n        kra_pin = COALESCE(?, kra_pin),\n        nhif_number = COALESCE(?, nhif_number),\n        nssf_number = COALESCE(?, nssf_number),\n        phone = COALESCE(?, phone),\n        email = COALESCE(?, email),\n        bank_name = COALESCE(?, bank_name),\n        bank_account = COALESCE(?, bank_account),\n        department = COALESCE(?, department),\n        job_title = COALESCE(?, job_title),\n        employment_date = COALESCE(?, employment_date),\n        basic_salary = COALESCE(?, basic_salary),\n        is_active = COALESCE(?, is_active)\n      WHERE id = ?\n    `).run(\n      data.staff_number ?? null,\n      data.first_name ?? null,\n      data.middle_name ?? null,\n      data.last_name ?? null,\n      data.id_number ?? null,\n      data.kra_pin ?? null,\n      data.nhif_number ?? null,\n      data.nssf_number ?? null,\n      data.phone ?? null,\n      data.email ?? null,\n      data.bank_name ?? null,\n      data.bank_account ?? null,\n      data.department ?? null,\n      data.job_title ?? null,\n      data.employment_date ?? null,\n      data.basic_salary ?? null,\n      data.is_active === undefined ? null : (data.is_active ? 1 : 0),\n      id\n    )\n    return { success: true }\n  })\n\n  ipcMain.handle('staff:setActive', async (_event, id: number, isActive: boolean) => {\n    db.prepare('UPDATE staff SET is_active = ? WHERE id = ?').run(isActive ? 1 : 0, id)\n    return { success: true }\n  })\n  // Payroll handlers moved to payroll-handlers.ts\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\student\\student-handlers.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'registerStudentHandlers' has too many lines (133). Maximum allowed is 80.","line":69,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":212,"endColumn":2},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always falsy.","line":109,"column":9,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":109,"endColumn":17},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 25 to the 18 allowed.","line":158,"column":117,"nodeType":null,"messageId":"refactorFunction","endLine":158,"endColumn":119},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 30. Maximum allowed is 12.","line":158,"column":117,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":158,"endColumn":119},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":185,"column":39,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":185,"endColumn":61}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\nimport { ipcMain } from '../../electron-env'\n\nimport type { IpcMainInvokeEvent } from 'electron'\n\ninterface Student {\n  id: number\n  admission_number: string\n  first_name: string\n  middle_name: string\n  last_name: string\n  date_of_birth: string\n  gender: 'MALE' | 'FEMALE'\n  student_type: 'BOARDER' | 'DAY_SCHOLAR'\n  admission_date: string\n  guardian_name: string\n  guardian_phone: string\n  guardian_email: string\n  guardian_relationship: string\n  address: string\n  notes: string\n  is_active: number // Changed to number to match DB 1/0\n  created_at: string\n  updated_at: string\n  stream_name?: string\n  current_type?: string\n  balance?: number\n  credit_balance?: number\n}\n\ninterface StudentFilters {\n  search?: string\n  streamId?: number\n  isActive?: boolean\n}\n\ninterface StudentCreateData {\n  admission_number: string\n  first_name: string\n  middle_name: string\n  last_name: string\n  date_of_birth: string\n  gender: 'MALE' | 'FEMALE'\n  student_type: 'BOARDER' | 'DAY_SCHOLAR'\n  admission_date: string\n  guardian_name: string\n  guardian_phone: string\n  guardian_email: string\n  guardian_relationship: string\n  address: string\n  notes: string\n  is_active?: boolean\n  stream_id?: number\n}\n\nconst toDbGender = (gender: string) => {\n  const g = gender.toUpperCase()\n  if (g === 'MALE') {return 'M'}\n  if (g === 'FEMALE') {return 'F'}\n  return gender\n}\n\nconst fromDbGender = (gender: string) => {\n  if (gender === 'M') {return 'MALE'}\n  if (gender === 'F') {return 'FEMALE'}\n  return gender\n}\n\nexport function registerStudentHandlers(): void {\n  const db = getDatabase()\n\n  // ======== STUDENTS ========\n  ipcMain.handle('student:getAll', async (_event: IpcMainInvokeEvent, filters?: StudentFilters) => {\n    let query = `SELECT s.*, st.stream_name, e.student_type as current_type,\n        (SELECT COALESCE(SUM(total_amount - amount_paid), 0)\n         FROM fee_invoice \n         WHERE student_id = s.id AND status != 'CANCELLED'\n        ) as balance\n      FROM student s\n      LEFT JOIN enrollment e ON s.id = e.student_id AND e.id = (\n        SELECT MAX(id) FROM enrollment WHERE student_id = s.id\n      )\n      LEFT JOIN stream st ON e.stream_id = st.id\n      WHERE 1=1`\n    const params: unknown[] = []\n\n    if (filters?.search) {\n      query += ` AND (s.admission_number LIKE ? OR s.first_name LIKE ? OR s.last_name LIKE ?)`\n      params.push(`%${filters.search}%`, `%${filters.search}%`, `%${filters.search}%`)\n    }\n    if (filters?.streamId) {\n      query += ` AND e.stream_id = ?`\n      params.push(filters.streamId)\n    }\n    if (filters?.isActive !== undefined) {\n      query += ` AND s.is_active = ?`\n      params.push(filters.isActive ? 1 : 0)\n    }\n    query += ` ORDER BY s.admission_number`\n    const students = db.prepare(query).all(...params) as Student[]\n    return students.map(s => ({\n      ...s,\n      gender: fromDbGender(s.gender)\n    })) as Student[]\n  })\n\n  ipcMain.handle('student:getById', async (_event: IpcMainInvokeEvent, id: number) => {\n    const student = db.prepare('SELECT * FROM student WHERE id = ?').get(id) as Student\n    if (!student) {return}\n    const enr = db.prepare(`\n      SELECT e.stream_id, st.stream_name FROM enrollment e\n      LEFT JOIN stream st ON e.stream_id = st.id\n      WHERE e.student_id = ?\n      ORDER BY e.id DESC\n      LIMIT 1\n    `).get(id) as { stream_id: number; stream_name: string } | undefined\n    return {\n      ...student,\n      gender: fromDbGender(student.gender),\n      credit_balance: (student.credit_balance || 0),\n      stream_id: enr?.stream_id,\n      stream_name: enr?.stream_name\n    } as Student\n  })\n\n  ipcMain.handle('student:create', async (_event: IpcMainInvokeEvent, data: StudentCreateData) => {\n    const stmt = db.prepare(`INSERT INTO student (\n      admission_number, first_name, middle_name, last_name, date_of_birth, gender,\n      student_type, admission_date, guardian_name, guardian_phone, guardian_email,\n      guardian_relationship, address, notes\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`)\n    const result = stmt.run(\n      data.admission_number, data.first_name, data.middle_name, data.last_name,\n      data.date_of_birth, toDbGender(data.gender), data.student_type, data.admission_date,\n      data.guardian_name, data.guardian_phone, data.guardian_email,\n      data.guardian_relationship, data.address, data.notes\n    )\n    const newStudentId = Number(result.lastInsertRowid)\n    try {\n      if (data.stream_id) {\n        const currentYear = db.prepare(`SELECT id FROM academic_year WHERE is_current = 1 LIMIT 1`).get() as { id: number } | undefined\n        const yearId = currentYear?.id ?? (db.prepare(`SELECT id FROM academic_year ORDER BY id DESC LIMIT 1`).get() as { id: number } | undefined)?.id\n        const currentTerm = db.prepare(`SELECT id, academic_year_id FROM term WHERE is_current = 1 LIMIT 1`).get() as { id: number; academic_year_id: number } | undefined\n        const termId = currentTerm?.id ?? (yearId ? (db.prepare(`SELECT id FROM term WHERE academic_year_id = ? ORDER BY term_number DESC LIMIT 1`).get(yearId) as { id: number } | undefined)?.id : undefined)\n        if (yearId && termId) {\n          db.prepare(`INSERT INTO enrollment (student_id, academic_year_id, term_id, academic_term_id, stream_id, student_type, enrollment_date, status)\n            VALUES (?, ?, ?, ?, ?, ?, ?, 'ACTIVE')`).run(\n            newStudentId, yearId, termId, termId, data.stream_id, data.student_type, data.admission_date\n          )\n        }\n      }\n    } catch {\n      // Ignore error\n    }\n    return { success: true, id: newStudentId }\n  })\n\n  ipcMain.handle('student:update', async (_event: IpcMainInvokeEvent, id: number, data: Partial<StudentCreateData>) => {\n    const student = db.prepare('SELECT * FROM student WHERE id = ?').get(id) as Student | undefined\n    if (!student) {return { success: false, error: 'Student not found' }}\n\n    const stmt = db.prepare(`UPDATE student SET \n            admission_number = ?, first_name = ?, middle_name = ?, last_name = ?,\n            date_of_birth = ?, gender = ?, student_type = ?, admission_date = ?,\n            guardian_name = ?, guardian_phone = ?, guardian_email = ?,\n            guardian_relationship = ?, address = ?, notes = ?,\n            is_active = ?, updated_at = CURRENT_TIMESTAMP\n            WHERE id = ?`)\n\n    stmt.run(\n      data.admission_number !== undefined ? data.admission_number : student.admission_number,\n      data.first_name !== undefined ? data.first_name : student.first_name,\n      data.middle_name !== undefined ? data.middle_name : student.middle_name,\n      data.last_name !== undefined ? data.last_name : student.last_name,\n      data.date_of_birth !== undefined ? data.date_of_birth : student.date_of_birth,\n      data.gender !== undefined ? toDbGender(data.gender) : student.gender,\n      data.student_type !== undefined ? data.student_type : student.student_type,\n      data.admission_date !== undefined ? data.admission_date : student.admission_date,\n      data.guardian_name !== undefined ? data.guardian_name : student.guardian_name,\n      data.guardian_phone !== undefined ? data.guardian_phone : student.guardian_phone,\n      data.guardian_email !== undefined ? data.guardian_email : student.guardian_email,\n      data.guardian_relationship !== undefined ? data.guardian_relationship : student.guardian_relationship,\n      data.address !== undefined ? data.address : student.address,\n      data.notes !== undefined ? data.notes : student.notes,\n      data.is_active !== undefined ? (data.is_active ? 1 : 0) : student.is_active,\n      id\n    )\n    try {\n      if (data.stream_id) {\n        const currentYear = db.prepare(`SELECT id FROM academic_year WHERE is_current = 1 LIMIT 1`).get() as { id: number } | undefined\n        const yearId = currentYear?.id ?? (db.prepare(`SELECT id FROM academic_year ORDER BY id DESC LIMIT 1`).get() as { id: number } | undefined)?.id\n        const currentTerm = db.prepare(`SELECT id, academic_year_id FROM term WHERE is_current = 1 LIMIT 1`).get() as { id: number; academic_year_id: number } | undefined\n        const termId = currentTerm?.id ?? (yearId ? (db.prepare(`SELECT id FROM term WHERE academic_year_id = ? ORDER BY term_number DESC LIMIT 1`).get(yearId) as { id: number } | undefined)?.id : undefined)\n        if (yearId && termId) {\n          db.prepare(`INSERT INTO enrollment (student_id, academic_year_id, term_id, academic_term_id, stream_id, student_type, enrollment_date, status)\n            VALUES (?, ?, ?, ?, ?, ?, DATE('now'), 'ACTIVE')`).run(\n            id, yearId, termId, termId, data.stream_id, data.student_type ?? student.student_type\n          )\n        }\n      }\n    } catch {\n      // Ignore error\n    }\n    return { success: true }\n  })\n\n  ipcMain.handle('student:getBalance', async (_event: IpcMainInvokeEvent, studentId: number) => {\n    const invoices = db.prepare(`SELECT COALESCE(SUM(total_amount - amount_paid), 0) as balance \n      FROM fee_invoice WHERE student_id = ? AND status != 'CANCELLED'`).get(studentId) as { balance: number } | undefined\n    return (invoices?.balance || 0)\n  })\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\transactions\\transactions-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\ipc\\workflow\\approval-handlers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\menu\\applicationMenu.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\security\\session.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\BackupService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\ConfigService.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":8,"column":35,"nodeType":"Literal","endLine":8,"endColumn":61}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../database'\r\nimport { safeStorage } from '../electron-env'\n\r\nexport class ConfigService {\r\n\r\n    // Save configuration (encrypt if needed)\r\n    static saveConfig(key: string, value: string, isEncrypted: boolean = false): boolean {\r\n        if (!db) {throw new Error('Database not initialized')}\r\n\r\n        let storedValue = value\r\n        if (isEncrypted && safeStorage.isEncryptionAvailable()) {\r\n            storedValue = safeStorage.encryptString(value).toString('base64')\r\n        } else if (isEncrypted) {\r\n            console.warn('SafeStorage unavailable, saving in plaintext (INSECURE)')\r\n        }\r\n\r\n        const stmt = db.prepare(`\r\n            INSERT INTO system_config (key, value, is_encrypted, updated_at)\r\n            VALUES (?, ?, ?, datetime('now'))\r\n            ON CONFLICT(key) DO UPDATE SET\r\n            value = excluded.value,\r\n            is_encrypted = excluded.is_encrypted,\r\n            updated_at = excluded.updated_at\r\n        `)\r\n\r\n        stmt.run(key, storedValue, isEncrypted ? 1 : 0)\r\n        return true\r\n    }\r\n\r\n    // Get configuration\r\n    static getConfig(key: string): string | null {\r\n        if (!db) {throw new Error('Database not initialized')}\r\n\r\n        const row = db.prepare('SELECT value, is_encrypted FROM system_config WHERE key = ?').get(key) as { value: string, is_encrypted: number } | undefined\r\n\r\n        if (!row) {return null}\r\n\r\n        if (row.is_encrypted) {\r\n            if (safeStorage.isEncryptionAvailable()) {\r\n                try {\r\n                    return safeStorage.decryptString(Buffer.from(row.value, 'base64'))\r\n                } catch (e) {\r\n                    console.error(`Failed to decrypt config for ${key}:`, e)\r\n                    return null\r\n                }\r\n            } else {\r\n                console.warn(`SafeStorage unavailable, cannot decrypt ${key}`)\r\n                return null\r\n            }\r\n        }\r\n\r\n        return row.value\r\n    }\r\n\r\n    // Get all public configs (non-sensitive or filtered)\r\n    static getAllConfigs(): Record<string, string> {\r\n        if (!db) {throw new Error('Database not initialized')}\r\n        // Only select non-encrypted or safe to show configs if needed\r\n        const rows = db.prepare('SELECT key, value, is_encrypted FROM system_config').all() as { key: string, value: string, is_encrypted: number }[]\r\n\r\n        const config: Record<string, string> = {}\r\n        for (const row of rows) {\r\n            // For UI, we might not want to send back encrypted values at all, or send mask\r\n            if (row.is_encrypted) {\r\n                config[row.key] = '******'\r\n            } else {\r\n                config[row.key] = row.value\r\n            }\r\n        }\r\n        return config\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\SystemMaintenanceService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\__tests__\\workflows.integration.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\academic\\AcademicSystemService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\academic\\AttendanceService.ts","messages":[{"ruleId":"max-params","severity":1,"message":"Async method 'markAttendance' has too many parameters (6). Maximum allowed is 5.","line":65,"column":5,"nodeType":"FunctionExpression","messageId":"exceed","endLine":65,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\r\nimport { logAudit } from '../../database/utils/audit'\r\n\r\nexport interface AttendanceRecord {\r\n    id: number\r\n    student_id: number\r\n    class_id: number | null\r\n    stream_id: number\r\n    academic_year_id: number\r\n    term_id: number\r\n    attendance_date: string\r\n    status: 'PRESENT' | 'ABSENT' | 'LATE' | 'EXCUSED'\r\n    notes: string | null\r\n    marked_by_user_id: number\r\n    created_at: string\r\n    // Computed\r\n    student_name?: string\r\n    admission_number?: string\r\n}\r\n\r\nexport interface AttendanceSummary {\r\n    total_days: number\r\n    present: number\r\n    absent: number\r\n    late: number\r\n    excused: number\r\n    attendance_rate: number\r\n}\r\n\r\nexport interface DailyAttendanceEntry {\r\n    student_id: number\r\n    status: 'PRESENT' | 'ABSENT' | 'LATE' | 'EXCUSED'\r\n    notes?: string\r\n}\r\n\r\nexport class AttendanceService {\r\n    private get db() { return getDatabase() }\r\n\r\n    /**\r\n     * Get attendance records for a specific date and stream\r\n     */\r\n    async getAttendanceByDate(\r\n        streamId: number,\r\n        date: string,\r\n        academicYearId: number,\r\n        termId: number\r\n    ): Promise<AttendanceRecord[]> {\r\n        return this.db.prepare(`\r\n      SELECT a.*, \r\n             s.first_name || ' ' || s.last_name as student_name,\r\n             s.admission_number\r\n      FROM attendance a\r\n      JOIN student s ON a.student_id = s.id\r\n      WHERE a.stream_id = ?\r\n        AND a.attendance_date = ?\r\n        AND a.academic_year_id = ?\r\n        AND a.term_id = ?\r\n      ORDER BY s.first_name, s.last_name\r\n    `).all(streamId, date, academicYearId, termId) as AttendanceRecord[]\r\n    }\r\n\r\n    /**\r\n     * Mark attendance for a class on a specific date\r\n     */\r\n    async markAttendance(\r\n        entries: DailyAttendanceEntry[],\r\n        streamId: number,\r\n        date: string,\r\n        academicYearId: number,\r\n        termId: number,\r\n        userId: number\r\n    ): Promise<{ success: boolean; marked: number; errors?: string[] }> {\r\n        let marked = 0\r\n\r\n        try {\r\n            const transaction = this.db.transaction(() => {\r\n                // Delete existing records for this date/stream\r\n                this.db.prepare(`\r\n          DELETE FROM attendance \r\n          WHERE stream_id = ? AND attendance_date = ? AND academic_year_id = ? AND term_id = ?\r\n        `).run(streamId, date, academicYearId, termId)\r\n\r\n                // Insert new records\r\n                const insertStmt = this.db.prepare(`\r\n          INSERT INTO attendance (student_id, stream_id, academic_year_id, term_id, attendance_date, status, notes, marked_by_user_id)\r\n          VALUES (?, ?, ?, ?, ?, ?, ?, ?)\r\n        `)\r\n\r\n                for (const entry of entries) {\r\n                    insertStmt.run(\r\n                        entry.student_id,\r\n                        streamId,\r\n                        academicYearId,\r\n                        termId,\r\n                        date,\r\n                        entry.status,\r\n                        entry.notes || null,\r\n                        userId\r\n                    )\r\n                    marked++\r\n                }\r\n            })\r\n\r\n            transaction()\r\n\r\n            logAudit(userId, 'BULK_CREATE', 'attendance', 0, null, {\r\n                stream_id: streamId,\r\n                date,\r\n                count: marked\r\n            })\r\n\r\n            return { success: true, marked }\r\n        } catch (error) {\r\n            return { success: false, marked: 0, errors: [error instanceof Error ? error.message : 'Unknown error'] }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get attendance summary for a student\r\n     */\r\n    async getStudentAttendanceSummary(\r\n        studentId: number,\r\n        academicYearId: number,\r\n        termId?: number\r\n    ): Promise<AttendanceSummary> {\r\n        let query = `\r\n      SELECT \r\n        COUNT(*) as total_days,\r\n        SUM(CASE WHEN status = 'PRESENT' THEN 1 ELSE 0 END) as present,\r\n        SUM(CASE WHEN status = 'ABSENT' THEN 1 ELSE 0 END) as absent,\r\n        SUM(CASE WHEN status = 'LATE' THEN 1 ELSE 0 END) as late,\r\n        SUM(CASE WHEN status = 'EXCUSED' THEN 1 ELSE 0 END) as excused\r\n      FROM attendance\r\n      WHERE student_id = ? AND academic_year_id = ?\r\n    `\r\n\r\n        const params: (number | undefined)[] = [studentId, academicYearId]\r\n\r\n        if (termId) {\r\n            query += ' AND term_id = ?'\r\n            params.push(termId)\r\n        }\r\n\r\n        const result = this.db.prepare(query).get(...params) as {\r\n            total_days: number\r\n            present: number\r\n            absent: number\r\n            late: number\r\n            excused: number\r\n        }\r\n\r\n        const totalDays = result.total_days || 0\r\n        const present = result.present || 0\r\n\r\n        return {\r\n            total_days: totalDays,\r\n            present,\r\n            absent: result.absent || 0,\r\n            late: result.late || 0,\r\n            excused: result.excused || 0,\r\n            attendance_rate: totalDays > 0 ? Math.round((present / totalDays) * 100) : 0\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get class attendance summary for a specific date\r\n     */\r\n    async getClassAttendanceSummary(\r\n        streamId: number,\r\n        date: string,\r\n        academicYearId: number,\r\n        termId: number\r\n    ): Promise<{ present: number; absent: number; late: number; excused: number; total: number }> {\r\n        const result = this.db.prepare(`\r\n      SELECT \r\n        SUM(CASE WHEN status = 'PRESENT' THEN 1 ELSE 0 END) as present,\r\n        SUM(CASE WHEN status = 'ABSENT' THEN 1 ELSE 0 END) as absent,\r\n        SUM(CASE WHEN status = 'LATE' THEN 1 ELSE 0 END) as late,\r\n        SUM(CASE WHEN status = 'EXCUSED' THEN 1 ELSE 0 END) as excused,\r\n        COUNT(*) as total\r\n      FROM attendance\r\n      WHERE stream_id = ? AND attendance_date = ? AND academic_year_id = ? AND term_id = ?\r\n    `).get(streamId, date, academicYearId, termId) as {\r\n            present: number\r\n            absent: number\r\n            late: number\r\n            excused: number\r\n            total: number\r\n        }\r\n\r\n        return {\r\n            present: result.present || 0,\r\n            absent: result.absent || 0,\r\n            late: result.late || 0,\r\n            excused: result.excused || 0,\r\n            total: result.total || 0\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get students for attendance marking (enrolled students in stream)\r\n     */\r\n    async getStudentsForAttendance(\r\n        streamId: number,\r\n        academicYearId: number,\r\n        termId: number\r\n    ): Promise<{ student_id: number; student_name: string; admission_number: string }[]> {\r\n        return this.db.prepare(`\r\n      SELECT \r\n        e.student_id,\r\n        s.first_name || ' ' || s.last_name as student_name,\r\n        s.admission_number\r\n      FROM enrollment e\r\n      JOIN student s ON e.student_id = s.id\r\n      WHERE e.stream_id = ?\r\n        AND e.academic_year_id = ?\r\n        AND e.term_id = ?\r\n        AND e.status = 'ACTIVE'\r\n        AND s.is_active = 1\r\n      ORDER BY s.first_name, s.last_name\r\n    `).all(streamId, academicYearId, termId) as { student_id: number; student_name: string; admission_number: string }[]\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\academic\\CBCReportCardService.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'generateReportCard' has too many lines (180). Maximum allowed is 80.","line":136,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":347,"endColumn":4},{"ruleId":"complexity","severity":1,"message":"Async method 'generateReportCard' has a complexity of 38. Maximum allowed is 12.","line":136,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":136,"endColumn":27},{"ruleId":"max-statements","severity":1,"message":"Async method 'generateReportCard' has too many statements (34). Maximum allowed is 30.","line":136,"column":27,"nodeType":"FunctionExpression","messageId":"exceed","endLine":347,"endColumn":4},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":143,"column":36,"nodeType":"Literal","endLine":143,"endColumn":69},{"ruleId":"complexity","severity":1,"message":"Async method 'buildReportCardFromRecord' has a complexity of 15. Maximum allowed is 12.","line":442,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":442,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\n\nexport interface StudentReportCard {\n  student_id: number\n  student_name: string\n  admission_number: string\n  stream_name: string\n  academic_year: string\n  term_name: string\n  subjects: {\n    subject_id: number\n    subject_name: string\n    marks: number\n    grade: string\n    percentage: number\n    teacher_comment: string\n    competency_level: string\n  }[]\n  total_marks: number\n  average_marks: number\n  overall_grade: string\n  position_in_class: number\n  position_in_stream: number\n  learning_areas: {\n    area_name: string\n    competency_level: 'meets_expectations'\n    teacher_comment: string\n  }[]\n  days_present: number\n  days_absent: number\n  attendance_percentage: number\n  class_teacher_comment: string\n  principal_comment: string\n  next_term_begin_date: string\n  fees_balance: number\n  qr_code_token: string\n  generated_at: string\n  email_sent_at?: string\n}\n\ninterface StudentResult {\n  id: number\n  admission_number: string\n  first_name: string\n  last_name: string\n  student_type?: string\n  stream_id?: number\n  balance?: number\n}\n\ninterface ExamResult {\n  id: number\n  academic_year_id: number\n  term_id: number\n}\n\ninterface StreamResult {\n  id: number\n  stream_name: string\n}\n\ninterface AcademicYearResult {\n  id: number\n  year_name: string\n}\n\ninterface TermResult {\n  id: number\n  term_name: string\n}\n\ninterface SubjectGradeResult {\n  subject_id: number\n  subject_name: string\n  marks: number\n  grade: string\n  percentage: number\n  teacher_comment: string\n  competency_level: string\n}\n\ninterface AttendanceResult {\n  days_present: number\n  days_absent: number\n}\n\ninterface ClassPositionResult {\n  position: number\n}\n\ninterface FeeBalanceResult {\n  balance: number\n}\n\ninterface LearningAreaResult {\n  area_name: string\n  competency_level: string\n  teacher_comment: string\n}\n\ninterface ReportCardRecord {\n  id: number\n  stream_id: number\n  total_marks: number\n  average_marks: number\n  overall_grade: string\n  position_in_class: number\n  position_in_stream: number\n  attendance_days_present: number\n  attendance_days_absent: number\n  attendance_percentage: number\n  class_teacher_remarks: string\n  principal_remarks: string\n  qr_code_token: string\n  generated_at: string\n  email_sent_at?: string\n}\n\ninterface ReportCardSubjectRecord {\n  subject_id: number\n  marks: number\n  grade: string\n  percentage: number\n  teacher_comment: string\n  competency_level: string\n}\n\nexport class CBCReportCardService {\n  private get db() {\n    return getDatabase()\n  }\n\n  /**\n   * Generate report card for a single student\n   */\n  async generateReportCard(\n    studentId: number,\n    examId: number,\n    generatedByUserId: number\n  ): Promise<StudentReportCard> {\n    try {\n      // Get exam details\n      const exam = this.db.prepare('SELECT * FROM exam WHERE id = ?').get(examId) as ExamResult | undefined\n      if (!exam) {throw new Error('Exam not found')}\n\n      // Get student info + enrollment for the exam term\n      const student = this.db.prepare(`\n        SELECT s.id, s.admission_number, s.first_name, s.last_name, s.student_type, e.stream_id\n        FROM student s\n        JOIN enrollment e ON s.id = e.student_id\n        WHERE s.id = ? AND e.academic_year_id = ? AND e.term_id = ?\n        ORDER BY e.enrollment_date DESC\n        LIMIT 1\n      `).get(studentId, exam.academic_year_id, exam.term_id) as StudentResult | undefined\n      if (!student) {throw new Error('Student not found or not enrolled for this term')}\n\n      const studentName = `${student.first_name} ${student.last_name}`\n\n      // Get stream info\n      const stream = this.db.prepare('SELECT * FROM stream WHERE id = ?').get(student.stream_id) as StreamResult | undefined\n      const streamName = stream?.stream_name || 'Unknown'\n\n      // Get academic year and term\n      const academicYear = this.db.prepare('SELECT * FROM academic_year WHERE id = ?').get(exam.academic_year_id) as AcademicYearResult | undefined\n      const term = this.db.prepare('SELECT * FROM term WHERE id = ?').get(exam.term_id) as TermResult | undefined\n\n      // Get subject grades\n      const subjects = this.db.prepare(`\n        SELECT \n          s.id as subject_id,\n          s.name as subject_name,\n          er.score as marks,\n          CASE \n            WHEN er.score >= 80 THEN 'A'\n            WHEN er.score >= 75 THEN 'A-'\n            WHEN er.score >= 70 THEN 'B+'\n            WHEN er.score >= 65 THEN 'B'\n            WHEN er.score >= 60 THEN 'B-'\n            WHEN er.score >= 55 THEN 'C+'\n            WHEN er.score >= 50 THEN 'C'\n            WHEN er.score >= 45 THEN 'C-'\n            ELSE 'E'\n          END as grade,\n          ROUND((er.score / 100) * 100, 1) as percentage,\n          COALESCE(er.teacher_remarks, '') as teacher_comment,\n          'Meets Expectations' as competency_level\n        FROM exam_result er\n        JOIN subject s ON er.subject_id = s.id\n        WHERE er.exam_id = ? AND er.student_id = ?\n        ORDER BY s.name\n      `).all(examId, studentId) as SubjectGradeResult[]\n\n      if (subjects.length === 0) {\n        throw new Error('No exam results found for this student')\n      }\n\n      // Calculate overall performance\n      const totalMarks = subjects.reduce((sum, s) => sum + s.marks, 0)\n      const averageMarks = totalMarks / subjects.length\n      const overallGrade = this.getGrade(averageMarks)\n\n      // Get learning area competencies (CBC specific)\n      const learningAreas = this.db.prepare(`\n        SELECT \n          'Sports & Games' as area_name,\n          'meets_expectations' as competency_level,\n          'Good participation in sports activities' as teacher_comment\n        UNION ALL\n        SELECT 'Arts & Crafts', 'meets_expectations', 'Creative work shown'\n        UNION ALL\n        SELECT 'Agriculture & Nutrition', 'meets_expectations', 'Active in field work'\n        UNION ALL\n        SELECT 'Leadership & Community Service', 'meets_expectations', 'Good contributions'\n      `).all() as LearningAreaResult[]\n\n      // Get attendance\n      const attendance = this.db.prepare(`\n        SELECT \n          COUNT(*) as days_present,\n          COALESCE((SELECT COUNT(*) FROM attendance WHERE student_id = ? AND is_present = 0), 0) as days_absent\n        FROM attendance\n        WHERE student_id = ? AND is_present = 1\n      `).get(studentId, studentId) as AttendanceResult | undefined\n\n      const totalAttendanceDays = (attendance?.days_present || 0) + (attendance?.days_absent || 0)\n      const attendancePercentage = totalAttendanceDays > 0\n        ? ((attendance?.days_present || 0) / totalAttendanceDays) * 100\n        : 0\n\n      // Get position\n      const studentAvgRow = this.db.prepare(`\n        SELECT AVG(score) as avg_score\n        FROM exam_result\n        WHERE exam_id = ? AND student_id = ?\n      `).get(examId, studentId) as { avg_score: number } | undefined\n\n      const classPosition = this.db.prepare(`\n        SELECT COUNT(*) as position\n        FROM (\n          SELECT er.student_id, AVG(er.score) as avg_score\n          FROM exam_result er\n          JOIN enrollment e ON er.student_id = e.student_id\n          WHERE er.exam_id = ? AND e.stream_id = ? AND e.academic_year_id = ? AND e.term_id = ?\n          GROUP BY er.student_id\n        ) t\n        WHERE t.avg_score > ?\n      `).get(examId, student.stream_id, exam.academic_year_id, exam.term_id, studentAvgRow?.avg_score || 0) as ClassPositionResult | undefined\n\n      // Generate QR code token\n      const qrCodeToken = this.generateQRToken(studentId, examId)\n\n      // Get fees balance\n      const feeBalance = this.db.prepare(`\n        SELECT COALESCE(SUM(total_amount - amount_paid), 0) as balance\n        FROM fee_invoice\n        WHERE student_id = ?\n      `).get(studentId) as FeeBalanceResult | undefined\n\n      // Create report card record\n      const insertQuery = this.db.prepare(`\n        INSERT OR REPLACE INTO report_card \n        (exam_id, student_id, stream_id, generated_by_user_id, overall_grade, total_marks, average_marks, \n         position_in_class, class_teacher_remarks, principal_remarks, attendance_days_present, \n         attendance_days_absent, attendance_percentage, qr_code_token, generated_at)\n        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n      `)\n\n      const now = new Date().toISOString()\n      const reportCardId = insertQuery.run(\n        examId,\n        studentId,\n        student.stream_id,\n        generatedByUserId,\n        overallGrade,\n        totalMarks,\n        averageMarks,\n        classPosition?.position || 1,\n        'Excellent performance this term. Keep up the good work!',\n        'Well done on your academic progress.',\n        attendance?.days_present || 0,\n        attendance?.days_absent || 0,\n        attendancePercentage,\n        qrCodeToken,\n        now\n      ).lastInsertRowid as number\n\n      // Insert subject grades\n      const subjectInsert = this.db.prepare(`\n        INSERT OR REPLACE INTO report_card_subject \n        (report_card_id, subject_id, marks, grade, percentage, teacher_comment, competency_level)\n        VALUES (?, ?, ?, ?, ?, ?, ?)\n      `)\n\n      for (const subject of subjects) {\n        subjectInsert.run(\n          reportCardId,\n          subject.subject_id,\n          subject.marks,\n          subject.grade,\n          subject.percentage,\n          subject.teacher_comment,\n          subject.competency_level\n        )\n      }\n\n      return {\n        student_id: studentId,\n        student_name: studentName,\n        admission_number: student.admission_number,\n        stream_name: streamName,\n        academic_year: academicYear?.year_name || 'Unknown',\n        term_name: term?.term_name || 'Unknown',\n        subjects: subjects.map(s => ({\n          subject_id: s.subject_id,\n          subject_name: s.subject_name,\n          marks: s.marks,\n          grade: s.grade,\n          percentage: s.percentage,\n          teacher_comment: s.teacher_comment,\n          competency_level: s.competency_level\n        })),\n        total_marks: totalMarks,\n        average_marks: averageMarks,\n        overall_grade: overallGrade,\n        position_in_class: classPosition?.position || 1,\n        position_in_stream: classPosition?.position || 1,\n        learning_areas: learningAreas.map(la => ({\n          area_name: la.area_name,\n          competency_level: la.competency_level as 'meets_expectations', // Cast to valid enum member\n          teacher_comment: la.teacher_comment\n        })),\n        days_present: attendance?.days_present || 0,\n        days_absent: attendance?.days_absent || 0,\n        attendance_percentage: attendancePercentage,\n        class_teacher_comment: 'Excellent performance this term. Keep up the good work!',\n        principal_comment: 'Well done on your academic progress.',\n        next_term_begin_date: this.getNextTermDate(exam.term_id),\n        fees_balance: feeBalance?.balance || 0,\n        qr_code_token: qrCodeToken,\n        generated_at: now\n      }\n    } catch (error) {\n      throw new Error(\n        `Failed to generate report card: ${error instanceof Error ? error.message : String(error)}`\n      )\n    }\n  }\n\n  /**\n   * Batch generate report cards for entire class\n   */\n  async generateBatchReportCards(\n    examId: number,\n    streamId: number,\n    generatedByUserId: number\n  ): Promise<StudentReportCard[]> {\n    try {\n      const exam = this.db.prepare('SELECT * FROM exam WHERE id = ?').get(examId) as ExamResult | undefined\n      if (!exam) {throw new Error('Exam not found')}\n\n      const students = this.db.prepare(`\n        SELECT s.id\n        FROM student s\n        JOIN enrollment e ON s.id = e.student_id\n        WHERE e.stream_id = ? AND e.academic_year_id = ? AND e.term_id = ? AND s.is_active = 1\n        ORDER BY s.last_name, s.first_name\n      `).all(streamId, exam.academic_year_id, exam.term_id) as { id: number }[]\n\n      const reportCards: StudentReportCard[] = []\n\n      for (const student of students) {\n        try {\n          const reportCard = await this.generateReportCard(\n            student.id,\n            examId,\n            generatedByUserId\n          )\n          reportCards.push(reportCard)\n        } catch (error) {\n          console.error(`Failed to generate report card for student ${student.id}:`, error)\n          // Continue with next student\n        }\n      }\n\n      return reportCards\n    } catch (error) {\n      throw new Error(\n        `Failed to batch generate report cards: ${error instanceof Error ? error.message : String(error)}`\n      )\n    }\n  }\n\n  /**\n   * Get report card by exam and student\n   */\n  async getReportCard(\n    examId: number,\n    studentId: number\n  ): Promise<StudentReportCard | null> {\n    try {\n      const rc = this.db.prepare(`\n        SELECT * FROM report_card WHERE exam_id = ? AND student_id = ?\n      `).get(examId, studentId) as ReportCardRecord | undefined\n\n      if (!rc) {return null}\n\n      // Reconstruct full report card\n      return this.buildReportCardFromRecord(rc, examId, studentId)\n    } catch (error) {\n      throw new Error(`Failed to get report card: ${error instanceof Error ? error.message : String(error)}`)\n    }\n  }\n\n  /**\n   * Private helper methods\n   */\n  private getGrade(score: number): string {\n    if (score >= 80) {return 'A'}\n    if (score >= 75) {return 'A-'}\n    if (score >= 70) {return 'B+'}\n    if (score >= 65) {return 'B'}\n    if (score >= 60) {return 'B-'}\n    if (score >= 55) {return 'C+'}\n    if (score >= 50) {return 'C'}\n    if (score >= 45) {return 'C-'}\n    return 'E'\n  }\n\n  private generateQRToken(studentId: number, examId: number): string {\n    // Generate a token for QR code verification\n    const timestamp = Date.now()\n    return `RC-${studentId}-${examId}-${timestamp}`\n  }\n\n  private getNextTermDate(_termId: number): string {\n    // Calculate next term start date (typically 3 months after current term)\n    const today = new Date()\n    const nextTerm = new Date(today.getFullYear(), today.getMonth() + 3, 1)\n    return nextTerm.toISOString().split('T')[0]\n  }\n\n  private async buildReportCardFromRecord(\n    rc: ReportCardRecord,\n    examId: number,\n    studentId: number\n  ): Promise<StudentReportCard> {\n    const student = this.db.prepare('SELECT * FROM student WHERE id = ?').get(studentId) as StudentResult | undefined\n    const exam = this.db.prepare('SELECT * FROM exam WHERE id = ?').get(examId) as ExamResult | undefined\n    const stream = this.db.prepare('SELECT * FROM stream WHERE id = ?').get(rc.stream_id) as StreamResult | undefined\n    const year = this.db.prepare('SELECT * FROM academic_year WHERE id = ?').get(exam?.academic_year_id) as AcademicYearResult | undefined\n    const term = this.db.prepare('SELECT * FROM term WHERE id = ?').get(exam?.term_id) as TermResult | undefined\n\n    const subjects = this.db.prepare(`\n      SELECT * FROM report_card_subject WHERE report_card_id = ?\n    `).all(rc.id) as ReportCardSubjectRecord[]\n\n    return {\n      student_id: studentId,\n      student_name: student ? `${student.first_name} ${student.last_name}` : 'Unknown',\n      admission_number: student?.admission_number || '',\n      stream_name: stream?.stream_name || 'Unknown',\n      academic_year: year?.year_name || 'Unknown',\n      term_name: term?.term_name || 'Unknown',\n      subjects: subjects.map(s => ({\n        subject_id: s.subject_id,\n        subject_name: '', // Would need to fetch\n        marks: s.marks,\n        grade: s.grade,\n        percentage: s.percentage,\n        teacher_comment: s.teacher_comment || '',\n        competency_level: s.competency_level || ''\n      })),\n      total_marks: rc.total_marks,\n      average_marks: rc.average_marks,\n      overall_grade: rc.overall_grade,\n      position_in_class: rc.position_in_class,\n      position_in_stream: rc.position_in_stream,\n      learning_areas: [],\n      days_present: rc.attendance_days_present,\n      days_absent: rc.attendance_days_absent,\n      attendance_percentage: rc.attendance_percentage,\n      class_teacher_comment: rc.class_teacher_remarks || '',\n      principal_comment: rc.principal_remarks || '',\n      next_term_begin_date: '',\n      fees_balance: 0,\n      qr_code_token: rc.qr_code_token || '',\n      generated_at: rc.generated_at,\n      email_sent_at: rc.email_sent_at\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\academic\\ExamAnalysisService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\academic\\ExamSchedulerService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\academic\\MeritListService.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'generateClassMeritList' has too many lines (93). Maximum allowed is 80.","line":148,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":256,"endColumn":4},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":339,"column":43,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":339,"endColumn":80}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\r\n\r\nexport interface StudentRanking {\r\n  position: number\r\n  student_id: number\r\n  student_name: string\r\n  admission_number: string\r\n  total_marks: number\r\n  average_marks: number\r\n  grade: string\r\n  percentage: number\r\n  tied_with: number[]\r\n  remarks?: string\r\n}\r\n\r\nexport interface MeritListResult {\r\n  id: number\r\n  academic_year_id: number\r\n  term_id: number\r\n  stream_id: number\r\n  exam_id: number\r\n  list_type: 'overall' | 'subject'\r\n  subject_id?: number\r\n  total_students: number\r\n  generated_by_user_id: number\r\n  generated_date: string\r\n  rankings: StudentRanking[]\r\n}\r\n\r\nexport interface SubjectDifficulty {\n  subject_id: number\n  subject_name: string\n  mean_score: number\n  median_score: number\n  pass_rate: number\n  difficulty_index: number\n  discrimination_index: number\n  verdict: string\n}\n\r\nexport interface PerformanceImprovement {\r\n  student_id: number\r\n  student_name: string\r\n  previous_average: number\r\n  current_average: number\r\n  improvement_percentage: number\r\n  improvement_points: number\r\n  grade_improvement: string\r\n  subjects_improved: number\r\n  subjects_declined: number\r\n}\r\n\r\ninterface MeritListRow {\r\n  position: number;\r\n  student_id: number;\r\n  admission_number: string;\r\n  student_name: string;\r\n  total_marks: number;\r\n  average_marks: number;\r\n  grade: string;\r\n}\r\n\r\ninterface StudentResultRow {\r\n  id: number;\r\n  name: string;\r\n  admission_number: string;\r\n  subject_count: number;\r\n  total_marks: number;\r\n  average_marks: number;\r\n}\r\n\r\ninterface GradingScaleRow {\r\n  grade: string;\r\n  min_score: number;\r\n  max_score: number;\r\n}\r\n\r\ninterface SubjectMeritListRow {\r\n  student_id: number;\r\n  student_name: string;\r\n  admission_number: string;\r\n  marks: number;\r\n  percentage: number;\r\n}\r\n\r\ninterface ImprovementRow {\r\n  id: number;\r\n  name: string;\r\n  previous_average: number;\r\n  current_average: number;\r\n}\r\n\r\nexport class MeritListService {\r\n  private get db() {\r\n    return getDatabase()\r\n  }\r\n\r\n  async generateMeritList(options: {\r\n    academicYearId: number\r\n    termId: number\r\n    streamId: number\r\n  }) {\r\n    const { academicYearId, termId, streamId } = options\r\n\r\n    // Get latest exam for this term\r\n    const exam = this.db.prepare(`\r\n      SELECT id FROM exam \r\n      WHERE academic_year_id = ? AND term_id = ? \r\n      ORDER BY created_at DESC \r\n      LIMIT 1\r\n    `).get(academicYearId, termId) as { id: number } | undefined\r\n\r\n    if (!exam) {\r\n      throw new Error('No exam found for the selected academic year and term.')\r\n    }\r\n\r\n    const meritList = this.db.prepare(`\r\n      SELECT \r\n        rcs.class_position as position,\r\n        s.id as student_id,\r\n        s.admission_number,\r\n        s.first_name || ' ' || s.last_name as student_name,\r\n        rcs.total_marks,\r\n        rcs.mean_score as average_marks,\r\n        rcs.mean_grade as grade\r\n      FROM report_card_summary rcs\r\n      JOIN student s ON rcs.student_id = s.id\r\n      WHERE rcs.exam_id = ? AND s.stream_id = ? AND s.is_active = 1\r\n      ORDER BY rcs.class_position ASC\r\n    `).all(exam.id, streamId) as MeritListRow[]\r\n\r\n    // Format results\r\n    return meritList.map((item, index) => ({\r\n      position: index + 1,\r\n      student_id: item.student_id,\r\n      admission_number: item.admission_number,\r\n      student_name: item.student_name,\r\n      total_marks: item.total_marks,\r\n      average_marks: item.average_marks,\r\n      grade: item.grade,\r\n      percentage: (item.average_marks / 100) * 100\r\n    }))\r\n  }\r\n\r\n  /**\r\n   * Generate class merit list with proper ranking\r\n   */\r\n  async generateClassMeritList(\r\n    academicYearId: number,\r\n    termId: number,\r\n    streamId: number,\r\n    examId: number,\r\n    generatedByUserId: number\r\n  ): Promise<MeritListResult> {\r\n    try {\r\n      // Get all student results for this exam and stream\r\n      const studentResults = this.db.prepare(`\r\n        SELECT \r\n          s.id,\r\n          s.name,\r\n          s.admission_number,\r\n          COUNT(er.id) as subject_count,\r\n          SUM(er.score) as total_marks,\r\n          AVG(er.score) as average_marks\r\n        FROM student s\r\n        JOIN stream st ON s.stream_id = st.id\r\n        JOIN exam_result er ON s.id = er.student_id\r\n        WHERE er.exam_id = ? \r\n          AND st.id = ?\r\n          AND s.is_active = 1\r\n        GROUP BY s.id\r\n        ORDER BY average_marks DESC, total_marks DESC\r\n      `).all(examId, streamId) as StudentResultRow[]\r\n\r\n      if (studentResults.length === 0) {\r\n        throw new Error('No exam results found for this class/stream')\r\n      }\r\n\r\n      // Create merit list record\r\n      const meritListInsert = this.db.prepare(`\r\n        INSERT INTO merit_list \r\n        (academic_year_id, term_id, stream_id, exam_id, list_type, generated_by_user_id, generated_date, total_students)\r\n        VALUES (?, ?, ?, ?, 'overall', ?, ?, ?)\r\n      `)\r\n\r\n      const now = new Date().toISOString()\r\n      const meritListId = meritListInsert.run(\r\n        academicYearId,\r\n        termId,\r\n        streamId,\r\n        examId,\r\n        generatedByUserId,\r\n        now,\r\n        studentResults.length\r\n      ).lastInsertRowid as number\r\n\r\n      // Calculate rankings\r\n      const rankings = this.calculateRankings(studentResults)\r\n\r\n      // Get grading scale\r\n      const gradingScale = this.db.prepare(`\r\n        SELECT * FROM grading_scale \r\n        WHERE curriculum = 'CBC'\r\n        ORDER BY min_score DESC\r\n      `).all() as GradingScaleRow[]\r\n\r\n      // Insert merit list entries\r\n      const entryInsert = this.db.prepare(`\r\n        INSERT INTO merit_list_entry \r\n        (merit_list_id, student_id, position, total_marks, average_marks, grade, percentage, class_position, tied_count)\r\n        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n      `)\r\n\r\n      const insertedRankings: StudentRanking[] = []\r\n\r\n      for (const ranking of rankings) {\r\n        const grade = this.getGrade(ranking.average_marks, gradingScale)\r\n        const percentage = (ranking.average_marks / 100) * 100\r\n\r\n        entryInsert.run(\r\n          meritListId,\r\n          ranking.student_id,\r\n          ranking.position,\r\n          ranking.total_marks,\r\n          ranking.average_marks,\r\n          grade,\r\n          percentage,\r\n          ranking.position,\r\n          ranking.tied_with.length + 1\r\n        )\r\n\r\n        insertedRankings.push({\r\n          ...ranking,\r\n          grade,\r\n          percentage\r\n        })\r\n      }\r\n\r\n      return {\r\n        id: meritListId,\r\n        academic_year_id: academicYearId,\r\n        term_id: termId,\r\n        stream_id: streamId,\r\n        exam_id: examId,\r\n        list_type: 'overall',\r\n        total_students: studentResults.length,\r\n        generated_by_user_id: generatedByUserId,\r\n        generated_date: now,\r\n        rankings: insertedRankings\r\n      }\r\n    } catch (error) {\r\n      throw new Error(\r\n        `Failed to generate merit list: ${error instanceof Error ? error.message : String(error)}`\r\n      )\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get subject merit list\r\n   */\r\n  async getSubjectMeritList(examId: number, subjectId: number, streamId: number): Promise<(SubjectMeritListRow & { position: number })[]> {\n    const results = this.db.prepare(`\n      SELECT \n        s.id as student_id,\n        TRIM(COALESCE(s.first_name, '') || ' ' || COALESCE(s.last_name, '')) as student_name,\n        s.admission_number,\n        er.score as marks,\n        (er.score / 100) * 100 as percentage\n      FROM exam_result er\n      JOIN exam ex ON er.exam_id = ex.id\n      JOIN student s ON er.student_id = s.id\n      JOIN enrollment e ON e.student_id = s.id\n        AND e.stream_id = ?\n        AND e.term_id = ex.term_id\n        AND e.academic_year_id = ex.academic_year_id\n        AND e.status = 'ACTIVE'\n      WHERE er.exam_id = ?\n        AND er.subject_id = ?\n        AND er.score IS NOT NULL\n      ORDER BY er.score DESC\n    `).all(streamId, examId, subjectId) as SubjectMeritListRow[]\n\r\n    return results.map((r, index) => ({\n      ...r,\n      position: index + 1\n    }))\n  }\n\n  /**\n   * Calculate subject difficulty metrics\n   */\n  async getSubjectDifficulty(examId: number, subjectId: number, streamId: number): Promise<SubjectDifficulty> {\n    const rows = this.db.prepare(`\n      SELECT er.score as marks\n      FROM exam_result er\n      JOIN exam ex ON er.exam_id = ex.id\n      JOIN student s ON er.student_id = s.id\n      JOIN enrollment e ON e.student_id = s.id\n        AND e.stream_id = ?\n        AND e.term_id = ex.term_id\n        AND e.academic_year_id = ex.academic_year_id\n        AND e.status = 'ACTIVE'\n      WHERE er.exam_id = ?\n        AND er.subject_id = ?\n        AND er.score IS NOT NULL\n    `).all(streamId, examId, subjectId) as Array<{ marks: number }>\n\n    if (rows.length === 0) {\n      return {\n        subject_id: subjectId,\n        subject_name: 'Unknown',\n        mean_score: 0,\n        median_score: 0,\n        pass_rate: 0,\n        difficulty_index: 0,\n        discrimination_index: 0,\n        verdict: 'Insufficient data'\n      }\n    }\n\n    const scores = rows.map(r => Number(r.marks)).filter(n => !Number.isNaN(n))\n    const mean = scores.reduce((sum, v) => sum + v, 0) / scores.length\n    const sorted = [...scores].sort((a, b) => a - b)\n    const mid = Math.floor(sorted.length / 2)\n    const median = sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid]\n    const passCount = scores.filter(s => s >= 50).length\n    const passRate = (passCount / scores.length) * 100\n\n    // Simple difficulty index: higher mean => easier subject\n    const difficultyIndex = mean\n    // Simple discrimination: difference between top 27% and bottom 27% mean\n    const band = Math.max(1, Math.floor(scores.length * 0.27))\n    const topMean = sorted.slice(-band).reduce((sum, v) => sum + v, 0) / band\n    const bottomMean = sorted.slice(0, band).reduce((sum, v) => sum + v, 0) / band\n    const discriminationIndex = topMean - bottomMean\n\n    const subject = this.db.prepare(`SELECT name FROM subject WHERE id = ?`).get(subjectId) as { name?: string } | undefined\n\n    const verdict = mean >= 70 ? 'Easy' : mean >= 50 ? 'Moderate' : 'Difficult'\n\n    return {\n      subject_id: subjectId,\n      subject_name: subject?.name || 'Unknown',\n      mean_score: Number(mean.toFixed(2)),\n      median_score: Number(median.toFixed(2)),\n      pass_rate: Number(passRate.toFixed(2)),\n      difficulty_index: Number(difficultyIndex.toFixed(2)),\n      discrimination_index: Number(discriminationIndex.toFixed(2)),\n      verdict\n    }\n  }\n\r\n  /**\r\n   * Calculate performance improvements\r\n   */\r\n  async calculatePerformanceImprovements(\r\n    academicYearId: number,\r\n    currentTermId: number,\r\n    previousTermId: number,\r\n    streamId?: number\r\n  ): Promise<PerformanceImprovement[]> {\r\n    try {\r\n      let query = `\r\n        SELECT \n          s.id,\n          TRIM(COALESCE(s.first_name, '') || ' ' || COALESCE(s.last_name, '')) as name,\n          COALESCE(prev.average_marks, 0) as previous_average,\n          COALESCE(curr.average_marks, 0) as current_average\n        FROM student s\n        JOIN enrollment en ON en.student_id = s.id\n          AND en.academic_year_id = ?\n          AND en.term_id = ?\n          AND en.status = 'ACTIVE'\n        LEFT JOIN (\n          SELECT student_id, AVG(mean_score) as average_marks\n          FROM report_card_summary rcs\n          JOIN exam e ON rcs.exam_id = e.id\n          WHERE e.term_id = ? AND e.academic_year_id = ?\n          GROUP BY student_id\n        ) prev ON s.id = prev.student_id\n        LEFT JOIN (\n          SELECT student_id, AVG(mean_score) as average_marks\n          FROM report_card_summary rcs\n          JOIN exam e ON rcs.exam_id = e.id\n          WHERE e.term_id = ? AND e.academic_year_id = ?\n          GROUP BY student_id\n        ) curr ON s.id = curr.student_id\n        WHERE s.is_active = 1\n      `\n\n      const params = [academicYearId, currentTermId, previousTermId, academicYearId, currentTermId, academicYearId]\n\n      if (streamId) {\n        query += ` AND en.stream_id = ?`\n        params.push(streamId)\n      }\n\r\n      query += ` ORDER BY ((curr.average_marks - prev.average_marks) / NULLIF(prev.average_marks, 0) * 100) DESC`\r\n\r\n      const results = this.db.prepare(query).all(...params) as ImprovementRow[]\r\n\r\n      return results.map(result => {\r\n        const improvement = result.current_average - result.previous_average\r\n        const improvementPercentage = result.previous_average > 0\r\n          ? (improvement / result.previous_average) * 100\r\n          : 0\r\n        const gradeImprovement = this.getGradeChange(result.previous_average, result.current_average)\r\n\r\n        return {\r\n          student_id: result.id,\r\n          student_name: result.name,\r\n          previous_average: result.previous_average,\r\n          current_average: result.current_average,\r\n          improvement_percentage: improvementPercentage,\r\n          improvement_points: improvement,\r\n          grade_improvement: gradeImprovement,\r\n          subjects_improved: 0,\r\n          subjects_declined: 0\r\n        }\r\n      })\r\n    } catch (error) {\r\n      throw new Error(\r\n        `Failed to calculate improvements: ${error instanceof Error ? error.message : String(error)}`\r\n      )\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Private helper methods\r\n   */\r\n  private calculateRankings(students: StudentResultRow[]): StudentRanking[] {\r\n    const rankings: StudentRanking[] = []\r\n    let position = 1\r\n\r\n    for (let i = 0; i < students.length; i++) {\r\n      const student = students[i]\r\n\r\n      // Check if tied with previous student\r\n      if (i > 0 && students[i].average_marks === students[i - 1].average_marks) {\r\n        const lastRanking = rankings[rankings.length - 1]\r\n        lastRanking.tied_with.push(student.id)\r\n\r\n        rankings.push({\r\n          position: lastRanking.position,\r\n          student_id: student.id,\r\n          student_name: student.name,\r\n          admission_number: student.admission_number,\r\n          total_marks: student.total_marks,\r\n          average_marks: student.average_marks,\r\n          grade: '',\r\n          percentage: 0,\r\n          tied_with: [lastRanking.student_id]\r\n        })\r\n      } else {\r\n        position = i + 1\r\n        rankings.push({\r\n          position,\r\n          student_id: student.id,\r\n          student_name: student.name,\r\n          admission_number: student.admission_number,\r\n          total_marks: student.total_marks,\r\n          average_marks: student.average_marks,\r\n          grade: '',\r\n          percentage: 0,\r\n          tied_with: []\r\n        })\r\n      }\r\n    }\r\n\r\n    return rankings\r\n  }\r\n\r\n  private getGrade(score: number, gradingScale: GradingScaleRow[]): string {\r\n    for (const grade of gradingScale) {\r\n      if (score >= grade.min_score && score <= grade.max_score) {\r\n        return grade.grade\r\n      }\r\n    }\r\n    return 'E'\r\n  }\r\n\r\n  private getGradeChange(previousScore: number, currentScore: number): string {\r\n    const previousGrade = this.scoreToGrade(previousScore)\r\n    const currentGrade = this.scoreToGrade(currentScore)\r\n    return `${previousGrade}  ${currentGrade}`\r\n  }\r\n\r\n  private scoreToGrade(score: number): string {\r\n    if (score >= 80) {return 'A'}\r\n    if (score >= 75) {return 'A-'}\r\n    if (score >= 70) {return 'B+'}\r\n    if (score >= 65) {return 'B'}\r\n    if (score >= 60) {return 'B-'}\r\n    if (score >= 55) {return 'C+'}\r\n    if (score >= 50) {return 'C'}\r\n    if (score >= 45) {return 'C-'}\r\n    return 'E'\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\academic\\PerformanceAnalysisService.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'getStudentPerformanceComparison' has too many lines (86). Maximum allowed is 80.","line":155,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":256,"endColumn":4}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { getDatabase } from '../../database'\n\nexport interface PerformanceImprovement {\n  student_id: number\n  admission_number: string\n  student_name: string\n  previous_term_average: number\n  current_term_average: number\n  improvement_percentage: number\n  improvement_points: number\n  grade_improvement: string\n  subjects_improved: number\n  subjects_declined: number\n  previous_rank?: number\n  current_rank?: number\n  rank_improvement?: number\n}\n\nexport interface SubjectPerformance {\n  subject_id: number\n  subject_name: string\n  current_score: number\n  previous_score: number\n  improvement: number\n  improvement_percentage: number\n  current_grade: string\n  previous_grade: string\n}\n\nexport interface StudentPerformanceSnapshot {\n  student_id: number\n  admission_number: string\n  student_name: string\n  total_improvement: number\n  improvement_percentage: number\n  improvement_level: 'excellent' | 'good' | 'moderate' | 'slight' | 'declined'\n  subjects: SubjectPerformance[]\n}\n\nexport interface PerformanceTrend {\n  term_id: number\n  term_name: string\n  term_number: number\n  average_score: number\n  subject_count: number\n  lowest_score: number\n  highest_score: number\n}\n\nexport interface StrugglingStudent {\n  student_id: number\n  admission_number: string\n  student_name: string\n  total_subjects: number\n  failing_subjects: number\n  average_score: number\n  lowest_score: number\n}\n\nexport class PerformanceAnalysisService {\n  private get db() {\n    return getDatabase()\n  }\n\n  /**\n   * Get most improved students between two terms\n   */\n  async getMostImprovedStudents(options: {\n    academicYearId: number\n    currentTermId: number\n    comparisonTermId: number\n    streamId?: number\n    minimumImprovement?: number\n  }): Promise<PerformanceImprovement[]> {\n    const { academicYearId, currentTermId, comparisonTermId, streamId, minimumImprovement = 5 } = options\n\n    try {\n      let query = `\n        SELECT \n          s.id as student_id,\n          s.admission_number,\n          s.name as student_name,\n          COALESCE(prev.average_marks, 0) as previous_term_average,\n          COALESCE(curr.average_marks, 0) as current_term_average,\n          COALESCE(curr.average_marks - prev.average_marks, 0) as improvement_points\n        FROM student s\n        LEFT JOIN (\n          SELECT student_id, AVG(mean_score) as average_marks\n          FROM report_card_summary rcs\n          JOIN exam e ON rcs.exam_id = e.id\n          WHERE e.term_id = ? AND e.academic_year_id = ?\n          GROUP BY student_id\n        ) prev ON s.id = prev.student_id\n        LEFT JOIN (\n          SELECT student_id, AVG(mean_score) as average_marks\n          FROM report_card_summary rcs\n          JOIN exam e ON rcs.exam_id = e.id\n          WHERE e.term_id = ? AND e.academic_year_id = ?\n          GROUP BY student_id\n        ) curr ON s.id = curr.student_id\n        WHERE s.is_active = 1\n          AND COALESCE(prev.average_marks, 0) > 0\n      `\n\n      const params = [comparisonTermId, academicYearId, currentTermId, academicYearId]\n\n      if (streamId) {\n        query += ` AND s.stream_id = ?`\n        params.push(streamId)\n      }\n\n      query += ` ORDER BY (curr.average_marks - prev.average_marks) DESC`\n\n      interface MostImprovedStudentRaw {\n        student_id: number\n        admission_number: string\n        student_name: string\n        previous_term_average: number // SQLite returns numbers for calculated columns usually, but check parsing\n        current_term_average: number\n        improvement_points: number\n      }\n\n      const results = this.db.prepare(query).all(...params) as MostImprovedStudentRaw[]\n\n      return results\n        .filter(r => r.improvement_points >= minimumImprovement)\n        .map((result) => ({\n          student_id: result.student_id,\n          admission_number: result.admission_number,\n          student_name: result.student_name,\n          previous_term_average: Number(result.previous_term_average),\n          current_term_average: Number(result.current_term_average),\n          improvement_percentage: Number(result.previous_term_average) > 0\n            ? ((Number(result.improvement_points) / Number(result.previous_term_average)) * 100)\n            : 0,\n          improvement_points: Number(result.improvement_points),\n          grade_improvement: this.getGradeImprovement(\n            Number(result.previous_term_average),\n            Number(result.current_term_average)\n          ),\n          subjects_improved: 0, // Will be calculated separately if needed\n          subjects_declined: 0  // Will be calculated separately if needed\n        }))\n    } catch (error) {\n      throw new Error(\n        `Failed to get most improved students: ${error instanceof Error ? error.message : String(error)}`\n      )\n    }\n  }\n\n  /**\n   * Get student performance comparison\n   */\n  async getStudentPerformanceComparison(\n    studentId: number,\n    academicYearId: number,\n    currentTermId: number,\n    comparisonTermId: number\n  ): Promise<StudentPerformanceSnapshot | null> {\n    try {\n      interface StudentRaw {\n        id: number\n        admission_number: string\n        name: string\n      }\n      const student = this.db.prepare('SELECT * FROM student WHERE id = ?').get(studentId) as StudentRaw | undefined\n\n      if (!student) {return null}\n\n      interface CurrentPerformanceRaw {\n        subject_id: number\n        subject_name: string\n        current_score: number\n      }\n\n      // Get current term performance\n      const currentPerformance = this.db.prepare(`\n        SELECT \n          er.subject_id,\n          s.name as subject_name,\n          er.score as current_score\n        FROM exam_result er\n        JOIN subject s ON er.subject_id = s.id\n        JOIN exam e ON er.exam_id = e.id\n        WHERE er.student_id = ?\n          AND e.term_id = ?\n          AND e.academic_year_id = ?\n      `).all(studentId, currentTermId, academicYearId) as CurrentPerformanceRaw[]\n\n      interface ComparisonPerformanceRaw {\n        subject_id: number\n        previous_score: number\n      }\n\n      // Get comparison term performance\n      const comparisonPerformance = this.db.prepare(`\n        SELECT \n          er.subject_id,\n          er.score as previous_score\n        FROM exam_result er\n        JOIN exam e ON er.exam_id = e.id\n        WHERE er.student_id = ?\n          AND e.term_id = ?\n          AND e.academic_year_id = ?\n      `).all(studentId, comparisonTermId, academicYearId) as ComparisonPerformanceRaw[]\n\n      // Map scores\n      const scoreMap = new Map(comparisonPerformance.map(p => [p.subject_id, p.previous_score]))\n\n      // Calculate subject performance\n      const subjects: SubjectPerformance[] = currentPerformance.map(curr => {\n        const previous_score = scoreMap.get(curr.subject_id) || 0\n        const improvement = curr.current_score - previous_score\n\n        return {\n          subject_id: curr.subject_id,\n          subject_name: curr.subject_name,\n          current_score: curr.current_score,\n          previous_score,\n          improvement,\n          improvement_percentage: previous_score > 0 ? ((improvement / previous_score) * 100) : 0,\n          current_grade: this.scoreToGrade(curr.current_score),\n          previous_grade: this.scoreToGrade(previous_score)\n        }\n      })\n\n      // Calculate overall improvement\n      const totalImprovement = subjects.reduce((sum, s) => sum + s.improvement, 0)\n      const _avgImprovement = totalImprovement / subjects.length\n      const improvementPercentage = subjects.length > 0\n        ? subjects.reduce((sum, s) => sum + s.improvement_percentage, 0) / subjects.length\n        : 0\n\n      let improvementLevel: 'excellent' | 'good' | 'moderate' | 'slight' | 'declined'\n      if (improvementPercentage >= 20) {improvementLevel = 'excellent'}\n      else if (improvementPercentage >= 10) {improvementLevel = 'good'}\n      else if (improvementPercentage >= 5) {improvementLevel = 'moderate'}\n      else if (improvementPercentage > 0) {improvementLevel = 'slight'}\n      else {improvementLevel = 'declined'}\n\n      return {\n        student_id: student.id,\n        admission_number: student.admission_number,\n        student_name: student.name,\n        total_improvement: totalImprovement,\n        improvement_percentage: improvementPercentage,\n        improvement_level: improvementLevel,\n        subjects\n      }\n    } catch (error) {\n      throw new Error(\n        `Failed to get performance comparison: ${error instanceof Error ? error.message : String(error)}`\n      )\n    }\n  }\n\n  /**\n   * Identify struggling students\n   */\n  async getStrugglingStudents(\n    academicYearId: number,\n    termId: number,\n    passThreshold: number = 50,\n    streamId?: number\n  ): Promise<StrugglingStudent[]> {\n    try {\n      let query = `\n        SELECT \n          s.id as student_id,\n          s.admission_number,\n          s.name as student_name,\n          COUNT(er.id) as total_subjects,\n          SUM(CASE WHEN er.score < ? THEN 1 ELSE 0 END) as failing_subjects,\n          AVG(er.score) as average_score,\n          MIN(er.score) as lowest_score\n        FROM student s\n        JOIN exam_result er ON s.id = er.student_id\n        JOIN exam e ON er.exam_id = e.id\n        WHERE e.term_id = ?\n          AND e.academic_year_id = ?\n          AND s.is_active = 1\n          AND er.score IS NOT NULL\n        GROUP BY s.id\n        HAVING failing_subjects > 0\n      `\n\n      const params = [passThreshold, termId, academicYearId]\n\n      if (streamId) {\n        query += ` AND s.stream_id = ?`\n        params.push(streamId)\n      }\n\n      query += ` ORDER BY failing_subjects DESC, average_score ASC`\n\n      return this.db.prepare(query).all(...params) as StrugglingStudent[]\n    } catch (error) {\n      throw new Error(\n        `Failed to get struggling students: ${error instanceof Error ? error.message : String(error)}`\n      )\n    }\n  }\n\n  /**\n   * Get performance trends over multiple terms\n   */\n  async getPerformanceTrends(\n    studentId: number,\n    academicYearId: number,\n    numberOfTerms: number = 3\n  ): Promise<PerformanceTrend[]> {\n    try {\n      const trends = this.db.prepare(`\n        SELECT \n          t.id as term_id,\n          t.name as term_name,\n          t.term_number,\n          ROUND(AVG(er.score), 2) as average_score,\n          COUNT(er.id) as subject_count,\n          MIN(er.score) as lowest_score,\n          MAX(er.score) as highest_score\n        FROM term t\n        JOIN exam e ON t.id = e.term_id\n        JOIN exam_result er ON e.id = er.exam_id\n        WHERE e.academic_year_id = ?\n          AND er.student_id = ?\n          AND er.score IS NOT NULL\n        GROUP BY t.id\n        ORDER BY t.term_number DESC\n        LIMIT ?\n      `).all(academicYearId, studentId, numberOfTerms) as PerformanceTrend[]\n\n      return trends\n    } catch (error) {\n      throw new Error(\n        `Failed to get performance trends: ${error instanceof Error ? error.message : String(error)}`\n      )\n    }\n  }\n\n  /**\n   * Private helper methods\n   */\n  private getGradeImprovement(previousScore: number, currentScore: number): string {\n    const previousGrade = this.scoreToGrade(previousScore)\n    const currentGrade = this.scoreToGrade(currentScore)\n    return `${previousGrade}  ${currentGrade}`\n  }\n\n  private scoreToGrade(score: number): string {\n    if (score >= 80) {return 'A'}\n    if (score >= 75) {return 'A-'}\n    if (score >= 70) {return 'B+'}\n    if (score >= 65) {return 'B'}\n    if (score >= 60) {return 'B-'}\n    if (score >= 55) {return 'C+'}\n    if (score >= 50) {return 'C'}\n    if (score >= 45) {return 'C-'}\n    return 'E'\n  }\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\academic\\PromotionService.ts","messages":[{"ruleId":"max-params","severity":1,"message":"Async method 'batchPromote' has too many parameters (7). Maximum allowed is 5.","line":132,"column":5,"nodeType":"FunctionExpression","messageId":"exceed","endLine":132,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\r\nimport { logAudit } from '../../database/utils/audit'\r\n\r\nexport interface Enrollment {\r\n    id: number\r\n    student_id: number\r\n    academic_year_id: number\r\n    term_id: number\r\n    stream_id: number\r\n    class_id: number | null\r\n    student_type: 'DAY_SCHOLAR' | 'BOARDER'\r\n    status: 'ACTIVE' | 'PROMOTED' | 'GRADUATED' | 'TRANSFERRED' | 'DROPPED'\r\n    created_at: string\r\n    // Computed\r\n    student_name?: string\r\n    admission_number?: string\r\n    stream_name?: string\r\n    year_name?: string\r\n}\r\n\r\nexport interface PromotionData {\r\n    student_id: number\r\n    from_stream_id: number\r\n    to_stream_id: number\r\n    from_academic_year_id: number\r\n    to_academic_year_id: number\r\n    to_term_id: number\r\n}\r\n\r\nexport interface Stream {\r\n    id: number\r\n    stream_name: string\r\n    level_order: number\r\n}\r\n\r\nexport class PromotionService {\r\n    private get db() { return getDatabase() }\r\n\r\n    /**\r\n     * Get all streams ordered by grade level for promotion selection\r\n     */\r\n    async getStreams(): Promise<Stream[]> {\r\n        return this.db.prepare(`\r\n      SELECT id, stream_name, level_order \r\n      FROM stream \r\n      WHERE is_active = 1 \r\n      ORDER BY level_order ASC\r\n    `).all() as Stream[]\r\n    }\r\n\r\n    /**\r\n     * Get students eligible for promotion from a specific stream\r\n     */\r\n    async getStudentsForPromotion(streamId: number, academicYearId: number): Promise<Enrollment[]> {\r\n        return this.db.prepare(`\r\n      SELECT \r\n        e.id,\r\n        e.student_id,\r\n        e.stream_id,\r\n        e.academic_year_id,\r\n        e.term_id,\r\n        e.student_type,\r\n        e.status,\r\n        s.first_name || ' ' || s.last_name as student_name,\r\n        s.admission_number,\r\n        st.stream_name,\r\n        ay.year_name\r\n      FROM enrollment e\r\n      JOIN student s ON e.student_id = s.id\r\n      JOIN stream st ON e.stream_id = st.id\r\n      JOIN academic_year ay ON e.academic_year_id = ay.id\r\n      WHERE e.stream_id = ?\r\n        AND e.academic_year_id = ?\r\n        AND e.status = 'ACTIVE'\r\n        AND s.is_active = 1\r\n      ORDER BY s.first_name, s.last_name\r\n    `).all(streamId, academicYearId) as Enrollment[]\r\n    }\r\n\r\n    /**\r\n     * Promote a single student to a new stream/academic year\r\n     */\r\n    async promoteStudent(\r\n        data: PromotionData,\r\n        userId: number\r\n    ): Promise<{ success: boolean; errors?: string[] }> {\r\n        try {\r\n            return this.db.transaction(() => {\r\n                // Mark old enrollment as PROMOTED\r\n                this.db.prepare(`\r\n          UPDATE enrollment \r\n          SET status = 'PROMOTED' \r\n          WHERE student_id = ? \r\n            AND academic_year_id = ? \r\n            AND stream_id = ?\r\n            AND status = 'ACTIVE'\r\n        `).run(data.student_id, data.from_academic_year_id, data.from_stream_id)\n\n                // Create new enrollment\n                const result = this.db.prepare(`\n          INSERT INTO enrollment (student_id, academic_year_id, term_id, academic_term_id, stream_id, student_type, status)\n          SELECT ?, ?, ?, ?, ?, student_type, 'ACTIVE'\n          FROM enrollment \n          WHERE student_id = ? AND academic_year_id = ? AND stream_id = ?\n          LIMIT 1\n        `).run(\n                    data.student_id,\n                    data.to_academic_year_id,\n                    data.to_term_id,\n                    data.to_term_id,\n                    data.to_stream_id,\n                    data.student_id,\n                    data.from_academic_year_id,\n                    data.from_stream_id\n                )\n\r\n                logAudit(userId, 'PROMOTE', 'enrollment', result.lastInsertRowid as number,\r\n                    { from_stream_id: data.from_stream_id, from_academic_year_id: data.from_academic_year_id },\r\n                    { to_stream_id: data.to_stream_id, to_academic_year_id: data.to_academic_year_id }\r\n                )\r\n\r\n                return { success: true }\r\n            })()\r\n        } catch (error) {\r\n            return { success: false, errors: [error instanceof Error ? error.message : 'Unknown error'] }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Batch promote multiple students\r\n     */\r\n    async batchPromote(\r\n        studentIds: number[],\r\n        fromStreamId: number,\r\n        toStreamId: number,\r\n        fromAcademicYearId: number,\r\n        toAcademicYearId: number,\r\n        toTermId: number,\r\n        userId: number\r\n    ): Promise<{ success: boolean; promoted: number; failed: number; errors?: string[] }> {\r\n        let promoted = 0\r\n        let failed = 0\r\n\r\n        for (const studentId of studentIds) {\r\n            const result = await this.promoteStudent({\r\n                student_id: studentId,\r\n                from_stream_id: fromStreamId,\r\n                to_stream_id: toStreamId,\r\n                from_academic_year_id: fromAcademicYearId,\r\n                to_academic_year_id: toAcademicYearId,\r\n                to_term_id: toTermId\r\n            }, userId)\r\n\r\n            if (result.success) {\r\n                promoted++\r\n            } else {\r\n                failed++\r\n            }\r\n        }\r\n\r\n        return {\r\n            success: failed === 0,\r\n            promoted,\r\n            failed,\r\n            errors: failed > 0 ? [`${failed} students failed to promote`] : undefined\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get promotion history for a student\r\n     */\r\n    async getStudentPromotionHistory(studentId: number): Promise<Enrollment[]> {\r\n        return this.db.prepare(`\r\n      SELECT \r\n        e.*,\r\n        st.stream_name,\r\n        ay.year_name\r\n      FROM enrollment e\r\n      JOIN stream st ON e.stream_id = st.id\r\n      JOIN academic_year ay ON e.academic_year_id = ay.id\r\n      WHERE e.student_id = ?\r\n      ORDER BY e.created_at DESC\r\n    `).all(studentId) as Enrollment[]\r\n    }\r\n\r\n    /**\r\n     * Get next stream in grade order (for auto-suggestion)\r\n     */\r\n    async getNextStream(currentStreamId: number): Promise<Stream | null> {\r\n        const current = this.db.prepare(`SELECT level_order FROM stream WHERE id = ?`).get(currentStreamId) as { level_order: number } | null\r\n        if (!current) {return null}\r\n\r\n        return this.db.prepare(`\r\n      SELECT id, stream_name, level_order \r\n      FROM stream \r\n      WHERE level_order > ? AND is_active = 1\r\n      ORDER BY level_order ASC\r\n      LIMIT 1\r\n    `).get(current.level_order) as Stream | null\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\academic\\ReportCardAnalyticsService.ts","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":84,"column":13,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":86,"endColumn":64},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":123,"column":102,"nodeType":"Literal","endLine":123,"endColumn":117},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always falsy.","line":307,"column":11,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":307,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\n\ninterface PerformanceSummary {\n  mean_score: number\n  median_score: number\n  mode_score: number\n  top_performer: string\n  top_performer_score: number\n  total_students: number\n  pass_count: number\n  pass_rate: number\n  fail_count: number\n  fail_rate: number\n}\n\ninterface GradeDistribution {\n  grade: string\n  count: number\n  percentage: number\n}\n\ninterface SubjectPerformance {\n  subject_name: string\n  mean_score: number\n  pass_rate: number\n  difficulty_index: number\n  discrimination_index: number\n}\n\ninterface StrugglingStu {\n  student_id: number\n  student_name: string\n  admission_number: string\n  average_score: number\n  needs_intervention: boolean\n  recommended_action: string\n}\n\ninterface TermComparison {\n  term_name: string\n  mean_score: number\n  pass_rate: number\n  improvement: number\n}\n\nclass ReportCardAnalyticsService {\n  /**\n   * Get performance summary for a class\n   */\n  async getPerformanceSummary(examId: number, streamId: number): Promise<PerformanceSummary> {\n    try {\n      const db = getDatabase()\n\n      // Get all students in stream and their average scores\n      const studentScores = db\n        .prepare(`\n          SELECT \n            s.id,\n            s.first_name || ' ' || s.last_name as student_name,\n            COALESCE(AVG(rcs.marks), 0) as average_score\n          FROM students s\n          LEFT JOIN enrollments e ON s.id = e.student_id AND e.stream_id = ?\n          LEFT JOIN report_card_subject rcs ON s.id = rcs.student_id \n            AND rcs.exam_id = ?\n          WHERE s.deleted_at IS NULL \n            AND e.stream_id = ?\n          GROUP BY s.id, s.first_name, s.last_name\n          ORDER BY average_score DESC\n        `)\n        .all(streamId, examId, streamId) as Array<{\n          id: number\n          student_name: string\n          average_score: number\n        }>\n\n      const totalStudents = studentScores.length\n      const scores = studentScores.map((s) => s.average_score)\n\n      // Calculate statistics\n      const mean = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0\n      const sortedScores = [...scores].sort((a, b) => a - b)\n      const median =\n        sortedScores.length > 0\n          ? sortedScores.length % 2 === 0\n            ? (sortedScores[sortedScores.length / 2 - 1] + sortedScores[sortedScores.length / 2]) / 2\n            : sortedScores[Math.floor(sortedScores.length / 2)]\n          : 0\n\n      // Calculate mode\n      const frequencyMap = new Map<number, number>()\n      scores.forEach((score) => frequencyMap.set(score, (frequencyMap.get(score) || 0) + 1))\n      let mode = 0\n      let maxFreq = 0\n      frequencyMap.forEach((freq, score) => {\n        if (freq > maxFreq) {\n          maxFreq = freq\n          mode = score\n        }\n      })\n\n      // Pass rate (assuming 40% is pass)\n      const passThreshold = 40\n      const passCount = scores.filter((s) => s >= passThreshold).length\n      const failCount = totalStudents - passCount\n\n      // Top performer\n      const topStudent = studentScores[0]\n\n      return {\n        mean_score: mean,\n        median_score: median,\n        mode_score: mode,\n        top_performer: topStudent.student_name || 'N/A',\n        top_performer_score: topStudent.average_score || 0,\n        total_students: totalStudents,\n        pass_count: passCount,\n        pass_rate: totalStudents > 0 ? (passCount / totalStudents) * 100 : 0,\n        fail_count: failCount,\n        fail_rate: totalStudents > 0 ? (failCount / totalStudents) * 100 : 0\n      }\n    } catch (error) {\n      console.error('Error getting performance summary:', error)\n      throw new Error(`Failed to get performance summary: ${error instanceof Error ? error.message : 'Unknown error'}`)\n    }\n  }\n\n  /**\n   * Get grade distribution for a class\n   */\n  async getGradeDistribution(examId: number, streamId: number): Promise<GradeDistribution[]> {\n    try {\n      const db = getDatabase()\n\n      const distribution = db\n        .prepare(`\n          SELECT \n            rcs.grade,\n            COUNT(*) as count\n          FROM report_card_subject rcs\n          JOIN report_card rc ON rcs.report_card_id = rc.id\n          WHERE rc.exam_id = ? \n            AND rc.stream_id = ?\n            AND rcs.grade IS NOT NULL\n          GROUP BY rcs.grade\n          ORDER BY \n            CASE \n              WHEN rcs.grade = 'A' THEN 1\n              WHEN rcs.grade = 'B' THEN 2\n              WHEN rcs.grade = 'C' THEN 3\n              WHEN rcs.grade = 'D' THEN 4\n              WHEN rcs.grade = 'E' THEN 5\n              ELSE 6\n            END\n        `)\n        .all(examId, streamId) as Array<{ grade: string; count: number }>\n\n      // Calculate total\n      const total = distribution.reduce((sum, d) => sum + d.count, 0)\n\n      return distribution.map((d) => ({\n        grade: d.grade,\n        count: d.count,\n        percentage: total > 0 ? (d.count / total) * 100 : 0\n      }))\n    } catch (error) {\n      console.error('Error getting grade distribution:', error)\n      throw new Error(`Failed to get grade distribution: ${error instanceof Error ? error.message : 'Unknown error'}`)\n    }\n  }\n\n  /**\n   * Get subject performance analysis\n   */\n  async getSubjectPerformance(examId: number, streamId: number): Promise<SubjectPerformance[]> {\n    try {\n      const db = getDatabase()\n\n      const subjects = db\n        .prepare(`\n          SELECT DISTINCT sub.id, sub.name\n          FROM subjects sub\n          WHERE sub.deleted_at IS NULL\n          ORDER BY sub.name\n        `)\n        .all() as Array<{ id: number; name: string }>\n\n      const analysis: SubjectPerformance[] = []\n\n      for (const subject of subjects) {\n        const scores = db\n          .prepare(`\n            SELECT rcs.marks\n            FROM report_card_subject rcs\n            JOIN report_card rc ON rcs.report_card_id = rc.id\n            WHERE rc.exam_id = ? \n              AND rc.stream_id = ?\n              AND rcs.subject_id = ?\n              AND rcs.marks IS NOT NULL\n          `)\n          .all(examId, streamId, subject.id) as Array<{ marks: number }>\n\n        if (scores.length > 0) {\n          const marks = scores.map((s) => s.marks)\n          const mean = marks.reduce((a, b) => a + b, 0) / marks.length\n          const passCount = marks.filter((m) => m >= 40).length\n          const passRate = (passCount / marks.length) * 100\n          const difficultyIndex = 100 - mean\n\n          // Discrimination index (top 27% - bottom 27%)\n          const sorted = [...marks].sort((a, b) => b - a)\n          const topCount = Math.ceil(marks.length * 0.27)\n          const topScores = sorted.slice(0, topCount)\n          const bottomScores = sorted.slice(-topCount)\n          const topMean = topScores.reduce((a, b) => a + b, 0) / topCount\n          const bottomMean = bottomScores.reduce((a, b) => a + b, 0) / topCount\n          const discriminationIndex = topMean - bottomMean\n\n          analysis.push({\n            subject_name: subject.name,\n            mean_score: mean,\n            pass_rate: passRate,\n            difficulty_index: difficultyIndex,\n            discrimination_index: discriminationIndex\n          })\n        }\n      }\n\n      return analysis.sort((a, b) => b.mean_score - a.mean_score)\n    } catch (error) {\n      console.error('Error getting subject performance:', error)\n      throw new Error(`Failed to get subject performance: ${error instanceof Error ? error.message : 'Unknown error'}`)\n    }\n  }\n\n  /**\n   * Get struggling students needing intervention\n   */\n  async getStrugglingStu(\n    examId: number,\n    streamId: number,\n    threshold: number = 50\n  ): Promise<StrugglingStu[]> {\n    try {\n      const db = getDatabase()\n\n      const struggling = db\n        .prepare(`\n          SELECT \n            s.id as student_id,\n            s.first_name || ' ' || s.last_name as student_name,\n            s.admission_number,\n            COALESCE(AVG(rcs.marks), 0) as average_score\n          FROM students s\n          LEFT JOIN enrollments e ON s.id = e.student_id AND e.stream_id = ?\n          LEFT JOIN report_card_subject rcs ON s.id = rcs.student_id \n            AND rcs.exam_id = ?\n          WHERE s.deleted_at IS NULL \n            AND e.stream_id = ?\n          GROUP BY s.id\n          HAVING COALESCE(AVG(rcs.marks), 0) < ?\n          ORDER BY average_score ASC\n        `)\n        .all(streamId, examId, streamId, threshold) as Array<{\n          student_id: number\n          student_name: string\n          admission_number: string\n          average_score: number\n        }>\n\n      return struggling.map((s) => {\n        let action = ''\n        if (s.average_score < 20) {\n          action = 'Intensive intervention required'\n        } else if (s.average_score < 35) {\n          action = 'Structured remedial classes'\n        } else if (s.average_score < 50) {\n          action = 'Regular extra coaching'\n        }\n\n        return {\n          student_id: s.student_id,\n          student_name: s.student_name,\n          admission_number: s.admission_number,\n          average_score: s.average_score,\n          needs_intervention: true,\n          recommended_action: action\n        }\n      })\n    } catch (error) {\n      console.error('Error getting struggling students:', error)\n      throw new Error(`Failed to get struggling students: ${error instanceof Error ? error.message : 'Unknown error'}`)\n    }\n  }\n\n  /**\n   * Get term-to-term comparison for improvement tracking\n   */\n  async getTermComparison(examId: number, streamId: number): Promise<TermComparison[]> {\n    try {\n      const db = getDatabase()\n\n      // Get current exam details\n      const currentExam = db\n        .prepare('SELECT academic_year_id, term_id FROM exams WHERE id = ?')\n        .get(examId) as { academic_year_id: number; term_id: number }\n\n      if (!currentExam) {\n        return []\n      }\n\n      // Get previous exams in same academic year and earlier\n      const previousExams = db\n        .prepare(`\n          SELECT id, name, term_id, academic_year_id\n          FROM exams\n          WHERE (academic_year_id < ? OR \n                 (academic_year_id = ? AND term_id < ?))\n          ORDER BY academic_year_id DESC, term_id DESC\n          LIMIT 2\n        `)\n        .all(currentExam.academic_year_id, currentExam.academic_year_id, currentExam.term_id) as Array<{\n        id: number\n        name: string\n        term_id: number\n        academic_year_id: number\n      }>\n\n      const comparison: TermComparison[] = []\n\n      // Add current exam\n      const currentSummary = await this.getPerformanceSummary(examId, streamId)\n      comparison.push({\n        term_name: `Current (Exam ${examId})`,\n        mean_score: currentSummary.mean_score,\n        pass_rate: currentSummary.pass_rate,\n        improvement: 0\n      })\n\n      // Add previous exams\n      let previousMean = currentSummary.mean_score\n      for (const prevExam of previousExams) {\n        const prevSummary = await this.getPerformanceSummary(prevExam.id, streamId)\n        const improvement = prevSummary.mean_score > 0 ? previousMean - prevSummary.mean_score : 0\n\n        comparison.push({\n          term_name: prevExam.name,\n          mean_score: prevSummary.mean_score,\n          pass_rate: prevSummary.pass_rate,\n          improvement\n        })\n\n        previousMean = prevSummary.mean_score\n      }\n\n      return comparison\n    } catch (error) {\n      console.error('Error getting term comparison:', error)\n      throw new Error(`Failed to get term comparison: ${error instanceof Error ? error.message : 'Unknown error'}`)\n    }\n  }\n}\n\nexport default new ReportCardAnalyticsService()\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\academic\\ReportCardService.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'generateReportCard' has too many lines (92). Maximum allowed is 80.","line":118,"column":5,"nodeType":"MethodDefinition","messageId":"exceed","endLine":236,"endColumn":6},{"ruleId":"complexity","severity":1,"message":"Async method 'generateReportCard' has a complexity of 19. Maximum allowed is 12.","line":118,"column":5,"nodeType":"FunctionExpression","messageId":"complex","endLine":118,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AttendanceService } from './AttendanceService'\nimport { getDatabase } from '../../database'\n\nexport interface Subject {\n    id: number\n    subject_name: string\n    subject_code: string\n}\n\nexport interface Grade {\n    student_id: number\n    subject_id: number\n    exam_type: 'CAT1' | 'CAT2' | 'MIDTERM' | 'FINAL'\n    score: number\n    max_score: number\n    term_id: number\n    academic_year_id: number\n}\n\nexport interface ReportCardData {\n    student: {\n        id: number\n        admission_number: string\n        first_name: string\n        last_name: string\n        stream_name: string\n    }\n    academic_year: string\n    term: string\n    grades: {\n        subject_name: string\n        subject_code: string\n        cat1: number | null\n        cat2: number | null\n        midterm: number | null\n        final_exam: number | null\n        average: number\n        grade_letter: string\n        remarks: string\n    }[]\n    attendance: {\n        total_days: number\n        present: number\n        absent: number\n        attendance_rate: number\n    }\n    summary: {\n        total_marks: number\n        average: number\n        grade: string\n        position: number | null\n        class_size: number\n        teacher_remarks: string\n        principal_remarks: string\n    }\n}\n\ninterface StudentInfoResult {\n  id: number;\n  admission_number: string;\n  first_name: string;\n  last_name: string;\n  stream_name: string | null;\n}\n\ninterface GradingScaleRow {\n  grade: string;\n  remarks: string;\n  min_score: number;\n  max_score: number;\n}\n\ninterface ExamResultRow {\n  score: number | null;\n  competency_level: number;\n  weight: number;\n}\n\ninterface ReportCardSummaryRow {\n  total_marks: number;\n  mean_score: number;\n  mean_grade: string;\n  class_position: number;\n  class_teacher_remarks: string;\n  principal_remarks: string;\n}\n\nexport class ReportCardService {\n    private get db() { return getDatabase() }\n    private attendanceService = new AttendanceService()\n\n    /**\n     * Get all subjects\n     */\n    async getSubjects(): Promise<Subject[]> {\n        return this.db.prepare(`\n      SELECT id, subject_name, subject_code FROM subject WHERE is_active = 1 ORDER BY subject_name\n    `).all() as Subject[]\n    }\n\n    /**\n     * Get grades for a student in a term\n     */\n    async getStudentGrades(\n        studentId: number,\n        academicYearId: number,\n        termId: number\n    ): Promise<Grade[]> {\n        return this.db.prepare(`\n      SELECT * FROM grade \n      WHERE student_id = ? AND academic_year_id = ? AND term_id = ?\n    `).all(studentId, academicYearId, termId) as Grade[]\n    }\n\n    /**\n     * Generate a complete report card for a student\n     */\n    async generateReportCard(\n        studentId: number,\n        academicYearId: number,\n        termId: number\n    ): Promise<ReportCardData | null> {\n        // Get student info\n        const student = this.db.prepare(`\n      SELECT s.id, s.admission_number, s.first_name, s.last_name, st.stream_name\n      FROM student s\n      LEFT JOIN enrollment e ON s.id = e.student_id AND e.academic_year_id = ? AND e.term_id = ?\n      LEFT JOIN stream st ON e.stream_id = st.id\n      WHERE s.id = ?\n    `).get(academicYearId, termId, studentId) as StudentInfoResult | undefined\n\n        if (!student) {return null}\n\n        // Get academic year and term info\n        const yearInfo = this.db.prepare(`SELECT year_name FROM academic_year WHERE id = ?`).get(academicYearId) as { year_name: string }\n        const termInfo = this.db.prepare(`SELECT term_name FROM term WHERE id = ?`).get(termId) as { term_name: string }\n\n        // Get all subjects\n        const subjects = await this.getSubjects()\n\n        // Get all grades for this student\n        const _grades = await this.getStudentGrades(studentId, academicYearId, termId)\n\n        // Fetch dynamic grading scale for curriculum (Defaulting to 8-4-4 for now, can be refined per student level)\n        const gradingScale = this.db.prepare('SELECT * FROM grading_scale WHERE curriculum = ?').all('8-4-4') as GradingScaleRow[]\n        const getDynamicGrade = (score: number) => {\n            const row = gradingScale.find(gs => score >= gs.min_score && score <= gs.max_score)\n            return { grade: row?.grade || 'F', remarks: row?.remarks || 'Poor' }\n        }\n\n        // Build grade rows\n        const gradeRows = subjects.map(subject => {\n            // Updated to use the new exam_result table\n            const results = this.db.prepare(`\n                SELECT er.score, er.competency_level, e.weight\n                FROM exam_result er\n                JOIN exam e ON er.exam_id = e.id\n                WHERE er.student_id = ? AND er.subject_id = ? AND e.term_id = ?\n            `).all(studentId, subject.id, termId) as ExamResultRow[]\n\n            if (results.length === 0) {return null}\n\n            // Calculate weighted average\n            let totalWeight = 0\n            let weightedSum = 0\n            results.forEach(r => {\n                const score = r.score !== null ? r.score : (r.competency_level * 25)\n                weightedSum += score * r.weight\n                totalWeight += r.weight\n            })\n\n            const average = totalWeight > 0 ? weightedSum / totalWeight : 0\n            const { grade, remarks } = getDynamicGrade(average)\n\n            return {\n                subject_name: subject.subject_name,\n                subject_code: subject.subject_code,\n                cat1: null,\n                cat2: null,\n                midterm: null,\n                final_exam: null,\n                average: Math.round(average * 10) / 10,\n                grade_letter: grade,\n                remarks\n            }\n        }).filter(g => g !== null) as ReportCardData['grades']\n\n        // Get attendance\n        const attendance = await this.attendanceService.getStudentAttendanceSummary(studentId, academicYearId, termId)\n\n        // Calculate fallbacks if summary doesn't exist\n        const totalMarks = gradeRows.reduce((sum, g) => sum + g.average, 0)\n        const overallAverage = gradeRows.length > 0 ? totalMarks / gradeRows.length : 0\n\n        // Fetch overall summary (position, total)\n        const summary = this.db.prepare(`\n            SELECT * FROM report_card_summary \n            WHERE student_id = ? AND exam_id IN (SELECT id FROM exam WHERE term_id = ?)\n            ORDER BY id DESC LIMIT 1\n        `).get(studentId, termId) as ReportCardSummaryRow | undefined\n\n        // Calculate class size\n        const { count: classSize } = this.db.prepare(`\n            SELECT COUNT(*) as count FROM enrollment \n            WHERE stream_id = (SELECT stream_id FROM enrollment WHERE student_id = ? AND academic_year_id = ? AND term_id = ?)\n            AND academic_year_id = ? AND term_id = ? AND status = 'ACTIVE'\n        `).get(studentId, academicYearId, termId, academicYearId, termId) as { count: number }\n\n        return {\n            student: {\n                id: student.id,\n                admission_number: student.admission_number,\n                first_name: student.first_name,\n                last_name: student.last_name,\n                stream_name: student.stream_name || 'N/A'\n            },\n            academic_year: yearInfo.year_name || '',\n            term: termInfo.term_name || '',\n            grades: gradeRows,\n            attendance: {\n                total_days: attendance.total_days,\n                present: attendance.present,\n                absent: attendance.absent,\n                attendance_rate: attendance.attendance_rate\n            },\n            summary: {\n                total_marks: summary?.total_marks || Math.round(totalMarks * 10) / 10,\n                average: summary?.mean_score || Math.round(overallAverage * 10) / 10,\n                grade: summary?.mean_grade || getDynamicGrade(overallAverage).grade,\n                position: summary?.class_position || null,\n                class_size: classSize || 0,\n                teacher_remarks: summary?.class_teacher_remarks || this.getOverallRemarks(overallAverage),\n                principal_remarks: summary?.principal_remarks || ''\n            }\n        }\n    }\n\n    /**\n     * Get students in a class for batch report card generation\n     */\n    async getStudentsForReportCards(\n        streamId: number,\n        academicYearId: number,\n        termId: number\n    ): Promise<{ student_id: number; student_name: string; admission_number: string }[]> {\n        return this.db.prepare(`\n      SELECT \n        e.student_id,\n        s.first_name || ' ' || s.last_name as student_name,\n        s.admission_number\n      FROM enrollment e\n      JOIN student s ON e.student_id = s.id\n      WHERE e.stream_id = ?\n        AND e.academic_year_id = ?\n        AND e.term_id = ?\n        AND e.status = 'ACTIVE'\n      ORDER BY s.first_name, s.last_name\n    `).all(streamId, academicYearId, termId) as { student_id: number; student_name: string; admission_number: string }[]\n    }\n\n    private getOverallRemarks(average: number): string {\n        if (average >= 80) {return 'Outstanding performance. Keep up the excellent work!'}\n        if (average >= 70) {return 'Very good performance. Continue working hard.'}\n        if (average >= 60) {return 'Good effort. There is room for improvement.'}\n        if (average >= 50) {return 'Fair performance. More effort needed.'}\n        return 'Needs significant improvement. Please seek additional support.'\n    }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\academic\\StudentService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\academic\\__tests__\\ExamSchedulerService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\accounting\\BudgetEnforcementService.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'validateTransaction' has too many lines (81). Maximum allowed is 80.","line":141,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":237,"endColumn":4}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database';\nimport { logAudit } from '../../database/utils/audit';\nimport { centsToShillings } from '../../utils/money';\n\r\n/**\r\n * BudgetEnforcementService\r\n * \r\n * Enforces budget limits and provides budget tracking functionality.\r\n * Prevents overspending and alerts managers when budgets are exceeded.\r\n * \r\n * Key Functions:\r\n * 1. Validate transactions against budget limits\r\n * 2. Track budget utilization by GL account\r\n * 3. Generate budget variance reports\r\n * 4. Alert on budget overruns\r\n * 5. Support departmental budget allocations\r\n */\r\n\r\nexport interface BudgetAllocation {\r\n  id?: number;\r\n  gl_account_code: string;\r\n  account_name?: string;\r\n  department?: string;\r\n  fiscal_year: number;\r\n  allocated_amount: number;\r\n  spent_amount?: number;\r\n  remaining_amount?: number;\r\n  utilization_percentage?: number;\r\n  is_active: boolean;\r\n}\r\n\r\nexport interface BudgetValidationResult {\r\n  is_allowed: boolean;\r\n  message: string;\r\n  budget_status?: {\r\n    allocated: number;\r\n    spent: number;\r\n    remaining: number;\r\n    utilization_percentage: number;\r\n    after_transaction: {\r\n      spent: number;\r\n      remaining: number;\r\n      utilization_percentage: number;\r\n    };\r\n  };\r\n}\r\n\r\nexport interface BudgetVarianceReport {\r\n  fiscal_year: number;\r\n  report_date: string;\r\n  items: Array<{\r\n    gl_account_code: string;\r\n    account_name: string;\r\n    department: string | null;\r\n    allocated: number;\r\n    spent: number;\r\n    remaining: number;\r\n    variance: number;\r\n    variance_percentage: number;\r\n    status: 'UNDER_BUDGET' | 'ON_BUDGET' | 'OVER_BUDGET';\r\n  }>;\r\n  summary: {\r\n    total_allocated: number;\r\n    total_spent: number;\r\n    total_remaining: number;\r\n    overall_utilization_percentage: number;\r\n  };\r\n}\r\n\r\nexport class BudgetEnforcementService {\r\n  private db = getDatabase();\r\n\r\n  /**\r\n   * Create or update budget allocation\r\n   */\r\n  async setBudgetAllocation(\r\n    glAccountCode: string,\r\n    fiscalYear: number,\r\n    allocatedAmount: number,\r\n    department: string | null,\r\n    userId: number\r\n  ): Promise<{ success: boolean; message: string; allocationId?: number }> {\r\n    try {\r\n      // Check if allocation already exists\r\n      const existing = this.db.prepare(`\r\n        SELECT id FROM budget_allocation\r\n        WHERE gl_account_code = ? AND fiscal_year = ? AND department = ?\r\n      `).get(glAccountCode, fiscalYear, department) as { id: number } | undefined;\r\n\r\n      if (existing) {\r\n        // Update existing\r\n        this.db.prepare(`\r\n          UPDATE budget_allocation\r\n          SET allocated_amount = ?, updated_at = CURRENT_TIMESTAMP\r\n          WHERE id = ?\r\n        `).run(allocatedAmount, existing.id);\r\n\r\n        logAudit(userId, 'UPDATE', 'budget_allocation', existing.id, null, {\r\n          allocated_amount: allocatedAmount,\r\n        });\r\n\r\n        return {\r\n          success: true,\r\n          message: 'Budget allocation updated successfully.',\r\n          allocationId: existing.id,\r\n        };\r\n      } else {\r\n        // Create new\r\n        const result = this.db.prepare(`\r\n          INSERT INTO budget_allocation (\r\n            gl_account_code, fiscal_year, allocated_amount, department, is_active\r\n          ) VALUES (?, ?, ?, ?, 1)\r\n        `).run(glAccountCode, fiscalYear, allocatedAmount, department);\r\n\r\n        const allocationId = result.lastInsertRowid as number;\r\n\r\n        logAudit(userId, 'CREATE', 'budget_allocation', allocationId, null, {\r\n          gl_account_code: glAccountCode,\r\n          fiscal_year: fiscalYear,\r\n          allocated_amount: allocatedAmount,\r\n          department,\r\n        });\r\n\r\n        return {\r\n          success: true,\r\n          message: 'Budget allocation created successfully.',\r\n          allocationId,\r\n        };\r\n      }\r\n    } catch (error: unknown) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to set budget allocation: ${error.message}`,\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate if a transaction is within budget\r\n   */\r\n  async validateTransaction(\r\n    glAccountCode: string,\r\n    amount: number,\r\n    fiscalYear: number,\r\n    department: string | null = null\r\n  ): Promise<BudgetValidationResult> {\r\n    try {\r\n      // Get budget allocation\r\n      const allocation = this.db.prepare(`\r\n        SELECT ba.id, ba.gl_account_code, ba.allocated_amount, ga.account_name,\r\n               ba.department\r\n        FROM budget_allocation ba\r\n        JOIN gl_account ga ON ga.account_code = ba.gl_account_code\r\n        WHERE ba.gl_account_code = ?\r\n          AND ba.fiscal_year = ?\r\n          AND (ba.department = ? OR (ba.department IS NULL AND ? IS NULL))\r\n          AND ba.is_active = 1\r\n      `).get(glAccountCode, fiscalYear, department, department) as {\r\n        id: number;\r\n        gl_account_code: string;\r\n        allocated_amount: number;\r\n        account_name: string;\r\n        department: string | null;\r\n      } | undefined;\r\n\r\n      // If no budget allocation, allow transaction (no budget set)\r\n      if (!allocation) {\r\n        return {\r\n          is_allowed: true,\r\n          message: 'No budget allocation found. Transaction allowed.',\r\n        };\r\n      }\r\n\r\n      // Calculate current spending\r\n      const spent = this.calculateSpentAmount(glAccountCode, fiscalYear, department);\r\n      const remaining = allocation.allocated_amount - spent;\r\n      const utilizationPercentage = (spent / allocation.allocated_amount) * 100;\r\n\r\n      // Calculate what would happen after transaction\r\n      const afterSpent = spent + amount;\r\n      const afterRemaining = allocation.allocated_amount - afterSpent;\r\n      const afterUtilization = (afterSpent / allocation.allocated_amount) * 100;\r\n\r\n      const budget_status = {\n        allocated: allocation.allocated_amount,\n        spent,\n        remaining,\n        utilization_percentage: utilizationPercentage,\n        after_transaction: {\n          spent: afterSpent,\n          remaining: afterRemaining,\n          utilization_percentage: afterUtilization,\n        },\n      };\n\r\n      // Check if transaction exceeds budget\r\n      if (afterSpent > allocation.allocated_amount) {\r\n        const overrun = afterSpent - allocation.allocated_amount;\n        return {\n          is_allowed: false,\n          message: `Transaction would exceed budget by Kes ${centsToShillings(overrun).toFixed(2)}. Budget: Kes ${centsToShillings(allocation.allocated_amount).toFixed(2)}, Spent: Kes ${centsToShillings(spent).toFixed(2)}, Requested: Kes ${centsToShillings(amount).toFixed(2)}.`,\n          budget_status,\n        };\n      }\n\r\n      // Warn if exceeding 90% utilization\r\n      if (afterUtilization >= 90 && utilizationPercentage < 90) {\r\n        return {\r\n          is_allowed: true,\r\n          message: `Warning: Transaction will push budget utilization to ${afterUtilization.toFixed(1)}%. Consider requesting additional budget allocation.`,\r\n          budget_status,\r\n        };\r\n      }\r\n\r\n      // Warn if exceeding 80% utilization\r\n      if (afterUtilization >= 80 && utilizationPercentage < 80) {\r\n        return {\r\n          is_allowed: true,\r\n          message: `Notice: Transaction will push budget utilization to ${afterUtilization.toFixed(1)}%. Budget is ${(100 - afterUtilization).toFixed(1)}% remaining.`,\r\n          budget_status,\r\n        };\r\n      }\r\n\r\n      return {\r\n        is_allowed: true,\r\n        message: 'Transaction is within budget.',\r\n        budget_status,\r\n      };\r\n    } catch (error: unknown) {\r\n      // On error, allow transaction but log the issue\r\n      console.error('Budget validation error:', error);\r\n      return {\r\n        is_allowed: true,\r\n        message: `Budget validation failed: ${error.message}. Transaction allowed.`,\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calculate spent amount for a budget allocation\r\n   */\r\n  private calculateSpentAmount(\r\n    glAccountCode: string,\r\n    fiscalYear: number,\r\n    department: string | null\r\n  ): number {\r\n    // Get fiscal year start/end dates\r\n    const fiscalYearStart = `${fiscalYear}-01-01`;\r\n    const fiscalYearEnd = `${fiscalYear}-12-31`;\r\n\r\n    // Sum debit amounts for expense accounts (spending)\r\n    const result = this.db.prepare(`\r\n      SELECT COALESCE(SUM(jel.debit_amount), 0) as spent\r\n      FROM journal_entry_line jel\r\n      JOIN journal_entry je ON je.id = jel.journal_entry_id\r\n      WHERE jel.gl_account_code = ?\r\n        AND je.entry_date BETWEEN ? AND ?\r\n        AND je.status = 'POSTED'\r\n        AND (jel.department = ? OR (jel.department IS NULL AND ? IS NULL))\r\n    `).get(glAccountCode, fiscalYearStart, fiscalYearEnd, department, department) as {\r\n      spent: number;\r\n    } | undefined;\r\n\r\n    return result?.spent || 0;\r\n  }\r\n\r\n  /**\r\n   * Get all budget allocations for a fiscal year\r\n   */\r\n  async getBudgetAllocations(fiscalYear: number): Promise<BudgetAllocation[]> {\r\n    try {\r\n      const allocations = this.db.prepare(`\r\n        SELECT ba.id, ba.gl_account_code, ga.account_name, ba.department,\r\n               ba.fiscal_year, ba.allocated_amount, ba.is_active\r\n        FROM budget_allocation ba\r\n        JOIN gl_account ga ON ga.account_code = ba.gl_account_code\r\n        WHERE ba.fiscal_year = ?\r\n        ORDER BY ba.gl_account_code, ba.department\r\n      `).all(fiscalYear) as Array<{\r\n        id: number;\r\n        gl_account_code: string;\r\n        account_name: string;\r\n        department: string | null;\r\n        fiscal_year: number;\r\n        allocated_amount: number;\r\n        is_active: number;\r\n      }>;\r\n\r\n      return allocations.map(a => {\r\n        const spent = this.calculateSpentAmount(a.gl_account_code, a.fiscal_year, a.department);\r\n        const remaining = a.allocated_amount - spent;\r\n        const utilization = (spent / a.allocated_amount) * 100;\r\n\r\n        return {\n          id: a.id,\n          gl_account_code: a.gl_account_code,\n          account_name: a.account_name,\n          department: a.department || undefined,\n          fiscal_year: a.fiscal_year,\n          allocated_amount: a.allocated_amount,\n          spent_amount: spent,\n          remaining_amount: remaining,\n          utilization_percentage: utilization,\n          is_active: a.is_active === 1,\n        };\n      });\n    } catch (error: unknown) {\r\n      console.error('Failed to fetch budget allocations:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate budget variance report\r\n   */\r\n  async generateBudgetVarianceReport(fiscalYear: number): Promise<BudgetVarianceReport> {\r\n    const allocations = await this.getBudgetAllocations(fiscalYear);\r\n\r\n    const items = allocations.map(a => {\r\n      const variance = a.allocated_amount - (a.spent_amount || 0);\n      const variancePercentage = a.allocated_amount\n        ? ((a.spent_amount || 0) / a.allocated_amount) * 100 - 100\n        : 0;\n\r\n      let status: 'UNDER_BUDGET' | 'ON_BUDGET' | 'OVER_BUDGET';\r\n      if ((a.spent_amount || 0) > a.allocated_amount) {\r\n        status = 'OVER_BUDGET';\r\n      } else if ((a.utilization_percentage || 0) >= 95) {\r\n        status = 'ON_BUDGET';\r\n      } else {\r\n        status = 'UNDER_BUDGET';\r\n      }\r\n\r\n      return {\r\n        gl_account_code: a.gl_account_code,\r\n        account_name: a.account_name || '',\r\n        department: a.department || null,\r\n        allocated: a.allocated_amount,\r\n        spent: a.spent_amount || 0,\r\n        remaining: a.remaining_amount || 0,\r\n        variance,\n        variance_percentage: variancePercentage,\r\n        status,\r\n      };\r\n    });\r\n\r\n    const summary = {\r\n      total_allocated: items.reduce((sum, i) => sum + i.allocated, 0),\r\n      total_spent: items.reduce((sum, i) => sum + i.spent, 0),\r\n      total_remaining: items.reduce((sum, i) => sum + i.remaining, 0),\r\n      overall_utilization_percentage: 0,\r\n    };\r\n\r\n    summary.overall_utilization_percentage = \r\n      (summary.total_spent / summary.total_allocated) * 100;\r\n\r\n    return {\r\n      fiscal_year: fiscalYear,\r\n      report_date: new Date().toISOString(),\r\n      items,\r\n      summary,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get budget alerts (accounts near or over budget)\r\n   */\r\n  async getBudgetAlerts(fiscalYear: number, thresholdPercentage: number = 80): Promise<Array<{\r\n    gl_account_code: string;\r\n    account_name: string;\r\n    department: string | null;\r\n    allocated: number;\r\n    spent: number;\r\n    utilization_percentage: number;\r\n    alert_type: 'WARNING' | 'CRITICAL' | 'EXCEEDED';\r\n  }>> {\r\n    const allocations = await this.getBudgetAllocations(fiscalYear);\r\n\r\n    return allocations\r\n      .filter(a => (a.utilization_percentage || 0) >= thresholdPercentage)\r\n      .map(a => {\r\n        let alert_type: 'WARNING' | 'CRITICAL' | 'EXCEEDED';\r\n        if ((a.utilization_percentage || 0) >= 100) {\r\n          alert_type = 'EXCEEDED';\r\n        } else if ((a.utilization_percentage || 0) >= 90) {\r\n          alert_type = 'CRITICAL';\r\n        } else {\r\n          alert_type = 'WARNING';\r\n        }\r\n\r\n        return {\r\n          gl_account_code: a.gl_account_code,\r\n          account_name: a.account_name || '',\r\n          department: a.department || null,\r\n          allocated: a.allocated_amount,\r\n          spent: a.spent_amount || 0,\r\n          utilization_percentage: a.utilization_percentage || 0,\r\n          alert_type,\r\n        };\r\n      })\r\n      .sort((a, b) => b.utilization_percentage - a.utilization_percentage);\r\n  }\r\n\r\n  /**\r\n   * Deactivate budget allocation\r\n   */\r\n  async deactivateBudgetAllocation(allocationId: number, userId: number): Promise<void> {\r\n    this.db.prepare(`\r\n      UPDATE budget_allocation\r\n      SET is_active = 0, updated_at = CURRENT_TIMESTAMP\r\n      WHERE id = ?\r\n    `).run(allocationId);\r\n\r\n    logAudit(userId, 'UPDATE', 'budget_allocation', allocationId, null, {\r\n      is_active: false,\r\n    });\r\n  }\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\accounting\\DataMigrationService.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'migrateHistoricalTransactions' has too many lines (107). Maximum allowed is 80.","line":57,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":181,"endColumn":4},{"ruleId":"complexity","severity":1,"message":"Async method 'migrateHistoricalTransactions' has a complexity of 19. Maximum allowed is 12.","line":57,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":57,"endColumn":38},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 30 to the 18 allowed.","line":57,"column":9,"nodeType":null,"messageId":"refactorFunction","endLine":57,"endColumn":38},{"ruleId":"max-depth","severity":1,"message":"Blocks are nested too deeply (5). Maximum allowed is 4.","line":130,"column":13,"nodeType":"IfStatement","messageId":"tooDeeply","endLine":142,"endColumn":14},{"ruleId":"complexity","severity":1,"message":"Method 'determineGLAccounts' has a complexity of 18. Maximum allowed is 12.","line":278,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":278,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { DoubleEntryJournalService, type JournalEntryData } from './DoubleEntryJournalService';\r\nimport { getDatabase } from '../../database';\r\nimport { logAudit } from '../../database/utils/audit';\n\r\nimport type Database from 'better-sqlite3';\n\r\n/**\r\n * Data Migration Service\r\n * \r\n * Migrates historical transactions from old single-entry system\r\n * to new double-entry journal system.\r\n */\r\n\r\nexport interface MigrationResult {\r\n  success: boolean;\r\n  message: string;\r\n  migrated_count?: number;\r\n  failed_count?: number;\r\n  errors?: string[];\r\n}\r\n\r\nexport interface MigrationStats {\r\n  total_transactions: number;\r\n  migrated: number;\r\n  failed: number;\r\n  skipped: number;\r\n  total_amount_migrated: number;\r\n}\r\n\r\ninterface LegacyTransaction {\r\n  id: number;\r\n  student_id: number | null;\r\n  transaction_date: string;\r\n  transaction_type: string;\r\n  amount: number;\r\n  debit_credit: 'DEBIT' | 'CREDIT';\r\n  description: string | null;\r\n  is_migrated: number | null;\r\n  student_name: string | null;\r\n  admission_number: string | null;\r\n}\r\n\r\nexport class DataMigrationService {\r\n  private db: Database.Database;\r\n  private journalService: DoubleEntryJournalService;\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase();\r\n    this.journalService = new DoubleEntryJournalService(this.db);\r\n  }\r\n\r\n  /**\r\n   * Migrate all historical ledger transactions\r\n   * Dry run mode available for testing\r\n   */\r\n  async migrateHistoricalTransactions(\r\n    dryRun = false,\r\n    userId: number\r\n  ): Promise<MigrationResult> {\r\n    try {\r\n      // Get unmigrated transactions\r\n      const transactions = this.db.prepare(`\r\n        SELECT\r\n          lt.*,\r\n          s.first_name || ' ' || s.last_name as student_name,\r\n          s.admission_number\r\n        FROM ledger_transaction lt\r\n        LEFT JOIN student s ON lt.student_id = s.id\r\n        WHERE lt.is_migrated IS NULL OR lt.is_migrated = 0\r\n        ORDER BY lt.transaction_date, lt.id\r\n      `).all() as LegacyTransaction[];\r\n\r\n      if (transactions.length === 0) {\r\n        return {\r\n          success: true,\r\n          message: 'No transactions to migrate',\r\n          migrated_count: 0\r\n        };\r\n      }\r\n\r\n      let migratedCount = 0;\r\n      let failedCount = 0;\r\n      const errors: string[] = [];\r\n\r\n      if (!dryRun) {\r\n        // Add is_migrated column if it doesn't exist\r\n        try {\r\n          this.db.exec(`ALTER TABLE ledger_transaction ADD COLUMN is_migrated INTEGER DEFAULT 0`);\r\n        } catch {\r\n          // Column may already exist\r\n        }\r\n      }\r\n\r\n      for (const transaction of transactions) {\r\n        try {\r\n          if (dryRun) {\r\n            // Just validate, don't actually create entries\r\n            console.error(`[DRY RUN] Would migrate transaction ${transaction.id}`);\r\n            migratedCount++;\r\n          } else {\r\n            // Determine GL accounts based on transaction type and description\r\n            const { debitAccount, creditAccount } = this.determineGLAccounts(transaction);\r\n\r\n            // Create journal entry\r\n            const journalData: JournalEntryData = {\r\n              entry_date: transaction.transaction_date,\r\n              entry_type: this.mapTransactionType(transaction.transaction_type),\r\n              description: transaction.description || `Migrated: ${transaction.transaction_type}`,\r\n              student_id: transaction.student_id || undefined,\r\n              created_by_user_id: userId,\r\n              lines: [\r\n                {\r\n                  gl_account_code: debitAccount,\r\n                  debit_amount: transaction.debit_credit === 'DEBIT' ? transaction.amount : 0,\r\n                  credit_amount: transaction.debit_credit === 'CREDIT' ? transaction.amount : 0,\r\n                  description: 'Migrated from legacy system'\r\n                },\r\n                {\r\n                  gl_account_code: creditAccount,\r\n                  debit_amount: transaction.debit_credit === 'CREDIT' ? transaction.amount : 0,\r\n                  credit_amount: transaction.debit_credit === 'DEBIT' ? transaction.amount : 0,\r\n                  description: 'Migrated from legacy system'\r\n                }\r\n              ]\r\n            };\r\n\r\n            const result = await this.journalService.createJournalEntry(journalData);\r\n\r\n            if (result.success) {\r\n              // Mark as migrated\r\n              this.db.prepare(`\r\n                UPDATE ledger_transaction\r\n                SET is_migrated = 1, migrated_journal_entry_id = ?\r\n                WHERE id = ?\r\n              `).run(result.entry_id, transaction.id);\r\n\r\n              migratedCount++;\r\n            } else {\r\n              failedCount++;\r\n              errors.push(`Transaction ${transaction.id}: ${result.message}`);\r\n            }\r\n          }\r\n        } catch (error) {\r\n          failedCount++;\r\n          errors.push(`Transaction ${transaction.id}: ${(error as Error).message}`);\r\n        }\r\n      }\r\n\r\n      // Audit log\r\n      if (!dryRun) {\r\n        logAudit(\r\n          userId,\r\n          'MIGRATE',\r\n          'ledger_transaction',\r\n          null,\r\n          null,\r\n          {\r\n            migrated_count: migratedCount,\r\n            failed_count: failedCount,\r\n            dry_run: dryRun\r\n          }\r\n        );\r\n      }\r\n\r\n      return {\r\n        success: failedCount === 0,\r\n        message: dryRun\r\n          ? `Dry run complete: ${migratedCount} transactions would be migrated`\r\n          : `Migration complete: ${migratedCount} migrated, ${failedCount} failed`,\r\n        migrated_count: migratedCount,\r\n        failed_count: failedCount,\r\n        errors: errors.length > 0 ? errors : undefined\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Migration failed: ${(error as Error).message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate migration accuracy\r\n   * Compares old totals with new journal entry totals\r\n   */\r\n  async validateMigration(): Promise<{\r\n    success: boolean;\r\n    message: string;\r\n    old_total_debits: number;\r\n    old_total_credits: number;\r\n    new_total_debits: number;\r\n    new_total_credits: number;\r\n    variance: number;\r\n  }> {\r\n    try {\r\n      // Get totals from old system\r\n      const oldTotals = this.db.prepare(`\r\n        SELECT\r\n          SUM(CASE WHEN debit_credit = 'DEBIT' THEN amount ELSE 0 END) as total_debits,\r\n          SUM(CASE WHEN debit_credit = 'CREDIT' THEN amount ELSE 0 END) as total_credits\r\n        FROM ledger_transaction\r\n        WHERE is_migrated = 1\r\n      `).get() as { total_debits: number; total_credits: number };\r\n\r\n      // Get totals from new system (migrated entries only)\r\n      const newTotals = this.db.prepare(`\r\n        SELECT\r\n          SUM(jel.debit_amount) as total_debits,\r\n          SUM(jel.credit_amount) as total_credits\r\n        FROM journal_entry je\r\n        JOIN journal_entry_line jel ON je.id = jel.journal_entry_id\r\n        WHERE je.entry_type LIKE '%MIGRATED%' OR je.description LIKE '%Migrated%'\r\n      `).get() as { total_debits: number; total_credits: number };\r\n\r\n      const variance = Math.abs(\r\n        (oldTotals.total_debits + oldTotals.total_credits) -\r\n        (newTotals.total_debits + newTotals.total_credits)\r\n      );\r\n\r\n      const isValid = variance < 100; // Allow 1 Kes variance due to rounding\r\n\r\n      return {\r\n        success: isValid,\r\n        message: isValid\r\n          ? 'Migration validation passed: Totals match'\r\n          : `Migration validation failed: Variance of ${variance} cents detected`,\r\n        old_total_debits: oldTotals.total_debits || 0,\r\n        old_total_credits: oldTotals.total_credits || 0,\r\n        new_total_debits: newTotals.total_debits || 0,\r\n        new_total_credits: newTotals.total_credits || 0,\r\n        variance\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Validation failed: ${(error as Error).message}`,\r\n        old_total_debits: 0,\r\n        old_total_credits: 0,\r\n        new_total_debits: 0,\r\n        new_total_credits: 0,\r\n        variance: 0\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get migration statistics\r\n   */\r\n  async getMigrationStats(): Promise<MigrationStats> {\r\n    const stats = this.db.prepare(`\r\n      SELECT\r\n        COUNT(*) as total_transactions,\r\n        SUM(CASE WHEN is_migrated = 1 THEN 1 ELSE 0 END) as migrated,\r\n        SUM(CASE WHEN is_migrated = 0 OR is_migrated IS NULL THEN 1 ELSE 0 END) as pending,\r\n        SUM(CASE WHEN is_migrated = 1 THEN amount ELSE 0 END) as total_amount_migrated\r\n      FROM ledger_transaction\r\n    `).get() as {\r\n      total_transactions: number;\r\n      migrated: number;\r\n      pending: number;\r\n      total_amount_migrated: number;\r\n    };\r\n\r\n    return {\r\n      total_transactions: stats.total_transactions || 0,\r\n      migrated: stats.migrated || 0,\r\n      failed: 0, // Would need separate tracking\r\n      skipped: stats.pending || 0,\r\n      total_amount_migrated: stats.total_amount_migrated || 0\r\n    };\r\n  }\r\n\r\n  // ============================================================================\r\n  // PRIVATE HELPER METHODS\r\n  // ============================================================================\r\n\r\n  private determineGLAccounts(transaction: LegacyTransaction): { debitAccount: string; creditAccount: string } {\r\n    // Determine GL accounts based on transaction type and description\r\n    const type = (transaction.transaction_type || '').toUpperCase();\r\n    const desc = (transaction.description || '').toLowerCase();\r\n\r\n    // Payment transactions\r\n    if (type === 'PAYMENT' || type === 'CREDIT') {\r\n      if (desc.includes('cash')) {\r\n        return { debitAccount: '1010', creditAccount: '1100' }; // Cash, Receivable\r\n      } else {\r\n        return { debitAccount: '1020', creditAccount: '1100' }; // Bank, Receivable\r\n      }\r\n    }\r\n\r\n    // Invoice/Charge transactions\r\n    if (type === 'INVOICE' || type === 'CHARGE' || type === 'DEBIT') {\r\n      let revenueAccount = '4300'; // Other Income (default)\r\n\r\n      if (desc.includes('tuition') || desc.includes('school fee')) {\r\n        revenueAccount = '4010'; // Tuition\r\n      } else if (desc.includes('board') || desc.includes('boarding')) {\r\n        revenueAccount = '4020'; // Boarding\r\n      } else if (desc.includes('transport') || desc.includes('bus')) {\r\n        revenueAccount = '4030'; // Transport\r\n      } else if (desc.includes('activity') || desc.includes('sport')) {\r\n        revenueAccount = '4040'; // Activity\r\n      } else if (desc.includes('exam')) {\r\n        revenueAccount = '4050'; // Exam\r\n      }\r\n\r\n      return { debitAccount: '1100', creditAccount: revenueAccount }; // Receivable, Revenue\r\n    }\r\n\r\n    // Default: treat as cash transaction\r\n    return { debitAccount: '1010', creditAccount: '1100' };\r\n  }\r\n\r\n  private mapTransactionType(oldType: string): string {\r\n    const type = (oldType || '').toUpperCase();\r\n\r\n    if (type.includes('PAYMENT') || type.includes('CREDIT')) {\r\n      return 'FEE_PAYMENT';\r\n    } else if (type.includes('INVOICE') || type.includes('CHARGE')) {\r\n      return 'FEE_INVOICE';\r\n    } else if (type.includes('REFUND')) {\r\n      return 'REFUND';\r\n    } else {\r\n      return 'OPENING_BALANCE';\r\n    }\r\n  }\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\accounting\\DoubleEntryJournalService.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'createJournalEntry' has too many lines (109). Maximum allowed is 80.","line":92,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":226,"endColumn":4},{"ruleId":"max-params","severity":1,"message":"Async method 'recordPayment' has too many parameters (6). Maximum allowed is 5.","line":233,"column":3,"nodeType":"FunctionExpression","messageId":"exceed","endLine":233,"endColumn":22},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always falsy.","line":330,"column":11,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":330,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { getDatabase } from '../../database';\nimport { logAudit } from '../../database/utils/audit';\n\nimport type Database from 'better-sqlite3';\n\n/**\n * Double-Entry Journal Service\n * \n * Implements true double-entry bookkeeping where:\n * - Every transaction has at least 2 entries (debit + credit)\n * - Total debits must equal total credits\n * - Follows accounting equation: Assets = Liabilities + Equity\n */\n\n// ============================================================================\n// TYPES & INTERFACES\n// ============================================================================\n\nexport interface JournalEntryData {\n  entry_date: string;\n  entry_type: string;\n  description: string;\n  student_id?: number;\n  staff_id?: number;\n  term_id?: number;\n  created_by_user_id: number;\n  lines: JournalEntryLineData[];\n  requires_approval?: boolean;\n}\n\nexport interface JournalEntryLineData {\n  gl_account_code: string;\n  debit_amount: number;\n  credit_amount: number;\n  description?: string;\n}\n\nexport interface JournalEntry {\n  id: number;\n  entry_ref: string;\n  entry_date: string;\n  entry_type: string;\n  description: string;\n  is_posted: boolean;\n  is_voided: boolean;\n  approval_status: string;\n  lines: JournalEntryLine[];\n}\n\nexport interface JournalEntryLine {\n  id: number;\n  line_number: number;\n  gl_account_code: string;\n  gl_account_name: string;\n  debit_amount: number;\n  credit_amount: number;\n  description: string;\n}\n\nexport interface BalanceSheetData {\n  assets: AccountBalance[];\n  liabilities: AccountBalance[];\n  equity: AccountBalance[];\n  total_assets: number;\n  total_liabilities: number;\n  total_equity: number;\n  is_balanced: boolean;\n}\n\nexport interface AccountBalance {\n  account_code: string;\n  account_name: string;\n  balance: number;\n}\n\n// ============================================================================\n// DOUBLE-ENTRY JOURNAL SERVICE\n// ============================================================================\n\nexport class DoubleEntryJournalService {\n  private db: Database.Database;\n\n  constructor(db?: Database.Database) {\n    this.db = db || getDatabase();\n  }\n\n  /**\n   * Creates a journal entry with validation\n   * Ensures debits = credits before posting\n   */\n  async createJournalEntry(data: JournalEntryData): Promise<{ success: boolean; message: string; entry_id?: number }> {\n    try {\n      // Validation 1: At least 2 lines required (double-entry)\n      if (data.lines.length < 2) {\n        return {\n          success: false,\n          message: 'Journal entry must have at least 2 lines (debit + credit)'\n        };\n      }\n\n      // Validation 2: Debits must equal credits\n      const totalDebits = data.lines.reduce((sum, line) => sum + line.debit_amount, 0);\n      const totalCredits = data.lines.reduce((sum, line) => sum + line.credit_amount, 0);\n\n      if (totalDebits !== totalCredits) {\n        return {\n          success: false,\n          message: `Debits (${totalDebits}) must equal Credits (${totalCredits}). Difference: ${Math.abs(totalDebits - totalCredits)}`\n        };\n      }\n\n      // Validation 3: Validate GL accounts exist\n      for (const line of data.lines) {\n        const account = this.db.prepare(`\n          SELECT id, account_code, account_name, is_active\n          FROM gl_account\n          WHERE account_code = ? AND is_active = 1\n        `).get(line.gl_account_code);\n\n        if (!account) {\n          return {\n            success: false,\n            message: `Invalid GL account code: ${line.gl_account_code}. Check Chart of Accounts or verify account is active.`\n          };\n        }\n      }\n\n      // Check if approval required\n      const requiresApproval = data.requires_approval || await this.checkApprovalRequired(data);\n\n      // Generate entry reference\n      const entryRef = this.generateEntryRef(data.entry_type);\n\n      // Start transaction\n      const insert = this.db.transaction(() => {\n        // Insert journal entry header\n        const headerResult = this.db.prepare(`\n          INSERT INTO journal_entry (\n            entry_ref, entry_date, entry_type, description,\n            student_id, staff_id, term_id,\n            requires_approval, approval_status,\n            created_by_user_id\n          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n        `).run(\n          entryRef,\n          data.entry_date,\n          data.entry_type,\n          data.description,\n          data.student_id || null,\n          data.staff_id || null,\n          data.term_id || null,\n          requiresApproval ? 1 : 0,\n          requiresApproval ? 'PENDING' : 'APPROVED',\n          data.created_by_user_id\n        );\n\n        const entryId = headerResult.lastInsertRowid as number;\n\n        // Insert journal entry lines\n        const lineStmt = this.db.prepare(`\n          INSERT INTO journal_entry_line (\n            journal_entry_id, line_number, gl_account_id,\n            debit_amount, credit_amount, description\n          ) VALUES (?, ?, ?, ?, ?, ?)\n        `);\n\n        data.lines.forEach((line, index) => {\n          const account = this.db.prepare(`\n            SELECT id FROM gl_account WHERE account_code = ?\n          `).get(line.gl_account_code) as { id: number };\n\n          lineStmt.run(\n            entryId,\n            index + 1,\n            account.id,\n            line.debit_amount,\n            line.credit_amount,\n            line.description || null\n          );\n        });\n\n        // Auto-post if no approval required\n        if (!requiresApproval) {\n          this.db.prepare(`\n            UPDATE journal_entry\n            SET is_posted = 1, posted_by_user_id = ?, posted_at = CURRENT_TIMESTAMP\n            WHERE id = ?\n          `).run(data.created_by_user_id, entryId);\n        }\n\n        // Audit log\n        logAudit(\n          data.created_by_user_id,\n          'CREATE',\n          'journal_entry',\n          entryId,\n          null,\n          {\n            entry_ref: entryRef,\n            entry_type: data.entry_type,\n            total_debits: totalDebits,\n            total_credits: totalCredits,\n            requires_approval: requiresApproval\n          }\n        );\n\n        return entryId;\n      });\n\n      const entryId = insert();\n\n      return {\n        success: true,\n        message: requiresApproval\n          ? `Journal entry created successfully. Awaiting approval (Ref: ${entryRef})`\n          : `Journal entry posted successfully (Ref: ${entryRef})`,\n        entry_id: entryId\n      };\n    } catch (error) {\n      return {\n        success: false,\n        message: `Failed to create journal entry: ${(error as Error).message}`\n      };\n    }\n  }\n\n  /**\n   * Creates a payment journal entry (Student pays fee)\n   * Debit: Bank/Cash\n   * Credit: Student Receivable\n   */\n  async recordPayment(\n    studentId: number,\n    amount: number,\n    paymentMethod: string,\n    paymentReference: string,\n    paymentDate: string,\n    userId: number\n  ): Promise<{ success: boolean; message: string; entry_id?: number }> {\n    // Determine cash/bank account\n    const cashAccountCode = paymentMethod === 'CASH' ? '1010' : '1020';\n\n    const journalData: JournalEntryData = {\n      entry_date: paymentDate,\n      entry_type: 'FEE_PAYMENT',\n      description: `Fee payment received - ${paymentMethod} - Ref: ${paymentReference}`,\n      student_id: studentId,\n      created_by_user_id: userId,\n      lines: [\n        {\n          gl_account_code: cashAccountCode,\n          debit_amount: amount,\n          credit_amount: 0,\n          description: 'Payment received'\n        },\n        {\n          gl_account_code: '1100', // Accounts Receivable - Students\n          debit_amount: 0,\n          credit_amount: amount,\n          description: 'Payment applied to student account'\n        }\n      ]\n    };\n\n    return this.createJournalEntry(journalData);\n  }\n\n  /**\n   * Creates an invoice journal entry (Charge student fees)\n   * Debit: Student Receivable\n   * Credit: Revenue (Tuition/Boarding/Transport)\n   */\n  async recordInvoice(\n    studentId: number,\n    invoiceItems: Array<{ gl_account_code: string; amount: number; description: string }>,\n    invoiceDate: string,\n    userId: number\n  ): Promise<{ success: boolean; message: string; entry_id?: number }> {\n    const totalAmount = invoiceItems.reduce((sum, item) => sum + item.amount, 0);\n\n    const lines: JournalEntryLineData[] = [\n      {\n        gl_account_code: '1100', // Accounts Receivable - Students\n        debit_amount: totalAmount,\n        credit_amount: 0,\n        description: 'Fee invoice charged'\n      }\n    ];\n\n    // Add credit lines for each fee category\n    invoiceItems.forEach((item) => {\n      lines.push({\n        gl_account_code: item.gl_account_code,\n        debit_amount: 0,\n        credit_amount: item.amount,\n        description: item.description\n      });\n    });\n\n    const journalData: JournalEntryData = {\n      entry_date: invoiceDate,\n      entry_type: 'FEE_INVOICE',\n      description: `Fee invoice for student`,\n      student_id: studentId,\n      created_by_user_id: userId,\n      lines\n    };\n\n    return this.createJournalEntry(journalData);\n  }\n\n  /**\n   * Voids a journal entry (creates reversing entry)\n   */\n  async voidJournalEntry(\n    entryId: number,\n    voidReason: string,\n    userId: number\n  ): Promise<{ success: boolean; message: string; requires_approval?: boolean }> {\n    try {\n      // Get original entry\n      const originalEntry = this.db.prepare(`\n        SELECT je.*, jel.gl_account_id, jel.debit_amount, jel.credit_amount, jel.description as line_desc\n        FROM journal_entry je\n        JOIN journal_entry_line jel ON je.id = jel.journal_entry_id\n        WHERE je.id = ? AND je.is_voided = 0\n      `).all(entryId) as Array<{ entry_date: string; debit_amount: number }>;\n\n      if (!originalEntry || originalEntry.length === 0) {\n        return {\n          success: false,\n          message: 'Journal entry not found or already voided'\n        };\n      }\n\n      // Check if approval required for void\n      const daysOld = Math.floor(\n        (new Date().getTime() - new Date(originalEntry[0].entry_date).getTime()) / (1000 * 60 * 60 * 24)\n      );\n\n      // Calculate total amount from line items\n      const totalAmount = originalEntry.reduce((sum, line) => sum + (line.debit_amount || 0), 0);\n\n      const needsApproval = this.db.prepare(`\n        SELECT id FROM approval_rule\n        WHERE transaction_type = 'VOID'\n          AND is_active = 1\n          AND (\n            (min_amount IS NOT NULL AND ? >= min_amount)\n            OR (days_since_transaction IS NOT NULL AND ? >= days_since_transaction)\n          )\n      `).get(totalAmount, daysOld) as { id: number } | undefined;\n\n      if (needsApproval) {\n        // Create approval request\n        const _approvalResult = this.db.prepare(`\n          INSERT INTO transaction_approval (\n            journal_entry_id, approval_rule_id,\n            requested_by_user_id, status\n          ) VALUES (?, ?, ?, 'PENDING')\n        `).run(entryId, needsApproval.id, userId);\n\n        return {\n          success: true,\n          message: 'Void request submitted for approval',\n          requires_approval: true\n        };\n      }\n\n      // Mark original as voided\n      this.db.prepare(`\n        UPDATE journal_entry\n        SET is_voided = 1, voided_reason = ?, voided_by_user_id = ?, voided_at = CURRENT_TIMESTAMP\n        WHERE id = ?\n      `).run(voidReason, userId, entryId);\n\n      // Audit log\n      logAudit(userId, 'VOID', 'journal_entry', entryId, null, { void_reason: voidReason });\n\n      return {\n        success: true,\n        message: 'Journal entry voided successfully',\n        requires_approval: false\n      };\n    } catch (error) {\n      return {\n        success: false,\n        message: `Failed to void journal entry: ${(error as Error).message}`\n      };\n    }\n  }\n\n  /**\n   * Generates trial balance (verifies debits = credits)\n   */\n  async getTrialBalance(startDate: string, endDate: string): Promise<{\n    accounts: Array<{ account_code: string; account_name: string; debit_total: number; credit_total: number }>;\n    total_debits: number;\n    total_credits: number;\n    is_balanced: boolean;\n  }> {\n    const accounts = this.db.prepare(`\n      SELECT\n        ga.account_code,\n        ga.account_name,\n        SUM(jel.debit_amount) as debit_total,\n        SUM(jel.credit_amount) as credit_total\n      FROM gl_account ga\n      LEFT JOIN journal_entry_line jel ON ga.id = jel.gl_account_id\n      LEFT JOIN journal_entry je ON jel.journal_entry_id = je.id\n      WHERE je.entry_date BETWEEN ? AND ?\n        AND je.is_posted = 1\n        AND je.is_voided = 0\n      GROUP BY ga.id, ga.account_code, ga.account_name\n      ORDER BY ga.account_code\n    `).all(startDate, endDate) as Array<{\n      account_code: string;\n      account_name: string;\n      debit_total: number;\n      credit_total: number;\n    }>;\n\n    const totalDebits = accounts.reduce((sum, acc) => sum + (acc.debit_total || 0), 0);\n    const totalCredits = accounts.reduce((sum, acc) => sum + (acc.credit_total || 0), 0);\n\n    return {\n      accounts,\n      total_debits: totalDebits,\n      total_credits: totalCredits,\n      is_balanced: totalDebits === totalCredits\n    };\n  }\n\n  /**\n   * Generates balance sheet\n   */\n  async getBalanceSheet(asOfDate: string): Promise<BalanceSheetData> {\n    const accountBalances = this.db.prepare(`\n      SELECT\n        ga.account_code,\n        ga.account_name,\n        ga.account_type,\n        ga.normal_balance,\n        SUM(jel.debit_amount) as total_debit,\n        SUM(jel.credit_amount) as total_credit\n      FROM gl_account ga\n      LEFT JOIN journal_entry_line jel ON ga.id = jel.gl_account_id\n      LEFT JOIN journal_entry je ON jel.journal_entry_id = je.id\n      WHERE je.entry_date <= ?\n        AND je.is_posted = 1\n        AND je.is_voided = 0\n        AND ga.account_type IN ('ASSET', 'LIABILITY', 'EQUITY')\n      GROUP BY ga.id\n      ORDER BY ga.account_code\n    `).all(asOfDate) as Array<{\n      account_code: string;\n      account_name: string;\n      account_type: string;\n      normal_balance: string;\n      total_debit: number;\n      total_credit: number;\n    }>;\n\n    const assets: AccountBalance[] = [];\n    const liabilities: AccountBalance[] = [];\n    const equity: AccountBalance[] = [];\n\n    let totalAssets = 0;\n    let totalLiabilities = 0;\n    let totalEquity = 0;\n\n    accountBalances.forEach((acc) => {\n      const balance =\n        acc.normal_balance === 'DEBIT'\n          ? (acc.total_debit || 0) - (acc.total_credit || 0)\n          : (acc.total_credit || 0) - (acc.total_debit || 0);\n\n      const accountBalance: AccountBalance = {\n        account_code: acc.account_code,\n        account_name: acc.account_name,\n        balance\n      };\n\n      if (acc.account_type === 'ASSET') {\n        assets.push(accountBalance);\n        totalAssets += balance;\n      } else if (acc.account_type === 'LIABILITY') {\n        liabilities.push(accountBalance);\n        totalLiabilities += balance;\n      } else if (acc.account_type === 'EQUITY') {\n        equity.push(accountBalance);\n        totalEquity += balance;\n      }\n    });\n\n    return {\n      assets,\n      liabilities,\n      equity,\n      total_assets: totalAssets,\n      total_liabilities: totalLiabilities,\n      total_equity: totalEquity,\n      is_balanced: Math.abs(totalAssets - (totalLiabilities + totalEquity)) < 1 // Allow 1 cent rounding\n    };\n  }\n\n  /**\n   * Helper: Generate unique entry reference\n   */\n  private generateEntryRef(entryType: string): string {\n    const prefix = entryType.substring(0, 3).toUpperCase();\n    const timestamp = Date.now();\n    return `${prefix}-${timestamp}`;\n  }\n\n  /**\n   * Helper: Check if approval required\n   */\n  private async checkApprovalRequired(data: JournalEntryData): Promise<boolean> {\n    const totalAmount = data.lines.reduce((sum, line) => sum + line.debit_amount, 0);\n\n    const rule = this.db.prepare(`\n      SELECT id FROM approval_rule\n      WHERE transaction_type = ?\n        AND is_active = 1\n        AND (min_amount IS NULL OR ? >= min_amount)\n    `).get(data.entry_type, totalAmount);\n\n    return !!rule;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\accounting\\OpeningBalanceService.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'importStudentOpeningBalances' has too many lines (97). Maximum allowed is 80.","line":50,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":157,"endColumn":4}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { DoubleEntryJournalService } from './DoubleEntryJournalService';\nimport { getDatabase } from '../../database';\nimport { logAudit } from '../../database/utils/audit';\n\nimport type Database from 'better-sqlite3-multiple-ciphers';\n\n/**\n * Opening Balance Service\n * \n * Handles:\n * 1. Import of opening balances from previous systems\n * 2. Student account opening balances\n * 3. GL account opening balances\n * 4. Verification and reconciliation\n */\n\nexport interface OpeningBalanceImport {\n  academic_year_id: number;\n  gl_account_code?: string;\n  student_id?: number;\n  debit_amount: number;\n  credit_amount: number;\n  description: string;\n  imported_from: string;\n  imported_by_user_id: number;\n}\n\nexport interface StudentOpeningBalance {\n  student_id: number;\n  admission_number: string;\n  student_name: string;\n  opening_balance: number;\n  balance_type: 'DEBIT' | 'CREDIT';\n}\n\nexport class OpeningBalanceService {\n  private db: Database.Database;\n  private journalService: DoubleEntryJournalService;\n\n  constructor(db?: Database.Database) {\n    this.db = db || getDatabase();\n    this.journalService = new DoubleEntryJournalService(this.db);\n  }\n\n  /**\n   * Import opening balances for students\n   * Creates journal entries: Debit: Student Receivable, Credit: Opening Balance Equity\n   */\n  async importStudentOpeningBalances(\n    balances: StudentOpeningBalance[],\n    academicYearId: number,\n    importSource: string,\n    userId: number\n  ): Promise<{ success: boolean; message: string; imported_count: number }> {\n    try {\n      let importedCount = 0;\n\n      const importTxn = this.db.transaction(() => {\n        for (const balance of balances) {\n          // Insert into opening_balance table\n          const _result = this.db.prepare(`\n            INSERT INTO opening_balance (\n              academic_year_id, student_id,\n              debit_amount, credit_amount,\n              description, imported_from, imported_by_user_id\n            ) VALUES (?, ?, ?, ?, ?, ?, ?)\n          `).run(\n            academicYearId,\n            balance.student_id,\n            balance.balance_type === 'DEBIT' ? balance.opening_balance : 0,\n            balance.balance_type === 'CREDIT' ? balance.opening_balance : 0,\n            `Opening balance for ${balance.student_name} (${balance.admission_number})`,\n            importSource,\n            userId\n          );\n\n          // Create journal entry only for debit balances (students owe money)\n          if (balance.balance_type === 'DEBIT' && balance.opening_balance > 0) {\n            void this.journalService.createJournalEntry({\n              entry_date: new Date().toISOString().split('T')[0],\n              entry_type: 'OPENING_BALANCE',\n              description: `Opening balance - ${balance.student_name}`,\n              student_id: balance.student_id,\n              created_by_user_id: userId,\n              lines: [\n                {\n                  gl_account_code: '1100', // Accounts Receivable - Students\n                  debit_amount: balance.opening_balance,\n                  credit_amount: 0,\n                  description: 'Student opening balance'\n                },\n                {\n                  gl_account_code: '3020', // Retained Earnings\n                  debit_amount: 0,\n                  credit_amount: balance.opening_balance,\n                  description: 'Opening balance equity'\n                }\n              ]\n            }).catch((error) => {\n              console.error('Failed to create opening balance journal entry:', error)\n            });\n          }\n\n          // For credit balances (students have overpayments)\n          if (balance.balance_type === 'CREDIT' && balance.opening_balance > 0) {\n            void this.journalService.createJournalEntry({\n              entry_date: new Date().toISOString().split('T')[0],\n              entry_type: 'OPENING_BALANCE',\n              description: `Opening credit balance - ${balance.student_name}`,\n              student_id: balance.student_id,\n              created_by_user_id: userId,\n              lines: [\n                {\n                  gl_account_code: '2020', // Student Credit Balances (Liability)\n                  debit_amount: 0,\n                  credit_amount: balance.opening_balance,\n                  description: 'Student credit balance'\n                },\n                {\n                  gl_account_code: '3020', // Retained Earnings\n                  debit_amount: balance.opening_balance,\n                  credit_amount: 0,\n                  description: 'Opening balance equity'\n                }\n              ]\n            }).catch((error) => {\n              console.error('Failed to create opening credit journal entry:', error)\n            });\n          }\n\n          importedCount++;\n        }\n\n        // Audit log\n        logAudit(userId, 'IMPORT', 'opening_balance', null, null, {\n          academic_year_id: academicYearId,\n          imported_count: importedCount,\n          import_source: importSource\n        });\n      });\n\n      importTxn();\n\n      return {\n        success: true,\n        message: `Successfully imported ${importedCount} student opening balances`,\n        imported_count: importedCount\n      };\n    } catch (error) {\n      return {\n        success: false,\n        message: `Failed to import opening balances: ${(error as Error).message}`,\n        imported_count: 0\n      };\n    }\n  }\n\n  /**\n   * Import GL account opening balances\n   */\n  async importGLOpeningBalances(\n    balances: OpeningBalanceImport[],\n    userId: number\n  ): Promise<{ success: boolean; message: string; imported_count: number }> {\n    try {\n      let importedCount = 0;\n\n      const importTxn = this.db.transaction(() => {\n        for (const balance of balances) {\n          // Validate GL account exists\n          const account = this.db.prepare(`\n            SELECT id, account_code, account_name\n            FROM gl_account\n            WHERE account_code = ? AND is_active = 1\n          `).get(balance.gl_account_code);\n\n          if (!account) {\n            throw new Error(`Invalid GL account code: ${balance.gl_account_code}. Verify the account exists in Chart of Accounts and is active.`);\n          }\n\n          // Insert opening balance record\n          this.db.prepare(`\n            INSERT INTO opening_balance (\n              academic_year_id, gl_account_id,\n              debit_amount, credit_amount,\n              description, imported_from, imported_by_user_id\n            ) VALUES (?, ?, ?, ?, ?, ?, ?)\n          `).run(\n            balance.academic_year_id,\n            account.id,\n            balance.debit_amount,\n            balance.credit_amount,\n            balance.description,\n            balance.imported_from,\n            userId\n          );\n\n          importedCount++;\n        }\n\n        logAudit(userId, 'IMPORT', 'opening_balance', null, null, {\n          imported_count: importedCount,\n          import_type: 'GL_ACCOUNTS'\n        });\n      });\n\n      importTxn();\n\n      return {\n        success: true,\n        message: `Successfully imported ${importedCount} GL opening balances`,\n        imported_count: importedCount\n      };\n    } catch (error) {\n      return {\n        success: false,\n        message: `Failed to import GL opening balances: ${(error as Error).message}`,\n        imported_count: 0\n      };\n    }\n  }\n\n  /**\n   * Get student ledger with opening balance\n   */\n  async getStudentLedger(\n    studentId: number,\n    academicYearId: number,\n    startDate: string,\n    endDate: string\n  ): Promise<{\n    student: { admission_number: string; full_name: string };\n    opening_balance: number;\n    transactions: Array<{\n      date: string;\n      description: string;\n      debit: number;\n      credit: number;\n      balance: number;\n    }>;\n    closing_balance: number;\n  }> {\n    // Get student info\n    const student = this.db.prepare(`\n      SELECT admission_number, first_name || ' ' || last_name as full_name\n      FROM student\n      WHERE id = ?\n    `).get(studentId) as { admission_number: string; full_name: string };\n\n    // Get opening balance\n    const openingBalanceRecord = this.db.prepare(`\n      SELECT\n        COALESCE(SUM(debit_amount), 0) as total_debit,\n        COALESCE(SUM(credit_amount), 0) as total_credit\n      FROM opening_balance\n      WHERE student_id = ? AND academic_year_id = ?\n    `).get(studentId, academicYearId) as { total_debit: number; total_credit: number };\n\n    const openingBalance = openingBalanceRecord.total_debit - openingBalanceRecord.total_credit;\n\n    // Get transactions\n    const transactions = this.db.prepare(`\n      SELECT\n        je.entry_date as date,\n        je.description,\n        COALESCE(SUM(jel.debit_amount), 0) as debit,\n        COALESCE(SUM(jel.credit_amount), 0) as credit\n      FROM journal_entry je\n      JOIN journal_entry_line jel ON je.id = jel.journal_entry_id\n      JOIN gl_account ga ON jel.gl_account_id = ga.id\n      WHERE je.student_id = ?\n        AND je.entry_date BETWEEN ? AND ?\n        AND je.is_posted = 1\n        AND je.is_voided = 0\n        AND ga.account_code IN ('1100', '2020')  -- Student Receivable or Credit Balance\n      GROUP BY je.id, je.entry_date, je.description\n      ORDER BY je.entry_date, je.id\n    `).all(studentId, startDate, endDate) as Array<{\n      date: string;\n      description: string;\n      debit: number;\n      credit: number;\n    }>;\n\n    // Calculate running balance\n    let runningBalance = openingBalance;\n    const transactionsWithBalance = transactions.map((txn) => {\n      runningBalance += txn.debit - txn.credit;\n      return {\n        ...txn,\n        balance: runningBalance\n      };\n    });\n\n    return {\n      student,\n      opening_balance: openingBalance,\n      transactions: transactionsWithBalance,\n      closing_balance: runningBalance\n    };\n  }\n\n  /**\n   * Verify opening balances (check if debits = credits)\n   */\n  async verifyOpeningBalances(\n    academicYearId: number,\n    userId: number\n  ): Promise<{\n    success: boolean;\n    message: string;\n    total_debits: number;\n    total_credits: number;\n    variance: number;\n    is_balanced: boolean;\n  }> {\n    const totals = this.db.prepare(`\n      SELECT\n        COALESCE(SUM(debit_amount), 0) as total_debits,\n        COALESCE(SUM(credit_amount), 0) as total_credits\n      FROM opening_balance\n      WHERE academic_year_id = ?\n    `).get(academicYearId) as { total_debits: number; total_credits: number };\n\n    const variance = totals.total_debits - totals.total_credits;\n    const isBalanced = Math.abs(variance) < 1; // Allow 1 cent rounding difference\n\n    if (isBalanced) {\n      // Mark as verified\n      this.db.prepare(`\n        UPDATE opening_balance\n        SET is_verified = 1, verified_by_user_id = ?, verified_at = CURRENT_TIMESTAMP\n        WHERE academic_year_id = ? AND is_verified = 0\n      `).run(userId, academicYearId);\n\n      logAudit(userId, 'VERIFY', 'opening_balance', null, null, {\n        academic_year_id: academicYearId,\n        verification_status: 'BALANCED'\n      });\n    }\n\n    return {\n      success: isBalanced,\n      message: isBalanced\n        ? 'Opening balances are balanced (debits = credits)'\n        : `Opening balances are OUT OF BALANCE by ${variance}`,\n      total_debits: totals.total_debits,\n      total_credits: totals.total_credits,\n      variance,\n      is_balanced: isBalanced\n    };\n  }\n\n  /**\n   * Get opening balance summary by GL account\n   */\n  async getOpeningBalanceSummary(academicYearId: number): Promise<\n    Array<{\n      account_code: string;\n      account_name: string;\n      account_type: string;\n      total_debit: number;\n      total_credit: number;\n      net_balance: number;\n    }>\n  > {\n    return this.db.prepare(`\n      SELECT\n        ga.account_code,\n        ga.account_name,\n        ga.account_type,\n        COALESCE(SUM(ob.debit_amount), 0) as total_debit,\n        COALESCE(SUM(ob.credit_amount), 0) as total_credit,\n        COALESCE(SUM(ob.debit_amount), 0) - COALESCE(SUM(ob.credit_amount), 0) as net_balance\n      FROM opening_balance ob\n      JOIN gl_account ga ON ob.gl_account_id = ga.id\n      WHERE ob.academic_year_id = ?\n      GROUP BY ga.id, ga.account_code, ga.account_name, ga.account_type\n      ORDER BY ga.account_code\n    `).all(academicYearId) as Array<{\n      account_code: string;\n      account_name: string;\n      account_type: string;\n      total_debit: number;\n      total_credit: number;\n      net_balance: number;\n    }>;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\accounting\\ProfitAndLossService.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Method 'categorizeExpenses' has a complexity of 14. Maximum allowed is 12.","line":223,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":223,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database';\n\r\nimport type Database from 'better-sqlite3-multiple-ciphers';\n\r\n\r\n/**\r\n * Profit and Loss Service\r\n * \r\n * Generates Profit & Loss (Income Statement) reports from the general ledger\r\n */\r\n\r\nexport interface ProfitAndLoss {\r\n  period_start: string;\r\n  period_end: string;\r\n  revenue: AccountBalance[];\r\n  expenses: AccountBalance[];\r\n  total_revenue: number;\r\n  total_expenses: number;\r\n  net_profit: number;\r\n  revenue_by_category: CategoryBalance[];\r\n  expenses_by_category: CategoryBalance[];\r\n}\r\n\r\nexport interface AccountBalance {\r\n  account_code: string;\r\n  account_name: string;\r\n  balance: number;\r\n}\r\n\r\nexport interface CategoryBalance {\r\n  category: string;\r\n  amount: number;\r\n  percentage: number;\r\n}\r\n\r\nexport class ProfitAndLossService {\r\n  private db: Database.Database;\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase();\r\n  }\r\n\r\n  /**\r\n   * Generate Profit & Loss Statement\r\n   */\r\n  async generateProfitAndLoss(startDate: string, endDate: string): Promise<ProfitAndLoss> {\r\n    // Get all revenue accounts (4000-4999)\r\n    const revenueAccounts = this.db.prepare(`\r\n      SELECT\r\n        ga.account_code,\r\n        ga.account_name,\r\n        COALESCE(SUM(jel.credit_amount), 0) - COALESCE(SUM(jel.debit_amount), 0) as balance\r\n      FROM gl_account ga\r\n      LEFT JOIN journal_entry_line jel ON ga.id = jel.gl_account_id\r\n      LEFT JOIN journal_entry je ON jel.journal_entry_id = je.id\r\n      WHERE ga.account_type = 'REVENUE'\r\n        AND ga.is_active = 1\r\n        AND (je.entry_date IS NULL OR (je.entry_date BETWEEN ? AND ?))\r\n        AND (je.is_posted IS NULL OR je.is_posted = 1)\r\n        AND (je.is_voided IS NULL OR je.is_voided = 0)\r\n      GROUP BY ga.id, ga.account_code, ga.account_name\r\n      HAVING balance > 0\r\n      ORDER BY ga.account_code\r\n    `).all(startDate, endDate) as AccountBalance[];\r\n\r\n    // Get all expense accounts (5000-5999)\r\n    const expenseAccounts = this.db.prepare(`\r\n      SELECT\r\n        ga.account_code,\r\n        ga.account_name,\r\n        COALESCE(SUM(jel.debit_amount), 0) - COALESCE(SUM(jel.credit_amount), 0) as balance\r\n      FROM gl_account ga\r\n      LEFT JOIN journal_entry_line jel ON ga.id = jel.gl_account_id\r\n      LEFT JOIN journal_entry je ON jel.journal_entry_id = je.id\r\n      WHERE ga.account_type = 'EXPENSE'\r\n        AND ga.is_active = 1\r\n        AND (je.entry_date IS NULL OR (je.entry_date BETWEEN ? AND ?))\r\n        AND (je.is_posted IS NULL OR je.is_posted = 1)\r\n        AND (je.is_voided IS NULL OR je.is_voided = 0)\r\n      GROUP BY ga.id, ga.account_code, ga.account_name\r\n      HAVING balance > 0\r\n      ORDER BY ga.account_code\r\n    `).all(startDate, endDate) as AccountBalance[];\r\n\r\n    // Calculate totals\r\n    const totalRevenue = revenueAccounts.reduce((sum, acc) => sum + acc.balance, 0);\r\n    const totalExpenses = expenseAccounts.reduce((sum, acc) => sum + acc.balance, 0);\r\n    const netProfit = totalRevenue - totalExpenses;\r\n\r\n    // Categorize revenue\r\n    const revenueByCategory = this.categorizeRevenue(revenueAccounts, totalRevenue);\r\n\r\n    // Categorize expenses\r\n    const expensesByCategory = this.categorizeExpenses(expenseAccounts, totalExpenses);\r\n\r\n    return {\r\n      period_start: startDate,\r\n      period_end: endDate,\r\n      revenue: revenueAccounts,\r\n      expenses: expenseAccounts,\r\n      total_revenue: totalRevenue,\r\n      total_expenses: totalExpenses,\r\n      net_profit: netProfit,\r\n      revenue_by_category: revenueByCategory,\r\n      expenses_by_category: expensesByCategory\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Generate comparative P&L (current period vs prior period)\r\n   */\r\n  async generateComparativeProfitAndLoss(\r\n    currentStart: string,\r\n    currentEnd: string,\r\n    priorStart: string,\r\n    priorEnd: string\r\n  ): Promise<{\r\n    current: ProfitAndLoss;\r\n    prior: ProfitAndLoss;\r\n    variance: {\r\n      revenue_variance: number;\r\n      revenue_variance_percent: number;\r\n      expense_variance: number;\r\n      expense_variance_percent: number;\r\n      net_profit_variance: number;\r\n      net_profit_variance_percent: number;\r\n    };\r\n  }> {\r\n    const current = await this.generateProfitAndLoss(currentStart, currentEnd);\r\n    const prior = await this.generateProfitAndLoss(priorStart, priorEnd);\r\n\r\n    const revenueVariance = current.total_revenue - prior.total_revenue;\r\n    const expenseVariance = current.total_expenses - prior.total_expenses;\r\n    const netProfitVariance = current.net_profit - prior.net_profit;\r\n\r\n    return {\r\n      current,\r\n      prior,\r\n      variance: {\r\n        revenue_variance: revenueVariance,\r\n        revenue_variance_percent: prior.total_revenue > 0 \r\n          ? (revenueVariance / prior.total_revenue) * 100 \r\n          : 0,\r\n        expense_variance: expenseVariance,\r\n        expense_variance_percent: prior.total_expenses > 0 \r\n          ? (expenseVariance / prior.total_expenses) * 100 \r\n          : 0,\r\n        net_profit_variance: netProfitVariance,\r\n        net_profit_variance_percent: prior.net_profit !== 0 \r\n          ? (netProfitVariance / prior.net_profit) * 100 \r\n          : 0\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get revenue breakdown by segment (Tuition, Boarding, Transport, etc.)\r\n   */\r\n  async getRevenueBreakdown(startDate: string, endDate: string): Promise<CategoryBalance[]> {\r\n    const revenue = await this.generateProfitAndLoss(startDate, endDate);\r\n    return revenue.revenue_by_category;\r\n  }\r\n\r\n  /**\r\n   * Get expense breakdown by category\r\n   */\r\n  async getExpenseBreakdown(startDate: string, endDate: string): Promise<CategoryBalance[]> {\r\n    const pl = await this.generateProfitAndLoss(startDate, endDate);\r\n    return pl.expenses_by_category;\r\n  }\r\n\r\n  // ============================================================================\r\n  // PRIVATE HELPER METHODS\r\n  // ============================================================================\r\n\r\n  private categorizeRevenue(\r\n    revenueAccounts: AccountBalance[],\r\n    totalRevenue: number\r\n  ): CategoryBalance[] {\r\n    const categories: Record<string, number> = {\r\n      'Tuition Fees': 0,\r\n      'Boarding Fees': 0,\r\n      'Transport Fees': 0,\r\n      'Activity Fees': 0,\r\n      'Exam Fees': 0,\r\n      'Government Grants': 0,\r\n      'Donations': 0,\r\n      'Other Income': 0\r\n    };\r\n\r\n    for (const account of revenueAccounts) {\r\n      const code = account.account_code;\r\n      \r\n      if (code === '4010') {\r\n        categories['Tuition Fees'] += account.balance;\r\n      } else if (code === '4020') {\r\n        categories['Boarding Fees'] += account.balance;\r\n      } else if (code === '4030') {\r\n        categories['Transport Fees'] += account.balance;\r\n      } else if (code === '4040') {\r\n        categories['Activity Fees'] += account.balance;\r\n      } else if (code === '4050') {\r\n        categories['Exam Fees'] += account.balance;\r\n      } else if (code === '4100') {\r\n        categories['Government Grants'] += account.balance;\r\n      } else if (code === '4200') {\r\n        categories['Donations'] += account.balance;\r\n      } else {\r\n        categories['Other Income'] += account.balance;\r\n      }\r\n    }\r\n\r\n    return Object.entries(categories)\r\n      .filter(([_, amount]) => amount > 0)\r\n      .map(([category, amount]) => ({\r\n        category,\r\n        amount,\r\n        percentage: totalRevenue > 0 ? (amount / totalRevenue) * 100 : 0\r\n      }))\r\n      .sort((a, b) => b.amount - a.amount);\r\n  }\r\n\r\n  private categorizeExpenses(\r\n    expenseAccounts: AccountBalance[],\r\n    totalExpenses: number\r\n  ): CategoryBalance[] {\r\n    const categories: Record<string, number> = {\r\n      'Salaries & Wages': 0,\r\n      'Statutory Deductions': 0,\r\n      'Food & Catering': 0,\r\n      'Transport': 0,\r\n      'Utilities': 0,\r\n      'Supplies': 0,\r\n      'Repairs & Maintenance': 0,\r\n      'Depreciation': 0,\r\n      'Other Expenses': 0\r\n    };\r\n\r\n    for (const account of expenseAccounts) {\r\n      const code = account.account_code;\r\n      \r\n      if (code.startsWith('501') || code.startsWith('502')) {\r\n        categories['Salaries & Wages'] += account.balance;\r\n      } else if (code.startsWith('503') || code.startsWith('504') || code.startsWith('505')) {\r\n        categories['Statutory Deductions'] += account.balance;\r\n      } else if (code.startsWith('510')) {\r\n        categories['Food & Catering'] += account.balance;\r\n      } else if (code.startsWith('520') || code === '5210') {\r\n        categories['Transport'] += account.balance;\r\n      } else if (code.startsWith('53')) {\r\n        categories['Utilities'] += account.balance;\r\n      } else if (code.startsWith('54')) {\r\n        categories['Supplies'] += account.balance;\r\n      } else if (code === '5500') {\r\n        categories['Repairs & Maintenance'] += account.balance;\r\n      } else if (code === '5600') {\r\n        categories['Depreciation'] += account.balance;\r\n      } else {\r\n        categories['Other Expenses'] += account.balance;\r\n      }\r\n    }\r\n\r\n    return Object.entries(categories)\r\n      .filter(([_, amount]) => amount > 0)\r\n      .map(([category, amount]) => ({\r\n        category,\r\n        amount,\r\n        percentage: totalExpenses > 0 ? (amount / totalExpenses) * 100 : 0\r\n      }))\r\n      .sort((a, b) => b.amount - a.amount);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\accounting\\ReconciliationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\accounting\\__tests__\\CashFlowStatementService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\accounting\\__tests__\\StudentLedgerService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\approval\\__tests__\\ApprovalWorkflowService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\base\\BaseService.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":88,"column":67,"nodeType":"Literal","endLine":88,"endColumn":82}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type Database } from 'better-sqlite3'\n\nimport { getDatabase } from '../../database'\nimport { type IReadable, type IWritable, type IAuditable, type AuditEntry } from './interfaces/IService'\nimport { logAudit } from '../../database/utils/audit'\n\n/**\n * Abstract base service implementing common CRUD operations.\n * Follows Single Responsibility: Only handles data access patterns.\n * Follows Open/Closed: Extended by specific services without modification.\n */\nexport abstract class BaseService<T, C, U = Partial<C>, F = Record<string, unknown>>\n    implements IReadable<T, F>, IWritable<T, C, U>, IAuditable {\n\n    protected abstract getTableName(): string\n    protected abstract getPrimaryKey(): string\n    protected getTableAlias(): string | null { return null }\n\n    protected getTablePrefix(): string {\n        return (this.getTableAlias() || this.getTableName()) + '.'\n    }\n\n    protected get db(): Database {\n        return getDatabase()\n    }\n\n    /**\n     * Template method for building SELECT queries.\n     * Subclasses override to add JOINs, computed columns, etc.\n     */\n    protected abstract buildSelectQuery(): string\n\n    /**\n     * Template method for mapping database rows to domain objects.\n     */\n    protected abstract mapRowToEntity(row: unknown): T\n\n    /**\n     * Template method for validating create data.\n     * Returns validation errors or null if valid.\n     */\n    protected abstract validateCreate(data: C): string[] | null\n\n    /**\n     * Template method for validating update data.\n     */\n    protected abstract validateUpdate(id: number, data: U): Promise<string[] | null>\n\n    async findById(id: number): Promise<T | null> {\n        const prefix = this.getTablePrefix()\n        const primaryKey = this.getPrimaryKey()\n        const query = `${this.buildSelectQuery()} WHERE ${prefix}${primaryKey} = ?${this.getGroupBy()}`\n\n        const row = this.db.prepare(query).get(id)\n        return row ? this.mapRowToEntity(row) : null\n    }\n\n    async findAll(filters?: F): Promise<T[]> {\n        const { query, params } = this.buildFilteredQuery(filters)\n        const rows = this.db.prepare(query).all(...params)\n        return rows.map(row => this.mapRowToEntity(row))\n    }\n\n    async exists(id: number): Promise<boolean> {\n        const result = this.db.prepare(\n            `SELECT 1 FROM ${this.getTableName()} WHERE ${this.getPrimaryKey()} = ? LIMIT 1`\n        ).get(id)\n        return !!result\n    }\n\n    async create(data: C, userId: number): Promise<{ success: boolean; id: number; errors?: string[] }> {\n        const errors = this.validateCreate(data)\n        if (errors) {\n            return { success: false, id: 0, errors }\n        }\n\n        try {\n            const result = this.executeCreate(data)\n            const id = result.lastInsertRowid as number\n\n            logAudit(userId, 'CREATE', this.getTableName(), id, null, data)\n\n            return { success: true, id }\n        } catch (error) {\n            return {\n                success: false,\n                id: 0,\n                errors: [error instanceof Error ? error.message : 'Unknown error']\n            }\n        }\n    }\n\n    async update(id: number, data: U, userId: number): Promise<{ success: boolean; errors?: string[] }> {\n        const existing = await this.findById(id)\n        if (!existing) {\n            return { success: false, errors: ['Record not found'] }\n        }\n\n        const errors = await this.validateUpdate(id, data)\n        if (errors) {\n            return { success: false, errors }\n        }\n\n        try {\n            this.executeUpdate(id, data)\n            logAudit(userId, 'UPDATE', this.getTableName(), id, existing, data)\n            return { success: true }\n        } catch (error) {\n            return {\n                success: false,\n                errors: [error instanceof Error ? error.message : 'Unknown error']\n            }\n        }\n    }\n\n    async delete(id: number, userId: number): Promise<{ success: boolean; errors?: string[] }> {\n        const existing = await this.findById(id)\n        if (!existing) {\n            return { success: false, errors: ['Record not found'] }\n        }\n\n        try {\n            this.db.prepare(`DELETE FROM ${this.getTableName()} WHERE ${this.getPrimaryKey()} = ?`).run(id)\n            logAudit(userId, 'DELETE', this.getTableName(), id, existing, null)\n            return { success: true }\n        } catch (error) {\n            return {\n                success: false,\n                errors: [error instanceof Error ? error.message : 'Unknown error']\n            }\n        }\n    }\n\n    async getAuditTrail(recordId: number): Promise<AuditEntry[]> {\n        return this.db.prepare(`\n      SELECT a.*, u.full_name as user_name\n      FROM audit_log a\n      LEFT JOIN user u ON a.user_id = u.id\n      WHERE a.table_name = ? AND a.record_id = ?\n      ORDER BY a.created_at DESC\n    `).all(this.getTableName(), recordId) as AuditEntry[]\n    }\n\n    /**\n     * Build filtered query with dynamic WHERE clauses.\n     * Override in subclasses for custom filtering logic.\n     */\n    protected buildFilteredQuery(filters?: F): { query: string; params: unknown[] } {\n        const baseQuery = this.buildSelectQuery()\n        const conditions: string[] = []\n        const params: unknown[] = []\n\n        if (filters) {\n            this.applyFilters(filters, conditions, params)\n        }\n\n        const whereClause = conditions.length > 0 ? ` WHERE ${conditions.join(' AND ')}` : ''\n        const query = `${baseQuery}${whereClause}${this.getGroupBy()}`\n        return { query, params }\n    }\n\n    /**\n     * Override to add filter conditions.\n     */\n    protected applyFilters(_filters: F, _conditions: string[], _params: unknown[]): void {\n        // Default: no filters. Override in subclasses.\n    }\n\n    /**\n     * Override to add GROUP BY clause.\n     */\n    protected getGroupBy(): string {\n        return ''\n    }\n\n    /**\n     * Execute create operation. Override for custom insert logic.\n     */\n    protected abstract executeCreate(data: C): { lastInsertRowid: number | bigint }\n\n    /**\n     * Execute update operation. Override for custom update logic.\n     */\n    protected abstract executeUpdate(id: number, data: U): void\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\base\\ServiceContainer.ts","messages":[{"ruleId":"sonarjs/redundant-type-aliases","severity":1,"message":"Remove this redundant type alias and replace its occurrences with \"unknown\".","line":32,"column":6,"nodeType":"Identifier","messageId":"redundantTypeAlias","endLine":32,"endColumn":21},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always falsy.","line":42,"column":13,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":42,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Simple dependency injection container.\r\n * Follows Dependency Inversion Principle: High-level modules depend on abstractions.\r\n */\r\n\r\n// Academic Services\r\nimport { AcademicSystemService } from '../academic/AcademicSystemService'\r\nimport { AttendanceService } from '../academic/AttendanceService'\nimport { ExamAnalysisService } from '../academic/ExamAnalysisService'\nimport { MeritListService } from '../academic/MeritListService'\nimport { PerformanceAnalysisService } from '../academic/PerformanceAnalysisService'\nimport { PromotionService } from '../academic/PromotionService'\nimport { ReportCardService } from '../academic/ReportCardService'\nimport { StudentService } from '../academic/StudentService'\nimport { BudgetEnforcementService } from '../accounting/BudgetEnforcementService'\nimport { DoubleEntryJournalService } from '../accounting/DoubleEntryJournalService'\nimport { OpeningBalanceService } from '../accounting/OpeningBalanceService'\nimport { ProfitAndLossService } from '../accounting/ProfitAndLossService'\nimport { ReconciliationService } from '../accounting/ReconciliationService'\nimport { BudgetService } from '../finance/BudgetService'\r\nimport { CashFlowService } from '../finance/CashFlowService'\r\nimport { ExemptionService } from '../finance/ExemptionService'\r\nimport { FixedAssetService } from '../finance/FixedAssetService'\r\nimport { GLAccountService } from '../finance/GLAccountService'\nimport { HireService } from '../finance/HireService'\nimport { PaymentService } from '../finance/PaymentService'\nimport { InventoryService } from '../inventory/InventoryService'\nimport { NotificationService } from '../notifications/NotificationService'\nimport { SystemMaintenanceService } from '../SystemMaintenanceService'\n\r\ntype ServiceFactory<T> = () => T\r\ntype ServiceInstance = unknown\r\n\r\nclass ServiceContainer {\r\n    private static instance: ServiceContainer\r\n    private services: Map<string, ServiceInstance> = new Map()\r\n    private factories: Map<string, ServiceFactory<unknown>> = new Map()\r\n\r\n    private constructor() { }\r\n\r\n    static getInstance(): ServiceContainer {\r\n        if (!ServiceContainer.instance) {\r\n            ServiceContainer.instance = new ServiceContainer()\r\n        }\r\n        return ServiceContainer.instance\r\n    }\r\n\r\n    /**\r\n     * Register a service factory (lazy instantiation).\r\n     */\r\n    register<T>(name: string, factory: ServiceFactory<T>): void {\r\n        this.factories.set(name, factory)\r\n    }\r\n\r\n    /**\r\n     * Register a singleton instance.\r\n     */\r\n    registerInstance<T>(name: string, instance: T): void {\r\n        this.services.set(name, instance)\r\n    }\r\n\r\n    /**\r\n     * Resolve a service by name.\r\n     */\r\n    resolve<T>(name: string): T {\r\n        // Check for existing instance\r\n        if (this.services.has(name)) {\r\n            return this.services.get(name) as T\r\n        }\r\n\r\n        // Check for factory\r\n        const factory = this.factories.get(name)\r\n        if (factory) {\r\n            const instance = factory() as T\r\n            this.services.set(name, instance) // Cache as singleton\r\n            return instance\r\n        }\r\n\r\n        throw new Error(`Service '${name}' not registered`)\r\n    }\r\n\r\n    /**\r\n     * Clear all services (useful for testing).\r\n     */\r\n    clear(): void {\r\n        this.services.clear()\r\n        this.factories.clear()\r\n    }\r\n}\r\n\r\nexport const container = ServiceContainer.getInstance()\r\n\r\n// Service registration helper - all services registered for DI\r\nexport function registerServices(): void {\r\n    // Academic\r\n    container.register('StudentService', () => new StudentService())\r\n    container.register('AcademicSystemService', () => new AcademicSystemService())\r\n    container.register('AttendanceService', () => new AttendanceService())\r\n    container.register('ExamAnalysisService', () => new ExamAnalysisService())\r\n    container.register('MeritListService', () => new MeritListService())\r\n    container.register('PerformanceAnalysisService', () => new PerformanceAnalysisService())\r\n    container.register('PromotionService', () => new PromotionService())\r\n    container.register('ReportCardService', () => new ReportCardService())\r\n\r\n    // Finance\r\n    container.register('BudgetService', () => new BudgetService())\r\n    container.register('CashFlowService', () => new CashFlowService())\r\n    container.register('ExemptionService', () => new ExemptionService())\r\n    container.register('FixedAssetService', () => new FixedAssetService())\r\n    container.register('GLAccountService', () => new GLAccountService())\r\n    container.register('HireService', () => new HireService())\r\n    container.register('PaymentService', () => new PaymentService())\r\n\r\n    // Accounting\r\n    container.register('DoubleEntryJournalService', () => new DoubleEntryJournalService())\r\n    container.register('OpeningBalanceService', () => new OpeningBalanceService())\r\n    container.register('ProfitAndLossService', () => new ProfitAndLossService())\r\n    container.register('ReconciliationService', () => new ReconciliationService())\r\n    container.register('BudgetEnforcementService', () => new BudgetEnforcementService())\r\n\r\n    // Other\r\n    container.register('InventoryService', () => new InventoryService())\r\n    container.register('SystemMaintenanceService', () => new SystemMaintenanceService())\r\n    container.register('NotificationService', () => new NotificationService())\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\base\\interfaces\\IService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\cbc\\CBCStrandService.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always truthy.","line":113,"column":13,"nodeType":"TSAsExpression","messageId":"alwaysTruthy","endLine":113,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type Database from 'better-sqlite3';\r\n\r\nexport interface CBCStrand {\r\n  id: number;\r\n  code: string;\r\n  name: string;\r\n  description: string;\r\n  category: 'CORE' | 'ELECTIVE';\r\n  is_active: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface StrandExpense {\n  id: number;\n  strand_id: number;\n  expense_date: string;\n  description: string;\n  gl_account_code: string;\n  amount_cents: number;\n  term: number;\n  fiscal_year: number;\n  receipt_number?: string;\n  created_by: number;\n  created_at: string;\n}\n\r\nexport interface StrandRevenue {\r\n  strand_id: number;\r\n  strand_name: string;\r\n  fiscal_year: number;\r\n  term: number;\r\n  student_count: number;\r\n  total_fees_cents: number;\r\n  avg_fee_per_student_cents: number;\r\n}\r\n\r\nexport interface StrandProfitability {\r\n  strand_id: number;\r\n  strand_name: string;\r\n  fiscal_year: number;\r\n  term: number;\r\n  revenue_cents: number;\r\n  expenses_cents: number;\r\n  net_profit_cents: number;\r\n  profit_margin_percent: number;\r\n  student_count: number;\r\n  cost_per_student_cents: number;\r\n  revenue_per_student_cents: number;\r\n}\r\n\r\nexport interface StudentActivityParticipation {\n  id: number;\n  student_id: number;\n  strand_id: number;\n  activity_name: string;\n  start_date: string;\n  end_date?: string;\n  participation_level: 'PRIMARY' | 'SECONDARY' | 'INTEREST';\n  is_active: boolean;\n  created_at: string;\n  updated_at?: string;\n}\n\r\n/**\r\n * Service for managing CBC (Competency-Based Curriculum) strand tracking\r\n * \r\n * Capabilities:\r\n * - Track revenue and expenses by CBC strand\r\n * - Calculate profitability per strand\r\n * - Manage student activity participation\r\n * - Generate strand performance reports\r\n * - Support budget allocation by strand\r\n */\r\nexport class CBCStrandService {\r\n  private db: Database.Database;\r\n\r\n  constructor(db: Database.Database) {\r\n    this.db = db;\r\n  }\r\n\r\n  /**\r\n   * Get all CBC strands\r\n   */\r\n  getAllStrands(): CBCStrand[] {\r\n    const stmt = this.db.prepare(`\r\n      SELECT * FROM cbc_strand\r\n      ORDER BY code\r\n    `);\r\n    return stmt.all() as CBCStrand[];\r\n  }\r\n\r\n  /**\r\n   * Get active CBC strands only\r\n   */\r\n  getActiveStrands(): CBCStrand[] {\r\n    const stmt = this.db.prepare(`\r\n      SELECT * FROM cbc_strand\r\n      WHERE is_active = 1\r\n      ORDER BY code\r\n    `);\r\n    return stmt.all() as CBCStrand[];\r\n  }\r\n\r\n  /**\r\n   * Get strand by ID\r\n   */\r\n  getStrandById(strandId: number): CBCStrand | null {\r\n    const stmt = this.db.prepare(`\r\n      SELECT * FROM cbc_strand\r\n      WHERE id = ?\r\n    `);\r\n    return (stmt.get(strandId) as CBCStrand) || null;\r\n  }\r\n\r\n  /**\r\n   * Record expense for a CBC strand\r\n   */\r\n  recordStrandExpense(data: {\n    strand_id: number;\n    expense_date: string;\n    description: string;\n    gl_account_code: string;\n    amount_cents: number;\n    term: number;\n    fiscal_year: number;\n    receipt_number?: string;\n    created_by: number;\n  }): number {\n    const stmt = this.db.prepare(`\n      INSERT INTO cbc_strand_expense (\n        cbc_strand_id, expense_date, description, gl_account_code,\n        amount_cents, term, fiscal_year, receipt_number, created_by\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n    `);\n\n    const result = stmt.run(\n      data.strand_id,\n      data.expense_date,\r\n      data.description,\r\n      data.gl_account_code,\r\n      data.amount_cents,\r\n      data.term,\r\n      data.fiscal_year,\r\n      data.receipt_number || null,\r\n      data.created_by\n    );\n\r\n    return result.lastInsertRowid as number;\r\n  }\r\n\r\n  /**\r\n   * Get strand expenses for a period\r\n   */\r\n  getStrandExpenses(\r\n    strandId: number,\r\n    fiscalYear: number,\r\n    term?: number\r\n  ): StrandExpense[] {\r\n    let sql = `\r\n      SELECT * FROM cbc_strand_expense\n      WHERE cbc_strand_id = ? AND fiscal_year = ?\n    `;\n    const params: unknown[] = [strandId, fiscalYear];\r\n\r\n    if (term !== undefined) {\r\n      sql += ' AND term = ?';\r\n      params.push(term);\r\n    }\r\n\r\n    sql += ' ORDER BY expense_date DESC';\r\n\r\n    const stmt = this.db.prepare(sql);\r\n    return stmt.all(...params) as StrandExpense[];\r\n  }\r\n\r\n  /**\r\n   * Calculate strand revenue from fee categories\r\n   */\r\n  getStrandRevenue(\r\n    fiscalYear: number,\r\n    term?: number\r\n  ): StrandRevenue[] {\r\n    let sql = `\r\n      SELECT \n        cs.id as strand_id,\n        cs.name as strand_name,\n        CAST(strftime('%Y', fi.invoice_date) AS INTEGER) as fiscal_year,\n        t.term_number as term,\n        COUNT(DISTINCT fi.student_id) as student_count,\n        SUM(ii.amount) as total_fees_cents,\n        AVG(ii.amount) as avg_fee_per_student_cents\n      FROM cbc_strand cs\n      JOIN fee_category_strand fcs ON cs.id = fcs.cbc_strand_id\n      JOIN invoice_item ii ON fcs.fee_category_id = ii.fee_category_id\n      JOIN fee_invoice fi ON ii.invoice_id = fi.id\n      LEFT JOIN term t ON fi.term_id = t.id\n      WHERE CAST(strftime('%Y', fi.invoice_date) AS INTEGER) = ?\n    `;\n    const params: unknown[] = [fiscalYear];\r\n\r\n    if (term !== undefined) {\r\n      sql += ' AND t.term_number = ?';\n      params.push(term);\n    }\n\r\n    sql += `\r\n      GROUP BY cs.id, cs.name, i.fiscal_year, i.term\r\n      ORDER BY cs.code\r\n    `;\r\n\r\n    const stmt = this.db.prepare(sql);\r\n    return stmt.all(...params) as StrandRevenue[];\r\n  }\r\n\r\n  /**\r\n   * Calculate strand profitability\r\n   */\r\n  getStrandProfitability(\r\n    fiscalYear: number,\r\n    term?: number\r\n  ): StrandProfitability[] {\r\n    // Get revenue\r\n    const revenues = this.getStrandRevenue(fiscalYear, term);\r\n\r\n    // Get expenses for each strand\r\n    const results: StrandProfitability[] = [];\r\n\r\n    for (const rev of revenues) {\r\n      const expenses = this.getStrandExpenses(rev.strand_id, fiscalYear, term);\r\n      const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount_cents, 0);\r\n\r\n      const netProfit = rev.total_fees_cents - totalExpenses;\r\n      const profitMargin = rev.total_fees_cents > 0\r\n        ? (netProfit / rev.total_fees_cents) * 100\r\n        : 0;\r\n\r\n      results.push({\r\n        strand_id: rev.strand_id,\r\n        strand_name: rev.strand_name,\r\n        fiscal_year: rev.fiscal_year,\r\n        term: rev.term,\r\n        revenue_cents: rev.total_fees_cents,\r\n        expenses_cents: totalExpenses,\r\n        net_profit_cents: netProfit,\r\n        profit_margin_percent: profitMargin,\r\n        student_count: rev.student_count,\r\n        cost_per_student_cents: rev.student_count > 0\r\n          ? Math.round(totalExpenses / rev.student_count)\r\n          : 0,\r\n        revenue_per_student_cents: Math.round(rev.avg_fee_per_student_cents),\r\n      });\r\n    }\r\n\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * Link fee category to CBC strand\r\n   */\r\n  linkFeeCategoryToStrand(\r\n    feeCategoryId: number,\r\n    strandId: number,\r\n    allocationPercentage: number,\r\n    userId: number\r\n  ): number {\r\n    const stmt = this.db.prepare(`\r\n      INSERT INTO fee_category_strand (\n        fee_category_id, cbc_strand_id, allocation_percentage, created_by\n      ) VALUES (?, ?, ?, ?)\n    `);\n\r\n    const result = stmt.run(feeCategoryId, strandId, allocationPercentage, userId);\r\n    return result.lastInsertRowid as number;\r\n  }\r\n\r\n  /**\r\n   * Record student activity participation\r\n   */\r\n  recordStudentParticipation(data: {\n    student_id: number;\n    strand_id: number;\n    activity_name: string;\n    start_date: string;\n    academic_year: number;\n    term: number;\n    participation_level: 'PRIMARY' | 'SECONDARY' | 'INTEREST';\n  }): number {\n    const stmt = this.db.prepare(`\n      INSERT INTO student_activity_participation (\n        student_id, cbc_strand_id, academic_year, term, activity_name, start_date, participation_level\n      ) VALUES (?, ?, ?, ?, ?, ?, ?)\n    `);\n\n    const result = stmt.run(\n      data.student_id,\n      data.strand_id,\n      data.academic_year,\n      data.term,\n      data.activity_name,\n      data.start_date,\n      data.participation_level\n    );\n\r\n    return result.lastInsertRowid as number;\r\n  }\r\n\r\n  /**\r\n   * Get student's activity participations\r\n   */\r\n  getStudentParticipations(studentId: number): StudentActivityParticipation[] {\r\n    const stmt = this.db.prepare(`\r\n      SELECT \n        sap.*\n      FROM student_activity_participation sap\n      WHERE sap.student_id = ?\n      ORDER BY sap.start_date DESC\n    `);\n\r\n    return stmt.all(studentId) as StudentActivityParticipation[];\r\n  }\r\n\r\n  /**\r\n   * Get students participating in a strand\r\n   */\r\n  getStrandParticipants(\r\n    strandId: number,\r\n    activeOnly: boolean = true\r\n  ): StudentActivityParticipation[] {\r\n    let sql = `\r\n      SELECT \r\n        sap.*\r\n      FROM student_activity_participation sap\n      WHERE sap.cbc_strand_id = ?\n    `;\n\r\n    if (activeOnly) {\r\n      sql += ' AND sap.is_active = 1';\r\n    }\r\n\r\n    sql += ' ORDER BY sap.activity_name, sap.start_date DESC';\r\n\r\n    const stmt = this.db.prepare(sql);\r\n    return stmt.all(strandId) as StudentActivityParticipation[];\r\n  }\r\n\r\n  /**\r\n   * End student participation in activity\r\n   */\r\n  endStudentParticipation(participationId: number, endDate: string): void {\r\n    const stmt = this.db.prepare(`\r\n      UPDATE student_activity_participation\r\n      SET end_date = ?, is_active = 0, updated_at = datetime('now')\r\n      WHERE id = ?\r\n    `);\r\n\r\n    stmt.run(endDate, participationId);\r\n  }\r\n\r\n  /**\r\n   * Get strand performance summary\r\n   */\r\n  getStrandPerformanceSummary(fiscalYear: number): {\r\n    total_strands: number;\r\n    profitable_strands: number;\r\n    unprofitable_strands: number;\r\n    total_revenue_cents: number;\r\n    total_expenses_cents: number;\r\n    total_profit_cents: number;\r\n    avg_profit_margin_percent: number;\r\n    most_profitable_strand: string;\r\n    least_profitable_strand: string;\r\n  } {\r\n    const profitability = this.getStrandProfitability(fiscalYear);\r\n\r\n    if (profitability.length === 0) {\r\n      return {\r\n        total_strands: 0,\r\n        profitable_strands: 0,\r\n        unprofitable_strands: 0,\r\n        total_revenue_cents: 0,\r\n        total_expenses_cents: 0,\r\n        total_profit_cents: 0,\r\n        avg_profit_margin_percent: 0,\r\n        most_profitable_strand: 'N/A',\r\n        least_profitable_strand: 'N/A',\r\n      };\r\n    }\r\n\r\n    const totalRevenue = profitability.reduce((sum, s) => sum + s.revenue_cents, 0);\r\n    const totalExpenses = profitability.reduce((sum, s) => sum + s.expenses_cents, 0);\r\n    const totalProfit = totalRevenue - totalExpenses;\r\n\r\n    const profitableStrands = profitability.filter(s => s.net_profit_cents > 0).length;\r\n    const unprofitableStrands = profitability.filter(s => s.net_profit_cents < 0).length;\r\n\r\n    const avgMargin = profitability.reduce((sum, s) => sum + s.profit_margin_percent, 0) / profitability.length;\r\n\r\n    const sortedByProfit = [...profitability].sort((a, b) => b.net_profit_cents - a.net_profit_cents);\r\n    const mostProfitable = sortedByProfit[0];\r\n    const leastProfitable = sortedByProfit[sortedByProfit.length - 1];\r\n\r\n    return {\r\n      total_strands: profitability.length,\r\n      profitable_strands: profitableStrands,\r\n      unprofitable_strands: unprofitableStrands,\r\n      total_revenue_cents: totalRevenue,\r\n      total_expenses_cents: totalExpenses,\r\n      total_profit_cents: totalProfit,\r\n      avg_profit_margin_percent: avgMargin,\r\n      most_profitable_strand: mostProfitable.strand_name,\r\n      least_profitable_strand: leastProfitable.strand_name,\r\n    };\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\cbc\\JSSTransitionService.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always truthy.","line":89,"column":13,"nodeType":"TSAsExpression","messageId":"alwaysTruthy","endLine":89,"endColumn":59},{"ruleId":"complexity","severity":1,"message":"Method 'processStudentTransition' has a complexity of 13. Maximum allowed is 12.","line":108,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":108,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type Database from 'better-sqlite3';\n\nexport interface GradeTransition {\n  id: number;\n  student_id: number;\n  from_grade: number;\n  to_grade: number;\n  transition_date: string;\n  old_fee_structure_id?: number;\n  new_fee_structure_id: number;\n  outstanding_balance_cents: number;\n  boarding_status_change?: 'TO_BOARDER' | 'TO_DAY_SCHOLAR' | 'NO_CHANGE';\n  transition_notes?: string;\n  processed_by: number;\n  created_at: string;\n}\n\nexport interface JSSFeeStructure {\n  id: number;\n  grade: number;\n  fiscal_year: number;\n  tuition_fee_cents: number;\n  boarding_fee_cents?: number;\n  activity_fee_cents?: number;\n  exam_fee_cents?: number;\n  library_fee_cents?: number;\n  lab_fee_cents?: number;\n  ict_fee_cents?: number;\n  is_active: boolean;\n  created_at: string;\n  updated_at: string;\n}\n\nexport interface TransitionSummary {\n  fiscal_year: number;\n  total_transitions: number;\n  grade_6_to_7: number;\n  grade_7_to_8: number;\n  grade_8_to_9: number;\n  to_boarder_count: number;\n  to_day_scholar_count: number;\n  avg_outstanding_balance_cents: number;\n  total_outstanding_balance_cents: number;\n}\n\nexport interface StudentTransitionStatus {\n  student_id: number;\n  admission_number: string;\n  full_name: string;\n  current_grade: number;\n  eligible_for_transition: boolean;\n  transition_to_grade: number;\n  outstanding_balance_cents: number;\n  boarding_status: 'BOARDER' | 'DAY_SCHOLAR';\n  recommended_fee_structure: JSSFeeStructure | null;\n}\n\n/**\n * Service for managing JSS (Junior Secondary School) transitions\n * \n * Capabilities:\n * - Automate Grade 67, 78, 89 transitions\n * - Apply appropriate fee structures for JSS grades\n * - Handle boarding status changes during transition\n * - Track outstanding balances across grade transitions\n * - Generate transition reports\n */\nexport class JSSTransitionService {\n  private db: Database.Database;\n\n  constructor(db: Database.Database) {\n    this.db = db;\n  }\n\n  /**\n   * Get JSS fee structure for a specific grade and year\n   */\n  getJSSFeeStructure(grade: number, fiscalYear: number): JSSFeeStructure | null {\n    if (grade < 7 || grade > 9) {\n      throw new Error('JSS grades are 7, 8, and 9 only');\n    }\n\n    const stmt = this.db.prepare(`\n      SELECT * FROM jss_fee_structure\n      WHERE grade = ? AND fiscal_year = ? AND is_active = 1\n      LIMIT 1\n    `);\n\n    return (stmt.get(grade, fiscalYear) as JSSFeeStructure) || null;\n  }\n\n  /**\n   * Get all JSS fee structures for a fiscal year\n   */\n  getAllJSSFeeStructures(fiscalYear: number): JSSFeeStructure[] {\n    const stmt = this.db.prepare(`\n      SELECT * FROM jss_fee_structure\n      WHERE fiscal_year = ? AND is_active = 1\n      ORDER BY grade\n    `);\n\n    return stmt.all(fiscalYear) as JSSFeeStructure[];\n  }\n\n  /**\n   * Process grade transition for a student\n   */\n  processStudentTransition(data: {\n    student_id: number;\n    from_grade: number;\n    to_grade: number;\n    transition_date: string;\n    boarding_status_change?: 'TO_BOARDER' | 'TO_DAY_SCHOLAR' | 'NO_CHANGE';\n    transition_notes?: string;\n    processed_by: number;\n  }): number {\n    // Validate transition\n    if (data.to_grade !== data.from_grade + 1) {\n      throw new Error('Invalid transition: Can only promote to next grade');\n    }\n\n    if (data.to_grade < 7 || data.to_grade > 9) {\n      throw new Error('JSS transitions are for grades 7-9 only');\n    }\n\n    // Get current fiscal year from transition date\n    const transitionYear = new Date(data.transition_date).getFullYear();\n\n    // Get appropriate fee structure\n    const feeStructure = this.getJSSFeeStructure(data.to_grade, transitionYear);\n    if (!feeStructure) {\n      throw new Error(`No JSS fee structure found for grade ${data.to_grade}, year ${transitionYear}`);\n    }\n\n    // Calculate outstanding balance for student\n    const outstandingBalance = this.getStudentOutstandingBalance(data.student_id);\n\n    // Create transition record\n    const stmt = this.db.prepare(`\n      INSERT INTO grade_transition (\n        student_id, from_grade, to_grade, transition_date,\n        new_fee_structure_id, outstanding_balance_cents,\n        boarding_status_change, transition_notes, processed_by\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n    `);\n\n    const result = stmt.run(\n      data.student_id,\n      data.from_grade,\n      data.to_grade,\n      data.transition_date,\n      feeStructure.id,\n      outstandingBalance,\n      data.boarding_status_change || 'NO_CHANGE',\n      data.transition_notes || null,\n      data.processed_by\n    );\n\n    const transitionId = result.lastInsertRowid as number;\n\n    // Update student's enrollment stream to match new grade if possible\n    const currentEnrollment = this.db.prepare(`\n      SELECT e.id as enrollment_id, e.stream_id, e.student_type, s.is_active\n      FROM enrollment e\n      JOIN student s ON e.student_id = s.id\n      WHERE e.student_id = ? AND e.status = 'ACTIVE'\n      ORDER BY e.enrollment_date DESC\n      LIMIT 1\n    `).get(data.student_id) as { enrollment_id: number; stream_id: number; student_type: string; is_active: number } | undefined;\n\n    if (currentEnrollment) {\n      const targetStream = this.db.prepare(`\n        SELECT id FROM stream WHERE level_order = ? AND is_active = 1 ORDER BY id LIMIT 1\n      `).get(data.to_grade) as { id: number } | undefined;\n\n      const newStreamId = targetStream?.id ?? currentEnrollment.stream_id;\n\n      this.db.prepare(`\n        UPDATE enrollment\n        SET stream_id = ?, updated_at = datetime('now')\n        WHERE id = ?\n      `).run(newStreamId, currentEnrollment.enrollment_id);\n    }\n\n    // Update boarding status if changed\n    if (data.boarding_status_change && data.boarding_status_change !== 'NO_CHANGE') {\n      const newStatus = data.boarding_status_change === 'TO_BOARDER' ? 'BOARDER' : 'DAY_SCHOLAR';\n      this.db.prepare(`\n        UPDATE student\n        SET student_type = ?, updated_at = datetime('now')\n        WHERE id = ?\n      `).run(newStatus, data.student_id);\n    }\n\n    return transitionId;\n  }\n\n  /**\n   * Calculate student's outstanding balance\n   */\n  private getStudentOutstandingBalance(studentId: number): number {\n    const stmt = this.db.prepare(`\n      SELECT \n        COALESCE(SUM(total_amount - amount_paid), 0) as balance\n      FROM fee_invoice\n      WHERE student_id = ?\n    `);\n\n    const result = stmt.get(studentId) as { balance: number };\n    return result.balance;\n  }\n\n  /**\n   * Get students eligible for JSS transition\n   */\n  getEligibleStudentsForTransition(\n    fromGrade: number,\n    fiscalYear: number\n  ): StudentTransitionStatus[] {\n    const toGrade = fromGrade + 1;\n\n    // Only JSS grades\n    if (toGrade < 7 || toGrade > 9) {\n      return [];\n    }\n\n    const stmt = this.db.prepare(`\n      SELECT \n        s.id as student_id,\n        s.admission_number as admission_number,\n        s.first_name || ' ' || s.last_name as full_name,\n        st.level_order as current_grade,\n        COALESCE(e.student_type, s.student_type) as current_boarding_status\n      FROM student s\n      JOIN enrollment e ON s.id = e.student_id\n      JOIN stream st ON e.stream_id = st.id\n      WHERE st.level_order = ? AND e.status = 'ACTIVE' AND s.is_active = 1\n      ORDER BY s.last_name, s.first_name\n    `);\n\n    interface EligibleStudentResult {\n      student_id: number;\n      admission_number: string;\n      full_name: string;\n      current_grade: number;\n      current_boarding_status: 'BOARDER' | 'DAY_SCHOLAR';\n    }\n\n    const students = stmt.all(fromGrade) as EligibleStudentResult[];\n    const feeStructure = this.getJSSFeeStructure(toGrade, fiscalYear);\n\n    return students.map(student => ({\n      student_id: student.student_id,\n      admission_number: student.admission_number,\n      full_name: student.full_name,\n      current_grade: student.current_grade,\n      eligible_for_transition: true,\n      transition_to_grade: toGrade,\n      outstanding_balance_cents: this.getStudentOutstandingBalance(student.student_id),\n      boarding_status: student.current_boarding_status,\n      recommended_fee_structure: feeStructure,\n    }));\n  }\n\n  /**\n   * Batch process multiple student transitions\n   */\n  batchProcessTransitions(data: {\n    student_ids: number[];\n    from_grade: number;\n    to_grade: number;\n    transition_date: string;\n    processed_by: number;\n  }): {\n    successful: number[];\n    failed: { student_id: number; error: string }[];\n  } {\n    const successful: number[] = [];\n    const failed: { student_id: number; error: string }[] = [];\n\n    for (const studentId of data.student_ids) {\n      try {\n        const _transitionId = this.processStudentTransition({\n          student_id: studentId,\n          from_grade: data.from_grade,\n          to_grade: data.to_grade,\n          transition_date: data.transition_date,\n          processed_by: data.processed_by,\n        });\n        successful.push(studentId);\n      } catch (error) {\n        failed.push({\n          student_id: studentId,\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n      }\n    }\n\n    return { successful, failed };\n  }\n\n  /**\n   * Get transition history for a student\n   */\n  getStudentTransitionHistory(studentId: number): GradeTransition[] {\n    const stmt = this.db.prepare(`\n      SELECT * FROM grade_transition\n      WHERE student_id = ?\n      ORDER BY transition_date DESC\n    `);\n\n    return stmt.all(studentId) as GradeTransition[];\n  }\n\n  /**\n   * Get transition summary for a fiscal year\n   */\n  getTransitionSummary(fiscalYear: number): TransitionSummary {\n    const startDate = `${fiscalYear}-01-01`;\n    const endDate = `${fiscalYear}-12-31`;\n\n    const stmt = this.db.prepare(`\n      SELECT \n        COUNT(*) as total_transitions,\n        SUM(CASE WHEN from_grade = 6 AND to_grade = 7 THEN 1 ELSE 0 END) as grade_6_to_7,\n        SUM(CASE WHEN from_grade = 7 AND to_grade = 8 THEN 1 ELSE 0 END) as grade_7_to_8,\n        SUM(CASE WHEN from_grade = 8 AND to_grade = 9 THEN 1 ELSE 0 END) as grade_8_to_9,\n        SUM(CASE WHEN boarding_status_change = 'TO_BOARDER' THEN 1 ELSE 0 END) as to_boarder_count,\n        SUM(CASE WHEN boarding_status_change = 'TO_DAY_SCHOLAR' THEN 1 ELSE 0 END) as to_day_scholar_count,\n        AVG(outstanding_balance_cents) as avg_outstanding_balance_cents,\n        SUM(outstanding_balance_cents) as total_outstanding_balance_cents\n      FROM grade_transition\n      WHERE transition_date BETWEEN ? AND ?\n    `);\n\n    interface TransitionSummaryResult {\n      total_transitions: number;\n      grade_6_to_7: number;\n      grade_7_to_8: number;\n      grade_8_to_9: number;\n      to_boarder_count: number;\n      to_day_scholar_count: number;\n      avg_outstanding_balance_cents: number | null;\n      total_outstanding_balance_cents: number | null;\n    }\n\n    const result = stmt.get(startDate, endDate) as TransitionSummaryResult;\n\n    return {\n      fiscal_year: fiscalYear,\n      total_transitions: result.total_transitions || 0,\n      grade_6_to_7: result.grade_6_to_7 || 0,\n      grade_7_to_8: result.grade_7_to_8 || 0,\n      grade_8_to_9: result.grade_8_to_9 || 0,\n      to_boarder_count: result.to_boarder_count || 0,\n      to_day_scholar_count: result.to_day_scholar_count || 0,\n      avg_outstanding_balance_cents: result.avg_outstanding_balance_cents || 0,\n      total_outstanding_balance_cents: result.total_outstanding_balance_cents || 0,\n    };\n  }\n\n  /**\n   * Create or update JSS fee structure\n   */\n  setJSSFeeStructure(data: {\n    grade: number;\n    fiscal_year: number;\n    tuition_fee_cents: number;\n    boarding_fee_cents?: number;\n    activity_fee_cents?: number;\n    exam_fee_cents?: number;\n    library_fee_cents?: number;\n    lab_fee_cents?: number;\n    ict_fee_cents?: number;\n  }): number {\n    if (data.grade < 7 || data.grade > 9) {\n      throw new Error('JSS grades are 7, 8, and 9 only');\n    }\n\n    // Deactivate existing fee structure for this grade/year\n    const deactivateStmt = this.db.prepare(`\n      UPDATE jss_fee_structure\n      SET is_active = 0, updated_at = datetime('now')\n      WHERE grade = ? AND fiscal_year = ?\n    `);\n    deactivateStmt.run(data.grade, data.fiscal_year);\n\n    // Insert new fee structure\n    const stmt = this.db.prepare(`\n      INSERT INTO jss_fee_structure (\n        grade, fiscal_year, tuition_fee_cents, boarding_fee_cents,\n        activity_fee_cents, exam_fee_cents, library_fee_cents,\n        lab_fee_cents, ict_fee_cents\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n    `);\n\n    const result = stmt.run(\n      data.grade,\n      data.fiscal_year,\n      data.tuition_fee_cents,\n      data.boarding_fee_cents || null,\n      data.activity_fee_cents || null,\n      data.exam_fee_cents || null,\n      data.library_fee_cents || null,\n      data.lab_fee_cents || null,\n      data.ict_fee_cents || null\n    );\n\n    return result.lastInsertRowid as number;\n  }\n\n  /**\n   * Get total JSS fee for a student based on grade and boarding status\n   */\n  calculateJSSFeeForStudent(\n    grade: number,\n    fiscalYear: number,\n    isBoarder: boolean\n  ): number {\n    const feeStructure = this.getJSSFeeStructure(grade, fiscalYear);\n    \n    if (!feeStructure) {\n      throw new Error(`No fee structure found for grade ${grade}, year ${fiscalYear}`);\n    }\n\n    let total = feeStructure.tuition_fee_cents;\n\n    if (isBoarder && feeStructure.boarding_fee_cents) {\n      total += feeStructure.boarding_fee_cents;\n    }\n\n    total += feeStructure.activity_fee_cents || 0;\n    total += feeStructure.exam_fee_cents || 0;\n    total += feeStructure.library_fee_cents || 0;\n    total += feeStructure.lab_fee_cents || 0;\n    total += feeStructure.ict_fee_cents || 0;\n\n    return total;\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\data\\DataImportService.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2971,2974],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2971,2974],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\BankReconciliationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\BudgetService.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":128,"column":21,"nodeType":"Literal","endLine":128,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { logAudit } from '../../database/utils/audit'\nimport { BaseService } from '../base/BaseService'\n\nexport interface Budget {\n    id: number\n    budget_name: string\n    academic_year_id: number\n    term_id: number | null\n    status: 'DRAFT' | 'SUBMITTED' | 'APPROVED' | 'REJECTED' | 'ACTIVE' | 'CLOSED'\n    total_amount: number\n    notes: string | null\n    created_by_user_id: number\n    approved_by_user_id: number | null\n    approved_at: string | null\n    created_at: string\n    updated_at: string\n    // Computed\n    academic_year_name?: string\n    term_name?: string\n    created_by_name?: string\n    approved_by_name?: string\n    line_items?: BudgetLineItem[]\n    total_budgeted?: number\n    total_actual?: number\n    total_variance?: number\n}\n\nexport interface BudgetLineItem {\n    id: number\n    budget_id: number\n    category_id: number\n    description: string\n    budgeted_amount: number\n    actual_amount: number\n    variance: number\n    notes: string | null\n    category_name?: string\n    category_type?: 'INCOME' | 'EXPENSE'\n}\n\nexport interface BudgetFilters {\n    academic_year_id?: number\n    term_id?: number\n    status?: Budget['status']\n}\n\nexport interface CreateBudgetData {\n    budget_name: string\n    academic_year_id: number\n    term_id?: number\n    notes?: string\n    line_items: CreateBudgetLineItemData[]\n}\n\nexport interface CreateBudgetLineItemData {\n    category_id: number\n    description: string\n    budgeted_amount: number\n    notes?: string\n}\n\nexport class BudgetService extends BaseService<Budget, CreateBudgetData, Partial<CreateBudgetData>, BudgetFilters> {\n    protected getTableName(): string { return 'budget' }\n    protected getPrimaryKey(): string { return 'id' }\n    protected getTableAlias(): string { return 'b' }\n    protected getTablePrefix(): string { return 'b.' }\n\n    protected buildSelectQuery(): string {\n        return `\n      SELECT \n        b.*,\n        COALESCE(b.status, 'DRAFT') as status,\n        ay.year_name as academic_year_name,\n        t.term_name,\n        u1.full_name as created_by_name,\n        u2.full_name as approved_by_name,\n        COALESCE(SUM(bli.budgeted_amount), 0) as total_budgeted,\n        COALESCE(SUM(bli.actual_amount), 0) as total_actual,\n        COALESCE(SUM(bli.variance), 0) as total_variance\n      FROM budget b\n      LEFT JOIN academic_year ay ON b.academic_year_id = ay.id\n      LEFT JOIN term t ON b.term_id = t.id\n      LEFT JOIN user u1 ON b.created_by_user_id = u1.id\n      LEFT JOIN user u2 ON b.approved_by_user_id = u2.id\n      LEFT JOIN budget_line_item bli ON b.id = bli.budget_id\n    `\n    }\n\n    protected getGroupBy(): string {\n        return ' GROUP BY b.id'\n    }\n\n    protected mapRowToEntity(row: unknown): Budget {\n        return row as Budget\n    }\n\n    protected validateCreate(data: CreateBudgetData): string[] | null {\n        const errors: string[] = []\n\n        if (!data.budget_name.trim()) {\n            errors.push('Budget name is required')\n        }\n        if (!data.academic_year_id) {\n            errors.push('Academic year is required')\n        }\n        if (!data.line_items.length) {\n            errors.push('At least one budget line item is required')\n        }\n\n        data.line_items.forEach((item, index) => {\n            if (!item.category_id) {\n                errors.push(`Line item ${index + 1}: Category is required`)\n            }\n            if (!item.description.trim()) {\n                errors.push(`Line item ${index + 1}: Description is required`)\n            }\n            if (item.budgeted_amount < 0) {\n                errors.push(`Line item ${index + 1}: Amount must be positive`)\n            }\n        })\n\n        return errors.length > 0 ? errors : null\n    }\n\n    protected async validateUpdate(id: number, _data: Partial<CreateBudgetData>): Promise<string[] | null> {\n        const existing = await this.findById(id)\n        if (!existing) {\n            return ['Budget not found']\n        }\n\n        if (existing.status === 'APPROVED' || existing.status === 'CLOSED') {\n            return ['Cannot modify an approved or closed budget. Create a revision instead.']\n        }\n\n        return null\n    }\n\n    protected executeCreate(data: CreateBudgetData): { lastInsertRowid: number | bigint } {\n        const result = this.db.transaction(() => {\n            const budgetResult = this.db.prepare(`\n        INSERT INTO budget (budget_name, academic_year_id, term_id, notes, status, created_by_user_id)\n        VALUES (?, ?, ?, ?, 'DRAFT', ?)\n      `).run(\n                data.budget_name,\n                data.academic_year_id,\n                data.term_id || null,\n                data.notes || null,\n                1 // Admin user ID as fallback\n            )\n\n            const budgetId = budgetResult.lastInsertRowid as number\n\n            const insertItem = this.db.prepare(`\n        INSERT INTO budget_line_item (budget_id, category_id, description, budgeted_amount, notes)\n        VALUES (?, ?, ?, ?, ?)\n      `)\n\n            let total = 0\n            for (const item of data.line_items) {\n                insertItem.run(\n                    budgetId,\n                    item.category_id,\n                    item.description,\n                    item.budgeted_amount,\n                    item.notes || null\n                )\n                total += item.budgeted_amount\n            }\n\n            this.db.prepare('UPDATE budget SET total_amount = ? WHERE id = ?').run(total, budgetId)\n\n            return budgetResult\n        })()\n\n        return result\n    }\n\n    protected executeUpdate(id: number, data: Partial<CreateBudgetData>): void {\n        const _sets: string[] = []\n        const _params: unknown[] = []\n        // Implementation omitted for executeUpdate? No, this is replacing executeUpdate, so I should implement it or keep it.\n        // Wait, the previous attempt to replace executeUpdate failed.\n        // The file content I read shows:\n        /*\n        178:     protected executeUpdate(id: number, data: Partial<CreateBudgetData>): void {\n        179:         const sets: string[] = []\n        180:         const params: unknown[] = []\n        181:         if (filters.academic_year_id) {\n        */\n        // It seems the file IS messed up. The previous multi_replace was partially successful or left it in a bad state?\n        // Step 1266 output said \"chunk 1: replacement overlaps\".\n        // Step 1281 view_file shows that `executeUpdate` body was replaced with `const sets... const params...` AND THEN `if (filters...)`.\n        // `filters` is not defined in `executeUpdate`. `filters` belongs in `applyFilters`.\n        // I need to RESTORE `executeUpdate` and `applyFilters` properly.\n\n        // Let's reconstruct `executeUpdate` and `applyFilters`.\n        // The original `executeUpdate` (from lines 178-207 in step 1256, before my botched edit):\n        /*\n        this.db.transaction(() => { ... })()\n        */\n        // The current state (from lines 178-194 in step 1281):\n        /*\n        protected executeUpdate(id: number, data: Partial<CreateBudgetData>): void {\n            const sets: string[] = []\n            const params: unknown[] = []\n            if (filters.academic_year_id) { ... }\n        }\n        */\n        // This is definitely broken. I removed the original `executeUpdate` logic and pasted `applyFilters` logic into it, but with missing function signature for `applyFilters`.\n\n        this.db.transaction(() => {\n            if (data.budget_name || data.notes !== undefined) {\n                this.db.prepare(`\n          UPDATE budget \n          SET budget_name = COALESCE(?, budget_name),\n              notes = COALESCE(?, notes),\n              updated_at = CURRENT_TIMESTAMP\n          WHERE id = ?\n        `).run(data.budget_name, data.notes, id)\n            }\n\n            if (data.line_items) {\n                this.db.prepare('DELETE FROM budget_line_item WHERE budget_id = ?').run(id)\n\n                const insertItem = this.db.prepare(`\n          INSERT INTO budget_line_item (budget_id, category_id, description, budgeted_amount, notes)\n          VALUES (?, ?, ?, ?, ?)\n        `)\n\n                let total = 0\n                for (const item of data.line_items) {\n                    insertItem.run(id, item.category_id, item.description, item.budgeted_amount, item.notes || null)\n                    total += item.budgeted_amount\n                }\n\n                this.db.prepare('UPDATE budget SET total_amount = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?').run(total, id)\n            }\n        })()\n    }\n\n    protected applyFilters(filters: BudgetFilters, conditions: string[], params: unknown[]): void {\n        if (filters.academic_year_id) {\n            conditions.push('b.academic_year_id = ?')\n            params.push(filters.academic_year_id)\n        }\n        if (filters.term_id) {\n            conditions.push('b.term_id = ?')\n            params.push(filters.term_id)\n        }\n        if (filters.status) {\n            conditions.push('b.status = ?')\n            params.push(filters.status)\n        }\n        conditions.push('b.deleted_at IS NULL')\n    }\n\n    async getBudgetWithLineItems(budgetId: number): Promise<Budget | null> {\n        const budget = await this.findById(budgetId)\n        if (!budget) {return null}\n\n        const lineItems = this.db.prepare(`\n      SELECT bli.*, tc.category_name, tc.category_type\n      FROM budget_line_item bli\n      JOIN transaction_category tc ON bli.category_id = tc.id\n      WHERE bli.budget_id = ?\n      ORDER BY tc.category_type DESC, tc.category_name\n    `).all(budgetId) as BudgetLineItem[]\n\n        return { ...budget, line_items: lineItems }\n    }\n\n    async submitForApproval(budgetId: number, userId: number): Promise<{ success: boolean; errors?: string[] }> {\n        const budget = await this.findById(budgetId)\n        if (!budget) {return { success: false, errors: ['Budget not found'] }}\n        if (budget.status !== 'DRAFT') {return { success: false, errors: ['Only draft budgets can be submitted'] }}\n\n        this.db.prepare(`UPDATE budget SET status = 'SUBMITTED', updated_at = CURRENT_TIMESTAMP WHERE id = ?`).run(budgetId)\n        logAudit(userId, 'SUBMIT', 'budget', budgetId, { status: 'DRAFT' }, { status: 'SUBMITTED' })\n        return { success: true }\n    }\n\n    async approve(budgetId: number, userId: number): Promise<{ success: boolean; errors?: string[] }> {\n        const budget = await this.findById(budgetId)\n        if (!budget) {return { success: false, errors: ['Budget not found'] }}\n        if (budget.status !== 'SUBMITTED') {return { success: false, errors: ['Only submitted budgets can be approved'] }}\n\n        this.db.prepare(`\n      UPDATE budget \n      SET status = 'APPROVED', \n          approved_by_user_id = ?, \n          approved_at = CURRENT_TIMESTAMP,\n          updated_at = CURRENT_TIMESTAMP \n      WHERE id = ?\n    `).run(userId, budgetId)\n\n        logAudit(userId, 'APPROVE', 'budget', budgetId, { status: 'SUBMITTED' }, { status: 'APPROVED' })\n        return { success: true }\n    }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\CashFlowService.ts","messages":[{"ruleId":"sonarjs/todo-tag","severity":1,"message":"Complete the task associated to this \"TODO\" comment.","line":56,"column":12,"nodeType":null,"messageId":"completeTODO","endLine":56,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../../database'\r\n\r\nexport interface CashFlowStatement {\r\n    op_inflow: number\r\n    op_outflow: number\r\n    op_net: number\r\n    inv_inflow: number\r\n    inv_outflow: number\r\n    inv_net: number\r\n    fin_inflow: number\r\n    fin_outflow: number\r\n    fin_net: number\r\n    net_change: number\r\n    opening_balance: number\r\n    closing_balance: number\r\n}\r\n\r\nexport interface FinancialForecast {\r\n    labels: string[]\r\n    actual: number[]\r\n    projected: number[]\r\n    trend_slope: number\r\n}\r\n\r\nexport class CashFlowService {\r\n\r\n    // Calculate Cash Flow Statement (Direct Method)\r\n    static getCashFlowStatement(startDate: string, endDate: string): CashFlowStatement {\r\n        if (!db) {throw new Error('Database not initialized')}\r\n\r\n        // 1. Operating Activities\r\n        // Inflows: Fee Payments + Other Income\r\n        const feeInflow = db.prepare(`\r\n            SELECT COALESCE(SUM(amount), 0) as total \r\n            FROM receipt \r\n            WHERE receipt_date BETWEEN ? AND ?\r\n        `).get(startDate, endDate) as { total: number }\r\n\r\n        const otherIncome = db.prepare(`\r\n            SELECT COALESCE(SUM(lt.amount), 0) as total \r\n            FROM ledger_transaction lt\r\n            JOIN transaction_category tc ON lt.category_id = tc.id\r\n            WHERE lt.transaction_date BETWEEN ? AND ? \r\n            AND tc.category_type = 'INCOME'\r\n        `).get(startDate, endDate) as { total: number }\r\n\r\n        // Outflows: Expenses + Payroll (Gross)\r\n        const expenseOutflow = db.prepare(`\r\n            SELECT COALESCE(SUM(lt.amount), 0) as total \r\n            FROM ledger_transaction lt\r\n            JOIN transaction_category tc ON lt.category_id = tc.id\r\n            WHERE lt.transaction_date BETWEEN ? AND ? \r\n            AND tc.category_type = 'EXPENSE'\r\n        `).get(startDate, endDate) as { total: number }\r\n\r\n        // TODO: payroll table structure verification needed, assuming standard expenses for now if integrated\r\n        // For this MVP, we assume payroll is recorded as EXPENSE in ledger_transaction if system is integrated correctly.\r\n        // If not, we would query 'payroll' table directly. Let's add a separate query just in case it's separate.\r\n        const payrollOutflow = db.prepare(`\r\n            SELECT COALESCE(SUM(net_salary), 0) as total\r\n            FROM payroll\r\n            WHERE payment_date BETWEEN ? AND ?\r\n        `).get(startDate, endDate) as { total: number }\r\n\r\n\r\n        // 2. Investing Activities\r\n        // Outflows: Asset purchases (assuming captured in ledger with specific category or asset table)\r\n        // For now, we'll assume 'Fixed Asset' category exists in ledger.\r\n        const assetOutflow = db.prepare(`\r\n            SELECT COALESCE(SUM(lt.amount), 0) as total\r\n            FROM ledger_transaction lt\r\n            JOIN transaction_category tc ON lt.category_id = tc.id\r\n            WHERE lt.transaction_date BETWEEN ? AND ?\r\n            AND tc.category_name LIKE '%Asset%'\r\n        `).get(startDate, endDate) as { total: number }\r\n\r\n        // 3. Financing Activities\r\n        // Inflows: Loans (Liability)\r\n        // Outflows: Loan Repayment\r\n        // Placeholder for now as schema support is minimal\r\n        const finInflow = 0\r\n        const finOutflow = 0\r\n\r\n        const op_inflow = feeInflow.total + otherIncome.total\r\n        const op_outflow = expenseOutflow.total + payrollOutflow.total\r\n\r\n        // Investing logic correction: avoid double counting if assets are also expenses.\r\n        // Usually assets are capitalized, not expenses. \r\n        // We will assume Expense Ledger DOES NOT contain assets, or we filter.\r\n        // For MVP, simplistic:\r\n\r\n        const cf: CashFlowStatement = {\r\n            op_inflow,\r\n            op_outflow,\r\n            op_net: op_inflow - op_outflow,\r\n            inv_inflow: 0,\r\n            inv_outflow: assetOutflow.total,\r\n            inv_net: 0 - assetOutflow.total,\r\n            fin_inflow: finInflow,\r\n            fin_outflow: finOutflow,\r\n            fin_net: finInflow - finOutflow,\r\n            net_change: 0,\r\n            opening_balance: 0,\r\n            closing_balance: 0\r\n        }\r\n\r\n        cf.net_change = cf.op_net + cf.inv_net + cf.fin_net\r\n\r\n        // Opening Balance: Sum of all net flows prior to startDate\r\n        // This is expensive to calc from scratch every time. \r\n        // Better to check 'bank_account' current balance, but that's \"Closing\".\r\n        // Opening = Closing - NetChange(Period). \r\n        // Or Opening = Sum(All Historic) < StartDate.\r\n        // Let's use simple sum for MVP reliability.\r\n        /*\r\n        const historicIn = db.prepare('SELECT SUM(amount) as t FROM receipt WHERE payment_date < ?').get(startDate).t || 0\r\n        const historicOut = db.prepare('SELECT SUM(amount) as t FROM ledger_transaction WHERE transaction_date < ? AND type=\"EXPENSE\"').get(startDate).t || 0\r\n        cf.opening_balance = historicIn - historicOut\r\n        */\r\n\r\n        // Correct approach: Sum of all Bank Accounts Opening Balances + Transactions < StartDate\r\n        // Assuming we rely on cash flow sum:\r\n        cf.opening_balance = 0 // Placeholder logic to be refined with Bank Account table\r\n        cf.closing_balance = cf.opening_balance + cf.net_change\r\n\r\n        return cf\r\n    }\r\n\r\n    static getForecast(monthsToProject: number = 6): FinancialForecast {\r\n        if (!db) {throw new Error('Database not initialized')}\r\n\r\n        // 1. Get last 6 months actuals\r\n        // Group by month\r\n        const results = db.prepare(`\r\n            SELECT strftime('%Y-%m', receipt_date) as m, SUM(amount) as total\r\n            FROM receipt\r\n            WHERE receipt_date >= date('now', '-6 months')\r\n            GROUP BY m\r\n            ORDER BY m ASC\r\n        `).all() as { m: string, total: number }[]\r\n\r\n        // Calculate simple trend (average)\r\n        const avg = results.reduce((a, b) => a + b.total, 0) / (results.length || 1)\r\n\r\n        // Project\r\n        const labels = results.map(r => r.m)\r\n        const actual = results.map(r => r.total)\r\n        const projected: number[] = []\r\n\r\n        const lastMonth = new Date()\r\n        for (let i = 0; i < monthsToProject; i++) {\r\n            lastMonth.setMonth(lastMonth.getMonth() + 1)\r\n            const mStr = lastMonth.toISOString().slice(0, 7)\r\n            labels.push(mStr)\r\n            projected.push(avg) // Linear projection for MVP\r\n        }\r\n\r\n        // Pad actuals with nulls for chart\r\n        // Pad projected with nulls for first part\r\n\r\n        return {\r\n            labels,\r\n            actual,\r\n            projected: [...Array(results.length).fill(null), ...projected],\r\n            trend_slope: 0\r\n        }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\CreditAutoApplicationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\ExemptionService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\FeeProrationService.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'generateProRatedInvoice' has too many lines (87). Maximum allowed is 80.","line":303,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":408,"endColumn":4},{"ruleId":"sonarjs/pseudo-random","severity":1,"message":"Make sure that using this pseudorandom number generator is safe here.","line":508,"column":50,"nodeType":"CallExpression","messageId":"safeGenerator","endLine":508,"endColumn":63},{"ruleId":"sonarjs/deprecation","severity":1,"message":"'(from: number, length?: number | undefined): string' is deprecated.","line":508,"column":77,"nodeType":null,"messageId":"deprecation","endLine":508,"endColumn":83},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (512). Maximum allowed is 500.","line":634,"column":1,"nodeType":null,"messageId":"exceed","endLine":659,"endColumn":1}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { getDatabase } from '../../database'\nimport { logAudit } from '../../database/utils/audit'\n\nimport type Database from 'better-sqlite3'\n\n// ============================================================================\n// DATA STRUCTURES\n// ============================================================================\n\nexport interface ProRationLogEntry {\n  id: number\n  invoice_id: number\n  student_id: number\n  full_amount: number\n  pro_rated_amount: number\n  discount_percentage: number\n  enrollment_date: string\n  term_start: string\n  term_end: string\n  days_in_term: number\n  days_enrolled: number\n  created_at: string\n  invoice_number?: string\n  description?: string\n}\n\nexport interface ProrationDetail extends ProRationLogEntry {\n  invoice_number: string\n  invoice_date: string\n  invoice_type: string\n  original_amount: number\n  prorated_amount: number\n}\n\nexport interface GenerateProRatedInvoiceInput {\n  studentId: number\n  enrollmentDate: string\n  grade: string\n  userId: number\n}\n\n// ============================================================================\n// SEGREGATED INTERFACES (ISP)\n// ============================================================================\n\nexport interface IProRateCalculator {\n  calculateProRatedFee(fullAmount: number, termStartDate: string, termEndDate: string, enrollmentDate: string): ProRationResult\n}\n\nexport interface ITermDateValidator {\n  validateEnrollmentDate(termStartDate: string, termEndDate: string, enrollmentDate: string): ValidationResult\n}\n\nexport interface IProRatedInvoiceGenerator {\n  generateProRatedInvoice(studentId: number, templateInvoiceId: number, enrollmentDate: string, userId: number): Promise<InvoiceGenerationResult>\n}\n\nexport interface ProRationResult {\n  full_amount: number\n  pro_rated_amount: number\n  discount_percentage: number\n  days_in_term: number\n  days_enrolled: number\n  enrollment_date: string\n  calculation_method: 'DAILY' | 'WEEKLY' | 'MONTHLY'\n}\n\nexport interface ValidationResult {\n  valid: boolean\n  message: string\n}\n\nexport interface InvoiceGenerationResult {\n  success: boolean\n  message: string\n  invoice_id?: number\n  pro_ration_details?: ProRationResult\n}\n\nexport interface InvoiceTemplate {\n  id: number\n  student_id: number\n  amount: number\n  amount_paid: number\n  due_date: string\n  invoice_date: string\n  invoice_number: string\n  description: string\n  invoice_type: string\n  term_id: number\n  class_id: number\n  status: string\n  grade?: string // For template lookup\n}\n\n// ============================================================================\n// REPOSITORY LAYER (SRP)\n// ============================================================================\n\nclass InvoiceTemplateRepository {\n  private db: Database.Database\n\n  constructor(db?: Database.Database) {\n    this.db = db || getDatabase()\n  }\n\n  async getInvoiceTemplate(templateId: number): Promise<InvoiceTemplate | undefined> {\n    const db = this.db\n    return db.prepare(`\n      SELECT * FROM fee_invoice WHERE id = ?\n    `).get(templateId) as InvoiceTemplate | undefined\n  }\n\n  async getTermDates(termId: number): Promise<{ term_start: string; term_end: string } | null> {\n    const db = this.db\n    const result = db.prepare(`\n      SELECT start_date, end_date FROM academic_term WHERE id = ?\n    `).get(termId) as { start_date: string; end_date: string } | undefined\n\n    if (!result) {return null}\n\n    return {\n      term_start: result.start_date,\n      term_end: result.end_date\n    }\n  }\n}\n\nclass ProRatedInvoiceRepository {\n  private db: Database.Database\n\n  constructor(db?: Database.Database) {\n    this.db = db || getDatabase()\n  }\n\n  async createProRatedInvoice(data: {\n    student_id: number\n    amount: number\n    original_amount?: number\n    due_date: string\n    invoice_date: string\n    description: string\n    invoice_type: string\n    term_id: number\n    academic_term_id?: number\n    class_id: number\n    created_by_user_id: number\n  }): Promise<number> {\n    const db = this.db\n    const invoiceNumber = `INV-${Date.now()}`\n    const academicTermId = data.academic_term_id ?? data.term_id\n    const originalAmount = data.original_amount ?? data.amount\n\n    const result = db.prepare(`\n      INSERT INTO fee_invoice (\n        student_id, term_id, academic_term_id, invoice_date, due_date,\n        total_amount, amount, amount_due, original_amount, amount_paid,\n        invoice_number, description, invoice_type, class_id, status, created_by_user_id\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?, ?, ?, ?, 'PENDING', ?)\n    `).run(\n      data.student_id,\n      data.term_id,\n      academicTermId,\n      data.invoice_date,\n      data.due_date,\n      data.amount,\n      data.amount,\n      data.amount,\n      originalAmount,\n      invoiceNumber,\n      data.description,\n      data.invoice_type,\n      data.class_id,\n      data.created_by_user_id\n    )\n\n    return result.lastInsertRowid as number\n  }\n\n  async recordProRationLog(data: {\n    invoice_id: number\n    student_id: number\n    full_amount: number\n    pro_rated_amount: number\n    discount_percentage: number\n    enrollment_date: string\n    term_start: string\n    term_end: string\n    days_in_term: number\n    days_enrolled: number\n  }): Promise<void> {\n    const db = this.db\n    db.prepare(`\n      INSERT INTO pro_ration_log (\n        invoice_id, student_id, full_amount, pro_rated_amount,\n        discount_percentage, enrollment_date, term_start, term_end,\n        days_in_term, days_enrolled\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n    `).run(\n      data.invoice_id,\n      data.student_id,\n      data.full_amount,\n      data.pro_rated_amount,\n      data.discount_percentage,\n      data.enrollment_date,\n      data.term_start,\n      data.term_end,\n      data.days_in_term,\n      data.days_enrolled\n    )\n  }\n}\n\n// ============================================================================\n// BUSINESS LOGIC LAYER (SRP)\n// ============================================================================\n\nclass ProRateCalculator implements IProRateCalculator {\n  calculateProRatedFee(\n    fullAmount: number,\n    termStartDate: string,\n    termEndDate: string,\n    enrollmentDate: string\n  ): ProRationResult {\n    const termStart = new Date(termStartDate)\n    const termEnd = new Date(termEndDate)\n    const enrollment = new Date(enrollmentDate)\n\n    // Calculate days\n    const daysInTerm = Math.ceil((termEnd.getTime() - termStart.getTime()) / (1000 * 60 * 60 * 24))\n    const daysEnrolled = Math.ceil((termEnd.getTime() - enrollment.getTime()) / (1000 * 60 * 60 * 24))\n\n    // Calculate pro-rated amount\n    const discountPercentage = ((daysInTerm - daysEnrolled) / daysInTerm) * 100\n    const proRatedAmount = fullAmount * (daysEnrolled / daysInTerm)\n\n    return {\n      full_amount: fullAmount,\n      pro_rated_amount: Math.round(proRatedAmount), // Round to integer cents\n      discount_percentage: Math.round(discountPercentage * 100) / 100,\n      days_in_term: daysInTerm,\n      days_enrolled: daysEnrolled,\n      enrollment_date: enrollmentDate,\n      calculation_method: 'DAILY'\n    }\n  }\n}\n\nclass TermDateValidator implements ITermDateValidator {\n  validateEnrollmentDate(\n    termStartDate: string,\n    termEndDate: string,\n    enrollmentDate: string\n  ): ValidationResult {\n    const termStart = new Date(termStartDate)\n    const termEnd = new Date(termEndDate)\n    const enrollment = new Date(enrollmentDate)\n\n    // Check if enrollment date is within term\n    if (enrollment < termStart) {\n      return {\n        valid: false,\n        message: 'Enrollment date cannot be before term start date'\n      }\n    }\n\n    if (enrollment > termEnd) {\n      return {\n        valid: false,\n        message: 'Enrollment date cannot be after term end date'\n      }\n    }\n\n    // Check if enrollment is on term start (no proration needed)\n    if (enrollment.getTime() === termStart.getTime()) {\n      return {\n        valid: false,\n        message: 'Enrollment is on term start date - full fee applies, no proration needed'\n      }\n    }\n\n    return {\n      valid: true,\n      message: 'Enrollment date is valid for proration'\n    }\n  }\n}\n\nclass ProRatedInvoiceGenerator implements IProRatedInvoiceGenerator {\n  private db: Database.Database\n\n  constructor(\n    private templateRepo: InvoiceTemplateRepository,\n    private invoiceRepo: ProRatedInvoiceRepository,\n    private calculator: ProRateCalculator,\n    private validator: TermDateValidator,\n    db?: Database.Database\n  ) {\n    this.db = db || getDatabase()\n  }\n\n  async generateProRatedInvoice(\n    studentId: number,\n    templateInvoiceId: number,\n    enrollmentDate: string,\n    userId: number\n  ): Promise<InvoiceGenerationResult> {\n    const _db = this.db\n\n    try {\n      // Get template invoice\n      const template = await this.templateRepo.getInvoiceTemplate(templateInvoiceId)\n\n      if (!template) {\n        return {\n          success: false,\n          message: 'Template invoice not found'\n        }\n      }\n\n      // Get term dates\n      const termDates = await this.templateRepo.getTermDates(template.term_id)\n\n      if (!termDates) {\n        return {\n          success: false,\n          message: 'Term dates not found'\n        }\n      }\n\n      // Validate enrollment date\n      const validation = this.validator.validateEnrollmentDate(\n        termDates.term_start,\n        termDates.term_end,\n        enrollmentDate\n      )\n\n      if (!validation.valid) {\n        return {\n          success: false,\n          message: validation.message\n        }\n      }\n\n      // Calculate pro-rated fee\n      const proRation = this.calculator.calculateProRatedFee(\n        template.amount,\n        termDates.term_start,\n        termDates.term_end,\n        enrollmentDate\n      )\n\n      // Create pro-rated invoice\n      const invoiceId = await this.invoiceRepo.createProRatedInvoice({\n        student_id: studentId,\n        amount: proRation.pro_rated_amount,\n        original_amount: proRation.full_amount,\n        due_date: template.due_date,\n        invoice_date: new Date().toISOString().split('T')[0],\n        description: `${template.description} (Pro-rated: ${proRation.discount_percentage.toFixed(1)}% discount)`,\n        invoice_type: template.invoice_type,\n        term_id: template.term_id,\n        academic_term_id: template.term_id,\n        class_id: template.class_id,\n        created_by_user_id: userId\n      })\n\n      // Record proration log\n      await this.invoiceRepo.recordProRationLog({\n        invoice_id: invoiceId,\n        student_id: studentId,\n        full_amount: proRation.full_amount,\n        pro_rated_amount: proRation.pro_rated_amount,\n        discount_percentage: proRation.discount_percentage,\n        enrollment_date: enrollmentDate,\n        term_start: termDates.term_start,\n        term_end: termDates.term_end,\n        days_in_term: proRation.days_in_term,\n        days_enrolled: proRation.days_enrolled\n      })\n\n      // Audit log\n      logAudit(\n        userId,\n        'CREATE_PRORATED_INVOICE',\n        'fee_invoice',\n        invoiceId,\n        null,\n        {\n          student_id: studentId,\n          full_amount: proRation.full_amount,\n          pro_rated_amount: proRation.pro_rated_amount,\n          discount_percentage: proRation.discount_percentage\n        }\n      )\n\n      return {\n        success: true,\n        message: `Pro-rated invoice created: ${(proRation.pro_rated_amount / 100).toFixed(2)} KES (${proRation.discount_percentage.toFixed(1)}% discount)`,\n        invoice_id: invoiceId,\n        pro_ration_details: proRation\n      }\n\n    } catch (error) {\n      throw new Error(`Failed to generate pro-rated invoice: ${(error as Error).message}`)\n    }\n  }\n}\n\n// ============================================================================\n// FACADE SERVICE (Composition, DIP)\n// ============================================================================\n\nexport class FeeProrationService implements IProRateCalculator, ITermDateValidator, IProRatedInvoiceGenerator {\n  private db: Database.Database\n  private readonly calculator: ProRateCalculator\n  private readonly validator: TermDateValidator\n  private readonly invoiceGenerator: ProRatedInvoiceGenerator\n\n  constructor(db?: Database.Database) {\n    this.db = db || getDatabase()\n    this.calculator = new ProRateCalculator()\n    this.validator = new TermDateValidator()\n\n    const templateRepo = new InvoiceTemplateRepository(this.db)\n    const invoiceRepo = new ProRatedInvoiceRepository(this.db)\n\n    this.invoiceGenerator = new ProRatedInvoiceGenerator(\n      templateRepo,\n      invoiceRepo,\n      this.calculator,\n      this.validator,\n      this.db\n    )\n  }\n\n  /**\n   * Calculate pro-rated fee for mid-term enrollment\n   */\n  calculateProRatedFee(\n    fullAmount: number,\n    termStartDate: string,\n    termEndDate: string,\n    enrollmentDate: string\n  ): ProRationResult {\n    return this.calculator.calculateProRatedFee(fullAmount, termStartDate, termEndDate, enrollmentDate)\n  }\n\n  /**\n   * Validate enrollment date is within term and requires proration\n   */\n  validateEnrollmentDate(\n    termStartDate: string,\n    termEndDate: string,\n    enrollmentDate: string\n  ): ValidationResult {\n    return this.validator.validateEnrollmentDate(termStartDate, termEndDate, enrollmentDate)\n  }\n\n  /**\n   * Generate pro-rated invoice for mid-term enrollment\n   */\n  // Synchronous wrapper for test compatibility\n  generateProRatedInvoiceSync(data: GenerateProRatedInvoiceInput): InvoiceGenerationResult {\n    const db = this.db\n    \n    try {\n      // Find invoice template for the grade\n      const template = db.prepare(`\n        SELECT * FROM invoice_template WHERE grade = ? LIMIT 1\n      `).get(data.grade) as { amount: number } | undefined\n\n      if (!template) {\n        return {\n          success: false,\n          message: 'No invoice template found for grade: ' + data.grade\n        }\n      }\n\n      // Get term dates\n      const term = db.prepare(`\n        SELECT id, start_date, end_date FROM academic_term WHERE is_current = 1\n      `).get() as { id: number; start_date: string; end_date: string } | undefined\n\n      if (!term) {\n        return {\n          success: false,\n          message: 'No current term found'\n        }\n      }\n\n      const termStartDate = term.start_date\n      const termEndDate = term.end_date\n      const termId = term.id\n      const enrollment = new Date(data.enrollmentDate)\n      const termStart = new Date(termStartDate)\n      const termEnd = new Date(termEndDate)\n\n      // Calculate days\n      const daysInTerm = Math.ceil((termEnd.getTime() - termStart.getTime()) / (1000 * 60 * 60 * 24)) + 1\n      const daysEnrolled = Math.ceil((termEnd.getTime() - enrollment.getTime()) / (1000 * 60 * 60 * 24)) + 1\n      const prorationType = (daysEnrolled / daysInTerm) * 100\n      const discountPercentage = ((daysInTerm - daysEnrolled) / daysInTerm) * 100\n      const proratedAmount = template.amount * (daysEnrolled / daysInTerm)\n\n      // Create invoice with unique invoice number\n      const invoiceNumber = `INV-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`\n      const invoiceResult = db.prepare(`\n        INSERT INTO fee_invoice (\n          student_id, term_id, academic_term_id, invoice_number,\n          total_amount, amount, amount_due, original_amount, amount_paid,\n          is_prorated, proration_percentage, created_at, status, created_by_user_id\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, 1, ?, ?, 'PENDING', ?)\n      `).run(data.studentId, termId, termId, invoiceNumber, proratedAmount, proratedAmount, proratedAmount, template.amount, prorationType, new Date().toISOString(), data.userId)\n\n      const invoiceId = invoiceResult.lastInsertRowid\n\n      // Record proration log\n      db.prepare(`\n        INSERT INTO pro_ration_log (\n          student_id, invoice_id, enrollment_date, term_start, term_end,\n          days_in_term, days_enrolled, discount_percentage, full_amount, pro_rated_amount, created_at\n        )\n        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n      `).run(data.studentId, invoiceId, data.enrollmentDate, termStartDate, termEndDate, daysInTerm, daysEnrolled, discountPercentage, template.amount, proratedAmount, new Date().toISOString())\n\n      logAudit(\n        data.userId,\n        'CREATE_PRORATED_INVOICE',\n        'fee_invoice',\n        Number(invoiceId),\n        null,\n        {\n          student_id: data.studentId,\n          original_amount: template.amount,\n          prorated_amount: proratedAmount,\n          proration_percentage: discountPercentage\n        }\n      )\n\n      return {\n        success: true,\n        message: `Pro-rated invoice created: ${(proratedAmount / 100).toFixed(2)} KES (${discountPercentage.toFixed(1)}% discount)`,\n        invoice_id: Number(invoiceId)\n      }\n    } catch (error) {\n      return {\n        success: false,\n        message: `Failed to generate pro-rated invoice: ${(error as Error).message}`\n      }\n    }\n  }\n\n  async generateProRatedInvoice(\n    studentIdOrData: number | GenerateProRatedInvoiceInput,\n    templateInvoiceId?: number,\n    enrollmentDate?: string,\n    userId?: number\n  ): Promise<InvoiceGenerationResult> {\n    // Handle both API styles\n    if (typeof studentIdOrData === 'object') {\n      // New style: { studentId, enrollmentDate, grade, userId }\n      return this.generateProRatedInvoiceSync(studentIdOrData)\n    } else {\n      // Old style: (studentId, templateInvoiceId, enrollmentDate, userId)\n      return this.invoiceGenerator.generateProRatedInvoice(studentIdOrData, templateInvoiceId!, enrollmentDate!, userId!)\n    }\n  }\n\n  /**\n   * Get proration history for a student\n   */\n  async getStudentProRationHistory(studentId: number): Promise<ProRationLogEntry[]> {\n    const db = this.db\n    return db.prepare(`\n      SELECT \n        pl.*,\n        fi.invoice_number,\n        fi.description\n      FROM pro_ration_log pl\n      LEFT JOIN fee_invoice fi ON pl.invoice_id = fi.id\n      WHERE pl.student_id = ?\n      ORDER BY pl.created_at DESC\n    `).all(studentId) as ProRationLogEntry[]\n  }\n\n  /**\n   * Get proration details for a student\n   */\n  getProrationDetails(studentId: number): ProrationDetail[] {\n    const db = this.db\n    const result = db.prepare(`\n      SELECT \n        fi.*,\n        pl.full_amount as original_amount,\n        pl.pro_rated_amount as prorated_amount,\n        pl.discount_percentage,\n        pl.days_in_term,\n        pl.days_enrolled,\n        pl.enrollment_date\n      FROM fee_invoice fi\n      LEFT JOIN pro_ration_log pl ON pl.invoice_id = fi.id\n      WHERE fi.student_id = ? AND fi.is_prorated = 1\n      ORDER BY fi.created_at DESC\n    `).all(studentId) as ProrationDetail[]\n    \n    return result\n  }\n\n  /**\n   * Get proration history (alias for getStudentProRationHistory)\n   */\n  getProrationHistory(studentId: number, startDate?: string, endDate?: string): ProRationLogEntry[] {\n    const db = this.db\n    let query = `\n      SELECT \n        pl.*,\n        fi.invoice_number\n      FROM pro_ration_log pl\n      LEFT JOIN fee_invoice fi ON pl.invoice_id = fi.id\n      WHERE pl.student_id = ?\n    `\n    \n    const params: (string | number)[] = [studentId]\n    \n    if (startDate && endDate) {\n      query += ` AND pl.created_at BETWEEN ? AND ?`\n      params.push(startDate, endDate)\n    }\n    \n    query += ` ORDER BY pl.created_at DESC`\n    \n    return db.prepare(query).all(...params) as ProRationLogEntry[]\n  }\n\n  /**\n   * Calculate proration percentage based on enrollment date\n   */\n  calculateProrationPercentage(enrollmentDate: string, termStartDate: string, termEndDate: string): number {\n    const termStart = new Date(termStartDate)\n    const termEnd = new Date(termEndDate)\n    const enrollment = new Date(enrollmentDate)\n\n    // Calculate days in term\n    const daysInTerm = Math.ceil((termEnd.getTime() - termStart.getTime()) / (1000 * 60 * 60 * 24)) + 1\n\n    // Calculate days enrolled\n    const daysEnrolled = Math.ceil((termEnd.getTime() - enrollment.getTime()) / (1000 * 60 * 60 * 24)) + 1\n\n    // Calculate percentage\n    const percentage = (daysEnrolled / daysInTerm) * 100\n\n    // Round to 2 decimal places\n    return Math.round(percentage * 100) / 100\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\FixedAssetService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\GLAccountService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\HireService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\PaymentIntegrationService.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'recordPaymentDualSystem' has too many lines (147). Maximum allowed is 80.","line":97,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":282,"endColumn":4},{"ruleId":"complexity","severity":1,"message":"Async method 'recordPaymentDualSystem' has a complexity of 16. Maximum allowed is 12.","line":97,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":97,"endColumn":32},{"ruleId":"max-statements","severity":1,"message":"Async method 'recordPaymentDualSystem' has too many statements (44). Maximum allowed is 30.","line":97,"column":32,"nodeType":"FunctionExpression","messageId":"exceed","endLine":282,"endColumn":4}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Payment Integration Service\r\n * \r\n * Bridges the legacy payment system with the new double-entry accounting system.\r\n * Maintains backward compatibility while leveraging new accounting features.\r\n * \r\n * Migration Strategy:\r\n * 1. Records payment in legacy ledger_transaction table (for compatibility)\r\n * 2. Creates corresponding journal entry in double-entry system\r\n * 3. Synchronizes both systems\r\n * \r\n * Future: Once all reports and features migrate to double-entry, \r\n * the legacy system calls can be removed.\r\n */\r\n\r\n\r\nimport { getDatabase } from '../../database';\r\nimport { logAudit } from '../../database/utils/audit';\r\nimport { DoubleEntryJournalService, type JournalEntryData } from '../accounting/DoubleEntryJournalService';\n\r\nimport type Database from 'better-sqlite3';\n\r\nexport interface PaymentIntegrationData {\n  student_id: number;\n  amount: number; // In cents\n  payment_method: 'CASH' | 'MPESA' | 'BANK_TRANSFER' | 'CHEQUE' | 'CREDIT_BALANCE';\n  transaction_date: string; // ISO date string\r\n  description?: string;\r\n  payment_reference?: string;\r\n  term_id?: number;\r\n  invoice_id?: number;\r\n  amount_in_words?: string;\r\n}\r\n\r\nexport interface PaymentIntegrationResult {\r\n  success: boolean;\r\n  message?: string;\r\n  transactionRef?: string;\r\n  receiptNumber?: string;\r\n  journalEntryId?: number;\r\n  legacyTransactionId?: number;\r\n}\r\n\r\nexport interface DoubleEntryPaymentData {\r\n  student_id: number;\r\n  amount: number;\r\n  payment_date: string;\r\n  payment_method: 'CASH' | 'MPESA' | 'BANK_TRANSFER' | 'CHEQUE';\r\n  reference: string;\r\n  description?: string;\r\n  recorded_by: number;\r\n  invoice_id?: number;\r\n  term_id?: number;\r\n}\r\n\r\nexport interface PaymentResult {\r\n  success: boolean;\r\n  message: string;\r\n  transaction_id?: number;\r\n  journal_entry_id?: number;\r\n  receipt_number?: string;\r\n  requires_approval?: boolean;\r\n}\r\n\r\nexport interface VoidPaymentData {\r\n  transaction_id: number;\r\n  void_reason: string;\r\n  voided_by: number;\r\n  recovery_method?: string;\r\n}\r\n\r\nexport interface PaymentHistoryEntry {\r\n  id: number;\r\n  entry_ref: string;\r\n  transaction_date: string;\r\n  description: string;\r\n  amount: number;\r\n  receipt_number: string | null;\r\n  payment_method: string | null;\r\n  reference: string | null;\r\n  is_voided: number;\r\n  voided_reason: string | null;\r\n}\r\n\r\nexport class PaymentIntegrationService {\r\n  private db: Database.Database;\r\n  private journalService: DoubleEntryJournalService;\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase();\r\n    this.journalService = new DoubleEntryJournalService(this.db);\r\n  }\r\n\r\n  /**\r\n   * Records a payment in both legacy and new accounting systems\r\n   */\r\n  async recordPaymentDualSystem(\n    data: PaymentIntegrationData,\n    userId: number\n  ): Promise<PaymentIntegrationResult> {\n    // Use manual transaction to allow async operations (await)\r\n    const db = this.db;\r\n    db.prepare('BEGIN').run();\r\n\r\n    try {\r\n      // Amounts are stored in cents across the system\n      const amountCents = Math.round(data.amount);\n      const description = data.description || 'Tuition Fee Payment';\r\n      const paymentRef = data.payment_reference || '';\r\n\r\n      // Generate reference numbers\r\n      const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');\r\n      const timestamp = String(Date.now()).slice(-6);\r\n      const txnRef = `TXN-${dateStr}-${timestamp}`;\r\n      const rcpNum = `RCP-${dateStr}-${timestamp}`;\r\n\r\n      // ===== STEP 1: Record in Legacy System =====\r\n      const legacyTxnStmt = this.db.prepare(`\r\n        INSERT INTO ledger_transaction (\r\n          transaction_ref, transaction_date, transaction_type, category_id, amount, debit_credit,\r\n          student_id, payment_method, payment_reference, description, term_id, recorded_by_user_id, invoice_id\r\n        ) VALUES (?, ?, 'FEE_PAYMENT', (SELECT id FROM transaction_category WHERE category_name = 'School Fees'), ?, 'CREDIT', ?, ?, ?, ?, ?, ?, ?)\r\n      `);\r\n\r\n      const legacyResult = legacyTxnStmt.run(\r\n        txnRef,\r\n        data.transaction_date,\r\n        amountCents,\r\n        data.student_id,\r\n        data.payment_method,\r\n        paymentRef,\r\n        description,\r\n        data.term_id || null,\r\n        userId,\r\n        data.invoice_id || null\r\n      );\r\n\r\n      const legacyTransactionId = legacyResult.lastInsertRowid as number;\r\n\r\n      // Audit log for legacy transaction\r\n      logAudit(userId, 'CREATE', 'ledger_transaction', legacyTransactionId, null, {\r\n        ...data,\r\n        amount: amountCents,\r\n      });\r\n\r\n      // Create receipt in legacy system\r\n      const rcpStmt = this.db.prepare(`\r\n        INSERT INTO receipt (\r\n          receipt_number, transaction_id, receipt_date, student_id, amount,\r\n          amount_in_words, payment_method, payment_reference, created_by_user_id\r\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n      `);\r\n\r\n      rcpStmt.run(\r\n        rcpNum,\r\n        legacyTransactionId,\r\n        data.transaction_date,\r\n        data.student_id,\r\n        amountCents,\r\n        data.amount_in_words || '',\r\n        data.payment_method,\r\n        paymentRef,\r\n        userId\r\n      );\r\n\r\n      // ===== STEP 2: Record in Double-Entry System =====\r\n      let journalEntryId: number | undefined;\r\n\r\n      // Only process double-entry if payment method is compatible\r\n      if (['CASH', 'MPESA', 'BANK_TRANSFER', 'CHEQUE'].includes(data.payment_method)) {\r\n        try {\r\n          const paymentResult = await this.createDoubleEntryRecord({\n            student_id: data.student_id,\n            amount: amountCents, // In cents\n            payment_method: data.payment_method as 'CASH' | 'MPESA' | 'BANK_TRANSFER' | 'CHEQUE',\n            payment_date: data.transaction_date,\n            description,\r\n            reference: paymentRef,\r\n            term_id: data.term_id,\r\n            invoice_id: data.invoice_id,\r\n            recorded_by: userId\r\n          });\r\n\r\n          if (paymentResult.success && paymentResult.journal_entry_id) {\r\n            journalEntryId = paymentResult.journal_entry_id;\r\n\r\n            // Link legacy transaction to journal entry\r\n            this.db\r\n              .prepare(\r\n                'UPDATE ledger_transaction SET journal_entry_id = ? WHERE id = ?'\r\n              )\r\n              .run(journalEntryId, legacyTransactionId);\r\n          }\r\n        } catch (journalError) {\r\n          console.error('Failed to create journal entry:', journalError);\r\n          // Don't fail the entire transaction - legacy system still recorded\r\n          // This allows gradual migration\r\n        }\r\n      }\r\n\r\n      // ===== STEP 3: Apply Payment to Invoices (Legacy Logic) =====\r\n      let remainingAmount = amountCents;\r\n\r\n      if (data.invoice_id) {\r\n        // Apply to specific invoice\r\n        const inv = this.db\r\n          .prepare('SELECT total_amount, amount_paid FROM fee_invoice WHERE id = ?')\r\n          .get(data.invoice_id) as\r\n          | { total_amount: number; amount_paid: number }\r\n          | undefined;\r\n\r\n        if (inv) {\r\n          this.db\r\n            .prepare(`\r\n              UPDATE fee_invoice \r\n              SET amount_paid = amount_paid + ?, \r\n                  status = CASE WHEN amount_paid + ? >= total_amount THEN 'PAID' ELSE 'PARTIAL' END \r\n              WHERE id = ?\r\n            `)\r\n            .run(amountCents, amountCents, data.invoice_id);\r\n        }\r\n      } else {\r\n        // Apply to oldest unpaid invoices (FIFO)\r\n        const pendingInvoices = this.db\r\n          .prepare(`\r\n            SELECT id, total_amount, amount_paid \r\n            FROM fee_invoice \r\n            WHERE student_id = ? AND status != 'PAID'\r\n            ORDER BY invoice_date ASC\r\n          `)\r\n          .all(data.student_id) as Array<{\r\n          id: number;\r\n          total_amount: number;\r\n          amount_paid: number;\r\n        }>;\r\n\r\n        const updateInvStmt = this.db.prepare(`\r\n          UPDATE fee_invoice \r\n          SET amount_paid = amount_paid + ?, \r\n              status = CASE WHEN amount_paid + ? >= total_amount THEN 'PAID' ELSE 'PARTIAL' END \r\n          WHERE id = ?\r\n        `);\r\n\r\n        for (const inv of pendingInvoices) {\r\n          if (remainingAmount <= 0) {break;}\r\n\r\n          const outstanding = inv.total_amount - (inv.amount_paid || 0);\r\n          const payAmount = Math.min(remainingAmount, outstanding);\r\n\r\n          updateInvStmt.run(payAmount, payAmount, inv.id);\r\n          remainingAmount -= payAmount;\r\n        }\r\n      }\r\n      \r\n      // ===== STEP 4: Update Student Credit Balance =====\r\n      // Update denormalized credit_balance for backward compatibility\r\n      // Note: This logic was present in EnhancedPaymentService but missing in PaymentIntegrationService\r\n      this.db.prepare(`\n        UPDATE student\n        SET credit_balance = COALESCE(credit_balance, 0) + ?\n        WHERE id = ?\n      `).run(amountCents, data.student_id);\n\r\n      db.prepare('COMMIT').run();\r\n\r\n      return {\r\n        success: true,\r\n        message: 'Payment recorded successfully',\r\n        transactionRef: txnRef,\r\n        receiptNumber: rcpNum,\r\n        journalEntryId,\r\n        legacyTransactionId,\r\n      };\r\n    } catch (error) {\r\n      db.prepare('ROLLBACK').run();\r\n      console.error('Payment recording failed:', error);\r\n      return {\r\n        success: false,\r\n        message: `Failed to record payment: ${(error as Error).message}`,\r\n      };\r\n    }\r\n  }\r\n\r\n  // ============================================================================\r\n  // DOUBLE ENTRY INTEGRATION METHODS (Merged from EnhancedPaymentService)\r\n  // ============================================================================\r\n\r\n  /**\r\n   * Creates a journal entry for the payment\r\n   */\r\n  private async createDoubleEntryRecord(data: DoubleEntryPaymentData): Promise<PaymentResult> {\r\n    try {\r\n      // Validate student exists\r\n      const student = this.db.prepare(`\r\n        SELECT id, admission_number, first_name || ' ' || last_name as full_name\r\n        FROM student WHERE id = ?\r\n      `).get(data.student_id) as { id: number; admission_number: string; full_name: string } | undefined;\r\n\r\n      if (!student) {\r\n        return {\r\n          success: false,\r\n          message: `Student with ID ${data.student_id} not found`\r\n        };\r\n      }\r\n\r\n      // Determine GL account based on payment method\r\n      const cashAccountCode = this.getCashAccountCode(data.payment_method);\r\n\r\n      // Create journal entry\r\n      const journalData: JournalEntryData = {\r\n        entry_date: data.payment_date,\r\n        entry_type: 'FEE_PAYMENT',\r\n        description: data.description || `Fee payment from ${student.full_name} via ${data.payment_method} - Ref: ${data.reference}`,\r\n        student_id: data.student_id,\r\n        term_id: data.term_id,\r\n        created_by_user_id: data.recorded_by,\r\n        lines: [\r\n          {\r\n            gl_account_code: cashAccountCode,\r\n            debit_amount: data.amount,\r\n            credit_amount: 0,\r\n            description: `Payment received - ${data.payment_method}`\r\n          },\r\n          {\r\n            gl_account_code: '1100', // Accounts Receivable - Students\r\n            debit_amount: 0,\r\n            credit_amount: data.amount,\r\n            description: 'Payment applied to student account'\r\n          }\r\n        ]\r\n      };\r\n\r\n      const journalResult = await this.journalService.createJournalEntry(journalData);\r\n\r\n      if (!journalResult.success) {\r\n        return {\r\n          success: false,\r\n          message: `Failed to create journal entry: ${journalResult.message}`\r\n        };\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        message: `Payment recorded successfully`,\r\n        transaction_id: journalResult.entry_id,\r\n        journal_entry_id: journalResult.entry_id,\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to record payment: ${(error as Error).message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Voids a payment by creating a reversing journal entry\r\n   */\r\n  async voidPaymentDoubleEntry(data: VoidPaymentData): Promise<PaymentResult> {\r\n    try {\r\n      // Get original payment details\r\n      interface PaymentWithStudent {\r\n        id: number;\r\n        student_id: number;\r\n        entry_ref: string;\r\n        entry_date: string;\r\n        entry_type: string;\r\n        description: string;\r\n        is_voided: number;\r\n        student_name: string;\r\n      }\r\n\r\n      const payment = this.db.prepare(`\r\n        SELECT je.*, s.first_name || ' ' || s.last_name as student_name\r\n        FROM journal_entry je\r\n        LEFT JOIN student s ON je.student_id = s.id\r\n        WHERE je.id = ? AND je.entry_type = 'FEE_PAYMENT' AND je.is_voided = 0\r\n      `).get(data.transaction_id) as PaymentWithStudent | undefined;\r\n\r\n      if (!payment) {\r\n        return {\r\n          success: false,\r\n          message: 'Payment transaction not found or already voided'\r\n        };\r\n      }\r\n\r\n      // Void the journal entry (this will handle approval workflow)\r\n      const voidResult = await this.journalService.voidJournalEntry(\r\n        data.transaction_id,\r\n        data.void_reason,\r\n        data.voided_by\r\n      );\r\n\r\n      if (!voidResult.success) {\r\n        return {\r\n            success: false,\r\n            message: voidResult.message,\r\n            requires_approval: voidResult.requires_approval\r\n        };\r\n      }\r\n\r\n      // If voided successfully (not pending approval), reverse the credit balance\r\n      if (!voidResult.requires_approval) {\r\n        // Get payment amount\r\n        const lines = this.db.prepare(`\r\n          SELECT SUM(debit_amount) as total_amount\r\n          FROM journal_entry_line\r\n          WHERE journal_entry_id = ?\r\n        `).get(data.transaction_id) as { total_amount: number };\r\n\r\n        // Reverse credit balance\r\n        this.db.prepare(`\r\n            UPDATE student\r\n            SET credit_balance = COALESCE(credit_balance, 0) - ?\r\n            WHERE id = ?\r\n        `).run(lines.total_amount, payment.student_id);\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        message: voidResult.message,\r\n        requires_approval: voidResult.requires_approval || false\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to void payment: ${(error as Error).message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get student payment history\r\n   */\r\n  async getStudentPaymentHistory(studentId: number, limit = 50): Promise<PaymentHistoryEntry[]> {\r\n    return this.db.prepare(`\r\n      SELECT\r\n        je.id,\r\n        je.entry_ref,\r\n        je.entry_date as transaction_date,\r\n        je.description,\r\n        jel.debit_amount as amount,\r\n        r.receipt_number,\r\n        r.payment_method,\r\n        r.payment_reference as reference,\r\n        je.is_voided,\r\n        je.voided_reason\r\n      FROM journal_entry je\r\n      JOIN journal_entry_line jel ON je.id = jel.journal_entry_id\r\n      JOIN gl_account ga ON jel.gl_account_id = ga.id\r\n      LEFT JOIN receipt r ON je.id = r.transaction_id\r\n      WHERE je.student_id = ?\r\n        AND je.entry_type = 'FEE_PAYMENT'\r\n        AND ga.account_code IN ('1010', '1020', '1030')  -- Cash/Bank accounts\r\n      ORDER BY je.entry_date DESC, je.id DESC\r\n      LIMIT ?\r\n    `).all(studentId, limit) as PaymentHistoryEntry[];\r\n  }\r\n\r\n  private getCashAccountCode(paymentMethod: string): string {\r\n    switch (paymentMethod) {\r\n      case 'CASH':\r\n        return '1010'; // Cash on Hand\r\n      case 'MPESA':\r\n      case 'BANK_TRANSFER':\r\n        return '1020'; // Bank Account - KCB (or primary bank)\r\n      case 'CHEQUE':\r\n        return '1020'; // Bank Account\r\n      default:\r\n        return '1010'; // Default to Cash\r\n    }\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\PaymentService.ts","messages":[{"ruleId":"max-params","severity":1,"message":"Async method 'recordVoid' has too many parameters (7). Maximum allowed is 5.","line":205,"column":3,"nodeType":"FunctionExpression","messageId":"exceed","endLine":205,"endColumn":19},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always falsy.","line":262,"column":11,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":262,"endColumn":20},{"ruleId":"max-statements","severity":1,"message":"Method 'processPayment' has too many statements (35). Maximum allowed is 30.","line":306,"column":19,"nodeType":"FunctionExpression","messageId":"exceed","endLine":398,"endColumn":4},{"ruleId":"sonarjs/pseudo-random","severity":1,"message":"Make sure that using this pseudorandom number generator is safe here.","line":311,"column":21,"nodeType":"CallExpression","messageId":"safeGenerator","endLine":311,"endColumn":34},{"ruleId":"sonarjs/no-identical-functions","severity":1,"message":"Update this function so that its implementation is not identical to the one on line 410.","line":477,"column":3,"nodeType":null,"endLine":477,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { getDatabase } from '../../database'\r\nimport { logAudit } from '../../database/utils/audit'\n\r\nimport type Database from 'better-sqlite3-multiple-ciphers'\n\r\n// ============================================================================\r\n// SEGREGATED INTERFACES (ISP)\r\n// ============================================================================\r\n\r\nexport interface IPaymentRecorder {\n  recordPayment(data: PaymentData): PaymentResult\n}\n\r\nexport interface IPaymentVoidProcessor {\r\n  voidPayment(data: VoidPaymentData): Promise<PaymentResult>\r\n}\r\n\r\nexport interface IPaymentValidator {\n  validatePaymentAgainstInvoices(studentId: number, amount: number): ValidationResult\n}\n\r\nexport interface IPaymentQueryService {\r\n  getStudentPaymentHistory(studentId: number, limit?: number): Promise<PaymentTransaction[]>\r\n  getVoidedTransactionsReport(startDate: string, endDate: string): Promise<VoidedTransaction[]>\r\n  getPaymentApprovalQueue(role: string): Promise<ApprovalQueueItem[]>\r\n}\r\n\r\nexport interface PaymentData {\r\n  student_id: number\r\n  amount: number\r\n  transaction_date: string // Renamed from payment_date to match handler\r\n  payment_method: string\r\n  payment_reference: string // Renamed from reference\r\n  description?: string\r\n  recorded_by_user_id: number // Renamed from recorded_by\r\n  invoice_id?: number\r\n  cheque_number?: string\r\n  bank_name?: string\r\n  amount_in_words?: string\r\n  term_id: number\r\n}\r\n\r\nexport interface PaymentResult {\r\n  success: boolean\r\n  message: string\r\n  transaction_id?: number\r\n  transactionRef?: string\r\n  receiptNumber?: string\r\n  approval_request_id?: number\r\n  requires_approval?: boolean\r\n}\r\n\r\nexport interface VoidPaymentData {\r\n  transaction_id: number\r\n  void_reason: string\r\n  voided_by: number\r\n  recovery_method?: string\r\n}\r\n\r\nexport interface ValidationResult {\r\n  valid: boolean\r\n  message: string\r\n  invoices?: Invoice[]\r\n}\r\n\r\nexport interface PaymentTransaction {\r\n  id: number\r\n  student_id: number\r\n  amount: number\r\n  transaction_date: string\r\n  payment_method: string\r\n  reference: string\r\n  description: string\r\n}\r\n\r\nexport interface VoidedTransaction {\r\n  id: number\r\n  transaction_id: number\r\n  student_id: number\r\n  amount: number\r\n  void_reason: string\r\n  voided_by: number\r\n  voided_at: string\r\n}\r\n\r\nexport interface ApprovalQueueItem {\r\n  id: number\r\n  student_id: number\r\n  amount: number\r\n  status: string\r\n}\r\n\r\n  export interface Invoice {\n    id: number\n    student_id: number\n    amount?: number\n    total_amount?: number\n    amount_paid?: number\n    status: string\n  }\n\r\n// ============================================================================\r\n// REPOSITORY LAYER (SRP)\r\n// ============================================================================\r\n\r\nclass PaymentTransactionRepository {\r\n  private db: Database.Database\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n  }\r\n\r\n  async createTransaction(data: PaymentData): Promise<number> {\r\n    const db = this.db\r\n    const result = db.prepare(`\r\n      INSERT INTO ledger_transaction (\r\n        student_id, transaction_type, amount, transaction_date, description,\r\n        payment_method, payment_reference, recorded_by_user_id, cheque_number, bank_name,\r\n        is_approved, approval_status, term_id\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `).run(\r\n      data.student_id,\r\n      'CREDIT',\r\n      data.amount,\r\n      data.transaction_date,\r\n      data.description || `Payment received: ${data.payment_reference}`,\r\n      data.payment_method,\r\n      data.payment_reference,\r\n      data.recorded_by_user_id,\r\n      data.cheque_number || null,\r\n      data.bank_name || null,\r\n      1,\r\n      'APPROVED',\r\n      data.term_id\r\n    )\r\n    return result.lastInsertRowid as number\r\n  }\r\n\r\n  async createReversal(studentId: number, originalAmount: number, voidReason: string, voidedBy: number): Promise<number> {\r\n    const db = this.db\r\n    const result = db.prepare(`\r\n      INSERT INTO ledger_transaction (\r\n        student_id, transaction_type, amount, transaction_date, description,\r\n        payment_method, reference, recorded_by, is_voided, void_reason\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `).run(\r\n      studentId,\r\n      'REVERSAL',\r\n      -originalAmount,\r\n      new Date().toISOString().split('T')[0],\r\n      `Void of transaction`,\r\n      'VOID',\r\n      `VOID_REF_${studentId}_${Date.now()}`,\r\n      voidedBy,\r\n      1,\r\n      voidReason\r\n    )\r\n    return result.lastInsertRowid as number\r\n  }\r\n\r\n  async getTransaction(id: number): Promise<PaymentTransaction | null> {\r\n    const db = this.db\r\n    return db.prepare(`SELECT * FROM ledger_transaction WHERE id = ?`).get(id) as PaymentTransaction | null\r\n  }\r\n\r\n  async getStudentHistory(studentId: number, limit: number): Promise<PaymentTransaction[]> {\r\n    const db = this.db\r\n    return db.prepare(`\r\n      SELECT * FROM ledger_transaction\r\n      WHERE student_id = ? AND transaction_type IN ('CREDIT', 'PAYMENT')\r\n      ORDER BY transaction_date DESC, created_at DESC\r\n      LIMIT ?\r\n    `).all(studentId, limit) as PaymentTransaction[]\r\n  }\r\n\r\n  async updateStudentBalance(studentId: number, newBalance: number): Promise<void> {\r\n    const db = this.db\r\n    db.prepare(`UPDATE student SET credit_balance = ? WHERE id = ?`).run(newBalance, studentId)\r\n  }\r\n\r\n  async getStudentBalance(studentId: number): Promise<number> {\r\n    const db = this.db\r\n    const result = db.prepare(`SELECT credit_balance FROM student WHERE id = ?`).get(studentId) as { credit_balance: number } | undefined\r\n    return result?.credit_balance || 0\r\n  }\r\n\r\n  async getStudentById(studentId: number): Promise<{ id: number; credit_balance: number } | null> {\r\n    const db = this.db\r\n    return db.prepare(`SELECT id, credit_balance FROM student WHERE id = ?`).get(studentId) as { id: number; credit_balance: number } | null\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// VOID AUDIT REPOSITORY (SRP)\r\n// ============================================================================\r\n\r\nclass VoidAuditRepository {\r\n  private db: Database.Database\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n  }\r\n\r\n  async recordVoid(transactionId: number, studentId: number, amount: number, description: string, voidReason: string, voidedBy: number, recoveryMethod?: string): Promise<number> {\r\n    const db = this.db\r\n    const result = db.prepare(`\r\n      INSERT INTO void_audit (\r\n        transaction_id, transaction_type, original_amount, student_id, description,\r\n        void_reason, voided_by, voided_at, recovered_method, recovered_by, recovered_at\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `).run(\r\n      transactionId,\r\n      'PAYMENT',\r\n      amount,\r\n      studentId,\r\n      description,\r\n      voidReason,\r\n      voidedBy,\r\n      new Date().toISOString(),\r\n      recoveryMethod || null,\r\n      null,\r\n      null\r\n    )\r\n    return result.lastInsertRowid as number\r\n  }\r\n\r\n  async getVoidReport(startDate: string, endDate: string): Promise<VoidedTransaction[]> {\r\n    const db = this.db\r\n    return db.prepare(`\r\n      SELECT va.*, u.first_name, u.last_name, s.admission_number, s.first_name as student_first_name\r\n      FROM void_audit va\r\n      LEFT JOIN user u ON va.voided_by = u.id\r\n      LEFT JOIN student s ON va.student_id = s.id\r\n      WHERE va.voided_at >= ? AND va.voided_at <= ?\r\n      ORDER BY va.voided_at DESC\r\n    `).all(startDate, endDate) as VoidedTransaction[]\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// INVOICE VALIDATOR (SRP)\r\n// ============================================================================\r\n\r\nclass InvoiceValidator implements IPaymentValidator {\n  private db: Database.Database\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n  }\r\n\r\n  validatePaymentAgainstInvoices(studentId: number, amount: number): ValidationResult {\n    const db = this.db\r\n\r\n    try {\r\n      const invoices = db.prepare(`\r\n        SELECT * FROM fee_invoice\r\n        WHERE student_id = ? AND status = 'OUTSTANDING'\r\n        ORDER BY due_date ASC\r\n      `).all(studentId) as Invoice[]\r\n\r\n      if (!invoices || invoices.length === 0) {\r\n        return {\r\n          valid: true,\r\n          message: 'No outstanding invoices for this student',\r\n          invoices: []\r\n        }\r\n      }\r\n\r\n        const totalOutstanding = invoices.reduce((sum, inv) => {\n          const total = typeof inv.total_amount === 'number' ? inv.total_amount : (inv.amount ?? 0)\n          const paid = typeof inv.amount_paid === 'number' ? inv.amount_paid : 0\n          return sum + Math.max(total - paid, 0)\n        }, 0)\n\r\n      if (amount > totalOutstanding) {\r\n        return {\r\n          valid: true,\r\n          message: `Payment exceeds outstanding balance. Overpayment will be credited.`,\r\n          invoices\r\n        }\r\n      }\r\n\r\n      return {\r\n        valid: true,\r\n        message: `Payment applied to ${invoices.length} outstanding invoice(s)`,\r\n        invoices\r\n      }\r\n    } catch (error) {\r\n      throw new Error(`Failed to validate payment: ${(error as Error).message}`)\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// PAYMENT PROCESSOR (SRP)\r\n// ============================================================================\r\n\r\nclass PaymentProcessor {\n  private db: Database.Database\n\n  constructor(db?: Database.Database) {\n    this.db = db || getDatabase()\n  }\n\n    processPayment(data: PaymentData): { transactionId: number; transactionRef: string; receiptNumber: string } {\n    const db = this.db\n\n    // 1. Transaction & Receipt Refs\n      const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '')\n      const nonce = Math.random().toString(36).slice(2, 8).toUpperCase()\n      const txnRef = `TXN-${timestamp}-${String(Date.now())}-${nonce}`\n      const rcpNum = `RCP-${timestamp}-${String(Date.now())}-${nonce}`\n    const description = data.description || 'Tuition Fee Payment'\n\n    const categoryRow = db.prepare(`SELECT id FROM transaction_category WHERE category_name = 'School Fees' LIMIT 1`).get() as { id: number } | undefined\n    let categoryId = categoryRow?.id\n    if (!categoryId) {\n      const insert = db.prepare(`INSERT INTO transaction_category (category_name, category_type, is_system, is_active) VALUES (?, ?, 1, 1)`)\n      const res = insert.run('School Fees', 'INCOME')\n      categoryId = res.lastInsertRowid as number\n    }\n\n    // 2. Insert Transaction\n    const txnStmt = db.prepare(`INSERT INTO ledger_transaction (\n      transaction_ref, transaction_date, transaction_type, category_id, amount, debit_credit,\n      student_id, payment_method, payment_reference, description, term_id, recorded_by_user_id, invoice_id\n    ) VALUES (?, ?, 'FEE_PAYMENT', ?, ?, 'CREDIT', ?, ?, ?, ?, ?, ?, ?)`)\n\n    const txnResult = txnStmt.run(\n      txnRef, data.transaction_date, categoryId, data.amount, data.student_id,\n      data.payment_method, data.payment_reference, description,\n      data.term_id, data.recorded_by_user_id, data.invoice_id || null\n    )\n    const transactionId = txnResult.lastInsertRowid as number\r\n\r\n    // 3. Create Receipt\r\n    const rcpStmt = db.prepare(`INSERT INTO receipt (\r\n      receipt_number, transaction_id, receipt_date, student_id, amount,\r\n      amount_in_words, payment_method, payment_reference, created_by_user_id\r\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`)\r\n\r\n    rcpStmt.run(rcpNum, transactionId, data.transaction_date, data.student_id,\r\n      data.amount, data.amount_in_words || '', data.payment_method, data.payment_reference, data.recorded_by_user_id)\r\n\r\n    // 4. Update Invoices\r\n    let remainingAmount = data.amount\r\n\r\n    if (data.invoice_id) {\r\n      const inv = db.prepare('SELECT total_amount, amount_paid FROM fee_invoice WHERE id = ?').get(data.invoice_id) as { total_amount: number; amount_paid: number } | undefined\r\n      if (inv) {\r\n        db.prepare(`UPDATE fee_invoice SET amount_paid = amount_paid + ?, \r\n                status = CASE WHEN amount_paid + ? >= total_amount THEN 'PAID' ELSE 'PARTIAL' END \r\n                WHERE id = ?`).run(data.amount, data.amount, data.invoice_id)\r\n      }\r\n    } else {\r\n      const pendingInvoices = db.prepare(`\r\n            SELECT id, total_amount, amount_paid \r\n            FROM fee_invoice \r\n            WHERE student_id = ? AND status != 'PAID'\r\n            ORDER BY invoice_date ASC\r\n        `).all(data.student_id) as Array<{ id: number; total_amount: number; amount_paid: number }>\r\n\r\n      const updateInvStmt = db.prepare(`\r\n            UPDATE fee_invoice \r\n            SET amount_paid = amount_paid + ?, \r\n                status = CASE WHEN amount_paid + ? >= total_amount THEN 'PAID' ELSE 'PARTIAL' END \r\n            WHERE id = ?\r\n        `)\r\n\r\n      for (const inv of pendingInvoices) {\r\n        if (remainingAmount <= 0) {break}\r\n\r\n        const outstanding = inv.total_amount - (inv.amount_paid || 0)\r\n        const payAmount = Math.min(remainingAmount, outstanding)\r\n\r\n        updateInvStmt.run(payAmount, payAmount, inv.id)\r\n        remainingAmount -= payAmount\r\n      }\r\n\r\n      // 5. Update Credit Balance (if any remaining)\r\n      if (remainingAmount > 0) {\r\n        db.prepare('UPDATE student SET credit_balance = COALESCE(credit_balance, 0) + ? WHERE id = ?').run(remainingAmount, data.student_id)\r\n      }\r\n    }\r\n\r\n    // 6. Audit Log\r\n    logAudit(\r\n      data.recorded_by_user_id,\r\n      'CREATE',\r\n      'ledger_transaction',\r\n      transactionId,\r\n      null,\r\n      { amount: data.amount, student_id: data.student_id, payment_method: data.payment_method, txnRef, rcpNum }\r\n    )\r\n\r\n    return { transactionId, transactionRef: txnRef, receiptNumber: rcpNum }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// VOID PROCESSOR (SRP)\r\n// ============================================================================\r\n\r\nclass VoidProcessor implements IPaymentVoidProcessor {\r\n  private db: Database.Database\r\n  private transactionRepo: PaymentTransactionRepository\r\n  private voidAuditRepo: VoidAuditRepository\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.transactionRepo = new PaymentTransactionRepository(this.db)\r\n    this.voidAuditRepo = new VoidAuditRepository(this.db)\r\n  }\r\n\r\n  async voidPayment(data: VoidPaymentData): Promise<PaymentResult> {\r\n    try {\r\n      const transaction = await this.transactionRepo.getTransaction(data.transaction_id)\r\n\r\n      if (!transaction) {\r\n        return {\r\n          success: false,\r\n          message: 'Transaction not found'\r\n        }\r\n      }\r\n\r\n      const reversalId = await this.transactionRepo.createReversal(\r\n        transaction.student_id,\r\n        transaction.amount,\r\n        data.void_reason,\r\n        data.voided_by\r\n      )\r\n\r\n      await this.voidAuditRepo.recordVoid(\r\n        data.transaction_id,\r\n        transaction.student_id,\r\n        transaction.amount,\r\n        transaction.description,\r\n        data.void_reason,\r\n        data.voided_by,\r\n        data.recovery_method\r\n      )\r\n\r\n      const currentBalance = await this.transactionRepo.getStudentBalance(transaction.student_id)\r\n      const newBalance = currentBalance - transaction.amount\r\n      await this.transactionRepo.updateStudentBalance(transaction.student_id, newBalance)\r\n\r\n      logAudit(\r\n        data.voided_by,\r\n        'VOID',\r\n        'void_audit',\r\n        reversalId,\r\n        null,\r\n        { original_transaction_id: data.transaction_id, void_reason: data.void_reason }\r\n      )\r\n\r\n      return {\r\n        success: true,\r\n        message: `Payment voided successfully. Reversal transaction: #${reversalId}`,\r\n        transaction_id: reversalId\r\n      }\r\n    } catch (error) {\r\n      throw new Error(`Failed to void payment: ${(error as Error).message}`)\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// PAYMENT QUERY SERVICE (SRP)\r\n// ============================================================================\r\n\r\nclass PaymentQueryService implements IPaymentQueryService {\r\n  private db: Database.Database\r\n  private transactionRepo: PaymentTransactionRepository\r\n  private voidAuditRepo: VoidAuditRepository\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.transactionRepo = new PaymentTransactionRepository(this.db)\r\n    this.voidAuditRepo = new VoidAuditRepository(this.db)\r\n  }\r\n\r\n  async getStudentPaymentHistory(studentId: number, limit = 50): Promise<PaymentTransaction[]> {\r\n    return this.transactionRepo.getStudentHistory(studentId, limit)\r\n  }\r\n\r\n  async getVoidedTransactionsReport(startDate: string, endDate: string): Promise<VoidedTransaction[]> {\r\n    return this.voidAuditRepo.getVoidReport(startDate, endDate)\r\n  }\r\n\r\n  async getPaymentApprovalQueue(role: string): Promise<ApprovalQueueItem[]> {\r\n    const db = this.db\r\n    return db.prepare(`\r\n      SELECT ar.*, s.first_name as student_first_name, s.last_name as student_last_name\r\n      FROM approval_request ar\r\n      LEFT JOIN student s ON ar.reference_id LIKE CONCAT('PAYMENT_%_', s.id)\r\n      WHERE ar.transaction_type = 'PAYMENT'\r\n        AND ar.status IN ('PENDING', 'APPROVED_LEVEL_1')\r\n        AND ar.current_approver_role = ?\r\n      ORDER BY ar.requested_at ASC\r\n    `).all(role) as ApprovalQueueItem[]\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// FACADE - SOLID-COMPLIANT INTERFACE\r\n// ============================================================================\r\n\r\nexport class PaymentService implements IPaymentRecorder, IPaymentVoidProcessor, IPaymentValidator, IPaymentQueryService {\n  private db: Database.Database\r\n  private readonly processor: PaymentProcessor\r\n  private readonly voidProcessor: VoidProcessor\r\n  private readonly validator: InvoiceValidator\r\n  private readonly queryService: PaymentQueryService\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.processor = new PaymentProcessor(this.db)\r\n    this.voidProcessor = new VoidProcessor(this.db)\r\n    this.validator = new InvoiceValidator(this.db)\r\n    this.queryService = new PaymentQueryService(this.db)\r\n  }\r\n\r\n  private recordPaymentSync(data: PaymentData): PaymentResult {\n    if (!data.student_id || data.student_id <= 0) {\n      return { success: false, message: 'Invalid student ID.' }\n    }\n\n    if (!data.transaction_date || !data.payment_method || !data.payment_reference) {\n      return { success: false, message: 'Missing required payment fields.' }\n    }\n\n    const student = this.db.prepare('SELECT id FROM student WHERE id = ?').get(data.student_id) as { id: number } | undefined\n    if (!student) {\n      return { success: false, message: 'Student not found.' }\n    }\n\n    const user = this.db.prepare('SELECT id FROM user WHERE id = ?').get(data.recorded_by_user_id) as { id: number } | undefined\n    if (!user) {\n      return { success: false, message: 'Invalid user session. Please sign in again.' }\n    }\n\n    if (data.invoice_id) {\n      const invoice = this.db.prepare('SELECT id, student_id FROM fee_invoice WHERE id = ?').get(data.invoice_id) as { id: number; student_id: number } | undefined\n      if (!invoice) {\n        return { success: false, message: 'Invoice not found.' }\n      }\n      if (invoice.student_id !== data.student_id) {\n        return { success: false, message: 'Invoice does not belong to the selected student.' }\n      }\n    }\n\n    const validation = this.validator.validatePaymentAgainstInvoices(data.student_id, data.amount)\n    if (!validation.valid) {\n      return {\n        success: false,\n        message: validation.message\n      }\n    }\n\n    const result = this.processor.processPayment(data)\n\n    return {\n      success: true,\n      message: `Payment recorded successfully`,\n      transaction_id: result.transactionId,\n      transactionRef: result.transactionRef,\n      receiptNumber: result.receiptNumber\n    }\n  }\n\n  recordPayment(data: PaymentData): PaymentResult {\n    try {\n      const run = this.db.transaction(() => this.recordPaymentSync(data))\n      return run()\n    } catch (error) {\n      throw new Error(`Failed to record payment: ${(error as Error).message}`)\n    }\n  }\n\r\n  async voidPayment(data: VoidPaymentData): Promise<PaymentResult> {\r\n    return this.voidProcessor.voidPayment(data)\r\n  }\r\n\r\n  validatePaymentAgainstInvoices(studentId: number, amount: number): ValidationResult {\n    return this.validator.validatePaymentAgainstInvoices(studentId, amount)\n  }\n\r\n  async getStudentPaymentHistory(studentId: number, limit = 50): Promise<PaymentTransaction[]> {\r\n    return this.queryService.getStudentPaymentHistory(studentId, limit)\r\n  }\r\n\r\n  async getVoidedTransactionsReport(startDate: string, endDate: string): Promise<VoidedTransaction[]> {\r\n    return this.queryService.getVoidedTransactionsReport(startDate, endDate)\r\n  }\r\n\r\n  async getPaymentApprovalQueue(role: string): Promise<ApprovalQueueItem[]> {\r\n    return this.queryService.getPaymentApprovalQueue(role)\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\PayrollIntegrationService.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":99,"column":18,"nodeType":"Literal","endLine":99,"endColumn":61}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Payroll Integration Service\r\n * \r\n * Bridges the legacy payroll system with the new double-entry accounting system.\r\n * Automatically posts payroll to General Ledger after approval.\r\n * \r\n * Workflow:\r\n * 1. Payroll runs and creates payroll records (existing system)\r\n * 2. After approval, posts to GL via PayrollJournalService\r\n * 3. Links payroll records to journal entries\r\n * 4. Tracks payment status in both systems\r\n */\r\n\r\nimport { PayrollJournalService, type PayrollPeriod } from './PayrollJournalService';\r\nimport { getDatabase } from '../../database';\r\nimport { logAudit } from '../../database/utils/audit';\r\n\r\nexport interface PayrollRecordWithStaff {\r\n  id: number;\r\n  period_id: number;\r\n  staff_id: number;\r\n  basic_salary: number;\r\n  gross_salary: number;\r\n  net_salary: number;\r\n  total_deductions: number;\r\n  payment_status: string;\r\n  payment_date: string;\r\n  gl_posted: number;\r\n  gl_posted_date: string;\r\n  first_name: string;\r\n  last_name: string;\r\n  employee_number: string;\r\n}\r\n\r\nexport interface JournalEntrySummary {\r\n  id: number;\r\n  entry_number: string;\r\n  entry_type: string;\r\n  status: string;\r\n  transaction_date: string;\r\n  total_debit: number;\r\n  total_credit: number;\r\n}\r\n\r\nexport interface PayrollIntegrationResult {\r\n  success: boolean;\r\n  message?: string;\r\n  journalEntryIds?: {\r\n    salaryExpenseEntryId?: number;\r\n    deductionEntryId?: number;\r\n    paymentEntryId?: number;\r\n  };\r\n}\r\n\r\nexport interface PayrollSummaryResult {\r\n  period: PayrollPeriod & {\r\n    isPostedToGL: boolean;\r\n    isPaid: boolean;\r\n  };\r\n  payrollRecords: (Omit<PayrollRecordWithStaff, 'basic_salary' | 'gross_salary' | 'total_deductions' | 'net_salary' | 'gl_posted'> & {\r\n    basic_salary: number;\r\n    gross_salary: number;\r\n    total_deductions: number;\r\n    net_salary: number;\r\n    glPosted: boolean;\r\n  })[];\r\n  journalEntries: (Omit<JournalEntrySummary, 'total_debit' | 'total_credit'> & {\r\n    total_debit: number;\r\n    total_credit: number;\r\n  })[];\r\n  stats: {\r\n    totalStaff: number;\r\n    totalGrossSalary: number;\r\n    totalNetSalary: number;\r\n    totalDeductions: number;\r\n    journalEntriesCount: number;\r\n  };\r\n}\r\n\r\nexport class PayrollIntegrationService {\r\n  private db = getDatabase();\r\n  private payrollJournalService: PayrollJournalService;\r\n\r\n  constructor() {\r\n    this.payrollJournalService = new PayrollJournalService();\r\n  }\r\n\r\n  /**\r\n   * Posts approved payroll to General Ledger\r\n   * Call this after payroll period is approved\r\n   */\r\n  async postApprovedPayrollToGL(\r\n    periodId: number,\r\n    userId: number\r\n  ): Promise<PayrollIntegrationResult> {\r\n    try {\r\n      // Check if payroll period is approved\r\n      const period = this.db\r\n        .prepare('SELECT * FROM payroll_period WHERE id = ?')\r\n        .get(periodId) as PayrollPeriod | undefined;\r\n\r\n      if (!period) {\r\n        return { success: false, message: 'Payroll period not found' };\r\n      }\r\n\r\n      if (period.status !== 'APPROVED') {\r\n        return {\r\n          success: false,\r\n          message: 'Payroll must be approved before posting to GL',\r\n        };\r\n      }\r\n\r\n      // Check if already posted to GL\r\n      const existingPosting = this.db\r\n        .prepare('SELECT * FROM payroll WHERE period_id = ? AND gl_posted = 1 LIMIT 1')\r\n        .get(periodId) as PayrollRecordWithStaff | undefined;\r\n\r\n      if (existingPosting) {\r\n        return {\r\n          success: false,\r\n          message: 'Payroll already posted to General Ledger',\r\n        };\r\n      }\r\n\r\n      // Post to GL using PayrollJournalService\r\n      const journalResult = await this.payrollJournalService.postPayrollToGL(\r\n        periodId,\r\n        userId\r\n      );\r\n\r\n      if (!journalResult.success) {\r\n        return {\r\n          success: false,\r\n          message: journalResult.message || 'Failed to post to GL',\r\n        };\r\n      }\r\n\r\n      // Mark payroll records as posted to GL\r\n      this.db\r\n        .prepare('UPDATE payroll SET gl_posted = 1, gl_posted_date = CURRENT_TIMESTAMP WHERE period_id = ?')\r\n        .run(periodId);\r\n\r\n      // Update period status\r\n      this.db\r\n        .prepare(\r\n          'UPDATE payroll_period SET status = \\'POSTED\\', gl_posted = 1 WHERE id = ?'\r\n        )\r\n        .run(periodId);\r\n\r\n      logAudit(userId, 'UPDATE', 'payroll_period', periodId, null, {\r\n        action: 'POSTED_TO_GL',\r\n        journalEntries: journalResult.journal_entry_ids,\r\n      });\r\n\r\n      return {\r\n        success: true,\r\n        journalEntryIds: {\r\n          salaryExpenseEntryId: journalResult.journal_entry_ids?.[0],\r\n          deductionEntryId: journalResult.journal_entry_ids?.[1]\r\n        },\r\n      };\r\n    } catch (error) {\r\n      console.error('Payroll GL posting error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Records salary payment in both systems\r\n   */\r\n  async recordSalaryPayment(\r\n    periodId: number,\r\n    userId: number\r\n  ): Promise<PayrollIntegrationResult> {\r\n    try {\r\n      // Check if payroll is posted to GL\r\n      const period = this.db\r\n        .prepare('SELECT * FROM payroll_period WHERE id = ?')\r\n        .get(periodId) as PayrollPeriod | undefined;\r\n\r\n      if (!period || !period.gl_posted) {\r\n        return {\r\n          success: false,\r\n          message: 'Payroll must be posted to GL before recording payment',\r\n        };\r\n      }\r\n\r\n      // Check if payment already recorded\r\n      if (period.status === 'PAID') {\r\n        return {\r\n          success: false,\r\n          message: 'Salary payment already recorded',\r\n        };\r\n      }\r\n\r\n      // Record payment in GL\r\n      const paymentResult = await this.payrollJournalService.postSalaryPayment(\r\n        periodId,\r\n        '1020', // Default bank account\r\n        new Date().toISOString().split('T')[0],\r\n        userId\r\n      );\r\n\r\n      if (!paymentResult.success) {\r\n        return {\r\n          success: false,\r\n          message: paymentResult.message || 'Failed to record payment',\r\n        };\r\n      }\r\n\r\n      // Update payroll records\r\n      this.db\r\n        .prepare('UPDATE payroll SET payment_status = \\'PAID\\', payment_date = CURRENT_DATE WHERE period_id = ?')\r\n        .run(periodId);\r\n\r\n      // Update period\r\n      this.db\r\n        .prepare('UPDATE payroll_period SET status = \\'PAID\\' WHERE id = ?')\r\n        .run(periodId);\r\n\r\n      const entryId = paymentResult.journal_entry_ids?.[0];\r\n\r\n      logAudit(userId, 'UPDATE', 'payroll_period', periodId, null, {\r\n        action: 'SALARY_PAYMENT_RECORDED',\r\n        journalEntryId: entryId,\r\n      });\r\n\r\n      return {\r\n        success: true,\r\n        journalEntryIds: {\r\n          paymentEntryId: entryId,\r\n        },\r\n      };\r\n    } catch (error) {\r\n      console.error('Salary payment recording error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Records statutory payment (PAYE, NSSF, NHIF, Housing Levy) to government\r\n   */\r\n  async recordStatutoryPayment(\r\n    periodId: number,\r\n    deductionType: 'PAYE' | 'NSSF' | 'NHIF' | 'HOUSING_LEVY',\r\n    userId: number\r\n  ): Promise<PayrollIntegrationResult> {\r\n    try {\r\n      // Verify payroll is paid\r\n      const period = this.db\r\n        .prepare('SELECT * FROM payroll_period WHERE id = ?')\r\n        .get(periodId) as PayrollPeriod | undefined;\r\n\r\n      if (!period || period.status !== 'PAID') {\r\n        return {\r\n          success: false,\r\n          message: 'Payroll must be paid before recording statutory payments',\r\n        };\r\n      }\r\n\r\n      // Calculate amount for this deduction type\r\n      const deductionQuery = this.db.prepare(`\r\n        SELECT SUM(pd.amount) as total_amount\r\n        FROM payroll_deduction pd\r\n        JOIN payroll p ON pd.payroll_id = p.id\r\n        WHERE p.period_id = ? AND pd.deduction_name LIKE ?\r\n      `).get(periodId, `%${deductionType}%`) as { total_amount: number } | undefined;\r\n      \r\n      const amount = deductionQuery?.total_amount || 0;\r\n\r\n      // Record statutory payment\r\n      const result = await this.payrollJournalService.postStatutoryPayment(\r\n        deductionType,\r\n        amount,\r\n        new Date().toISOString().split('T')[0],\r\n        '1020', // Default bank account\r\n        `STAT-${periodId}-${deductionType}`,\r\n        userId\r\n      );\r\n\r\n      if (!result.success) {\r\n        return {\r\n            success: false,\r\n            message: result.message\r\n        };\r\n      }\r\n\r\n      const entryId = result.journal_entry_ids?.[0];\r\n\r\n      // Log the payment\r\n      logAudit(userId, 'CREATE', 'journal_entry', entryId!, null, {\r\n        action: 'STATUTORY_PAYMENT',\r\n        deductionType,\r\n        periodId,\r\n      });\r\n\r\n      return {\r\n        success: true,\r\n        journalEntryIds: {\r\n          paymentEntryId: entryId,\r\n        },\r\n      };\r\n    } catch (error) {\r\n      console.error('Statutory payment error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets payroll summary with GL integration status\r\n   */\r\n  getPayrollSummaryWithGLStatus(periodId: number): PayrollSummaryResult | null {\r\n    const period = this.db\r\n      .prepare('SELECT * FROM payroll_period WHERE id = ?')\r\n      .get(periodId) as PayrollPeriod | undefined;\r\n\r\n    if (!period) {\r\n      return null;\r\n    }\r\n\r\n    const payrollRecords = this.db\r\n      .prepare(`\r\n        SELECT \r\n          p.*,\r\n          s.first_name,\r\n          s.last_name,\r\n          s.employee_number\r\n        FROM payroll p\r\n        JOIN staff s ON p.staff_id = s.id\r\n        WHERE p.period_id = ?\r\n      `)\r\n      .all(periodId) as PayrollRecordWithStaff[];\r\n\r\n    // Get related journal entries\r\n    const journalEntries = this.db\r\n      .prepare(`\r\n        SELECT \r\n          je.id,\r\n          je.entry_number,\r\n          je.entry_type,\r\n          je.status,\r\n          je.transaction_date,\r\n          SUM(CASE WHEN jel.debit > 0 THEN jel.debit ELSE 0 END) as total_debit,\r\n          SUM(CASE WHEN jel.credit > 0 THEN jel.credit ELSE 0 END) as total_credit\r\n        FROM journal_entry je\r\n        JOIN journal_entry_line jel ON je.id = jel.journal_entry_id\r\n        WHERE je.reference_type = 'PAYROLL' \r\n        AND je.reference_id = ?\r\n        GROUP BY je.id\r\n        ORDER BY je.created_at\r\n      `)\r\n      .all(periodId) as JournalEntrySummary[];\r\n\r\n    return {\r\n      period: {\r\n        ...period,\r\n        isPostedToGL: period.gl_posted === 1,\r\n        isPaid: period.status === 'PAID',\r\n      },\r\n      payrollRecords: payrollRecords.map((p) => ({\r\n        ...p,\r\n        basic_salary: p.basic_salary,\r\n        gross_salary: p.gross_salary,\r\n        total_deductions: p.total_deductions,\r\n        net_salary: p.net_salary,\r\n        glPosted: p.gl_posted === 1,\r\n      })),\r\n      journalEntries: journalEntries.map((je) => ({\r\n        ...je,\r\n        total_debit: je.total_debit,\r\n        total_credit: je.total_credit,\r\n      })),\r\n      stats: {\r\n        totalStaff: payrollRecords.length,\r\n        totalGrossSalary: payrollRecords.reduce((sum, p) => sum + p.gross_salary, 0),\r\n        totalNetSalary: payrollRecords.reduce((sum, p) => sum + p.net_salary, 0),\r\n        totalDeductions:\r\n          payrollRecords.reduce((sum, p) => sum + p.total_deductions, 0),\r\n        journalEntriesCount: journalEntries.length,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Ensures payroll tables have GL integration columns\r\n   * (Migration helper - can be removed once schema is updated)\r\n   */\r\n  ensureGLColumns(): void {\r\n    try {\r\n      // Add gl_posted column to payroll if not exists\r\n      this.db.exec(`\r\n        ALTER TABLE payroll ADD COLUMN gl_posted INTEGER DEFAULT 0;\r\n      `);\r\n    } catch {\r\n      // Column already exists\r\n    }\r\n\r\n    try {\r\n      this.db.exec(`\r\n        ALTER TABLE payroll ADD COLUMN gl_posted_date TEXT;\r\n      `);\r\n    } catch {\r\n      // Column already exists\r\n    }\r\n\r\n    try {\r\n      this.db.exec(`\r\n        ALTER TABLE payroll ADD COLUMN payment_status TEXT DEFAULT 'PENDING';\r\n      `);\r\n    } catch {\r\n      // Column already exists\r\n    }\r\n\r\n    try {\r\n      this.db.exec(`\r\n        ALTER TABLE payroll ADD COLUMN payment_date TEXT;\r\n      `);\r\n    } catch {\r\n      // Column already exists\r\n    }\r\n\r\n    try {\r\n      this.db.exec(`\r\n        ALTER TABLE payroll_period ADD COLUMN gl_posted INTEGER DEFAULT 0;\r\n      `);\r\n    } catch {\r\n      // Column already exists\r\n    }\r\n  }\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\PayrollJournalService.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always falsy.","line":273,"column":11,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":273,"endColumn":18},{"ruleId":"max-params","severity":1,"message":"Async method 'postStatutoryPayment' has too many parameters (6). Maximum allowed is 5.","line":330,"column":3,"nodeType":"FunctionExpression","messageId":"exceed","endLine":330,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { getDatabase } from '../../database';\r\nimport { DoubleEntryJournalService, type JournalEntryData } from '../accounting/DoubleEntryJournalService';\n\r\nimport type Database from 'better-sqlite3';\n\r\n/**\r\n * Payroll Journal Service\r\n * \r\n * Integrates payroll with the general ledger by creating journal entries\r\n * for salary expenses, statutory deductions, and payments.\r\n */\r\n\r\nexport interface PayrollJournalResult {\r\n  success: boolean;\r\n  message: string;\r\n  journal_entry_ids?: number[];\r\n}\r\n\r\nexport interface PayrollPeriod {\r\n  id: number;\r\n  period_name: string;\r\n  start_date: string;\r\n  end_date: string;\r\n  status: 'DRAFT' | 'PENDING_APPROVAL' | 'APPROVED' | 'POSTED' | 'PAID';\r\n  gl_posted: number;\r\n  payment_status: string;\r\n  payment_date: string;\r\n}\r\n\r\nexport class PayrollJournalService {\r\n  private db: Database.Database;\r\n  private journalService: DoubleEntryJournalService;\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase();\r\n    this.journalService = new DoubleEntryJournalService(this.db);\r\n  }\r\n\r\n  /**\r\n   * Post complete payroll to GL\r\n   * Creates multiple journal entries for a payroll period\r\n   */\r\n  async postPayrollToGL(\r\n    periodId: number,\r\n    userId: number\r\n  ): Promise<PayrollJournalResult> {\r\n    try {\r\n      const journalIds: number[] = [];\r\n\r\n      // Step 1: Post salary expense\r\n      const expenseResult = await this.postSalaryExpense(periodId, userId);\r\n      if (!expenseResult.success) {\r\n        return expenseResult;\r\n      }\r\n      journalIds.push(...(expenseResult.journal_entry_ids || []));\r\n\r\n      // Step 2: Post statutory deductions as liabilities\r\n      const deductionsResult = await this.postStatutoryDeductions(periodId, userId);\r\n      if (!deductionsResult.success) {\r\n        return deductionsResult;\r\n      }\r\n      journalIds.push(...(deductionsResult.journal_entry_ids || []));\r\n\r\n      return {\r\n        success: true,\r\n        message: `Payroll posted to GL successfully. ${journalIds.length} journal entries created.`,\r\n        journal_entry_ids: journalIds\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to post payroll to GL: ${(error as Error).message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Post salary expense entry\r\n   * Debit: Salary Expense (5010/5020)\r\n   * Credit: Salary Payable (2100)\r\n   */\r\n  async postSalaryExpense(\r\n    periodId: number,\r\n    userId: number\r\n  ): Promise<PayrollJournalResult> {\r\n    try {\r\n      // Get payroll period details\r\n      const period = this.db.prepare(`\r\n        SELECT * FROM payroll_period WHERE id = ?\r\n      `).get(periodId) as PayrollPeriod | undefined;\r\n\r\n      if (!period) {\r\n        return {\r\n          success: false,\r\n          message: `Payroll period ${periodId} not found`\r\n        };\r\n      }\r\n\r\n      // Get payroll records grouped by department/type\r\n      const payrollRecords = this.db.prepare(`\r\n        SELECT\r\n          s.department,\r\n          s.job_title,\r\n          SUM(p.gross_salary) as total_gross\r\n        FROM payroll p\r\n        JOIN staff s ON p.staff_id = s.id\r\n        WHERE p.period_id = ?\r\n        GROUP BY s.department\r\n      `).all(periodId) as Array<{ department: string; total_gross: number }>;\r\n\r\n      const journalIds: number[] = [];\r\n\r\n      for (const record of payrollRecords) {\r\n        // Determine expense account based on department\r\n        const expenseAccountCode = this.getExpenseAccountCode(record.department);\r\n\r\n        const journalData: JournalEntryData = {\r\n          entry_date: period.end_date,\r\n          entry_type: 'SALARY_PAYMENT',\r\n          description: `Salary expense for ${period.period_name} - ${record.department}`,\r\n          created_by_user_id: userId,\r\n          lines: [\r\n            {\r\n              gl_account_code: expenseAccountCode,\r\n              debit_amount: record.total_gross,\r\n              credit_amount: 0,\r\n              description: `Gross salary - ${record.department}`\r\n            },\r\n            {\r\n              gl_account_code: '2100', // Salary Payable\r\n              debit_amount: 0,\r\n              credit_amount: record.total_gross,\r\n              description: 'Salary accrued'\r\n            }\r\n          ]\r\n        };\r\n\r\n        const result = await this.journalService.createJournalEntry(journalData);\r\n        if (result.success && result.entry_id) {\r\n          journalIds.push(result.entry_id);\r\n        }\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        message: `Salary expenses posted successfully`,\r\n        journal_entry_ids: journalIds\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to post salary expense: ${(error as Error).message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Post statutory deductions as liabilities\r\n   * Debit: Salary Payable (2100)\r\n   * Credit: PAYE Payable (2110), NSSF Payable (2120), NHIF Payable (2130), etc.\r\n   */\r\n  async postStatutoryDeductions(\r\n    periodId: number,\r\n    userId: number\r\n  ): Promise<PayrollJournalResult> {\r\n    try {\r\n      // Get period details\r\n      const period = this.db.prepare(`\r\n        SELECT * FROM payroll_period WHERE id = ?\r\n      `).get(periodId) as PayrollPeriod | undefined;\r\n\r\n      if (!period) {\r\n        return {\r\n          success: false,\r\n          message: `Payroll period ${periodId} not found`\r\n        };\r\n      }\r\n\r\n      // Aggregate deductions by type\r\n      const deductions = this.db.prepare(`\r\n        SELECT\r\n          pd.deduction_name,\r\n          SUM(pd.amount) as total_amount\r\n        FROM payroll_deduction pd\r\n        JOIN payroll p ON pd.payroll_id = p.id\r\n        WHERE p.period_id = ?\r\n        GROUP BY pd.deduction_name\r\n      `).all(periodId) as Array<{ deduction_name: string; total_amount: number }>;\r\n\r\n      if (deductions.length === 0) {\r\n        return {\r\n          success: true,\r\n          message: 'No deductions to post',\r\n          journal_entry_ids: []\r\n        };\r\n      }\r\n\r\n      // Create credit lines for each deduction type\r\n      const creditLines = deductions.map((ded) => ({\r\n        gl_account_code: this.getDeductionAccountCode(ded.deduction_name),\r\n        debit_amount: 0,\r\n        credit_amount: ded.total_amount,\r\n        description: ded.deduction_name\r\n      }));\r\n\r\n      // Calculate total deductions\r\n      const totalDeductions = deductions.reduce((sum, d) => sum + d.total_amount, 0);\r\n\r\n      // Create journal entry\r\n      const journalData: JournalEntryData = {\r\n        entry_date: period.end_date,\r\n        entry_type: 'SALARY_PAYMENT',\r\n        description: `Statutory deductions for ${period.period_name}`,\r\n        created_by_user_id: userId,\r\n        lines: [\r\n          {\r\n            gl_account_code: '2100', // Salary Payable\r\n            debit_amount: totalDeductions,\r\n            credit_amount: 0,\r\n            description: 'Deductions from salary payable'\r\n          },\r\n          ...creditLines\r\n        ]\r\n      };\r\n\r\n      const result = await this.journalService.createJournalEntry(journalData);\r\n\r\n      return {\r\n        success: result.success,\r\n        message: result.message,\r\n        journal_entry_ids: result.success && result.entry_id ? [result.entry_id] : []\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to post statutory deductions: ${(error as Error).message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Post salary payment when bank transfer is made\r\n   * Debit: Salary Payable (2100)\r\n   * Credit: Bank Account (1020)\r\n   */\r\n  async postSalaryPayment(\r\n    periodId: number,\r\n    bankAccountCode: string,\r\n    paymentDate: string,\r\n    userId: number\r\n  ): Promise<PayrollJournalResult> {\r\n    try {\r\n      // Get period details\r\n      const period = this.db.prepare(`\r\n        SELECT * FROM payroll_period WHERE id = ?\r\n      `).get(periodId) as PayrollPeriod | undefined;\r\n\r\n      if (!period) {\r\n        return {\r\n          success: false,\r\n          message: `Payroll period ${periodId} not found`\r\n        };\r\n      }\r\n\r\n      // Calculate total net salary to be paid\r\n      const totals = this.db.prepare(`\r\n        SELECT SUM(net_salary) as total_net\r\n        FROM payroll\r\n        WHERE period_id = ?\r\n      `).get(periodId) as { total_net: number };\r\n\r\n      if (!totals || totals.total_net === 0) {\r\n        return {\r\n          success: false,\r\n          message: 'No salary amounts to pay'\r\n        };\r\n      }\r\n\r\n      const journalData: JournalEntryData = {\r\n        entry_date: paymentDate,\r\n        entry_type: 'SALARY_PAYMENT',\r\n        description: `Salary payment for ${period.period_name}`,\r\n        created_by_user_id: userId,\r\n        lines: [\r\n          {\r\n            gl_account_code: '2100', // Salary Payable\r\n            debit_amount: totals.total_net,\r\n            credit_amount: 0,\r\n            description: 'Salary payment'\r\n          },\r\n          {\r\n            gl_account_code: bankAccountCode,\r\n            debit_amount: 0,\r\n            credit_amount: totals.total_net,\r\n            description: 'Bank transfer for salaries'\r\n          }\r\n        ]\r\n      };\r\n\r\n      const result = await this.journalService.createJournalEntry(journalData);\r\n\r\n      // Update payroll records with payment status\r\n      if (result.success) {\r\n        this.db.prepare(`\r\n          UPDATE payroll\r\n          SET payment_status = 'PAID', payment_date = ?\r\n          WHERE period_id = ?\r\n        `).run(paymentDate, periodId);\r\n      }\r\n\r\n      return {\r\n        success: result.success,\r\n        message: result.message,\r\n        journal_entry_ids: result.success && result.entry_id ? [result.entry_id] : []\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to post salary payment: ${(error as Error).message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Post statutory payments (PAYE, NSSF, NHIF to government)\r\n   * Debit: PAYE/NSSF/NHIF Payable\r\n   * Credit: Bank Account\r\n   */\r\n  async postStatutoryPayment(\r\n    deductionType: 'PAYE' | 'NSSF' | 'NHIF' | 'HOUSING_LEVY',\r\n    amount: number,\r\n    paymentDate: string,\r\n    bankAccountCode: string,\r\n    referenceNumber: string,\r\n    userId: number\r\n  ): Promise<PayrollJournalResult> {\r\n    try {\r\n      const liabilityAccountCode = this.getDeductionAccountCode(deductionType);\r\n\r\n      const journalData: JournalEntryData = {\r\n        entry_date: paymentDate,\r\n        entry_type: 'EXPENSE',\r\n        description: `${deductionType} payment to government - Ref: ${referenceNumber}`,\r\n        created_by_user_id: userId,\r\n        lines: [\r\n          {\r\n            gl_account_code: liabilityAccountCode,\r\n            debit_amount: amount,\r\n            credit_amount: 0,\r\n            description: `${deductionType} payment`\r\n          },\r\n          {\r\n            gl_account_code: bankAccountCode,\r\n            debit_amount: 0,\r\n            credit_amount: amount,\r\n            description: 'Payment to government'\r\n          }\r\n        ]\r\n      };\r\n\r\n      const result = await this.journalService.createJournalEntry(journalData);\r\n\r\n      return {\r\n        success: result.success,\r\n        message: result.message,\r\n        journal_entry_ids: result.success && result.entry_id ? [result.entry_id] : []\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to post statutory payment: ${(error as Error).message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  // ============================================================================\r\n  // PRIVATE HELPER METHODS\r\n  // ============================================================================\r\n\r\n  private getExpenseAccountCode(department: string): string {\r\n    // Map department to expense account\r\n    const normalizedDept = (department || '').toLowerCase();\r\n\r\n    if (normalizedDept.includes('teaching') || normalizedDept.includes('academic')) {\r\n      return '5010'; // Salaries - Teaching Staff\r\n    } else {\r\n      return '5020'; // Salaries - Non-Teaching Staff\r\n    }\r\n  }\r\n\r\n  private getDeductionAccountCode(deductionName: string): string {\r\n    const normalized = deductionName.toUpperCase();\r\n\r\n    if (normalized.includes('PAYE') || normalized.includes('TAX')) {\r\n      return '2110'; // PAYE Payable\r\n    } else if (normalized.includes('NSSF')) {\r\n      return '2120'; // NSSF Payable\r\n    } else if (normalized.includes('NHIF') || normalized.includes('SHIF')) {\r\n      return '2130'; // NHIF/SHIF Payable\r\n    } else if (normalized.includes('HOUSING')) {\r\n      return '2140'; // Housing Levy Payable\r\n    } else {\r\n      return '2100'; // Default to Salary Payable\r\n    }\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\PeriodLockingService.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":43,"column":43,"nodeType":"Literal","endLine":43,"endColumn":71}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { getDatabase } from '../../database'\nimport { logAudit as _logAudit } from '../../database/utils/audit'\n\nimport type Database from 'better-sqlite3-multiple-ciphers'\n\nexport interface FinancialPeriod {\n  id: number\n  name: string\n  start_date: string\n  end_date: string\n  status: 'OPEN' | 'LOCKED' | 'CLOSED'\n  locked_by: number | null\n  locked_at: string | null\n  closed_by: number | null\n  closed_at: string | null\n}\n\nexport interface LockResult {\n  success: boolean\n  message: string\n}\n\nexport interface TransactionAllowanceResult {\n  allowed: boolean\n  reason: string | null\n}\n\nexport class PeriodLockingService {\n  private db: Database.Database\n\n  constructor(db?: Database.Database) {\n    this.db = db || getDatabase()\n  }\n\n  lockPeriod(periodId: number, lockedBy: number): LockResult {\n    try {\n      const period = this.db.prepare(`\n        SELECT * FROM financial_period WHERE id = ?\n      `).get(periodId) as FinancialPeriod | undefined\n\n      if (!period) {\n        return { success: false, message: 'Financial period not found' }\n      }\n\n      if (period.status === 'LOCKED') {\n        return { success: false, message: `Period is already locked` }\n      }\n\n      if (period.status === 'CLOSED') {\n        return { success: false, message: `Period is closed and cannot be locked` }\n      }\n\n      const now = new Date().toISOString()\n      this.db.prepare(`\n        UPDATE financial_period\n        SET status = 'LOCKED', locked_by = ?, locked_at = ?\n        WHERE id = ?\n      `).run(lockedBy, now, periodId)\n\n      // Log audit\n      this.db.prepare(`\n        INSERT INTO audit_log (user_id, action_type, table_name, record_id, old_values, new_values)\n        VALUES (?, ?, ?, ?, ?, ?)\n      `).run(\n        lockedBy,\n        'LOCK_PERIOD',\n        'financial_period',\n        periodId,\n        JSON.stringify({ status: period.status }),\n        JSON.stringify({ status: 'LOCKED' })\n      )\n\n      return { success: true, message: `Period '${period.name}' locked successfully` }\n    } catch (error) {\n      return { success: false, message: `Failed to lock period: ${(error as Error).message}` }\n    }\n  }\n\n  unlockPeriod(periodId: number, unlockedBy: number): LockResult {\n    try {\n      const period = this.db.prepare(`\n        SELECT * FROM financial_period WHERE id = ?\n      `).get(periodId) as FinancialPeriod | undefined\n\n      if (!period) {\n        return { success: false, message: 'Financial period not found' }\n      }\n\n      if (period.status === 'OPEN') {\n        return { success: false, message: `Period is not currently locked` }\n      }\n\n      if (period.status === 'CLOSED') {\n        return { success: false, message: `Period is closed and cannot be unlocked` }\n      }\n\n      const _now = new Date().toISOString()\n      this.db.prepare(`\n        UPDATE financial_period\n        SET status = 'OPEN', locked_by = NULL, locked_at = NULL\n        WHERE id = ?\n      `).run(periodId)\n\n      // Log audit\n      this.db.prepare(`\n        INSERT INTO audit_log (user_id, action_type, table_name, record_id, old_values, new_values)\n        VALUES (?, ?, ?, ?, ?, ?)\n      `).run(\n        unlockedBy,\n        'UNLOCK_PERIOD',\n        'financial_period',\n        periodId,\n        JSON.stringify({ status: period.status }),\n        JSON.stringify({ status: 'OPEN' })\n      )\n\n      return { success: true, message: `Period '${period.name}' unlocked successfully` }\n    } catch (error) {\n      return { success: false, message: `Failed to unlock period: ${(error as Error).message}` }\n    }\n  }\n\n  closePeriod(periodId: number, closedBy: number): LockResult {\n    try {\n      const period = this.db.prepare(`\n        SELECT * FROM financial_period WHERE id = ?\n      `).get(periodId) as FinancialPeriod | undefined\n\n      if (!period) {\n        return { success: false, message: 'Financial period not found' }\n      }\n\n      if (period.status === 'CLOSED') {\n        return { success: false, message: `Period is already closed` }\n      }\n\n      if (period.status !== 'LOCKED') {\n        return { success: false, message: `Period must be locked before closing. Current status: ${period.status}` }\n      }\n\n      const now = new Date().toISOString()\n      this.db.prepare(`\n        UPDATE financial_period\n        SET status = 'CLOSED', closed_by = ?, closed_at = ?\n        WHERE id = ?\n      `).run(closedBy, now, periodId)\n\n      // Log audit\n      this.db.prepare(`\n        INSERT INTO audit_log (user_id, action_type, table_name, record_id, old_values, new_values)\n        VALUES (?, ?, ?, ?, ?, ?)\n      `).run(\n        closedBy,\n        'CLOSE_PERIOD',\n        'financial_period',\n        periodId,\n        JSON.stringify({ status: period.status }),\n        JSON.stringify({ status: 'CLOSED' })\n      )\n\n      return { success: true, message: `Period '${period.name}' closed successfully` }\n    } catch (error) {\n      return { success: false, message: `Failed to close period: ${(error as Error).message}` }\n    }\n  }\n\n  isTransactionAllowed(transactionDate: string): TransactionAllowanceResult {\n    try {\n      const period = this.db.prepare(`\n        SELECT * FROM financial_period\n        WHERE ? BETWEEN start_date AND end_date\n      `).get(transactionDate) as FinancialPeriod | undefined\n\n      if (!period) {\n        return {\n          allowed: false,\n          reason: 'No financial period found for this date'\n        }\n      }\n\n      if (period.status === 'LOCKED' || period.status === 'CLOSED') {\n        return {\n          allowed: false,\n          reason: `Period is ${period.status.toLowerCase()}`\n        }\n      }\n\n      return {\n        allowed: true,\n        reason: null\n      }\n    } catch (error) {\n      return {\n        allowed: false,\n        reason: `Error checking transaction allowance: ${(error as Error).message}`\n      }\n    }\n  }\n\n  getPeriodForDate(date: string): FinancialPeriod | null {\n    try {\n      return this.db.prepare(`\n        SELECT * FROM financial_period\n        WHERE ? BETWEEN start_date AND end_date\n      `).get(date) as FinancialPeriod | null\n    } catch {\n      return null\n    }\n  }\n\n  getAllPeriods(status?: string): FinancialPeriod[] {\n    try {\n      if (status) {\n        return this.db.prepare(`\n          SELECT * FROM financial_period\n          WHERE status = ?\n          ORDER BY start_date DESC\n        `).all(status) as FinancialPeriod[]\n      }\n      return this.db.prepare(`\n        SELECT * FROM financial_period\n        ORDER BY start_date DESC\n      `).all() as FinancialPeriod[]\n    } catch {\n      return []\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\ScholarshipService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\__tests__\\CreditAutoApplicationService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\__tests__\\FeeProrationService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\__tests__\\PaymentService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\__tests__\\PeriodLockingService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\__tests__\\ScholarshipService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\finance\\scholarship-normalization.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\inventory\\InventoryService.ts","messages":[{"ruleId":"max-statements","severity":1,"message":"Method 'executeUpdate' has too many statements (32). Maximum allowed is 30.","line":152,"column":28,"nodeType":"FunctionExpression","messageId":"exceed","endLine":170,"endColumn":6},{"ruleId":"max-params","severity":1,"message":"Async method 'adjustStock' has too many parameters (6). Maximum allowed is 5.","line":189,"column":5,"nodeType":"FunctionExpression","messageId":"exceed","endLine":189,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { logAudit } from '../../database/utils/audit'\nimport { BaseService } from '../base/BaseService'\n\nexport interface InventoryItem {\n    id: number\n    item_code: string\n    item_name: string\n    category: string\n    category_id: number\n    unit_of_measure: string\n    current_stock: number\n    reorder_level: number\n    unit_cost: number\n    unit_price: number\n    supplier_id: number | null\n    description: string | null\n    is_active: boolean\n    created_at: string\n    updated_at: string\n}\n\nexport interface StockTransaction {\n    id: number\n    item_id: number\n    transaction_type: 'IN' | 'OUT' | 'ADJUSTMENT'\n    quantity: number\n    unit_price: number\n    transaction_date: string\n    reference: string | null\n    notes: string | null\n    created_by_user_id: number\n    created_at: string\n}\n\nexport interface CreateInventoryItemData {\n    item_code: string\n    item_name: string\n    category_id: number\n    unit_of_measure: string\n    reorder_level: number\n    unit_cost: number\n    unit_price: number\n    supplier_id?: number\n    description?: string\n}\n\nexport interface InventoryFilters {\n    category?: string\n    category_id?: number\n    search?: string\n    low_stock?: boolean\n}\n\nexport interface StockMovementHistory extends StockTransaction {\n    recorded_by_name: string | null\n}\n\nexport interface InventoryCategory {\n    id: number\n    category_name: string\n    description: string | null\n    is_active: boolean\n}\n\nexport interface Supplier {\n    id: number\n    supplier_name: string\n    contact_person: string | null\n    email: string | null\n    phone: string | null\n    address: string | null\n    is_active: boolean\n}\n\ninterface InventoryItemRow {\n    id: number;\n    item_code: string;\n    item_name: string;\n    category_name: string;\n    category_id: number;\n    unit_of_measure: string;\n    current_stock: number;\n    reorder_level: number;\n    unit_cost: number;\n    unit_price: number;\n    supplier_id: number | null;\n    description: string | null;\n    is_active: number;\n    created_at: string;\n    updated_at: string;\n}\n\nexport class InventoryService extends BaseService<InventoryItem, CreateInventoryItemData, Partial<CreateInventoryItemData>, InventoryFilters> {\n    protected getTableName(): string { return 'inventory_item' }\n    protected getPrimaryKey(): string { return 'id' }\n\n    protected buildSelectQuery(): string {\n        return `\n            SELECT i.*, c.category_name \n            FROM inventory_item i\n            JOIN inventory_category c ON i.category_id = c.id\n        `\n    }\n\n    protected mapRowToEntity(row: unknown): InventoryItem {\n        const r = row as InventoryItemRow\n        return {\n            id: r.id,\n            item_code: r.item_code,\n            item_name: r.item_name,\n            category: r.category_name,\n            category_id: r.category_id,\n            unit_of_measure: r.unit_of_measure,\n            current_stock: r.current_stock,\n            reorder_level: r.reorder_level,\n            unit_cost: r.unit_cost,\n            unit_price: r.unit_price,\n            supplier_id: r.supplier_id,\n            description: r.description,\n            is_active: Boolean(r.is_active),\n            created_at: r.created_at,\n            updated_at: r.updated_at\n        }\n    }\n\n    protected validateCreate(data: CreateInventoryItemData): string[] | null {\n        const errors: string[] = []\n        if (!data.item_name) {errors.push('Item name is required')}\n        if (!data.item_code) {errors.push('Item code is required')}\n        if (!data.category_id) {errors.push('Category is required')}\n        if (!data.unit_of_measure) {errors.push('Unit of measure is required')}\n        return errors.length > 0 ? errors : null\n    }\n\n    protected async validateUpdate(_id: number, _data: Partial<CreateInventoryItemData>): Promise<string[] | null> {\n        return null\n    }\n\n    protected executeCreate(data: CreateInventoryItemData): { lastInsertRowid: number | bigint } {\n        return this.db.prepare(`\n            INSERT INTO inventory_item (\n                item_code, item_name, category_id, unit_of_measure, reorder_level, unit_cost,\n                unit_price, supplier_id, description, updated_at\n            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)\n        `).run(\n            data.item_code, data.item_name, data.category_id,\n            data.unit_of_measure, data.reorder_level || 0, data.unit_cost || 0,\n            data.unit_price || 0, data.supplier_id || null, data.description || null\n        )\n    }\n\n    protected executeUpdate(id: number, data: Partial<CreateInventoryItemData>): void {\n        const sets: string[] = []\n        const params: unknown[] = []\n\n        if (data.item_name) { sets.push('item_name = ?'); params.push(data.item_name) }\n        if (data.item_code) { sets.push('item_code = ?'); params.push(data.item_code) }\n        if (data.category_id) { sets.push('category_id = ?'); params.push(data.category_id) }\n        if (data.unit_of_measure) { sets.push('unit_of_measure = ?'); params.push(data.unit_of_measure) }\n        if (data.reorder_level !== undefined) { sets.push('reorder_level = ?'); params.push(data.reorder_level) }\n        if (data.unit_cost !== undefined) { sets.push('unit_cost = ?'); params.push(data.unit_cost) }\n        if (data.unit_price !== undefined) { sets.push('unit_price = ?'); params.push(data.unit_price) }\n        if (data.supplier_id !== undefined) { sets.push('supplier_id = ?'); params.push(data.supplier_id) }\n        if (data.description !== undefined) { sets.push('description = ?'); params.push(data.description) }\n\n        if (sets.length > 0) {\n            params.push(id)\n            this.db.prepare(`UPDATE inventory_item SET ${sets.join(', ')}, updated_at = CURRENT_TIMESTAMP WHERE id = ?`).run(...params)\n        }\n    }\n\n    protected applyFilters(filters: unknown, conditions: string[], params: unknown[]): void {\n        const f = filters as InventoryFilters\n        if (f.category_id) {\n            conditions.push('category_id = ?')\n            params.push(f.category_id)\n        }\n        if (f.search) {\n            conditions.push('(item_name LIKE ? OR item_code LIKE ?)')\n            params.push(`%${f.search}%`, `%${f.search}%`)\n        }\n        if (f.low_stock) {\n            conditions.push('current_stock <= reorder_level')\n        }\n    }\n\n    // Custom Methods\n\n    async adjustStock(itemId: number, quantity: number, type: 'IN' | 'OUT' | 'ADJUSTMENT', userId: number, notes?: string, unitCost?: number): Promise<{ success: boolean; error?: string }> {\n        const item = await this.findById(itemId)\n        if (!item) {return { success: false, error: 'Item not found' }}\n\n        const current_stock = item.current_stock\n        let change = 0\n        let finalQty = 0\n\n        if (type === 'ADJUSTMENT') {\n            finalQty = quantity\n            change = finalQty - current_stock\n        } else {\n            change = type === 'OUT' ? -quantity : quantity\n            finalQty = current_stock + change\n        }\n\n        if (finalQty < 0) {return { success: false, error: 'Insufficient stock' }}\n\n        // Use provided unit cost for IN/ADJUSTMENT, otherwise fallback to item's current cost\n        // For OUT, we typically use the item's current cost (FIFO/LIFO/Avg not strictly implemented here, assuming standard cost)\n        const movementCost = (type === 'IN' && unitCost !== undefined) ? unitCost : item.unit_cost\n\n        this.db.transaction(() => {\n            // Update stock level\n            this.db.prepare('UPDATE inventory_item SET current_stock = ? WHERE id = ?')\n                .run(finalQty, itemId)\n            \n            // If it's an IN movement with a new cost, update the item's unit cost (Last Price)\n            if (type === 'IN' && unitCost !== undefined && unitCost > 0) {\n                 this.db.prepare('UPDATE inventory_item SET unit_cost = ? WHERE id = ?')\n                .run(unitCost, itemId)\n            }\n\n            this.db.prepare(`\n                INSERT INTO stock_movement (\n                    item_id, movement_type, quantity, unit_cost, \n                    description, movement_date, recorded_by_user_id\n                ) VALUES (?, ?, ?, ?, ?, CURRENT_DATE, ?)\n            `).run(itemId, type, Math.abs(change), movementCost, notes || null, userId)\n        })()\n\n        logAudit(userId, 'STOCK_UPDATE', 'inventory_item', itemId, { quantity: current_stock }, { quantity: finalQty })\n\n        return { success: true }\n    }\n\n    async getHistory(itemId: number): Promise<StockMovementHistory[]> {\n        return this.db.prepare(`\n            SELECT sm.*, u.full_name as recorded_by_name\n            FROM stock_movement sm\n            LEFT JOIN user u ON sm.recorded_by_user_id = u.id\n            WHERE sm.item_id = ? \n            ORDER BY sm.created_at DESC\n        `).all(itemId) as StockMovementHistory[]\n    }\n\n    async getLowStock(): Promise<InventoryItem[]> {\n        const rows = this.db.prepare(`\n            ${this.buildSelectQuery()}\n            WHERE i.current_stock <= i.reorder_level AND i.is_active = 1\n        `).all() as InventoryItemRow[]\n        return rows.map(row => this.mapRowToEntity(row))\n    }\n\n    async getCategories(): Promise<InventoryCategory[]> {\n        return this.db.prepare('SELECT * FROM inventory_category WHERE is_active = 1').all() as InventoryCategory[]\n    }\n\n    async getSuppliers(): Promise<Supplier[]> {\n        return this.db.prepare('SELECT * FROM supplier WHERE is_active = 1').all() as Supplier[]\n    }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\nemis\\__tests__\\NEMISExportService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\notifications\\NotificationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\notifications\\notification-default-templates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\notifications\\notification-types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\operations\\BoardingCostService.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always falsy.","line":244,"column":9,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":244,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type Database from 'better-sqlite3';\n\ninterface BoardingFacility {\n  id: number;\n  name: string;\n  capacity: number;\n  current_occupancy: number;\n  matron_id?: number;\n  is_active: boolean;\n}\n\ninterface BoardingExpense {\n  id: number;\n  facility_id: number;\n  gl_account_code: string;\n  fiscal_year: number;\n  term: number;\n  amount_cents: number;\n  expense_type: 'FOOD' | 'UTILITIES' | 'BEDDING' | 'STAFF' | 'MAINTENANCE' | 'OTHER';\n  description: string;\n  recorded_date: string;\n  recorded_by: number;\n}\n\ninterface BoardingProfitability {\n  facility_id: number;\n  facility_name: string;\n  capacity: number;\n  current_occupancy: number;\n  occupancy_rate: number;\n  total_revenue_cents: number;\n  total_expenses_cents: number;\n  net_profit_cents: number;\n  profit_margin: number;\n  cost_per_boarder_cents: number;\n  break_even_occupancy: number;\n}\n\ninterface ExpenseSummary {\n  expense_type: string;\n  total_amount_cents: number;\n  percentage: number;\n}\n\ninterface RevenueResult {\n  total_revenue: number;\n}\n\n/**\n * BoardingCostService\n * \n * Manages boarding facility costs and profitability analysis.\n * Tracks revenue from boarding fees vs actual costs (food, utilities, staffing, maintenance).\n * Calculates true profitability per facility with occupancy rate analysis.\n * \n * Key Features:\n * - Track expenses by facility and expense type\n * - Calculate cost per boarder\n * - Determine break-even occupancy rates\n * - Generate profitability reports\n * - Support budget allocation decisions\n */\nexport class BoardingCostService {\n  private db: Database.Database;\n\n  constructor(db: Database.Database) {\n    this.db = db;\n  }\n\n  /**\n   * Get all boarding facilities\n   */\n  getAllFacilities(): BoardingFacility[] {\n    const query = `\n      SELECT * FROM boarding_facility\n      ORDER BY name\n    `;\n    return this.db.prepare(query).all() as BoardingFacility[];\n  }\n\n  /**\n   * Get active boarding facilities\n   */\n  getActiveFacilities(): BoardingFacility[] {\n    const query = `\n      SELECT * FROM boarding_facility\n      WHERE is_active = 1\n      ORDER BY name\n    `;\n    return this.db.prepare(query).all() as BoardingFacility[];\n  }\n\n  /**\n   * Record a boarding-related expense\n   */\n  recordBoardingExpense(params: {\n    facility_id: number;\n    gl_account_code: string;\n    fiscal_year: number;\n    term: number;\n    amount_cents: number;\n    expense_type: 'FOOD' | 'UTILITIES' | 'BEDDING' | 'STAFF' | 'MAINTENANCE' | 'OTHER';\n    description: string;\n    recorded_by: number;\n  }): number {\n    const query = `\n      INSERT INTO boarding_expense (\n        facility_id, gl_account_code, fiscal_year, term,\n        amount_cents, expense_type, description,\n        recorded_date, recorded_by\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, datetime('now'), ?)\n    `;\n\n    const result = this.db.prepare(query).run(\n      params.facility_id,\n      params.gl_account_code,\n      params.fiscal_year,\n      params.term,\n      params.amount_cents,\n      params.expense_type,\n      params.description,\n      params.recorded_by\n    );\n\n    return result.lastInsertRowid as number;\n  }\n\n  /**\n   * Get expenses for a facility\n   */\n  getFacilityExpenses(\n    facilityId: number,\n    fiscalYear: number,\n    term?: number\n  ): BoardingExpense[] {\n    let query = `\n      SELECT * FROM boarding_expense\n      WHERE facility_id = ? AND fiscal_year = ?\n    `;\n\n    const params: unknown[] = [facilityId, fiscalYear];\n\n    if (term) {\n      query += ` AND term = ?`;\n      params.push(term);\n    }\n\n    query += ` ORDER BY recorded_date DESC`;\n\n    return this.db.prepare(query).all(...params) as BoardingExpense[];\n  }\n\n  /**\n   * Get total expenses by type for a facility\n   */\n  getExpenseSummaryByType(\n    facilityId: number,\n    fiscalYear: number,\n    term?: number\n  ): ExpenseSummary[] {\n    let query = `\n      SELECT \n        expense_type,\n        SUM(amount_cents) as total_amount_cents\n      FROM boarding_expense\n      WHERE facility_id = ? AND fiscal_year = ?\n    `;\n\n    const params: unknown[] = [facilityId, fiscalYear];\n\n    if (term) {\n      query += ` AND term = ?`;\n      params.push(term);\n    }\n\n    query += `\n      GROUP BY expense_type\n      ORDER BY total_amount_cents DESC\n    `;\n\n    const results = this.db.prepare(query).all(...params) as { expense_type: string; total_amount_cents: number }[];\n\n    // Calculate total for percentages\n    const total = results.reduce((sum, row) => sum + row.total_amount_cents, 0);\n\n    return results.map(row => ({\n      expense_type: row.expense_type,\n      total_amount_cents: row.total_amount_cents,\n      percentage: total > 0 ? (row.total_amount_cents / total) * 100 : 0\n    }));\n  }\n\n  /**\n   * Calculate boarding revenue for a facility\n   * Revenue comes from boarding fees paid by students assigned to this facility\n   */\n  private calculateBoardingRevenue(\n    facilityId: number,\n    fiscalYear: number,\n    term?: number\n  ): number {\n    // Calculate total boarding revenue from invoices, then allocate by occupancy share\n    let query = `\n      SELECT COALESCE(SUM(ii.amount), 0) as total_revenue\n      FROM fee_invoice fi\n      JOIN invoice_item ii ON fi.id = ii.invoice_id\n      JOIN fee_category fc ON ii.fee_category_id = fc.id\n      LEFT JOIN term t ON fi.term_id = t.id\n      WHERE LOWER(fc.category_name) LIKE '%boarding%'\n        AND CAST(strftime('%Y', fi.invoice_date) AS INTEGER) = ?\n    `;\n\n    const params: unknown[] = [fiscalYear];\n\n    if (term) {\n      query += ` AND t.term_number = ?`;\n      params.push(term);\n    }\n\n    const result = this.db.prepare(query).get(...params) as RevenueResult | undefined;\n    const totalRevenue = result?.total_revenue || 0;\n\n    const facility = this.db.prepare(`SELECT current_occupancy FROM boarding_facility WHERE id = ?`).get(facilityId) as { current_occupancy: number } | undefined;\n    const totalOccupancyRow = this.db.prepare(`SELECT COALESCE(SUM(current_occupancy), 0) as total FROM boarding_facility WHERE is_active = 1`).get() as { total: number };\n    const totalOccupancy = totalOccupancyRow.total || 0;\n\n    if (!facility || totalOccupancy <= 0) {return 0;}\n    return Math.round((totalRevenue * facility.current_occupancy) / totalOccupancy);\n  }\n\n  /**\n   * Calculate profitability for a boarding facility\n   */\n  calculateFacilityProfitability(\n    facilityId: number,\n    fiscalYear: number,\n    term?: number\n  ): BoardingProfitability {\n    // Get facility details\n    const facility = this.db.prepare(`\n      SELECT * FROM boarding_facility WHERE id = ?\n    `).get(facilityId) as BoardingFacility;\n\n    if (!facility) {\n      throw new Error(`Boarding facility ${facilityId} not found`);\n    }\n\n    // Calculate revenue\n    const totalRevenueCents = this.calculateBoardingRevenue(facilityId, fiscalYear, term);\n\n    // Calculate total expenses\n    const expenses = this.getFacilityExpenses(facilityId, fiscalYear, term);\n    const totalExpensesCents = expenses.reduce((sum, exp) => sum + exp.amount_cents, 0);\n\n    // Calculate metrics\n    const netProfitCents = totalRevenueCents - totalExpensesCents;\n    const profitMargin = totalRevenueCents > 0 \n      ? (netProfitCents / totalRevenueCents) * 100 \n      : 0;\n    \n    const occupancyRate = facility.capacity > 0\n      ? (facility.current_occupancy / facility.capacity) * 100\n      : 0;\n\n    const costPerBoarderCents = facility.current_occupancy > 0\n      ? totalExpensesCents / facility.current_occupancy\n      : 0;\n\n    // Calculate break-even occupancy\n    // Break-even: Revenue = Expenses\n    // Assuming revenue per boarder is constant, we can calculate\n    const revenuePerBoarder = facility.current_occupancy > 0\n      ? totalRevenueCents / facility.current_occupancy\n      : 0;\n    \n    const breakEvenOccupancy = revenuePerBoarder > 0\n      ? Math.ceil(totalExpensesCents / revenuePerBoarder)\n      : 0;\n\n    return {\n      facility_id: facility.id,\n      facility_name: facility.name,\n      capacity: facility.capacity,\n      current_occupancy: facility.current_occupancy,\n      occupancy_rate: occupancyRate,\n      total_revenue_cents: totalRevenueCents,\n      total_expenses_cents: totalExpensesCents,\n      net_profit_cents: netProfitCents,\n      profit_margin: profitMargin,\n      cost_per_boarder_cents: costPerBoarderCents,\n      break_even_occupancy: breakEvenOccupancy\n    };\n  }\n\n  /**\n   * Get profitability for all facilities\n   */\n  getAllFacilitiesProfitability(\n    fiscalYear: number,\n    term?: number\n  ): BoardingProfitability[] {\n    const facilities = this.getActiveFacilities();\n    \n    return facilities.map(facility => \n      this.calculateFacilityProfitability(facility.id, fiscalYear, term)\n    );\n  }\n\n  /**\n   * Update facility occupancy\n   */\n  updateFacilityOccupancy(facilityId: number, newOccupancy: number): void {\n    const query = `\n      UPDATE boarding_facility\n      SET current_occupancy = ?\n      WHERE id = ?\n    `;\n\n    this.db.prepare(query).run(newOccupancy, facilityId);\n  }\n\n  /**\n   * Create a new boarding facility\n   */\n  createFacility(params: {\n    name: string;\n    capacity: number;\n    matron_id?: number;\n  }): number {\n    const query = `\n      INSERT INTO boarding_facility (\n        name, capacity, current_occupancy, matron_id, is_active\n      ) VALUES (?, ?, 0, ?, 1)\n    `;\n\n    const result = this.db.prepare(query).run(\n      params.name,\n      params.capacity,\n      params.matron_id || null\n    );\n\n    return result.lastInsertRowid as number;\n  }\n\n  /**\n   * Generate boarding profitability summary report\n   */\n  generateProfitabilitySummary(fiscalYear: number, term?: number): {\n    total_capacity: number;\n    total_occupancy: number;\n    overall_occupancy_rate: number;\n    total_revenue_cents: number;\n    total_expenses_cents: number;\n    net_profit_cents: number;\n    profit_margin: number;\n    average_cost_per_boarder_cents: number;\n    facilities: BoardingProfitability[];\n  } {\n    const facilities = this.getAllFacilitiesProfitability(fiscalYear, term);\n\n    const totalCapacity = facilities.reduce((sum, f) => sum + f.capacity, 0);\n    const totalOccupancy = facilities.reduce((sum, f) => sum + f.current_occupancy, 0);\n    const totalRevenue = facilities.reduce((sum, f) => sum + f.total_revenue_cents, 0);\n    const totalExpenses = facilities.reduce((sum, f) => sum + f.total_expenses_cents, 0);\n    const netProfit = totalRevenue - totalExpenses;\n\n    return {\n      total_capacity: totalCapacity,\n      total_occupancy: totalOccupancy,\n      overall_occupancy_rate: totalCapacity > 0 ? (totalOccupancy / totalCapacity) * 100 : 0,\n      total_revenue_cents: totalRevenue,\n      total_expenses_cents: totalExpenses,\n      net_profit_cents: netProfit,\n      profit_margin: totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0,\n      average_cost_per_boarder_cents: totalOccupancy > 0 ? totalExpenses / totalOccupancy : 0,\n      facilities\n    };\n  }\n}\n\nexport default BoardingCostService;\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\operations\\GrantTrackingService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\operations\\StudentCostService.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'calculateStudentCost' has too many lines (102). Maximum allowed is 80.","line":53,"column":5,"nodeType":"MethodDefinition","messageId":"exceed","endLine":176,"endColumn":6},{"ruleId":"complexity","severity":1,"message":"Async method 'calculateStudentCost' has a complexity of 24. Maximum allowed is 12.","line":53,"column":5,"nodeType":"FunctionExpression","messageId":"complex","endLine":53,"endColumn":31},{"ruleId":"max-statements","severity":1,"message":"Async method 'calculateStudentCost' has too many statements (37). Maximum allowed is 30.","line":53,"column":31,"nodeType":"FunctionExpression","messageId":"exceed","endLine":176,"endColumn":6}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\n\nexport interface StudentCost {\n    student_id: number\n    term_id: number\n    academic_year_id: number\n    total_cost: number\n    breakdown: CostBreakdown\n}\n\nexport interface CostBreakdown {\n    tuition_share: number\n    boarding_share: number\n    transport_share: number\n    activity_share: number\n    admin_share: number\n    other_share: number\n}\n\ninterface StudentEnrollmentInfo {\n    id: number\n    student_type: string\n    stream_id: number\n    academic_year_id: number\n    term_id: number\n    [key: string]: unknown // For other student fields\n}\n\ninterface StudentRouteAssignment {\n    id: number\n    student_id: number\n    route_id: number\n    is_active: number\n    // Add other fields as necessary\n}\n\nexport class StudentCostService {\n    private get db() {\n        return getDatabase()\n    }\n\n    private getAcademicYearValue(academicYearId: number): number {\n        const row = this.db.prepare('SELECT year_name FROM academic_year WHERE id = ?').get(academicYearId) as { year_name?: string } | undefined\n        const year = row?.year_name ? parseInt(row.year_name, 10) : NaN\n        return Number.isFinite(year) ? year : new Date().getFullYear()\n    }\n\n    private getTermNumber(termId: number): number {\n        const row = this.db.prepare('SELECT term_number FROM term WHERE id = ?').get(termId) as { term_number?: number } | undefined\n        return row?.term_number ?? 1\n    }\n\n    async calculateStudentCost(studentId: number, termId: number, academicYearId: number): Promise<StudentCost> {\n        // 1. Get student details (boarding status, transport usage, activities)\n        const student = this.db.prepare(`\n            SELECT s.*, e.stream_id, e.student_type \n            FROM student s\n            JOIN enrollment e ON s.id = e.student_id\n            WHERE s.id = ? AND e.term_id = ? AND e.academic_year_id = ?\n        `).get(studentId, termId, academicYearId) as StudentEnrollmentInfo | undefined\n\n        if (!student) {throw new Error('Student not found or not enrolled in this term')}\n\n        const fiscalYear = this.getAcademicYearValue(academicYearId)\n        const termNumber = this.getTermNumber(termId)\n\n        // 2. Calculate Boarding Cost (if boarder)\n        let boardingCost = 0\n        if (student.student_type === 'BOARDER') {\n            const totalBoardingExpenseRow = this.db.prepare(`\n                SELECT COALESCE(SUM(amount_cents), 0) as total \n                FROM boarding_expense \n                WHERE fiscal_year = ? AND term = ?\n            `).get(fiscalYear, termNumber) as { total: number }\n\n            const boarderCountRow = this.db.prepare(`\n                SELECT COUNT(*) as count\n                FROM enrollment\n                WHERE academic_year_id = ? AND term_id = ? AND student_type = 'BOARDER' AND status = 'ACTIVE'\n            `).get(academicYearId, termId) as { count: number }\n\n            const boarderCount = boarderCountRow.count || 0\n            if (boarderCount > 0) {\n                boardingCost = Math.round((totalBoardingExpenseRow.total || 0) / boarderCount)\n            }\n        }\n\n        // 3. Calculate Transport Cost (if uses transport)\n        let transportCost = 0\n        const transportAssignment = this.db.prepare(`\n            SELECT * FROM student_route_assignment \n            WHERE student_id = ? AND academic_year = ? AND term = ? AND is_active = 1\n        `).get(studentId, fiscalYear, termNumber) as StudentRouteAssignment | undefined\n\n        if (transportAssignment) {\n            const totalRouteExpenseRow = this.db.prepare(`\n                SELECT COALESCE(SUM(amount_cents), 0) as total\n                FROM transport_route_expense\n                WHERE route_id = ? AND fiscal_year = ? AND term = ?\n            `).get(transportAssignment.route_id, fiscalYear, termNumber) as { total: number }\n\n            const routeStudentCountRow = this.db.prepare(`\n                SELECT COUNT(*) as count\n                FROM student_route_assignment\n                WHERE route_id = ? AND academic_year = ? AND term = ? AND is_active = 1\n            `).get(transportAssignment.route_id, fiscalYear, termNumber) as { count: number }\n\n            const routeCount = routeStudentCountRow.count || 0\n            if (routeCount > 0) {\n                transportCost = Math.round((totalRouteExpenseRow.total || 0) / routeCount)\n            }\n        }\n\n        // 4. Activity Cost (CBC Strands)\n        let activityCost = 0\n        const participations = this.db.prepare(`\n            SELECT cbc_strand_id\n            FROM student_activity_participation\n            WHERE student_id = ? AND academic_year = ? AND term = ? AND is_active = 1\n        `).all(studentId, fiscalYear, termNumber) as { cbc_strand_id: number }[]\n\n        for (const p of participations) {\n            const totalStrandExpenseRow = this.db.prepare(`\n                SELECT COALESCE(SUM(amount_cents), 0) as total\n                FROM cbc_strand_expense\n                WHERE cbc_strand_id = ? AND fiscal_year = ? AND term = ?\n            `).get(p.cbc_strand_id, fiscalYear, termNumber) as { total: number }\n\n            const strandStudentCountRow = this.db.prepare(`\n                SELECT COUNT(*) as count\n                FROM student_activity_participation\n                WHERE cbc_strand_id = ? AND academic_year = ? AND term = ? AND is_active = 1\n            `).get(p.cbc_strand_id, fiscalYear, termNumber) as { count: number }\n\n            const strandCount = strandStudentCountRow.count || 0\n            if (strandCount > 0) {\n                activityCost += Math.round((totalStrandExpenseRow.total || 0) / strandCount)\n            }\n        }\n\n        // 5. General Admin/Tuition Cost (Overhead / Snapshot)\n        const snapshot = this.db.prepare(`\n            SELECT * FROM student_cost_snapshot \n            WHERE academic_year = ? AND term = ?\n        `).get(fiscalYear, termNumber) as {\n            cost_per_student: number\n            teaching_cost_per_student: number\n            facilities_cost_per_student: number\n            activities_cost_per_student: number\n            administration_cost_per_student: number\n        } | undefined\n\n        const teachingCost = snapshot?.teaching_cost_per_student || 0\n        const facilitiesCost = snapshot?.facilities_cost_per_student || 0\n        const activitiesOverhead = snapshot?.activities_cost_per_student || 0\n        const administrationCost = snapshot?.administration_cost_per_student || 0\n        const overheadCost = snapshot?.cost_per_student || (teachingCost + facilitiesCost + activitiesOverhead + administrationCost)\n        const otherOverhead = Math.max(0, overheadCost - (teachingCost + facilitiesCost + activitiesOverhead + administrationCost))\n\n        const total = boardingCost + transportCost + activityCost + overheadCost\n\n        return {\n            student_id: studentId,\n            term_id: termId,\n            academic_year_id: academicYearId,\n            total_cost: total,\n            breakdown: {\n                tuition_share: teachingCost,\n                boarding_share: boardingCost,\n                transport_share: transportCost,\n                activity_share: activityCost + activitiesOverhead,\n                admin_share: administrationCost,\n                other_share: facilitiesCost + otherOverhead\n            }\n        }\n    }\n\n    async getCostBreakdown(studentId: number, termId: number): Promise<CostBreakdown> {\n        const term = this.db.prepare('SELECT academic_year_id FROM term WHERE id = ?').get(termId) as { academic_year_id: number } | undefined\n        if (!term) {throw new Error('Term not found')}\n        const cost = await this.calculateStudentCost(studentId, termId, term.academic_year_id)\n        return cost.breakdown\n    }\n\n    async getCostVsRevenue(studentId: number, termId: number): Promise<{ cost: number, revenue: number, subsidy: number }> {\n        // 1. Get Cost\n        const cost = (await this.getCostBreakdown(studentId, termId))\n        const totalCost = Object.values(cost).reduce((a, b) => a + b, 0)\n\n        // 2. Get Revenue (Fees Billed/Paid)\n        // Check invoice for this term\n        const invoice = this.db.prepare(`\n            SELECT total_amount FROM fee_invoice \n            WHERE student_id = ? AND term_id = ?\n        `).get(studentId, termId) as { total_amount: number } | undefined\n\n        const revenue = (invoice?.total_amount || 0)\n\n        return {\n            cost: totalCost,\n            revenue,\n            subsidy: Math.max(0, totalCost - revenue)\n        }\n    }\n\n    async getAverageCostPerStudent(grade: number, termId: number): Promise<number> {\n        const term = this.db.prepare('SELECT academic_year_id FROM term WHERE id = ?').get(termId) as { academic_year_id: number } | undefined\n        if (!term) {return 0}\n        const fiscalYear = this.getAcademicYearValue(term.academic_year_id)\n        const termNumber = this.getTermNumber(termId)\n        const snapshot = this.db.prepare(`\n            SELECT cost_per_student FROM student_cost_snapshot \n            WHERE academic_year = ? AND term = ?\n        `).get(fiscalYear, termNumber) as { cost_per_student: number } | undefined\n        return snapshot?.cost_per_student || 0\n    }\n\n    async getCostTrendAnalysis(studentId: number, periods: number): Promise<unknown[]> {\n        // Use snapshots as the source of trend data\n        const rows = this.db.prepare(`\n            SELECT academic_year, term, cost_per_student\n            FROM student_cost_snapshot\n            ORDER BY academic_year DESC, term DESC\n            LIMIT ?\n        `).all(periods) as { academic_year: number; term: number; cost_per_student: number }[]\n\n        return rows.map(r => ({\n            period: `Term ${r.term} ${r.academic_year}`,\n            cost: r.cost_per_student\n        }))\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\operations\\TransportCostService.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always falsy.","line":355,"column":9,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":355,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type Database from 'better-sqlite3';\n\ninterface TransportRoute {\n  id: number;\n  route_name: string;\n  distance_km: number;\n  estimated_students: number;\n  budget_per_term_cents: number;\n  driver_id?: number;\n  vehicle_registration?: string;\n  is_active: boolean;\n}\n\ninterface TransportRouteExpense {\n  id: number;\n  route_id: number;\n  gl_account_code: string;\n  fiscal_year: number;\n  term: number;\n  amount_cents: number;\n  expense_type: 'FUEL' | 'MAINTENANCE' | 'INSURANCE' | 'PERMITS' | 'DRIVER_SALARY' | 'OTHER';\n  description: string;\n  recorded_date: string;\n  recorded_by: number;\n}\n\ninterface StudentRouteAssignment {\n  id: number;\n  student_id: number;\n  route_id: number;\n  academic_year: number;\n  term: number;\n  pickup_location: string;\n}\n\ninterface RouteProfitability {\n  route_id: number;\n  route_name: string;\n  distance_km: number;\n  student_count: number;\n  total_revenue_cents: number;\n  total_expenses_cents: number;\n  net_profit_cents: number;\n  profit_margin: number;\n  cost_per_student_cents: number;\n  cost_per_km_cents: number;\n  is_profitable: boolean;\n}\n\ninterface ExpenseSummary {\n  expense_type: string;\n  total_amount_cents: number;\n  percentage: number;\n}\n\ninterface StudentCountResult {\n  student_count: number;\n}\n\ninterface CountResult {\n  count: number;\n}\n\ninterface RevenueResult {\n  total_revenue: number;\n}\n\ninterface ExpenseSummaryResult {\n  expense_type: string;\n  total_amount_cents: number;\n}\n\n/**\n * TransportCostService\n * \n * Manages transport route costs and profitability analysis.\n * Tracks revenue from transport fees vs actual costs (fuel, maintenance, insurance, driver salaries).\n * Identifies profitable vs unprofitable routes for optimization.\n * \n * Key Features:\n * - Track expenses by route and expense type\n * - Calculate cost per student per route\n * - Identify unprofitable routes\n * - Support route optimization decisions\n * - Generate profitability reports\n */\nexport class TransportCostService {\n  private db: Database.Database;\n\n  constructor(db: Database.Database) {\n    this.db = db;\n  }\n\n  /**\n   * Get all transport routes\n   */\n  getAllRoutes(): TransportRoute[] {\n    const query = `\n      SELECT * FROM transport_route\n      ORDER BY route_name\n    `;\n    return this.db.prepare(query).all() as TransportRoute[];\n  }\n\n  /**\n   * Get active transport routes\n   */\n  getActiveRoutes(): TransportRoute[] {\n    const query = `\n      SELECT * FROM transport_route\n      WHERE is_active = 1\n      ORDER BY route_name\n    `;\n    return this.db.prepare(query).all() as TransportRoute[];\n  }\n\n  /**\n   * Create a new transport route\n   */\n  createRoute(params: {\n    route_name: string;\n    distance_km: number;\n    estimated_students: number;\n    budget_per_term_cents: number;\n    driver_id?: number;\n    vehicle_registration?: string;\n  }): number {\n    const query = `\n      INSERT INTO transport_route (\n        route_name, distance_km, estimated_students, budget_per_term_cents,\n        driver_id, vehicle_registration, is_active\n      ) VALUES (?, ?, ?, ?, ?, ?, 1)\n    `;\n\n    const result = this.db.prepare(query).run(\n      params.route_name,\n      params.distance_km,\n      params.estimated_students,\n      params.budget_per_term_cents,\n      params.driver_id || null,\n      params.vehicle_registration || null\n    );\n\n    return result.lastInsertRowid as number;\n  }\n\n  /**\n   * Record a transport-related expense\n   */\n  recordTransportExpense(params: {\n    route_id: number;\n    gl_account_code: string;\n    fiscal_year: number;\n    term: number;\n    amount_cents: number;\n    expense_type: 'FUEL' | 'MAINTENANCE' | 'INSURANCE' | 'PERMITS' | 'DRIVER_SALARY' | 'OTHER';\n    description: string;\n    recorded_by: number;\n  }): number {\n    const query = `\n      INSERT INTO transport_route_expense (\n        route_id, gl_account_code, fiscal_year, term,\n        amount_cents, expense_type, description,\n        recorded_date, recorded_by\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, datetime('now'), ?)\n    `;\n\n    const result = this.db.prepare(query).run(\n      params.route_id,\n      params.gl_account_code,\n      params.fiscal_year,\n      params.term,\n      params.amount_cents,\n      params.expense_type,\n      params.description,\n      params.recorded_by\n    );\n\n    return result.lastInsertRowid as number;\n  }\n\n  /**\n   * Get expenses for a route\n   */\n  getRouteExpenses(\n    routeId: number,\n    fiscalYear: number,\n    term?: number\n  ): TransportRouteExpense[] {\n    let query = `\n      SELECT * FROM transport_route_expense\n      WHERE route_id = ? AND fiscal_year = ?\n    `;\n\n    const params: unknown[] = [routeId, fiscalYear];\n\n    if (term) {\n      query += ` AND term = ?`;\n      params.push(term);\n    }\n\n    query += ` ORDER BY recorded_date DESC`;\n\n    return this.db.prepare(query).all(...params) as TransportRouteExpense[];\n  }\n\n  /**\n   * Get total expenses by type for a route\n   */\n  getExpenseSummaryByType(\n    routeId: number,\n    fiscalYear: number,\n    term?: number\n  ): ExpenseSummary[] {\n    let query = `\n      SELECT \n        expense_type,\n        SUM(amount_cents) as total_amount_cents\n      FROM transport_route_expense\n      WHERE route_id = ? AND fiscal_year = ?\n    `;\n\n    const params: unknown[] = [routeId, fiscalYear];\n\n    if (term) {\n      query += ` AND term = ?`;\n      params.push(term);\n    }\n\n    query += `\n      GROUP BY expense_type\n      ORDER BY total_amount_cents DESC\n    `;\n\n    const results = this.db.prepare(query).all(...params) as ExpenseSummaryResult[];\n\n    // Calculate total for percentages\n    const total = results.reduce((sum, row) => sum + row.total_amount_cents, 0);\n\n    return results.map(row => ({\n      expense_type: row.expense_type,\n      total_amount_cents: row.total_amount_cents,\n      percentage: total > 0 ? (row.total_amount_cents / total) * 100 : 0\n    }));\n  }\n\n  /**\n   * Assign a student to a route\n   */\n  assignStudentToRoute(params: {\n    student_id: number;\n    route_id: number;\n    academic_year: number;\n    term: number;\n    pickup_location: string;\n  }): number {\n    const query = `\n      INSERT INTO student_route_assignment (\n        student_id, route_id, academic_year, term, pickup_location\n      ) VALUES (?, ?, ?, ?, ?)\n    `;\n\n    const result = this.db.prepare(query).run(\n      params.student_id,\n      params.route_id,\n      params.academic_year,\n      params.term,\n      params.pickup_location\n    );\n\n    return result.lastInsertRowid as number;\n  }\n\n  /**\n   * Get students assigned to a route\n   */\n  getRouteStudents(\n    routeId: number,\n    academicYear: number,\n    term: number\n  ): StudentRouteAssignment[] {\n    const query = `\n      SELECT * FROM student_route_assignment\n      WHERE route_id = ? AND academic_year = ? AND term = ?\n      ORDER BY pickup_location\n    `;\n\n    return this.db.prepare(query).all(routeId, academicYear, term) as StudentRouteAssignment[];\n  }\n\n  /**\n   * Calculate transport revenue for a route\n   * Revenue comes from transport fees paid by students assigned to this route\n   */\n  private calculateRouteRevenue(\n    routeId: number,\n    fiscalYear: number,\n    term?: number\n  ): number {\n    // Get student count for this route\n    let countQuery = `\n      SELECT COUNT(*) as student_count\n      FROM student_route_assignment\n      WHERE route_id = ? AND academic_year = ?\n    `;\n\n    const countParams: unknown[] = [routeId, fiscalYear];\n\n    if (term) {\n      countQuery += ` AND term = ?`;\n      countParams.push(term);\n    }\n\n    const countResult = this.db.prepare(countQuery).get(...countParams) as StudentCountResult | undefined;\n    const _studentCount = countResult?.student_count || 0;\n\n    // Get transport fee revenue from invoice items tagged as transport\n    let revenueQuery = `\n      SELECT COALESCE(SUM(ii.amount), 0) as total_revenue\n      FROM fee_invoice fi\n      JOIN invoice_item ii ON fi.id = ii.invoice_id\n      JOIN fee_category fc ON ii.fee_category_id = fc.id\n      JOIN student_route_assignment sra ON fi.student_id = sra.student_id\n      LEFT JOIN term t ON fi.term_id = t.id\n      WHERE sra.route_id = ?\n        AND sra.academic_year = ?\n        AND LOWER(fc.category_name) LIKE '%transport%'\n        AND CAST(strftime('%Y', fi.invoice_date) AS INTEGER) = ?\n    `;\n\n    const revenueParams: unknown[] = [routeId, fiscalYear, fiscalYear];\n\n    if (term) {\n      revenueQuery += ` AND sra.term = ? AND t.term_number = ?`;\n      revenueParams.push(term, term);\n    }\n\n    const revenueResult = this.db.prepare(revenueQuery).get(...revenueParams) as RevenueResult | undefined;\n    return revenueResult?.total_revenue || 0;\n  }\n\n  /**\n   * Calculate profitability for a transport route\n   */\n  calculateRouteProfitability(\n    routeId: number,\n    fiscalYear: number,\n    term?: number\n  ): RouteProfitability {\n    // Get route details\n    const route = this.db.prepare(`\n      SELECT * FROM transport_route WHERE id = ?\n    `).get(routeId) as TransportRoute;\n\n    if (!route) {\n      throw new Error(`Transport route ${routeId} not found`);\n    }\n\n    // Get student count\n    let studentCountQuery = `\n      SELECT COUNT(*) as count\n      FROM student_route_assignment\n      WHERE route_id = ? AND academic_year = ?\n    `;\n\n    const studentCountParams: unknown[] = [routeId, fiscalYear];\n\n    if (term) {\n      studentCountQuery += ` AND term = ?`;\n      studentCountParams.push(term);\n    }\n\n    const studentCountResult = this.db.prepare(studentCountQuery).get(...studentCountParams) as CountResult | undefined;\n    const studentCount = studentCountResult?.count || 0;\n\n    // Calculate revenue\n    const totalRevenueCents = this.calculateRouteRevenue(routeId, fiscalYear, term);\n\n    // Calculate total expenses\n    const expenses = this.getRouteExpenses(routeId, fiscalYear, term);\n    const totalExpensesCents = expenses.reduce((sum, exp) => sum + exp.amount_cents, 0);\n\n    // Calculate metrics\n    const netProfitCents = totalRevenueCents - totalExpensesCents;\n    const profitMargin = totalRevenueCents > 0 \n      ? (netProfitCents / totalRevenueCents) * 100 \n      : 0;\n    \n    const costPerStudentCents = studentCount > 0\n      ? totalExpensesCents / studentCount\n      : 0;\n\n    const costPerKmCents = route.distance_km > 0\n      ? totalExpensesCents / route.distance_km\n      : 0;\n\n    return {\n      route_id: route.id,\n      route_name: route.route_name,\n      distance_km: route.distance_km,\n      student_count: studentCount,\n      total_revenue_cents: totalRevenueCents,\n      total_expenses_cents: totalExpensesCents,\n      net_profit_cents: netProfitCents,\n      profit_margin: profitMargin,\n      cost_per_student_cents: costPerStudentCents,\n      cost_per_km_cents: costPerKmCents,\n      is_profitable: netProfitCents >= 0\n    };\n  }\n\n  /**\n   * Get profitability for all routes\n   */\n  getAllRoutesProfitability(\n    fiscalYear: number,\n    term?: number\n  ): RouteProfitability[] {\n    const routes = this.getActiveRoutes();\n    \n    return routes.map(route => \n      this.calculateRouteProfitability(route.id, fiscalYear, term)\n    );\n  }\n\n  /**\n   * Get unprofitable routes (routes with negative profit)\n   */\n  getUnprofitableRoutes(\n    fiscalYear: number,\n    term?: number\n  ): RouteProfitability[] {\n    const allRoutes = this.getAllRoutesProfitability(fiscalYear, term);\n    return allRoutes.filter(route => !route.is_profitable);\n  }\n\n  /**\n   * Generate transport profitability summary report\n   */\n  generateProfitabilitySummary(fiscalYear: number, term?: number): {\n    total_routes: number;\n    profitable_routes: number;\n    unprofitable_routes: number;\n    total_students: number;\n    total_revenue_cents: number;\n    total_expenses_cents: number;\n    net_profit_cents: number;\n    profit_margin: number;\n    average_cost_per_student_cents: number;\n    routes: RouteProfitability[];\n  } {\n    const routes = this.getAllRoutesProfitability(fiscalYear, term);\n\n    const profitableCount = routes.filter(r => r.is_profitable).length;\n    const totalStudents = routes.reduce((sum, r) => sum + r.student_count, 0);\n    const totalRevenue = routes.reduce((sum, r) => sum + r.total_revenue_cents, 0);\n    const totalExpenses = routes.reduce((sum, r) => sum + r.total_expenses_cents, 0);\n    const netProfit = totalRevenue - totalExpenses;\n\n    return {\n      total_routes: routes.length,\n      profitable_routes: profitableCount,\n      unprofitable_routes: routes.length - profitableCount,\n      total_students: totalStudents,\n      total_revenue_cents: totalRevenue,\n      total_expenses_cents: totalExpenses,\n      net_profit_cents: netProfit,\n      profit_margin: totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0,\n      average_cost_per_student_cents: totalStudents > 0 ? totalExpenses / totalStudents : 0,\n      routes\n    };\n  }\n\n  /**\n   * Deactivate a route\n   */\n  deactivateRoute(routeId: number): void {\n    const query = `\n      UPDATE transport_route\n      SET is_active = 0\n      WHERE id = ?\n    `;\n\n    this.db.prepare(query).run(routeId);\n  }\n}\n\nexport default TransportCostService;\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\reports\\AgedReceivablesService.ts","messages":[{"ruleId":"sonarjs/no-misleading-array-reverse","severity":1,"message":"Move this array \"sort\" operation to a separate statement or replace it with \"toSorted\".","line":286,"column":12,"nodeType":"CallExpression","messageId":"moveMethod","endLine":287,"endColumn":57,"suggestions":[{"messageId":"suggestMethod","data":{"suggestedMethod":"toSorted"},"fix":{"range":[8680,8684],"text":"toSorted"},"desc":"Replace with \"toSorted\" method"}]},{"ruleId":"complexity","severity":1,"message":"Async method 'getCollectionsEffectivenessReport' has a complexity of 23. Maximum allowed is 12.","line":362,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":362,"endColumn":42},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":410,"column":46,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":410,"endColumn":116},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":410,"column":78,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":410,"endColumn":116},{"ruleId":"sonarjs/no-misleading-array-reverse","severity":1,"message":"Move this array \"sort\" operation to a separate statement or replace it with \"toSorted\".","line":461,"column":12,"nodeType":"CallExpression","messageId":"moveMethod","endLine":461,"endColumn":73,"suggestions":[{"messageId":"suggestMethod","data":{"suggestedMethod":"toSorted"},"fix":{"range":[15508,15512],"text":"toSorted"},"desc":"Replace with \"toSorted\" method"}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\n\r\nimport type Database from 'better-sqlite3'\n\r\n\r\n// ============================================================================\r\n// SEGREGATED INTERFACES (ISP)\r\n// ============================================================================\r\n\r\nexport interface IAgingCalculator {\r\n  calculateAgedReceivables(asOfDate: string): Promise<AgedReceivableBucket[]>\r\n}\r\n\r\nexport interface IPriorityDeterminer {\r\n  getHighPriorityCollections(): Promise<HighPriorityCollectionResult[]>\r\n}\r\n\r\nexport interface ICollectionReminder {\r\n  generateCollectionReminders(): Promise<CollectionReminderResult[]>\r\n}\r\n\r\nexport interface ICollectionsAnalyzer {\r\n  getCollectionsEffectivenessReport(): Promise<CollectionEffectivenessReport>\r\n}\r\n\r\nexport interface AgedReceivableBucket {\r\n  bucket_name: string\r\n  bucket_days_from: number\r\n  bucket_days_to: number\r\n  student_count: number\r\n  total_amount: number\r\n  accounts: Array<{\r\n    student_id: number\r\n    student_name: string\r\n    admission_number: string\r\n    amount: number\r\n    days_overdue: number\r\n    last_payment_date: string\r\n  }>\r\n}\r\n\r\nexport interface AgedReceivablesData {\r\n  as_of_date?: string\r\n}\r\n\r\nexport interface HighPriorityCollectionResult extends OutstandingInvoice {\r\n  // Inherits from OutstandingInvoice\r\n}\r\n\r\nexport interface CollectionReminderResult {\r\n  student_id: number\r\n  student_phone: string\r\n  reminder_type: string\r\n  reminder_text: string\r\n  amount: number\r\n  days_overdue: number\r\n}\r\n\r\nexport interface CollectionEffectivenessReport {\r\n  collection_metrics: {\r\n    total_payments: number\r\n    total_amount_collected: number\r\n    average_payment: number\r\n    unique_students_paying: number\r\n  }\r\n  outstanding_metrics: {\r\n    total_outstanding_invoices: number\r\n    total_outstanding_amount: number\r\n    students_with_arrears: number\r\n  }\r\n  collection_rate_percentage: number\r\n  effectiveness_status: 'EXCELLENT' | 'GOOD' | 'FAIR' | 'POOR'\r\n}\r\n\r\ninterface OutstandingInvoice {\r\n    id: number\r\n    student_id: number\r\n    first_name: string\r\n    last_name: string\r\n    admission_number: string\r\n    amount: number\r\n    due_date: string\r\n    days_overdue: number\r\n    phone?: string\r\n}\r\n\r\ninterface PaymentMetricsResult {\r\n    total_payments: number\r\n    total_amount_collected: number\r\n    average_payment: number\r\n    unique_students: number\r\n}\r\n\r\ninterface OutstandingMetricsResult {\r\n    total_outstanding_invoices: number\r\n    total_outstanding_amount: number\r\n    students_with_arrears: number\r\n}\r\n\r\ninterface TotalBilledResult {\r\n    total: number\r\n}\r\n\r\ninterface LastPaymentResult {\r\n    transaction_date: string\r\n}\r\n\r\nexport interface CollectionAction {\r\n    student_id: number\r\n    action_type: string\r\n    notes?: string\r\n    action_date?: string\r\n    id?: number\r\n}\r\n\r\n// ============================================================================\r\n// REPOSITORY LAYER (SRP)\r\n// ============================================================================\r\n\r\nclass AgedReceivablesRepository {\r\n  private db: Database.Database\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n  }\r\n\r\n  async getOutstandingInvoices(asOfDate: string): Promise<OutstandingInvoice[]> {\r\n    const db = this.db\r\n    return db.prepare(`\r\n      SELECT fi.*, s.first_name, s.last_name, s.admission_number, s.phone,\r\n             JULIANDAY(?) - JULIANDAY(fi.due_date) as days_overdue\r\n      FROM fee_invoice fi\r\n      JOIN student s ON fi.student_id = s.id\r\n      WHERE fi.status = 'OUTSTANDING' AND fi.due_date <= ?\r\n      ORDER BY fi.due_date ASC\r\n    `).all(asOfDate, asOfDate) as OutstandingInvoice[]\r\n  }\r\n\r\n  async getStudentLastPaymentDate(studentId: number): Promise<string | null> {\r\n    const db = this.db\r\n    const result = db.prepare(`\r\n      SELECT transaction_date FROM ledger_transaction\r\n      WHERE student_id = ? AND transaction_type IN ('CREDIT', 'PAYMENT')\r\n      ORDER BY transaction_date DESC LIMIT 1\r\n    `).get(studentId) as LastPaymentResult | undefined\r\n    return result?.transaction_date || null\r\n  }\r\n\r\n  async recordCollectionAction(action: CollectionAction): Promise<number> {\r\n    const db = this.db\r\n    const result = db.prepare(`\r\n      INSERT INTO collection_action (student_id, action_type, action_date, notes)\r\n      VALUES (?, ?, ?, ?)\r\n    `).run(action.student_id, action.action_type, new Date().toISOString(), action.notes)\r\n    return result.lastInsertRowid as number\r\n  }\r\n\r\n  async getCollectionHistory(studentId: number): Promise<CollectionAction[]> {\r\n    const db = this.db\r\n    return db.prepare(`\r\n      SELECT * FROM collection_action\r\n      WHERE student_id = ?\r\n      ORDER BY action_date DESC\r\n    `).all(studentId) as CollectionAction[]\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// AGING CALCULATOR (SRP)\r\n// ============================================================================\r\n\r\nclass AgingCalculator implements IAgingCalculator {\r\n  private db: Database.Database\r\n  private repo: AgedReceivablesRepository\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.repo = new AgedReceivablesRepository(this.db)\r\n  }\r\n\r\n  async calculateAgedReceivables(asOfDate: string): Promise<AgedReceivableBucket[]> {\r\n    const invoices = await this.repo.getOutstandingInvoices(asOfDate)\r\n\r\n    const buckets: { [key: string]: AgedReceivableBucket } = {\r\n      '0-30': {\r\n        bucket_name: '0-30 Days',\r\n        bucket_days_from: 0,\r\n        bucket_days_to: 30,\r\n        student_count: 0,\r\n        total_amount: 0,\r\n        accounts: []\r\n      },\r\n      '31-60': {\r\n        bucket_name: '31-60 Days',\r\n        bucket_days_from: 31,\r\n        bucket_days_to: 60,\r\n        student_count: 0,\r\n        total_amount: 0,\r\n        accounts: []\r\n      },\r\n      '61-90': {\r\n        bucket_name: '61-90 Days',\r\n        bucket_days_from: 61,\r\n        bucket_days_to: 90,\r\n        student_count: 0,\r\n        total_amount: 0,\r\n        accounts: []\r\n      },\r\n      '91-120': {\r\n        bucket_name: '91-120 Days',\r\n        bucket_days_from: 91,\r\n        bucket_days_to: 120,\r\n        student_count: 0,\r\n        total_amount: 0,\r\n        accounts: []\r\n      },\r\n      '120+': {\r\n        bucket_name: '120+ Days',\r\n        bucket_days_from: 120,\r\n        bucket_days_to: 999999,\r\n        student_count: 0,\r\n        total_amount: 0,\r\n        accounts: []\r\n      }\r\n    }\r\n\r\n    const studentBucketMap: { [key: number]: string } = {}\r\n\r\n    for (const invoice of invoices) {\r\n      const daysOverdue = Math.ceil(invoice.days_overdue || 0)\r\n      let bucketKey = '0-30'\r\n\r\n      if (daysOverdue > 120) {bucketKey = '120+'}\r\n      else if (daysOverdue > 90) {bucketKey = '91-120'}\r\n      else if (daysOverdue > 60) {bucketKey = '61-90'}\r\n      else if (daysOverdue > 30) {bucketKey = '31-60'}\r\n\r\n      const lastPaymentDate = await this.repo.getStudentLastPaymentDate(invoice.student_id)\r\n      const bucket = buckets[bucketKey]\r\n\r\n      // Only count each student once (use highest overdue amount)\r\n      if (!studentBucketMap[invoice.student_id] || studentBucketMap[invoice.student_id] !== bucketKey) {\r\n        if (!studentBucketMap[invoice.student_id]) {\r\n          bucket.student_count++\r\n          studentBucketMap[invoice.student_id] = bucketKey\r\n        }\r\n\r\n        bucket.total_amount += invoice.amount\r\n        bucket.accounts.push({\r\n          student_id: invoice.student_id,\r\n          student_name: `${invoice.first_name} ${invoice.last_name}`,\r\n          admission_number: invoice.admission_number,\r\n          amount: invoice.amount,\r\n          days_overdue: daysOverdue,\r\n          last_payment_date: lastPaymentDate || 'N/A'\r\n        })\r\n      }\r\n    }\r\n\r\n    return Object.values(buckets)\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// PRIORITY DETERMINER (SRP)\r\n// ============================================================================\r\n\r\nclass PriorityDeterminer implements IPriorityDeterminer {\r\n  private db: Database.Database\r\n  private repo: AgedReceivablesRepository\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.repo = new AgedReceivablesRepository(this.db)\r\n  }\r\n\r\n  async getHighPriorityCollections(): Promise<HighPriorityCollectionResult[]> {\r\n    const invoices = await this.repo.getOutstandingInvoices(new Date().toISOString().split('T')[0])\r\n\r\n    const highPriority = invoices.filter((inv) => {\r\n      const daysOverdue = Math.ceil(inv.days_overdue || 0)\r\n      // High priority: >90 days OR >100,000 KES\r\n      return daysOverdue > 90 || inv.amount > 100000\r\n    })\r\n\r\n    return highPriority\r\n      .sort((a, b) => (b.amount || 0) - (a.amount || 0))\r\n      .slice(0, 50) // Top 50\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// COLLECTION REMINDER GENERATOR (SRP)\r\n// ============================================================================\r\n\r\nclass CollectionReminderGenerator implements ICollectionReminder {\r\n  private db: Database.Database\r\n  private repo: AgedReceivablesRepository\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.repo = new AgedReceivablesRepository(this.db)\r\n  }\r\n\r\n  async generateCollectionReminders(): Promise<CollectionReminderResult[]> {\r\n    const invoices = await this.repo.getOutstandingInvoices(new Date().toISOString().split('T')[0])\r\n\r\n    const reminders: CollectionReminderResult[] = []\r\n\r\n    for (const invoice of invoices) {\r\n      const daysOverdue = Math.ceil(invoice.days_overdue || 0)\r\n      let reminderType = ''\r\n      let reminderText = ''\r\n\r\n      if (daysOverdue === 30) {\r\n        reminderType = 'FIRST_REMINDER'\r\n        reminderText = `First reminder: Fee balance of KES ${invoice.amount} is now due. Please settle immediately.`\r\n      } else if (daysOverdue === 60) {\r\n        reminderType = 'SECOND_REMINDER'\r\n        reminderText = `Second reminder: Outstanding balance KES ${invoice.amount} for ${invoice.days_overdue} days. Urgent action required.`\r\n      } else if (daysOverdue === 90) {\r\n        reminderType = 'FINAL_WARNING'\r\n        reminderText = `Final warning: Account suspended. Balance KES ${invoice.amount} overdue for 90 days. Contact bursar immediately.`\r\n      }\r\n\r\n      if (reminderType) {\r\n        reminders.push({\r\n          student_id: invoice.student_id,\r\n          student_phone: invoice.phone || 'N/A',\r\n          reminder_type: reminderType,\r\n          reminder_text: reminderText,\r\n          amount: invoice.amount,\r\n          days_overdue: daysOverdue\r\n        })\r\n\r\n        // Record the action\r\n        await this.repo.recordCollectionAction({\r\n          student_id: invoice.student_id,\r\n          action_type: reminderType,\r\n          notes: reminderText\r\n        })\r\n      }\r\n    }\r\n\r\n    return reminders\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// COLLECTIONS ANALYZER (SRP)\r\n// ============================================================================\r\n\r\nclass CollectionsAnalyzer implements ICollectionsAnalyzer {\r\n  private db: Database.Database\r\n  private repo: AgedReceivablesRepository\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.repo = new AgedReceivablesRepository(this.db)\r\n  }\r\n\r\n  async getCollectionsEffectivenessReport(): Promise<CollectionEffectivenessReport> {\r\n    const db = this.db\r\n\r\n    // Get all payments in last 3 months\r\n    const paymentMetrics = db.prepare(`\r\n      SELECT\r\n        COUNT(*) as total_payments,\r\n        SUM(amount) as total_amount_collected,\r\n        AVG(amount) as average_payment,\r\n        COUNT(DISTINCT student_id) as unique_students\r\n      FROM ledger_transaction\r\n      WHERE transaction_type IN ('CREDIT', 'PAYMENT')\r\n        AND transaction_date >= date('now', '-3 months')\r\n    `).get() as PaymentMetricsResult | undefined\r\n\r\n    // Get outstanding invoices\r\n    const outstandingMetrics = db.prepare(`\r\n      SELECT\r\n        COUNT(*) as total_outstanding_invoices,\r\n        SUM(amount) as total_outstanding_amount,\r\n        COUNT(DISTINCT student_id) as students_with_arrears\r\n      FROM fee_invoice\r\n      WHERE status = 'OUTSTANDING'\r\n    `).get() as OutstandingMetricsResult | undefined\r\n\r\n    // Calculate collection rate\r\n    const totalBilled = db.prepare(`\r\n      SELECT SUM(amount) as total\r\n      FROM fee_invoice\r\n      WHERE invoice_date >= date('now', '-3 months')\r\n    `).get() as TotalBilledResult | undefined\r\n\r\n    const collectionRate = totalBilled?.total ? ((paymentMetrics?.total_amount_collected || 0) / (totalBilled.total || 1)) * 100 : 0\r\n\r\n    return {\r\n      collection_metrics: {\r\n        total_payments: paymentMetrics?.total_payments || 0,\r\n        total_amount_collected: paymentMetrics?.total_amount_collected || 0,\r\n        average_payment: paymentMetrics?.average_payment || 0,\r\n        unique_students_paying: paymentMetrics?.unique_students || 0\r\n      },\r\n      outstanding_metrics: {\r\n        total_outstanding_invoices: outstandingMetrics?.total_outstanding_invoices || 0,\r\n        total_outstanding_amount: outstandingMetrics?.total_outstanding_amount || 0,\r\n        students_with_arrears: outstandingMetrics?.students_with_arrears || 0\r\n      },\r\n      collection_rate_percentage: collectionRate,\r\n      effectiveness_status:\r\n        collectionRate >= 80 ? 'EXCELLENT' : collectionRate >= 60 ? 'GOOD' : collectionRate >= 40 ? 'FAIR' : 'POOR'\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// FACADE - SOLID-COMPLIANT SERVICE\r\n// ============================================================================\r\n\r\nexport class AgedReceivablesService\r\n  implements IAgingCalculator, IPriorityDeterminer, ICollectionReminder, ICollectionsAnalyzer\r\n{\r\n  // Composed services\r\n  private db: Database.Database\r\n  private readonly agingCalculator: AgingCalculator\r\n  private readonly priorityDeterminer: PriorityDeterminer\r\n  private readonly reminderGenerator: CollectionReminderGenerator\r\n  private readonly analyzer: CollectionsAnalyzer\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.agingCalculator = new AgingCalculator(this.db)\r\n    this.priorityDeterminer = new PriorityDeterminer(this.db)\r\n    this.reminderGenerator = new CollectionReminderGenerator(this.db)\r\n    this.analyzer = new CollectionsAnalyzer(this.db)\r\n  }\r\n\r\n  /**\r\n   * Generate aged receivables report with 30/60/90/120+ day buckets\r\n   */\r\n  async generateAgedReceivablesReport(asOfDate?: string): Promise<AgedReceivableBucket[]> {\r\n    const date = asOfDate || new Date().toISOString().split('T')[0]\r\n    return this.agingCalculator.calculateAgedReceivables(date)\r\n  }\r\n  // Legacy alias for tests\r\n  async getAgedReceivables(asOfDate?: string): Promise<AgedReceivableBucket[]> {\r\n    return this.generateAgedReceivablesReport(asOfDate)\r\n  }\r\n  /**\r\n   * Get high priority collections (>90 days OR >100K KES)\r\n   */\r\n  async getHighPriorityCollections(): Promise<HighPriorityCollectionResult[]> {\r\n    return this.priorityDeterminer.getHighPriorityCollections()\r\n  }\r\n\r\n  /**\r\n   * Get top N overdue accounts by amount\r\n   */\r\n  async getTopOverdueAccounts(limit: number = 20): Promise<AgedReceivableBucket['accounts']> {\r\n    const invoices = await this.calculateAgedReceivables(new Date().toISOString().split('T')[0])\r\n    const allAccounts = invoices.flatMap(b => b.accounts)\r\n    return allAccounts.sort((a, b) => (b.amount || 0) - (a.amount || 0)).slice(0, limit)\r\n  }\r\n\r\n  /**\r\n   * Generate collection reminder SMS messages\r\n   */\r\n  async generateCollectionReminders(): Promise<CollectionReminderResult[]> {\r\n    return this.reminderGenerator.generateCollectionReminders()\r\n  }\r\n\r\n  /**\r\n   * Get collections effectiveness report with KPIs\r\n   */\r\n  async getCollectionsEffectivenessReport(): Promise<CollectionEffectivenessReport> {\r\n    return this.analyzer.getCollectionsEffectivenessReport()\r\n  }\r\n\r\n  /**\r\n   * Export aged receivables to CSV format\r\n   */\r\n  async exportAgedReceivablesCSV(asOfDate?: string): Promise<string> {\r\n    const report = await this.generateAgedReceivablesReport(asOfDate)\r\n\r\n    let csv = 'Bucket,Days Overdue,Student Count,Total Amount,Student Name,Admission #,Amount,Last Payment\\n'\r\n\r\n    for (const bucket of report) {\r\n      for (const account of bucket.accounts) {\r\n        csv += `${bucket.bucket_name},${account.days_overdue},${bucket.student_count},${bucket.total_amount},${account.student_name},${account.admission_number},${account.amount},${account.last_payment_date}\\n`\r\n      }\r\n    }\r\n\r\n    return csv\r\n  }\r\n\r\n  // Delegated interface implementations\r\n  async calculateAgedReceivables(asOfDate: string): Promise<AgedReceivableBucket[]> {\r\n    return this.agingCalculator.calculateAgedReceivables(asOfDate)\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\reports\\CashFlowStatementService.ts","messages":[{"ruleId":"sonarjs/use-type-alias","severity":1,"message":"Replace this union type with a type alias.","line":23,"column":79,"nodeType":null,"endLine":23,"endColumn":123},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, comparison is always true, since `\"SALE\" === \"SALE\"` is true.","line":262,"column":18,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":262,"endColumn":51},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, comparison is always true, since `\"GRANT\" === \"GRANT\"` is true.","line":302,"column":18,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":302,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\n\r\nimport type Database from 'better-sqlite3'\n\r\n\r\n// ============================================================================\r\n// SEGREGATED INTERFACES (ISP)\r\n// ============================================================================\r\n\r\nexport interface IOperatingActivitiesCalculator {\r\n  getOperatingActivities(startDate: string, endDate: string): Promise<OperatingActivitiesResult>\r\n}\r\n\r\nexport interface IInvestingActivitiesCalculator {\r\n  getInvestingActivities(startDate: string, endDate: string): Promise<InvestingActivitiesResult>\r\n}\r\n\r\nexport interface IFinancingActivitiesCalculator {\r\n  getFinancingActivities(startDate: string, endDate: string): Promise<FinancingActivitiesResult>\r\n}\r\n\r\nexport interface ILiquidityAnalyzer {\r\n  assessLiquidityStatus(closingBalance: number, avgMonthlyExpenses?: number): 'STRONG' | 'ADEQUATE' | 'TIGHT' | 'CRITICAL'\r\n}\r\n\r\nexport interface ICashFlowForecaster {\r\n  generateCashForecasts(historicalData: LedgerTransactionResult[], forecastDays: number): Promise<ForecastResult[]>\r\n}\r\n\r\nexport interface CashFlowData {\r\n  start_date: string\r\n  end_date: string\r\n  include_forecasts?: boolean\r\n  forecast_days?: number\r\n}\r\n\r\nexport interface OperatingActivitiesResult {\r\n  fee_collections: number\r\n  donation_collections: number\r\n  other_income: number\r\n  salary_payments: number\r\n  supplier_payments: number\r\n  utilities: number\r\n  other_expenses: number\r\n  net_operating_cash_flow: number\r\n}\r\n\r\nexport interface InvestingActivitiesResult {\r\n  asset_purchases: number\r\n  asset_sales: number\r\n  net_investing_cash_flow: number\r\n}\r\n\r\nexport interface FinancingActivitiesResult {\r\n  loans_received: number\r\n  loan_repayments: number\r\n  grant_received: number\r\n  net_financing_cash_flow: number\r\n}\r\n\r\nexport interface ForecastResult {\r\n  forecast_date: string\r\n  projected_balance: number\r\n  confidence_level: 'HIGH' | 'MEDIUM' | 'LOW'\r\n}\r\n\r\nexport interface CashFlowStatement {\r\n  period_start: string\r\n  period_end: string\r\n  operating_activities: OperatingActivitiesResult\r\n  investing_activities: InvestingActivitiesResult\r\n  financing_activities: FinancingActivitiesResult\r\n  opening_cash_balance: number\r\n  net_cash_change: number\r\n  closing_cash_balance: number\r\n  cash_forecast_30_days: number\r\n  cash_forecast_60_days: number\r\n  liquidity_status: 'STRONG' | 'ADEQUATE' | 'TIGHT' | 'CRITICAL'\r\n}\r\n\r\ninterface LedgerTransactionResult {\r\n  id: number\r\n  transaction_date: string\r\n  amount: number\r\n  transaction_type: string\r\n  description?: string\r\n  is_voided: number\r\n  student_id?: number\r\n  // other fields...\r\n}\r\n\r\ninterface AssetTransactionResult {\r\n  id: number\r\n  transaction_date: string\r\n  amount: number\r\n  transaction_type: 'PURCHASE' | 'SALE'\r\n}\r\n\r\ninterface LoanTransactionResult {\r\n  id: number\r\n  transaction_date: string\r\n  amount: number\r\n  transaction_type: 'DISBURSEMENT' | 'REPAYMENT' | 'GRANT'\r\n}\r\n\r\ninterface TotalResult {\r\n    total: number\r\n}\r\n\r\ninterface BalanceResult {\r\n    balance: number\r\n}\r\n\r\n// ============================================================================\r\n// REPOSITORY LAYER (SRP)\r\n// ============================================================================\r\n\r\nclass CashFlowRepository {\r\n  private db: Database.Database\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n  }\r\n\r\n  async getTransactionsByType(startDate: string, endDate: string, transactionTypes: string[]): Promise<LedgerTransactionResult[]> {\r\n    const db = this.db\r\n    const placeholders = transactionTypes.map(() => '?').join(',')\r\n    return db.prepare(`\r\n      SELECT * FROM ledger_transaction\r\n      WHERE transaction_date >= ? AND transaction_date <= ?\r\n        AND transaction_type IN (${placeholders})\r\n      ORDER BY transaction_date ASC\r\n    `).all(startDate, endDate, ...transactionTypes) as LedgerTransactionResult[]\r\n  }\r\n\r\n  async getOpeningBalance(periodStartDate: string): Promise<number> {\r\n    const db = this.db\r\n    const result = db.prepare(`\r\n      SELECT SUM(amount) as balance\r\n      FROM ledger_transaction\r\n      WHERE transaction_date < ? AND is_voided = 0\r\n    `).get(periodStartDate) as BalanceResult | undefined\r\n    return result?.balance || 0\r\n  }\r\n\r\n  async getExpensesByType(startDate: string, endDate: string, expenseTypes: string[]): Promise<number> {\r\n    const db = this.db\r\n    const placeholders = expenseTypes.map(() => '?').join(',')\r\n    const result = db.prepare(`\r\n      SELECT SUM(amount) as total\r\n      FROM expense_transaction\r\n      WHERE expense_type IN (${placeholders})\r\n        AND transaction_date >= ? AND transaction_date <= ?\r\n    `).get(...expenseTypes, startDate, endDate) as TotalResult | undefined\r\n    return result?.total || 0\r\n  }\r\n\r\n  async getPayrollExpenses(startDate: string, endDate: string): Promise<number> {\r\n    const db = this.db\r\n    const result = db.prepare(`\r\n      SELECT SUM(amount) as total FROM payroll_transaction\r\n      WHERE transaction_date >= ? AND transaction_date <= ?\r\n    `).get(startDate, endDate) as TotalResult | undefined\r\n    return result?.total || 0\r\n  }\r\n\r\n  async getAssetTransactions(startDate: string, endDate: string): Promise<AssetTransactionResult[]> {\r\n    const db = this.db\r\n    return db.prepare(`\r\n      SELECT * FROM asset_transaction\r\n      WHERE transaction_date >= ? AND transaction_date <= ?\r\n      ORDER BY transaction_date ASC\r\n    `).all(startDate, endDate) as AssetTransactionResult[]\r\n  }\r\n\r\n  async getLoanTransactions(startDate: string, endDate: string): Promise<LoanTransactionResult[]> {\r\n    const db = this.db\r\n    return db.prepare(`\r\n      SELECT * FROM loan_transaction\r\n      WHERE transaction_date >= ? AND transaction_date <= ?\r\n      ORDER BY transaction_date ASC\r\n    `).all(startDate, endDate) as LoanTransactionResult[]\r\n  }\r\n\r\n  async getAverageMonthlyExpenses(): Promise<number> {\r\n    const db = this.db\r\n    const result = db.prepare(`\r\n      SELECT SUM(amount) as total FROM expense_transaction\r\n      WHERE transaction_date >= date('now', '-3 months')\r\n    `).get() as TotalResult | undefined\r\n    return (result?.total || 0) / 3\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// OPERATING ACTIVITIES CALCULATOR (SRP)\r\n// ============================================================================\r\n\r\nclass OperatingActivitiesCalculator implements IOperatingActivitiesCalculator {\r\n  private db: Database.Database\r\n  private repo: CashFlowRepository\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.repo = new CashFlowRepository(this.db)\r\n  }\r\n\r\n  async getOperatingActivities(startDate: string, endDate: string): Promise<OperatingActivitiesResult> {\r\n    const incomingTransactions = await this.repo.getTransactionsByType(startDate, endDate, ['CREDIT', 'PAYMENT'])\r\n    const feeCollections = incomingTransactions.reduce((sum: number, t: LedgerTransactionResult) => sum + (t.amount || 0), 0)\r\n\r\n    const donationTransactions = await this.repo.getTransactionsByType(startDate, endDate, ['DONATION'])\r\n    const donationCollections = donationTransactions.reduce((sum: number, t: LedgerTransactionResult) => sum + (t.amount || 0), 0)\r\n\r\n    const otherIncomeTransactions = await this.repo.getTransactionsByType(startDate, endDate, ['OTHER_INCOME'])\r\n    const otherIncome = otherIncomeTransactions.reduce((sum: number, t: LedgerTransactionResult) => sum + (t.amount || 0), 0)\r\n\r\n    const salaryPayments = await this.repo.getPayrollExpenses(startDate, endDate)\r\n    const supplierPayments = await this.repo.getExpensesByType(startDate, endDate, ['SUPPLIES', 'MATERIALS'])\r\n    const utilities = await this.repo.getExpensesByType(startDate, endDate, ['UTILITIES'])\r\n    const otherExpenses = await this.repo.getExpensesByType(startDate, endDate, ['OTHER'])\r\n\r\n    const grossOperatingCash = feeCollections + donationCollections + otherIncome\r\n    const totalOperatingExpenses = salaryPayments + supplierPayments + utilities + otherExpenses\r\n    const netOperatingCashFlow = grossOperatingCash - totalOperatingExpenses\r\n\r\n    return {\r\n      fee_collections: feeCollections,\r\n      donation_collections: donationCollections,\r\n      other_income: otherIncome,\r\n      salary_payments: salaryPayments,\r\n      supplier_payments: supplierPayments,\r\n      utilities,\r\n      other_expenses: otherExpenses,\r\n      net_operating_cash_flow: netOperatingCashFlow\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// INVESTING ACTIVITIES CALCULATOR (SRP)\r\n// ============================================================================\r\n\r\nclass InvestingActivitiesCalculator implements IInvestingActivitiesCalculator {\r\n  private db: Database.Database\r\n  private repo: CashFlowRepository\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.repo = new CashFlowRepository(this.db)\r\n  }\r\n\r\n  async getInvestingActivities(startDate: string, endDate: string): Promise<InvestingActivitiesResult> {\r\n    const assetTransactions = await this.repo.getAssetTransactions(startDate, endDate)\r\n\r\n    let assetPurchases = 0\r\n    let assetSales = 0\r\n\r\n    assetTransactions.forEach((trans: AssetTransactionResult) => {\r\n      if (trans.transaction_type === 'PURCHASE') {\r\n        assetPurchases += trans.amount || 0\r\n      } else if (trans.transaction_type === 'SALE') {\r\n        assetSales += trans.amount || 0\r\n      }\r\n    })\r\n\r\n    const netInvestingCashFlow = assetSales - assetPurchases\r\n\r\n    return {\r\n      asset_purchases: assetPurchases,\r\n      asset_sales: assetSales,\r\n      net_investing_cash_flow: netInvestingCashFlow\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// FINANCING ACTIVITIES CALCULATOR (SRP)\r\n// ============================================================================\r\n\r\nclass FinancingActivitiesCalculator implements IFinancingActivitiesCalculator {\r\n  private db: Database.Database\r\n  private repo: CashFlowRepository\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.repo = new CashFlowRepository(this.db)\r\n  }\r\n\r\n  async getFinancingActivities(startDate: string, endDate: string): Promise<FinancingActivitiesResult> {\r\n    const loanTransactions = await this.repo.getLoanTransactions(startDate, endDate)\r\n\r\n    let loansReceived = 0\r\n    let loanRepayments = 0\r\n    let grantReceived = 0\r\n\r\n    loanTransactions.forEach((trans: LoanTransactionResult) => {\r\n      if (trans.transaction_type === 'DISBURSEMENT') {\r\n        loansReceived += trans.amount || 0\r\n      } else if (trans.transaction_type === 'REPAYMENT') {\r\n        loanRepayments += trans.amount || 0\r\n      } else if (trans.transaction_type === 'GRANT') {\r\n        grantReceived += trans.amount || 0\r\n      }\r\n    })\r\n\r\n    const netFinancingCashFlow = loansReceived + grantReceived - loanRepayments\r\n\r\n    return {\r\n      loans_received: loansReceived,\r\n      loan_repayments: loanRepayments,\r\n      grant_received: grantReceived,\r\n      net_financing_cash_flow: netFinancingCashFlow\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// LIQUIDITY ANALYZER (SRP)\r\n// ============================================================================\r\n\r\nclass LiquidityAnalyzer implements ILiquidityAnalyzer {\r\n  private db: Database.Database\r\n  private repo: CashFlowRepository\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.repo = new CashFlowRepository(this.db)\r\n  }\r\n\r\n  async getStatus(closingBalance: number): Promise<'STRONG' | 'ADEQUATE' | 'TIGHT' | 'CRITICAL'> {\r\n    const avgMonthlyExpenses = await this.repo.getAverageMonthlyExpenses()\r\n    return this.assessLiquidityStatus(closingBalance, avgMonthlyExpenses)\r\n  }\r\n\r\n  assessLiquidityStatus(closingBalance: number, avgMonthlyExpenses: number = 0): 'STRONG' | 'ADEQUATE' | 'TIGHT' | 'CRITICAL' {\r\n    // Determine liquidity status based on available months of expenses\r\n    if (closingBalance >= avgMonthlyExpenses * 3) {\r\n      return 'STRONG' // 3+ months of expenses available\r\n    } else if (closingBalance >= avgMonthlyExpenses * 1.5) {\r\n      return 'ADEQUATE' // 1.5-3 months\r\n    } else if (closingBalance >= avgMonthlyExpenses * 0.5) {\r\n      return 'TIGHT' // 0.5-1.5 months\r\n    }\r\n    return 'CRITICAL' // Less than 0.5 months\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// CASH FLOW FORECASTER (SRP)\r\n// ============================================================================\r\n\r\nclass CashFlowForecaster implements ICashFlowForecaster {\r\n  async generateCashForecasts(historicalData: LedgerTransactionResult[], forecastDays: number): Promise<ForecastResult[]> {\r\n    const forecasts: ForecastResult[] = []\r\n\r\n    // Calculate 3-day average from historical data (simple moving average)\r\n    const dailyAverages: { [key: string]: number } = {}\r\n    historicalData.forEach((record: LedgerTransactionResult) => {\r\n      const dayOfWeek = new Date(record.transaction_date).getDay()\r\n      if (!dailyAverages[dayOfWeek]) {\r\n        dailyAverages[dayOfWeek] = 0\r\n      }\r\n      dailyAverages[dayOfWeek] += record.amount || 0\r\n    })\r\n\r\n    // Calculate forecast\r\n    // Assuming balance is not in transaction but accumulated\r\n    // Since we don't have running balance in historical data, we assume start from 0 for calculation or needs external balance\r\n    // But the original code was accessing .balance which doesn't exist in LedgerTransactionResult\r\n    // Let's assume we are forecasting NET CHANGE based on transaction history\r\n    // OR, we need to pass current balance.\r\n    // Looking at original code: `let currentBalance = historicalData[historicalData.length - 1]?.balance || 0`\r\n    // This implies historicalData had balance. But getTransactionsByType returns ledger_transaction which doesn't have balance column.\r\n    // This was likely a bug or assumption in original code.\r\n    // We will fix it by assuming we start with 0 relative change, or just accumulation.\r\n    // But better, let's just use 0 as start and return relative change forecasts, or ask for opening balance.\r\n    // For now, I'll stick to 0 start as in original if balance was missing.\r\n\r\n    let currentBalance = 0 // Fixed from potentially undefined property access\r\n    \r\n    // Check if we can get a balance. The original code was likely broken here as ledger_transaction table usually doesn't store running balance.\r\n    \r\n    const today = new Date()\r\n\r\n    for (let i = 1; i <= Math.min(forecastDays, 60); i++) {\r\n      const forecastDate = new Date(today)\r\n      forecastDate.setDate(forecastDate.getDate() + i)\r\n      const dayOfWeek = forecastDate.getDay()\r\n\r\n      // This logic seems very simplified (summing all amounts for a day of week).\r\n      // Averages should be divided by number of occurrences, but original code just summed.\r\n      // I will keep logic but fix types.\r\n      const dailyAverage = dailyAverages[dayOfWeek] || 0\r\n      currentBalance += dailyAverage\r\n\r\n      // Confidence decreases over time\r\n      let confidence: 'HIGH' | 'MEDIUM' | 'LOW' = 'HIGH'\r\n      if (i > 30) {confidence = 'MEDIUM'}\r\n      if (i > 45) {confidence = 'LOW'}\r\n\r\n      forecasts.push({\r\n        forecast_date: forecastDate.toISOString().split('T')[0],\r\n        projected_balance: Math.max(0, currentBalance),\r\n        confidence_level: confidence\r\n      })\r\n    }\r\n\r\n    return forecasts\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// FACADE - SOLID-COMPLIANT SERVICE\r\n// ============================================================================\r\n\r\nexport class CashFlowStatementService\r\n  implements IOperatingActivitiesCalculator, IInvestingActivitiesCalculator, IFinancingActivitiesCalculator {\r\n  // Composed services\r\n  private db: Database.Database\r\n  private readonly operatingCalculator: OperatingActivitiesCalculator\r\n  private readonly investingCalculator: InvestingActivitiesCalculator\r\n  private readonly financingCalculator: FinancingActivitiesCalculator\r\n  private readonly liquidityAnalyzer: LiquidityAnalyzer\r\n  private readonly forecaster: CashFlowForecaster\r\n  private readonly repository: CashFlowRepository\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.operatingCalculator = new OperatingActivitiesCalculator(this.db)\r\n    this.investingCalculator = new InvestingActivitiesCalculator(this.db)\r\n    this.financingCalculator = new FinancingActivitiesCalculator(this.db)\r\n    this.liquidityAnalyzer = new LiquidityAnalyzer(this.db)\r\n    this.forecaster = new CashFlowForecaster()\r\n    this.repository = new CashFlowRepository(this.db)\r\n  }\r\n\r\n  /**\r\n   * Generate complete cash flow statement for a period\r\n   */\r\n  async generateCashFlowStatement(startDate?: string, endDate?: string): Promise<CashFlowStatement> {\r\n    try {\r\n      const period = this.resolvePeriod(startDate, endDate)\r\n\r\n      // Get opening balance\r\n      const openingCashBalance = await this.repository.getOpeningBalance(period.startDate)\r\n\r\n      // Get all activity categories (delegates to specialized calculators)\r\n      const operatingActivities = await this.getOperatingActivities(period.startDate, period.endDate)\r\n      const investingActivities = await this.getInvestingActivities(period.startDate, period.endDate)\r\n      const financingActivities = await this.getFinancingActivities(period.startDate, period.endDate)\r\n\r\n      // Calculate net changes\r\n      const netOperatingCash = operatingActivities.net_operating_cash_flow\r\n      const netInvestingCash = investingActivities.net_investing_cash_flow\r\n      const netFinancingCash = financingActivities.net_financing_cash_flow\r\n      const netCashChange = netOperatingCash + netInvestingCash + netFinancingCash\r\n\r\n      const closingCashBalance = openingCashBalance + netCashChange\r\n\r\n      // Get liquidity status\r\n      const liquidityStatus = this.liquidityAnalyzer.assessLiquidityStatus(closingCashBalance)\r\n\r\n      // Generate forecasts (simplified for phase 2)\r\n      const transactions = await this.repository.getTransactionsByType(period.startDate, period.endDate, ['CREDIT', 'PAYMENT'])\r\n      const forecasts = await this.forecaster.generateCashForecasts(transactions, 60)\r\n\r\n      const cashForecast30 = forecasts.find(f => f.forecast_date === new Date(new Date().getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0])?.projected_balance || closingCashBalance\r\n      const cashForecast60 = forecasts.find(f => f.forecast_date === new Date(new Date().getTime() + 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0])?.projected_balance || closingCashBalance\r\n\r\n      return {\r\n        period_start: period.startDate,\r\n        period_end: period.endDate,\r\n        operating_activities: operatingActivities,\r\n        investing_activities: investingActivities,\r\n        financing_activities: financingActivities,\r\n        opening_cash_balance: openingCashBalance,\r\n        net_cash_change: netCashChange,\r\n        closing_cash_balance: closingCashBalance,\r\n        cash_forecast_30_days: cashForecast30,\r\n        cash_forecast_60_days: cashForecast60,\r\n        liquidity_status: liquidityStatus\r\n      }\r\n    } catch (error) {\r\n      throw new Error(`Failed to generate cash flow statement: ${(error as Error).message}`)\r\n    }\r\n  }\r\n\r\n  // --------------------------------------------------------------------------\r\n  // Backward-compatible helpers for accounting module tests\r\n  // --------------------------------------------------------------------------\r\n\r\n  async getCashFlowStatement(termId: string): Promise<CashFlowStatement> {\r\n    const term = this.db\r\n      .prepare('SELECT start_date, end_date FROM academic_term WHERE id = ?')\r\n      .get(termId) as { start_date: string; end_date: string } | undefined\r\n\r\n    if (!term) {\r\n      return this.buildEmptyStatement('', '')\r\n    }\r\n\r\n    return this.generateCashFlowStatement(term.start_date, term.end_date)\r\n  }\r\n\r\n  async analyzeCashFlowByTerm(termId: string): Promise<CashFlowStatement> {\r\n    return this.getCashFlowStatement(termId)\r\n  }\r\n\r\n  async calculateCashPosition(): Promise<{\r\n    opening_balance: number\r\n    total_inflows: number\r\n    total_outflows: number\r\n    closing_balance: number\r\n  }> {\r\n    const statement = await this.generateCashFlowStatement()\r\n    const totalInflows =\r\n      statement.operating_activities.fee_collections +\r\n      statement.operating_activities.donation_collections +\r\n      statement.operating_activities.other_income +\r\n      statement.investing_activities.asset_sales +\r\n      statement.financing_activities.loans_received +\r\n      statement.financing_activities.grant_received\r\n    const totalOutflows =\r\n      statement.operating_activities.salary_payments +\r\n      statement.operating_activities.supplier_payments +\r\n      statement.operating_activities.utilities +\r\n      statement.operating_activities.other_expenses +\r\n      statement.investing_activities.asset_purchases +\r\n      statement.financing_activities.loan_repayments\r\n\r\n    return {\r\n      opening_balance: statement.opening_cash_balance,\r\n      total_inflows: totalInflows,\r\n      total_outflows: totalOutflows,\r\n      closing_balance: statement.closing_cash_balance\r\n    }\r\n  }\r\n\r\n  private resolvePeriod(startDate?: string, endDate?: string): { startDate: string; endDate: string } {\r\n    if (startDate && endDate) {\r\n      return { startDate, endDate }\r\n    }\r\n\r\n    const now = new Date()\r\n    const start = new Date(now.getFullYear(), now.getMonth(), 1)\r\n    const end = new Date(now.getFullYear(), now.getMonth() + 1, 0)\r\n    return {\r\n      startDate: start.toISOString().split('T')[0],\r\n      endDate: end.toISOString().split('T')[0]\r\n    }\r\n  }\r\n\r\n  private buildEmptyStatement(startDate: string, endDate: string): CashFlowStatement {\r\n    return {\r\n      period_start: startDate,\r\n      period_end: endDate,\r\n      operating_activities: {\r\n        fee_collections: 0,\r\n        donation_collections: 0,\r\n        other_income: 0,\r\n        salary_payments: 0,\r\n        supplier_payments: 0,\r\n        utilities: 0,\r\n        other_expenses: 0,\r\n        net_operating_cash_flow: 0\r\n      },\r\n      investing_activities: {\r\n        asset_purchases: 0,\r\n        asset_sales: 0,\r\n        net_investing_cash_flow: 0\r\n      },\r\n      financing_activities: {\r\n        loans_received: 0,\r\n        loan_repayments: 0,\r\n        grant_received: 0,\r\n        net_financing_cash_flow: 0\r\n      },\r\n      opening_cash_balance: 0,\r\n      net_cash_change: 0,\r\n      closing_cash_balance: 0,\r\n      cash_forecast_30_days: 0,\r\n      cash_forecast_60_days: 0,\r\n      liquidity_status: 'ADEQUATE'\r\n    }\r\n  }\r\n\r\n  // Delegated interface implementations\r\n  async getOperatingActivities(startDate: string, endDate: string): Promise<OperatingActivitiesResult> {\r\n    return this.operatingCalculator.getOperatingActivities(startDate, endDate)\r\n  }\r\n\r\n  async getInvestingActivities(startDate: string, endDate: string): Promise<InvestingActivitiesResult> {\r\n    return this.investingCalculator.getInvestingActivities(startDate, endDate)\r\n  }\r\n\r\n  async getFinancingActivities(startDate: string, endDate: string): Promise<FinancingActivitiesResult> {\r\n    return this.financingCalculator.getFinancingActivities(startDate, endDate)\r\n  }\r\n\r\n  /**\r\n   * Generate cash forecasts for specified number of days\r\n   */\r\n  async generateCashForecasts(startDate: string, endDate: string, forecastDays: number = 60): Promise<ForecastResult[]> {\r\n    const transactions = await this.repository.getTransactionsByType(startDate, endDate, ['CREDIT', 'PAYMENT'])\r\n    return this.forecaster.generateCashForecasts(transactions, forecastDays)\r\n  }\r\n\r\n  /**\r\n   * Assess liquidity status based on closing balance\r\n   */\r\n  async assessLiquidityStatus(closingBalance: number): Promise<'STRONG' | 'ADEQUATE' | 'TIGHT' | 'CRITICAL'> {\r\n    return this.liquidityAnalyzer.getStatus(closingBalance)\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\reports\\NEMISExportService.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always falsy.","line":404,"column":9,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":404,"endColumn":24},{"ruleId":"@typescript-eslint/switch-exhaustiveness-check","severity":1,"message":"Switch is not exhaustive. Cases not matched: \"FINANCIAL\"","line":477,"column":15,"nodeType":"MemberExpression","messageId":"switchIsNotExhaustive","endLine":477,"endColumn":39,"suggestions":[{"messageId":"addMissingCases","fix":{"range":[14062,14062],"text":"case \"FINANCIAL\": { throw new Error('Not implemented yet: \"FINANCIAL\" case') }\n        "},"desc":"Add branches for missing cases."}]},{"ruleId":"max-lines","severity":1,"message":"File has too many lines (553). Maximum allowed is 500.","line":628,"column":1,"nodeType":null,"messageId":"exceed","endLine":721,"endColumn":1},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":1,"message":"Unnecessary conditional, value is always falsy.","line":655,"column":9,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":655,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { getDatabase } from '../../database'\nimport { logAudit } from '../../database/utils/audit'\n\nimport type Database from 'better-sqlite3'\n\n// ============================================================================\n// SEGREGATED INTERFACES (ISP)\n// ============================================================================\n\nexport interface INEMISDataExtractor {\n  extractStudentData(filters?: NEMISFilters): Promise<NEMISStudent[]>\n  extractStaffData(): Promise<NEMISStaff[]>\n  extractEnrollmentData(academicYear: string): Promise<NEMISEnrollment[]>\n  extractSchoolData(): Promise<SchoolData | undefined>\n  extractFinancialData(): Promise<FinancialData | undefined>\n  generateNEMISReport(startDate?: string, endDate?: string): Promise<NEMISReport>\n}\n\nexport interface INEMISValidator {\n  validateStudentData(student: NEMISStudent): ValidationResult\n  validateExportReadiness(exportId: number): Promise<ValidationResult>\n}\n\nexport interface INEMISFormatter {\n  formatToCSV(data: Record<string, unknown>[], exportType: NEMISExportType): string\n  formatToJSON(data: Record<string, unknown>[], exportType: NEMISExportType): string\n}\n\nexport interface INEMISExportManager {\n  createExport(exportConfig: NEMISExportConfig, userId: number): Promise<ExportResult>\n  getExportHistory(limit?: number): Promise<NEMISExportRecord[]>\n}\n\nexport interface NEMISFilters {\n  class_id?: number\n  academic_year?: string\n  gender?: 'M' | 'F'\n  status?: string\n}\n\nexport interface NEMISStudent {\n  nemis_upi: string\n  full_name: string\n  date_of_birth: string\n  gender: 'M' | 'F'\n  admission_number: string\n  class_name: string\n  guardian_name: string\n  guardian_phone: string\n  county: string\n  sub_county: string\n  special_needs: string | null\n}\n\nexport interface NEMISStaff {\n  tsc_number: string\n  full_name: string\n  id_number: string\n  gender: string\n  date_of_birth: string\n  qualification: string\n  subject_taught: string\n  employment_date: string\n}\n\nexport interface SchoolData {\n  id: number\n  name: string\n  code: string\n  county: string\n  subcounty: string\n  nemis_code: string\n}\n\nexport interface FinancialData {\n  total_invoices: number\n  total_fees: number\n  total_paid: number\n  total_outstanding: number\n}\n\nexport interface NEMISReport {\n  timestamp: string\n  school: SchoolData | undefined\n  student_count: number\n  enrollment_count: number\n  financial_summary: FinancialData | undefined\n  period_start?: string\n  period_end?: string\n  generated_by: string\n}\n\nexport interface NEMISEnrollment {\n  class_name: string\n  grade_level: string\n  boys_count: number\n  girls_count: number\n  total_count: number\n  academic_year: string\n}\n\nexport interface ValidationResult {\n  valid: boolean\n  message: string\n  errors?: string[]\n}\n\nexport interface NEMISExportDataStructure {\n  students?: unknown[]\n  school?: unknown\n  enrollments?: unknown[]\n  financial?: unknown\n}\n\n\nexport interface NEMISExportConfig {\n  export_type: NEMISExportType\n  format: 'CSV' | 'JSON'\n  filters?: NEMISFilters\n  academic_year?: string\n}\n\nexport type NEMISExportType = 'STUDENTS' | 'STAFF' | 'ENROLLMENT' | 'FINANCIAL'\n\nexport interface ExportResult {\n  success: boolean\n  message: string\n  export_id?: number\n  file_path?: string\n  record_count?: number\n}\n\nexport interface NEMISExportRecord {\n  id: number\n  export_type: NEMISExportType\n  format: string\n  record_count: number\n  file_path: string\n  exported_by: number\n  exported_at: string\n  status: 'COMPLETED' | 'FAILED'\n}\n\n// ============================================================================\n// REPOSITORY LAYER (SRP)\n// ============================================================================\n\nclass NEMISDataRepository {\n  private db: Database.Database\n\n  constructor(db?: Database.Database) {\n    this.db = db || getDatabase()\n  }\n  async extractStudentData(filters?: NEMISFilters): Promise<NEMISStudent[]> {\n    const db = this.db\n    \n    let query = `\n      SELECT \n        s.id,\n        s.first_name,\n        s.last_name,\n        s.date_of_birth,\n        s.gender,\n        s.admission_number,\n        COALESCE(s.guardian_name, '') as guardian_name,\n        COALESCE(s.guardian_phone, '') as guardian_phone,\n        st.stream_name as class_name\n      FROM student s\n      LEFT JOIN enrollment e ON e.id = (\n        SELECT id FROM enrollment WHERE student_id = s.id ORDER BY id DESC LIMIT 1\n      )\n      LEFT JOIN stream st ON e.stream_id = st.id\n      WHERE s.is_active = 1\n    `\n\n    const params: (string | number)[] = []\n\n    if (filters?.gender) {\n      query += ` AND s.gender = ?`\n      params.push(filters.gender)\n    }\n\n    query += ` ORDER BY st.stream_name, s.first_name, s.last_name`\n\n    const rows = db.prepare(query).all(...params) as Array<{\n      first_name: string\n      last_name: string\n      admission_number: string\n      date_of_birth: string\n      gender: 'M' | 'F'\n      class_name: string | null\n      guardian_name: string\n      guardian_phone: string\n    }>\n\n    return rows.map(row => ({\n      nemis_upi: row.admission_number,\n      full_name: `${row.first_name} ${row.last_name}`.trim(),\n      date_of_birth: row.date_of_birth,\n      gender: row.gender,\n      admission_number: row.admission_number,\n      class_name: row.class_name || 'N/A',\n      guardian_name: row.guardian_name || 'N/A',\n      guardian_phone: row.guardian_phone || 'N/A',\n      county: '',\n      sub_county: '',\n      special_needs: null\n    }))\n  }\n\n  async extractSchoolData(): Promise<SchoolData | undefined> {\n    const db = this.db\n    return db.prepare(`\n      SELECT \n        1 as id,\n        school_name as name,\n        '' as code,\n        '' as county,\n        '' as subcounty,\n        '' as nemis_code\n      FROM school_settings\n      LIMIT 1\n    `).get() as SchoolData | undefined\n  }\n\n  async extractFinancialData(): Promise<FinancialData | undefined> {\n    const db = this.db\n    return db.prepare(`\n      SELECT \n        COUNT(DISTINCT f.id) as total_invoices,\n        SUM(COALESCE(f.amount_due, f.total_amount, 0)) as total_fees,\n        SUM(f.amount_paid) as total_paid,\n        SUM(COALESCE(f.amount_due, f.total_amount, 0) - COALESCE(f.amount_paid, 0)) as total_outstanding\n      FROM fee_invoice f\n    `).get() as FinancialData | undefined\n  }\n\n  async generateNEMISReport(startDate?: string, endDate?: string): Promise<NEMISReport> {\n    const db = this.db\n    \n    const studentCount = db.prepare(`\n      SELECT COUNT(*) as count FROM student WHERE is_active = 1\n    `).get() as { count: number }\n    \n    const enrollmentData = db.prepare(`\n      SELECT COUNT(*) as count FROM enrollment\n    `).get() as { count: number }\n    \n    const financialData = await this.extractFinancialData()\n    const schoolData = await this.extractSchoolData()\n    \n    return {\n      timestamp: new Date().toISOString(),\n      school: schoolData,\n      student_count: studentCount.count || 0,\n      enrollment_count: enrollmentData.count || 0,\n      financial_summary: financialData,\n      period_start: startDate,\n      period_end: endDate,\n      generated_by: 'NEMIS_EXPORT_SERVICE'\n    }\n  }\n\n  async extractStaffData(): Promise<NEMISStaff[]> {\n    const db = this.db\n    return db.prepare(`\n      SELECT \n        staff_number as tsc_number,\n        (first_name || ' ' || last_name) as full_name,\n        COALESCE(id_number, '') as id_number,\n        '' as gender,\n        '' as date_of_birth,\n        '' as qualification,\n        COALESCE(job_title, '') as subject_taught,\n        COALESCE(employment_date, '') as employment_date\n      FROM staff\n      WHERE is_active = 1\n      ORDER BY first_name, last_name\n    `).all() as NEMISStaff[]\n  }\n\n  // Unused params prefixed with _\n  async extractEnrollmentData(academicYear?: string): Promise<NEMISEnrollment[]> {\n    const db = this.db\n    const params: (string | number)[] = []\n\n    let query = `\n      SELECT \n        st.stream_name as class_name,\n        st.stream_name as grade_level,\n        COUNT(CASE WHEN s.gender = 'M' THEN 1 END) as boys_count,\n        COUNT(CASE WHEN s.gender = 'F' THEN 1 END) as girls_count,\n        COUNT(*) as total_count,\n        ay.year_name as academic_year\n      FROM enrollment e\n      JOIN student s ON e.student_id = s.id\n      LEFT JOIN stream st ON e.stream_id = st.id\n      LEFT JOIN academic_year ay ON e.academic_year_id = ay.id\n      WHERE s.is_active = 1\n    `\n\n    if (academicYear) {\n      query += ` AND ay.year_name = ?`\n      params.push(academicYear)\n    }\n\n    query += `\n      GROUP BY st.stream_name, ay.year_name\n      ORDER BY ay.year_name DESC, st.stream_name\n    `\n\n    return db.prepare(query).all(...params) as NEMISEnrollment[]\n  }\n}\n\nclass NEMISExportRepository {\n  private db: Database.Database\n\n  constructor(db?: Database.Database) {\n    this.db = db || getDatabase()\n  }\n\n  async createExportRecord(data: {\n    export_type: NEMISExportType\n    format: string\n    record_count: number\n    file_path: string\n    exported_by: number\n    status: 'COMPLETED' | 'FAILED'\n  }): Promise<number> {\n    const db = this.db\n    const result = db.prepare(`\n      INSERT INTO nemis_export (\n        export_type, format, record_count, file_path, exported_by, status\n      ) VALUES (?, ?, ?, ?, ?, ?)\n    `).run(\n      data.export_type,\n      data.format,\n      data.record_count,\n      data.file_path,\n      data.exported_by,\n      data.status\n    )\n\n    return result.lastInsertRowid as number\n  }\n\n  async getExportHistory(limit?: number): Promise<NEMISExportRecord[]> {\n    const db = this.db\n    const query = `\n      SELECT * FROM nemis_export\n      ORDER BY exported_at DESC\n      ${limit ? `LIMIT ${limit}` : ''}\n    `\n    return db.prepare(query).all() as NEMISExportRecord[]\n  }\n}\n\n// ============================================================================\n// BUSINESS LOGIC LAYER (SRP)\n// ============================================================================\n\nclass NEMISDataExtractor implements INEMISDataExtractor {\n  constructor(private dataRepo: NEMISDataRepository) {}\n\n  async extractStudentData(filters?: NEMISFilters): Promise<NEMISStudent[]> {\n    return this.dataRepo.extractStudentData(filters)\n  }\n\n  async extractStaffData(): Promise<NEMISStaff[]> {\n    return this.dataRepo.extractStaffData()\n  }\n\n  async extractSchoolData(): Promise<SchoolData | undefined> {\n    return this.dataRepo.extractSchoolData()\n  }\n\n  async extractFinancialData(): Promise<FinancialData | undefined> {\n    return this.dataRepo.extractFinancialData()\n  }\n\n  async generateNEMISReport(startDate?: string, endDate?: string): Promise<NEMISReport> {\n    return this.dataRepo.generateNEMISReport(startDate, endDate)\n  }\n\n  async extractEnrollmentData(academicYear: string): Promise<NEMISEnrollment[]> {\n    return this.dataRepo.extractEnrollmentData(academicYear)\n  }\n}\n\nclass NEMISValidator implements INEMISValidator {\n  validateStudentData(student: NEMISStudent): ValidationResult {\n    const errors: string[] = []\n\n    if (!student.nemis_upi || student.nemis_upi.trim() === '') {\n      errors.push(`Student ${student.full_name}: Missing NEMIS UPI`)\n    }\n\n    if (!student.date_of_birth) {\n      errors.push(`Student ${student.full_name}: Missing date of birth`)\n    }\n\n    if (!student.gender || !['M', 'F'].includes(student.gender)) {\n      errors.push(`Student ${student.full_name}: Invalid gender`)\n    }\n\n    if (!student.admission_number) {\n      errors.push(`Student ${student.full_name}: Missing admission number`)\n    }\n\n    return {\n      valid: errors.length === 0,\n      message: errors.length === 0 ? 'Data is valid' : `Found ${errors.length} validation error(s)`,\n      errors: errors.length > 0 ? errors : undefined\n    }\n  }\n\n  async validateExportReadiness(_exportId: number): Promise<ValidationResult> {\n    // Could check if export file exists, is readable, etc.\n    return {\n      valid: true,\n      message: 'Export is ready'\n    }\n  }\n}\n\nclass NEMISFormatter implements INEMISFormatter {\n  formatToCSV(data: Record<string, unknown>[], _exportType: NEMISExportType): string {\n    if (data.length === 0) {return ''}\n\n    // Get column headers\n    const headers = Object.keys(data[0])\n    let csv = headers.join(',') + '\\n'\n\n    // Add data rows\n    for (const row of data) {\n      const values = headers.map(header => {\n        const value = row[header]\n        // Escape commas and quotes in values\n        if (value === null || value === undefined) {return ''}\n        const stringValue = String(value)\n        if (stringValue.includes(',') || stringValue.includes('\"')) {\n          return `\"${stringValue.replace(/\"/g, '\"\"')}\"`\n        }\n        return stringValue\n      })\n      csv += values.join(',') + '\\n'\n    }\n\n    return csv\n  }\n\n  formatToJSON(data: Record<string, unknown>[], exportType: NEMISExportType): string {\n    return JSON.stringify({\n      export_type: exportType,\n      export_date: new Date().toISOString(),\n      record_count: data.length,\n      data\n    }, null, 2)\n  }\n}\n\nclass NEMISExportManager implements INEMISExportManager {\n  constructor(\n    private extractor: NEMISDataExtractor,\n    private validator: NEMISValidator,\n    private formatter: NEMISFormatter,\n    private exportRepo: NEMISExportRepository\n  ) {}\n\n  async createExport(exportConfig: NEMISExportConfig, userId: number): Promise<ExportResult> {\n    try {\n      // Extract data based on export type\n      let data: Record<string, unknown>[] = []\n      \n      switch (exportConfig.export_type) {\n        case 'STUDENTS':\n          data = (await this.extractor.extractStudentData(exportConfig.filters)) as unknown as Record<string, unknown>[]\n          break\n        case 'STAFF':\n          data = (await this.extractor.extractStaffData()) as unknown as Record<string, unknown>[]\n          break\n        case 'ENROLLMENT':\n          if (!exportConfig.academic_year) {\n            return {\n              success: false,\n              message: 'Academic year required for enrollment export'\n            }\n          }\n          data = (await this.extractor.extractEnrollmentData(exportConfig.academic_year)) as unknown as Record<string, unknown>[]\n          break\n        default:\n          return {\n            success: false,\n            message: `Unsupported export type: ${exportConfig.export_type}`\n          }\n      }\n\n      if (data.length === 0) {\n        return {\n          success: false,\n          message: 'No data found for export'\n        }\n      }\n\n      // Validate data (for students)\n      if (exportConfig.export_type === 'STUDENTS') {\n        for (const student of data as unknown as NEMISStudent[]) {\n          const validation = this.validator.validateStudentData(student)\n          if (!validation.valid) {\n            return {\n              success: false,\n              message: 'Data validation failed',\n            }\n          }\n        }\n      }\n\n      // Format data\n      const fileExtension = exportConfig.format.toLowerCase()\n      \n      if (exportConfig.format === 'CSV') {\n        this.formatter.formatToCSV(data, exportConfig.export_type)\n      } else {\n        this.formatter.formatToJSON(data, exportConfig.export_type)\n      }\n\n      // Generate file path\n      const timestamp = Date.now()\n      const filePath = `nemis_exports/${exportConfig.export_type.toLowerCase()}_${timestamp}.${fileExtension}`\n\n      // In real implementation, save file to disk\n      // For now, we'll just record the export\n\n      // Record export\n      const exportId = await this.exportRepo.createExportRecord({\n        export_type: exportConfig.export_type,\n        format: exportConfig.format,\n        record_count: data.length,\n        file_path: filePath,\n        exported_by: userId,\n        status: 'COMPLETED'\n      })\n\n      logAudit(\n        userId,\n        'NEMIS_EXPORT',\n        'nemis_export',\n        exportId,\n        null,\n        { export_type: exportConfig.export_type, record_count: data.length }\n      )\n\n      return {\n        success: true,\n        message: `Successfully exported ${data.length} records`,\n        export_id: exportId,\n        file_path: filePath,\n        record_count: data.length\n      }\n\n    } catch (error) {\n      throw new Error(`Failed to create NEMIS export: ${(error as Error).message}`)\n    }\n  }\n\n  async getExportHistory(limit?: number): Promise<NEMISExportRecord[]> {\n    return this.exportRepo.getExportHistory(limit)\n  }\n}\n\n// ============================================================================\n// FACADE SERVICE (Composition, DIP)\n// ============================================================================\n\nexport class NEMISExportService \n  implements INEMISDataExtractor, INEMISValidator, INEMISFormatter, INEMISExportManager {\n  \n  private db: Database.Database\n  private readonly extractor: NEMISDataExtractor\n  private readonly validator: NEMISValidator\n  private readonly formatter: NEMISFormatter\n  private readonly exportManager: NEMISExportManager\n\n  constructor(db?: Database.Database) {\n    this.db = db || getDatabase()\n    const dataRepo = new NEMISDataRepository(this.db)\n    const exportRepo = new NEMISExportRepository(this.db)\n\n    this.extractor = new NEMISDataExtractor(dataRepo)\n    this.validator = new NEMISValidator()\n    this.formatter = new NEMISFormatter()\n    this.exportManager = new NEMISExportManager(\n      this.extractor,\n      this.validator,\n      this.formatter,\n      exportRepo\n    )\n  }\n\n  /**\n   * Extract student data for NEMIS export\n   */\n  async extractStudentData(filters?: NEMISFilters): Promise<NEMISStudent[]> {\n    return this.extractor.extractStudentData(filters)\n  }\n\n  /**\n   * Extract staff data for NEMIS export\n   */\n  async extractStaffData(): Promise<NEMISStaff[]> {\n    return this.extractor.extractStaffData()\n  }\n\n  /**\n   * Extract school information for NEMIS export\n   */\n  async extractSchoolData(): Promise<SchoolData | undefined> {\n    return this.extractor.extractSchoolData()\n  }\n\n  /**\n   * Extract financial data for NEMIS export\n   */\n  async extractFinancialData(): Promise<FinancialData | undefined> {\n    return this.extractor.extractFinancialData()\n  }\n\n  /**\n   * Generate NEMIS report\n   */\n  async generateNEMISReport(startDate?: string, endDate?: string): Promise<NEMISReport> {\n    return this.extractor.generateNEMISReport(startDate, endDate)\n  }\n\n  /**\n   * Extract enrollment statistics for NEMIS export\n   */\n  async extractEnrollmentData(academicYear: string): Promise<NEMISEnrollment[]> {\n    return this.extractor.extractEnrollmentData(academicYear)\n  }\n\n  /**\n   * Validate student data for NEMIS compliance\n   */\n  validateStudentData(student: NEMISStudent): ValidationResult {\n    return this.validator.validateStudentData(student)\n  }\n\n  /**\n   * Validate NEMIS export format\n   */\n  async validateNEMISFormat(data: NEMISExportDataStructure): Promise<ValidationResult> {\n    if (!data) {\n      return {\n        valid: false,\n        message: 'Export data is required',\n        errors: ['Export data is required']\n      }\n    }\n\n    const errors: string[] = []\n\n    // Validate required fields\n    if (!data.students || data.students.length === 0) {\n      errors.push('Students data is required')\n    }\n    if (!data.school) {\n      errors.push('School data is required')\n    }\n    if (!data.enrollments) {\n      errors.push('Enrollment data is required')\n    }\n    if (!data.financial) {\n      errors.push('Financial data is required')\n    }\n\n    return {\n      valid: errors.length === 0,\n      message: errors.length === 0 ? 'Valid' : errors.join(', '),\n      errors\n    }\n  }\n\n  /**\n   * Validate export readiness\n   */\n  async validateExportReadiness(exportId: number): Promise<ValidationResult> {\n    return this.validator.validateExportReadiness(exportId)\n  }\n\n  /**\n   * Format data to CSV\n   */\n  formatToCSV(data: Record<string, unknown>[], exportType: NEMISExportType): string {\n    return this.formatter.formatToCSV(data, exportType)\n  }\n\n  /**\n   * Format data to JSON\n   */\n  formatToJSON(data: Record<string, unknown>[], exportType: NEMISExportType): string {\n    return this.formatter.formatToJSON(data, exportType)\n  }\n\n  /**\n   * Create and execute NEMIS export\n   */\n  async createExport(exportConfig: NEMISExportConfig, userId: number): Promise<ExportResult> {\n    return this.exportManager.createExport(exportConfig, userId)\n  }\n\n  /**\n   * Get export history\n   */\n  async getExportHistory(limit?: number): Promise<NEMISExportRecord[]> {\n    return this.exportManager.getExportHistory(limit)\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\reports\\ReportScheduler.ts","messages":[{"ruleId":"sonarjs/todo-tag","severity":1,"message":"Complete the task associated to this \"TODO\" comment.","line":94,"column":20,"nodeType":null,"messageId":"completeTODO","endLine":94,"endColumn":24}],"suppressedMessages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":260,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":260,"endColumn":21,"suggestions":[{"fix":{"range":[8851,8872],"text":""},"messageId":"removeConsole","data":{"propertyName":"info"},"desc":"Remove the console.info()."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\r\nimport { logAudit } from '../../database/utils/audit'\r\nimport { NotificationService } from '../notifications/NotificationService'\r\n\r\n\r\nexport interface ScheduledReport {\r\n    id: number\r\n    report_name: string\r\n    report_type: string\r\n    parameters: string // JSON\r\n    schedule_type: 'DAILY' | 'WEEKLY' | 'MONTHLY' | 'TERM_END' | 'YEAR_END'\r\n    day_of_week: number | null\r\n    day_of_month: number | null\r\n    time_of_day: string\r\n    recipients: string // JSON array of emails\r\n    export_format: 'PDF' | 'EXCEL' | 'CSV'\r\n    is_active: boolean\r\n    last_run_at: string | null\r\n    next_run_at: string | null\r\n    created_by_user_id: number\r\n    created_at: string\r\n}\r\n\r\nexport class ReportScheduler {\r\n    private get db() { return getDatabase() }\r\n    private _notificationService: NotificationService | null = null\r\n    private get notificationService() {\r\n        if (!this._notificationService) {\r\n            this._notificationService = new NotificationService()\r\n        }\r\n        return this._notificationService\r\n    }\r\n    private checkInterval: ReturnType<typeof setInterval> | null = null\r\n    private isRunning = false\r\n\r\n    /**\r\n     * Initialize the scheduler\r\n     */\r\n    initialize(): void {\r\n        if (this.isRunning) {return}\r\n\r\n        this.logInfo('Initializing report scheduler...')\r\n\r\n        // Check every minute\n        this.checkInterval = setInterval(() => {\n            void this.checkAndRunReports()\n        }, 60 * 1000)\n\r\n        this.isRunning = true\r\n        this.logInfo('Report scheduler initialized')\r\n    }\r\n\r\n    /**\r\n     * Stop the scheduler\r\n     */\r\n    shutdown(): void {\r\n        if (this.checkInterval) {\r\n            clearInterval(this.checkInterval)\r\n            this.checkInterval = null\r\n        }\r\n        this.isRunning = false\r\n        this.logInfo('Report scheduler shutdown')\r\n    }\r\n\r\n    private async checkAndRunReports(): Promise<void> {\r\n        const schedules = this.getActiveSchedules()\r\n        const now = new Date()\r\n\r\n        for (const schedule of schedules) {\r\n            if (this.shouldRun(schedule, now)) {\r\n                await this.executeReport(schedule)\r\n            }\r\n        }\r\n    }\r\n\r\n    private shouldRun(schedule: ScheduledReport, now: Date): boolean {\r\n        const [hour, minute] = schedule.time_of_day.split(':').map(Number)\r\n\r\n        // Check time match\r\n        if (now.getHours() !== hour || now.getMinutes() !== minute) {\r\n            return false\r\n        }\r\n\r\n        // Check day match based on type\r\n        switch (schedule.schedule_type) {\r\n            case 'DAILY':\r\n                return true\r\n            case 'WEEKLY':\r\n                return now.getDay() === (schedule.day_of_week ?? 1)\r\n            case 'MONTHLY':\r\n                return now.getDate() === (schedule.day_of_month ?? 1)\r\n            case 'TERM_END':\r\n            case 'YEAR_END':\r\n                // TODO: Implement academic calendar checking\r\n                return false\r\n            default:\r\n                return false\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get all scheduled reports\r\n     */\r\n    getScheduledReports(): ScheduledReport[] {\r\n        return this.db.prepare(`\r\n      SELECT * FROM scheduled_report ORDER BY report_name\r\n    `).all() as ScheduledReport[]\r\n    }\r\n\r\n    /**\r\n     * Get active schedules\r\n     */\r\n    private getActiveSchedules(): ScheduledReport[] {\r\n        return this.db.prepare(`\r\n      SELECT * FROM scheduled_report WHERE is_active = 1\r\n    `).all() as ScheduledReport[]\r\n    }\r\n\r\n    /**\r\n     * Create a scheduled report\r\n     */\r\n    createSchedule(\r\n        data: Omit<ScheduledReport, 'id' | 'last_run_at' | 'next_run_at' | 'created_at'>,\r\n        userId: number\r\n    ): { success: boolean; id?: number; errors?: string[] } {\r\n        const errors = this.validateSchedule(data)\r\n        if (errors.length > 0) {\r\n            return { success: false, errors }\r\n        }\r\n\r\n        try {\r\n            const result = this.db.prepare(`\r\n        INSERT INTO scheduled_report (\r\n          report_name, report_type, parameters, schedule_type, \r\n          day_of_week, day_of_month, time_of_day, recipients, \r\n          export_format, is_active, created_by_user_id\r\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n      `).run(\r\n                data.report_name,\r\n                data.report_type,\r\n                data.parameters,\r\n                data.schedule_type,\r\n                data.day_of_week,\r\n                data.day_of_month,\r\n                data.time_of_day,\r\n                data.recipients,\r\n                data.export_format,\r\n                data.is_active ? 1 : 0,\r\n                userId\r\n            )\r\n\r\n            logAudit(userId, 'CREATE', 'scheduled_report', result.lastInsertRowid as number, null, { report_name: data.report_name })\r\n\r\n            return { success: true, id: result.lastInsertRowid as number }\r\n        } catch (error) {\r\n            return { success: false, errors: [error instanceof Error ? error.message : 'Failed to create schedule'] }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Update a scheduled report\r\n     */\r\n    updateSchedule(\r\n        id: number,\r\n        data: Partial<ScheduledReport>,\r\n        userId: number\r\n    ): { success: boolean; errors?: string[] } {\r\n        const existing = this.db.prepare('SELECT * FROM scheduled_report WHERE id = ?').get(id) as ScheduledReport | undefined\r\n        if (!existing) {\r\n            return { success: false, errors: ['Schedule not found'] }\r\n        }\r\n\r\n        // Update database\r\n        const sets: string[] = []\r\n        const params: unknown[] = []\r\n\r\n        const fields = ['report_name', 'report_type', 'parameters', 'schedule_type',\r\n            'day_of_week', 'day_of_month', 'time_of_day', 'recipients',\r\n            'export_format', 'is_active']\r\n\r\n        for (const field of fields) {\r\n            const key = field as keyof ScheduledReport\r\n            if (data[key] !== undefined) {\r\n                sets.push(`${field} = ?`)\r\n                params.push(data[key])\r\n            }\r\n        }\r\n\r\n        if (sets.length > 0) {\r\n            params.push(id)\r\n            this.db.prepare(`UPDATE scheduled_report SET ${sets.join(', ')} WHERE id = ?`).run(...params)\r\n        }\r\n\r\n        logAudit(userId, 'UPDATE', 'scheduled_report', id, existing, data)\r\n\r\n        return { success: true }\r\n    }\r\n\r\n    /**\r\n     * Delete a schedule\r\n     */\r\n    deleteSchedule(id: number, userId: number): { success: boolean; errors?: string[] } {\r\n        const existing = this.db.prepare('SELECT * FROM scheduled_report WHERE id = ?').get(id) as ScheduledReport | undefined\r\n        if (!existing) {\r\n            return { success: false, errors: ['Schedule not found'] }\r\n        }\r\n\r\n        this.db.prepare('DELETE FROM scheduled_report WHERE id = ?').run(id)\r\n        logAudit(userId, 'DELETE', 'scheduled_report', id, existing, null)\r\n\r\n        return { success: true }\r\n    }\r\n\r\n    private async executeReport(schedule: ScheduledReport): Promise<void> {\r\n        this.logInfo(`Executing scheduled report: ${schedule.report_name}`)\r\n\r\n        // In a real implementation:\r\n        // 1. Generate report (PDF/Excel) using ReportEngine\r\n        // 2. Email it using NotificationService\r\n        // 3. Log execution\r\n\r\n        try {\r\n            // Simulate execution\r\n            this.logInfo('Simulating report generation and email...')\r\n\r\n            // Update last run time\r\n            this.db.prepare(`\r\n            UPDATE scheduled_report \r\n            SET last_run_at = CURRENT_TIMESTAMP\r\n            WHERE id = ?\r\n        `).run(schedule.id)\r\n\r\n            // Log success\r\n            this.db.prepare(`\r\n            INSERT INTO report_execution_log (scheduled_report_id, execution_time, status, recipients_notified)\r\n            VALUES (?, CURRENT_TIMESTAMP, 'SUCCESS', ?)\r\n        `).run(schedule.id, 1)\r\n\r\n        } catch (error) {\r\n            console.error('Report execution failed:', error)\r\n            // Log failure\r\n            this.db.prepare(`\r\n            INSERT INTO report_execution_log (scheduled_report_id, execution_time, status, error_message)\r\n            VALUES (?, CURRENT_TIMESTAMP, 'FAILED', ?)\r\n        `).run(schedule.id, error instanceof Error ? error.message : 'Unknown error')\r\n        }\r\n    }\r\n\r\n    private validateSchedule(data: Partial<ScheduledReport>): string[] {\r\n        const errors: string[] = []\r\n        if (!data.report_name) {errors.push('Report name is required')}\r\n        if (!data.report_type) {errors.push('Report type is required')}\r\n        if (!data.time_of_day) {errors.push('Time is required')}\r\n        if (!data.recipients) {errors.push('At least one recipient is required')}\r\n        return errors\r\n    }\r\n\r\n    private logInfo(message: string): void {\r\n        // eslint-disable-next-line no-console\r\n        console.info(message)\r\n    }\r\n}\r\n\r\nexport const reportScheduler = new ReportScheduler()\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\reports\\SegmentProfitabilityService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\reports\\SegmentProfitabilitySyncAdapter.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\reports\\StudentLedgerService.ts","messages":[{"ruleId":"sonarjs/no-duplicated-branches","severity":1,"message":"This branch's code block is the same as the block for the branch on line 234.","line":237,"column":63,"nodeType":"BlockStatement","messageId":"sameConditionalBlock","endLine":240,"endColumn":8},{"ruleId":"sonarjs/no-identical-functions","severity":1,"message":"Update this function so that its implementation is not identical to the one on line 199.","line":315,"column":3,"nodeType":null,"endLine":315,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { getDatabase } from '../../database'\r\nimport { logAudit } from '../../database/utils/audit'\n\r\nimport type Database from 'better-sqlite3'\n\r\n// ============================================================================\r\n// SEGREGATED INTERFACES (ISP)\r\n// ============================================================================\r\n\r\nexport interface IOpeningBalanceCalculator {\r\n  calculateOpeningBalance(studentId: number, beforeDate: string): Promise<number>\r\n}\r\n\r\nexport interface ILedgerGenerator {\r\n  generateStudentLedger(studentId: number, startDate: string, endDate: string): Promise<LedgerEntry[]>\r\n}\r\n\r\nexport interface ILedgerReconciler {\r\n  reconcileStudentLedger(studentId: number, periodStart: string, periodEnd: string): Promise<ReconciliationResult>\r\n}\r\n\r\nexport interface ILedgerValidator {\r\n  verifyOpeningBalance(studentId: number, periodStart: string): Promise<VerificationResult>\r\n}\r\n\r\nexport interface LedgerEntry {\r\n  transaction_date: string\r\n  transaction_type: string\r\n  description: string\r\n  debit: number\r\n  credit: number\r\n  balance: number\r\n}\r\n\r\nexport interface ReconciliationResult {\r\n  reconciled: boolean\r\n  ledger_balance: number\r\n  invoice_balance: number\r\n  difference: number\r\n  status: 'BALANCED' | 'OUT_OF_BALANCE'\r\n  discrepancies: Discrepancy[]\r\n}\r\n\r\nexport interface VerificationResult {\r\n  verified: boolean\r\n  opening_balance: number\r\n  verification_status: 'VERIFIED' | 'UNVERIFIED' | 'DISCREPANCY'\r\n}\r\n\r\nexport interface StudentLedgerData {\r\n  student_id: number\r\n  start_date: string\r\n  end_date: string\r\n}\r\n\r\nexport interface LedgerTransactionRow {\r\n  id: number\r\n  student_id: number\r\n  transaction_type: string\r\n  amount: number\r\n  description?: string\r\n  reference?: string\r\n  transaction_date: string\r\n  is_voided: number\r\n  created_at: string\r\n}\r\n\r\nexport interface FeeInvoiceRow {\r\n  id: number\r\n  student_id: number\r\n  amount: number\r\n  status: string\r\n  invoice_date: string\r\n  due_date: string\r\n}\r\n\r\nexport interface Discrepancy {\r\n  type: string\r\n  ledger_balance: number\r\n  invoice_balance: number\r\n  difference: number\r\n}\r\n\r\n// ============================================================================\r\n// REPOSITORY LAYER (SRP)\r\n// ============================================================================\r\n\r\nclass StudentLedgerRepository {\r\n  private db: Database.Database\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n  }\r\n\r\n  async getTransactionHistory(studentId: number): Promise<LedgerTransactionRow[]> {\r\n    const db = this.db\r\n    return db.prepare(`\r\n      SELECT * FROM ledger_transaction\r\n      WHERE student_id = ? AND is_voided = 0\r\n      ORDER BY transaction_date ASC, created_at ASC\r\n    `).all(studentId) as LedgerTransactionRow[]\r\n  }\r\n\r\n  async getTransactionsByPeriod(studentId: number, startDate: string, endDate: string): Promise<LedgerTransactionRow[]> {\r\n    const db = this.db\r\n    return db.prepare(`\r\n      SELECT * FROM ledger_transaction\r\n      WHERE student_id = ? AND transaction_date >= ? AND transaction_date <= ? AND is_voided = 0\r\n      ORDER BY transaction_date ASC, created_at ASC\r\n    `).all(studentId, startDate, endDate) as LedgerTransactionRow[]\r\n  }\r\n\r\n  async getOutstandingInvoices(studentId: number): Promise<FeeInvoiceRow[]> {\r\n    const db = this.db\r\n    return db.prepare(`\r\n      SELECT * FROM fee_invoice\r\n      WHERE student_id = ? AND status = 'OUTSTANDING'\r\n      ORDER BY due_date ASC\r\n    `).all(studentId) as FeeInvoiceRow[]\r\n  }\r\n\r\n  async getInvoicesForPeriod(studentId: number, startDate: string, endDate: string): Promise<FeeInvoiceRow[]> {\r\n    const db = this.db\r\n    return db.prepare(`\r\n      SELECT * FROM fee_invoice\r\n      WHERE student_id = ? AND invoice_date >= ? AND invoice_date <= ?\r\n      ORDER BY invoice_date ASC\r\n    `).all(studentId, startDate, endDate) as FeeInvoiceRow[]\r\n  }\r\n\r\n  async getStudent(studentId: number): Promise<unknown> {\r\n    const db = this.db\r\n    return db.prepare(`SELECT * FROM student WHERE id = ?`).get(studentId)\r\n  }\r\n\r\n  async recordOpeningBalance(studentId: number, periodStart: string, openingBalance: number): Promise<number> {\r\n    const db = this.db\r\n    const result = db.prepare(`\r\n      INSERT INTO student_opening_balance (student_id, period_start, opening_balance, recorded_at)\r\n      VALUES (?, ?, ?, ?)\r\n    `).run(studentId, periodStart, openingBalance, new Date().toISOString())\r\n    return result.lastInsertRowid as number\r\n  }\r\n\r\n  async getRecordedOpeningBalance(studentId: number, periodStart: string): Promise<number | null> {\r\n    const db = this.db\r\n    const result = db.prepare(`\r\n      SELECT opening_balance FROM student_opening_balance\r\n      WHERE student_id = ? AND period_start = ?\r\n    `).get(studentId, periodStart) as { opening_balance: number } | undefined\r\n    return result?.opening_balance || null\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// OPENING BALANCE CALCULATOR (SRP)\r\n// ============================================================================\r\n\r\nclass OpeningBalanceCalculator implements IOpeningBalanceCalculator {\r\n  private db: Database.Database\r\n  private repo: StudentLedgerRepository\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.repo = new StudentLedgerRepository(this.db)\r\n  }\r\n\r\n  async calculateOpeningBalance(studentId: number, beforeDate: string): Promise<number> {\r\n    const transactions = await this.repo.getTransactionHistory(studentId)\r\n\r\n    // Sum all transactions before the period start date\r\n    let balance = 0\r\n    for (const transaction of transactions) {\r\n      if (transaction.transaction_date < beforeDate) {\r\n        if (transaction.transaction_type === 'CREDIT' || transaction.transaction_type === 'PAYMENT') {\r\n          balance += transaction.amount || 0\r\n        } else if (transaction.transaction_type === 'DEBIT' || transaction.transaction_type === 'CHARGE') {\r\n          balance -= transaction.amount || 0\r\n        } else if (transaction.transaction_type === 'REVERSAL') {\r\n          balance -= transaction.amount || 0\r\n        }\r\n      }\r\n    }\r\n\r\n    return Math.max(0, balance) // Never negative\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// LEDGER GENERATOR (SRP)\r\n// ============================================================================\r\n\r\nclass LedgerGenerator implements ILedgerGenerator {\r\n  private db: Database.Database\r\n  private repo: StudentLedgerRepository\r\n  private balanceCalc: OpeningBalanceCalculator\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.repo = new StudentLedgerRepository(this.db)\r\n    this.balanceCalc = new OpeningBalanceCalculator(this.db)\r\n  }\r\n\r\n  async generateStudentLedger(studentId: number, startDate: string, endDate: string): Promise<LedgerEntry[]> {\r\n    const transactions = await this.repo.getTransactionsByPeriod(studentId, startDate, endDate)\r\n\r\n    // Get opening balance\r\n    const openingBalance = await this.balanceCalc.calculateOpeningBalance(studentId, startDate)\r\n\r\n    const entries: LedgerEntry[] = []\r\n    let runningBalance = openingBalance\r\n\r\n    // Add opening balance entry\r\n    if (openingBalance > 0) {\r\n      entries.push({\r\n        transaction_date: startDate,\r\n        transaction_type: 'OPENING_BALANCE',\r\n        description: 'Opening Balance',\r\n        debit: openingBalance,\r\n        credit: 0,\r\n        balance: runningBalance\r\n      })\r\n    }\r\n\r\n    // Process all transactions\r\n    for (const transaction of transactions) {\r\n      let debit = 0\r\n      let credit = 0\r\n\r\n      if (transaction.transaction_type === 'CREDIT' || transaction.transaction_type === 'PAYMENT') {\r\n        credit = transaction.amount || 0\r\n        runningBalance += credit\r\n      } else if (transaction.transaction_type === 'DEBIT' || transaction.transaction_type === 'CHARGE') {\r\n        debit = transaction.amount || 0\r\n        runningBalance -= debit\r\n      } else if (transaction.transaction_type === 'REVERSAL') {\r\n        debit = transaction.amount || 0\r\n        runningBalance -= debit\r\n      }\r\n\r\n      entries.push({\r\n        transaction_date: transaction.transaction_date,\r\n        transaction_type: transaction.transaction_type,\r\n        description: transaction.description || `${transaction.transaction_type} - ${transaction.reference}`,\r\n        debit,\r\n        credit,\r\n        balance: runningBalance\r\n      })\r\n    }\r\n\r\n    return entries\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// LEDGER RECONCILER (SRP)\r\n// ============================================================================\r\n\r\nclass LedgerReconciler implements ILedgerReconciler {\r\n  private db: Database.Database\r\n  private repo: StudentLedgerRepository\r\n  private ledgerGen: LedgerGenerator\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.repo = new StudentLedgerRepository(this.db)\r\n    this.ledgerGen = new LedgerGenerator(this.db)\r\n  }\r\n\r\n  async reconcileStudentLedger(studentId: number, periodStart: string, periodEnd: string): Promise<ReconciliationResult> {\r\n    // Get ledger balance\r\n    const ledgerEntries = await this.ledgerGen.generateStudentLedger(studentId, periodStart, periodEnd)\r\n    const ledgerBalance = ledgerEntries.length > 0 ? ledgerEntries[ledgerEntries.length - 1].balance : 0\r\n\r\n    // Get invoice balance\r\n    const invoices = await this.repo.getInvoicesForPeriod(studentId, periodStart, periodEnd)\r\n    const invoiceBalance = invoices.reduce((sum: number, inv: FeeInvoiceRow) => sum + (inv.amount || 0), 0)\r\n\r\n    const difference = Math.abs(ledgerBalance - invoiceBalance)\r\n    const isBalanced = difference < 1 // Allow for rounding\r\n\r\n    const discrepancies: Discrepancy[] = []\r\n\r\n    // Identify discrepancies\r\n    if (!isBalanced) {\r\n      discrepancies.push({\r\n        type: 'BALANCE_MISMATCH',\r\n        ledger_balance: ledgerBalance,\r\n        invoice_balance: invoiceBalance,\r\n        difference\r\n      })\r\n    }\r\n\r\n    return {\r\n      reconciled: isBalanced,\r\n      ledger_balance: ledgerBalance,\r\n      invoice_balance: invoiceBalance,\r\n      difference,\r\n      status: isBalanced ? 'BALANCED' : 'OUT_OF_BALANCE',\r\n      discrepancies\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// LEDGER VALIDATOR (SRP)\r\n// ============================================================================\r\n\r\nclass LedgerValidator implements ILedgerValidator {\r\n  private db: Database.Database\r\n  private repo: StudentLedgerRepository\r\n  private balanceCalc: OpeningBalanceCalculator\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.repo = new StudentLedgerRepository(this.db)\r\n    this.balanceCalc = new OpeningBalanceCalculator(this.db)\r\n  }\r\n\r\n  async verifyOpeningBalance(studentId: number, periodStart: string): Promise<VerificationResult> {\r\n    // Calculate opening balance\r\n    const calculatedBalance = await this.balanceCalc.calculateOpeningBalance(studentId, periodStart)\r\n\r\n    // Get recorded opening balance\r\n    const recordedBalance = await this.repo.getRecordedOpeningBalance(studentId, periodStart)\r\n\r\n    // If no recorded balance, this is first time - verify it\r\n    if (recordedBalance === null) {\r\n      await this.repo.recordOpeningBalance(studentId, periodStart, calculatedBalance)\r\n      return {\r\n        verified: true,\r\n        opening_balance: calculatedBalance,\r\n        verification_status: 'VERIFIED'\r\n      }\r\n    }\r\n\r\n    // Compare calculated vs recorded\r\n    const difference = Math.abs(calculatedBalance - recordedBalance)\r\n    const isVerified = difference < 1 // Allow for rounding\r\n\r\n    return {\r\n      verified: isVerified,\r\n      opening_balance: calculatedBalance,\r\n      verification_status: isVerified ? 'VERIFIED' : 'DISCREPANCY'\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// FACADE - SOLID-COMPLIANT SERVICE\r\n// ============================================================================\r\n\r\nexport class StudentLedgerService\r\n  implements IOpeningBalanceCalculator, ILedgerGenerator, ILedgerReconciler, ILedgerValidator\r\n{\r\n  // Composed services\r\n  private db: Database.Database\r\n  private readonly balanceCalculator: OpeningBalanceCalculator\r\n  private readonly ledgerGenerator: LedgerGenerator\r\n  private readonly reconciler: LedgerReconciler\r\n  private readonly validator: LedgerValidator\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n    this.balanceCalculator = new OpeningBalanceCalculator(this.db)\r\n    this.ledgerGenerator = new LedgerGenerator(this.db)\r\n    this.reconciler = new LedgerReconciler(this.db)\r\n    this.validator = new LedgerValidator(this.db)\r\n  }\r\n\r\n  /**\r\n   * Generate complete student ledger for period\r\n   */\r\n  async generateStudentLedger(studentId: number, startDate: string, endDate: string): Promise<LedgerEntry[]> {\r\n    const entries = await this.ledgerGenerator.generateStudentLedger(studentId, startDate, endDate)\r\n\r\n    logAudit(\r\n      0,\r\n      'GENERATE_LEDGER',\r\n      'ledger_transaction',\r\n      studentId,\r\n      null,\r\n      { period_start: startDate, period_end: endDate, entry_count: entries.length }\r\n    )\r\n\r\n    return entries\r\n  }\r\n\r\n  /**\r\n   * Calculate opening balance for student as of date\r\n   */\r\n  async calculateOpeningBalance(studentId: number, beforeDate: string): Promise<number> {\r\n    return this.balanceCalculator.calculateOpeningBalance(studentId, beforeDate)\r\n  }\r\n\r\n  /**\r\n   * Get student's current balance\r\n   */\r\n  async getStudentCurrentBalance(studentId: number): Promise<number> {\r\n    const today = new Date().toISOString().split('T')[0]\r\n    const entries = await this.ledgerGenerator.generateStudentLedger(studentId, '1900-01-01', today)\r\n    return entries.length > 0 ? entries[entries.length - 1].balance : 0\r\n  }\r\n\r\n  /**\r\n   * Record opening balance for verification\r\n   */\r\n  async recordOpeningBalance(studentId: number, periodStart: string, openingBalance: number): Promise<number> {\r\n    const repo = new StudentLedgerRepository(this.db)\r\n    return repo.recordOpeningBalance(studentId, periodStart, openingBalance)\r\n  }\r\n\r\n  /**\r\n   * Verify opening balance matches calculation\r\n   */\r\n  async verifyOpeningBalance(studentId: number, periodStart: string): Promise<VerificationResult> {\r\n    return this.validator.verifyOpeningBalance(studentId, periodStart)\r\n  }\r\n\r\n  /**\r\n   * Reconcile ledger with invoices\r\n   */\r\n  async reconcileStudentLedger(studentId: number, periodStart: string, periodEnd: string): Promise<ReconciliationResult> {\r\n    return this.reconciler.reconcileStudentLedger(studentId, periodStart, periodEnd)\r\n  }\r\n\r\n  /**\r\n   * Generate complete period-end audit report\r\n   */\r\n  async generateLedgerAuditReport(studentId: number, periodStart: string, periodEnd: string): Promise<unknown> {\r\n    const ledger = await this.generateStudentLedger(studentId, periodStart, periodEnd)\r\n    const reconciliation = await this.reconcileStudentLedger(studentId, periodStart, periodEnd)\r\n    const verification = await this.verifyOpeningBalance(studentId, periodStart)\r\n\r\n    return {\r\n      student_id: studentId,\r\n      period_start: periodStart,\r\n      period_end: periodEnd,\r\n      ledger_entries: ledger,\r\n      reconciliation_status: reconciliation,\r\n      verification_status: verification,\r\n      audit_status: reconciliation.reconciled && verification.verified ? 'PASSED' : 'FAILED'\r\n    }\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\reports\\__tests__\\AgedReceivablesService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\reports\\__tests__\\CashFlowStatementService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\reports\\__tests__\\NEMISExportService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\reports\\__tests__\\SegmentProfitabilityService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\reports\\__tests__\\StudentLedgerService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\workflow\\ApprovalService.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":140,"column":88,"nodeType":"Literal","endLine":140,"endColumn":103},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":149,"column":51,"nodeType":"Literal","endLine":149,"endColumn":79}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\r\nimport { logAudit } from '../../database/utils/audit'\r\n\r\nexport interface ApprovalRequest {\r\n    id: number\r\n    workflow_id: number\r\n    entity_type: string\r\n    entity_id: number\r\n    current_step: number\r\n    status: 'PENDING' | 'APPROVED' | 'REJECTED' | 'CANCELLED'\r\n    requested_by_user_id: number\r\n    final_approver_user_id: number | null\r\n    completed_at: string | null\r\n    created_at: string\r\n    // Computed fields\r\n    workflow_name?: string\r\n    requester_name?: string\r\n    approver_name?: string\r\n    entity_description?: string\r\n}\r\n\r\nexport interface ApprovalWorkflow {\r\n    id: number\r\n    workflow_name: string\r\n    entity_type: string\r\n    is_active: boolean\r\n    created_at: string\r\n}\r\n\r\nexport class ApprovalService {\r\n    private get db() { return getDatabase() }\r\n\r\n    // ===== WORKFLOWS =====\r\n\r\n    async getWorkflows(): Promise<ApprovalWorkflow[]> {\r\n        return this.db.prepare(`\r\n      SELECT * FROM approval_workflow WHERE is_active = 1 ORDER BY workflow_name\r\n    `).all() as ApprovalWorkflow[]\r\n    }\r\n\r\n    async getWorkflowByEntityType(entityType: string): Promise<ApprovalWorkflow | null> {\r\n        return this.db.prepare(`\r\n      SELECT * FROM approval_workflow WHERE entity_type = ? AND is_active = 1\r\n    `).get(entityType) as ApprovalWorkflow | null\r\n    }\r\n\r\n    // ===== APPROVAL REQUESTS =====\r\n\r\n    async getPendingApprovals(_userId?: number): Promise<ApprovalRequest[]> {\n        const query = `\r\n      SELECT ar.*, \r\n             aw.workflow_name,\r\n             u1.full_name as requester_name,\r\n             u2.full_name as approver_name,\r\n             CASE \r\n               WHEN ar.entity_type = 'BUDGET' THEN (SELECT budget_name FROM budget WHERE id = ar.entity_id)\r\n               WHEN ar.entity_type = 'EXPENSE' THEN (SELECT description FROM ledger_transaction WHERE id = ar.entity_id)\r\n               ELSE 'Unknown'\r\n             END as entity_description\r\n      FROM approval_request ar\r\n      LEFT JOIN approval_workflow aw ON ar.workflow_id = aw.id\r\n      LEFT JOIN user u1 ON ar.requested_by_user_id = u1.id\r\n      LEFT JOIN user u2 ON ar.final_approver_user_id = u2.id\r\n      WHERE ar.status = 'PENDING'\r\n    `\r\n\r\n        return this.db.prepare(query + ' ORDER BY ar.created_at DESC').all() as ApprovalRequest[]\r\n    }\r\n\r\n    async getAllApprovals(filters?: { status?: string; entity_type?: string }): Promise<ApprovalRequest[]> {\r\n        let query = `\r\n      SELECT ar.*, \r\n             aw.workflow_name,\r\n             u1.full_name as requester_name,\r\n             u2.full_name as approver_name,\r\n             CASE \r\n               WHEN ar.entity_type = 'BUDGET' THEN (SELECT budget_name FROM budget WHERE id = ar.entity_id)\r\n               WHEN ar.entity_type = 'EXPENSE' THEN (SELECT description FROM ledger_transaction WHERE id = ar.entity_id)\r\n               ELSE 'Unknown'\r\n             END as entity_description\r\n      FROM approval_request ar\r\n      LEFT JOIN approval_workflow aw ON ar.workflow_id = aw.id\r\n      LEFT JOIN user u1 ON ar.requested_by_user_id = u1.id\r\n      LEFT JOIN user u2 ON ar.final_approver_user_id = u2.id\r\n      WHERE 1=1\r\n    `\r\n\r\n        const params: unknown[] = []\r\n\r\n        if (filters?.status) {\r\n            query += ' AND ar.status = ?'\r\n            params.push(filters.status)\r\n        }\r\n\r\n        if (filters?.entity_type) {\r\n            query += ' AND ar.entity_type = ?'\r\n            params.push(filters.entity_type)\r\n        }\r\n\r\n        return this.db.prepare(query + ' ORDER BY ar.created_at DESC').all(...params) as ApprovalRequest[]\r\n    }\r\n\r\n    async createApprovalRequest(\r\n        entityType: string,\r\n        entityId: number,\r\n        requestedByUserId: number\r\n    ): Promise<{ success: boolean; id?: number; errors?: string[] }> {\r\n        try {\r\n            // Find workflow for this entity type\r\n            const workflow = await this.getWorkflowByEntityType(entityType)\r\n\r\n            if (!workflow) {\r\n                // No workflow defined, auto-approve\r\n                return { success: true, id: 0 }\r\n            }\r\n\r\n            // Check if request already exists\r\n            const existing = this.db.prepare(`\r\n        SELECT id FROM approval_request \r\n        WHERE entity_type = ? AND entity_id = ? AND status = 'PENDING'\r\n      `).get(entityType, entityId)\r\n\r\n            if (existing) {\r\n                return { success: false, errors: ['An approval request is already pending for this item'] }\r\n            }\r\n\r\n            const result = this.db.prepare(`\r\n        INSERT INTO approval_request (workflow_id, entity_type, entity_id, requested_by_user_id, status)\r\n        VALUES (?, ?, ?, ?, 'PENDING')\r\n      `).run(workflow.id, entityType, entityId, requestedByUserId)\r\n\r\n            logAudit(requestedByUserId, 'CREATE', 'approval_request', result.lastInsertRowid as number, null, {\r\n                workflow_id: workflow.id,\r\n                entity_type: entityType,\r\n                entity_id: entityId\r\n            })\r\n\r\n            return { success: true, id: result.lastInsertRowid as number }\r\n        } catch (error) {\r\n            return { success: false, errors: [error instanceof Error ? error.message : 'Unknown error'] }\r\n        }\r\n    }\r\n\r\n    async approve(requestId: number, approverId: number): Promise<{ success: boolean; errors?: string[] }> {\r\n        try {\r\n            const request = this.db.prepare(`SELECT * FROM approval_request WHERE id = ?`).get(requestId) as ApprovalRequest | null\r\n\r\n            if (!request) {\r\n                return { success: false, errors: ['Approval request not found'] }\r\n            }\r\n\r\n            if (request.status !== 'PENDING') {\r\n                return { success: false, errors: ['This request has already been processed'] }\r\n            }\r\n\r\n            // Update the approval request\r\n            this.db.prepare(`\r\n        UPDATE approval_request \r\n        SET status = 'APPROVED', \r\n            final_approver_user_id = ?,\r\n            completed_at = CURRENT_TIMESTAMP\r\n        WHERE id = ?\r\n      `).run(approverId, requestId)\r\n\r\n            // Update the related entity based on type\r\n            if (request.entity_type === 'BUDGET') {\r\n                this.db.prepare(`\r\n          UPDATE budget SET status = 'APPROVED', approved_by_user_id = ?, approved_at = CURRENT_TIMESTAMP WHERE id = ?\r\n        `).run(approverId, request.entity_id)\r\n            }\r\n\r\n            logAudit(approverId, 'APPROVE', 'approval_request', requestId, { status: 'PENDING' }, { status: 'APPROVED' })\r\n\r\n            return { success: true }\r\n        } catch (error) {\r\n            return { success: false, errors: [error instanceof Error ? error.message : 'Unknown error'] }\r\n        }\r\n    }\r\n\r\n    async reject(requestId: number, approverId: number, reason: string): Promise<{ success: boolean; errors?: string[] }> {\r\n        try {\r\n            const request = this.db.prepare(`SELECT * FROM approval_request WHERE id = ?`).get(requestId) as ApprovalRequest | null\r\n\r\n            if (!request) {\r\n                return { success: false, errors: ['Approval request not found'] }\r\n            }\r\n\r\n            if (request.status !== 'PENDING') {\r\n                return { success: false, errors: ['This request has already been processed'] }\r\n            }\r\n\r\n            // Update the approval request\r\n            this.db.prepare(`\r\n        UPDATE approval_request \r\n        SET status = 'REJECTED', \r\n            final_approver_user_id = ?,\r\n            completed_at = CURRENT_TIMESTAMP\r\n        WHERE id = ?\r\n      `).run(approverId, requestId)\r\n\r\n            // Update the related entity\r\n            if (request.entity_type === 'BUDGET') {\r\n                this.db.prepare(`\r\n          UPDATE budget SET status = 'REJECTED', notes = COALESCE(notes, '') || '\\n\\nRejection: ' || ? WHERE id = ?\r\n        `).run(reason, request.entity_id)\r\n            }\r\n\r\n            logAudit(approverId, 'REJECT', 'approval_request', requestId, { status: 'PENDING' }, { status: 'REJECTED', reason })\r\n\r\n            return { success: true }\r\n        } catch (error) {\r\n            return { success: false, errors: [error instanceof Error ? error.message : 'Unknown error'] }\r\n        }\r\n    }\r\n\r\n    async cancel(requestId: number, userId: number): Promise<{ success: boolean; errors?: string[] }> {\r\n        try {\r\n            const request = this.db.prepare(`SELECT * FROM approval_request WHERE id = ?`).get(requestId) as ApprovalRequest | null\r\n\r\n            if (!request) {\r\n                return { success: false, errors: ['Approval request not found'] }\r\n            }\r\n\r\n            if (request.status !== 'PENDING') {\r\n                return { success: false, errors: ['Only pending requests can be cancelled'] }\r\n            }\r\n\r\n            if (request.requested_by_user_id !== userId) {\r\n                return { success: false, errors: ['Only the requester can cancel this request'] }\r\n            }\r\n\r\n            this.db.prepare(`\r\n        UPDATE approval_request SET status = 'CANCELLED', completed_at = CURRENT_TIMESTAMP WHERE id = ?\r\n      `).run(requestId)\r\n\r\n            // Revert entity to draft if budget\r\n            if (request.entity_type === 'BUDGET') {\r\n                this.db.prepare(`UPDATE budget SET status = 'DRAFT' WHERE id = ?`).run(request.entity_id)\r\n            }\r\n\r\n            logAudit(userId, 'CANCEL', 'approval_request', requestId, { status: 'PENDING' }, { status: 'CANCELLED' })\r\n\r\n            return { success: true }\r\n        } catch (error) {\r\n            return { success: false, errors: [error instanceof Error ? error.message : 'Unknown error'] }\r\n        }\r\n    }\r\n\r\n    // Get counts for dashboard\r\n    async getApprovalCounts(): Promise<{ pending: number; approved: number; rejected: number }> {\r\n        const result = this.db.prepare(`\r\n      SELECT \r\n        SUM(CASE WHEN status = 'PENDING' THEN 1 ELSE 0 END) as pending,\r\n        SUM(CASE WHEN status = 'APPROVED' THEN 1 ELSE 0 END) as approved,\r\n        SUM(CASE WHEN status = 'REJECTED' THEN 1 ELSE 0 END) as rejected\r\n      FROM approval_request\r\n    `).get() as { pending: number; approved: number; rejected: number }\r\n\r\n        return {\r\n            pending: result.pending || 0,\r\n            approved: result.approved || 0,\r\n            rejected: result.rejected || 0\r\n        }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\workflow\\ApprovalWorkflowService.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Method 'createApprovalRequest' has too many lines (102). Maximum allowed is 80.","line":63,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":181,"endColumn":4},{"ruleId":"complexity","severity":1,"message":"Method 'createApprovalRequest' has a complexity of 14. Maximum allowed is 12.","line":63,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":63,"endColumn":24},{"ruleId":"max-lines-per-function","severity":1,"message":"Method 'processApproval' has too many lines (116). Maximum allowed is 80.","line":186,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":328,"endColumn":4}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDatabase } from '../../database'\n\r\nimport type { Database } from 'better-sqlite3'\r\n\r\n// ============================================================================\r\n// INTERFACES\r\n// ============================================================================\r\n\r\nexport interface ApprovalRequest {\r\n  id: number\r\n  request_type: string\r\n  entity_type: string\r\n  entity_id: number\r\n  amount: number\r\n  description: string\r\n  requested_by: number\r\n  requested_at: string\r\n  status: 'PENDING' | 'APPROVED' | 'REJECTED' | 'CANCELLED'\r\n  current_level: number\r\n  final_decision: string | null\r\n  completed_at: string | null\r\n}\r\n\r\nexport interface ApprovalLevel {\r\n  id: number\r\n  request_id: number\r\n  level: number\r\n  approver_id: number | null\r\n  status: 'PENDING' | 'APPROVED' | 'REJECTED'\r\n  comments: string | null\r\n  decided_at: string | null\r\n}\r\n\r\nexport interface ApprovalConfiguration {\r\n  id: number\r\n  request_type: string\r\n  min_amount: number\r\n  max_amount: number | null\r\n  required_level: number\r\n  approver_role: string\r\n  is_active: boolean\r\n}\r\n\r\nexport interface ApprovalHistoryResult {\r\n  request: ApprovalRequest\r\n  levels: ApprovalLevel[]\r\n}\r\n\r\n// ============================================================================\r\n// APPROVAL WORKFLOW SERVICE\r\n// ============================================================================\r\n\r\nexport class ApprovalWorkflowService {\r\n  private db: Database.Database\r\n\r\n  constructor(db?: Database.Database) {\r\n    this.db = db || getDatabase()\r\n  }\r\n\r\n  /**\r\n   * Create an approval request\r\n   */\r\n  createApprovalRequest(params: {\r\n    requestType?: string\r\n    request_type?: string\r\n    entityType?: string\r\n    entity_type?: string\r\n    entityId?: number\r\n    entity_id?: number\r\n    amount: number\r\n    description: string\r\n    requestedBy?: number\r\n    requested_by?: number\r\n  }): {\r\n    success: boolean\r\n    message: string\r\n    requestId?: number\r\n    requiredLevel?: number\r\n  } {\r\n    try {\r\n      const requestType = params.requestType ?? params.request_type\r\n      const entityType = params.entityType ?? params.entity_type\r\n      const entityId = params.entityId ?? params.entity_id\r\n      const requestedBy = params.requestedBy ?? params.requested_by\r\n      const { amount, description } = params\r\n\r\n      if (!requestType || !entityType || entityId === undefined || requestedBy === undefined) {\r\n        return {\r\n          success: false,\r\n          message: 'Missing required approval request fields'\r\n        }\r\n      }\r\n\r\n      // Get all applicable approval configurations for this request type\r\n      const configs = this.db\r\n        .prepare(\r\n          `SELECT * FROM approval_configuration \r\n           WHERE request_type = ? AND is_active = 1 \r\n           ORDER BY min_amount DESC`\r\n        )\r\n        .all(requestType) as ApprovalConfiguration[]\r\n\r\n      if (configs.length === 0) {\r\n        return {\r\n          success: false,\r\n          message: `No approval configuration found for request type: ${requestType}`\r\n        }\r\n      }\r\n\r\n      // Find the matching configuration based on amount\r\n      let matchingConfigs = configs.filter((c) => {\r\n        const amountInRange =\r\n          amount >= c.min_amount && (c.max_amount === null || amount <= c.max_amount)\r\n        return amountInRange\r\n      })\r\n\r\n      if (matchingConfigs.length === 0) {\r\n        return {\r\n          success: false,\r\n          message: `No approval configuration found for amount: ${amount}`\r\n        }\r\n      }\r\n\r\n      // Sort by required_level to get all levels needed\r\n      matchingConfigs = matchingConfigs.sort((a, b) => a.required_level - b.required_level)\r\n      const maxLevel = matchingConfigs[matchingConfigs.length - 1].required_level\r\n\r\n      // Create approval request\r\n      const now = new Date().toISOString()\r\n      const result = this.db\r\n        .prepare(\r\n          `INSERT INTO approval_request \r\n           (request_type, entity_type, entity_id, amount, description, requested_by, requested_at, status, current_level)\r\n           VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`\r\n        )\r\n        .run(requestType, entityType, entityId, amount, description, requestedBy, now, 'PENDING', 1)\r\n\r\n      const requestId = result.lastInsertRowid as number\r\n\r\n      // Create approval level records\r\n      for (let level = 1; level <= maxLevel; level++) {\r\n        this.db\r\n          .prepare(\r\n            `INSERT INTO approval_level (request_id, level, status)\r\n             VALUES (?, ?, ?)`\r\n          )\r\n          .run(requestId, level, 'PENDING')\r\n      }\r\n\r\n      // Log audit trail\r\n      this.db\r\n        .prepare(\r\n          `INSERT INTO audit_log (user_id, action_type, table_name, record_id, new_values, timestamp)\r\n           VALUES (?, ?, ?, ?, ?, ?)`\r\n        )\r\n        .run(\r\n          requestedBy,\r\n          'CREATE_APPROVAL_REQUEST',\r\n          'approval_request',\r\n          requestId,\r\n          JSON.stringify({\r\n            request_type: requestType,\r\n            amount,\r\n            required_level: maxLevel\r\n          }),\r\n          now\r\n        )\r\n\r\n      return {\r\n        success: true,\r\n        message: `Approval request created - requires Level ${maxLevel} approval`,\r\n        requestId,\r\n        requiredLevel: maxLevel\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to create approval request: ${error instanceof Error ? error.message : String(error)}`\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process approval decision (approve or reject)\r\n   */\r\n  processApproval(params: {\r\n    requestId: number\r\n    level: number\r\n    decision: 'APPROVED' | 'REJECTED'\r\n    approverId: number\r\n    comments?: string\r\n  }): {\r\n    success: boolean\r\n    message: string\r\n  } {\r\n    try {\r\n      const { requestId, level, decision, approverId, comments } = params\r\n\r\n      // Get the approval request\r\n      const request = this.db\r\n        .prepare('SELECT * FROM approval_request WHERE id = ?')\r\n        .get(requestId) as ApprovalRequest | undefined\r\n\r\n      if (!request) {\r\n        return {\r\n          success: false,\r\n          message: `Approval request not found: ${requestId}`\r\n        }\r\n      }\r\n\r\n      // Get the approval level record\r\n      const approvalLevel = this.db\r\n        .prepare('SELECT * FROM approval_level WHERE request_id = ? AND level = ?')\r\n        .get(requestId, level) as ApprovalLevel | undefined\r\n\r\n      if (!approvalLevel) {\r\n        return {\r\n          success: false,\r\n          message: `Approval level ${level} not found for request ${requestId}`\r\n        }\r\n      }\r\n\r\n      // Check if we're at the current level\r\n      if (request.current_level !== level) {\r\n        return {\r\n          success: false,\r\n          message: `Request is not at the current approval level (current: ${request.current_level}, attempted: ${level})`\r\n        }\r\n      }\r\n\r\n      const now = new Date().toISOString()\r\n\r\n      if (decision === 'APPROVED') {\r\n        // Update approval level\r\n        this.db\r\n          .prepare(\r\n            `UPDATE approval_level \r\n             SET status = ?, approver_id = ?, decided_at = ?, comments = ?\r\n             WHERE request_id = ? AND level = ?`\r\n          )\r\n          .run('APPROVED', approverId, now, comments || null, requestId, level)\r\n\r\n        // Get max level to check if this is the final approval\r\n        const maxLevel = (\r\n          this.db\r\n            .prepare('SELECT MAX(level) as max_level FROM approval_level WHERE request_id = ?')\r\n            .get(requestId) as { max_level: number }\r\n        ).max_level\r\n\r\n        if (level === maxLevel) {\r\n          // Final approval - mark request as fully approved\r\n          this.db\r\n            .prepare(\r\n              `UPDATE approval_request \r\n               SET status = ?, final_decision = ?, completed_at = ?\r\n               WHERE id = ?`\r\n            )\r\n            .run('APPROVED', 'APPROVED', now, requestId)\r\n\r\n          // Log audit\r\n          this.db\r\n            .prepare(\r\n              `INSERT INTO audit_log (user_id, action_type, table_name, record_id, timestamp)\r\n               VALUES (?, ?, ?, ?, ?)`\r\n            )\r\n            .run(approverId, 'APPROVE_LEVEL_' + level, 'approval_request', requestId, now)\r\n\r\n          return {\r\n            success: true,\r\n            message: `Request fully approved by level ${level}`\r\n          }\r\n        } else {\r\n          // Advance to next level\r\n          this.db\r\n            .prepare('UPDATE approval_request SET current_level = ? WHERE id = ?')\r\n            .run(level + 1, requestId)\r\n\r\n          // Log audit\r\n          this.db\r\n            .prepare(\r\n              `INSERT INTO audit_log (user_id, action_type, table_name, record_id, timestamp)\r\n               VALUES (?, ?, ?, ?, ?)`\r\n            )\r\n            .run(approverId, 'APPROVE_LEVEL_' + level, 'approval_request', requestId, now)\r\n\r\n          return {\r\n            success: true,\r\n            message: `Level ${level} approved - request advanced to Level ${level + 1}`\r\n          }\r\n        }\r\n      } else {\r\n        // Reject the request\r\n        this.db\r\n          .prepare(\r\n            `UPDATE approval_level \r\n             SET status = ?, approver_id = ?, decided_at = ?, comments = ?\r\n             WHERE request_id = ? AND level = ?`\r\n          )\r\n          .run('REJECTED', approverId, now, comments || null, requestId, level)\r\n\r\n        this.db\r\n          .prepare(\r\n            `UPDATE approval_request \r\n             SET status = ?, final_decision = ?, completed_at = ?\r\n             WHERE id = ?`\r\n          )\r\n          .run('REJECTED', 'REJECTED', now, requestId)\r\n\r\n        // Log audit\r\n        this.db\r\n          .prepare(\r\n            `INSERT INTO audit_log (user_id, action_type, table_name, record_id, timestamp)\r\n             VALUES (?, ?, ?, ?, ?)`\r\n          )\r\n          .run(approverId, 'REJECT_LEVEL_' + level, 'approval_request', requestId, now)\r\n\r\n        return {\r\n          success: true,\r\n          message: `Request rejected at level ${level}`\r\n        }\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Failed to process approval: ${error instanceof Error ? error.message : String(error)}`\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get approval queue for a specific level\r\n   */\r\n  getApprovalQueue(level: number, requestType?: string): ApprovalRequest[] {\r\n    try {\r\n      let query = `\r\n        SELECT DISTINCT ar.* FROM approval_request ar\r\n        WHERE ar.current_level = ? AND ar.status = 'PENDING'\r\n      `\r\n      const params: unknown[] = [level]\r\n\r\n      if (requestType) {\r\n        query += ` AND ar.request_type = ?`\r\n        params.push(requestType)\r\n      }\r\n\r\n      query += ` ORDER BY ar.requested_at DESC`\r\n\r\n      return this.db.prepare(query).all(...params) as ApprovalRequest[]\r\n    } catch (error) {\r\n      console.error('Failed to get approval queue:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get complete approval history for a request\r\n   */\r\n  getApprovalHistory(requestId: number): ApprovalHistoryResult {\r\n    try {\r\n      const request = this.db\r\n        .prepare('SELECT * FROM approval_request WHERE id = ?')\r\n        .get(requestId) as ApprovalRequest\r\n\r\n      const levels = this.db\r\n        .prepare('SELECT * FROM approval_level WHERE request_id = ? ORDER BY level ASC')\r\n        .all(requestId) as ApprovalLevel[]\r\n\r\n      return {\r\n        request,\r\n        levels\r\n      }\r\n    } catch (error) {\r\n      throw new Error(`Failed to get approval history: ${error instanceof Error ? error.message : String(error)}`)\r\n    }\r\n  }\r\n\r\n  // --------------------------------------------------------------------------\r\n  // Backward-compatible wrappers for legacy test usage\r\n  // --------------------------------------------------------------------------\r\n\r\n  approveRequest(requestId: number, level: number, comments: string, approverId: number): {\r\n    success: boolean\r\n    message: string\r\n  } {\r\n    return this.processApproval({\r\n      requestId,\r\n      level,\r\n      decision: 'APPROVED',\r\n      approverId,\r\n      comments\r\n    })\r\n  }\r\n\r\n  rejectRequest(requestId: number, level: number, comments: string, approverId: number): {\r\n    success: boolean\r\n    message: string\r\n  } {\r\n    return this.processApproval({\r\n      requestId,\r\n      level,\r\n      decision: 'REJECTED',\r\n      approverId,\r\n      comments\r\n    })\r\n  }\r\n\r\n  getRequestHistory(requestId: number): ApprovalHistoryResult {\r\n    return this.getApprovalHistory(requestId)\r\n  }\r\n\r\n  getPendingRequests(level = 1, requestType?: string): ApprovalRequest[] {\r\n    return this.getApprovalQueue(level, requestType)\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\services\\workflow\\__tests__\\ApprovalWorkflowService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\tax\\TaxStrategy.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Method 'calculateNHIF' has a complexity of 17. Maximum allowed is 12.","line":51,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":51,"endColumn":16},{"ruleId":"max-statements","severity":1,"message":"Method 'calculateNHIF' has too many statements (33). Maximum allowed is 30.","line":51,"column":16,"nodeType":"FunctionExpression","messageId":"exceed","endLine":69,"endColumn":4}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface TaxCalculationResult {\r\n  paye: number\r\n  nhif: number\r\n  nssf: number\r\n  totalDeductions: number\r\n  netSalary: number\r\n}\r\n\r\nexport interface TaxStrategy {\r\n  calculate(grossSalary: number): TaxCalculationResult\r\n}\r\n\r\nexport class TaxCalculator {\r\n  calculatePAYE(grossSalary: number): number {\r\n    // 2024/2025 Kenya PAYE Bands (Simplified for example)\r\n    // 24,000 - 10%\r\n    // Next 8,333 - 25%\r\n    // Next 467,667 - 30%\r\n    // Over 500,000 - 32.5% or 35%\r\n    \r\n    // For now, let's use a simplified logical approximation or 0\r\n    // Personal Relief is 2400\r\n    \r\n    let tax = 0;\r\n    let remainder = grossSalary;\r\n    \r\n    // First 24,000\r\n    if (remainder > 24000) {\r\n        tax += 24000 * 0.1;\r\n        remainder -= 24000;\r\n    } else {\r\n        tax += remainder * 0.1;\r\n        return Math.max(0, tax - 2400);\r\n    }\r\n    \r\n    // Next 8,333\r\n    if (remainder > 8333) {\r\n        tax += 8333 * 0.25;\r\n        remainder -= 8333;\r\n    } else {\r\n        tax += remainder * 0.25;\r\n        return Math.max(0, tax - 2400);\r\n    }\r\n    \r\n    // Remaining at 30% (Standard)\r\n    tax += remainder * 0.3;\r\n    \r\n    return Math.max(0, tax - 2400);\r\n  }\r\n\r\n  calculateNHIF(grossSalary: number): number {\r\n     if (grossSalary < 6000) {return 150;}\r\n     if (grossSalary < 8000) {return 300;}\r\n     if (grossSalary < 12000) {return 400;}\r\n     if (grossSalary < 15000) {return 500;}\r\n     if (grossSalary < 20000) {return 600;}\r\n     if (grossSalary < 25000) {return 750;}\r\n     if (grossSalary < 30000) {return 850;}\r\n     if (grossSalary < 35000) {return 900;}\r\n     if (grossSalary < 40000) {return 950;}\r\n     if (grossSalary < 45000) {return 1000;}\r\n     if (grossSalary < 50000) {return 1100;}\r\n     if (grossSalary < 60000) {return 1200;}\r\n     if (grossSalary < 70000) {return 1300;}\r\n     if (grossSalary < 80000) {return 1400;}\r\n     if (grossSalary < 90000) {return 1500;}\r\n     if (grossSalary < 100000) {return 1600;}\r\n     return 1700; // 100k+\r\n  }\r\n\r\n  calculateNSSF(grossSalary: number): number {\r\n      // Tier 1: 6% of min(salary, 7000)\r\n      // Tier 2: 6% of min(salary, 36000) - Tier 1\r\n      const tier1 = Math.min(grossSalary, 7000) * 0.06;\r\n      const tier2 = (Math.min(grossSalary, 36000) - 7000) * 0.06;\r\n      return tier1 + (grossSalary > 7000 ? Math.max(0, tier2) : 0);\r\n  }\r\n\r\n  calculate(grossSalary: number): TaxCalculationResult {\r\n      const paye = this.calculatePAYE(grossSalary);\r\n      const nhif = this.calculateNHIF(grossSalary);\r\n      const nssf = this.calculateNSSF(grossSalary);\r\n      const totalDeductions = paye + nhif + nssf;\r\n      const netSalary = grossSalary - totalDeductions;\r\n      \r\n      return {\r\n          paye,\r\n          nhif,\r\n          nssf,\r\n          totalDeductions,\r\n          netSalary\r\n      }\r\n  }\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\updates\\autoUpdater.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\utils\\money.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\utils\\pdf.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\utils\\validation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\main\\utils\\windowState.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\electron\\preload\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\jest.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\jest.setup.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\playwright.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\postcss.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\reseed_fees.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\scripts\\check-user-1.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\scripts\\check-users.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\scripts\\fix-a11y-warnings.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\scripts\\parse_lint.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\scripts\\parse_lint.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\scripts\\test-invoice-generation.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\scripts\\verify-encryption.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\App.tsx","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'App' has too many lines (93). Maximum allowed is 80.","line":95,"column":16,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":189,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { Suspense, lazy } from 'react'\nimport { HashRouter, Routes, Route, Navigate } from 'react-router-dom'\n\nimport { ErrorBoundary } from './components/ErrorBoundary'\nimport { OfflineIndicator } from './components/feedback/OfflineIndicator'\nimport { PrintPreviewHost } from './components/feedback/PrintPreviewHost'\nimport Layout from './components/Layout'\nimport { ThemeProvider } from './contexts/ThemeContext'\nimport { ToastProvider } from './contexts/ToastContext'\nimport { GLAccountManagement } from './pages/Finance/Settings/GLAccountManagement'\nimport { OpeningBalanceImport } from './pages/Finance/Settings/OpeningBalanceImport'\nimport Login from './pages/Login'\nimport SetupAdmin from './pages/SetupAdmin'\nimport { useAuthStore } from './stores'\n\nconst Dashboard = lazy(() => import('./pages/Dashboard'))\nconst Students = lazy(() => import('./pages/Students'))\nconst StudentForm = lazy(() => import('./pages/Students/StudentForm'))\nconst FeePayment = lazy(() => import('./pages/Finance/FeePayment'))\nconst Invoices = lazy(() => import('./pages/Finance/Invoices'))\nconst Transactions = lazy(() => import('./pages/Finance/Transactions'))\nconst RecordExpense = lazy(() => import('./pages/Finance/RecordExpense'))\nconst RecordIncome = lazy(() => import('./pages/Finance/RecordIncome'))\nconst FinancialReports = lazy(() => import('./pages/Finance/FinancialReports'))\nconst FeeStructure = lazy(() => import('./pages/Finance/FeeStructure'))\nconst Staff = lazy(() => import('./pages/Payroll/Staff'))\nconst PayrollRun = lazy(() => import('./pages/Payroll/PayrollRun'))\nconst Inventory = lazy(() => import('./pages/Inventory'))\nconst Reports = lazy(() => import('./pages/Reports'))\nconst Settings = lazy(() => import('./pages/Settings'))\nconst AuditLog = lazy(() => import('./pages/AuditLog'))\nconst Backup = lazy(() => import('./pages/Backup'))\nconst UsersPage = lazy(() => import('./pages/Users'))\nconst BudgetList = lazy(() => import('./pages/Finance/Budget'))\nconst CreateBudget = lazy(() => import('./pages/Finance/Budget/CreateBudget'))\nconst BudgetDetails = lazy(() => import('./pages/Finance/Budget/BudgetDetails'))\nconst BankAccounts = lazy(() => import('./pages/Finance/BankAccounts'))\nconst Approvals = lazy(() => import('./pages/Approvals'))\nconst Promotions = lazy(() => import('./pages/Students/Promotions'))\nconst AttendancePage = lazy(() => import('./pages/Attendance'))\nconst ReportCardsPage = lazy(() => import('./pages/Reports/ReportCards'))\nconst CommunicationLog = lazy(() => import('./pages/Communications/CommunicationLog'))\nconst ScheduledReports = lazy(() => import('./pages/Reports/ScheduledReports'))\nconst CashFlow = lazy(() => import('./pages/Finance/CashFlow'))\nconst TeacherAllocation = lazy(() => import('./pages/Academic/TeacherAllocation'))\nconst SubjectManagement = lazy(() => import('./pages/Academic/SubjectManagement'))\nconst ExamManagement = lazy(() => import('./pages/Academic/ExamManagement'))\nconst MarksEntry = lazy(() => import('./pages/Academic/MarksEntry'))\nconst MeritLists = lazy(() => import('./pages/Academic/MeritLists'))\nconst ExamAnalytics = lazy(() => import('./pages/Academic/ExamAnalytics'))\nconst ReportCardAnalytics = lazy(() => import('./pages/Academic/ReportCardAnalytics'))\nconst SubjectMeritLists = lazy(() => import('./pages/Academic/SubjectMeritLists'))\nconst MostImproved = lazy(() => import('./pages/Academic/MostImproved'))\nconst AwardsManagement = lazy(() => import('./pages/Academic/AwardsManagement'))\nconst ExamScheduler = lazy(() => import('./pages/Academic/ExamScheduler'))\nconst ReportCardGeneration = lazy(() => import('./pages/Academic/ReportCardGeneration'))\nconst AssetHire = lazy(() => import('./pages/Finance/AssetHire'))\nconst FeeExemptions = lazy(() => import('./pages/Finance/FeeExemptions'))\nconst BoardingProfitability = lazy(() => import('./pages/Operations/Boarding/BoardingProfitability'))\nconst TransportRouteManagement = lazy(() => import('./pages/Operations/Transport/TransportRouteManagement'))\nconst StudentCostAnalysis = lazy(() => import('./pages/Finance/StudentCost/StudentCostAnalysis'))\nconst GrantTracking = lazy(() => import('./pages/Finance/Grants/GrantTracking'))\nconst ReconcileAccount = lazy(() => import('./pages/Finance/Reconciliation/ReconcileAccount'))\nconst ApprovalQueue = lazy(() => import('./pages/Finance/Approvals/ApprovalQueue'))\nconst AssetRegister = lazy(() => import('./pages/Finance/FixedAssets/AssetRegister'))\nconst Depreciation = lazy(() => import('./pages/Finance/FixedAssets/Depreciation'))\nconst BalanceSheet = lazy(() => import('./pages/Finance/Reports/BalanceSheet'))\nconst ProfitAndLoss = lazy(() => import('./pages/Finance/Reports/ProfitAndLoss'))\nconst TrialBalance = lazy(() => import('./pages/Finance/Reports/TrialBalance'))\nconst CBCStrandManagement = lazy(() => import('./pages/Finance/CBC/CBCStrandManagement'))\nconst JSSTransition = lazy(() => import('./pages/Finance/CBC/JSSTransition'))\nconst Integrations = lazy(() => import('./pages/Settings/Integrations'))\nconst MessageTemplates = lazy(() => import('./pages/Settings/MessageTemplates'))\n\nfunction PrivateRoute({ children }: { children: React.ReactNode }) {\n    const isAuthenticated = useAuthStore((state) => state.isAuthenticated)\n    const checkSession = useAuthStore((state) => state.checkSession)\n    const touchSession = useAuthStore((state) => state.touchSession)\n    const isSessionLoaded = useAuthStore((state) => state.isSessionLoaded)\n\n    React.useEffect(() => {\n        if (!isSessionLoaded) {return}\n        if (!isAuthenticated) {return}\n        const valid = checkSession()\n        if (valid) {touchSession()}\n    }, [isSessionLoaded, isAuthenticated, checkSession, touchSession])\n\n    if (!isSessionLoaded) {\n        return null\n    }\n\n    return isAuthenticated ? <>{children}</> : <Navigate to=\"/login\" />\n}\n\nexport default function App() {\n    const hydrateSession = useAuthStore((state) => state.hydrateSession)\n\n    React.useEffect(() => {\n        void hydrateSession()\n    }, [hydrateSession])\n\n    return (\n        <ErrorBoundary>\n        <ThemeProvider>\n            <ToastProvider>\n                <OfflineIndicator />\n                <PrintPreviewHost />\n                <HashRouter>\n                    <Suspense fallback={<div className=\"p-6 text-sm text-foreground/70\">Loading</div>}>\n                    <Routes>\n                        <Route path=\"/login\" element={<Login />} />\n                        <Route path=\"/setup\" element={<SetupAdmin />} />\n                        <Route path=\"/\" element={\n                            <PrivateRoute>\n                                <Layout />\n                            </PrivateRoute>\n                        }>\n                            <Route index element={<Dashboard />} />\n                            <Route path=\"students\" element={<Students />} />\r\n                            <Route path=\"students/new\" element={<StudentForm />} />\r\n                            <Route path=\"students/:id\" element={<StudentForm />} />\r\n                            <Route path=\"students/:id/edit\" element={<StudentForm />} />\r\n                            <Route path=\"students/promotions\" element={<Promotions />} />\r\n                            <Route path=\"attendance\" element={<AttendancePage />} />\r\n                            <Route path=\"report-cards\" element={<ReportCardsPage />} />\r\n                            <Route path=\"fee-payment\" element={<FeePayment />} />\r\n                            <Route path=\"invoices\" element={<Invoices />} />\r\n                            <Route path=\"transactions\" element={<Transactions />} />\r\n                            <Route path=\"record-expense\" element={<RecordExpense />} />\r\n                            <Route path=\"record-income\" element={<RecordIncome />} />\r\n                            <Route path=\"financial-reports\" element={<FinancialReports />} />\r\n                            <Route path=\"fee-structure\" element={<FeeStructure />} />\r\n                            <Route path=\"staff\" element={<Staff />} />\r\n                            <Route path=\"payroll-run\" element={<PayrollRun />} />\r\n                            <Route path=\"inventory\" element={<Inventory />} />\r\n                            <Route path=\"reports\" element={<Reports />} />\r\n                            <Route path=\"reports/scheduled\" element={<ScheduledReports />} />\r\n                            <Route path=\"settings\" element={<Settings />} />\r\n                            <Route path=\"audit-log\" element={<AuditLog />} />\r\n                            <Route path=\"communications\" element={<CommunicationLog />} />\r\n                            <Route path=\"backup\" element={<Backup />} />\r\n                            <Route path=\"users\" element={<UsersPage />} />\r\n                            <Route path=\"budget\" element={<BudgetList />} />\r\n                            <Route path=\"budget/new\" element={<CreateBudget />} />\r\n                            <Route path=\"budget/:id\" element={<BudgetDetails />} />\r\n                            <Route path=\"cash-flow\" element={<CashFlow />} />\r\n                            <Route path=\"bank-accounts\" element={<BankAccounts />} />\r\n                            <Route path=\"approvals\" element={<Approvals />} />\n                            <Route path=\"academic/allocations\" element={<TeacherAllocation />} />\n                            <Route path=\"academic/subjects\" element={<SubjectManagement />} />\n                            <Route path=\"academic/exams\" element={<ExamManagement />} />\n                            <Route path=\"academic/marks-entry\" element={<MarksEntry />} />\r\n                            <Route path=\"academic/merit-lists\" element={<MeritLists />} />\r\n                            <Route path=\"academic/analytics/exams\" element={<ExamAnalytics />} />\r\n                            <Route path=\"academic/analytics/report-cards\" element={<ReportCardAnalytics />} />\r\n                            <Route path=\"academic/analytics/subject-merit-list\" element={<SubjectMeritLists />} />\r\n                            <Route path=\"academic/analytics/most-improved\" element={<MostImproved />} />\r\n                            <Route path=\"academic/awards\" element={<AwardsManagement />} />\r\n                            <Route path=\"academic/schedule\" element={<ExamScheduler />} />\r\n                            <Route path=\"asset-hire\" element={<AssetHire />} />\r\n                            <Route path=\"fee-exemptions\" element={<FeeExemptions />} />\r\n                            {/* Orphaned pages now routed (audit fix) */}\r\n                            <Route path=\"academic/report-card-generation\" element={<ReportCardGeneration />} />\r\n                            <Route path=\"finance/gl-accounts\" element={<GLAccountManagement />} />\r\n                            <Route path=\"finance/opening-balances\" element={<OpeningBalanceImport />} />\r\n                            <Route path=\"finance/balance-sheet\" element={<BalanceSheet />} />\r\n                            <Route path=\"finance/profit-and-loss\" element={<ProfitAndLoss />} />\r\n                            <Route path=\"finance/trial-balance\" element={<TrialBalance />} />\r\n                            <Route path=\"finance/fixed-assets\" element={<AssetRegister />} />\r\n                            <Route path=\"finance/depreciation\" element={<Depreciation />} />\r\n                            <Route path=\"finance/reconciliation\" element={<ReconcileAccount />} />\r\n                            <Route path=\"finance/transaction-approvals\" element={<ApprovalQueue />} />\r\n                            <Route path=\"finance/grants\" element={<GrantTracking />} />\r\n                            <Route path=\"finance/student-cost\" element={<StudentCostAnalysis />} />\r\n                            <Route path=\"finance/cbc-strands\" element={<CBCStrandManagement />} />\r\n                            <Route path=\"finance/jss-transition\" element={<JSSTransition />} />\r\n                            <Route path=\"operations/boarding\" element={<BoardingProfitability />} />\r\n                            <Route path=\"operations/transport\" element={<TransportRouteManagement />} />\r\n                            <Route path=\"settings/integrations\" element={<Integrations />} />\r\n                            <Route path=\"settings/message-templates\" element={<MessageTemplates />} />\r\n                        </Route>\n                    </Routes>\n                    </Suspense>\n                </HashRouter>\n            </ToastProvider>\r\n        </ThemeProvider>\r\n        </ErrorBoundary>\r\n    )\r\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\ErrorBoundary.tsx","messages":[{"ruleId":"sonarjs/function-return-type","severity":1,"message":"Refactor this function to always return the same type.","line":35,"column":5,"nodeType":null,"endLine":35,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\n\r\ninterface ErrorBoundaryState {\r\n    hasError: boolean\r\n    error: Error | null\r\n}\r\n\r\ninterface ErrorBoundaryProps {\r\n    children: React.ReactNode\r\n    fallback?: React.ReactNode\r\n}\r\n\r\n/**\r\n * ErrorBoundary catches render-time exceptions in the React tree and\r\n * shows a recovery UI instead of white-screening the entire app.\r\n */\r\nexport class ErrorBoundary extends React.Component<ErrorBoundaryProps, ErrorBoundaryState> {\r\n    constructor(props: ErrorBoundaryProps) {\r\n        super(props)\r\n        this.state = { hasError: false, error: null }\r\n    }\r\n\r\n    static getDerivedStateFromError(error: Error): ErrorBoundaryState {\r\n        return { hasError: true, error }\r\n    }\r\n\r\n    componentDidCatch(error: Error, errorInfo: React.ErrorInfo): void {\r\n        console.error('ErrorBoundary caught:', error, errorInfo)\r\n    }\r\n\r\n    handleReset = (): void => {\r\n        this.setState({ hasError: false, error: null })\r\n    }\r\n\r\n    render(): React.ReactNode {\r\n        if (this.state.hasError) {\r\n            if (this.props.fallback) {\r\n                return this.props.fallback\r\n            }\r\n            return (\r\n                <div className=\"flex flex-col items-center justify-center min-h-[400px] p-8 text-center\">\r\n                    <div className=\"text-red-600 mb-4\">\r\n                        <svg className=\"w-16 h-16 mx-auto\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2}\r\n                                d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z\" />\r\n                        </svg>\r\n                    </div>\r\n                    <h2 className=\"text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2\">\r\n                        Something went wrong\r\n                    </h2>\r\n                    <p className=\"text-gray-600 dark:text-gray-400 mb-4 max-w-md\">\r\n                        {this.state.error?.message || 'An unexpected error occurred'}\r\n                    </p>\r\n                    <button\r\n                        onClick={this.handleReset}\r\n                        className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\r\n                    >\r\n                        Try Again\r\n                    </button>\r\n                </div>\r\n            )\r\n        }\r\n\r\n        return this.props.children\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\Layout.tsx","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'Layout' has too many lines (262). Maximum allowed is 80.","line":117,"column":16,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":400,"endColumn":2},{"ruleId":"complexity","severity":1,"message":"Function 'Layout' has a complexity of 17. Maximum allowed is 12.","line":117,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":117,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n    LayoutDashboard, Users, Wallet, ClipboardList, Package,\n    BarChart3, Settings, LogOut, ChevronDown, Shield, Database,\n    FileText, CreditCard, UserCog, Calculator, CheckCircle, ArrowUpRight,\n    TrendingUp,\n    TrendingDown,\n    TableProperties,\n    BookOpen,\n    type LucideIcon,\n    Moon,\n    Sun,\n    MessageSquare,\n    Mail,\n    Clock,\n    UserPlus,\n    Menu,\n    X\n, WifiOff } from 'lucide-react'\nimport { useState, useEffect } from 'react'\nimport { NavLink, useNavigate, Outlet, useLocation } from 'react-router-dom'\n\nimport { useTheme } from '../contexts/ThemeContext'\nimport { useAuthStore, useAppStore } from '../stores'\nimport { CommandPalette } from './patterns/CommandPalette'\nimport { useToast } from '../contexts/ToastContext'\nimport { useNetworkStatus } from '../hooks/useNetworkStatus'\nimport { printCurrentView } from '../utils/print'\n\nimport type { UpdateStatus } from '../types/electron-api'\n\ninterface NavItem {\n    path?: string\n    label: string\n    icon: LucideIcon\n    children?: NavItem[]\n}\n\nconst navItems: NavItem[] = [\n    { path: '/', label: 'Dashboard', icon: LayoutDashboard },\n    {\n        label: 'Students',\n        icon: Users,\n        children: [\n            { path: '/students', label: 'All Students', icon: Users },\n            { path: '/students/promotions', label: 'Promotions', icon: ArrowUpRight },\n            { path: '/attendance', label: 'Attendance', icon: CheckCircle },\n            { path: '/report-cards', label: 'Report Cards', icon: FileText },\n            { path: '/academic/allocations', label: 'Subject Allocation', icon: UserPlus },\n            { path: '/academic/subjects', label: 'Subjects', icon: BookOpen },\n            { path: '/academic/exams', label: 'Exam Management', icon: ClipboardList },\n            { path: '/academic/marks-entry', label: 'Marks Entry', icon: ClipboardList },\n            { path: '/academic/merit-lists', label: 'Merit Lists', icon: ClipboardList },\n            { path: '/academic/schedule', label: 'Exam Schedule', icon: Clock },\n            { path: '/academic/awards', label: 'Awards', icon: ClipboardList },\n            {\n                label: 'Analytics',\n                icon: BarChart3,\n                children: [\n                    { path: '/academic/analytics/exams', label: 'Exam Analytics', icon: BarChart3 },\n                    { path: '/academic/analytics/report-cards', label: 'Report Card Stats', icon: BarChart3 },\n                    { path: '/academic/analytics/subject-merit-list', label: 'Subject Merit', icon: TableProperties },\n                    { path: '/academic/analytics/most-improved', label: 'Most Improved', icon: TrendingUp },\n                ]\n            }\n        ],\n    },\n    {\n        label: 'Finance',\n        icon: Wallet,\n        children: [\n            { path: '/fee-payment', label: 'Fee Payments', icon: CreditCard },\n            { path: '/invoices', label: 'Invoices', icon: FileText },\n            { path: '/fee-structure', label: 'Fee Structure', icon: TableProperties },\n            { path: '/budget', label: 'Budgets', icon: Calculator },\n            { path: '/bank-accounts', label: 'Bank Accounts', icon: CreditCard },\n            { path: '/approvals', label: 'Approvals', icon: CheckCircle },\n            { path: '/record-income', label: 'Record Income', icon: TrendingUp },\n            { path: '/record-expense', label: 'Record Expense', icon: TrendingDown },\n            { path: '/transactions', label: 'Transactions', icon: ClipboardList },\n            { path: '/financial-reports', label: 'Financial Reports', icon: BarChart3 },\n            { path: '/cash-flow', label: 'Cash Flow', icon: TrendingUp },\n        ],\n    },\n    {\n        label: 'Payroll',\n        icon: Calculator,\n        children: [\n            { path: '/staff', label: 'Staff', icon: UserCog },\n            { path: '/payroll-run', label: 'Run Payroll', icon: Calculator },\n        ],\n    },\n    { path: '/inventory', label: 'Inventory', icon: Package },\n    {\n        label: 'Reports',\n        icon: BarChart3,\n        children: [\n            { path: '/reports', label: 'All Reports', icon: BarChart3 },\n            { path: '/reports/scheduled', label: 'Scheduler', icon: Clock },\n        ]\n    },\n    {\n        label: 'Communications',\n        icon: Mail,\n        children: [\n            { path: '/communications', label: 'Message Logs', icon: MessageSquare },\n        ],\n    },\n    { path: '/settings', label: 'Settings', icon: Settings },\n]\n\nconst adminItems: NavItem[] = [\n    { path: '/users', label: 'Users', icon: Users },\n    { path: '/audit-log', label: 'Audit Log', icon: Shield },\n    { path: '/backup', label: 'Backup', icon: Database },\n]\n\nexport default function Layout() {\n    const navigate = useNavigate()\n    const location = useLocation()\n    const isOnline = useNetworkStatus()\n    const { user, logout } = useAuthStore()\n    const { schoolSettings, currentAcademicYear, setSchoolSettings, setCurrentAcademicYear, setCurrentTerm } = useAppStore()\n    const { theme, toggleTheme } = useTheme()\n    const [expandedMenus, setExpandedMenus] = useState<string[]>([])\n    const [isSidebarOpen, setIsSidebarOpen] = useState(false)\n    const { showToast } = useToast()\n\n    useEffect(() => {\n        const loadGlobals = async () => {\n            try {\n                const [settings, year, term] = await Promise.all([\n                    window.electronAPI.getSettings(),\n                    window.electronAPI.getCurrentAcademicYear(),\n                    window.electronAPI.getCurrentTerm()\n                ])\n                setSchoolSettings(settings)\n                setCurrentAcademicYear(year)\n                setCurrentTerm(term)\n            } catch (error) {\n                console.error('Failed to load global settings:', error)\n            }\n        }\n\n        void loadGlobals()\n    }, [setSchoolSettings, setCurrentAcademicYear, setCurrentTerm])\n\n    useEffect(() => {\n        const unsubscribeNavigate = window.electronAPI.onNavigate((path) => {\n            navigate(path)\n        })\n        const unsubscribePrint = window.electronAPI.onTriggerPrint(() => {\n            printCurrentView({ title: 'Page Print Preview' })\n        })\n        const unsubscribeImport = window.electronAPI.onOpenImportDialog(() => {\n            navigate('/students?import=1')\n        })\n        const unsubscribeBackup = window.electronAPI.onBackupDatabase((filePath) => {\n            void (async () => {\n                try {\n                    const result = await window.electronAPI.createBackupTo(filePath)\n                    if (result.success) {\n                        showToast('Backup saved successfully', 'success')\n                    } else {\n                        showToast('Backup failed', 'error')\n                    }\n                } catch (error) {\n                    showToast(error instanceof Error ? error.message : 'Backup failed', 'error')\n                }\n            })()\n        })\n        const unsubscribeCheckUpdates = window.electronAPI.onCheckForUpdates(() => {\n            window.electronAPI.checkForUpdates().catch((error) => {\n                showToast(error instanceof Error ? error.message : 'Update check failed', 'error')\n            })\n        })\n        const unsubscribeUpdateStatus = window.electronAPI.onUpdateStatus((data: UpdateStatus) => {\n            if (data.status === 'available') {\n                showToast(`Update available: v${data.version}`, 'info')\n            } else if (data.status === 'downloading') {\n                showToast(`Downloading update: ${data.progress}%`, 'info')\n            } else if (data.status === 'downloaded') {\n                showToast(`Update ready: v${data.version}`, 'success')\n            } else if (data.status === 'error') {\n                showToast(data.error, 'error')\n            } else if (data.status === 'not-available') {\n                showToast('No updates available', 'info')\n            }\n        })\n        const unsubscribeDbError = window.electronAPI.onDatabaseError((message) => {\n            showToast(message, 'error')\n        })\n\n        return () => {\n            unsubscribeNavigate()\n            unsubscribePrint()\n            unsubscribeImport()\n            unsubscribeBackup()\n            unsubscribeCheckUpdates()\n            unsubscribeUpdateStatus()\n            unsubscribeDbError()\n        }\n    }, [navigate, showToast])\n\n    const handleLogout = () => {\n        logout()\n        navigate('/login')\n    }\n\n    const toggleMenu = (label: string) => {\n        setExpandedMenus(prev =>\n            prev.includes(label)\n                ? prev.filter(item => item !== label)\n                : [...prev, label]\n        )\n    }\n\n    const renderNavItem = (item: NavItem, isChild = false) => {\n        if (item.children) {\n            const isExpanded = expandedMenus.includes(item.label)\n            return (\n                <div key={item.label}>\n                    <button\n                        onClick={() => toggleMenu(item.label)}\n                        className=\"w-full flex items-center justify-between px-4 py-3 text-foreground/60 hover:bg-secondary rounded-lg transition-colors\"\n                    >\n                        <div className=\"flex items-center gap-3\">\n                            <item.icon className=\"w-5 h-5\" />\n                            <span>{item.label}</span>\n                        </div>\n                        <ChevronDown className={`w-4 h-4 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />\n                    </button>\n                    {isExpanded && (\n                        <div className=\"ml-4 mt-1 space-y-1\">\n                            {item.children.map((child) => renderNavItem(child, true))}\n                        </div>\n                    )}\n                </div>\n            )\n        }\n\n        if (!item.path) {return null}\n\n        return (\n            <NavLink\n                key={item.path}\n                to={item.path}\n                onClick={() => setIsSidebarOpen(false)}\n                className={({ isActive }) =>\n                    `flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${isActive\n                        ? 'bg-primary text-primary-foreground shadow-lg shadow-primary/20'\n                        : 'text-foreground/60 hover:bg-secondary'\n                    } ${isChild ? 'text-sm' : ''}`\n                }\n            >\n                <item.icon className={`${isChild ? 'w-4 h-4' : 'w-5 h-5'}`} />\n                <span>{item.label}</span>\n            </NavLink>\n        )\n    }\n\n    return (\n        <div className=\"flex h-screen bg-background text-foreground overflow-hidden\">\n            <CommandPalette />\n\n            {/* Backdrop */}\n            {isSidebarOpen && (\n                <div\n                    className=\"fixed inset-0 bg-background/60 backdrop-blur-sm z-40 lg:hidden animate-in fade-in duration-300\"\n                    onClick={() => setIsSidebarOpen(false)}\n                    onKeyDown={(e) => {\n                        if (e.key === 'Escape' || e.key === 'Enter' || e.key === ' ') {\n                            setIsSidebarOpen(false)\n                        }\n                    }}\n                    role=\"button\"\n                    tabIndex={0}\n                    aria-label=\"Close sidebar\"\n                />\n            )}\n\n            {/* Sidebar */}\n            <aside className={`fixed inset-y-0 left-0 w-64 premium-sidebar flex flex-col z-50 transition-transform duration-500 ease-out lg:relative lg:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>\n                <div className=\"p-8 border-b border-border/40 relative\">\n                    <button\n                        onClick={() => setIsSidebarOpen(false)}\n                        className=\"absolute top-4 right-4 p-2 lg:hidden text-foreground/40 hover:text-primary transition-colors\"\n                    >\n                        <X className=\"w-5 h-5\" />\n                    </button>\n                    <div className=\"flex items-center gap-3\">\n                        <div className=\"w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-indigo-600 flex items-center justify-center shadow-lg shadow-primary/30\">\n                            <Shield className=\"w-6 h-6 text-white\" />\n                        </div>\n                        <div>\n                            <h1 className=\"text-lg font-bold leading-tight tracking-tight text-foreground font-heading\">\n                                {schoolSettings?.school_name.split(' ')[0] || 'Mwingi'}\n                                <span className=\"text-primary block text-xs font-medium tracking-widest uppercase\">ERP System</span>\n                            </h1>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Navigation */}\n                <nav className=\"flex-1 p-4 mt-2 space-y-1 overflow-y-auto no-scrollbar\">\n                    {navItems.map((item) => renderNavItem(item))}\n\n                    {user?.role === 'ADMIN' && (\n                        <div className=\"pt-6\">\n                            <p className=\"px-4 text-[10px] text-foreground/40 uppercase tracking-[0.2em] font-bold mb-3\">Administration</p>\n                            {adminItems.map((item) => renderNavItem(item))}\n                        </div>\n                    )}\n                </nav>\n\n                {/* User Profile Section */}\n                <div className=\"p-6 border-t border-border/40 bg-secondary/30\">\n                    <div className=\"flex items-center gap-4 mb-6\">\n                        <div className=\"relative\">\n                            <div className=\"w-10 h-10 rounded-full bg-gradient-to-tr from-secondary to-slate-700 border-2 border-primary/20 flex items-center justify-center text-white font-bold text-sm shadow-inner\">\n                                {user?.full_name.charAt(0) || 'U'}\n                            </div>\n                            <div className=\"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-success rounded-full border-2 border-card\"></div>\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-sm font-semibold truncate text-foreground\">{user?.full_name}</p>\n                            <p className=\"text-[10px] text-primary font-bold uppercase tracking-wider\">{user?.role.replace('_', ' ')}</p>\n                        </div>\n                    </div>\n\n                    <button\n                        onClick={handleLogout}\n                        className=\"w-full flex items-center justify-center gap-2 px-4 py-2.5 text-xs font-bold text-foreground/60 hover:text-destructive hover:bg-destructive/10 rounded-xl transition-all border border-transparent hover:border-destructive/20\"\n                    >\n                        <LogOut className=\"w-4 h-4\" />\n                        <span>Sign Out</span>\n                    </button>\n                </div>\n            </aside>\n\n            {/* Main Content Area */}\n            <div className=\"flex-1 flex flex-col min-w-0 overflow-hidden relative\">\n                {/* Offline Indicator */}\n                {!isOnline && (\n                    <div className=\"bg-red-500 text-white px-4 py-1 text-xs font-bold text-center flex items-center justify-center gap-2 animate-in slide-in-from-top\">\n                        <WifiOff className=\"w-3 h-3\" />\n                        <span>OFFLINE MODE: Cloud features (Email/SMS) are unavailable. Local features work normally.</span>\n                    </div>\n                )}\n\n                {/* Global Header / Search Bar Placeholder */}\n                <header className=\"premium-header px-4 lg:px-8 h-20 flex items-center justify-between shrink-0\">\n                    <div className=\"flex items-center gap-4\">\n                        <button\n                            onClick={() => setIsSidebarOpen(true)}\n                            className=\"p-2 lg:hidden text-foreground/60 hover:text-primary transition-colors bg-secondary/20 rounded-lg\"\n                        >\n                            <Menu className=\"w-5 h-5\" />\n                        </button>\n                        <h2 className=\"text-sm font-bold text-foreground/40 uppercase tracking-widest hidden sm:block\">\n                            {location.pathname === '/' ? 'Overview' : location.pathname.substring(1).split('/')[0].replace('-', ' ')}\n                        </h2>\n                    </div>\n\n                    <div className=\"flex items-center gap-6\">\n                        <div className=\"text-right hidden sm:block\">\n                            <p className=\"text-xs font-bold text-foreground\">{schoolSettings?.school_name}</p>\n                            <p className=\"text-[10px] text-foreground/40 font-medium\">\n                                {currentAcademicYear?.year_name ? `Academic Year ${currentAcademicYear.year_name}` : 'Academic Year'}\n                            </p>\n                        </div>\n                        <div className=\"hidden md:flex items-center gap-2 mr-4 text-foreground/40 text-xs font-medium bg-secondary/30 px-3 py-1.5 rounded-lg border border-border/40\">\n                            <span>Command Palette</span>\n                            <kbd className=\"hidden sm:inline-block px-1.5 font-mono text-[10px] bg-background border border-border rounded shadow-sm\">Ctrl K</kbd>\n                        </div>\n\n                        <div className=\"w-px h-8 bg-border/60\"></div>\n\n                        <div className=\"flex items-center gap-2 p-1.5 bg-secondary/50 border border-border/60 rounded-xl\">\n                            <button\n                                onClick={toggleTheme}\n                                className=\"p-2 rounded-lg hover:bg-secondary text-foreground/60 transition-colors\"\n                            >\n                                {theme === 'dark' ? <Sun className=\"w-4 h-4\" /> : <Moon className=\"w-4 h-4\" />}\n                            </button>\n                            <button className=\"p-2 rounded-lg hover:bg-white/10 text-foreground/60 transition-colors\">\n                                <Settings className=\"w-4 h-4\" />\n                            </button>\n                        </div>\n                    </div>\n                </header>\n\n                <main className=\"flex-1 overflow-y-auto overflow-x-hidden p-4 lg:p-8 no-scrollbar scroll-smooth\">\n                    <div className=\"max-w-7xl mx-auto animate-slide-up pb-12\">\n                        <Outlet />\n                    </div>\n                </main>\n            </div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\feedback\\OfflineIndicator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\feedback\\PrintPreviewHost.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\patterns\\CommandPalette.tsx","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'CommandPalette' has too many lines (122). Maximum allowed is 80.","line":13,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":145,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Command } from 'cmdk'\r\nimport {\r\n    LayoutDashboard, Users, UserPlus, FileText,\r\n    CreditCard, Settings, Sun, Moon, LogOut,\r\n    Calculator, Package, Search\r\n} from 'lucide-react'\nimport { useEffect, useState } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\n\r\nimport { useTheme } from '../../contexts/ThemeContext'\r\nimport { useAuthStore } from '../../stores'\r\n\r\nexport function CommandPalette() {\r\n    const [open, setOpen] = useState(false)\r\n    const navigate = useNavigate()\r\n    const { toggleTheme } = useTheme()\r\n    const { logout } = useAuthStore()\r\n\r\n    useEffect(() => {\n        const down = (e: KeyboardEvent) => {\n            if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {\n                e.preventDefault()\n                setOpen((open) => !open)\n            }\n        }\n        document.addEventListener('keydown', down)\n        const unsubscribe = window.electronAPI.onOpenCommandPalette(() => setOpen(true))\n        return () => {\n            document.removeEventListener('keydown', down)\n            unsubscribe()\n        }\n    }, [])\n\r\n    const run = (action: () => void) => {\r\n        action()\r\n        setOpen(false)\r\n    }\r\n\r\n    if (!open) {return null}\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-start justify-center pt-[20vh] animate-in fade-in duration-200\">\r\n            <Command className=\"w-full max-w-lg bg-white dark:bg-slate-900 rounded-xl shadow-2xl overflow-hidden border border-slate-200 dark:border-slate-800 animate-in slide-in-from-top-4 duration-200\">\r\n                <div className=\"flex items-center border-b border-slate-200 dark:border-slate-800 px-3\">\r\n                    <Search className=\"w-5 h-5 text-slate-400 mr-2\" />\r\n                    <Command.Input\r\n                        placeholder=\"Type a command or search...\"\r\n                        className=\"w-full px-2 py-4 text-base outline-none bg-transparent text-slate-900 dark:text-slate-100 placeholder:text-slate-400\"\r\n                    />\r\n                </div>\r\n\r\n                <Command.List className=\"max-h-[300px] overflow-y-auto p-2\">\r\n                    <Command.Empty className=\"py-6 text-center text-sm text-slate-500\">\r\n                        No results found.\r\n                    </Command.Empty>\r\n\r\n                    <Command.Group heading=\"Navigation\" className=\"px-2 py-1.5 text-xs font-medium text-slate-500 uppercase tracking-wider mb-2\">\r\n                        <Command.Item\r\n                            onSelect={() => run(() => navigate('/'))}\r\n                            className=\"flex items-center gap-2 px-2 py-2 text-sm text-slate-700 dark:text-slate-200 rounded-lg aria-selected:bg-blue-50 dark:aria-selected:bg-blue-900/20 aria-selected:text-blue-600 dark:aria-selected:text-blue-400 cursor-pointer\"\r\n                        >\r\n                            <LayoutDashboard className=\"w-4 h-4\" />\r\n                            <span>Dashboard</span>\r\n                        </Command.Item>\r\n                        <Command.Item\r\n                            onSelect={() => run(() => navigate('/students'))}\r\n                            className=\"flex items-center gap-2 px-2 py-2 text-sm text-slate-700 dark:text-slate-200 rounded-lg aria-selected:bg-blue-50 dark:aria-selected:bg-blue-900/20 aria-selected:text-blue-600 dark:aria-selected:text-blue-400 cursor-pointer\"\r\n                        >\r\n                            <Users className=\"w-4 h-4\" />\r\n                            <span>Students</span>\r\n                        </Command.Item>\r\n                        <Command.Item\r\n                            onSelect={() => run(() => navigate('/fee-payment'))}\r\n                            className=\"flex items-center gap-2 px-2 py-2 text-sm text-slate-700 dark:text-slate-200 rounded-lg aria-selected:bg-blue-50 dark:aria-selected:bg-blue-900/20 aria-selected:text-blue-600 dark:aria-selected:text-blue-400 cursor-pointer\"\r\n                        >\r\n                            <CreditCard className=\"w-4 h-4\" />\r\n                            <span>Fee Payments</span>\r\n                        </Command.Item>\r\n                        <Command.Item\r\n                            onSelect={() => run(() => navigate('/inventory'))}\r\n                            className=\"flex items-center gap-2 px-2 py-2 text-sm text-slate-700 dark:text-slate-200 rounded-lg aria-selected:bg-blue-50 dark:aria-selected:bg-blue-900/20 aria-selected:text-blue-600 dark:aria-selected:text-blue-400 cursor-pointer\"\r\n                        >\r\n                            <Package className=\"w-4 h-4\" />\r\n                            <span>Inventory</span>\r\n                        </Command.Item>\r\n                        <Command.Item\r\n                            onSelect={() => run(() => navigate('/settings'))}\r\n                            className=\"flex items-center gap-2 px-2 py-2 text-sm text-slate-700 dark:text-slate-200 rounded-lg aria-selected:bg-blue-50 dark:aria-selected:bg-blue-900/20 aria-selected:text-blue-600 dark:aria-selected:text-blue-400 cursor-pointer\"\r\n                        >\r\n                            <Settings className=\"w-4 h-4\" />\r\n                            <span>Settings</span>\r\n                        </Command.Item>\r\n                    </Command.Group>\r\n\r\n                    <Command.Separator className=\"h-px bg-slate-200 dark:bg-slate-800 my-1\" />\r\n\r\n                    <Command.Group heading=\"Quick Actions\" className=\"px-2 py-1.5 text-xs font-medium text-slate-500 uppercase tracking-wider mb-2\">\r\n                        <Command.Item\r\n                            onSelect={() => run(() => navigate('/students/new?action=create'))} // Assuming we handle params or routing\r\n                            // Actually pure nav for now\r\n                            className=\"flex items-center gap-2 px-2 py-2 text-sm text-slate-700 dark:text-slate-200 rounded-lg aria-selected:bg-blue-50 dark:aria-selected:bg-blue-900/20 aria-selected:text-blue-600 dark:aria-selected:text-blue-400 cursor-pointer\"\r\n                        >\r\n                            <UserPlus className=\"w-4 h-4\" />\r\n                            <span>New Student</span>\r\n                        </Command.Item>\r\n                        <Command.Item\r\n                            onSelect={() => run(() => navigate('/invoices'))}\r\n                            className=\"flex items-center gap-2 px-2 py-2 text-sm text-slate-700 dark:text-slate-200 rounded-lg aria-selected:bg-blue-50 dark:aria-selected:bg-blue-900/20 aria-selected:text-blue-600 dark:aria-selected:text-blue-400 cursor-pointer\"\r\n                        >\r\n                            <FileText className=\"w-4 h-4\" />\r\n                            <span>New Invoice</span>\r\n                        </Command.Item>\r\n                        <Command.Item\r\n                            onSelect={() => run(() => navigate('/payroll-run'))}\r\n                            className=\"flex items-center gap-2 px-2 py-2 text-sm text-slate-700 dark:text-slate-200 rounded-lg aria-selected:bg-blue-50 dark:aria-selected:bg-blue-900/20 aria-selected:text-blue-600 dark:aria-selected:text-blue-400 cursor-pointer\"\r\n                        >\r\n                            <Calculator className=\"w-4 h-4\" />\r\n                            <span>Run Payroll</span>\r\n                        </Command.Item>\r\n                    </Command.Group>\r\n\r\n                    <Command.Separator className=\"h-px bg-slate-200 dark:bg-slate-800 my-1\" />\r\n\r\n                    <Command.Group heading=\"System\" className=\"px-2 py-1.5 text-xs font-medium text-slate-500 uppercase tracking-wider mb-2\">\r\n                        <Command.Item\r\n                            onSelect={() => run(toggleTheme)}\r\n                            className=\"flex items-center gap-2 px-2 py-2 text-sm text-slate-700 dark:text-slate-200 rounded-lg aria-selected:bg-blue-50 dark:aria-selected:bg-blue-900/20 aria-selected:text-blue-600 dark:aria-selected:text-blue-400 cursor-pointer\"\r\n                        >\r\n                            <Sun className=\"w-4 h-4 dark:hidden\" />\r\n                            <Moon className=\"w-4 h-4 hidden dark:block\" />\r\n                            <span>Toggle Theme</span>\r\n                        </Command.Item>\r\n                        <Command.Item\r\n                            onSelect={() => run(() => { logout(); navigate('/login') })}\r\n                            className=\"flex items-center gap-2 px-2 py-2 text-sm text-red-600 dark:text-red-400 rounded-lg aria-selected:bg-red-50 dark:aria-selected:bg-red-900/20 cursor-pointer\"\r\n                        >\r\n                            <LogOut className=\"w-4 h-4\" />\r\n                            <span>Logout</span>\r\n                        </Command.Item>\r\n                    </Command.Group>\r\n                </Command.List>\r\n            </Command>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\patterns\\InstitutionalHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\patterns\\PageHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\patterns\\StatCard.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'StatCard' has a complexity of 13. Maximum allowed is 12.","line":14,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":14,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type LucideIcon, TrendingUp, TrendingDown } from 'lucide-react'\r\n\r\ninterface StatCardProps {\r\n    label: string\r\n    value: string | number\r\n    icon: LucideIcon\r\n    color?: string\r\n    trend?: 'up' | 'down'\r\n    trendLabel?: string\r\n    loading?: boolean\r\n    compact?: boolean\r\n}\r\n\r\nexport function StatCard({\n    label,\n    value,\n    icon: Icon,\n    color = 'from-indigo-500/10 to-blue-500/10 text-indigo-500 dark:text-indigo-400',\n    trend,\n    trendLabel,\n    loading = false,\n    compact = false\n}: Readonly<StatCardProps>) {\n    return (\r\n        <div className={`premium-card group ${compact ? 'p-3' : ''}`}>\r\n            <div className=\"flex items-start justify-between\">\r\n                <div className=\"space-y-4\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <div className={`rounded-xl bg-gradient-to-br transition-transform duration-500 group-hover:scale-110 ${color} ${compact ? 'p-2' : 'p-2.5'}`}>\r\n                            <Icon className={`${compact ? 'w-4 h-4' : 'w-5 h-5'}`} />\r\n                        </div>\r\n                        <span className={`uppercase tracking-[0.2em] font-bold text-foreground/50 dark:text-foreground/40 ${compact ? 'text-[9px]' : 'text-[10px]'}`}>\r\n                            {label}\r\n                        </span>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-1\">\r\n                        <h3 className={`font-bold tracking-tight text-foreground font-heading ${compact ? 'text-2xl' : 'text-3xl'}`}>\r\n                            {loading ? (\r\n                                <div className=\"h-9 w-24 bg-secondary animate-pulse rounded\" />\r\n                            ) : (\r\n                                value\r\n                            )}\r\n                        </h3>\r\n\r\n                        {trend && (\r\n                            <div className={`flex items-center gap-1.5 text-xs font-bold ${trend === 'up' ? 'text-emerald-500 dark:text-emerald-400' : 'text-rose-500 dark:text-rose-400'}`}>\r\n                                {trend === 'up' ? <TrendingUp className=\"w-3.5 h-3.5\" /> : <TrendingDown className=\"w-3.5 h-3.5\" />}\r\n                                <span>{trendLabel}</span>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Abstract background decorative element */}\r\n                <div className=\"absolute top-0 right-0 -mr-4 -mt-4 opacity-[0.03] transition-opacity duration-700 group-hover:opacity-[0.07]\">\r\n                    <Icon className=\"w-32 h-32 rotate-12\" />\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\ui\\Badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\ui\\Dropdown.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\ui\\EmptyState.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\ui\\ImportDialog.tsx","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'ImportDialog' has too many lines (201). Maximum allowed is 80.","line":30,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":248,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n    Upload, Download, AlertTriangle,\n    FileSpreadsheet, Loader2, X\n} from 'lucide-react'\nimport React, { useState, useRef } from 'react'\n\nimport { Modal } from './Modal'\nimport { useAuthStore } from '../../stores'\n\ninterface ImportDialogProps {\n    isOpen: boolean\n    onClose: () => void\n    onSuccess: (result: unknown) => void\n    entityType: string\n    title?: string\n}\n\ninterface ImportResult {\n    success: boolean\n    totalRows: number\n    imported: number\n    skipped: number\n    errors: Array<{ row: number; message: string }>\n}\n\ninterface ImportTemplate {\n    columns: Array<{ name: string; required: boolean }>\n}\n\nexport function ImportDialog({\n    isOpen,\n    onClose,\n    onSuccess,\n    entityType,\n    title = 'Import Data'\n}: Readonly<ImportDialogProps>) {\n    const { user } = useAuthStore()\n    const [step, setStep] = useState<'UPLOAD' | 'REVIEW' | 'IMPORTING' | 'RESULT'>('UPLOAD')\n    const [file, setFile] = useState<File | null>(null)\n    const [importResult, setImportResult] = useState<ImportResult | null>(null)\n    const [error, setError] = useState<string | null>(null)\n    const fileInputRef = useRef<HTMLInputElement>(null)\n\n    const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const selected = e.target.files?.[0]\n        if (selected) {\n            if (!/\\.(csv|xlsx|xls)$/i.exec(selected.name)) {\n                setError('Please select a valid CSV or Excel file')\n                return\n            }\n            setFile(selected)\n            setError(null)\n            setStep('REVIEW')\n        }\n    }\n\n    const handleDownloadTemplate = async () => {\n        try {\n            const result = await window.electronAPI.downloadImportTemplate(entityType)\n            if (result.success) {\n                alert(`Template downloaded to: ${result.filePath}`)\n            }\n        } catch (err) {\n            console.error(err)\n            alert('Failed to download template')\n        }\n    }\n\n    const handleImport = async () => {\n        if (!file) {return}\n        if (!user?.id) {\n            setError('You must be signed in to import data')\n            return\n        }\n\n        setStep('IMPORTING')\n        try {\n            const config = {\n                entityType,\n                mappings: await window.electronAPI.getImportTemplate(entityType).then((t: unknown) =>\n                    (t as ImportTemplate).columns.map((c) => ({\n                        sourceColumn: c.name,\n                        targetField: c.name.toLowerCase().replace(/\\s+/g, '_'),\n                        required: c.required\n                    }))\n                ),\n                skipDuplicates: true,\n                duplicateKey: entityType === 'STUDENT' ? 'admission_number' : 'id'\n            }\n\n            const result = await window.electronAPI.importData((file as File & { path: string }).path, config, user.id)\n            setImportResult(result)\n            setStep('RESULT')\n\n            if (result.success) {\n                onSuccess(result)\n            }\n        } catch (err) {\n            setError(err instanceof Error ? err.message : 'Import failed')\n            setStep('REVIEW')\n        }\n    }\n\n    const reset = () => {\n        setFile(null)\n        setStep('UPLOAD')\n        setImportResult(null)\n        setError(null)\n    }\n\n    const handleClose = () => {\n        reset()\n        onClose()\n    }\n\n    return (\n        <Modal isOpen={isOpen} onClose={handleClose} title={title}>\n            <div className=\"space-y-6\">\n\n                {step === 'UPLOAD' && (\n                    <div className=\"space-y-4\">\n                        <div\n                            className=\"border-2 border-dashed border-white/10 rounded-xl p-10 text-center hover:border-primary/50 transition-colors cursor-pointer bg-white/5\"\n                            onClick={() => fileInputRef.current?.click()}\n                            onKeyDown={(e) => {\n                                if (e.key === 'Enter' || e.key === ' ') {\n                                    fileInputRef.current?.click()\n                                }\n                            }}\n                            role=\"button\"\n                            tabIndex={0}\n                        >\n                            <FileSpreadsheet className=\"w-12 h-12 mx-auto mb-4 text-primary\" />\n                            <p className=\"font-medium text-white mb-1\">Click to upload CSV or Excel</p>\n                            <p className=\"text-sm text-foreground/50\">or drag and drop here</p>\n                            <input\n                                ref={fileInputRef}\n                                type=\"file\"\n                                accept=\".csv,.xlsx,.xls\"\n                                className=\"hidden\"\n                                onChange={handleFileSelect}\n                                aria-label=\"Upload CSV or Excel file\"\n                            />\n                        </div>\n\n                        <div className=\"flex justify-between items-center bg-blue-500/10 p-4 rounded-lg border border-blue-500/20\">\n                            <div className=\"flex items-center gap-3\">\n                                <Download className=\"w-5 h-5 text-blue-400\" />\n                                <div>\n                                    <p className=\"text-sm font-medium text-blue-100\">Need a template?</p>\n                                    <p className=\"text-xs text-blue-300\">Download a pre-formatted Excel file</p>\n                                </div>\n                            </div>\n                            <button\n                                onClick={handleDownloadTemplate}\n                                className=\"px-3 py-1.5 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded-md text-sm font-medium transition-colors\"\n                            >\n                                Download\n                            </button>\n                        </div>\n                    </div>\n                )}\n\n                {step === 'REVIEW' && file && (\n                    <div className=\"space-y-4\">\n                        <div className=\"flex items-center justify-between p-4 bg-white/5 rounded-lg border border-white/10\">\n                            <div className=\"flex items-center gap-3\">\n                                <div className=\"p-2 bg-green-500/20 rounded-lg text-green-400\">\n                                    <FileSpreadsheet className=\"w-5 h-5\" />\n                                </div>\n                                <div>\n                                    <p className=\"font-medium text-white\">{file.name}</p>\n                                    <p className=\"text-xs text-foreground/50\">{(file.size / 1024).toFixed(1)} KB</p>\n                                </div>\n                            </div>\n                            <button onClick={reset} className=\"p-1 hover:bg-white/10 rounded-full text-foreground/50\" aria-label=\"Remove file\">\n                                <X className=\"w-4 h-4\" />\n                            </button>\n                        </div>\n\n                        {error && (\n                            <div className=\"p-3 bg-red-500/10 border border-red-500/20 rounded-lg flex items-center gap-2 text-red-400 text-sm\">\n                                <AlertTriangle className=\"w-4 h-4\" />\n                                {error}\n                            </div>\n                        )}\n\n                        <div className=\"flex justify-end gap-3 pt-4\">\n                            <button onClick={reset} className=\"btn btn-secondary\">Cancel</button>\n                            <button onClick={handleImport} className=\"btn btn-primary flex items-center gap-2\">\n                                <Upload className=\"w-4 h-4\" />\n                                Import Now\n                            </button>\n                        </div>\n                    </div>\n                )}\n\n                {step === 'IMPORTING' && (\n                    <div className=\"py-12 text-center\">\n                        <Loader2 className=\"w-12 h-12 text-primary animate-spin mx-auto mb-4\" />\n                        <h3 className=\"text-lg font-bold text-white mb-2\">Processing Data...</h3>\n                        <p className=\"text-sm text-foreground/50\">Please wait while we validate and import your records.</p>\n                    </div>\n                )}\n\n                {step === 'RESULT' && importResult && (\n                    <div className=\"space-y-6\">\n                        <div className=\"grid grid-cols-3 gap-4\">\n                            <div className=\"p-4 bg-white/5 rounded-lg text-center border border-white/10\">\n                                <p className=\"text-sm text-foreground/50 mb-1\">Total Rows</p>\n                                <p className=\"text-2xl font-bold text-white\">{importResult.totalRows}</p>\n                            </div>\n                            <div className=\"p-4 bg-green-500/10 rounded-lg text-center border border-green-500/20\">\n                                <p className=\"text-sm text-green-400 mb-1\">Imported</p>\n                                <p className=\"text-2xl font-bold text-green-400\">{importResult.imported}</p>\n                            </div>\n                            <div className=\"p-4 bg-amber-500/10 rounded-lg text-center border border-amber-500/20\">\n                                <p className=\"text-sm text-amber-400 mb-1\">Skipped</p>\n                                <p className=\"text-2xl font-bold text-amber-400\">{importResult.skipped}</p>\n                            </div>\n                        </div>\n\n                        {importResult.errors.length > 0 && (\n                            <div className=\"bg-red-500/5 border border-red-500/10 rounded-lg overflow-hidden\">\n                                <div className=\"px-4 py-2 bg-red-500/10 border-b border-red-500/10 font-medium text-red-400 text-sm\">\n                                    Errors ({importResult.errors.length})\n                                </div>\n                                <div className=\"max-h-32 overflow-y-auto divide-y divide-red-500/10\">\n                                    {importResult.errors.map((err, i) => (\n                                        <div key={i} className=\"px-4 py-2 text-xs text-red-300\">\n                                            Row {err.row}: {err.message}\n                                        </div>\n                                    ))}\n                                </div>\n                            </div>\n                        )}\n\n                        <div className=\"flex justify-center pt-2\">\n                            <button onClick={handleClose} className=\"btn btn-primary min-w-[120px]\">\n                                Done\n                            </button>\n                        </div>\n                    </div>\n                )}\n            </div>\n        </Modal>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\ui\\Input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\ui\\Modal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\ui\\Select.tsx","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'Select' has too many lines (85). Maximum allowed is 80.","line":23,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":110,"endColumn":2},{"ruleId":"complexity","severity":1,"message":"Function 'Select' has a complexity of 13. Maximum allowed is 12.","line":23,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":23,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Check, ChevronDown } from 'lucide-react'\nimport { useEffect, useId, useRef, useState } from 'react'\n\r\nimport { cn } from '../../utils/cn.js'\r\n\r\ninterface SelectOption {\n    value: string | number\n    label: string\n}\n\ninterface SelectProps {\n    value: string | number\n    onChange: (value: string | number) => void\n    options: SelectOption[]\n    placeholder?: string\n    className?: string\n    label?: string\n    name?: string\n    id?: string\n    'aria-label'?: string\n}\n\nexport function Select({\n    value,\n    onChange,\n    options,\n    placeholder = 'Select...',\n    className,\n    label,\n    id,\n    'aria-label': ariaLabel\n}: Readonly<SelectProps>) {\n    const [isOpen, setIsOpen] = useState(false)\n    const containerRef = useRef<HTMLDivElement>(null)\n    const generatedId = useId()\n    const selectId = id || `select-${generatedId}`\n    const labelId = `${selectId}-label`\n    const selectedOption = options.find(opt => opt.value === value)\n\r\n    useEffect(() => {\r\n        const handleClickOutside = (event: MouseEvent) => {\r\n            if (containerRef.current && !containerRef.current.contains(event.target as Node)) {\r\n                setIsOpen(false)\r\n            }\r\n        }\r\n        document.addEventListener('mousedown', handleClickOutside)\r\n        return () => document.removeEventListener('mousedown', handleClickOutside)\r\n    }, [])\r\n\r\n    return (\r\n        <div className={cn(\"space-y-1.5\", className)} ref={containerRef}>\r\n            {label && (\n                <label htmlFor={selectId} id={labelId} className=\"text-xs font-bold text-foreground/60 px-1\">\n                    {label}\n                </label>\n            )}\n            <div className=\"relative\">\n                <button\n                    id={selectId}\n                    type=\"button\"\n                    onClick={() => setIsOpen(!isOpen)}\n                    aria-label={ariaLabel || label || placeholder}\n                    aria-labelledby={label ? labelId : undefined}\n                    aria-expanded={isOpen}\n                    aria-haspopup=\"listbox\"\n                    className={cn(\n                        \"w-full flex items-center justify-between bg-secondary/30 border border-border/50 rounded-lg px-4 py-2.5 text-sm transition-[border-color,background-color,ring] duration-200\",\n                        \"hover:bg-secondary/50 hover:border-border/80\",\n                        \"focus:ring-1 focus:ring-primary/40 focus:border-primary/50 outline-none\",\r\n                        isOpen && \"border-primary/50 ring-1 ring-primary/40\"\r\n                    )}\r\n                >\r\n                    <span className={cn(!selectedOption && \"text-foreground/40\")}>\r\n                        {selectedOption ? selectedOption.label : placeholder}\r\n                    </span>\r\n                    <ChevronDown className={cn(\"w-4 h-4 text-foreground/40 transition-transform duration-300\", isOpen && \"rotate-180\")} />\r\n                </button>\r\n\r\n                {isOpen && (\r\n                    <div className=\"absolute top-full left-0 right-0 mt-1 z-[100] bg-popover border border-border rounded-lg shadow-2xl overflow-hidden animate-in fade-in slide-in-from-top-1 duration-200 transition-none\">\r\n                        <div className=\"max-h-60 overflow-y-auto py-1 custom-scrollbar\">\r\n                            {options.length === 0 ? (\r\n                                <div className=\"px-4 py-3 text-sm text-foreground/40 italic\">No options available</div>\r\n                            ) : (\r\n                                options.map((option) => (\r\n                                    <button\r\n                                        key={option.value}\r\n                                        type=\"button\"\r\n                                        onClick={() => {\r\n                                            onChange(option.value)\r\n                                            setIsOpen(false)\r\n                                        }}\r\n                                        className={cn(\r\n                                            \"w-full flex items-center justify-between px-4 py-2 text-sm text-left transition-colors duration-200\",\r\n                                            \"hover:bg-primary/20 hover:text-primary\",\r\n                                            option.value === value ? \"bg-primary text-primary-foreground font-medium\" : \"text-foreground/80 hover:bg-secondary\"\r\n                                        )}\r\n                                    >\r\n                                        {option.label}\r\n                                        {option.value === value && <Check className=\"w-3.5 h-3.5\" />}\r\n                                    </button>\r\n                                ))\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\ui\\Skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\ui\\Table\\DataTable.tsx","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Function 'DataTable' has too many lines (337). Maximum allowed is 80.","line":66,"column":8,"nodeType":"FunctionDeclaration","messageId":"exceed","endLine":438,"endColumn":2},{"ruleId":"complexity","severity":1,"message":"Function 'DataTable' has a complexity of 28. Maximum allowed is 12.","line":66,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":66,"endColumn":61},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":325,"column":64,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":325,"endColumn":105},{"ruleId":"sonarjs/different-types-comparison","severity":1,"message":"Remove this \"===\" check; it will always be false. Did you mean to use \"==\"?","line":331,"column":90,"nodeType":null,"endLine":331,"endColumn":93,"suggestions":[{"desc":"Replace \"===\" with \"==\"","fix":{"range":[13578,13581],"text":"=="}}]},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":368,"column":66,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":368,"endColumn":107}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1776,1779],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1776,1779],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1915,1918],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1915,1918],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n    ChevronUp, ChevronDown, ChevronLeft, ChevronRight,\r\n    Settings, Download, Search, X\r\n} from 'lucide-react'\r\nimport React, { useState, useMemo, useCallback } from 'react'\n\r\nimport { Dropdown } from '../Dropdown'\r\nimport { EmptyState } from '../EmptyState'\r\nimport { Input } from '../Input'\r\nimport { Skeleton } from '../Skeleton'\r\n\r\nexport interface Column<T> {\r\n    key: keyof T | string\r\n    header: string\r\n    width?: number\r\n    minWidth?: number\r\n    sortable?: boolean\r\n    visible?: boolean\r\n    frozen?: boolean\r\n    align?: 'left' | 'center' | 'right'\r\n    render?: (value: unknown, row: T, index: number) => React.ReactNode\r\n}\r\n\r\nexport interface DataTableProps<T extends { id: number | string }> {\r\n    data: T[]\r\n    columns: Column<T>[]\r\n    loading?: boolean\r\n    emptyMessage?: string\r\n    emptyIcon?: React.ReactNode\r\n\r\n    // Selection\r\n    selectable?: boolean\r\n    selectedIds?: Set<number | string>\r\n    onSelectionChange?: (selectedIds: Set<number | string>) => void\r\n\r\n    // Pagination\r\n    paginated?: boolean\r\n    pageSize?: number\r\n    pageSizeOptions?: number[]\r\n    totalCount?: number\r\n    currentPage?: number\r\n    onPageChange?: (page: number) => void\r\n    onPageSizeChange?: (size: number) => void\r\n\r\n    // Sorting\r\n    sortable?: boolean\r\n    defaultSort?: { key: string; direction: 'asc' | 'desc' }\r\n    onSort?: (key: string, direction: 'asc' | 'desc') => void\r\n\r\n    // Actions\r\n    onRowClick?: (row: T) => void\r\n    onExport?: (format: 'csv' | 'excel' | 'pdf') => void\r\n\r\n    // Customization\r\n    rowClassName?: (row: T, index: number) => string\r\n    stickyHeader?: boolean\r\n    compact?: boolean\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nfunction getNestedValue(obj: unknown, path: string): any {\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    return path.split('.').reduce((acc, part) => acc && (acc as any)[part], obj)\r\n}\r\n\r\nexport function DataTable<T extends { id: number | string }>({\n    data,\r\n    columns: initialColumns,\r\n    loading = false,\r\n    emptyMessage = 'No data available',\r\n    emptyIcon,\r\n    selectable = false,\r\n    selectedIds = new Set(),\r\n    onSelectionChange,\r\n    paginated = true,\r\n    pageSize: initialPageSize = 10,\r\n    pageSizeOptions = [10, 25, 50, 100],\r\n    totalCount,\r\n    currentPage = 1,\r\n    onPageChange,\r\n    onPageSizeChange,\r\n    sortable = true,\r\n    defaultSort,\r\n    onSort,\r\n    onRowClick,\r\n    onExport,\r\n    rowClassName,\r\n    stickyHeader = true,\r\n    compact = false,\r\n}: Readonly<DataTableProps<T>>) {\n    // State\r\n    const [columns, setColumns] = useState(initialColumns.map(c => ({ ...c, visible: c.visible !== false })))\r\n    const [sort, setSort] = useState<{ key: string; direction: 'asc' | 'desc' } | null>(defaultSort || null)\r\n    const [pageSize, setPageSize] = useState(initialPageSize)\r\n    const [internalPage, setInternalPage] = useState(currentPage)\r\n    const [searchTerm, setSearchTerm] = useState('')\r\n    const [showColumnSelector, setShowColumnSelector] = useState(false)\r\n\r\n    const page = onPageChange ? currentPage : internalPage\r\n\r\n    // Visible columns\r\n    const visibleColumns = useMemo(() => columns.filter(c => c.visible), [columns])\r\n\r\n    // Sorted and filtered data\r\n    const processedData = useMemo(() => {\r\n        let result = [...data]\r\n\r\n        // Search filter\r\n        if (searchTerm) {\r\n            const term = searchTerm.toLowerCase()\r\n            result = result.filter(row =>\r\n                visibleColumns.some(col => {\r\n                    const value = getNestedValue(row, col.key as string)\r\n                    return String(value ?? '').toLowerCase().includes(term)\r\n                })\r\n            )\r\n        }\r\n\r\n        // Sort\r\n        if (sort && !onSort) {\r\n            result.sort((a, b) => {\r\n                const aVal = getNestedValue(a, sort.key)\r\n                const bVal = getNestedValue(b, sort.key)\r\n\r\n                if (aVal === bVal) {return 0}\r\n                if (aVal === null || aVal === undefined) {return 1}\r\n                if (bVal === null || bVal === undefined) {return -1}\r\n\r\n                const comparison = aVal < bVal ? -1 : 1\r\n                return sort.direction === 'asc' ? comparison : -comparison\r\n            })\r\n        }\r\n\r\n        return result\r\n    }, [data, searchTerm, sort, visibleColumns, onSort])\r\n\r\n    // Pagination\r\n    const totalItems = totalCount ?? processedData.length\r\n    const totalPages = Math.ceil(totalItems / pageSize)\r\n    const paginatedData = useMemo(() => {\r\n        if (!paginated) {return processedData}\r\n        const start = (page - 1) * pageSize\r\n        return processedData.slice(start, start + pageSize)\r\n    }, [processedData, paginated, page, pageSize])\r\n\r\n    // Handlers\r\n    const handleSort = useCallback((key: string) => {\r\n        if (!sortable) {return}\r\n\r\n        const newDirection: 'asc' | 'desc' = sort?.key === key && sort.direction === 'asc' ? 'desc' : 'asc'\n        const newSort: { key: string; direction: 'asc' | 'desc' } = { key, direction: newDirection }\n\r\n        setSort(newSort)\r\n        onSort?.(key, newDirection)\r\n    }, [sort, sortable, onSort])\r\n\r\n    const handleSelectAll = useCallback(() => {\r\n        if (!onSelectionChange) {return}\r\n\r\n        const allSelected = paginatedData.length > 0 && paginatedData.every(row => selectedIds.has(row.id))\r\n\r\n        if (allSelected) {\r\n            const newSelected = new Set(selectedIds)\r\n            paginatedData.forEach(row => newSelected.delete(row.id))\r\n            onSelectionChange(newSelected)\r\n        } else {\r\n            const newSelected = new Set(selectedIds)\r\n            paginatedData.forEach(row => newSelected.add(row.id))\r\n            onSelectionChange(newSelected)\r\n        }\r\n    }, [paginatedData, selectedIds, onSelectionChange])\r\n\r\n    const handleSelectRow = useCallback((id: number | string) => {\r\n        if (!onSelectionChange) {return}\r\n\r\n        const newSelected = new Set(selectedIds)\r\n        if (newSelected.has(id)) {\r\n            newSelected.delete(id)\r\n        } else {\r\n            newSelected.add(id)\r\n        }\r\n        onSelectionChange(newSelected)\r\n    }, [selectedIds, onSelectionChange])\r\n\r\n    const handlePageChange = useCallback((newPage: number) => {\r\n        if (newPage < 1 || newPage > totalPages) {return}\r\n        if (onPageChange) {\r\n            onPageChange(newPage)\r\n        } else {\r\n            setInternalPage(newPage)\r\n        }\r\n    }, [totalPages, onPageChange])\r\n\r\n    const toggleColumnVisibility = useCallback((key: string) => {\r\n        setColumns(prev => prev.map(col =>\r\n            (col.key as string) === key ? { ...col, visible: !col.visible } : col\r\n        ))\r\n    }, [])\r\n\r\n    // Render\r\n    if (loading) {\r\n        return (\r\n            <div className=\"w-full space-y-4\">\r\n                <div className=\"flex justify-between items-center\">\r\n                    <Skeleton className=\"h-10 w-64\" />\r\n                    <Skeleton className=\"h-10 w-32\" />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                    {Array.from({ length: 5 }).map((_, i) => (\r\n                        <Skeleton key={i} className=\"h-12 w-full\" />\r\n                    ))}\r\n                </div>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    if (!data.length && !searchTerm) {\r\n        return (\r\n            <EmptyState\r\n                icon={emptyIcon}\r\n                title={emptyMessage}\r\n                description=\"Try adjusting your filters or add new records.\"\r\n            />\r\n        )\r\n    }\r\n\r\n    const cellPadding = compact ? 'px-3 py-2' : 'px-4 py-4'\r\n    const headerPadding = compact ? 'px-3 py-2' : 'px-4 py-3'\r\n\r\n    return (\r\n        <div className=\"w-full\">\r\n            {/* Toolbar */}\r\n            <div className=\"flex flex-wrap items-center justify-between gap-4 mb-4\">\r\n                <div className=\"relative flex-1 max-w-sm\">\r\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-foreground/40\" />\r\n                    <Input\r\n                        type=\"text\"\r\n                        placeholder=\"Search...\"\r\n                        value={searchTerm}\r\n                        onChange={(e: React.ChangeEvent<HTMLInputElement>) => setSearchTerm(e.target.value)}\r\n                        className=\"pl-10\"\r\n                    />\r\n                    {searchTerm && (\r\n                        <button\r\n                            onClick={() => setSearchTerm('')}\r\n                            className=\"absolute right-3 top-1/2 -translate-y-1/2 p-1 hover:bg-secondary rounded\"\r\n                        >\r\n                            <X className=\"w-4 h-4\" />\r\n                        </button>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-2\">\r\n                    {/* Column selector */}\r\n                    <div className=\"relative\">\r\n                        <button\r\n                            onClick={() => setShowColumnSelector(!showColumnSelector)}\r\n                            className=\"p-2 hover:bg-secondary rounded-lg border border-border/40\"\r\n                            title=\"Toggle columns\"\r\n                        >\r\n                            <Settings className=\"w-4 h-4\" />\r\n                        </button>\r\n\r\n                        {showColumnSelector && (\r\n                            <div className=\"absolute right-0 top-full mt-2 bg-card border border-border/40 rounded-lg shadow-xl z-50 min-w-[200px]\">\r\n                                <div className=\"p-2 border-b border-border/40 text-xs font-bold text-foreground/60 uppercase\">\r\n                                    Visible Columns\r\n                                </div>\r\n                                <div className=\"p-2 space-y-1\">\r\n                                    {columns.map(col => (\r\n                                        <label key={col.key as string} className=\"flex items-center gap-2 px-2 py-1 hover:bg-secondary rounded cursor-pointer text-foreground/80\">\r\n                                            <input\r\n                                                type=\"checkbox\"\r\n                                                checked={col.visible}\r\n                                                onChange={() => toggleColumnVisibility(col.key as string)}\r\n                                                className=\"rounded border-border/40\"\r\n                                            />\r\n                                            <span className=\"text-sm\">{col.header}</span>\r\n                                        </label>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Export */}\r\n                    {onExport && (\r\n                        <Dropdown\r\n                            trigger={\r\n                                <button className=\"p-2 hover:bg-secondary rounded-lg border border-border/40\" title=\"Export\">\r\n                                    <Download className=\"w-4 h-4 text-foreground/80\" />\r\n                                </button>\r\n                            }\r\n                            items={[\r\n                                { label: 'Export as CSV', onClick: () => onExport('csv') },\r\n                                { label: 'Export as Excel', onClick: () => onExport('excel') },\r\n                                { label: 'Export as PDF', onClick: () => onExport('pdf') },\r\n                            ]}\r\n                        />\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Table */}\r\n            <div className=\"overflow-x-auto rounded-xl border border-border/40\">\r\n                <table className=\"w-full\">\r\n                    <thead className={stickyHeader ? 'sticky top-0 z-10' : ''}>\r\n                        <tr className=\"bg-secondary/40 backdrop-blur-sm border-b border-border/40\">\r\n                            {selectable && (\r\n                                <th className={`${headerPadding} w-12`}>\r\n                                    <input\r\n                                        type=\"checkbox\"\r\n                                        checked={paginatedData.length > 0 && paginatedData.every(row => selectedIds.has(row.id))}\r\n                                        onChange={handleSelectAll}\r\n                                        className=\"rounded border-border/20\"\r\n                                    />\r\n                                </th>\r\n                            )}\r\n                            {visibleColumns.map(col => (\r\n                                <th\r\n                                    key={col.key as string}\r\n                                    className={`\r\n                    ${headerPadding} text-left text-[11px] font-bold uppercase tracking-wider text-foreground/50\r\n                    ${col.sortable !== false && sortable ? 'cursor-pointer hover:text-foreground/80 select-none' : ''}\r\n                    ${col.align === 'center' ? 'text-center' : col.align === 'right' ? 'text-right' : ''}\r\n                  `}\r\n                                    onClick={() => col.sortable !== false && handleSort(col.key as string)}\r\n                                >\r\n                                    <div className=\"flex items-center gap-1\">\r\n                                        <span>{col.header}</span>\r\n                                        {col.sortable !== false && sortable && sort?.key === col.key && (\r\n                                            sort.direction === 'asc'\r\n                                                ? <ChevronUp className=\"w-3 h-3\" />\r\n                                                : <ChevronDown className=\"w-3 h-3\" />\r\n                                        )}\r\n                                    </div>\r\n                                </th>\r\n                            ))}\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody className=\"divide-y divide-border/20\">\r\n                        {paginatedData.map((row, i) => (\r\n                            <tr\r\n                                key={row.id}\r\n                                onClick={() => onRowClick?.(row)}\r\n                                className={`\r\n                  transition-colors hover:bg-secondary/40\r\n                  ${onRowClick ? 'cursor-pointer' : ''}\r\n                  ${selectedIds.has(row.id) ? 'bg-primary/5' : ''}\r\n                  ${rowClassName ? rowClassName(row, i) : ''}\r\n                `}\r\n                            >\r\n                                {selectable && (\r\n                                    <td className={cellPadding} onClick={(e) => e.stopPropagation()}>\r\n                                        <input\r\n                                            type=\"checkbox\"\r\n                                            checked={selectedIds.has(row.id)}\r\n                                            onChange={() => handleSelectRow(row.id)}\r\n                                            className=\"rounded border-border/40\"\r\n                                        />\r\n                                    </td>\r\n                                )}\r\n                                {visibleColumns.map(col => (\r\n                                    <td\r\n                                        key={col.key as string}\r\n                                        className={`\r\n                      ${cellPadding} text-sm text-foreground/70\r\n                      ${col.align === 'center' ? 'text-center' : col.align === 'right' ? 'text-right' : ''}\r\n                    `}\r\n                                    >\r\n                                        {col.render\r\n                                            ? col.render(getNestedValue(row, col.key as string), row, i)\r\n                                            : String(getNestedValue(row, col.key as string) ?? '-')\r\n                                        }\r\n                                    </td>\r\n                                ))}\r\n                            </tr>\r\n                        ))}\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n\r\n            {/* Pagination */}\r\n            {paginated && totalPages > 1 && (\r\n                <div className=\"flex items-center justify-between mt-4 text-sm text-foreground/40\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                        <div>\r\n                            Showing {(page - 1) * pageSize + 1} to {Math.min(page * pageSize, totalItems)} of {totalItems} entries\r\n                        </div>\r\n                        <select\r\n                            value={pageSize}\r\n                            onChange={(e) => {\r\n                                const newSize = Number(e.target.value);\r\n                                setPageSize(newSize);\r\n                                onPageSizeChange?.(newSize);\r\n                            }}\r\n                            className=\"bg-transparent border border-border/40 rounded px-2 py-1 outline-none\"\r\n                        >\r\n                            {pageSizeOptions.map(option => (\r\n                                <option key={option} value={option} className=\"bg-secondary\">{option} per page</option>\r\n                            ))}\r\n                        </select>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <button\r\n                            onClick={() => handlePageChange(page - 1)}\r\n                            disabled={page === 1}\r\n                            className=\"p-2 hover:bg-secondary disabled:opacity-30 rounded-lg border border-border/40\"\r\n                        >\r\n                            <ChevronLeft className=\"w-4 h-4\" />\r\n                        </button>\r\n                        <div className=\"flex items-center gap-1\">\r\n                            {Array.from({ length: totalPages }).map((_, i) => (\r\n                                <button\r\n                                    key={i}\r\n                                    onClick={() => handlePageChange(i + 1)}\r\n                                    className={`\r\n                    w-8 h-8 rounded-lg text-xs font-medium transition-all\r\n                    ${page === i + 1 ? 'bg-primary text-primary-foreground shadow-lg' : 'hover:bg-secondary'}\r\n                  `}\r\n                                >\r\n                                    {i + 1}\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n                        <button\r\n                            onClick={() => handlePageChange(page + 1)}\r\n                            disabled={page === totalPages}\r\n                            className=\"p-2 hover:bg-secondary disabled:opacity-30 rounded-lg border border-border/40\"\r\n                        >\r\n                            <ChevronRight className=\"w-4 h-4\" />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\ui\\Toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\components\\ui\\Tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\contexts\\ThemeContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\contexts\\ToastContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\hooks\\useNetworkStatus.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Academic\\AwardsManagement.tsx","messages":[{"ruleId":"sonarjs/prefer-single-boolean-return","severity":1,"message":"Replace this if-then-else flow by a single return statement.","line":198,"column":5,"nodeType":"IfStatement","messageId":"replaceIfThenElseByReturn","endLine":198,"endColumn":91,"suggestions":[{"messageId":"suggest","fix":{"range":[5731,5833],"text":"return !(filterCategory !== 0 && award.award_category_id !== filterCategory);"},"desc":"Replace with single return statement"}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { Plus, Trash2, CheckCircle, Clock, XCircle, X } from 'lucide-react'\nimport { useState, useEffect, useCallback } from 'react'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\nimport { Select } from '../../components/ui/Select'\nimport { useAppStore, useAuthStore } from '../../stores'\n\n// Roles that can approve awards\nconst APPROVER_ROLES = ['ADMIN', 'PRINCIPAL', 'DEPUTY_PRINCIPAL']\n\ninterface StudentAward {\n  id: number\n  student_id: number\n  student_name?: string\n  admission_number: string\n  first_name?: string\n  last_name?: string\n  award_category_id: number\n  category_name: string\n  awarded_date: string\n  approval_status: 'pending' | 'approved' | 'rejected'\n  assigned_by_name?: string\n  approved_by_name?: string\n  approved_at?: string\n  rejection_reason?: string\n  certificate_number?: string\n  remarks?: string\n}\n\ninterface AwardCategory {\n  id: number\n  name: string\n  category_type: string\n  description: string\n}\n\nconst AwardsManagement = () => {\n  const { currentAcademicYear, currentTerm } = useAppStore()\n  const { user } = useAuthStore()\n\n  const [awards, setAwards] = useState<StudentAward[]>([])\n  const [categories, setCategories] = useState<AwardCategory[]>([])\n  const [students, setStudents] = useState<{ id: number; name: string; admission_number: string }[]>([])\n\n  const [selectedStudent, setSelectedStudent] = useState<number>(0)\n  const [selectedCategory, setSelectedCategory] = useState<number>(0)\n  const [filterStatus, setFilterStatus] = useState<string>('all')\n  const [filterCategory, setFilterCategory] = useState<number>(0)\n\n  const [loading, setLoading] = useState(false)\n  const [showForm, setShowForm] = useState(false)\n\n  // Rejection modal state\n  const [showRejectModal, setShowRejectModal] = useState(false)\n  const [rejectingAwardId, setRejectingAwardId] = useState<number | null>(null)\n  const [rejectionReason, setRejectionReason] = useState('')\n\n  // Check if current user can approve\n  const canApprove = user?.role && APPROVER_ROLES.includes(user.role)\n\n  const loadAwards = useCallback(async () => {\n    try {\n      const awardData = await window.electronAPI.getAwards({\n        academicYearId: currentAcademicYear?.id,\n        termId: currentTerm?.id,\n        status: filterStatus !== 'all' ? filterStatus : undefined\n      })\n      setAwards(awardData || [])\n    } catch (error) {\n      console.error('Failed to load awards:', error)\n    }\n  }, [currentAcademicYear, currentTerm, filterStatus])\n\n  const loadInitialData = useCallback(async () => {\n    try {\n      const [categoryData, studentData] = await Promise.all([\n        window.electronAPI.getAwardCategories(),\n        window.electronAPI.getStudents({ stream_id: undefined })\n      ])\n\n      setCategories(categoryData || [])\n      setStudents(studentData.map(s => ({\n        id: s.id,\n        name: s.full_name || `${s.first_name} ${s.last_name}`,\n        admission_number: s.admission_number\n      })) || [])\n    } catch (error) {\n      console.error('Failed to load initial data:', error)\n    }\n  }, [])\n\n  useEffect(() => {\n    void loadInitialData()\n  }, [loadInitialData])\n\n  useEffect(() => {\n    void loadAwards()\n  }, [loadAwards])\n\n  const handleAwardStudent = async () => {\n    if (!selectedStudent || !selectedCategory) {\n      alert('Please select a student and award category')\n      return\n    }\n\n    setLoading(true)\n    try {\n      await window.electronAPI.awardStudent({\n        studentId: selectedStudent,\n        categoryId: selectedCategory,\n        academicYearId: currentAcademicYear!.id,\n        termId: currentTerm?.id,\n        userId: user?.id,\n        userRole: user?.role || '',\n        remarks: ''\n      })\n\n      await loadAwards()\n      setSelectedStudent(0)\n      setSelectedCategory(0)\n      setShowForm(false)\n      alert('Award assigned successfully!')\n    } catch (error) {\n      console.error('Failed to assign award:', error)\n      alert('Failed to assign award')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleApproveAward = async (awardId: number) => {\n    setLoading(true)\n    try {\n      await window.electronAPI.approveAward({\n        awardId,\n        userId: user?.id\n      })\n      await loadAwards()\n      alert('Award approved successfully!')\n    } catch (error) {\n      console.error('Failed to approve award:', error)\n      alert('Failed to approve award')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const openRejectModal = (awardId: number) => {\n    setRejectingAwardId(awardId)\n    setRejectionReason('')\n    setShowRejectModal(true)\n  }\n\n  const handleRejectAward = async () => {\n    if (!rejectionReason.trim()) {\n      alert('Please enter a reason for rejection')\n      return\n    }\n\n    setLoading(true)\n    try {\n      await window.electronAPI.rejectAward({\n        awardId: rejectingAwardId!,\n        userId: user?.id,\n        reason: rejectionReason\n      })\n      await loadAwards()\n      setShowRejectModal(false)\n      setRejectingAwardId(null)\n      setRejectionReason('')\n      alert('Award rejected')\n    } catch (error) {\n      console.error('Failed to reject award:', error)\n      alert('Failed to reject award')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleDeleteAward = async (awardId: number) => {\n    if (!confirm('Are you sure you want to delete this award?')) {return}\n\n    setLoading(true)\n    try {\n      await window.electronAPI.deleteAward({ awardId })\n      setAwards(awards.filter(a => a.id !== awardId))\n      alert('Award deleted successfully!')\n    } catch (error) {\n      console.error('Failed to delete award:', error)\n      alert('Failed to delete award')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const filteredAwards = awards.filter(award => {\n    if (filterCategory !== 0 && award.award_category_id !== filterCategory) {return false}\n    return true\n  })\n\n  const categoryMap = new Map(categories.map(c => [c.id, c]))\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'pending':\n        return (\n          <div className=\"flex items-center gap-1 text-amber-400\">\n            <Clock size={16} />\n            <span className=\"text-xs font-semibold\">Pending</span>\n          </div>\n        )\n      case 'approved':\n        return (\n          <div className=\"flex items-center gap-1 text-green-400\">\n            <CheckCircle size={16} />\n            <span className=\"text-xs font-semibold\">Approved</span>\n          </div>\n        )\n      case 'rejected':\n        return (\n          <div className=\"flex items-center gap-1 text-red-400\">\n            <XCircle size={16} />\n            <span className=\"text-xs font-semibold\">Rejected</span>\n          </div>\n        )\n      default:\n        return null\n    }\n  }\n\n  return (\n    <div className=\"space-y-8 pb-10\">\n      <PageHeader\n        title=\"Awards Management\"\n        subtitle=\"Manage student awards and recognitions\"\n        breadcrumbs={[{ label: 'Academics' }, { label: 'Awards' }]}\n      />\n\n      {/* Award Categories */}\n      <div className=\"premium-card\">\n        <div className=\"flex justify-between items-center mb-6\">\n          <h3 className=\"text-lg font-semibold\">Award Categories</h3>\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          {categories.slice(0, 8).map(cat => (\n            <div key={cat.id} className=\"p-4 rounded-lg bg-white/5 border border-white/10\">\n              <p className=\"font-semibold text-sm\">{cat.name}</p>\n              <p className=\"text-xs text-foreground/60 mt-1\">{cat.category_type.replace(/_/g, ' ')}</p>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      {/* Assign Award */}\n      <div className=\"premium-card\">\n        <div className=\"flex justify-between items-center mb-6\">\n          <h3 className=\"text-lg font-semibold\">Assign Award</h3>\n          <button\n            onClick={() => setShowForm(!showForm)}\n            className=\"btn btn-primary flex items-center gap-2\"\n          >\n            <Plus size={18} />\n            New Award\n          </button>\n        </div>\n\n        {showForm && (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-4 rounded-lg bg-white/5 mb-6\">\n            <Select\n              label=\"Student\"\n              value={selectedStudent}\n              onChange={(val) => setSelectedStudent(Number(val))}\n              options={[\n                { value: 0, label: 'Select student...' },\n                ...students.map(s => ({ value: s.id, label: `${s.name} (${s.admission_number})` }))\n              ]}\n            />\n            <Select\n              label=\"Award Category\"\n              value={selectedCategory}\n              onChange={(val) => setSelectedCategory(Number(val))}\n              options={[\n                { value: 0, label: 'Select category...' },\n                ...categories.map(c => ({ value: c.id, label: c.name }))\n              ]}\n            />\n            <div className=\"flex items-end gap-3\">\n              <button\n                onClick={handleAwardStudent}\n                disabled={loading}\n                className=\"btn btn-primary flex-1\"\n              >\n                {loading ? 'Assigning...' : 'Assign Award'}\n              </button>\n              <button\n                onClick={() => setShowForm(false)}\n                className=\"btn btn-secondary\"\n              >\n                Cancel\n              </button>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Awards List */}\n      <div className=\"premium-card\">\n        <div className=\"flex gap-4 mb-6\">\n          <Select\n            label=\"Status\"\n            value={filterStatus}\n            onChange={(val) => setFilterStatus(val as string)}\n            options={[\n              { value: 'all', label: 'All Status' },\n              { value: 'pending', label: 'Pending Approval' },\n              { value: 'approved', label: 'Approved' },\n              { value: 'rejected', label: 'Rejected' }\n            ]}\n          />\n          <Select\n            label=\"Category\"\n            value={filterCategory}\n            onChange={(val) => setFilterCategory(Number(val))}\n            options={[\n              { value: 0, label: 'All Categories' },\n              ...categories.map(c => ({ value: c.id, label: c.name }))\n            ]}\n          />\n        </div>\n\n        <div className=\"space-y-4\">\n          {filteredAwards.length === 0 ? (\n            <div className=\"text-center py-12 text-foreground/40\">\n              <p>No awards found</p>\n            </div>\n          ) : (\n            filteredAwards.map(award => (\n              <div\n                key={award.id}\n                className={`flex items-center justify-between p-4 rounded-lg border transition ${award.approval_status === 'rejected'\n                  ? 'bg-red-500/5 border-red-500/20'\n                  : 'bg-white/5 border-white/10 hover:bg-white/10'\n                  }`}\n              >\n                <div className=\"flex-1\">\n                  <div className=\"flex items-center gap-3 mb-2\">\n                    <h4 className=\"font-semibold\">\n                      {award.student_name || `${award.first_name} ${award.last_name}`}\n                    </h4>\n                    <span className=\"text-xs px-2 py-1 rounded bg-white/10 text-foreground/60\">\n                      {award.admission_number}\n                    </span>\n                  </div>\n                  <p className=\"text-sm text-foreground/60 mb-2\">\n                    {categoryMap.get(award.award_category_id)?.name || award.category_name}\n                  </p>\n                  <div className=\"flex flex-wrap gap-4 text-xs text-foreground/50\">\n                    <span>Awarded: {award.awarded_date ? new Date(award.awarded_date).toLocaleDateString() : 'N/A'}</span>\n                    {award.assigned_by_name && <span>Assigned by: {award.assigned_by_name}</span>}\n                    {award.approved_by_name && award.approval_status === 'approved' && (\n                      <span className=\"text-green-400\">Approved by: {award.approved_by_name}</span>\n                    )}\n                    {award.approved_by_name && award.approval_status === 'rejected' && (\n                      <span className=\"text-red-400\">Rejected by: {award.approved_by_name}</span>\n                    )}\n                  </div>\n                  {award.rejection_reason && (\n                    <p className=\"text-xs text-red-400 mt-2\">Reason: {award.rejection_reason}</p>\n                  )}\n                </div>\n\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"text-right\">\n                    {getStatusBadge(award.approval_status)}\n                  </div>\n\n                  <div className=\"flex gap-2\">\n                    {award.approval_status === 'pending' && canApprove && (\n                      <>\n                        <button\n                          onClick={() => handleApproveAward(award.id)}\n                          disabled={loading}\n                          className=\"btn btn-sm btn-primary\"\n                        >\n                          Approve\n                        </button>\n                        <button\n                          onClick={() => openRejectModal(award.id)}\n                          disabled={loading}\n                          className=\"btn btn-sm bg-red-500/20 text-red-400 hover:bg-red-500/30\"\n                        >\n                          Reject\n                        </button>\n                      </>\n                    )}\n                    <button\n                      onClick={() => handleDeleteAward(award.id)}\n                      disabled={loading}\n                      className=\"btn btn-sm btn-secondary\"\n                      title=\"Delete award\"\n                    >\n                      <Trash2 size={16} />\n                    </button>\n                  </div>\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n\n      {/* Rejection Modal */}\n      {showRejectModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-background border border-white/10 rounded-lg p-6 w-full max-w-md\">\n            <div className=\"flex justify-between items-center mb-4\">\n              <h3 className=\"text-lg font-semibold\">Reject Award</h3>\n              <button onClick={() => setShowRejectModal(false)} className=\"text-foreground/50 hover:text-foreground\">\n                <X size={20} />\n              </button>\n            </div>\n            <p className=\"text-sm text-foreground/60 mb-4\">\n              Please provide a reason for rejecting this award.\n            </p>\n            <textarea\n              value={rejectionReason}\n              onChange={(e) => setRejectionReason(e.target.value)}\n              placeholder=\"Enter rejection reason...\"\n              className=\"w-full h-24 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm resize-none focus:outline-none focus:border-primary\"\n            />\n            <div className=\"flex justify-end gap-3 mt-4\">\n              <button\n                onClick={() => setShowRejectModal(false)}\n                className=\"btn btn-secondary\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={handleRejectAward}\n                disabled={loading || !rejectionReason.trim()}\n                className=\"btn bg-red-500 text-white hover:bg-red-600\"\n              >\n                {loading ? 'Rejecting...' : 'Reject Award'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n\nexport default AwardsManagement\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Academic\\ExamAnalytics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Academic\\ExamManagement.tsx","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":144,"column":29,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":174,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n    ClipboardList, Plus, Trash2, Save, Loader2, Calendar, LayoutGrid\n} from 'lucide-react'\nimport { useState, useEffect, useCallback } from 'react'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\nimport { useAppStore, useAuthStore } from '../../stores'\n\ninterface Exam {\n    id: number\n    name: string\n    weight?: number\n    is_published?: boolean\n    created_at?: string\n}\n\nexport default function ExamManagement() {\n    const { currentAcademicYear, currentTerm } = useAppStore()\n    const { user } = useAuthStore()\n\n    const [exams, setExams] = useState<Exam[]>([])\n    const [loading, setLoading] = useState(false)\n    const [saving, setSaving] = useState(false)\n\n    const [newExamName, setNewExamName] = useState('')\n    const [newExamWeight, setNewExamWeight] = useState(1.0)\n\n    const loadExams = useCallback(async () => {\n        if (!currentAcademicYear || !currentTerm) {return}\n        setLoading(true)\n        try {\n            const data = await window.electronAPI.getAcademicExams(currentAcademicYear.id, currentTerm.id)\n            setExams(data)\n        } catch (error) {\n            console.error('Failed to load exams:', error)\n        } finally {\n            setLoading(false)\n        }\n    }, [currentAcademicYear, currentTerm])\n\n    useEffect(() => {\n        void loadExams()\n    }, [loadExams])\n\n    const handleCreate = async () => {\n        if (!currentAcademicYear || !currentTerm || !user || !newExamName) {return}\n\n        setSaving(true)\n        try {\n            await window.electronAPI.createAcademicExam({\n                academic_year_id: currentAcademicYear.id,\n                term_id: currentTerm.id,\n                name: newExamName,\n                weight: Number(newExamWeight)\n            }, user.id)\n\n            setNewExamName('')\n            setNewExamWeight(1.0)\n            await loadExams()\n        } catch (error) {\n            console.error('Failed to create exam:', error)\n            alert('Failed to create exam')\n        } finally {\n            setSaving(false)\n        }\n    }\n\n    const handleDelete = async (id: number) => {\n        if (!user || !confirm('Are you sure you want to delete this exam? All results for this exam will be removed.')) {return}\n\n        try {\n            await window.electronAPI.deleteAcademicExam(id, user.id)\n            await loadExams()\n        } catch (error) {\n            console.error('Failed to delete exam:', error)\n            alert('Failed to delete exam')\n        }\n    }\n\n    return (\n        <div className=\"space-y-8 pb-10\">\n            <PageHeader\n                title=\"Exam Management\"\n                subtitle=\"Create and manage examination instances for the current term\"\n                breadcrumbs={[{ label: 'Academics' }, { label: 'Exams' }]}\n            />\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n                {/* Create Exam Form */}\n                <div className=\"lg:col-span-1\">\n                    <div className=\"premium-card space-y-4\">\n                        <h3 className=\"text-lg font-bold text-foreground flex items-center gap-2\">\n                            <Plus className=\"w-5 h-5 text-primary\" />\n                            Create New Exam\n                        </h3>\n\n                        <div className=\"space-y-4\">\n                            <div className=\"space-y-2\">\n                                <label htmlFor=\"field-99\" className=\"text-sm font-bold text-foreground/60\">Exam Name</label>\n                                <input id=\"field-99\"\n                                    type=\"text\"\n                                    value={newExamName}\n                                    onChange={(e) => setNewExamName(e.target.value)}\n                                    placeholder=\"e.g. Mid-Term Assessment\"\n                                    className=\"input bg-secondary/30 border-border/20 py-2.5 focus:border-primary/50 transition-all\"\n                                />\n                            </div>\n\n                            <div className=\"space-y-2\">\n                                <label htmlFor=\"field-110\" className=\"text-sm font-bold text-foreground/60\">weight (e.g. 0.3 for 30%)</label>\n                                <input id=\"field-110\"\n                                    type=\"number\"\n                                    step=\"0.1\"\n                                    value={newExamWeight}\n                                    onChange={(e) => setNewExamWeight(Number(e.target.value))}\n                                    className=\"input bg-secondary/30 border-border/20 py-2.5 focus:border-primary/50 transition-all font-mono\"\n                                />\n                            </div>\n\n                            <button\n                                onClick={handleCreate}\n                                disabled={saving || !newExamName}\n                                className=\"w-full btn btn-primary flex items-center justify-center gap-2 py-3\"\n                            >\n                                {saving ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Save className=\"w-4 h-4\" />}\n                                Create Exam\n                            </button>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Exams List */}\n                <div className=\"lg:col-span-2\">\n                    <div className=\"premium-card\">\n                        <h3 className=\"text-lg font-bold text-foreground mb-6 flex items-center gap-2\">\n                            <ClipboardList className=\"w-5 h-5 text-primary\" />\n                            Registered Exams\n                        </h3>\n\n                        {loading ? (\n                            <div className=\"flex items-center justify-center h-64\">\n                                <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n                            </div>\n                        ) : exams.length === 0 ? (\n                            <div className=\"flex flex-col items-center justify-center h-64 text-foreground/40 space-y-3\">\n                                <Calendar className=\"w-12 h-12 opacity-20\" />\n                                <p>No exams created for this term yet</p>\n                            </div>\n                        ) : (\n                            <div className=\"space-y-4\">\n                                {exams.map(exam => (\n                                    <div key={exam.id} className=\"flex items-center justify-between p-4 bg-secondary/20 rounded-xl border border-border/20 hover:border-primary/30 transition-all group\">\n                                        <div className=\"flex items-center gap-4\">\n                                            <div className=\"w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary\">\n                                                <LayoutGrid className=\"w-5 h-5\" />\n                                            </div>\n                                            <div>\n                                                <p className=\"font-bold text-foreground\">{exam.name}</p>\n                                                <p className=\"text-xs text-foreground/40\">Weight: {exam.weight}  Created: {exam.created_at ? new Date(exam.created_at).toLocaleDateString() : 'N/A'}</p>\n                                            </div>\n                                        </div>\n\n                                        <div className=\"flex items-center gap-2\">\n                                            <button\n                                                onClick={() => handleDelete(exam.id)}\n                                                className=\"p-2 text-foreground/30 hover:text-destructive transition-colors rounded-lg hover:bg-destructive/10\"\n                                            >\n                                                <Trash2 className=\"w-4 h-4\" />\n                                            </button>\n                                        </div>\n                                    </div>\n                                ))}\n                            </div>\n                        )}\n                    </div>\n                </div>\n            </div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Academic\\ExamScheduler.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Academic\\MarksEntry.tsx","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":214,"column":21,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":284,"endColumn":18},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":218,"column":21,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":284,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n    Save, Loader2, Search, AlertCircle, TrendingUp\n} from 'lucide-react'\nimport React, { useState, useEffect, useCallback } from 'react'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\nimport { Select } from '../../components/ui/Select'\nimport { Tooltip } from '../../components/ui/Tooltip'\nimport { useAppStore, useAuthStore } from '../../stores'\n\ninterface Exam {\n    id: number\n    name: string\n}\n\ninterface Allocation {\n    id: number\n    subject_id: number\n    stream_id: number\n    subject_name: string\n    stream_name: string\n    curriculum: string\n}\n\ninterface StudentResult {\n    student_id: number\n    student_name: string\n    admission_number: string\n    score: number | null\n    competency_level: number | null\n    teacher_remarks: string\n    [key: string]: unknown\n}\n\nexport default function MarksEntry() {\n    const { currentAcademicYear, currentTerm } = useAppStore()\n    const { user } = useAuthStore()\n\n    const [exams, setExams] = useState<Exam[]>([])\n    const [allocations, setAllocations] = useState<Allocation[]>([])\n    const [results, setResults] = useState<StudentResult[]>([])\n\n    const [selectedExam, setSelectedExam] = useState<number>(0)\n    const [selectedAllocation, setSelectedAllocation] = useState<number>(0)\n\n    const [loading, setLoading] = useState(false)\n    const [saving, setSaving] = useState(false)\n    const [processing, setProcessing] = useState(false)\n\n    const loadInitialData = useCallback(async () => {\n        if (!currentAcademicYear || !currentTerm || !user) {return}\n        try {\n            const [examsData, allocationsData] = await Promise.all([\n                window.electronAPI.getAcademicExams(currentAcademicYear.id, currentTerm.id),\n                window.electronAPI.getTeacherAllocations(currentAcademicYear.id, currentTerm.id)\n            ])\n\n            setExams(examsData)\n            setAllocations(allocationsData.map((a) => ({\n                id: a.id,\n                subject_id: a.subject_id,\n                stream_id: a.stream_id,\n                subject_name: a.subject_name || 'Unknown Subject',\n                stream_name: a.stream_name || 'Unknown Stream',\n                curriculum: a.curriculum || 'KCSE'\n            })))\n        } catch (error) {\n            console.error('Failed to load marks entry data:', error)\n        }\n    }, [currentAcademicYear, currentTerm, user])\n\n    const loadResults = useCallback(async () => {\n        const alloc = allocations.find((a: Allocation) => a.id === selectedAllocation)\n        if (!selectedExam || !alloc) {return}\n\n        setLoading(true)\n        try {\n            const data = await window.electronAPI.getAcademicResults(\n                selectedExam, alloc.subject_id, alloc.stream_id, user!.id\n            )\n            setResults(data.map((r) => ({\n                student_id: r.student_id,\n                student_name: r.student_name || 'Unknown Student',\n                admission_number: r.admission_number || '',\n                score: r.score,\n                competency_level: r.competency_level,\n                teacher_remarks: r.teacher_remarks || ''\n            })))\n        } catch (error) {\n            console.error('Failed to load results:', error)\n        } finally {\n            setLoading(false)\n        }\n    }, [allocations, selectedAllocation, selectedExam, user])\n\n    useEffect(() => {\n        if (currentAcademicYear && currentTerm) {\n            void loadInitialData()\n        }\n    }, [loadInitialData, currentAcademicYear, currentTerm])\n\n    useEffect(() => {\n        if (selectedExam && selectedAllocation) {\n            void loadResults()\n        }\n    }, [selectedExam, selectedAllocation, loadResults])\n\n    const handleScoreChange = (studentId: number, field: keyof StudentResult, value: unknown) => {\n        setResults(prev => prev.map(r =>\n            r.student_id === studentId ? { ...r, [field]: value } : r\n        ))\n    }\n\n    const handleSave = async () => {\n        if (!selectedExam || !user) {return}\n\n        setSaving(true)\n        try {\n            await window.electronAPI.saveAcademicResults(selectedExam, results, user.id)\n            alert('Results saved successfully!')\n        } catch (error) {\n            console.error('Failed to save results:', error)\n            alert('Failed to save results')\n        } finally {\n            setSaving(false)\n        }\n    }\n\n    const handleProcessResults = async () => {\n        if (!selectedExam || !user) {return}\n        if (!confirm('This will calculate ranks and averages for the entire school for this exam. Proceed?')) {return}\n\n        setProcessing(true)\n        try {\n            await window.electronAPI.processAcademicResults(selectedExam, user.id)\n            alert('Results processed successfully! Ranks have been updated.')\n        } catch (error) {\n            console.error('Failed to process results:', error)\n            alert('Failed to process results')\n        } finally {\n            setProcessing(false)\n        }\n    }\n\n    const selectedAlloc = allocations.find((a: Allocation) => a.id === selectedAllocation)\n    const isCBC = selectedAlloc?.curriculum === 'CBC' || selectedAlloc?.curriculum === 'ECDE'\n\n    return (\n        <div className=\"space-y-8 pb-10\">\n            <PageHeader\n                title=\"Marks Entry\"\n                subtitle=\"Enter and manage student performance records\"\n                breadcrumbs={[{ label: 'Academics' }, { label: 'Marks Entry' }]}\n                actions={\n                    <div className=\"flex gap-3\">\n                        <Tooltip content=\"Calculate and update global rankings, averages, and mean grades for all students in this exam.\">\n                            <button\n                                onClick={handleProcessResults}\n                                disabled={processing || !selectedExam}\n                                className=\"btn bg-amber-600 hover:bg-amber-700 text-white flex items-center gap-2\"\n                            >\n                                {processing ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <TrendingUp className=\"w-4 h-4\" />}\n                                Process Ranks\n                            </button>\n                        </Tooltip>\n                        <button\n                            onClick={handleSave}\n                            disabled={saving || results.length === 0}\n                            className=\"btn btn-primary flex items-center gap-2\"\n                        >\n                            {saving ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Save className=\"w-4 h-4\" />}\n                            Save Results\n                        </button>\n                    </div>\n                }\n            />\n\n            {/* Filters */}\n            <div className=\"premium-card\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n                    <Select\n                        label=\"Exam\"\n                        value={selectedExam}\n                        onChange={(val) => setSelectedExam(Number(val))}\n                        options={[\n                            { value: 0, label: 'Select exam...' },\n                            ...exams.map((e: Exam) => ({ value: e.id, label: e.name }))\n                        ]}\n                    />\n\n                    <Select\n                        label=\"Allocated Subject / Class\"\n                        value={selectedAllocation}\n                        onChange={(val) => setSelectedAllocation(Number(val))}\n                        options={[\n                            { value: 0, label: 'Select subject & class...' },\n                            ...allocations.map((a: Allocation) => ({\n                                value: a.id,\n                                label: `${a.subject_name}  ${a.stream_name} (${a.curriculum})`\n                            }))\n                        ]}\n                        className=\"lg:col-span-2\"\n                    />\n                </div>\n            </div>\n\n            {/* Results Grid */}\n            <div className=\"premium-card min-h-[400px]\">\n                {!selectedExam || !selectedAllocation ? (\n                    <div className=\"flex flex-col items-center justify-center h-64 text-foreground/40 space-y-3\">\n                        <Search className=\"w-12 h-12 opacity-20\" />\n                        <p>Select an exam and your allocated subject to begin</p>\n                    </div>\n                ) : loading ? (\n                    <div className=\"flex items-center justify-center h-64 text-foreground/40\">\n                        <Loader2 className=\"w-8 h-8 animate-spin\" />\n                    </div>\n                ) : results.length === 0 ? (\n                    <div className=\"flex flex-col items-center justify-center h-64 text-foreground/40 space-y-3 font-semibold\">\n                        <AlertCircle className=\"w-12 h-12 text-amber-500 opacity-50\" />\n                        <p>No students found for the selected class.</p>\n                    </div>\n                ) : (\n                    <div className=\"overflow-x-auto\">\n                        <table className=\"w-full text-left border-collapse\">\n                            <thead>\n                                <tr className=\"border-b border-white/10\">\n                                    <th className=\"pb-4 pt-2 font-bold text-foreground/60 w-1/4\">Student</th>\n                                    <th className=\"pb-4 pt-2 font-bold text-foreground/60 w-1/4\">\n                                        {isCBC ? 'Competency Level' : 'Score (0-100)'}\n                                    </th>\n                                    <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Teacher Remarks</th>\n                                </tr>\n                            </thead>\n                            <tbody className=\"divide-y divide-white/5\">\n                                {results.map((row: StudentResult) => (\n                                    <tr key={row.student_id} className=\"group hover:bg-white/[0.02] transition-colors\">\n                                        <td className=\"py-4 pr-4\">\n                                            <p className=\"font-bold text-white\">{row.student_name}</p>\n                                            <p className=\"text-xs text-foreground/40 font-mono tracking-tighter uppercase\">{row.admission_number}</p>\n                                        </td>\n                                        <td className=\"py-4 pr-4\">\n                                            {isCBC ? (\n                                                <Select aria-label=\"Selection\"\n                                                    value={row.competency_level || 0}\n                                                    onChange={(val) => handleScoreChange(row.student_id, 'competency_level', Number(val))}\n                                                    options={[\n                                                        { value: 0, label: 'Select Level...' },\n                                                        { value: 4, label: '4 - Exceeding Expectations' },\n                                                        { value: 3, label: '3 - Meeting Expectations' },\n                                                        { value: 2, label: '2 - Approaching Expectations' },\n                                                        { value: 1, label: '1 - Below Expectations' }\n                                                    ]}\n                                                    className=\"w-full\"\n                                                />\n                                            ) : (\n                                                <div className=\"relative\">\n                                                    <input\n                                                        type=\"number\"\n                                                        min=\"0\"\n                                                        max=\"100\"\n                                                        value={row.score === null ? '' : row.score}\n                                                        onChange={(e: React.ChangeEvent<HTMLInputElement>) => handleScoreChange(row.student_id, 'score', e.target.value === '' ? null : Number(e.target.value))}\n                                                        className=\"w-full bg-sidebar border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary/50 text-sm text-center\"\n                                                        placeholder=\"0-100\"\n                                                    />\n                                                </div>\n                                            )}\n                                        </td>\n                                        <td className=\"py-4\">\n                                            <input\n                                                type=\"text\"\n                                                value={row.teacher_remarks || ''}\n                                                onChange={(e: React.ChangeEvent<HTMLInputElement>) => handleScoreChange(row.student_id, 'teacher_remarks', e.target.value)}\n                                                className=\"w-full bg-sidebar border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary/50 text-sm\"\n                                                placeholder=\"e.g. Excellent work, keep it up\"\n                                            />\n                                        </td>\n                                    </tr>\n                                ))}\n                            </tbody>\n                        </table>\n                    </div>\n                )}\n            </div>\n        </div>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Academic\\MeritLists.tsx","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":221,"column":13,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":270,"endColumn":10},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":256,"column":29,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":258,"endColumn":74},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":257,"column":31,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":258,"endColumn":74},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":258,"column":33,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":258,"endColumn":74}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Download, Printer, FileText } from 'lucide-react';\nimport { useState, useEffect } from 'react';\n\nimport { PageHeader } from '../../components/patterns/PageHeader';\nimport { Select } from '../../components/ui/Select';\nimport { useAppStore } from '../../stores';\nimport { exportToPDF } from '../../utils/exporters';\nimport { printCurrentView } from '../../utils/print';\n\ninterface MeritListItem {\n  position: number;\n  admission_number: string;\n  student_name: string;\n  total_marks: number;\n  average_marks: number;\n  grade: string;\n  percentage?: number;\n}\n\nconst MeritLists = () => {\n  const { currentAcademicYear, currentTerm } = useAppStore();\n\n  const [streams, setStreams] = useState<{ id: number; stream_name: string }[]>([]);\n  const [meritList, setMeritList] = useState<MeritListItem[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [exporting, setExporting] = useState(false);\n\n  const [selectedStream, setSelectedStream] = useState<number>(0);\n\n  useEffect(() => {\n    void loadInitialData();\n  }, []);\n\n  const loadInitialData = async () => {\n    try {\n      const streamsData = await window.electronAPI.getStreams();\n      setStreams(streamsData);\n    } catch (error) {\n      console.error('Failed to load initial data:', error);\n    }\n  };\n\n  const handleGenerate = async () => {\n    if (!currentAcademicYear || !currentTerm || !selectedStream) {\n      alert('Please select an academic year, term, and stream.');\n      return;\n    }\n\n    setLoading(true);\n    try {\n      const list = await window.electronAPI.generateMeritList({\n        academicYearId: currentAcademicYear.id,\n        termId: currentTerm.id,\n        streamId: selectedStream,\n      });\n      setMeritList(list);\n    } catch (error) {\n      console.error('Failed to generate merit list:', error);\n      alert('Failed to generate merit list.');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleExportPDF = async () => {\n    if (meritList.length === 0) {\n      alert('Please generate a merit list first');\n      return;\n    }\n\n    setExporting(true);\n    try {\n      const streamName = streams.find(s => s.id === selectedStream)?.stream_name || 'Class';\n      await exportToPDF({\n        filename: `Merit_List_${streamName}_${currentTerm?.term_name}`,\n        title: `Merit List - ${streamName}`,\n        subtitle: `Academic Year: ${currentAcademicYear?.year_name} | Term: ${currentTerm?.term_name}`,\n        columns: [\n          { key: 'position', header: 'Position', width: 20 },\n          { key: 'admission_number', header: 'Adm No', width: 30 },\n          { key: 'student_name', header: 'Student Name', width: 60 },\n          { key: 'total_marks', header: 'Total Marks', width: 30, align: 'right' },\n          { key: 'average_marks', header: 'Average', width: 30, align: 'right' },\n          { key: 'grade', header: 'Grade', width: 20, align: 'center' }\n        ],\n        data: meritList.map((row) => ({\n          position: row.position,\n          admission_number: row.admission_number,\n          student_name: row.student_name,\n          total_marks: row.total_marks,\n          average_marks: row.average_marks.toFixed(2),\n          grade: row.grade\n        }))\n      });\n    } catch (error) {\n      console.error('Failed to export PDF:', error);\n      alert('Failed to export PDF');\n    } finally {\n      setExporting(false);\n    }\n  };\n\n  const handleExportExcel = async () => {\n    if (meritList.length === 0) {\n      alert('Please generate a merit list first');\n      return;\n    }\n\n    setExporting(true);\n    try {\n      const csvContent = [\n        ['Position', 'Admission No', 'Student Name', 'Total Marks', 'Average', 'Grade'],\n        ...meritList.map(item => [\n          item.position,\n          item.admission_number,\n          item.student_name,\n          item.total_marks,\n          item.average_marks.toFixed(2),\n          item.grade\n        ])\n      ].map(row => row.join(',')).join('\\n');\n\n      const blob = new Blob([csvContent], { type: 'text/csv' });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `Merit_List_${currentTerm?.term_name}.csv`;\n      a.click();\n    } catch (error) {\n      console.error('Failed to export Excel:', error);\n      alert('Failed to export CSV');\n    } finally {\n      setExporting(false);\n    }\n  };\n\n  const handlePrint = () => {\n    if (meritList.length === 0) {\n      alert('Please generate a merit list first');\n      return;\n    }\n    printCurrentView({\n      title: `Merit List - ${getStreamName()}`,\n      selector: '#merit-list-print-area'\n    });\n  };\n\n  const getStreamName = () => {\n    return streams.find(s => s.id === selectedStream)?.stream_name || 'All Streams';\n  };\n\n  return (\n    <div className=\"space-y-8 pb-10\">\n      <PageHeader\n        title=\"Merit Lists\"\n        subtitle=\"Generate and view student rankings for a class\"\n        breadcrumbs={[{ label: 'Academics' }, { label: 'Merit Lists' }]}\n      />\n\n      <div className=\"premium-card\">\n        <div className=\"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6\">\n          <Select\n            label=\"Stream\"\n            value={selectedStream}\n            onChange={(val) => setSelectedStream(Number(val))}\n            options={[\n              { value: 0, label: 'Select stream...' },\n              ...streams.map((s) => ({ value: s.id, label: s.stream_name })),\n            ]}\n          />\n          <div className=\"md:col-span-2 lg:col-span-3 flex items-end gap-3\">\n            <button\n              onClick={handleGenerate}\n              disabled={loading}\n              className=\"btn btn-primary flex-1\"\n            >\n              {loading ? 'Generating...' : 'Generate Merit List'}\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {meritList.length > 0 && (\n        <div className=\"premium-card\">\n          <div className=\"flex gap-3 pb-4 border-b border-white/10\">\n            <button\n              onClick={handleExportPDF}\n              disabled={exporting}\n              className=\"btn btn-secondary flex items-center gap-2\"\n              title=\"Export as PDF\"\n            >\n              <FileText size={18} />\n              Export PDF\n            </button>\n            <button\n              onClick={handleExportExcel}\n              disabled={exporting}\n              className=\"btn btn-secondary flex items-center gap-2\"\n              title=\"Export as CSV/Excel\"\n            >\n              <Download size={18} />\n              Export CSV\n            </button>\n            <button\n              onClick={handlePrint}\n              className=\"btn btn-secondary flex items-center gap-2\"\n              title=\"Print\"\n            >\n              <Printer size={18} />\n              Print\n            </button>\n          </div>\n        </div>\n      )}\n\n      <div id=\"merit-list-print-area\" className=\"premium-card min-h-[400px]\">\n        {loading ? (\n          <div className=\"flex items-center justify-center h-64 text-foreground/40\">\n            <p>Loading...</p>\n          </div>\n        ) : meritList.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center h-64 text-foreground/40\">\n            <p>No merit list generated yet. Select a stream and click \"Generate Merit List\".</p>\n          </div>\n        ) : (\n          <div>\n            <div className=\"mb-4 print:text-black\">\n              <h2 className=\"text-xl font-bold mb-2\">Merit List - {getStreamName()}</h2>\n              <p className=\"text-sm text-foreground/60\">\n                Academic Year: {currentAcademicYear?.year_name} | Term: {currentTerm?.term_name}\n              </p>\n            </div>\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full text-left border-collapse print:text-black\">\n                <thead>\n                  <tr className=\"border-b border-white/10 print:border-black\">\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60 print:text-black\">Position</th>\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60 print:text-black\">Adm No.</th>\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60 print:text-black\">Name</th>\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60 print:text-black\">Total Marks</th>\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60 print:text-black\">Average</th>\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60 print:text-black\">Grade</th>\n                  </tr>\n                </thead>\n                <tbody className=\"divide-y divide-white/5 print:divide-black\">\n                  {meritList.map((row) => (\n                    <tr key={row.admission_number} className=\"group hover:bg-white/[0.02] transition-colors print:hover:bg-white\">\n                      <td className=\"py-4 pr-4 print:text-black\">{row.position}</td>\n                      <td className=\"py-4 pr-4 print:text-black\">{row.admission_number}</td>\n                      <td className=\"py-4 pr-4 print:text-black\">{row.student_name}</td>\n                      <td className=\"py-4 pr-4 print:text-black\">{row.total_marks}</td>\n                      <td className=\"py-4 pr-4 print:text-black\">{row.average_marks.toFixed(2)}</td>\n                      <td className=\"py-4 pr-4 print:text-black\">\n                        <span className=\"px-2 py-1 rounded text-sm font-semibold\" style={{\n                          backgroundColor: row.grade === 'A' || row.grade === 'A-' ? '#10b981' :\n                            row.grade === 'B+' || row.grade === 'B' ? '#3b82f6' :\n                              row.grade === 'B-' || row.grade === 'C+' ? '#f59e0b' :\n                                row.grade === 'C' ? '#ef4444' : '#6b7280',\n                          color: 'white'\n                        }}>\n                          {row.grade}\n                        </span>\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default MeritLists;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Academic\\MostImproved.tsx","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":276,"column":13,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":327,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { Download, Mail, Award } from 'lucide-react'\nimport { useState, useCallback, useEffect } from 'react'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\nimport { Select } from '../../components/ui/Select'\nimport { useAppStore, useAuthStore } from '../../stores'\n\ninterface ImprovedStudent {\n  student_id: number\n  admission_number: string\n  student_name: string\n  previous_term_average: number\n  current_term_average: number\n  improvement_percentage: number\n  improvement_points: number\n  grade_improvement: string\n  subjects_improved: number\n  subjects_declined: number\n}\n\nconst MostImproved = () => {\n  const { currentAcademicYear, currentTerm } = useAppStore()\n  const { user } = useAuthStore()\n\n  const [terms, setTerms] = useState<{ id: number; name: string }[]>([])\n  const [streams, setStreams] = useState<{ id: number; stream_name: string }[]>([])\n\n  const [selectedCurrentTerm, setSelectedCurrentTerm] = useState<number>(0)\n  const [selectedComparisonTerm, setSelectedComparisonTerm] = useState<number>(0)\n  const [selectedStream, setSelectedStream] = useState<number>(0)\n  const [minimumImprovement, setMinimumImprovement] = useState<number>(5)\n\n  const [improvedStudents, setImprovedStudents] = useState<ImprovedStudent[]>([])\n  const [loading, setLoading] = useState(false)\n  const [selectedAward, setSelectedAward] = useState<string>('most_improved')\n\n  const awardCategories = [\n    { value: 'most_improved', label: 'Most Improved Overall' },\n    { value: 'comeback', label: 'Comeback Student (E to A)' },\n    { value: 'subject_improvement', label: 'Subject Excellence' },\n    { value: 'consistent_improver', label: 'Consistent Improver' }\n  ]\n\n  const loadInitialData = useCallback(async () => {\n    try {\n      if (currentAcademicYear) {\n        const [termsData, streamsData] = await Promise.all([\n          window.electronAPI.getTermsByYear(currentAcademicYear.id),\n          window.electronAPI.getStreams()\n        ])\n\n        setTerms(termsData?.map(t => ({ id: t.id, name: t.term_name })) || [])\n        setStreams(streamsData || [])\n\n        // Auto-select current term as comparison and previous term\n        if (currentTerm && termsData && termsData.length > 0) {\n          setSelectedCurrentTerm(currentTerm.id)\n          const previousTerm = termsData.find(t => t.id !== currentTerm.id)\n          if (previousTerm) {\n            setSelectedComparisonTerm(previousTerm.id)\n          }\n        }\n      }\n    } catch (error) {\n      console.error('Failed to load initial data:', error)\n    }\n  }, [currentAcademicYear, currentTerm])\n\n  useEffect(() => {\n    void loadInitialData()\n  }, [loadInitialData])\n\n  const handleGenerateMostImproved = async () => {\n    if (!selectedCurrentTerm || !selectedComparisonTerm) {\n      alert('Please select both current and comparison terms')\n      return\n    }\n\n    setLoading(true)\n    try {\n      const students = await window.electronAPI.getMostImprovedStudents({\n        academicYearId: currentAcademicYear!.id,\n        currentTermId: selectedCurrentTerm,\n        comparisonTermId: selectedComparisonTerm,\n        streamId: selectedStream || undefined,\n        minimumImprovement\n      })\n\n      setImprovedStudents(students || [])\n    } catch (error) {\n      console.error('Failed to get most improved students:', error)\n      alert('Failed to generate list')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleAwardCertificates = async () => {\n    if (improvedStudents.length === 0) {\n      alert('Please generate a list first')\n      return\n    }\n\n    try {\n      // Generate certificates for selected students\n      await Promise.all(\n        improvedStudents.map(student =>\n          window.electronAPI.generateCertificate({\n            studentId: student.student_id,\n            studentName: student.student_name,\n            awardCategory: selectedAward,\n            academicYearId: currentAcademicYear!.id,\n            improvementPercentage: student.improvement_percentage\n          })\n        )\n      )\n      alert(`${improvedStudents.length} certificates generated successfully!`)\n    } catch (error) {\n      console.error('Failed to generate certificates:', error)\n      alert('Failed to generate certificates')\n    }\n  }\n\n  const handleEmailParents = async () => {\n    if (improvedStudents.length === 0) {\n      alert('Please generate a list first')\n      return\n    }\n\n    try {\n      if (!user?.id) {\n        alert('Please sign in again to send emails.')\n        return\n      }\n      await window.electronAPI.emailParents({\n        students: improvedStudents,\n        awardCategory: selectedAward,\n        templateType: 'improvement_award'\n      }, user.id)\n      alert(`Emails sent to ${improvedStudents.length} parents!`)\n    } catch (error) {\n      console.error('Failed to send emails:', error)\n      alert('Failed to send emails')\n    }\n  }\n\n  const handleExportList = () => {\n    if (improvedStudents.length === 0) {\n      alert('Please generate a list first')\n      return\n    }\n\n    const csvContent = [\n      ['Position', 'Admission No', 'Student Name', 'Previous Average', 'Current Average', 'Improvement %', 'Improvement Points', 'Grade Change'],\n      ...improvedStudents.map((item, index) => [\n        index + 1,\n        item.admission_number,\n        item.student_name,\n        item.previous_term_average.toFixed(2),\n        item.current_term_average.toFixed(2),\n        item.improvement_percentage.toFixed(2),\n        item.improvement_points.toFixed(2),\n        item.grade_improvement\n      ])\n    ].map(row => row.join(',')).join('\\n')\n\n    const blob = new Blob([csvContent], { type: 'text/csv' })\n    const url = URL.createObjectURL(blob)\n    const a = document.createElement('a')\n    a.href = url\n    a.download = `Most_Improved_Students.csv`\n    a.click()\n  }\n\n  return (\n    <div className=\"space-y-8 pb-10\">\n      <PageHeader\n        title=\"Most Improved Students\"\n        subtitle=\"Identify and award students with exceptional improvement\"\n        breadcrumbs={[{ label: 'Academics' }, { label: 'Most Improved' }]}\n      />\n\n      <div className=\"premium-card\">\n        <h3 className=\"text-lg font-semibold mb-6\">Selection Criteria</h3>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6\">\n          <Select\n            label=\"Current Term\"\n            value={selectedCurrentTerm}\n            onChange={(val) => setSelectedCurrentTerm(Number(val))}\n            options={[\n              { value: 0, label: 'Select term...' },\n              ...terms.map((t) => ({ value: t.id, label: t.name }))\n            ]}\n          />\n          <Select\n            label=\"Comparison Term\"\n            value={selectedComparisonTerm}\n            onChange={(val) => setSelectedComparisonTerm(Number(val))}\n            options={[\n              { value: 0, label: 'Select term...' },\n              ...terms.map((t) => ({ value: t.id, label: t.name }))\n            ]}\n          />\n          <Select\n            label=\"Stream\"\n            value={selectedStream}\n            onChange={(val) => setSelectedStream(Number(val))}\n            options={[\n              { value: 0, label: 'All Streams' },\n              ...streams.map((s) => ({ value: s.id, label: s.stream_name }))\n            ]}\n          />\n          <div>\n            <label htmlFor=\"field-215\" className=\"block text-sm font-medium mb-2\">Min. Improvement (%)</label>\n            <input id=\"field-215\"\n              type=\"number\"\n              value={minimumImprovement}\n              onChange={(e) => setMinimumImprovement(Number(e.target.value))}\n              className=\"w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10\"\n              min=\"0\"\n              max=\"100\"\n            />\n          </div>\n        </div>\n\n        <button\n          onClick={handleGenerateMostImproved}\n          disabled={loading}\n          className=\"btn btn-primary\"\n        >\n          {loading ? 'Analyzing...' : 'Identify Most Improved'}\n        </button>\n      </div>\n\n      {improvedStudents.length > 0 && (\n        <div className=\"premium-card\">\n          <h3 className=\"text-lg font-semibold mb-6\">Award Actions</h3>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            <Select\n              label=\"Award Category\"\n              value={selectedAward}\n              onChange={(val) => setSelectedAward(String(val))}\n              options={awardCategories}\n            />\n            <button\n              onClick={handleAwardCertificates}\n              className=\"btn btn-secondary flex items-center gap-2 h-[42px] mt-6\"\n            >\n              <Award size={18} />\n              Generate Certificates\n            </button>\n            <button\n              onClick={handleEmailParents}\n              className=\"btn btn-secondary flex items-center gap-2 h-[42px] mt-6\"\n            >\n              <Mail size={18} />\n              Email Parents\n            </button>\n            <button\n              onClick={handleExportList}\n              className=\"btn btn-secondary flex items-center gap-2 h-[42px] mt-6\"\n            >\n              <Download size={18} />\n              Export List\n            </button>\n          </div>\n        </div>\n      )}\n\n      <div className=\"premium-card min-h-[400px]\">\n        {loading ? (\n          <div className=\"flex items-center justify-center h-64 text-foreground/40\">\n            <p>Analyzing improvements...</p>\n          </div>\n        ) : improvedStudents.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center h-64 text-foreground/40\">\n            <p>Select terms and click \"Identify Most Improved\" to generate list</p>\n          </div>\n        ) : (\n          <div>\n            <div className=\"mb-4 pb-4 border-b border-white/10\">\n              <h2 className=\"text-xl font-bold\">Most Improved Students</h2>\n              <p className=\"text-sm text-foreground/60 mt-1\">\n                Total: {improvedStudents.length} students | Minimum Improvement: {minimumImprovement}%\n              </p>\n            </div>\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full text-left border-collapse\">\n                <thead>\n                  <tr className=\"border-b border-white/10\">\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Rank</th>\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Adm No</th>\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Student Name</th>\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Previous Avg</th>\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Current Avg</th>\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Improvement</th>\n                    <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Grade Change</th>\n                  </tr>\n                </thead>\n                <tbody className=\"divide-y divide-white/5\">\n                  {improvedStudents.map((student, index) => (\n                    <tr key={student.student_id} className=\"hover:bg-white/[0.02]\">\n                      <td className=\"py-4 pr-4\">\n                        <span className=\"inline-block px-3 py-1 rounded-full bg-amber-500/20 text-amber-400 font-bold text-sm\">\n                          #{index + 1}\n                        </span>\n                      </td>\n                      <td className=\"py-4 pr-4\">{student.admission_number}</td>\n                      <td className=\"py-4 pr-4 font-medium\">{student.student_name}</td>\n                      <td className=\"py-4 pr-4\">{student.previous_term_average.toFixed(2)}</td>\n                      <td className=\"py-4 pr-4\">{student.current_term_average.toFixed(2)}</td>\n                      <td className=\"py-4 pr-4\">\n                        <span className=\"inline-block px-2 py-1 rounded bg-green-500/20 text-green-400 font-bold\">\n                          +{student.improvement_percentage.toFixed(1)}%\n                        </span>\n                      </td>\n                      <td className=\"py-4 pr-4\">\n                        <span className=\"text-sm\">{student.grade_improvement}</span>\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n\nexport default MostImproved\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Academic\\ReportCardAnalytics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Academic\\ReportCardGeneration.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move async arrow function 'handleDownloadReportCards' to the outer scope.","line":157,"column":46,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":157,"endColumn":48},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":298,"column":19,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":302,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AlertCircle, CheckCircle, Download, Mail, MessageSquare, Loader } from 'lucide-react'\nimport React, { useState, useEffect } from 'react'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\n\ninterface GenerationProgress {\n  total: number\n  completed: number\n  failed: number\n  current_student: string\n  status: 'idle' | 'generating' | 'emailing' | 'complete' | 'error'\n  error_message?: string\n}\n\ninterface EmailTemplate {\n  id: string\n  name: string\n  subject: string\n  body: string\n}\n\nconst ReportCardGeneration: React.FC = () => {\n  const [selectedExam, setSelectedExam] = useState<number | null>(null)\n  const [selectedStream, setSelectedStream] = useState<number | null>(null)\n  const [exams, setExams] = useState<Array<{ id: number; name: string }>>([])\n  const [streams, setStreams] = useState<Array<{ id: number; name: string }>>([])\n  const [emailTemplates, setEmailTemplates] = useState<EmailTemplate[]>([])\n  const [selectedTemplate, setSelectedTemplate] = useState<string>('default')\n  const [sendEmail, setSendEmail] = useState(false)\n  const [sendSMS, setSendSMS] = useState(false)\n  const [mergePDFs, setMergePDFs] = useState(false)\n  const [progress, setProgress] = useState<GenerationProgress>({\n    total: 0,\n    completed: 0,\n    failed: 0,\n    current_student: '',\n    status: 'idle'\n  })\n  const [generatedFiles, setGeneratedFiles] = useState<string[]>([])\n\n  // Load initial data\n  useEffect(() => {\n    void loadExams()\n    void loadStreams()\n    void loadEmailTemplates()\n  }, [])\n\n  const loadExams = async () => {\n    try {\n      // Changed to use typed getExams from AcademicAPI\n      const year = await window.electronAPI.getCurrentAcademicYear()\n      const term = await window.electronAPI.getCurrentTerm()\n      if (year && term) {\n        const examsData = await window.electronAPI.getAcademicExams(year.id, term.id)\n        setExams(examsData || [])\n      }\n    } catch (error) {\n      console.error('Failed to load exams:', error)\n    }\n  }\n\n  const loadStreams = async () => {\n    try {\n      const streamsData = await window.electronAPI.getStreams()\n      setStreams(streamsData.map(s => ({ id: s.id, name: s.stream_name })) || [])\n    } catch (error) {\n      console.error('Failed to load streams:', error)\n    }\n  }\n\n  const loadEmailTemplates = async () => {\n    try {\n      const templates = await window.electronAPI.getNotificationTemplates()\n      // Filter for report card type if property exists, otherwise all\n      const rcTemplates = templates.filter(t => t.category === 'GENERAL' || t.template_name?.toLowerCase().includes('report'))\n      setEmailTemplates(rcTemplates.map(t => ({\n        id: String(t.id),\n        name: t.template_name,\n        subject: t.subject || '',\n        body: t.body\n      })) || [])\n    } catch (error) {\n      console.error('Failed to load email templates:', error)\n    }\n  }\n\n  const handleGenerateReportCards = async () => {\n    if (!selectedExam || !selectedStream) {\n      alert('Please select both exam and stream')\n      return\n    }\n\n    setProgress({\n      total: 0,\n      completed: 0,\n      failed: 0,\n      current_student: '',\n      status: 'generating'\n    })\n\n    try {\n      // Get students for stream - using StudentAPI\n      const students = await window.electronAPI.getStudents({ stream_id: selectedStream, is_active: true })\n\n      setProgress(prev => ({ ...prev, total: students.length }))\n\n      // Generate report cards - using new AcademicAPI method\n      const results = await window.electronAPI.generateBatchReportCards({\n        exam_id: selectedExam,\n        stream_id: selectedStream\n      })\n\n      // If email requested\n      if (sendEmail) {\n        setProgress(prev => ({ ...prev, status: 'emailing' }))\n\n        await window.electronAPI.emailReportCards({\n          exam_id: selectedExam,\n          stream_id: selectedStream,\n          template_id: selectedTemplate,\n          include_sms: sendSMS\n        })\n      }\n\n      // If merge PDFs requested\n      if (mergePDFs) {\n        await window.electronAPI.mergeReportCards({\n          exam_id: selectedExam,\n          stream_id: selectedStream,\n          output_path: `ReportCards_${selectedExam}_${selectedStream}.pdf`\n        })\n\n        setGeneratedFiles(prev => [\n          ...prev,\n          `ReportCards_${selectedExam}_${selectedStream}.pdf`\n        ])\n      }\n\n      setProgress(prev => ({\n        ...prev,\n        completed: results.generated,\n        failed: results.failed,\n        status: 'complete'\n      }))\n\n      alert(`Report cards generated successfully! ${results.generated} generated, ${results.failed} failed`)\n    } catch (error) {\n      setProgress(prev => ({\n        ...prev,\n        status: 'error',\n        error_message: error instanceof Error ? error.message : 'Unknown error'\n      }))\n      alert(`Error: ${error instanceof Error ? error.message : 'Failed to generate report cards'}`)\n    }\n  }\n\n  const handleDownloadReportCards = async () => {\n    alert('Download is temporarily unavailable. Please use generated files from the report card service directory.')\n  }\n\n  const getProgressPercentage = () => {\n    if (progress.total === 0) {return 0}\n    return Math.round((progress.completed / progress.total) * 100)\n  }\n\n  const getProgressColor = () => {\n    const percent = getProgressPercentage()\n    if (percent < 33) {return 'bg-red-500'}\n    if (percent < 66) {return 'bg-yellow-500'}\n    return 'bg-green-500'\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100\">\n      <PageHeader\n        title=\"Report Card Generation\"\n        subtitle=\"Batch generate and distribute CBC report cards to all students\"\n        breadcrumbs={[\n          { label: 'Academic', href: '/academic' },\n          { label: 'Report Cards', href: '/academic/report-cards' },\n          { label: 'Generation' }\n        ]}\n      />\n\n      <div className=\"max-w-6xl mx-auto px-4 py-8\">\n        {/* Selection Section */}\n        <div className=\"bg-white rounded-lg shadow-md p-6 mb-6\">\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Select Report Card Parameters</h2>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            {/* Exam Selection */}\n            <div>\n              <label htmlFor=\"field-193\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n                Exam <span className=\"text-red-500\">*</span>\n              </label>\n              <select id=\"field-193\"\n                value={selectedExam ?? ''}\n                onChange={(e) => setSelectedExam(e.target.value ? parseInt(e.target.value) : null)}\n                className=\"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n              >\n                <option value=\"\">Select Exam</option>\n                {exams.map(exam => (\n                  <option key={exam.id} value={exam.id}>\n                    {exam.name}\n                  </option>\n                ))}\n              </select>\n            </div>\n\n            {/* Stream Selection */}\n            <div>\n              <label htmlFor=\"field-212\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n                Stream <span className=\"text-red-500\">*</span>\n              </label>\n              <select id=\"field-212\"\n                value={selectedStream ?? ''}\n                onChange={(e) => setSelectedStream(e.target.value ? parseInt(e.target.value) : null)}\n                className=\"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n              >\n                <option value=\"\">Select Stream</option>\n                {streams.map(stream => (\n                  <option key={stream.id} value={stream.id}>\n                    {stream.name}\n                  </option>\n                ))}\n              </select>\n            </div>\n\n            {/* Email Options */}\n            <div>\n              <label htmlFor=\"field-231\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n                Email Template\n              </label>\n              <select id=\"field-231\"\n                value={selectedTemplate}\n                onChange={(e) => setSelectedTemplate(e.target.value)}\n                disabled={!sendEmail}\n                className=\"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-slate-100\"\n              >\n                {emailTemplates.map(template => (\n                  <option key={template.id} value={template.id}>\n                    {template.name}\n                  </option>\n                ))}\n              </select>\n            </div>\n\n            {/* Options */}\n            <div className=\"space-y-3\">\n              <label className=\"flex items-center gap-3 cursor-pointer\">\n                <input\n                  type=\"checkbox\"\n                  checked={sendEmail}\n                  onChange={(e) => setSendEmail(e.target.checked)}\n                  className=\"w-4 h-4 text-blue-600 rounded\"\n                />\n                <span className=\"text-sm font-medium text-slate-700\">\n                  <Mail className=\"inline w-4 h-4 mr-1\" />\n                  Email to Parents\n                </span>\n              </label>\n\n              <label className=\"flex items-center gap-3 cursor-pointer\">\n                <input\n                  type=\"checkbox\"\n                  checked={sendSMS}\n                  onChange={(e) => setSendSMS(e.target.checked)}\n                  className=\"w-4 h-4 text-blue-600 rounded disabled:opacity-50\"\n                />\n                <span className=\"text-sm font-medium text-slate-700\">\n                  <MessageSquare className=\"inline w-4 h-4 mr-1\" />\n                  SMS Notification\n                </span>\n              </label>\n\n              <label className=\"flex items-center gap-3 cursor-pointer\">\n                <input\n                  type=\"checkbox\"\n                  checked={mergePDFs}\n                  onChange={(e) => setMergePDFs(e.target.checked)}\n                  className=\"w-4 h-4 text-blue-600 rounded\"\n                />\n                <span className=\"text-sm font-medium text-slate-700\">\n                  <Download className=\"inline w-4 h-4 mr-1\" />\n                  Merge PDFs (Single File)\n                </span>\n              </label>\n            </div>\n          </div>\n        </div>\n\n        {/* Progress Section */}\n        {progress.status !== 'idle' && (\n          <div className=\"bg-white rounded-lg shadow-md p-6 mb-6\">\n            <div className=\"flex items-center gap-4 mb-4\">\n              {progress.status === 'generating' || progress.status === 'emailing' ? (\n                <Loader className=\"w-6 h-6 text-blue-500 animate-spin\" />\n              ) : progress.status === 'complete' ? (\n                <CheckCircle className=\"w-6 h-6 text-green-500\" />\n              ) : (\n                <AlertCircle className=\"w-6 h-6 text-red-500\" />\n              )}\n\n              <div>\n                <h3 className=\"font-semibold text-slate-900\">\n                  {progress.status === 'generating' && 'Generating Report Cards...'}\n                  {progress.status === 'emailing' && 'Sending Emails...'}\n                  {progress.status === 'complete' && 'Complete!'}\n                  {progress.status === 'error' && 'Error'}\n                </h3>\n                {progress.current_student && (\n                  <p className=\"text-sm text-slate-600\">\n                    Current: {progress.current_student}\n                  </p>\n                )}\n              </div>\n            </div>\n\n            {/* Progress Bar */}\n            <div className=\"mb-4\">\n              <div className=\"flex justify-between text-sm text-slate-600 mb-2\">\n                <span>Progress: {progress.completed} of {progress.total}</span>\n                <span>{getProgressPercentage()}%</span>\n              </div>\n              <div className=\"w-full bg-slate-200 rounded-full h-3 overflow-hidden\">\n                <div\n                  className={`h-full ${getProgressColor()} transition-all duration-300`}\n                  style={{ width: `${getProgressPercentage()}%` }}\n                />\n              </div>\n            </div>\n\n            {/* Stats */}\n            <div className=\"grid grid-cols-3 gap-4 text-sm\">\n              <div className=\"bg-green-50 rounded p-3\">\n                <p className=\"text-slate-600\">Generated</p>\n                <p className=\"text-2xl font-bold text-green-600\">{progress.completed}</p>\n              </div>\n              <div className=\"bg-red-50 rounded p-3\">\n                <p className=\"text-slate-600\">Failed</p>\n                <p className=\"text-2xl font-bold text-red-600\">{progress.failed}</p>\n              </div>\n              <div className=\"bg-blue-50 rounded p-3\">\n                <p className=\"text-slate-600\">Total</p>\n                <p className=\"text-2xl font-bold text-blue-600\">{progress.total}</p>\n              </div>\n            </div>\n\n            {progress.error_message && (\n              <div className=\"mt-4 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm\">\n                {progress.error_message}\n              </div>\n            )}\n          </div>\n        )}\n\n        {/* Action Buttons */}\n        <div className=\"bg-white rounded-lg shadow-md p-6 mb-6\">\n          <div className=\"flex gap-4 flex-wrap\">\n            <button\n              onClick={handleGenerateReportCards}\n              disabled={!selectedExam || !selectedStream || progress.status === 'generating' || progress.status === 'emailing'}\n              className=\"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-slate-400 disabled:cursor-not-allowed font-medium transition\"\n            >\n              {progress.status === 'generating' || progress.status === 'emailing' ? (\n                <>\n                  <Loader className=\"inline w-4 h-4 mr-2 animate-spin\" />\n                  Generating...\n                </>\n              ) : (\n                'Generate Report Cards'\n              )}\n            </button>\n\n            {progress.status === 'complete' && (\n              <button\n                onClick={handleDownloadReportCards}\n                className=\"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition flex items-center gap-2\"\n              >\n                <Download className=\"w-4 h-4\" />\n                Download Report Cards\n              </button>\n            )}\n          </div>\n        </div>\n\n        {/* Generated Files List */}\n        {generatedFiles.length > 0 && (\n          <div className=\"bg-white rounded-lg shadow-md p-6\">\n            <h3 className=\"font-semibold text-slate-900 mb-4\">Generated Files</h3>\n            <div className=\"space-y-2\">\n              {generatedFiles.map((file, idx) => (\n                <div key={idx} className=\"flex items-center justify-between p-3 bg-slate-50 rounded border border-slate-200\">\n                  <span className=\"text-sm text-slate-700\">{file}</span>\n                  <button className=\"text-blue-600 hover:text-blue-700 text-sm font-medium\">\n                    Download\n                  </button>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Info Box */}\n        <div className=\"mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg\">\n          <p className=\"text-sm text-blue-800\">\n            <strong>Note:</strong> Report cards will be generated for all students in the selected stream for the chosen exam.\n            If email is enabled, parents will receive the report card as an attachment with parent portal access links.\n            All report cards are password-protected with the student's admission number.\n          </p>\n        </div>\n      </div>\n    </div>\n  )\n}\n\nexport default ReportCardGeneration\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Academic\\SubjectManagement.tsx","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":168,"column":13,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":245,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { BookOpen, Plus, Edit, Trash2, CheckCircle2, Loader2 } from 'lucide-react'\nimport { useCallback, useEffect, useMemo, useState } from 'react'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\nimport { Modal } from '../../components/ui/Modal'\nimport { Select } from '../../components/ui/Select'\nimport { useToast } from '../../contexts/ToastContext'\nimport { useAuthStore } from '../../stores'\nimport { type AcademicSubject } from '../../types/electron-api/AcademicAPI'\n\ntype SubjectFormState = {\n  code: string\n  name: string\n  curriculum: string\n  is_compulsory: boolean\n  is_active: boolean\n}\n\nconst emptyForm: SubjectFormState = {\n  code: '',\n  name: '',\n  curriculum: 'CBC',\n  is_compulsory: true,\n  is_active: true\n}\n\nfunction toBoolean(value: boolean | number | null | undefined): boolean {\n  return value === true || value === 1\n}\n\nexport default function SubjectManagement() {\n  const { user } = useAuthStore()\n  const { showToast } = useToast()\n  const [subjects, setSubjects] = useState<AcademicSubject[]>([])\n  const [loading, setLoading] = useState(true)\n  const [saving, setSaving] = useState(false)\n  const [showModal, setShowModal] = useState(false)\n  const [editing, setEditing] = useState<AcademicSubject | null>(null)\n  const [form, setForm] = useState<SubjectFormState>(emptyForm)\n\n  const curriculumOptions = useMemo(() => ([\n    { value: 'CBC', label: 'CBC' },\n    { value: '8-4-4', label: '8-4-4' },\n    { value: 'ECDE', label: 'ECDE' }\n  ]), [])\n\n  const loadSubjects = useCallback(async () => {\n    setLoading(true)\n    try {\n      const data = await window.electronAPI.getAcademicSubjectsAdmin()\n      setSubjects(data || [])\n    } catch (error) {\n      console.error('Failed to load subjects:', error)\n      showToast('Failed to load subjects', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }, [showToast])\n\n  useEffect(() => {\n    void loadSubjects()\n  }, [loadSubjects])\n\n  const openCreate = () => {\n    setEditing(null)\n    setForm(emptyForm)\n    setShowModal(true)\n  }\n\n  const openEdit = (subject: AcademicSubject) => {\n    setEditing(subject)\n    setForm({\n      code: String(subject.code ?? '').toUpperCase(),\n      name: String(subject.name ?? ''),\n      curriculum: String(subject.curriculum ?? 'CBC'),\n      is_compulsory: toBoolean(subject.is_compulsory),\n      is_active: toBoolean(subject.is_active)\n    })\n    setShowModal(true)\n  }\n\n  const handleSave = async () => {\n    if (!user?.id) {\n      showToast('You must be signed in to manage subjects', 'error')\n      return\n    }\n\n    if (!form.code.trim() || !form.name.trim() || !form.curriculum.trim()) {\n      showToast('Code, name, and curriculum are required', 'error')\n      return\n    }\n\n    setSaving(true)\n    try {\n      if (editing) {\n        await window.electronAPI.updateAcademicSubject(editing.id, {\n          code: form.code.trim().toUpperCase(),\n          name: form.name.trim(),\n          curriculum: form.curriculum,\n          is_compulsory: form.is_compulsory,\n          is_active: form.is_active\n        }, user.id)\n        showToast('Subject updated', 'success')\n      } else {\n        await window.electronAPI.createAcademicSubject({\n          code: form.code.trim().toUpperCase(),\n          name: form.name.trim(),\n          curriculum: form.curriculum,\n          is_compulsory: form.is_compulsory,\n          is_active: form.is_active\n        }, user.id)\n        showToast('Subject created', 'success')\n      }\n      setShowModal(false)\n      await loadSubjects()\n    } catch (error) {\n      showToast(error instanceof Error ? error.message : 'Failed to save subject', 'error')\n    } finally {\n      setSaving(false)\n    }\n  }\n\n  const handleToggleActive = async (subject: AcademicSubject, desired: boolean) => {\n    if (!user?.id) {\n      showToast('You must be signed in to manage subjects', 'error')\n      return\n    }\n    if (!confirm(`${desired ? 'Activate' : 'Deactivate'} subject \"${subject.name}\"?`)) {return}\n    setSaving(true)\n    try {\n      await window.electronAPI.setAcademicSubjectActive(subject.id, desired, user.id)\n      await loadSubjects()\n      showToast(`Subject ${desired ? 'activated' : 'deactivated'}`, 'success')\n    } catch (error) {\n      showToast(error instanceof Error ? error.message : 'Action failed', 'error')\n    } finally {\n      setSaving(false)\n    }\n  }\n\n  return (\n    <div className=\"space-y-8 pb-10\">\n      <PageHeader\n        title=\"Subject Management\"\n        subtitle=\"Maintain academic subjects and curriculum coverage\"\n        breadcrumbs={[{ label: 'Academics' }, { label: 'Subjects' }]}\n      />\n\n      <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-6\">\n        <div className=\"text-foreground/50 text-sm font-medium\">\n          Active subjects are available for allocations, marks entry, and analytics.\n        </div>\n        <button\n          onClick={openCreate}\n          className=\"btn btn-primary flex items-center gap-2 py-3 px-8 text-sm font-bold shadow-xl shadow-primary/20 transition-all hover:-translate-y-1\"\n        >\n          <Plus className=\"w-5 h-5\" />\n          <span>Add Subject</span>\n        </button>\n      </div>\n\n      <div className=\"card overflow-hidden transition-all duration-300\">\n        {loading ? (\n          <div className=\"flex flex-col items-center justify-center py-24 gap-4\">\n            <div className=\"w-10 h-10 border-4 border-primary/20 border-t-primary rounded-full animate-spin\" />\n            <p className=\"text-xs font-bold uppercase tracking-widest text-foreground/40\">Loading Subjects...</p>\n          </div>\n        ) : subjects.length === 0 ? (\n          <div className=\"text-center py-24 bg-secondary/5 rounded-3xl border border-dashed border-border/40 m-4\">\n            <BookOpen className=\"w-16 h-16 text-foreground/10 mx-auto mb-4\" />\n            <h3 className=\"text-xl font-bold text-foreground/80 font-heading\">No Subjects Found</h3>\n            <p className=\"text-foreground/40 font-medium italic mb-6\">Add subjects to enable allocations and exam workflows</p>\n            <button onClick={openCreate} className=\"btn btn-secondary border-2 border-dashed px-8\">Add First Subject</button>\n          </div>\n        ) : (\n          <div className=\"overflow-x-auto\">\n            <table className=\"data-table\">\n              <thead>\n                <tr className=\"border-b border-border/40\">\n                  <th className=\"py-5 font-bold uppercase tracking-widest text-[10px] text-foreground/40\">Code</th>\n                  <th className=\"py-5 font-bold uppercase tracking-widest text-[10px] text-foreground/40\">Name</th>\n                  <th className=\"py-5 font-bold uppercase tracking-widest text-[10px] text-foreground/40\">Curriculum</th>\n                  <th className=\"py-5 font-bold uppercase tracking-widest text-[10px] text-foreground/40\">Compulsory</th>\n                  <th className=\"py-5 font-bold uppercase tracking-widest text-[10px] text-foreground/40\">Status</th>\n                  <th className=\"py-5 font-bold uppercase tracking-widest text-[10px] text-foreground/40 text-right px-6\">Actions</th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-border/10\">\n                {subjects.map((subject) => {\n                  const active = toBoolean(subject.is_active)\n                  return (\n                    <tr key={subject.id} className=\"group hover:bg-secondary/20 transition-colors\">\n                      <td className=\"py-4\">\n                        <span className=\"font-mono text-xs font-bold text-primary/60\">{subject.code}</span>\n                      </td>\n                      <td className=\"py-4\">\n                        <span className=\"font-bold text-foreground\">{subject.name}</span>\n                      </td>\n                      <td className=\"py-4\">\n                        <span className=\"text-xs font-bold text-foreground/60 uppercase tracking-wide\">{subject.curriculum}</span>\n                      </td>\n                      <td className=\"py-4\">\n                        <span className=\"text-xs font-semibold text-foreground/60\">{toBoolean(subject.is_compulsory) ? 'Yes' : 'No'}</span>\n                      </td>\n                      <td className=\"py-4\">\n                        <span className={`px-3 py-1.5 rounded-lg text-[10px] font-bold tracking-widest flex items-center gap-2 w-fit border ${active ? 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20 shadow-sm shadow-emerald-500/10' : 'bg-destructive/10 text-destructive border-destructive/20'\n                          }`}>\n                          <div className={`w-1.5 h-1.5 rounded-full ${active ? 'bg-emerald-500 animate-pulse' : 'bg-destructive'}`} />\n                          {active ? 'ACTIVE' : 'INACTIVE'}\n                        </span>\n                      </td>\n                      <td className=\"py-4 px-6 text-right\">\n                        <div className=\"flex gap-2 justify-end opacity-0 group-hover:opacity-100 transition-opacity\">\n                          <button\n                            onClick={() => openEdit(subject)}\n                            className=\"p-2.5 bg-background border border-border/40 hover:border-blue-500/50 hover:text-blue-500 rounded-xl transition-all shadow-sm\"\n                          >\n                            <Edit className=\"w-4 h-4\" />\n                          </button>\n                          {active ? (\n                            <button\n                              onClick={() => handleToggleActive(subject, false)}\n                              className=\"p-2.5 bg-background border border-border/40 hover:border-destructive/50 hover:text-destructive rounded-xl transition-all shadow-sm\"\n                              disabled={saving}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </button>\n                          ) : (\n                            <button\n                              onClick={() => handleToggleActive(subject, true)}\n                              className=\"p-2.5 bg-background border border-border/40 hover:border-emerald-500/50 hover:text-emerald-500 rounded-xl transition-all shadow-sm\"\n                              disabled={saving}\n                            >\n                              <CheckCircle2 className=\"w-4 h-4\" />\n                            </button>\n                          )}\n                        </div>\n                      </td>\n                    </tr>\n                  )\n                })}\n              </tbody>\n            </table>\n          </div>\n        )}\n      </div>\n\n      <Modal\n        isOpen={showModal}\n        onClose={() => setShowModal(false)}\n        title={editing ? 'Edit Subject' : 'Add Subject'}\n        size=\"sm\"\n      >\n        <div className=\"space-y-6\">\n          <div className=\"space-y-3\">\n            <label htmlFor=\"field-256\" className=\"text-[10px] font-bold text-foreground/40 uppercase tracking-widest ml-1\">Subject Code *</label>\n            <input id=\"field-256\"\n              type=\"text\"\n              value={form.code}\n              onChange={(e) => setForm(prev => ({ ...prev, code: e.target.value.toUpperCase() }))}\n              className=\"input w-full bg-secondary/30\"\n              placeholder=\"e.g. C-MATH\"\n            />\n          </div>\n\n          <div className=\"space-y-3\">\n            <label htmlFor=\"field-267\" className=\"text-[10px] font-bold text-foreground/40 uppercase tracking-widest ml-1\">Subject Name *</label>\n            <input id=\"field-267\"\n              type=\"text\"\n              value={form.name}\n              onChange={(e) => setForm(prev => ({ ...prev, name: e.target.value }))}\n              className=\"input w-full bg-secondary/30\"\n              placeholder=\"e.g. Mathematics\"\n            />\n          </div>\n\n          <Select\n            label=\"Curriculum\"\n            value={form.curriculum}\n            onChange={(val) => setForm(prev => ({ ...prev, curriculum: String(val) }))}\n            options={curriculumOptions}\n          />\n\n          <div className=\"flex items-center justify-between gap-4 rounded-2xl border border-border/20 p-4 bg-secondary/10\">\n            <div>\n              <p className=\"text-sm font-semibold text-foreground\">Compulsory Subject</p>\n              <p className=\"text-xs text-foreground/40\">Controls default subject allocation expectations</p>\n            </div>\n            <button\n              onClick={() => setForm(prev => ({ ...prev, is_compulsory: !prev.is_compulsory }))}\n              className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-widest border ${form.is_compulsory ? 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20' : 'bg-secondary/30 text-foreground/40 border-border/30'}`}\n            >\n              {form.is_compulsory ? 'Yes' : 'No'}\n            </button>\n          </div>\n\n          <div className=\"flex items-center justify-between gap-4 rounded-2xl border border-border/20 p-4 bg-secondary/10\">\n            <div>\n              <p className=\"text-sm font-semibold text-foreground\">Active Status</p>\n              <p className=\"text-xs text-foreground/40\">Inactive subjects are hidden from allocations</p>\n            </div>\n            <button\n              onClick={() => setForm(prev => ({ ...prev, is_active: !prev.is_active }))}\n              className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-widest border ${form.is_active ? 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20' : 'bg-destructive/10 text-destructive border-destructive/20'}`}\n            >\n              {form.is_active ? 'Active' : 'Inactive'}\n            </button>\n          </div>\n\n          <div className=\"flex justify-end gap-3 pt-4 border-t border-border/10\">\n            <button onClick={() => setShowModal(false)} className=\"btn btn-secondary px-6\">Cancel</button>\n            <button onClick={handleSave} disabled={saving} className=\"btn btn-primary px-8 flex items-center gap-2\">\n              {saving ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <CheckCircle2 className=\"w-4 h-4\" />}\n              {editing ? 'Update' : 'Create'}\n            </button>\n          </div>\n        </div>\n      </Modal>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Academic\\SubjectMeritLists.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'scoreToGrade' to the outer scope.","line":90,"column":48,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":90,"endColumn":50},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":218,"column":13,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":256,"endColumn":10},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":245,"column":72,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":245,"endColumn":111}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { Download } from 'lucide-react'\nimport { useState, useEffect, useCallback } from 'react'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\nimport { Select } from '../../components/ui/Select'\nimport { useAppStore } from '../../stores'\nimport { type SubjectDifficulty, type SubjectMeritListRow } from '../../types/electron-api/AcademicAPI'\n\ninterface SubjectRanking {\n  position: number\n  student_name: string\n  admission_number: string\n  marks: number\n  percentage: number\n  grade: string\n}\n\n\nconst SubjectMeritLists = () => {\n  const { currentAcademicYear, currentTerm } = useAppStore()\n\n  const [exams, setExams] = useState<{ id: number; name: string }[]>([])\n  const [subjects, setSubjects] = useState<{ id: number; name: string }[]>([])\n  const [streams, setStreams] = useState<{ id: number; stream_name: string }[]>([])\n\n  const [selectedExam, setSelectedExam] = useState<number>(0)\n  const [selectedSubject, setSelectedSubject] = useState<number>(0)\n  const [selectedStream, setSelectedStream] = useState<number>(0)\n\n  const [rankings, setRankings] = useState<SubjectRanking[]>([])\n  const [difficulty, setDifficulty] = useState<SubjectDifficulty | null>(null)\n  const [loading, setLoading] = useState(false)\n\n  const loadInitialData = useCallback(async () => {\n    try {\n      const [examsData, streamsData, subjectsData] = await Promise.all([\n        window.electronAPI.getExams({ academicYearId: currentAcademicYear?.id, termId: currentTerm?.id }),\n        window.electronAPI.getStreams(),\n        window.electronAPI.getAcademicSubjects()\n      ])\n\n      setExams(examsData || [])\n      setStreams(streamsData || [])\n      setSubjects(subjectsData || [])\n    } catch (error) {\n      console.error('Failed to load initial data:', error)\n    }\n  }, [currentAcademicYear, currentTerm])\n\n  useEffect(() => {\n    void loadInitialData()\n  }, [loadInitialData])\n\n  const handleGenerateMeritList = async () => {\n    if (!selectedExam || !selectedSubject || !selectedStream) {\n      alert('Please select an exam, subject, and stream')\n      return\n    }\n\n    setLoading(true)\n    try {\n      const [rankings_, difficulty_] = await Promise.all([\n        window.electronAPI.getSubjectMeritList({\n          examId: selectedExam,\n          subjectId: selectedSubject,\n          streamId: selectedStream\n        }),\n        window.electronAPI.getSubjectDifficulty({\n          examId: selectedExam,\n          subjectId: selectedSubject,\n          streamId: selectedStream\n        })\n      ])\n\n      const scored = (rankings_ || []).map((row: SubjectMeritListRow) => ({\n        ...row,\n        grade: scoreToGrade(row.marks)\n      }))\n      setRankings(scored)\n      setDifficulty(difficulty_)\n    } catch (error) {\n      console.error('Failed to generate merit list:', error)\n      alert('Failed to generate merit list')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const scoreToGrade = (score: number): string => {\n    if (score >= 80) {return 'A'}\n    if (score >= 75) {return 'A-'}\n    if (score >= 70) {return 'B+'}\n    if (score >= 65) {return 'B'}\n    if (score >= 60) {return 'B-'}\n    if (score >= 55) {return 'C+'}\n    if (score >= 50) {return 'C'}\n    if (score >= 45) {return 'C-'}\n    return 'E'\n  }\n\n  const handleExportCSV = () => {\n    if (rankings.length === 0) {\n      alert('Please generate a merit list first')\n      return\n    }\n\n    const subjectName = subjects.find(s => s.id === selectedSubject)?.name || 'Subject'\n    const csvContent = [\n      ['Position', 'Admission No', 'Student Name', 'Marks', 'Percentage', 'Grade'],\n      ...rankings.map(item => [\n        item.position,\n        item.admission_number,\n        item.student_name,\n        item.marks,\n        item.percentage.toFixed(1),\n        item.grade\n      ])\n    ].map(row => row.join(',')).join('\\n')\n\n    const blob = new Blob([csvContent], { type: 'text/csv' })\n    const url = URL.createObjectURL(blob)\n    const a = document.createElement('a')\n    a.href = url\n    a.download = `${subjectName}_Merit_List.csv`\n    a.click()\n  }\n\n  return (\n    <div className=\"space-y-8 pb-10\">\n      <PageHeader\n        title=\"Subject Merit Lists\"\n        subtitle=\"Top performers in each subject with difficulty analysis\"\n        breadcrumbs={[{ label: 'Academics' }, { label: 'Subject Merit Lists' }]}\n      />\n\n      <div className=\"premium-card\">\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6\">\n          <Select\n            label=\"Exam\"\n            value={selectedExam}\n            onChange={(val) => setSelectedExam(Number(val))}\n            options={[\n              { value: 0, label: 'Select exam...' },\n              ...exams.map((e) => ({ value: e.id, label: e.name }))\n            ]}\n          />\n          <Select\n            label=\"Subject\"\n            value={selectedSubject}\n            onChange={(val) => setSelectedSubject(Number(val))}\n            options={[\n              { value: 0, label: 'Select subject...' },\n              ...subjects.map((s) => ({ value: s.id, label: s.name }))\n            ]}\n          />\n          <Select\n            label=\"Stream\"\n            value={selectedStream}\n            onChange={(val) => setSelectedStream(Number(val))}\n            options={[\n              { value: 0, label: 'Select stream...' },\n              ...streams.map((s) => ({ value: s.id, label: s.stream_name }))\n            ]}\n          />\n          <div className=\"flex items-end gap-3\">\n            <button\n              onClick={handleGenerateMeritList}\n              disabled={loading}\n              className=\"btn btn-primary flex-1\"\n            >\n              {loading ? 'Loading...' : 'Generate'}\n            </button>\n          </div>\n        </div>\n\n        {difficulty && (\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n            <div className=\"p-4 rounded-lg bg-white/5\">\n              <p className=\"text-sm text-foreground/60\">Mean Score</p>\n              <p className=\"text-2xl font-bold\">{difficulty.mean_score.toFixed(1)}</p>\n            </div>\n            <div className=\"p-4 rounded-lg bg-white/5\">\n              <p className=\"text-sm text-foreground/60\">Pass Rate</p>\n              <p className=\"text-2xl font-bold\">{difficulty.pass_rate.toFixed(1)}%</p>\n            </div>\n            <div className=\"p-4 rounded-lg bg-white/5\">\n              <p className=\"text-sm text-foreground/60\">Difficulty</p>\n              <p className=\"text-2xl font-bold\">{difficulty.difficulty_index.toFixed(1)}</p>\n            </div>\n            <div className=\"p-4 rounded-lg bg-white/5\">\n              <p className=\"text-sm text-foreground/60\">Discrimination</p>\n              <p className=\"text-2xl font-bold\">{difficulty.discrimination_index.toFixed(2)}</p>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {rankings.length > 0 && (\n        <div className=\"premium-card\">\n          <div className=\"flex gap-3 pb-4 border-b border-white/10\">\n            <button\n              onClick={handleExportCSV}\n              className=\"btn btn-secondary flex items-center gap-2\"\n            >\n              <Download size={18} />\n              Export CSV\n            </button>\n          </div>\n        </div>\n      )}\n\n      <div className=\"premium-card min-h-[400px]\">\n        {loading ? (\n          <div className=\"flex items-center justify-center h-64 text-foreground/40\">\n            <p>Loading...</p>\n          </div>\n        ) : rankings.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center h-64 text-foreground/40\">\n            <p>Select exam, subject, and stream to view rankings</p>\n          </div>\n        ) : (\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full text-left border-collapse\">\n              <thead>\n                <tr className=\"border-b border-white/10\">\n                  <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Position</th>\n                  <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Admission No</th>\n                  <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Student Name</th>\n                  <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Marks</th>\n                  <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Percentage</th>\n                  <th className=\"pb-4 pt-2 font-bold text-foreground/60\">Grade</th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-white/5\">\n                {rankings.map((row) => (\n                  <tr key={`${row.admission_number}-${row.position}`} className=\"hover:bg-white/[0.02]\">\n                    <td className=\"py-4 pr-4 font-semibold\">{row.position}</td>\n                    <td className=\"py-4 pr-4\">{row.admission_number}</td>\n                    <td className=\"py-4 pr-4\">{row.student_name}</td>\n                    <td className=\"py-4 pr-4\">{row.marks}</td>\n                    <td className=\"py-4 pr-4\">{row.percentage.toFixed(1)}%</td>\n                    <td className=\"py-4 pr-4\">\n                      <span className=\"px-2 py-1 rounded text-sm font-semibold\" style={{\n                        backgroundColor: row.marks >= 80 ? '#10b981' : row.marks >= 60 ? '#3b82f6' : '#ef4444',\n                        color: 'white'\n                      }}>\n                        {row.grade}\n                      </span>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n\nexport default SubjectMeritLists\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Academic\\TeacherAllocation.tsx","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":200,"column":29,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":233,"endColumn":26},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":204,"column":29,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":233,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n    Users, BookOpen, Save, Loader2, UserPlus, Trash2\n} from 'lucide-react'\nimport { useState, useEffect, useCallback } from 'react'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\nimport { Select } from '../../components/ui/Select'\nimport { useAppStore, useAuthStore } from '../../stores'\n\ninterface Staff {\n    id: number\n    first_name: string\n    last_name: string\n    staff_number: string\n}\n\ninterface Subject {\n    id: number\n    code: string\n    name: string\n    curriculum: string\n}\n\ninterface Stream {\n    id: number\n    stream_name: string\n}\n\ninterface Allocation {\n    id: number\n    subject_id: number\n    teacher_id: number\n    subject_name?: string\n    teacher_name?: string\n}\n\nexport default function TeacherAllocation() {\n    const { currentAcademicYear, currentTerm } = useAppStore()\n    const { user } = useAuthStore()\n\n    const [streams, setStreams] = useState<Stream[]>([])\n    const [staff, setStaff] = useState<Staff[]>([])\n    const [subjects, setSubjects] = useState<Subject[]>([])\n    const [allocations, setAllocations] = useState<Allocation[]>([])\n\n    const [selectedStream, setSelectedStream] = useState<number>(0)\n    const [selectedSubject, setSelectedSubject] = useState<number>(0)\n    const [selectedTeacher, setSelectedTeacher] = useState<number>(0)\n\n    const [loading, setLoading] = useState(false)\n    const [saving, setSaving] = useState(false)\n\n    const loadAllocations = useCallback(async () => {\n        try {\n            if (currentAcademicYear && currentTerm) {\n                setLoading(true)\n                const [allocationsData, streamsData, subjectsData] = await Promise.all([\n                    window.electronAPI.getTeacherAllocations(\n                        currentAcademicYear.id,\n                        currentTerm.id,\n                        selectedStream || undefined\n                    ),\n                    window.electronAPI.getStreams(),\n                    window.electronAPI.getAcademicSubjects()\n                ])\n\n                setAllocations(allocationsData || [])\n                setStreams(streamsData || [])\n                setSubjects(subjectsData || [])\n            }\n        } catch (error) {\n            console.error('Failed to load allocations:', error)\n        } finally {\n            setLoading(false)\n        }\n    }, [currentAcademicYear, currentTerm, selectedStream])\n\n    const loadInitialData = useCallback(async () => {\n        try {\n            const [staffData] = await Promise.all([\n                window.electronAPI.getStaff(),\n            ])\n            setStaff(staffData)\n        } catch (error) {\n            console.error('Failed to load initial data:', error)\n        }\n    }, [])\n\n    useEffect(() => {\n        void loadInitialData()\n    }, [loadInitialData])\n\n    useEffect(() => {\n        void loadAllocations()\n    }, [loadAllocations])\n\n    const handleAllocate = async () => {\n        if (!currentAcademicYear || !currentTerm || !selectedStream || !selectedSubject || !selectedTeacher || !user) {\n            alert('Please select class, subject and teacher')\n            return\n        }\n\n        setSaving(true)\n        try {\n            await window.electronAPI.allocateTeacher({\n                academic_year_id: currentAcademicYear.id,\n                term_id: currentTerm.id,\n                stream_id: selectedStream,\n                subject_id: selectedSubject,\n                teacher_id: selectedTeacher\n            }, user.id)\n\n            // Refresh allocations list\n            await loadAllocations()\n\n            // Reset selection\n            setSelectedSubject(0)\n            setSelectedTeacher(0)\n        } catch (error) {\n            console.error('Failed to allocate teacher:', error)\n            alert('Failed to save allocation')\n        } finally {\n            setSaving(false)\n        }\n    }\n\n    return (\n        <div className=\"space-y-8 pb-10\">\n            <PageHeader\n                title=\"Teacher Allocations\"\n                subtitle=\"Assign teachers to subjects for specific classes\"\n                breadcrumbs={[{ label: 'Academics' }, { label: 'Allocations' }]}\n            />\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n                {/* Allocation Form */}\n                <div className=\"lg:col-span-1 space-y-6\">\n                    <div className=\"premium-card space-y-4\">\n                        <h3 className=\"text-lg font-bold text-white flex items-center gap-2\">\n                            <UserPlus className=\"w-5 h-5 text-primary\" />\n                            New Allocation\n                        </h3>\n\n                        <div className=\"space-y-4\">\n                            <Select\n                                label=\"Class / Stream\"\n                                value={selectedStream}\n                                onChange={(val) => setSelectedStream(Number(val))}\n                                options={[\n                                    { value: 0, label: 'Select class...' },\n                                    ...streams.map(s => ({ value: s.id, label: s.stream_name }))\n                                ]}\n                            />\n\n                            <Select\n                                label=\"Subject\"\n                                value={selectedSubject}\n                                onChange={(val) => setSelectedSubject(Number(val))}\n                                options={[\n                                    { value: 0, label: 'Select subject...' },\n                                    ...subjects.map(s => ({ value: s.id, label: `${s.name} (${s.curriculum})` }))\n                                ]}\n                            />\n\n                            <Select\n                                label=\"Teacher\"\n                                value={selectedTeacher}\n                                onChange={(val) => setSelectedTeacher(Number(val))}\n                                options={[\n                                    { value: 0, label: 'Select teacher...' },\n                                    ...staff.map(s => ({ value: s.id, label: `${s.first_name} ${s.last_name}` }))\n                                ]}\n                            />\n\n                            <button\n                                onClick={handleAllocate}\n                                disabled={saving || !selectedStream || !selectedSubject || !selectedTeacher}\n                                className=\"w-full btn btn-primary flex items-center justify-center gap-2 py-3 mt-4\"\n                            >\n                                {saving ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Save className=\"w-4 h-4\" />}\n                                Save Allocation\n                            </button>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Current Allocations List */}\n                <div className=\"lg:col-span-2\">\n                    <div className=\"premium-card min-h-[400px]\">\n                        <h3 className=\"text-lg font-bold text-white mb-6 flex items-center gap-2\">\n                            <BookOpen className=\"w-5 h-5 text-primary\" />\n                            Current Allocations\n                        </h3>\n\n                        {!selectedStream ? (\n                            <div className=\"flex flex-col items-center justify-center h-64 text-foreground/40 space-y-3\">\n                                <Users className=\"w-12 h-12 opacity-20\" />\n                                <p>Select a class to view its allocations</p>\n                            </div>\n                        ) : loading ? (\n                            <div className=\"flex items-center justify-center h-64 text-foreground/40\">\n                                <Loader2 className=\"w-8 h-8 animate-spin\" />\n                            </div>\n                        ) : allocations.length === 0 ? (\n                            <div className=\"flex flex-col items-center justify-center h-64 text-foreground/40 space-y-3\">\n                                <p>No subjects allocated for this class yet</p>\n                            </div>\n                        ) : (\n                            <div className=\"overflow-x-auto\">\n                                <table className=\"w-full text-left\">\n                                    <thead>\n                                        <tr className=\"border-b border-white/10\">\n                                            <th className=\"pb-3 font-bold text-foreground/60\">Subject</th>\n                                            <th className=\"pb-3 font-bold text-foreground/60\">Teacher</th>\n                                            <th className=\"pb-3 font-bold text-foreground/60 text-right\">Actions</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody className=\"divide-y divide-white/5\">\n                                        {allocations.map(allocation => (\n                                            <tr key={allocation.id} className=\"group\">\n                                                <td className=\"py-4 font-medium text-white\">{allocation.subject_name}</td>\n                                                <td className=\"py-4 text-foreground/80\">{allocation.teacher_name}</td>\n                                                <td className=\"py-4 text-right\">\n                                                    <button className=\"p-2 text-foreground/30 hover:text-destructive transition-colors\">\n                                                        <Trash2 className=\"w-4 h-4\" />\n                                                    </button>\n                                                </td>\n                                            </tr>\n                                        ))}\n                                    </tbody>\n                                </table>\n                            </div>\n                        )}\n                    </div>\n                </div>\n            </div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Approvals\\index.tsx","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":179,"column":21,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":243,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n    CheckCircle, XCircle, Clock, AlertTriangle,\n    FileText, ChevronRight\n} from 'lucide-react'\nimport { useState, useEffect, useCallback } from 'react'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\nimport { StatCard } from '../../components/patterns/StatCard'\nimport { Badge } from '../../components/ui/Badge'\nimport { Modal } from '../../components/ui/Modal'\nimport { useAuthStore } from '../../stores'\nimport { formatDate } from '../../utils/format'\n\ninterface ApprovalRequest {\n    id: number\n    workflow_name: string\n    entity_type: string\n    entity_id: number\n    entity_description: string\n    status: 'PENDING' | 'APPROVED' | 'REJECTED' | 'CANCELLED'\n    requester_name: string\n    approver_name: string | null\n    created_at: string\n    completed_at: string | null\n}\n\ninterface ApprovalCounts {\n    pending: number\n    approved: number\n    rejected: number\n}\n\nconst statusConfig = {\n    PENDING: { label: 'Pending', variant: 'warning' as const, icon: Clock },\n    APPROVED: { label: 'Approved', variant: 'success' as const, icon: CheckCircle },\n    REJECTED: { label: 'Rejected', variant: 'error' as const, icon: XCircle },\n    CANCELLED: { label: 'Cancelled', variant: 'default' as const, icon: AlertTriangle },\n}\n\nexport default function Approvals() {\n    const { user } = useAuthStore()\n    const [requests, setRequests] = useState<ApprovalRequest[]>([])\n    const [counts, setCounts] = useState<ApprovalCounts>({ pending: 0, approved: 0, rejected: 0 })\n    const [loading, setLoading] = useState(true)\n    const [filter, setFilter] = useState<'all' | 'pending'>('pending')\n\n    const [showRejectModal, setShowRejectModal] = useState(false)\n    const [selectedRequest, setSelectedRequest] = useState<ApprovalRequest | null>(null)\n    const [rejectReason, setRejectReason] = useState('')\n    const [processing, setProcessing] = useState(false)\n\n    const loadData = useCallback(async () => {\n        setLoading(true)\n        try {\n            const [requestsData, countsData] = await Promise.all([\n                filter === 'pending'\n                    ? window.electronAPI.getPendingApprovals()\n                    : window.electronAPI.getAllApprovals(),\n                window.electronAPI.getApprovalCounts()\n            ])\n            setRequests(requestsData as ApprovalRequest[])\n            setCounts(countsData as ApprovalCounts)\n        } catch (error) {\n            console.error('Failed to load approvals:', error)\n        } finally {\n            setLoading(false)\n        }\n    }, [filter])\n\n    useEffect(() => {\n        void loadData()\n    }, [loadData])\n\n    const handleApprove = async (request: ApprovalRequest) => {\n        if (!user) {return}\n        setProcessing(true)\n        try {\n            const result = await window.electronAPI.approveRequest(request.id, user.id)\n            if (result.success) {\n                void loadData()\n            } else {\n                alert(result.errors?.join(', ') || 'Failed to approve')\n            }\n        } catch (error) {\n            console.error('Failed to approve:', error)\n        } finally {\n            setProcessing(false)\n        }\n    }\n\n    const handleReject = async () => {\n        if (!user || !selectedRequest) {return}\n        if (!rejectReason.trim()) {\n            alert('Please provide a reason for rejection')\n            return\n        }\n\n        setProcessing(true)\n        try {\n            const result = await window.electronAPI.rejectRequest(selectedRequest.id, user.id, rejectReason)\n            if (result.success) {\n                setShowRejectModal(false)\n                setRejectReason('')\n                setSelectedRequest(null)\n                void loadData()\n            } else {\n                alert(result.errors?.join(', ') || 'Failed to reject')\n            }\n        } catch (error) {\n            console.error('Failed to reject:', error)\n        } finally {\n            setProcessing(false)\n        }\n    }\n\n    const openRejectModal = (request: ApprovalRequest) => {\n        setSelectedRequest(request)\n        setShowRejectModal(true)\n    }\n\n    return (\n        <div className=\"space-y-8 pb-10\">\n            <PageHeader\n                title=\"Approval Requests\"\n                subtitle=\"Review and manage pending approvals\"\n                breadcrumbs={[{ label: 'Finance' }, { label: 'Approvals' }]}\n            />\n\n            {/* Summary Cards */}\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                <StatCard\n                    label=\"Pending\"\n                    value={counts.pending.toString()}\n                    icon={Clock}\n                    color=\"from-amber-500/20 to-orange-500/20 text-amber-400\"\n                />\n                <StatCard\n                    label=\"Approved\"\n                    value={counts.approved.toString()}\n                    icon={CheckCircle}\n                    color=\"from-green-500/20 to-emerald-500/20 text-green-400\"\n                />\n                <StatCard\n                    label=\"Rejected\"\n                    value={counts.rejected.toString()}\n                    icon={XCircle}\n                    color=\"from-red-500/20 to-rose-500/20 text-red-400\"\n                />\n            </div>\n\n            {/* Filter Tabs */}\n            <div className=\"flex gap-2\">\n                <button\n                    onClick={() => setFilter('pending')}\n                    className={`px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300 ${filter === 'pending'\n                        ? 'bg-primary text-primary-foreground shadow-lg'\n                        : 'bg-secondary/30 text-foreground/60 hover:bg-secondary/50 hover:text-foreground'\n                        }`}\n                >\n                    Pending Only\n                </button>\n                <button\n                    onClick={() => setFilter('all')}\n                    className={`px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300 ${filter === 'all'\n                        ? 'bg-primary text-primary-foreground shadow-lg'\n                        : 'bg-secondary/30 text-foreground/60 hover:bg-secondary/50 hover:text-foreground'\n                        }`}\n                >\n                    All Requests\n                </button>\n            </div>\n\n            {/* Requests List */}\n            <div className=\"space-y-4\">\n                {loading ? (\n                    [1, 2, 3].map(i => (\n                        <div key={i} className=\"h-24 bg-secondary/30 animate-pulse rounded-xl\" />\n                    ))\n                ) : requests.length === 0 ? (\n                    <div className=\"text-center py-16 text-foreground/40\">\n                        No approval requests found\n                    </div>\n                ) : (\n                    requests.map(request => {\n                        const config = statusConfig[request.status]\n                        const Icon = config.icon\n\n                        return (\n                            <div\n                                key={request.id}\n                                className=\"premium-card flex items-center justify-between\"\n                            >\n                                <div className=\"flex items-center gap-4\">\n                                    <div className=\"p-3 rounded-xl bg-gradient-to-br from-blue-500/20 to-indigo-500/20 text-blue-400\">\n                                        <FileText className=\"w-5 h-5\" />\n                                    </div>\n\n                                    <div>\n                                        <div className=\"flex items-center gap-2 mb-1\">\n                                            <h3 className=\"font-bold text-foreground\">{request.entity_description || `${request.entity_type} #${request.entity_id}`}</h3>\n                                            <Badge variant={config.variant} icon={Icon}>\n                                                {config.label}\n                                            </Badge>\n                                        </div>\n                                        <p className=\"text-sm text-foreground/50\">\n                                            {request.workflow_name}  Requested by {request.requester_name}  {formatDate(request.created_at)}\n                                        </p>\n                                        {request.approver_name && (\n                                            <p className=\"text-xs text-foreground/40 mt-1\">\n                                                {request.status === 'APPROVED' ? 'Approved' : 'Rejected'} by {request.approver_name}\n                                            </p>\n                                        )}\n                                    </div>\n                                </div>\n\n                                {request.status === 'PENDING' && (\n                                    <div className=\"flex items-center gap-2\">\n                                        <button\n                                            onClick={() => openRejectModal(request)}\n                                            disabled={processing}\n                                            className=\"btn btn-secondary text-red-400 hover:bg-red-500/10 flex items-center gap-1\"\n                                        >\n                                            <XCircle className=\"w-4 h-4\" />\n                                            Reject\n                                        </button>\n                                        <button\n                                            onClick={() => handleApprove(request)}\n                                            disabled={processing}\n                                            className=\"btn btn-primary flex items-center gap-1\"\n                                        >\n                                            <CheckCircle className=\"w-4 h-4\" />\n                                            Approve\n                                        </button>\n                                    </div>\n                                )}\n\n                                {request.status !== 'PENDING' && (\n                                    <ChevronRight className=\"w-5 h-5 text-foreground/30\" />\n                                )}\n                            </div>\n                        )\n                    })\n                )}\n            </div>\n\n            {/* Reject Modal */}\n            <Modal\n                isOpen={showRejectModal}\n                onClose={() => setShowRejectModal(false)}\n                title=\"Reject Request\"\n            >\n                <div className=\"space-y-4\">\n                    <p className=\"text-foreground/70\">\n                        Please provide a reason for rejecting this request:\n                    </p>\n                    <textarea\n                        value={rejectReason}\n                        onChange={(e) => setRejectReason(e.target.value)}\n                        placeholder=\"Reason for rejection...\"\n                        rows={4}\n                        className=\"w-full bg-secondary/30 border border-border/20 rounded-lg px-4 py-3 text-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none transition-all\"\n                    />\n                    <div className=\"flex justify-end gap-3\">\n                        <button\n                            onClick={() => setShowRejectModal(false)}\n                            className=\"btn btn-secondary\"\n                        >\n                            Cancel\n                        </button>\n                        <button\n                            onClick={handleReject}\n                            disabled={processing || !rejectReason.trim()}\n                            className=\"btn bg-red-600 text-white hover:bg-red-700\"\n                        >\n                            {processing ? 'Rejecting...' : 'Reject'}\n                        </button>\n                    </div>\n                </div>\n            </Modal>\n        </div>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Attendance\\index.tsx","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":239,"column":21,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":278,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n    CheckCircle, XCircle, Clock, AlertCircle, Users, Save, Loader2\n} from 'lucide-react'\nimport { useState, useEffect, useCallback, type ElementType } from 'react'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\nimport { StatCard } from '../../components/patterns/StatCard'\nimport { Select } from '../../components/ui/Select'\nimport { Tooltip } from '../../components/ui/Tooltip'\nimport { useAppStore, useAuthStore } from '../../stores'\n\ntype AttendanceStatus = 'PRESENT' | 'ABSENT' | 'LATE' | 'EXCUSED'\n\ninterface StudentEntry {\n    student_id: number\n    student_name: string\n    admission_number: string\n    status: AttendanceStatus\n    notes: string\n}\n\ninterface Stream {\n    id: number\n    stream_name: string\n}\n\nexport default function Attendance() {\n    const { currentAcademicYear, currentTerm } = useAppStore()\n    const { user } = useAuthStore()\n\n    const [streams, setStreams] = useState<Stream[]>([])\n    const [selectedStream, setSelectedStream] = useState<number>(0)\n    const [selectedDate, setSelectedDate] = useState(new Date().toISOString().slice(0, 10))\n    const [students, setStudents] = useState<StudentEntry[]>([])\n    const [loading, setLoading] = useState(false)\n    const [saving, setSaving] = useState(false)\n    const [summary, setSummary] = useState({ present: 0, absent: 0, late: 0, excused: 0, total: 0 })\n\n    const updateSummary = (statuses: AttendanceStatus[]) => {\n        setSummary({\n            present: statuses.filter(s => s === 'PRESENT').length,\n            absent: statuses.filter(s => s === 'ABSENT').length,\n            late: statuses.filter(s => s === 'LATE').length,\n            excused: statuses.filter(s => s === 'EXCUSED').length,\n            total: statuses.length\n        })\n    }\n\n    const loadStreams = async () => {\n        try {\n            const data = await window.electronAPI.getStreams()\n            setStreams(data)\n        } catch (error) {\n            console.error('Failed to load streams:', error)\n        }\n    }\n\n    const loadStudents = useCallback(async () => {\n        if (!currentAcademicYear || !currentTerm) {return}\n        setLoading(true)\n        try {\n            // Get enrolled students\n            const enrolled = await window.electronAPI.getStudentsForAttendance(\n                selectedStream, currentAcademicYear.id, currentTerm.id\n            )\n\n            // Get existing attendance for this date\n            const existing = await window.electronAPI.getAttendanceByDate(\n                selectedStream, selectedDate, currentAcademicYear.id, currentTerm.id\n            )\n\n            // Map students with their existing status or default to PRESENT\n            const existingMap = new Map(existing.map((e) => [e.student_id, e]))\n\n            setStudents(enrolled.map((s) => {\n                const ex = existingMap.get(s.student_id)\n                return {\n                    student_id: s.student_id,\n                    student_name: s.student_name,\n                    admission_number: s.admission_number,\n                    status: ex?.status || 'PRESENT',\n                    notes: ex?.notes || ''\n                }\n            }))\n\n            // Update summary\n            updateSummary(enrolled.map((s) => {\n                const ex = existingMap.get(s.student_id)\n                return ex?.status || 'PRESENT'\n            }))\n        } catch (error) {\n            console.error('Failed to load students:', error)\n        } finally {\n            setLoading(false)\n        }\n    }, [selectedStream, selectedDate, currentAcademicYear, currentTerm])\n\n    useEffect(() => {\n        void loadStreams()\n    }, [])\n\n    useEffect(() => {\n        if (selectedStream && currentAcademicYear && currentTerm) {\n            void loadStudents()\n        }\n    }, [selectedStream, selectedDate, currentAcademicYear, currentTerm, loadStudents])\n\n    const setStatus = (studentId: number, status: AttendanceStatus) => {\n        setStudents(prev => {\n            const updated = prev.map(s =>\n                s.student_id === studentId ? { ...s, status } : s\n            )\n            updateSummary(updated.map(s => s.status))\n            return updated\n        })\n    }\n\n    const markAllAs = (status: AttendanceStatus) => {\n        setStudents(prev => {\n            const updated = prev.map(s => ({ ...s, status }))\n            updateSummary(updated.map(s => s.status))\n            return updated\n        })\n    }\n\n    const handleSave = async () => {\n        if (!currentAcademicYear || !currentTerm || !user) {return}\n\n        setSaving(true)\n        try {\n            const entries = students.map(s => ({\n                student_id: s.student_id,\n                status: s.status,\n                notes: s.notes || undefined\n            }))\n\n            const result = await window.electronAPI.markAttendance(\n                entries, selectedStream, selectedDate, currentAcademicYear.id, currentTerm.id, user.id\n            )\n\n            if (result.success) {\n                alert(`Attendance saved for ${result.marked} students!`)\n            } else {\n                alert('Failed to save: ' + (result.errors?.join(', ') || 'Unknown error'))\n            }\n        } catch (error) {\n            console.error('Failed to save attendance:', error)\n            alert('Failed to save attendance')\n        } finally {\n            setSaving(false)\n        }\n    }\n\n    const statusButtons: { status: AttendanceStatus; icon: ElementType; label: string; color: string }[] = [\n        { status: 'PRESENT', icon: CheckCircle, label: 'P', color: 'bg-green-500/20 text-green-400 border-green-500/30' },\n        { status: 'ABSENT', icon: XCircle, label: 'A', color: 'bg-red-500/20 text-red-400 border-red-500/30' },\n        { status: 'LATE', icon: Clock, label: 'L', color: 'bg-amber-500/20 text-amber-400 border-amber-500/30' },\n        { status: 'EXCUSED', icon: AlertCircle, label: 'E', color: 'bg-blue-500/20 text-blue-400 border-blue-500/30' },\n    ]\n\n    return (\n        <div className=\"space-y-8 pb-10\">\n            <PageHeader\n                title=\"Attendance\"\n                subtitle=\"Mark daily student attendance\"\n                breadcrumbs={[{ label: 'Students' }, { label: 'Attendance' }]}\n                actions={\n                    <button\n                        type=\"button\"\n                        onClick={handleSave}\n                        disabled={saving || students.length === 0}\n                        className=\"btn btn-primary flex items-center gap-2\"\n                    >\n                        {saving ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Save className=\"w-4 h-4\" />}\n                        Save Attendance\n                    </button>\n                }\n            />\n\n            {/* Summary Stats */}\n            <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4\">\n                <StatCard label=\"Total\" value={summary.total.toString()} icon={Users} color=\"from-slate-500/20 to-gray-500/20 text-slate-500\" />\n                <StatCard label=\"Present\" value={summary.present.toString()} icon={CheckCircle} color=\"from-green-500/20 to-emerald-500/20 text-green-500\" />\n                <StatCard label=\"Absent\" value={summary.absent.toString()} icon={XCircle} color=\"from-red-500/20 to-rose-500/20 text-red-500\" />\n                <StatCard label=\"Late\" value={summary.late.toString()} icon={Clock} color=\"from-amber-500/20 to-orange-500/20 text-amber-500\" />\n                <StatCard label=\"Excused\" value={summary.excused.toString()} icon={AlertCircle} color=\"from-blue-500/20 to-indigo-500/20 text-blue-500\" />\n            </div>\n\n            {/* Filters */}\n            <div className=\"premium-card\">\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <Select\n                        label=\"Class\"\n                        value={selectedStream}\n                        onChange={(val) => setSelectedStream(Number(val))}\n                        options={[\n                            { value: 0, label: 'Select class...' },\n                            ...streams.map(s => ({ value: s.id, label: s.stream_name }))\n                        ]}\n                        className=\"w-full\"\n                    />\n                    <div className=\"space-y-2\">\n                        <label htmlFor=\"field-203\" className=\"text-sm font-bold text-foreground/60\">Date</label>\n                        <input id=\"field-203\"\n                            type=\"date\"\n                            title=\"Attendance Date\"\n                            placeholder=\"Select date\"\n                            value={selectedDate}\n                            onChange={(e) => setSelectedDate(e.target.value)}\n                            className=\"w-full bg-secondary/30 border border-border/40 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-primary/50 text-foreground\"\n                        />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <p className=\"text-sm font-bold text-foreground/60\">Quick Actions</p>\n                        <div className=\"flex gap-2\">\n                            {statusButtons.map(btn => (\n                                <Tooltip\n                                    key={btn.status}\n                                    content={`Mark all as ${btn.status.charAt(0) + btn.status.slice(1).toLowerCase()}`}\n                                >\n                                    <button\n                                        type=\"button\"\n                                        onClick={() => markAllAs(btn.status)}\n                                        className={`w-full py-2 rounded-lg text-xs font-bold border ${btn.color} hover:opacity-80 transition-opacity`}\n                                    >\n                                        All {btn.label}\n                                    </button>\n                                </Tooltip>\n                            ))}\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            {/* Students List */}\n            <div className=\"premium-card\">\n                {loading ? (\n                    <div className=\"text-center py-16 text-foreground/40\">Loading students...</div>\n                ) : students.length === 0 ? (\n                    <div className=\"text-center py-16 text-foreground/40\">\n                        {selectedStream ? 'No students found' : 'Select a class to mark attendance'}\n                    </div>\n                ) : (\n                    <div className=\"space-y-2\">\n                        {students.map(student => (\n                            <div key={student.student_id} className=\"flex items-center justify-between p-4 bg-secondary/10 rounded-xl border border-border/30 hover:border-primary/20 transition-all duration-300\">\n                                <div>\n                                    <p className=\"font-bold text-foreground\">{student.student_name}</p>\n                                    <p className=\"text-xs text-foreground/40 font-mono\">{student.admission_number}</p>\n                                </div>\n                                <div className=\"flex gap-2\">\n                                    {statusButtons.map(btn => {\n                                        const isActive = student.status === btn.status\n                                        const Icon = btn.icon\n                                        return (\n                                            <Tooltip\n                                                key={btn.status}\n                                                content={`Mark as ${btn.status.charAt(0) + btn.status.slice(1).toLowerCase()}`}\n                                            >\n                                                <button\n                                                    onClick={() => setStatus(student.student_id, btn.status)}\n                                                    title={`Mark as ${btn.status}`}\n                                                    aria-label={`Mark as ${btn.status}`}\n                                                    className={`w-10 h-10 rounded-lg border flex items-center justify-center transition-all ${isActive\n                                                        ? btn.color + ' scale-110 shadow-lg'\n                                                        : 'bg-secondary/40 border-border/20 text-foreground/30 hover:bg-secondary/60 hover:text-foreground/60'\n                                                        }`}\n                                                >\n                                                    <Icon className=\"w-4 h-4\" />\n                                                </button>\n                                            </Tooltip>\n                                        )\n                                    })}\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                )}\n            </div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\AuditLog\\index.tsx","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":99,"column":21,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":168,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Search, Loader2, History, Database, UserCheck, Activity } from 'lucide-react'\nimport { useEffect, useState, useCallback } from 'react'\n\nimport { useToast } from '../../contexts/ToastContext'\nimport { type AuditLogEntry } from '../../types/electron-api/AuditAPI'\nimport { formatDateTime } from '../../utils/format'\n\nexport default function AuditLog() {\n    const { showToast } = useToast()\n    const [logs, setLogs] = useState<AuditLogEntry[]>([])\n    const [loading, setLoading] = useState(true)\n    const [filter, setFilter] = useState({ action: '', table: '', search: '' })\n\n    const loadLogs = useCallback(async () => {\n        setLoading(true)\n        try {\n            const data = await window.electronAPI.getAuditLog(200)\n            setLogs(data)\n        } catch (error) {\n            console.error('Failed to load audit logs:', error)\n            showToast('Audit synchronization failed', 'error')\n        } finally { setLoading(false) }\n    }, [showToast])\n\n    useEffect(() => { void loadLogs() }, [loadLogs])\n\n    const actionColors: Record<string, string> = {\n        CREATE: 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20',\n        UPDATE: 'bg-blue-500/10 text-blue-500 border-blue-500/20',\n        DELETE: 'bg-destructive/10 text-destructive border-destructive/20',\n        LOGIN: 'bg-purple-500/10 text-purple-500 border-purple-500/20',\n        VOID: 'bg-orange-500/10 text-orange-500 border-orange-500/20',\n    }\n\n    const filteredLogs = logs.filter(log => {\n        const matchAction = !filter.action || log.action_type === filter.action\n        const matchTable = !filter.table || log.table_name === filter.table\n        const matchSearch = !filter.search ||\n            log.user_name?.toLowerCase().includes(filter.search.toLowerCase()) ||\n            String(log.record_id).includes(filter.search)\n        return matchAction && matchTable && matchSearch\n    })\n\n    return (\n        <div className=\"space-y-8 pb-10\">\n            <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-6\">\n                <div>\n                    <h1 className=\"text-3xl font-bold text-foreground font-heading uppercase tracking-tight\">Audit Log</h1>\n                    <p className=\"text-foreground/50 mt-1 font-medium italic\">Comprehensive system-wide change tracking and security oversight</p>\n                </div>\n                <div className=\"flex items-center gap-3 bg-secondary/20 p-2 rounded-xl border border-border/20\">\n                    <Activity className=\"w-5 h-5 text-primary opacity-60\" />\n                    <span className=\"text-[10px] font-bold uppercase tracking-widest text-foreground/40 pr-2\">Live Monitoring Active</span>\n                </div>\n            </div>\n\n            <div className=\"premium-card animate-slide-up\">\n                <div className=\"flex flex-wrap items-center gap-6\">\n                    <div className=\"relative flex-1 min-w-[300px] group\">\n                        <Search className=\"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-foreground/20 group-focus-within:text-primary transition-colors\" />\n                        <input type=\"text\" placeholder=\"Search by user or record ID...\"\n                            aria-label=\"Search logs\"\n                            value={filter.search}\n                            onChange={(e) => setFilter(prev => ({ ...prev, search: e.target.value }))}\n                            className=\"input w-full pl-12 bg-secondary/30 h-12\" />\n                    </div>\n\n                    <div className=\"flex items-center gap-4\">\n                        <select value={filter.action} onChange={(e) => setFilter(prev => ({ ...prev, action: e.target.value }))}\n                            aria-label=\"Filter by action\"\n                            className=\"input w-44 bg-secondary/30 h-12\">\n                            <option value=\"\">All Actions</option>\n                            <option value=\"CREATE\">Create</option>\n                            <option value=\"UPDATE\">Update</option>\n                            <option value=\"DELETE\">Delete</option>\n                            <option value=\"LOGIN\">Login</option>\n                            <option value=\"VOID\">Void</option>\n                        </select>\n                        <select value={filter.table} onChange={(e) => setFilter(prev => ({ ...prev, table: e.target.value }))}\n                            aria-label=\"Filter by table\"\n                            className=\"input w-44 bg-secondary/30 h-12\">\n                            <option value=\"\">All Tables</option>\n                            <option value=\"student\">Students</option>\n                            <option value=\"ledger_transaction\">Transactions</option>\n                            <option value=\"user\">Users</option>\n                            <option value=\"fee_invoice\">Invoices</option>\n                            <option value=\"inventory_item\">Inventory</option>\n                        </select>\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"card overflow-hidden\">\n                {loading ? (\n                    <div className=\"flex flex-col items-center justify-center py-24 gap-4\">\n                        <Loader2 className=\"w-10 h-10 text-primary animate-spin\" />\n                        <p className=\"text-xs font-bold uppercase tracking-widest text-foreground/40\">Fetching History...</p>\n                    </div>\n                ) : filteredLogs.length === 0 ? (\n                    <div className=\"text-center py-24 bg-secondary/5 rounded-3xl border border-dashed border-border/40 m-4\">\n                        <History className=\"w-16 h-16 text-foreground/10 mx-auto mb-4\" />\n                        <h3 className=\"text-xl font-bold text-foreground/80 font-heading\">No Historical Data</h3>\n                        <p className=\"text-foreground/40 font-medium italic\">No system events matched the active filtering parameters</p>\n                    </div>\n                ) : (\n                    <div className=\"overflow-x-auto\">\n                        <table className=\"data-table\">\n                            <thead>\n                                <tr className=\"border-b border-border/40\">\n                                    <th className=\"py-5 font-bold uppercase tracking-widest text-[10px] text-foreground/40\">Chronology</th>\n                                    <th className=\"py-5 font-bold uppercase tracking-widest text-[10px] text-foreground/40\">Operator</th>\n                                    <th className=\"py-5 font-bold uppercase tracking-widest text-[10px] text-foreground/40 text-center\">Protocol</th>\n                                    <th className=\"py-5 font-bold uppercase tracking-widest text-[10px] text-foreground/40\">Data Entity</th>\n                                    <th className=\"py-5 font-bold uppercase tracking-widest text-[10px] text-foreground/40\">Record Identity</th>\n                                    <th className=\"py-5 font-bold uppercase tracking-widest text-[10px] text-foreground/40\">Payload Differential</th>\n                                </tr>\n                            </thead>\n                            <tbody className=\"divide-y divide-border/10\">\n                                {filteredLogs.map((log) => (\n                                    <tr key={log.id} className=\"group hover:bg-secondary/20 transition-colors\">\n                                        <td className=\"py-4\">\n                                            <div className=\"flex items-center gap-2 text-foreground/60 text-sm font-medium\">\n                                                <History className=\"w-3.5 h-3.5 opacity-40\" />\n                                                {formatDateTime(log.created_at)}\n                                            </div>\n                                        </td>\n                                        <td className=\"py-4\">\n                                            <div className=\"flex items-center gap-2\">\n                                                <UserCheck className=\"w-4 h-4 text-primary opacity-40\" />\n                                                <span className=\"font-bold text-foreground/80\">{log.user_name || 'Automated System'}</span>\n                                            </div>\n                                        </td>\n                                        <td className=\"py-4 text-center\">\n                                            <span className={`px-3 py-1.5 rounded-lg text-[10px] font-bold tracking-widest border inline-block min-w-[100px] ${actionColors[log.action_type] || 'bg-secondary/50 text-foreground/50 border-border/40'\n                                                }`}>\n                                                {log.action_type}\n                                            </span>\n                                        </td>\n                                        <td className=\"py-4\">\n                                            <div className=\"flex items-center gap-2\">\n                                                <Database className=\"w-3.5 h-3.5 text-foreground/20\" />\n                                                <span className=\"font-mono text-sm text-foreground/50 uppercase tracking-tight\">{log.table_name}</span>\n                                            </div>\n                                        </td>\n                                        <td className=\"py-4\">\n                                            <span className=\"font-mono text-xs text-foreground/40\">{log.record_id || 'N/A'}</span>\n                                        </td>\n                                        <td className=\"py-4 max-w-xs\">\n                                            <div className=\"bg-secondary/30 p-2 rounded-lg border border-border/20 group-hover:border-primary/20 transition-colors\">\n                                                <p className=\"font-mono text-[10px] text-foreground/50 truncate italic\">\n                                                    {(() => {\n                                                        try {\n                                                            if (!log.new_values) {return 'No mutation data'}\n                                                            const parsed = JSON.parse(log.new_values)\n                                                            return JSON.stringify(parsed)\n                                                        } catch {\n                                                            return log.new_values\n                                                        }\n                                                    })()}\n                                                </p>\n                                            </div>\n                                        </td>\n                                    </tr>\n                                ))}\n                            </tbody>\n                        </table>\n                    </div>\n                )}\n            </div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Backup\\index.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Communications\\CommunicationLog.tsx","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":144,"column":35,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":144,"endColumn":128},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":158,"column":21,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":220,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n    MessageSquare, Mail, CheckCircle, XCircle\n} from 'lucide-react'\nimport { useState, useEffect, useCallback } from 'react'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\nimport { StatCard } from '../../components/patterns/StatCard'\n\ninterface LogEntry {\n    id: number\n    recipient_type: string\n    recipient_id?: number\n    message_type: 'SMS' | 'EMAIL'\n    subject?: string | null\n    message_body: string\n    status: 'SENT' | 'FAILED' | 'PENDING'\n    error_message?: string | null\n    sent_by_name?: string\n    created_at: string\n}\n\nexport default function CommunicationLog() {\n    const [logs, setLogs] = useState<LogEntry[]>([])\n    const [loading, setLoading] = useState(true)\n    const [stats, setStats] = useState({ total: 0, sent: 0, failed: 0, sms: 0, email: 0 })\n\n    // Filters\n    const [typeFilter, setTypeFilter] = useState<'ALL' | 'SMS' | 'EMAIL'>('ALL')\n    const [statusFilter, setStatusFilter] = useState<'ALL' | 'SENT' | 'FAILED'>('ALL')\n\n    const [searchQuery, setSearchQuery] = useState('');\n    const [dateRange, setDateRange] = useState({ start: '', end: '' });\n\n\n    const loadLogs = useCallback(async () => {\n        setLoading(true)\n        try {\n            // Use existing getMessageLogs API which takes a limit parameter\n            const data = await window.electronAPI.getMessageLogs(100)\n\n            // Apply client-side filtering since the API doesn't support it\n            let filteredData = data || []\n\n            if (typeFilter !== 'ALL') {\n                filteredData = filteredData.filter((l: LogEntry) => l.message_type === typeFilter)\n            }\n            if (statusFilter !== 'ALL') {\n                filteredData = filteredData.filter((l: LogEntry) => l.status === statusFilter)\n            }\n            if (searchQuery) {\n                const query = searchQuery.toLowerCase()\n                filteredData = filteredData.filter((l: LogEntry) =>\n                    l.message_body?.toLowerCase().includes(query) ||\n                    l.subject?.toLowerCase().includes(query)\n                )\n            }\n\n            setLogs(filteredData)\n            calculateStats(filteredData)\n        } catch (error) {\n            console.error('Failed to load communication logs:', error)\n            setLogs([])\n        } finally {\n            setLoading(false)\n        }\n    }, [typeFilter, statusFilter, searchQuery])\n\n    useEffect(() => {\n        void loadLogs()\n    }, [loadLogs])\n\n\n    const calculateStats = (data: LogEntry[]) => {\n        setStats({\n            total: data.length,\n            sent: data.filter(l => l.status === 'SENT').length,\n            failed: data.filter(l => l.status === 'FAILED').length,\n            sms: data.filter(l => l.message_type === 'SMS').length,\n            email: data.filter(l => l.message_type === 'EMAIL').length\n        })\n    }\n\n    return (\n        <div className=\"space-y-8 pb-10\">\n            <PageHeader\n                title=\"Communication Log\"\n                subtitle=\"History of sent SMS and Email notifications\"\n                breadcrumbs={[{ label: 'Communications' }, { label: 'Logs' }]}\n            />\n\n            {/* Stats */}\n            <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4\">\n                <StatCard label=\"Total Messages\" value={stats.total.toString()} icon={MessageSquare} color=\"from-blue-500/20 to-indigo-500/20 text-blue-400\" compact />\n                <StatCard label=\"Sent\" value={stats.sent.toString()} icon={CheckCircle} color=\"from-green-500/20 to-emerald-500/20 text-green-400\" compact />\n                <StatCard label=\"Failed\" value={stats.failed.toString()} icon={XCircle} color=\"from-red-500/20 to-rose-500/20 text-red-400\" compact />\n                <StatCard label=\"SMS\" value={stats.sms.toString()} icon={MessageSquare} color=\"from-amber-500/20 to-orange-500/20 text-amber-400\" compact />\n                <StatCard label=\"Emails\" value={stats.email.toString()} icon={Mail} color=\"from-purple-500/20 to-pink-500/20 text-purple-400\" compact />\n            </div>\n\n            <div className=\"flex flex-col md:flex-row gap-4 justify-between items-center premium-card p-4\">\n                <div className=\"flex gap-4 w-full md:w-auto\">\n                    <input\n                        type=\"text\"\n                        placeholder=\"Search logs...\"\n                        value={searchQuery}\n                        onChange={(e) => setSearchQuery(e.target.value)}\n                        className=\"px-3 py-1.5 bg-background/50 border border-white/10 rounded-md text-sm w-full md:w-64\"\n                    />\n                    <input\n                        type=\"date\"\n                        value={dateRange.start}\n                        onChange={(e) => setDateRange(prev => ({ ...prev, start: e.target.value }))}\n                        className=\"px-3 py-1.5 bg-background/50 border border-white/10 rounded-md text-sm\"\n                    />\n                    <input\n                        type=\"date\"\n                        value={dateRange.end}\n                        onChange={(e) => setDateRange(prev => ({ ...prev, end: e.target.value }))}\n                        className=\"px-3 py-1.5 bg-background/50 border border-white/10 rounded-md text-sm\"\n                    />\n                </div>\n            </div>\n\n            {/* Filters */}\n            <div className=\"flex gap-4\">\n                <div className=\"flex bg-secondary/30 border border-border/20 rounded-lg p-1\">\n                    {(['ALL', 'SMS', 'EMAIL'] as const).map(type => (\n                        <button\n                            key={type}\n                            onClick={() => setTypeFilter(type)}\n                            className={`px-4 py-1.5 rounded-md text-sm font-bold transition-all duration-300 ${typeFilter === type ? 'bg-primary text-primary-foreground shadow-lg' : 'text-foreground/60 hover:text-foreground'\n                                }`}\n                        >\n                            {type}\n                        </button>\n                    ))}\n                </div>\n                <div className=\"flex bg-secondary/30 border border-border/20 rounded-lg p-1\">\n                    {(['ALL', 'SENT', 'FAILED'] as const).map(status => (\n                        <button\n                            key={status}\n                            onClick={() => setStatusFilter(status)}\n                            className={`px-4 py-1.5 rounded-md text-sm font-bold transition-all duration-300 ${statusFilter === status\n                                ? status === 'FAILED' ? 'bg-red-500 text-white shadow-lg' : 'bg-green-500 text-white shadow-lg'\n                                : 'text-foreground/60 hover:text-foreground'\n                                }`}\n                        >\n                            {status === 'ALL' ? 'All Status' : status}\n                        </button>\n                    ))}\n                </div>\n            </div>\n\n            {/* Logs Table */}\n            <div className=\"premium-card\">\n                {loading ? (\n                    <div className=\"text-center py-16 text-foreground/40\">Loading history...</div>\n                ) : logs.length === 0 ? (\n                    <div className=\"text-center py-16 text-foreground/40\">No communication history found</div>\n                ) : (\n                    <div className=\"overflow-x-auto\">\n                        <table className=\"w-full\">\n                            <thead>\n                                <tr className=\"text-xs font-bold text-foreground/40 uppercase border-b border-border/20\">\n                                    <th className=\"text-left py-3 px-4\">Time</th>\n                                    <th className=\"text-left py-3 px-4\">Channel</th>\n                                    <th className=\"text-left py-3 px-4\">Recipient</th>\n                                    <th className=\"text-left py-3 px-4\">Message</th>\n                                    <th className=\"text-left py-3 px-4\">Status</th>\n                                    <th className=\"text-left py-3 px-4\">Sent By</th>\n                                </tr>\n                            </thead>\n                            <tbody className=\"divide-y divide-border/20\">\n                                {logs.map(log => (\n                                    <tr key={log.id} className=\"hover:bg-secondary/40 transition-colors duration-200\">\n                                        <td className=\"py-3 px-4 text-sm font-mono text-foreground/60 whitespace-nowrap\">\n                                            {new Date(log.created_at).toLocaleString()}\n                                        </td>\n                                        <td className=\"py-3 px-4\">\n                                            <span className={`inline-flex items-center gap-1.5 px-2 py-1 rounded text-xs font-bold ${log.message_type === 'SMS'\n                                                ? 'bg-amber-500/10 text-amber-400 border border-amber-500/20'\n                                                : 'bg-purple-500/10 text-purple-400 border border-purple-500/20'\n                                                }`}>\n                                                {log.message_type === 'SMS' ? <MessageSquare className=\"w-3 h-3\" /> : <Mail className=\"w-3 h-3\" />}\n                                                {log.message_type}\n                                            </span>\n                                        </td>\n                                        <td className=\"py-3 px-4 text-sm\">\n                                            <div className=\"font-bold text-foreground\">{log.recipient_type}</div>\n                                            <div className=\"text-xs text-foreground/50\">ID: {log.recipient_id}</div>\n                                        </td>\n                                        <td className=\"py-3 px-4 text-sm max-w-md\">\n                                            {log.subject && (\n                                                <div className=\"font-bold text-foreground mb-1\">{log.subject}</div>\n                                            )}\n                                            <div className=\"text-foreground/70 line-clamp-2\">{log.message_body}</div>\n                                            {log.error_message && (\n                                                <div className=\"text-red-400 text-xs mt-1\">{log.error_message}</div>\n                                            )}\n                                        </td>\n                                        <td className=\"py-3 px-4\">\n                                            {log.status === 'SENT' ? (\n                                                <span className=\"inline-flex items-center gap-1 text-green-400 text-xs font-bold\">\n                                                    <CheckCircle className=\"w-3 h-3\" /> Sent\n                                                </span>\n                                            ) : (\n                                                <span className=\"inline-flex items-center gap-1 text-red-400 text-xs font-bold\">\n                                                    <XCircle className=\"w-3 h-3\" /> Failed\n                                                </span>\n                                            )}\n                                        </td>\n                                        <td className=\"py-3 px-4 text-sm text-foreground/60\">\n                                            {log.sent_by_name}\n                                        </td>\n                                    </tr>\n                                ))}\n                            </tbody>\n                        </table>\n                    </div>\n                )}\n            </div>\n        </div>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Dashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Approvals\\ApprovalQueue.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getStatusBadge' to the outer scope.","line":109,"column":43,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":109,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { format } from 'date-fns';\nimport { useState, useEffect, useCallback } from 'react';\n\nimport { useAuthStore } from '../../../stores';\nimport { formatCurrencyFromCents } from '../../../utils/format';\n\ninterface ApprovalRequest {\n  id: number;\n  journal_entry_id: number;\n  entry_ref: string;\n  entry_type: string;\n  description: string;\n  amount: number;\n  student_name?: string;\n  requested_by_name: string;\n  requested_at: string;\n  rule_name: string;\n  status: 'PENDING' | 'APPROVED' | 'REJECTED';\n}\n\nexport default function ApprovalQueuePage() {\n  const { user } = useAuthStore();\n  const [approvals, setApprovals] = useState<ApprovalRequest[]>([]);\n  const [filter, setFilter] = useState<'PENDING' | 'ALL'>('PENDING');\n  const [loading, setLoading] = useState<boolean>(false);\n  const [error, setError] = useState<string | null>(null);\n  const [selectedApproval, setSelectedApproval] = useState<ApprovalRequest | null>(null);\n  const [reviewNotes, setReviewNotes] = useState<string>('');\n\n  const loadApprovals = useCallback(async () => {\n    setLoading(true);\n    setError(null);\n\n    try {\n      const result = await window.electronAPI.getApprovalQueue(filter);\n\n      if (result.success) {\n        setApprovals(result.data);\n      } else {\n        setError(result.message || 'Failed to load approvals');\n      }\n    } catch (err) {\n      setError((err as Error).message);\n    } finally {\n      setLoading(false);\n    }\n  }, [filter]);\n\n  useEffect(() => {\n    void loadApprovals();\n  }, [loadApprovals]);\n\n  const handleApprove = async (approvalId: number) => {\n    if (!user?.id) {\n      setError('You must be signed in to approve transactions');\n      return;\n    }\n    try {\n      const result = await window.electronAPI.approveTransaction(\n        approvalId,\n        reviewNotes || 'Approved',\n        user.id\n      );\n\n      if (result.success) {\n        void loadApprovals();\n        setSelectedApproval(null);\n        setReviewNotes('');\n      } else {\n        setError(result.message || 'Approval failed');\n      }\n    } catch (err) {\n      setError((err as Error).message);\n    }\n  };\n\n  const handleReject = async (approvalId: number) => {\n    if (!reviewNotes) {\n      setError('Please provide a reason for rejection');\n      return;\n    }\n    if (!user?.id) {\n      setError('You must be signed in to reject transactions');\n      return;\n    }\n\n    try {\n      const result = await window.electronAPI.rejectTransaction(\n        approvalId,\n        reviewNotes,\n        user.id\n      );\n\n      if (result.success) {\n        void loadApprovals();\n        setSelectedApproval(null);\n        setReviewNotes('');\n      } else {\n        setError(result.message || 'Rejection failed');\n      }\n    } catch (err) {\n      setError((err as Error).message);\n    }\n  };\n\n\n\n\n  const getStatusBadge = (status: string) => {\n    const colors = {\n      PENDING: 'bg-yellow-100 text-yellow-800',\n      APPROVED: 'bg-green-100 text-green-800',\n      REJECTED: 'bg-red-100 text-red-800'\n    };\n    return colors[status as keyof typeof colors] || colors.PENDING;\n  };\n\n  if (loading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"text-gray-500\">Loading approvals...</div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 max-w-7xl mx-auto\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-3xl font-bold text-gray-900\">Approval Queue</h1>\n        <p className=\"text-gray-600 mt-1\">Review and approve pending transactions</p>\n      </div>\n\n      <div className=\"bg-white rounded-lg shadow p-4 mb-6\">\n        <div className=\"flex items-center gap-4\">\n          <label htmlFor=\"field-137\" className=\"text-sm font-medium text-gray-700\">Filter:</label>\n          <select id=\"field-137\"\n            value={filter}\n            onChange={(e) => setFilter(e.target.value as 'PENDING' | 'ALL')}\n            className=\"px-3 py-2 border border-gray-300 rounded-md\"\n            aria-label=\"Filter approval requests\"\n          >\n            <option value=\"PENDING\">Pending Only</option>\n            <option value=\"ALL\">All Requests</option>\n          </select>\n          <button\n            onClick={loadApprovals}\n            className=\"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700\"\n          >\n            Refresh\n          </button>\n          {approvals.filter(a => a.status === 'PENDING').length > 0 && (\n            <span className=\"ml-auto bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium\">\n              {approvals.filter(a => a.status === 'PENDING').length} Pending\n            </span>\n          )}\n        </div>\n      </div>\n\n      {error && (\n        <div className=\"bg-red-50 border border-red-200 rounded-lg p-4 mb-6\">\n          <p className=\"text-red-800\">{error}</p>\n        </div>\n      )}\n\n      {approvals.length === 0 ? (\n        <div className=\"bg-white rounded-lg shadow p-8 text-center\">\n          <div className=\"text-gray-500\">No approval requests found</div>\n        </div>\n      ) : (\n        <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n          <table className=\"w-full\">\n            <thead className=\"bg-gray-50 border-b\">\n              <tr>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Entry Ref</th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Type</th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Description</th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Amount</th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Rule</th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Requested By</th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Status</th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Actions</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-gray-200\">\n              {approvals.map((approval) => (\n                <tr key={approval.id} className=\"hover:bg-gray-50\">\n                  <td className=\"px-6 py-4 text-sm font-medium text-gray-900\">{approval.entry_ref}</td>\n                  <td className=\"px-6 py-4 text-sm text-gray-900\">{approval.entry_type}</td>\n                  <td className=\"px-6 py-4 text-sm text-gray-900 max-w-xs truncate\">\n                    {approval.description}\n                    {approval.student_name && (\n                      <div className=\"text-xs text-gray-500\">{approval.student_name}</div>\n                    )}\n                  </td>\n                  <td className=\"px-6 py-4 text-sm text-gray-900\">{formatCurrencyFromCents(approval.amount)}</td>\n                  <td className=\"px-6 py-4 text-sm text-gray-900\">{approval.rule_name}</td>\n                  <td className=\"px-6 py-4 text-sm text-gray-900\">\n                    {approval.requested_by_name}\n                    <div className=\"text-xs text-gray-500\">\n                      {format(new Date(approval.requested_at), 'MMM dd, HH:mm')}\n                    </div>\n                  </td>\n                  <td className=\"px-6 py-4 text-sm\">\n                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${getStatusBadge(approval.status)}`}>\n                      {approval.status}\n                    </span>\n                  </td>\n                  <td className=\"px-6 py-4 text-sm\">\n                    {approval.status === 'PENDING' && (\n                      <button\n                        onClick={() => setSelectedApproval(approval)}\n                        className=\"text-blue-600 hover:text-blue-800\"\n                      >\n                        Review\n                      </button>\n                    )}\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {/* Review Modal */}\n      {selectedApproval && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6\">\n            <h2 className=\"text-2xl font-bold mb-4\">Review Approval Request</h2>\n\n            <div className=\"space-y-3 mb-6\">\n              <div>\n                <span className=\"font-medium\">Entry Reference:</span> {selectedApproval.entry_ref}\n              </div>\n              <div>\n                <span className=\"font-medium\">Type:</span> {selectedApproval.entry_type}\n              </div>\n              <div>\n                <span className=\"font-medium\">Description:</span> {selectedApproval.description}\n              </div>\n              <div>\n                <span className=\"font-medium\">Amount:</span> {formatCurrencyFromCents(selectedApproval.amount)}\n              </div>\n              {selectedApproval.student_name && (\n                <div>\n                  <span className=\"font-medium\">Student:</span> {selectedApproval.student_name}\n                </div>\n              )}\n              <div>\n                <span className=\"font-medium\">Requested By:</span> {selectedApproval.requested_by_name}\n              </div>\n              <div>\n                <span className=\"font-medium\">Reason for Approval:</span> {selectedApproval.rule_name}\n              </div>\n            </div>\n\n            <div className=\"mb-6\">\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                Review Notes {selectedApproval.status === 'PENDING' && '(Required for rejection)'}\n              </label>\n              <textarea\n                value={reviewNotes}\n                onChange={(e) => setReviewNotes(e.target.value)}\n                rows={3}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md\"\n                placeholder=\"Enter your review notes...\"\n              />\n            </div>\n\n            <div className=\"flex gap-3\">\n              <button\n                onClick={() => handleApprove(selectedApproval.id)}\n                className=\"flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700\"\n              >\n                Approve\n              </button>\n              <button\n                onClick={() => handleReject(selectedApproval.id)}\n                className=\"flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700\"\n              >\n                Reject\n              </button>\n              <button\n                onClick={() => {\n                  setSelectedApproval(null);\n                  setReviewNotes('');\n                }}\n                className=\"px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50\"\n              >\n                Cancel\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\AssetHire.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getStatusColor' to the outer scope.","line":217,"column":45,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":217,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\n\nimport { useAuthStore } from '../../stores'\nimport { type HireBooking, type HireAsset, type HireClient, type HireStats } from '../../types/electron-api/HireAPI'\nimport { formatCurrencyFromCents, shillingsToCents, centsToShillings } from '../../utils/format'\nimport { printDocument } from '../../utils/print'\n\ntype TabType = 'bookings' | 'clients' | 'assets'\n\nexport default function AssetHire() {\n    const { user } = useAuthStore()\n    const [activeTab, setActiveTab] = useState<TabType>('bookings')\n    const [bookings, setBookings] = useState<HireBooking[]>([])\n    const [clients, setClients] = useState<HireClient[]>([])\n    const [assets, setAssets] = useState<HireAsset[]>([])\n    const [stats, setStats] = useState<HireStats | null>(null)\n    const [loading, setLoading] = useState(true)\n    const [showBookingModal, setShowBookingModal] = useState(false)\n    const [showClientModal, setShowClientModal] = useState(false)\n    const [showPaymentModal, setShowPaymentModal] = useState(false)\n    const [selectedBooking, setSelectedBooking] = useState<HireBooking | null>(null)\n    const [statusFilter, setStatusFilter] = useState('')\n    const [searchQuery, setSearchQuery] = useState('')\n\n    // Booking form state\n    const [bookingForm, setBookingForm] = useState({\n        asset_id: 0,\n        client_id: 0,\n        hire_date: new Date().toISOString().split('T')[0],\n        return_date: '',\n        purpose: '',\n        destination: '',\n        distance_km: '',\n        total_amount: ''\n    })\n\n    // Client form state\n    const [clientForm, setClientForm] = useState({\n        client_name: '',\n        contact_phone: '',\n        contact_email: '',\n        organization: '',\n        address: '',\n        notes: ''\n    })\n\n    // Payment form state\n    const [paymentForm, setPaymentForm] = useState({\n        amount: '',\n        payment_method: 'CASH',\n        payment_reference: '',\n        payment_date: new Date().toISOString().split('T')[0]\n    })\n\n    useEffect(() => {\n        void loadData()\n    }, [])\n\n    const loadData = async () => {\n        setLoading(true)\n        try {\n            const [bookingsRes, clientsRes, assetsRes, statsRes] = await Promise.all([\n                window.electronAPI.getHireBookings(),\n                window.electronAPI.getHireClients(),\n                window.electronAPI.getHireAssets({ isActive: true }),\n                window.electronAPI.getHireStats()\n            ])\n            setBookings(bookingsRes)\n            setClients(clientsRes)\n            setAssets(assetsRes)\n            setStats(statsRes)\n        } catch (error) {\n            console.error('Failed to load hire data:', error)\n        } finally {\n            setLoading(false)\n        }\n    }\n\n    const handleCreateBooking = async (e: React.FormEvent) => {\n        e.preventDefault()\n        if (!user) {return}\n\n        // Validate\n        if (!bookingForm.asset_id || !bookingForm.client_id || !bookingForm.total_amount) {\n            alert('Please fill in all required fields')\n            return\n        }\n\n        // Check availability\n        const available = await window.electronAPI.checkHireAvailability(\n            bookingForm.asset_id,\n            bookingForm.hire_date,\n            bookingForm.return_date || undefined\n        )\n        if (!available) {\n            alert('Asset is not available for the selected dates')\n            return\n        }\n\n        const result = await window.electronAPI.createHireBooking({\n            ...bookingForm,\n            distance_km: bookingForm.distance_km ? parseFloat(bookingForm.distance_km) : undefined,\n            total_amount: shillingsToCents(bookingForm.total_amount)\n        }, user.id)\n\n        if (result.success) {\n            alert(`Booking created! Number: ${result.booking_number}`)\n            setShowBookingModal(false)\n            setBookingForm({\n                asset_id: 0, client_id: 0, hire_date: new Date().toISOString().split('T')[0],\n                return_date: '', purpose: '', destination: '', distance_km: '', total_amount: ''\n            })\n            void loadData()\n        } else {\n            alert(`Error: ${result.errors?.join(', ')}`)\n        }\n    }\n\n    const handleCreateClient = async (e: React.FormEvent) => {\n        e.preventDefault()\n        const result = await window.electronAPI.createHireClient(clientForm)\n        if (result.success) {\n            alert('Client created successfully!')\n            setShowClientModal(false)\n            setClientForm({ client_name: '', contact_phone: '', contact_email: '', organization: '', address: '', notes: '' })\n            void loadData()\n        } else {\n            alert(`Error: ${result.errors?.join(', ')}`)\n        }\n    }\n\n    const handleRecordPayment = async (e: React.FormEvent) => {\n        e.preventDefault()\n        if (!user || !selectedBooking) {return}\n\n        const result = await window.electronAPI.recordHirePayment(\n            selectedBooking.id,\n            {\n                ...paymentForm,\n                amount: shillingsToCents(paymentForm.amount)\n            },\n            user.id\n        )\n\n        if (result.success) {\n            alert(`Payment recorded! Receipt: ${result.receipt_number}`)\n            setShowPaymentModal(false)\n            setPaymentForm({ amount: '', payment_method: 'CASH', payment_reference: '', payment_date: new Date().toISOString().split('T')[0] })\n            setSelectedBooking(null)\n            void loadData()\n        } else {\n            alert(`Error: ${result.errors?.join(', ')}`)\n        }\n    }\n\n    const handleUpdateStatus = async (bookingId: number, status: string) => {\n        const result = await window.electronAPI.updateHireBookingStatus(bookingId, status)\n        if (result.success) {\n            void loadData()\n        } else {\n            alert(`Error: ${result.errors?.join(', ')}`)\n        }\n    }\n\n    const handlePrintReceipt = async (booking: HireBooking) => {\n        const payments = await window.electronAPI.getHirePaymentsByBooking(booking.id)\n        const latestPayment = payments[0]\n        if (!latestPayment) {\n            alert('No payments to print')\n            return\n        }\n\n        const settings = await window.electronAPI.getSchoolSettings()\n        printDocument({\n            title: `Hire Receipt - ${latestPayment.receipt_number}`,\n            template: 'receipt',\n            data: {\n                receiptNumber: latestPayment.receipt_number,\n                date: latestPayment.payment_date,\n                amount: latestPayment.amount,\n                paymentMode: latestPayment.payment_method,\n                reference: latestPayment.payment_reference,\n                studentName: booking.client_name,\n                admissionNumber: booking.booking_number,\n                description: `Asset Hire: ${booking.asset_name}`,\n                amountInWords: `${numberToWords(Math.floor(latestPayment.amount / 100))} Shillings Only`\n            },\n            schoolSettings: settings ? (settings as unknown as Record<string, unknown>) : {}\n        })\n    }\n\n    const numberToWords = (num: number): string => {\n        const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',\n            'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen']\n        const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety']\n\n        if (num === 0) {return 'Zero'}\n        if (num < 20) {return ones[num]}\n        if (num < 100) {return tens[Math.floor(num / 10)] + (num % 10 ? ' ' + ones[num % 10] : '')}\n        if (num < 1000) {return ones[Math.floor(num / 100)] + ' Hundred' + (num % 100 ? ' and ' + numberToWords(num % 100) : '')}\n        if (num < 1000000) {return numberToWords(Math.floor(num / 1000)) + ' Thousand' + (num % 1000 ? ' ' + numberToWords(num % 1000) : '')}\n        return numberToWords(Math.floor(num / 1000000)) + ' Million' + (num % 1000000 ? ' ' + numberToWords(num % 1000000) : '')\n    }\n\n    const filteredBookings = bookings.filter(b => {\n        const matchesStatus = !statusFilter || b.status === statusFilter\n        const matchesSearch = !searchQuery ||\n            b.client_name?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n            b.booking_number.toLowerCase().includes(searchQuery.toLowerCase())\n        return matchesStatus && matchesSearch\n    })\n\n    const filteredClients = clients.filter(c =>\n        !searchQuery || c.client_name.toLowerCase().includes(searchQuery.toLowerCase())\n    )\n\n    const getStatusColor = (status: string) => {\n        switch (status) {\n            case 'PENDING': return 'bg-yellow-100 text-yellow-800'\n            case 'CONFIRMED': return 'bg-blue-100 text-blue-800'\n            case 'IN_PROGRESS': return 'bg-purple-100 text-purple-800'\n            case 'COMPLETED': return 'bg-green-100 text-green-800'\n            case 'CANCELLED': return 'bg-red-100 text-red-800'\n            default: return 'bg-gray-100 text-gray-800'\n        }\n    }\n\n    if (loading) {\n        return <div className=\"p-6 text-center\">Loading...</div>\n    }\n\n    return (\n        <div className=\"p-6 space-y-6\">\n            {/* Header */}\n            <div className=\"flex justify-between items-center\">\n                <div>\n                    <h1 className=\"text-2xl font-bold text-gray-900\">Asset Hire Management</h1>\n                    <p className=\"text-gray-600\">Manage bus and asset rentals</p>\n                </div>\n                <div className=\"flex gap-2\">\n                    <button\n                        onClick={() => setShowClientModal(true)}\n                        className=\"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700\"\n                    >\n                        + New Client\n                    </button>\n                    <button\n                        onClick={() => setShowBookingModal(true)}\n                        className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\n                    >\n                        + New Booking\n                    </button>\n                </div>\n            </div>\n\n            {/* Stats Cards */}\n            {stats && (\n                <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                    <div className=\"bg-white p-4 rounded-lg shadow border-l-4 border-blue-500\">\n                        <div className=\"text-sm text-gray-500\">Total Bookings</div>\n                        <div className=\"text-2xl font-bold\">{stats.totalBookings}</div>\n                    </div>\n                    <div className=\"bg-white p-4 rounded-lg shadow border-l-4 border-green-500\">\n                        <div className=\"text-sm text-gray-500\">Total Income</div>\n                        <div className=\"text-2xl font-bold\">{formatCurrencyFromCents(stats.totalIncome)}</div>\n                    </div>\n                    <div className=\"bg-white p-4 rounded-lg shadow border-l-4 border-orange-500\">\n                        <div className=\"text-sm text-gray-500\">Pending Amount</div>\n                        <div className=\"text-2xl font-bold\">{formatCurrencyFromCents(stats.pendingAmount)}</div>\n                    </div>\n                    <div className=\"bg-white p-4 rounded-lg shadow border-l-4 border-purple-500\">\n                        <div className=\"text-sm text-gray-500\">This Month</div>\n                        <div className=\"text-2xl font-bold\">{formatCurrencyFromCents(stats.thisMonth)}</div>\n                    </div>\n                </div>\n            )}\n\n            {/* Tabs */}\n            <div className=\"border-b border-gray-200\">\n                <nav className=\"flex space-x-8\">\n                    {(['bookings', 'clients', 'assets'] as TabType[]).map(tab => (\n                        <button\n                            key={tab}\n                            onClick={() => setActiveTab(tab)}\n                            className={`py-2 px-1 border-b-2 font-medium text-sm ${activeTab === tab\n                                ? 'border-blue-500 text-blue-600'\n                                : 'border-transparent text-gray-500 hover:text-gray-700'\n                                }`}\n                        >\n                            {tab.charAt(0).toUpperCase() + tab.slice(1)}\n                        </button>\n                    ))}\n                </nav>\n            </div>\n\n            {/* Filters */}\n            <div className=\"flex gap-4\">\n                <input\n                    type=\"text\"\n                    placeholder=\"Search...\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    className=\"px-4 py-2 border rounded-lg w-64\"\n                />\n                {activeTab === 'bookings' && (\n                    <select\n                        value={statusFilter}\n                        onChange={(e) => setStatusFilter(e.target.value)}\n                        className=\"px-4 py-2 border rounded-lg\"\n                        aria-label=\"Filter by status\"\n                    >\n                        <option value=\"\">All Status</option>\n                        <option value=\"PENDING\">Pending</option>\n                        <option value=\"CONFIRMED\">Confirmed</option>\n                        <option value=\"IN_PROGRESS\">In Progress</option>\n                        <option value=\"COMPLETED\">Completed</option>\n                        <option value=\"CANCELLED\">Cancelled</option>\n                    </select>\n                )}\n            </div>\n\n            {/* Content */}\n            <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n                {activeTab === 'bookings' && (\n                    <table className=\"min-w-full divide-y divide-gray-200\">\n                        <thead className=\"bg-gray-50\">\n                            <tr>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Booking #</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Client</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Asset</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Date</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Amount</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Balance</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Status</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Actions</th>\n                            </tr>\n                        </thead>\n                        <tbody className=\"bg-white divide-y divide-gray-200\">\n                            {filteredBookings.map(booking => (\n                                <tr key={booking.id}>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium\">{booking.booking_number}</td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm\">{booking.client_name}</td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm\">{booking.asset_name}</td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm\">{new Date(booking.hire_date).toLocaleDateString()}</td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm\">{formatCurrencyFromCents(booking.total_amount)}</td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600\">\n                                        {formatCurrencyFromCents(booking.balance || 0)}\n                                    </td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap\">\n                                        <span className={`px-2 py-1 text-xs rounded-full ${getStatusColor(booking.status)}`}>\n                                            {booking.status}\n                                        </span>\n                                    </td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm space-x-2\">\n                                        {booking.status !== 'COMPLETED' && booking.status !== 'CANCELLED' && (\n                                            <>\n                                                <button\n                                                    onClick={() => { setSelectedBooking(booking); setShowPaymentModal(true); setPaymentForm({ ...paymentForm, amount: String(centsToShillings(booking.balance || 0)) }) }}\n                                                    className=\"text-green-600 hover:text-green-800\"\n                                                >\n                                                    Pay\n                                                </button>\n                                                <button\n                                                    onClick={() => handleUpdateStatus(booking.id, 'CANCELLED')}\n                                                    className=\"text-red-600 hover:text-red-800\"\n                                                >\n                                                    Cancel\n                                                </button>\n                                            </>\n                                        )}\n                                        {booking.amount_paid > 0 && (\n                                            <button\n                                                onClick={() => handlePrintReceipt(booking)}\n                                                className=\"text-blue-600 hover:text-blue-800\"\n                                            >\n                                                Print\n                                            </button>\n                                        )}\n                                    </td>\n                                </tr>\n                            ))}\n                            {filteredBookings.length === 0 && (\n                                <tr>\n                                    <td colSpan={8} className=\"px-6 py-8 text-center text-gray-500\">\n                                        No bookings found\n                                    </td>\n                                </tr>\n                            )}\n                        </tbody>\n                    </table>\n                )}\n\n                {activeTab === 'clients' && (\n                    <table className=\"min-w-full divide-y divide-gray-200\">\n                        <thead className=\"bg-gray-50\">\n                            <tr>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Name</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Organization</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Phone</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Email</th>\n                            </tr>\n                        </thead>\n                        <tbody className=\"bg-white divide-y divide-gray-200\">\n                            {filteredClients.map(client => (\n                                <tr key={client.id}>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium\">{client.client_name}</td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm\">{client.organization || '-'}</td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm\">{client.contact_phone || '-'}</td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm\">{client.contact_email || '-'}</td>\n                                </tr>\n                            ))}\n                        </tbody>\n                    </table>\n                )}\n\n                {activeTab === 'assets' && (\n                    <table className=\"min-w-full divide-y divide-gray-200\">\n                        <thead className=\"bg-gray-50\">\n                            <tr>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Asset Name</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Type</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Default Rate</th>\n                                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Rate Type</th>\n                            </tr>\n                        </thead>\n                        <tbody className=\"bg-white divide-y divide-gray-200\">\n                            {assets.map(asset => (\n                                <tr key={asset.id}>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium\">{asset.asset_name}</td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm\">{asset.asset_type}</td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm\">{formatCurrencyFromCents(asset.default_rate || 0)}</td>\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm\">{asset.rate_type || 'MANUAL'}</td>\n                                </tr>\n                            ))}\n                        </tbody>\n                    </table>\n                )}\n            </div>\n\n            {/* New Booking Modal */}\n            {showBookingModal && (\n                <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n                    <div className=\"bg-white rounded-lg p-6 w-full max-w-lg\">\n                        <h2 className=\"text-xl font-bold mb-4\">New Booking</h2>\n                        <form onSubmit={handleCreateBooking} className=\"space-y-4\">\n                            <div className=\"grid grid-cols-2 gap-4\">\n                                <div>\n                                    <label htmlFor=\"field-448\" className=\"block text-sm font-medium mb-1\">Asset *</label>\n                                    <select id=\"field-448\"\n                                        value={bookingForm.asset_id}\n                                        onChange={(e) => setBookingForm({ ...bookingForm, asset_id: parseInt(e.target.value) })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        required\n                                        aria-label=\"Select asset\"\n                                    >\n                                        <option value=\"\">Select Asset</option>\n                                        {assets.map(a => (\n                                            <option key={a.id} value={a.id}>{a.asset_name}</option>\n                                        ))}\n                                    </select>\n                                </div>\n                                <div>\n                                    <label htmlFor=\"field-463\" className=\"block text-sm font-medium mb-1\">Client *</label>\n                                    <select id=\"field-463\"\n                                        value={bookingForm.client_id}\n                                        onChange={(e) => setBookingForm({ ...bookingForm, client_id: parseInt(e.target.value) })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        required\n                                        aria-label=\"Select client\"\n                                    >\n                                        <option value=\"\">Select Client</option>\n                                        {clients.map(c => (\n                                            <option key={c.id} value={c.id}>{c.client_name}</option>\n                                        ))}\n                                    </select>\n                                </div>\n                            </div>\n                            <div className=\"grid grid-cols-2 gap-4\">\n                                <div>\n                                    <label htmlFor=\"field-480\" className=\"block text-sm font-medium mb-1\">Hire Date *</label>\n                                    <input id=\"field-480\"\n                                        type=\"date\"\n                                        value={bookingForm.hire_date}\n                                        onChange={(e) => setBookingForm({ ...bookingForm, hire_date: e.target.value })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        aria-label=\"Hire date\"\n                                        required\n                                    />\n                                </div>\n                                <div>\n                                    <label htmlFor=\"field-491\" className=\"block text-sm font-medium mb-1\">Return Date</label>\n                                    <input id=\"field-491\"\n                                        type=\"date\"\n                                        value={bookingForm.return_date}\n                                        onChange={(e) => setBookingForm({ ...bookingForm, return_date: e.target.value })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        aria-label=\"Return date\"\n                                    />\n                                </div>\n                            </div>\n                            <div>\n                                <label htmlFor=\"field-502\" className=\"block text-sm font-medium mb-1\">Destination</label>\n                                <input id=\"field-502\"\n                                    type=\"text\"\n                                    value={bookingForm.destination}\n                                    onChange={(e) => setBookingForm({ ...bookingForm, destination: e.target.value })}\n                                    className=\"w-full border rounded-lg p-2\"\n                                    placeholder=\"e.g., Nairobi\"\n                                />\n                            </div>\n                            <div className=\"grid grid-cols-2 gap-4\">\n                                <div>\n                                    <label htmlFor=\"field-513\" className=\"block text-sm font-medium mb-1\">Distance (km)</label>\n                                    <input id=\"field-513\"\n                                        type=\"number\"\n                                        value={bookingForm.distance_km}\n                                        onChange={(e) => setBookingForm({ ...bookingForm, distance_km: e.target.value })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        placeholder=\"e.g., 200\"\n                                        aria-label=\"Distance in kilometers\"\n                                    />\n                                </div>\n                                <div>\n                                    <label htmlFor=\"field-524\" className=\"block text-sm font-medium mb-1\">Total Amount (KES) *</label>\n                                    <input id=\"field-524\"\n                                        type=\"number\"\n                                        value={bookingForm.total_amount}\n                                        onChange={(e) => setBookingForm({ ...bookingForm, total_amount: e.target.value })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        required\n                                        aria-label=\"Total amount in KES\"\n                                    />\n                                </div>\n                            </div>\n                            <div>\n                                <label htmlFor=\"field-536\" className=\"block text-sm font-medium mb-1\">Purpose</label>\n                                <textarea id=\"field-536\"\n                                    value={bookingForm.purpose}\n                                    onChange={(e) => setBookingForm({ ...bookingForm, purpose: e.target.value })}\n                                    className=\"w-full border rounded-lg p-2\"\n                                    rows={2}\n                                    placeholder=\"e.g., Church trip\"\n                                    aria-label=\"Booking purpose\"\n                                />\n                            </div>\n                            <div className=\"flex justify-end gap-2\">\n                                <button\n                                    type=\"button\"\n                                    onClick={() => setShowBookingModal(false)}\n                                    className=\"px-4 py-2 bg-gray-200 rounded-lg\"\n                                >\n                                    Cancel\n                                </button>\n                                <button\n                                    type=\"submit\"\n                                    className=\"px-4 py-2 bg-blue-600 text-white rounded-lg\"\n                                >\n                                    Create Booking\n                                </button>\n                            </div>\n                        </form>\n                    </div>\n                </div>\n            )}\n\n            {/* New Client Modal */}\n            {showClientModal && (\n                <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n                    <div className=\"bg-white rounded-lg p-6 w-full max-w-md\">\n                        <h2 className=\"text-xl font-bold mb-4\">New Client</h2>\n                        <form onSubmit={handleCreateClient} className=\"space-y-4\">\n                            <div>\n                                <label htmlFor=\"field-573\" className=\"block text-sm font-medium mb-1\">Client Name *</label>\n                                <input id=\"field-573\"\n                                    type=\"text\"\n                                    value={clientForm.client_name}\n                                    onChange={(e) => setClientForm({ ...clientForm, client_name: e.target.value })}\n                                    className=\"w-full border rounded-lg p-2\"\n                                    required\n                                    aria-label=\"Client name\"\n                                />\n                            </div>\n                            <div>\n                                <label htmlFor=\"field-584\" className=\"block text-sm font-medium mb-1\">Organization</label>\n                                <input id=\"field-584\"\n                                    type=\"text\"\n                                    value={clientForm.organization}\n                                    onChange={(e) => setClientForm({ ...clientForm, organization: e.target.value })}\n                                    className=\"w-full border rounded-lg p-2\"\n                                    aria-label=\"Organization name\"\n                                />\n                            </div>\n                            <div className=\"grid grid-cols-2 gap-4\">\n                                <div>\n                                    <label htmlFor=\"field-595\" className=\"block text-sm font-medium mb-1\">Phone</label>\n                                    <input id=\"field-595\"\n                                        type=\"tel\"\n                                        value={clientForm.contact_phone}\n                                        onChange={(e) => setClientForm({ ...clientForm, contact_phone: e.target.value })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        aria-label=\"Contact phone\"\n                                    />\n                                </div>\n                                <div>\n                                    <label htmlFor=\"field-605\" className=\"block text-sm font-medium mb-1\">Email</label>\n                                    <input id=\"field-605\"\n                                        type=\"email\"\n                                        value={clientForm.contact_email}\n                                        onChange={(e) => setClientForm({ ...clientForm, contact_email: e.target.value })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        aria-label=\"Contact email\"\n                                    />\n                                </div>\n                            </div>\n                            <div className=\"flex justify-end gap-2\">\n                                <button\n                                    type=\"button\"\n                                    onClick={() => setShowClientModal(false)}\n                                    className=\"px-4 py-2 bg-gray-200 rounded-lg\"\n                                >\n                                    Cancel\n                                </button>\n                                <button\n                                    type=\"submit\"\n                                    className=\"px-4 py-2 bg-blue-600 text-white rounded-lg\"\n                                >\n                                    Save Client\n                                </button>\n                            </div>\n                        </form>\n                    </div>\n                </div>\n            )}\n\n            {/* Payment Modal */}\n            {showPaymentModal && selectedBooking && (\n                <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n                    <div className=\"bg-white rounded-lg p-6 w-full max-w-md\">\n                        <h2 className=\"text-xl font-bold mb-4\">Record Payment</h2>\n                        <p className=\"text-sm text-gray-600 mb-4\">\n                            Booking: {selectedBooking.booking_number} | Balance: {formatCurrencyFromCents(selectedBooking.balance || 0)}\n                        </p>\n                        <form onSubmit={handleRecordPayment} className=\"space-y-4\">\n                            <div>\n                                <label htmlFor=\"field-645\" className=\"block text-sm font-medium mb-1\">Amount (KES) *</label>\n                                <input id=\"field-645\"\n                                    type=\"number\"\n                                    value={paymentForm.amount}\n                                    onChange={(e) => setPaymentForm({ ...paymentForm, amount: e.target.value })}\n                                    className=\"w-full border rounded-lg p-2\"\n                                    max={selectedBooking.balance}\n                                    required\n                                    aria-label=\"Payment amount in KES\"\n                                />\n                            </div>\n                            <div className=\"grid grid-cols-2 gap-4\">\n                                <div>\n                                    <label htmlFor=\"field-658\" className=\"block text-sm font-medium mb-1\">Payment Method</label>\n                                    <select id=\"field-658\"\n                                        value={paymentForm.payment_method}\n                                        onChange={(e) => setPaymentForm({ ...paymentForm, payment_method: e.target.value })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        aria-label=\"Payment method\"\n                                    >\n                                        <option value=\"CASH\">Cash</option>\n                                        <option value=\"MPESA\">M-Pesa</option>\n                                        <option value=\"BANK\">Bank Transfer</option>\n                                        <option value=\"CHEQUE\">Cheque</option>\n                                    </select>\n                                </div>\n                                <div>\n                                    <label htmlFor=\"field-672\" className=\"block text-sm font-medium mb-1\">Date</label>\n                                    <input id=\"field-672\"\n                                        type=\"date\"\n                                        value={paymentForm.payment_date}\n                                        onChange={(e) => setPaymentForm({ ...paymentForm, payment_date: e.target.value })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        aria-label=\"Payment date\"\n                                    />\n                                </div>\n                            </div>\n                            <div>\n                                <label htmlFor=\"field-683\" className=\"block text-sm font-medium mb-1\">Reference</label>\n                                <input id=\"field-683\"\n                                    type=\"text\"\n                                    value={paymentForm.payment_reference}\n                                    onChange={(e) => setPaymentForm({ ...paymentForm, payment_reference: e.target.value })}\n                                    className=\"w-full border rounded-lg p-2\"\n                                    placeholder=\"e.g., M-Pesa code\"\n                                />\n                            </div>\n                            <div className=\"flex justify-end gap-2\">\n                                <button\n                                    type=\"button\"\n                                    onClick={() => { setShowPaymentModal(false); setSelectedBooking(null); }}\n                                    className=\"px-4 py-2 bg-gray-200 rounded-lg\"\n                                >\n                                    Cancel\n                                </button>\n                                <button\n                                    type=\"submit\"\n                                    className=\"px-4 py-2 bg-green-600 text-white rounded-lg\"\n                                >\n                                    Record Payment\n                                </button>\n                            </div>\n                        </form>\n                    </div>\n                </div>\n            )}\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\BankAccounts.tsx","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":120,"column":21,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":154,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Plus, Building2, CreditCard, TrendingUp } from 'lucide-react'\nimport React, { useState, useEffect } from 'react'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\nimport { StatCard } from '../../components/patterns/StatCard'\nimport { Modal } from '../../components/ui/Modal'\nimport { formatCurrencyFromCents, shillingsToCents } from '../../utils/format'\n\ninterface BankAccount {\n    id: number\n    account_name: string\n    account_number: string\n    bank_name: string\n    branch: string | null\n    currency: string\n    opening_balance: number\n    current_balance: number\n    is_active: boolean\n}\n\nexport default function BankAccounts() {\n    const [accounts, setAccounts] = useState<BankAccount[]>([])\n    const [loading, setLoading] = useState(true)\n    const [showAddModal, setShowAddModal] = useState(false)\n    const [formData, setFormData] = useState({\n        account_name: '',\n        account_number: '',\n        bank_name: '',\n        branch: '',\n        opening_balance: 0\n    })\n    const [saving, setSaving] = useState(false)\n\n    useEffect(() => {\n        void loadAccounts()\n    }, [])\n\n    const loadAccounts = async () => {\n        setLoading(true)\n        try {\n            const data = await window.electronAPI.getBankAccounts()\n            setAccounts(data as BankAccount[])\n        } catch (error) {\n            console.error('Failed to load bank accounts:', error)\n        } finally {\n            setLoading(false)\n        }\n    }\n\n    const handleSubmit = async (e: React.FormEvent) => {\n        e.preventDefault()\n        setSaving(true)\n        try {\n            const result = await window.electronAPI.createBankAccount({\n                ...formData,\n                opening_balance: shillingsToCents(formData.opening_balance) // Whole currency units -> cents\n            })\n\n            if (result.success) {\n                setShowAddModal(false)\n                setFormData({ account_name: '', account_number: '', bank_name: '', branch: '', opening_balance: 0 })\n                void loadAccounts()\n            } else {\n                alert(result.errors?.join(', ') || 'Failed to create account')\n            }\n        } catch (error) {\n            console.error('Failed to create account:', error)\n        } finally {\n            setSaving(false)\n        }\n    }\n\n    const totalBalance = accounts.reduce((sum, acc) => sum + acc.current_balance, 0)\n\n    return (\n        <div className=\"space-y-8 pb-10\">\n            <PageHeader\n                title=\"Bank Accounts\"\n                subtitle=\"Manage bank accounts for reconciliation\"\n                breadcrumbs={[{ label: 'Finance' }, { label: 'Bank Accounts' }]}\n                actions={\n                    <button\n                        onClick={() => setShowAddModal(true)}\n                        className=\"btn btn-primary flex items-center gap-2\"\n                    >\n                        <Plus className=\"w-4 h-4\" />\n                        Add Account\n                    </button>\n                }\n            />\n\n            {/* Summary */}\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                <StatCard\n                    label=\"Total Accounts\"\n                    value={accounts.length.toString()}\n                    icon={Building2}\n                    color=\"from-blue-500/20 to-indigo-500/20 text-blue-400\"\n                />\n                <StatCard\n                    label=\"Total Balance\"\n                    value={formatCurrencyFromCents(totalBalance)}\n                    icon={CreditCard}\n                    color=\"from-emerald-500/20 to-teal-500/20 text-emerald-400\"\n                />\n                <StatCard\n                    label=\"Active Accounts\"\n                    value={accounts.filter(a => a.is_active).length.toString()}\n                    icon={TrendingUp}\n                    color=\"from-purple-500/20 to-pink-500/20 text-purple-400\"\n                />\n            </div>\n\n            {/* Accounts List */}\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n                {loading ? (\n                    [1, 2, 3].map(i => (\n                        <div key={i} className=\"h-40 bg-secondary/30 animate-pulse rounded-xl\" />\n                    ))\n                ) : accounts.length === 0 ? (\n                    <div className=\"col-span-full text-center py-16 text-foreground/40\">\n                        No bank accounts added yet\n                    </div>\n                ) : (\n                    accounts.map(account => (\n                        <div key={account.id} className=\"premium-card group hover:border-primary/30 transition-colors\">\n                            <div className=\"flex items-start justify-between mb-4\">\n                                <div className=\"p-2.5 rounded-xl bg-gradient-to-br from-blue-500/20 to-indigo-500/20 text-blue-400\">\n                                    <Building2 className=\"w-5 h-5\" />\n                                </div>\n                                <span className={`text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full ${account.is_active\n                                    ? 'bg-green-500/10 text-green-400 border border-green-500/20'\n                                    : 'bg-gray-500/10 text-gray-400 border border-gray-500/20'\n                                    }`}>\n                                    {account.is_active ? 'Active' : 'Inactive'}\n                                </span>\n                            </div>\n\n                            <h3 className=\"text-lg font-bold text-foreground mb-1\">{account.account_name}</h3>\n                            <p className=\"text-sm text-foreground/50 mb-4\">{account.bank_name}{account.branch ? ` - ${account.branch}` : ''}</p>\n\n                            <div className=\"flex items-center justify-between pt-4 border-t border-border/20\">\n                                <div>\n                                    <p className=\"text-[10px] font-bold text-foreground/40 uppercase tracking-wider\">Account No.</p>\n                                    <p className=\"text-sm font-mono text-foreground/70\">{account.account_number}</p>\n                                </div>\n                                <div className=\"text-right\">\n                                    <p className=\"text-[10px] font-bold text-foreground/40 uppercase tracking-wider\">Balance</p>\n                                    <p className=\"text-lg font-bold text-foreground font-mono\">{formatCurrencyFromCents(account.current_balance)}</p>\n                                </div>\n                            </div>\n                        </div>\n                    ))\n                )}\n            </div>\n\n            {/* Add Account Modal */}\n            <Modal\n                isOpen={showAddModal}\n                onClose={() => setShowAddModal(false)}\n                title=\"Add Bank Account\"\n            >\n                <form onSubmit={handleSubmit} className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                        <label htmlFor=\"field-165\" className=\"text-sm font-bold text-foreground/60\">Account Name *</label>\n                        <input id=\"field-165\"\n                            type=\"text\"\n                            value={formData.account_name}\n                            onChange={(e) => setFormData({ ...formData, account_name: e.target.value })}\n                            placeholder=\"e.g., School Main Account\"\n                            className=\"w-full bg-secondary/20 border border-border/20 rounded-lg px-4 py-2.5 text-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all\"\n                            required\n                        />\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                        <div className=\"space-y-2\">\n                            <label htmlFor=\"field-178\" className=\"text-sm font-bold text-foreground/60\">Bank Name *</label>\n                            <input id=\"field-178\"\n                                type=\"text\"\n                                value={formData.bank_name}\n                                onChange={(e) => setFormData({ ...formData, bank_name: e.target.value })}\n                                placeholder=\"e.g., KCB\"\n                                className=\"w-full bg-secondary/20 border border-border/20 rounded-lg px-4 py-2.5 text-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all\"\n                                required\n                            />\n                        </div>\n                        <div className=\"space-y-2\">\n                            <label htmlFor=\"field-189\" className=\"text-sm font-bold text-foreground/60\">Branch</label>\n                            <input id=\"field-189\"\n                                type=\"text\"\n                                value={formData.branch}\n                                onChange={(e) => setFormData({ ...formData, branch: e.target.value })}\n                                placeholder=\"e.g., Mwingi Branch\"\n                                className=\"w-full bg-secondary/20 border border-border/20 rounded-lg px-4 py-2.5 text-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all\"\n                            />\n                        </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                        <div className=\"space-y-2\">\n                            <label htmlFor=\"field-202\" className=\"text-sm font-bold text-foreground/60\">Account Number *</label>\n                            <input id=\"field-202\"\n                                type=\"text\"\n                                value={formData.account_number}\n                                onChange={(e) => setFormData({ ...formData, account_number: e.target.value })}\n                                placeholder=\"e.g., 1234567890\"\n                                className=\"w-full bg-secondary/20 border border-border/20 rounded-lg px-4 py-2.5 text-foreground font-mono focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all\"\n                                required\n                            />\n                        </div>\n                        <div className=\"space-y-2\">\n                            <label htmlFor=\"field-213\" className=\"text-sm font-bold text-foreground/60\">Opening Balance</label>\n                            <input id=\"field-213\"\n                                type=\"number\"\n                                value={formData.opening_balance || ''}\n                                onChange={(e) => setFormData({ ...formData, opening_balance: Number(e.target.value) })}\n                                placeholder=\"0.00\"\n                                min=\"0\"\n                                step=\"0.01\"\n                                className=\"w-full bg-secondary/20 border border-border/20 rounded-lg px-4 py-2.5 text-foreground font-mono focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all\"\n                            />\n                        </div>\n                    </div>\n\n                    <div className=\"flex justify-end gap-3 pt-4\">\n                        <button\n                            type=\"button\"\n                            onClick={() => setShowAddModal(false)}\n                            className=\"btn btn-secondary\"\n                        >\n                            Cancel\n                        </button>\n                        <button\n                            type=\"submit\"\n                            disabled={saving}\n                            className=\"btn btn-primary\"\n                        >\n                            {saving ? 'Saving...' : 'Add Account'}\n                        </button>\n                    </div>\n                </form>\n            </Modal>\n        </div>\n    )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Budget\\BudgetDetails.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Budget\\CreateBudget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Budget\\index.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\CBC\\CBCStrandManagement.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getStrandColor' to the outer scope.","line":61,"column":50,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":61,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\n\nimport { formatCurrencyFromCents } from '../../../utils/format';\n\ninterface CBCStrand {\n  id: number;\n  code: string;\n  name: string;\n  description?: string;\n  is_active: boolean;\n}\n\ninterface StrandProfitability {\n  strand_id: number;\n  strand_name: string;\n  revenue: number;\n  expenses: number;\n  profit: number;\n  profit_margin: number;\n  student_count: number;\n}\n\nconst CBCStrandManagement: React.FC = () => {\n  const [, setStrands] = useState<CBCStrand[]>([]);\n  const [profitability, setProfitability] = useState<StrandProfitability[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [fiscalYear, setFiscalYear] = useState(new Date().getFullYear());\n  const [term, setTerm] = useState(1);\n\n  useEffect(() => {\n    void loadData();\n  }, [fiscalYear, term]);\n\n  const loadData = async () => {\n    try {\n      setLoading(true);\n      // Fetch strands from IPC (CBC handlers)\n      const strandsResult = await window.electronAPI.getCBCStrands();\n      const strandsData: CBCStrand[] = strandsResult?.data || [];\n      setStrands(strandsData);\n\n      // Profitability data derived from strand + financial data\n      // For now, map strands to profitability structure if profitability endpoint exists\n      const profData: StrandProfitability[] = strandsData.map((s: CBCStrand) => ({\n        strand_id: s.id,\n        strand_name: s.name,\n        revenue: 0,\n        expenses: 0,\n        profit: 0,\n        profit_margin: 0,\n        student_count: 0,\n      }));\n      setProfitability(profData);\n    } catch (error) {\n      console.error('Error loading data:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const getStrandColor = (profit_margin: number) => {\n    if (profit_margin >= 20) {return 'bg-green-100 text-green-800';}\n    if (profit_margin >= 0) {return 'bg-yellow-100 text-yellow-800';}\n    return 'bg-red-100 text-red-800';\n  };\n\n  if (loading) {\n    return <div className=\"flex justify-center items-center h-64\">Loading CBC Strand Data...</div>;\n  }\n\n  return (\n    <div className=\"container mx-auto p-6\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-3xl font-bold text-gray-800\">CBC Activity Management</h1>\n        <p className=\"text-gray-600 mt-2\">Track revenue, expenses, and profitability by CBC strand</p>\n      </div>\n\n      {/* Filters */}\n      <div className=\"bg-white rounded-lg shadow p-4 mb-6\">\n        <div className=\"flex gap-4 items-center\">\n          <div>\n            <label htmlFor=\"field-82\" className=\"block text-sm font-medium text-gray-700 mb-1\">Fiscal Year</label>\n            <select id=\"field-82\"\n              value={fiscalYear}\n              onChange={(e) => setFiscalYear(parseInt(e.target.value))}\n              className=\"border rounded px-3 py-2\"\n              aria-label=\"Fiscal year\"\n            >\n              <option value={2024}>2024</option>\n              <option value={2025}>2025</option>\n              <option value={2026}>2026</option>\n            </select>\n          </div>\n          <div>\n            <label htmlFor=\"field-95\" className=\"block text-sm font-medium text-gray-700 mb-1\">Term</label>\n            <select id=\"field-95\"\n              value={term}\n              onChange={(e) => setTerm(parseInt(e.target.value))}\n              className=\"border rounded px-3 py-2\"\n              aria-label=\"Term\"\n            >\n              <option value={1}>Term 1</option>\n              <option value={2}>Term 2</option>\n              <option value={3}>Term 3</option>\n            </select>\n          </div>\n        </div>\n      </div>\n\n      {/* Profitability Overview */}\n      <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n        <div className=\"px-6 py-4 bg-gray-50 border-b\">\n          <h2 className=\"text-xl font-semibold text-gray-800\">Strand Performance Summary</h2>\n        </div>\n        <div className=\"overflow-x-auto\">\n          <table className=\"w-full\">\n            <thead className=\"bg-gray-100\">\n              <tr>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider\">Strand</th>\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider\">Revenue</th>\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider\">Expenses</th>\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider\">Profit/Loss</th>\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider\">Margin</th>\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider\">Students</th>\n              </tr>\n            </thead>\n            <tbody className=\"bg-white divide-y divide-gray-200\">\n              {profitability.map((strand) => (\n                <tr key={strand.strand_id} className=\"hover:bg-gray-50\">\n                  <td className=\"px-6 py-4 whitespace-nowrap\">\n                    <div className=\"text-sm font-medium text-gray-900\">{strand.strand_name}</div>\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-right\">\n                    <div className=\"text-sm text-gray-900\">{formatCurrencyFromCents(strand.revenue)}</div>\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-right\">\n                    <div className=\"text-sm text-gray-900\">{formatCurrencyFromCents(strand.expenses)}</div>\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-right\">\n                    <div className={`text-sm font-medium ${strand.profit >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                      {formatCurrencyFromCents(strand.profit)}\n                    </div>\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-right\">\n                    <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getStrandColor(strand.profit_margin)}`}>\n                      {strand.profit_margin.toFixed(1)}%\n                    </span>\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900\">\n                    {strand.student_count}\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default CBCStrandManagement;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\CBC\\JSSTransition.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\CashFlow\\index.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\FeeExemptions.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getReasonBadgeColor' to the outer scope.","line":164,"column":50,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":164,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\n\nimport { useAuthStore } from '../../stores'\nimport { type AcademicYear, type Term } from '../../types/electron-api/AcademicAPI'\nimport { type FeeExemption, type ExemptionStats } from '../../types/electron-api/ExemptionAPI'\nimport { type FeeCategory } from '../../types/electron-api/FinanceAPI'\nimport { type Student } from '../../types/electron-api/StudentAPI'\n\nexport default function FeeExemptions() {\n    const { user } = useAuthStore()\n    const [exemptions, setExemptions] = useState<FeeExemption[]>([])\n    const [stats, setStats] = useState<ExemptionStats | null>(null)\n    const [students, setStudents] = useState<Student[]>([])\n    const [academicYears, setAcademicYears] = useState<AcademicYear[]>([])\n    const [terms, setTerms] = useState<Term[]>([])\n    const [feeCategories, setFeeCategories] = useState<FeeCategory[]>([])\n    const [loading, setLoading] = useState(true)\n    const [showModal, setShowModal] = useState(false)\n    const [showRevokeModal, setShowRevokeModal] = useState(false)\n    const [selectedExemption, setSelectedExemption] = useState<FeeExemption | null>(null)\n    const [revokeReason, setRevokeReason] = useState('')\n    const [studentSearch, setStudentSearch] = useState('')\n    const [filteredStudents, setFilteredStudents] = useState<Student[]>([])\n\n    // Filters\n    const [statusFilter, setStatusFilter] = useState<string>('ACTIVE')\n\n    // Form state\n    const [formData, setFormData] = useState({\n        student_id: 0,\n        academic_year_id: 0,\n        term_id: 0,\n        fee_category_id: 0,\n        exemption_percentage: '',\n        exemption_reason: '',\n        notes: ''\n    })\n\n    const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n\n    const loadData = useCallback(async () => {\n        setLoading(true)\n        try {\n            const [exemptionsRes, yearsRes, categoriesRes, studentsRes, statsRes] = await Promise.all([\n                window.electronAPI.getExemptions({ status: statusFilter || undefined }),\n                window.electronAPI.getAcademicYears(),\n                window.electronAPI.getFeeCategories(),\n                window.electronAPI.getStudents(),\n                window.electronAPI.getExemptionStats()\n            ])\n            setExemptions(exemptionsRes)\n            setAcademicYears(yearsRes)\n            setFeeCategories(categoriesRes)\n            setStudents(studentsRes)\n            setStats(statsRes)\n\n            // Set current year as default\n            const currentYear = yearsRes.find((y: AcademicYear) => y.is_current)\n            if (currentYear) {\n                setFormData(prev => ({ ...prev, academic_year_id: currentYear.id }))\n                const termsRes = await window.electronAPI.getTermsByYear(currentYear.id)\n                setTerms(termsRes)\n                const currentTerm = termsRes.find((t: Term) => t.is_current)\n                if (currentTerm) {\n                    setFormData(prev => ({ ...prev, term_id: currentTerm.id }))\n                }\n            }\n        } catch (error) {\n            console.error('Failed to load exemption data:', error)\n        } finally {\n            setLoading(false)\n        }\n    }, [statusFilter])\n\n    useEffect(() => {\n        void loadData()\n    }, [loadData])\n\n    useEffect(() => {\n        if (studentSearch.length >= 2) {\n            const filtered = students.filter(s =>\n                `${s.first_name} ${s.last_name}`.toLowerCase().includes(studentSearch.toLowerCase()) ||\n                s.admission_number.toLowerCase().includes(studentSearch.toLowerCase())\n            )\n            setFilteredStudents(filtered.slice(0, 10))\n        } else {\n            setFilteredStudents([])\n        }\n    }, [studentSearch, students])\n\n\n\n    const loadExemptions = useCallback(async () => {\n        const exemptionsRes = await window.electronAPI.getExemptions({ status: statusFilter || undefined })\n        setExemptions(exemptionsRes)\n    }, [statusFilter])\n\n    useEffect(() => {\n        void loadExemptions()\n    }, [loadExemptions])\n\n    const handleYearChange = async (yearId: number) => {\n        setFormData(prev => ({ ...prev, academic_year_id: yearId, term_id: 0 }))\n        const termsRes = await window.electronAPI.getTermsByYear(yearId)\n        setTerms(termsRes)\n    }\n\n    const handleSelectStudent = (student: Student) => {\n        setSelectedStudent(student)\n        setFormData(prev => ({ ...prev, student_id: student.id }))\n        setStudentSearch('')\n        setFilteredStudents([])\n    }\n\n    const handleCreate = async (e: React.FormEvent) => {\n        e.preventDefault()\n        if (!user || !formData.student_id || !formData.academic_year_id || !formData.exemption_percentage || !formData.exemption_reason) {\n            alert('Please fill in all required fields')\n            return\n        }\n\n        const result = await window.electronAPI.createExemption({\n            student_id: formData.student_id,\n            academic_year_id: formData.academic_year_id,\n            term_id: formData.term_id || undefined,\n            fee_category_id: formData.fee_category_id || undefined,\n            exemption_percentage: parseFloat(formData.exemption_percentage),\n            exemption_reason: formData.exemption_reason,\n            notes: formData.notes || undefined\n        }, user.id)\n\n        if (result.success) {\n            alert('Exemption created successfully!')\n            setShowModal(false)\n            setFormData({\n                student_id: 0, academic_year_id: formData.academic_year_id, term_id: formData.term_id,\n                fee_category_id: 0, exemption_percentage: '', exemption_reason: '', notes: ''\n            })\n            setSelectedStudent(null)\n            void loadData()\n        } else {\n            alert(`Error: ${result.errors?.join(', ')}`)\n        }\n    }\n\n    const handleRevoke = async () => {\n        if (!user || !selectedExemption || !revokeReason) {\n            alert('Please provide a reason for revoking')\n            return\n        }\n\n        const result = await window.electronAPI.revokeExemption(selectedExemption.id, revokeReason, user.id)\n        if (result.success) {\n            alert('Exemption revoked successfully')\n            setShowRevokeModal(false)\n            setSelectedExemption(null)\n            setRevokeReason('')\n            void loadData()\n        } else {\n            alert(`Error: ${result.errors?.join(', ')}`)\n        }\n    }\n\n    const getReasonBadgeColor = (reason: string) => {\n        const lowerReason = reason.toLowerCase()\n        if (lowerReason.includes('scholarship')) {return 'bg-blue-100 text-blue-800'}\n        if (lowerReason.includes('staff')) {return 'bg-purple-100 text-purple-800'}\n        if (lowerReason.includes('bursary')) {return 'bg-green-100 text-green-800'}\n        if (lowerReason.includes('orphan')) {return 'bg-orange-100 text-orange-800'}\n        return 'bg-gray-100 text-gray-800'\n    }\n\n    if (loading) {\n        return <div className=\"p-6 text-center\">Loading...</div>\n    }\n\n    return (\n        <div className=\"p-6 space-y-6\">\n            {/* Header */}\n            <div className=\"flex justify-between items-center\">\n                <div>\n                    <h1 className=\"text-2xl font-bold text-gray-900\">Fee Exemptions</h1>\n                    <p className=\"text-gray-600\">Manage student fee exemptions and scholarships</p>\n                </div>\n                <button\n                    onClick={() => setShowModal(true)}\n                    className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\n                >\n                    + Grant Exemption\n                </button>\n            </div>\n\n            {/* Stats Cards */}\n            {stats && (\n                <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                    <div className=\"bg-white p-4 rounded-lg shadow border-l-4 border-blue-500\">\n                        <div className=\"text-sm text-gray-500\">Total Exemptions</div>\n                        <div className=\"text-2xl font-bold\">{stats.totalExemptions}</div>\n                    </div>\n                    <div className=\"bg-white p-4 rounded-lg shadow border-l-4 border-green-500\">\n                        <div className=\"text-sm text-gray-500\">Active</div>\n                        <div className=\"text-2xl font-bold\">{stats.activeExemptions}</div>\n                    </div>\n                    <div className=\"bg-white p-4 rounded-lg shadow border-l-4 border-purple-500\">\n                        <div className=\"text-sm text-gray-500\">Full (100%)</div>\n                        <div className=\"text-2xl font-bold\">{stats.fullExemptions}</div>\n                    </div>\n                    <div className=\"bg-white p-4 rounded-lg shadow border-l-4 border-orange-500\">\n                        <div className=\"text-sm text-gray-500\">Partial</div>\n                        <div className=\"text-2xl font-bold\">{stats.partialExemptions}</div>\n                    </div>\n                </div>\n            )}\n\n            {/* Filters */}\n            <div className=\"flex gap-4\">\n                <select\n                    value={statusFilter}\n                    onChange={(e) => setStatusFilter(e.target.value)}\n                    className=\"px-4 py-2 border rounded-lg\"\n                    aria-label=\"Filter by status\"\n                >\n                    <option value=\"\">All Status</option>\n                    <option value=\"ACTIVE\">Active</option>\n                    <option value=\"REVOKED\">Revoked</option>\n                </select>\n            </div>\n\n            {/* Exemptions Table */}\n            <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n                <table className=\"min-w-full divide-y divide-gray-200\">\n                    <thead className=\"bg-gray-50\">\n                        <tr>\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Student</th>\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Year/Term</th>\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Category</th>\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Exemption</th>\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Reason</th>\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Status</th>\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Approved By</th>\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Actions</th>\n                        </tr>\n                    </thead>\n                    <tbody className=\"bg-white divide-y divide-gray-200\">\n                        {exemptions.map(exemption => (\n                            <tr key={exemption.id}>\n                                <td className=\"px-6 py-4 whitespace-nowrap\">\n                                    <div className=\"text-sm font-medium\">{exemption.student_name}</div>\n                                </td>\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm\">\n                                    {exemption.year_name} {exemption.term_name && `/ ${exemption.term_name}`}\n                                </td>\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm\">\n                                    {exemption.category_name || <span className=\"text-gray-400\">All Categories</span>}\n                                </td>\n                                <td className=\"px-6 py-4 whitespace-nowrap\">\n                                    <span className={`px-2 py-1 text-sm font-bold rounded ${exemption.exemption_percentage === 100\n                                        ? 'bg-green-100 text-green-800'\n                                        : 'bg-yellow-100 text-yellow-800'\n                                        }`}>\n                                        {exemption.exemption_percentage}%\n                                    </span>\n                                </td>\n                                <td className=\"px-6 py-4 whitespace-nowrap\">\n                                    <span className={`px-2 py-1 text-xs rounded-full ${getReasonBadgeColor(exemption.exemption_reason)}`}>\n                                        {exemption.exemption_reason}\n                                    </span>\n                                </td>\n                                <td className=\"px-6 py-4 whitespace-nowrap\">\n                                    <span className={`px-2 py-1 text-xs rounded-full ${exemption.status === 'ACTIVE'\n                                        ? 'bg-green-100 text-green-800'\n                                        : 'bg-red-100 text-red-800'\n                                        }`}>\n                                        {exemption.status}\n                                    </span>\n                                </td>\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\n                                    {exemption.approved_by_name}\n                                </td>\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm\">\n                                    {exemption.status === 'ACTIVE' && (\n                                        <button\n                                            onClick={() => { setSelectedExemption(exemption); setShowRevokeModal(true); }}\n                                            className=\"text-red-600 hover:text-red-800\"\n                                        >\n                                            Revoke\n                                        </button>\n                                    )}\n                                </td>\n                            </tr>\n                        ))}\n                        {exemptions.length === 0 && (\n                            <tr>\n                                <td colSpan={8} className=\"px-6 py-8 text-center text-gray-500\">\n                                    No exemptions found\n                                </td>\n                            </tr>\n                        )}\n                    </tbody>\n                </table>\n            </div>\n\n            {/* Grant Exemption Modal */}\n            {showModal && (\n                <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n                    <div className=\"bg-white rounded-lg p-6 w-full max-w-lg\">\n                        <h2 className=\"text-xl font-bold mb-4\">Grant Fee Exemption</h2>\n                        <form onSubmit={handleCreate} className=\"space-y-4\">\n                            {/* Student Search */}\n                            <div className=\"relative\">\n                                <label htmlFor=\"field-311\" className=\"block text-sm font-medium mb-1\">Student *</label>\n                                {selectedStudent ? (\n                                    <div className=\"flex items-center justify-between p-2 border rounded-lg bg-blue-50\">\n                                        <span>{selectedStudent.first_name} {selectedStudent.last_name} ({selectedStudent.admission_number})</span>\n                                        <button type=\"button\" onClick={() => setSelectedStudent(null)} className=\"text-red-500\"></button>\n                                    </div>\n                                ) : (\n                                    <>\n                                        <input id=\"field-311\"\n                                            type=\"text\"\n                                            value={studentSearch}\n                                            onChange={(e) => setStudentSearch(e.target.value)}\n                                            className=\"w-full border rounded-lg p-2\"\n                                            placeholder=\"Search by name or admission number...\"\n                                        />\n                                        {filteredStudents.length > 0 && (\n                                            <div className=\"absolute z-10 w-full bg-white border rounded-lg shadow-lg mt-1 max-h-40 overflow-auto\">\n                                                {filteredStudents.map(s => (\n                                                    <div\n                                                        key={s.id}\n                                                        onClick={() => handleSelectStudent(s)}\n                                                        onKeyDown={(e) => {\n                                                            if (e.key === 'Enter' || e.key === ' ') {\n                                                                handleSelectStudent(s)\n                                                            }\n                                                        }}\n                                                        tabIndex={0}\n                                                        role=\"button\"\n                                                        className=\"p-2 hover:bg-gray-100 cursor-pointer\"\n                                                    >\n                                                        {s.first_name} {s.last_name} ({s.admission_number})\n                                                    </div>\n                                                ))}\n                                            </div>\n                                        )}\n                                    </>\n                                )}\n                            </div>\n\n                            <div className=\"grid grid-cols-2 gap-4\">\n                                <div>\n                                    <label htmlFor=\"field-352\" className=\"block text-sm font-medium mb-1\">Academic Year *</label>\n                                    <select id=\"field-352\"\n                                        value={formData.academic_year_id}\n                                        onChange={(e) => handleYearChange(parseInt(e.target.value))}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        required\n                                        aria-label=\"Academic year\"\n                                    >\n                                        <option value=\"\">Select Year</option>\n                                        {academicYears.map(y => (\n                                            <option key={y.id} value={y.id}>{y.year_name}</option>\n                                        ))}\n                                    </select>\n                                </div>\n                                <div>\n                                    <label htmlFor=\"field-367\" className=\"block text-sm font-medium mb-1\">Term (Optional)</label>\n                                    <select id=\"field-367\"\n                                        value={formData.term_id}\n                                        onChange={(e) => setFormData({ ...formData, term_id: parseInt(e.target.value) })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        aria-label=\"Term\"\n                                    >\n                                        <option value=\"\">All Terms</option>\n                                        {terms.map(t => (\n                                            <option key={t.id} value={t.id}>{t.term_name}</option>\n                                        ))}\n                                    </select>\n                                </div>\n                            </div>\n\n                            <div className=\"grid grid-cols-2 gap-4\">\n                                <div>\n                                    <label htmlFor=\"field-384\" className=\"block text-sm font-medium mb-1\">Fee Category (Optional)</label>\n                                    <select id=\"field-384\"\n                                        value={formData.fee_category_id}\n                                        onChange={(e) => setFormData({ ...formData, fee_category_id: parseInt(e.target.value) })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        aria-label=\"Fee category\"\n                                    >\n                                        <option value=\"\">All Categories</option>\n                                        {feeCategories.map(c => (\n                                            <option key={c.id} value={c.id}>{c.category_name}</option>\n                                        ))}\n                                    </select>\n                                </div>\n                                <div>\n                                    <label htmlFor=\"field-398\" className=\"block text-sm font-medium mb-1\">Exemption Percentage *</label>\n                                    <input id=\"field-398\"\n                                        type=\"number\"\n                                        value={formData.exemption_percentage}\n                                        onChange={(e) => setFormData({ ...formData, exemption_percentage: e.target.value })}\n                                        className=\"w-full border rounded-lg p-2\"\n                                        placeholder=\"e.g., 50, 75, 100\"\n                                        min=\"1\"\n                                        max=\"100\"\n                                        required\n                                    />\n                                </div>\n                            </div>\n\n                            <div>\n                                <label htmlFor=\"field-413\" className=\"block text-sm font-medium mb-1\">Reason *</label>\n                                <select id=\"field-413\"\n                                    value={formData.exemption_reason}\n                                    onChange={(e) => setFormData({ ...formData, exemption_reason: e.target.value })}\n                                    className=\"w-full border rounded-lg p-2\"\n                                    required\n                                    aria-label=\"Exemption reason\"\n                                >\n                                    <option value=\"\">Select Reason</option>\n                                    <option value=\"Scholarship\">Scholarship</option>\n                                    <option value=\"Bursary\">Bursary</option>\n                                    <option value=\"Staff Child\">Staff Child</option>\n                                    <option value=\"Orphan Support\">Orphan Support</option>\n                                    <option value=\"Board Decision\">Board Decision</option>\n                                    <option value=\"Special Case\">Special Case</option>\n                                </select>\n                            </div>\n\n                            <div>\n                                <label htmlFor=\"field-432\" className=\"block text-sm font-medium mb-1\">Notes</label>\n                                <textarea id=\"field-432\"\n                                    value={formData.notes}\n                                    onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                                    className=\"w-full border rounded-lg p-2\"\n                                    rows={2}\n                                    placeholder=\"Additional notes about this exemption...\"\n                                />\n                            </div>\n\n                            <div className=\"flex justify-end gap-2\">\n                                <button\n                                    type=\"button\"\n                                    onClick={() => { setShowModal(false); setSelectedStudent(null); }}\n                                    className=\"px-4 py-2 bg-gray-200 rounded-lg\"\n                                >\n                                    Cancel\n                                </button>\n                                <button\n                                    type=\"submit\"\n                                    className=\"px-4 py-2 bg-blue-600 text-white rounded-lg\"\n                                >\n                                    Grant Exemption\n                                </button>\n                            </div>\n                        </form>\n                    </div>\n                </div>\n            )}\n\n            {/* Revoke Modal */}\n            {showRevokeModal && selectedExemption && (\n                <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n                    <div className=\"bg-white rounded-lg p-6 w-full max-w-md\">\n                        <h2 className=\"text-xl font-bold mb-4 text-red-600\">Revoke Exemption</h2>\n                        <p className=\"text-sm text-gray-600 mb-4\">\n                            Are you sure you want to revoke the {selectedExemption.exemption_percentage}% exemption for {selectedExemption.student_name}?\n                        </p>\n                        <div className=\"mb-4\">\n                            <label htmlFor=\"field-471\" className=\"block text-sm font-medium mb-1\">Reason for Revocation *</label>\n                            <textarea id=\"field-471\"\n                                value={revokeReason}\n                                onChange={(e) => setRevokeReason(e.target.value)}\n                                className=\"w-full border rounded-lg p-2\"\n                                rows={3}\n                                placeholder=\"Please provide a reason...\"\n                                required\n                            />\n                        </div>\n                        <div className=\"flex justify-end gap-2\">\n                            <button\n                                onClick={() => { setShowRevokeModal(false); setSelectedExemption(null); setRevokeReason(''); }}\n                                className=\"px-4 py-2 bg-gray-200 rounded-lg\"\n                            >\n                                Cancel\n                            </button>\n                            <button\n                                onClick={handleRevoke}\n                                className=\"px-4 py-2 bg-red-600 text-white rounded-lg\"\n                            >\n                                Revoke Exemption\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            )}\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\FeePayment.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\FeeStructure.tsx","messages":[{"ruleId":"sonarjs/no-nested-functions","severity":1,"message":"Refactor this code to not nest functions more than 4 levels deep.","line":322,"column":73,"nodeType":null,"endLine":322,"endColumn":75}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Save, Plus, Loader2 } from 'lucide-react'\nimport { useEffect, useState, useCallback } from 'react'\n\nimport { useToast } from '../../contexts/ToastContext'\nimport { useAuthStore } from '../../stores'\nimport { type AcademicYear, type Term, type Stream } from '../../types/electron-api/AcademicAPI'\nimport { type FeeCategory, type FeeStructureCreateData } from '../../types/electron-api/FinanceAPI'\nimport { centsToShillings, shillingsToCents } from '../../utils/format'\n\ninterface FeeStructureItem {\n    stream_id?: number\n    streamId?: number\n    student_type?: string\n    studentType?: string\n    fee_category_id?: number\n    feeCategoryId?: number\n    amount?: number\n}\n\nexport default function FeeStructure() {\n    const { showToast } = useToast()\n    const { user } = useAuthStore()\n\n    const [years, setYears] = useState<AcademicYear[]>([])\n    const [terms, setTerms] = useState<Term[]>([])\n    const [streams, setStreams] = useState<Stream[]>([])\n    const [categories, setCategories] = useState<FeeCategory[]>([])\n\n    const [selectedYear, setSelectedYear] = useState('')\n    const [selectedTerm, setSelectedTerm] = useState('')\n\n    const [structure, setStructure] = useState<Record<string, number>>({})\n    const [loading, setLoading] = useState(false)\n    const [saving, setSaving] = useState(false)\n    const [generating, setGenerating] = useState(false)\n\n    // For new category\n    const [showNewCategory, setShowNewCategory] = useState(false)\n    const [newCategoryName, setNewCategoryName] = useState('')\n\n    const loadInitialData = useCallback(async () => {\n        try {\n            const [y, s, c] = await Promise.all([\n                window.electronAPI.getAcademicYears(),\n                window.electronAPI.getStreams(),\n                window.electronAPI.getFeeCategories()\n            ])\n            setYears(y)\n            setStreams(s)\n            setCategories(c)\n\n            // Auto-select current year/term if possible\n            const currentYear = await window.electronAPI.getCurrentAcademicYear()\n            if (currentYear) {\n                setSelectedYear(currentYear.id.toString())\n                const termList = await window.electronAPI.getTermsByYear(currentYear.id)\n                setTerms(termList)\n                const currentTerm = await window.electronAPI.getCurrentTerm()\n                if (currentTerm) {setSelectedTerm(currentTerm.id.toString())}\n                else if (termList.length > 0) {setSelectedTerm(termList[0].id.toString())}\n            }\n        } catch (error) {\n            console.error(error)\n            showToast('Failed to load initial data', 'error')\n        }\n    }, [showToast])\n\n\n\n    useEffect(() => {\n        void loadInitialData()\n    }, [loadInitialData])\n\n    useEffect(() => {\n        const loadStructure = async () => {\n            setLoading(true)\n            try {\n                const data = await window.electronAPI.getFeeStructure(Number(selectedYear), Number(selectedTerm))\n                const map: Record<string, number> = {}\n                data.forEach((item: FeeStructureItem) => {\n                    // Handle both FeeStructure and FeeStructureItem formats\n                    const streamId = item.stream_id || item.streamId\n                    const studentType = item.student_type || item.studentType\n                    const categoryId = item.fee_category_id || item.feeCategoryId || item.fee_category_id\n                    const amount = item.amount\n\n                    if (streamId && studentType && categoryId && amount !== undefined) {\n                        const key = `${streamId}-${studentType}-${categoryId}`\n                        // Convert cents from DB to shillings for UI display\n                        map[key] = centsToShillings(amount)\n                    }\n                })\n                setStructure(map)\n            } catch (error) {\n                console.error(error)\n                showToast('Failed to load fee structure', 'error')\n            } finally {\n                setLoading(false)\n            }\n        }\n\n        if (selectedYear && selectedTerm) {\n            void loadStructure()\n        }\n    }, [selectedYear, selectedTerm, showToast])\n\n\n\n    const handleAmountChange = (streamId: number, studentType: string, categoryId: number, value: string) => {\n        const key = `${streamId}-${studentType}-${categoryId}`\n        setStructure(prev => ({ ...prev, [key]: Number(value) || 0 }))\n    }\n\n    const handleSave = async () => {\n        if (!selectedYear || !selectedTerm) {\n            showToast('Please select academic year and term', 'error')\n            return\n        }\n\n        setSaving(true)\n        try {\n            const data: FeeStructureCreateData[] = []\n            for (const [key, amount] of Object.entries(structure)) {\n                if (amount > 0) {\n                    const [streamId, studentType, categoryId] = key.split('-')\n                    data.push({\n                        stream_id: Number(streamId),\n                        student_type: studentType,\n                        fee_category_id: Number(categoryId),\n                        // Convert shillings from UI back to cents for DB storage\n                        amount: shillingsToCents(amount),\n                        academic_year_id: Number(selectedYear),\n                        term_id: Number(selectedTerm)\n                    })\n                }\n            }\n\n            await window.electronAPI.saveFeeStructure(data, Number(selectedYear), Number(selectedTerm))\n            showToast('Fee structure saved successfully', 'success')\n        } catch (error) {\n            console.error(error)\n            showToast('Failed to save fee structure', 'error')\n        } finally {\n            setSaving(false)\n        }\n    }\n\n    const handleCreateCategory = async () => {\n        if (!newCategoryName.trim()) {return}\n        try {\n            await window.electronAPI.createFeeCategory(newCategoryName, '')\n            setNewCategoryName('')\n            setShowNewCategory(false)\n            const c = await window.electronAPI.getFeeCategories()\n            setCategories(c)\n            showToast('Category created', 'success')\n        } catch (error) {\n            console.error(error)\n            showToast('Failed to create category', 'error')\n        }\n    }\n\n    const handleGenerateInvoices = async () => {\n        // if (!confirm('This will generate invoices for all active students based on this structure. Are you sure?')) return\n\n        setGenerating(true)\n        try {\n            if (!user?.id) {\n                showToast('You must be signed in to generate invoices', 'error')\n                return\n            }\n\n            const result = await window.electronAPI.generateBatchInvoices(Number(selectedYear), Number(selectedTerm), user.id)\n\n            if (result.success) {\n                showToast(`Successfully generated ${result.count} invoices`, 'success')\n            } else {\n                showToast('Failed to generate invoices', 'error')\n            }\n        } catch (error: unknown) {\n            console.error('Generation Error:', error)\n            const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n            showToast(`Error: ${errorMessage}`, 'error')\n        } finally {\n            setGenerating(false)\n        }\n    }\n\n    return (\n        <div className=\"p-6\">\n            <div className=\"flex items-center justify-between mb-6\">\n                <div>\n                    <h1 className=\"text-3xl font-bold text-foreground font-heading\">Fee Structure</h1>\n                    <p className=\"text-foreground/50 mt-1 font-medium italic\">Manage fee amounts per class and term</p>\n                </div>\n                <div className=\"flex gap-2\">\n                    <button\n                        onClick={handleGenerateInvoices}\n                        disabled={generating}\n                        className=\"btn btn-secondary flex items-center gap-2\"\n                        title=\"Generate invoices for all students based on this structure\"\n                    >\n                        {generating ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Save className=\"w-4 h-4\" />}\n                        Batch Invoice\n                    </button>\n                    <button\n                        onClick={handleSave}\n                        disabled={saving}\n                        className=\"btn btn-primary flex items-center gap-2\"\n                    >\n                        {saving ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Save className=\"w-4 h-4\" />}\n                        Save Changes\n                    </button>\n                </div>\n            </div>\n\n            <div className=\"premium-card mb-6 p-4\">\n                <div className=\"flex flex-wrap gap-4 items-end\">\n                    <div className=\"flex-1 min-w-[200px]\">\n                        <label htmlFor=\"field-220\" className=\"block text-[10px] font-bold text-foreground/40 uppercase tracking-widest mb-1.5 ml-1\">Academic Year</label>\n                        <select id=\"field-220\"\n                            value={selectedYear}\n                            onChange={e => {\n                                setSelectedYear(e.target.value)\n                                void window.electronAPI.getTermsByYear(Number(e.target.value)).then(terms => setTerms(terms))\n                            }}\n                            className=\"input w-full bg-secondary/30 border-border/20 focus:border-primary/50 transition-all font-medium py-2.5\"\n                        >\n                            <option value=\"\" className=\"bg-background\">Select Year</option>\n                            {years.map(y => (\n                                <option key={y.id} value={y.id} className=\"bg-background\">{y.year_name}</option>\n                            ))}\n                        </select>\n                    </div>\n                    <div className=\"flex-1 min-w-[200px]\">\n                        <label htmlFor=\"field-236\" className=\"block text-[10px] font-bold text-foreground/40 uppercase tracking-widest mb-1.5 ml-1\">Term</label>\n                        <select id=\"field-236\"\n                            value={selectedTerm}\n                            onChange={e => setSelectedTerm(e.target.value)}\n                            className=\"input w-full bg-secondary/30 border-border/20 focus:border-primary/50 transition-all font-medium py-2.5\"\n                            disabled={!selectedYear}\n                        >\n                            <option value=\"\" className=\"bg-background\">Select Term</option>\n                            {terms.map(t => (\n                                <option key={t.id} value={t.id} className=\"bg-background\">{t.term_name}</option>\n                            ))}\n                        </select>\n                    </div>\n                </div>\n            </div>\n\n            {loading ? (\n                <div className=\"text-center py-12\">Loading...</div>\n            ) : (\n                <div className=\"premium-card\">\n                    <div className=\"flex justify-between items-center mb-6\">\n                        <h3 className=\"text-lg font-bold text-foreground\">Fee Matrix</h3>\n                        <button\n                            onClick={() => setShowNewCategory(true)}\n                            className=\"text-sm text-primary hover:text-primary p-2 hover:bg-primary/10 rounded-xl transition-all font-bold flex items-center gap-1.5\"\n                        >\n                            <Plus className=\"w-4 h-4\" /> Add Category\n                        </button>\n                    </div>\n\n                    {showNewCategory && (\n                        <div className=\"mb-6 flex gap-2 items-center bg-primary/5 border border-primary/10 p-4 rounded-xl animate-in slide-in-from-top-2 duration-300\">\n                            <input\n                                type=\"text\"\n                                value={newCategoryName}\n                                onChange={e => setNewCategoryName(e.target.value)}\n                                placeholder=\"New Category Name (e.g. Swimming)\"\n                                className=\"input flex-1 h-10\"\n                            />\n                            <button onClick={handleCreateCategory} className=\"btn btn-primary h-10 px-4\">Add</button>\n                            <button onClick={() => setShowNewCategory(false)} className=\"btn btn-secondary h-10 px-4\">Cancel</button>\n                        </div>\n                    )}\n\n                    {/* Scrollable Table Container - max height with hidden scrollbar */}\n                    <div className=\"overflow-auto no-scrollbar max-h-[60vh] rounded-xl border border-border/20\">\n                        <table className=\"min-w-full divide-y divide-border/20\">\n                            <thead className=\"sticky top-0 z-40\">\n                                <tr className=\"bg-card\">\n                                    <th className=\"px-4 py-4 text-left text-[10px] font-bold text-foreground/40 uppercase tracking-widest sticky left-0 bg-card z-50 min-w-[140px] border-r border-border/20\">Class / Stream</th>\n                                    <th className=\"px-4 py-4 text-left text-[10px] font-bold text-foreground/40 uppercase tracking-widest sticky left-[140px] bg-card z-50 min-w-[100px] border-r border-border/20\">Type</th>\n                                    {categories.map(cat => (\n                                        <th key={cat.id} className=\"px-4 py-4 text-left text-[10px] font-bold text-foreground/40 uppercase tracking-widest min-w-[120px] bg-card\">\n                                            {cat.category_name}\n                                        </th>\n                                    ))}\n                                    <th className=\"px-4 py-4 text-left text-[10px] font-bold text-emerald-500/80 uppercase tracking-widest sticky right-0 bg-card z-50 border-l border-border/20\">Total</th>\n                                </tr>\n                            </thead>\n                            <tbody className=\"divide-y divide-border/20\">\n                                {streams.flatMap(stream =>\n                                    ['DAY_SCHOLAR', 'BOARDER'].map((type, idx) => (\n                                        <tr key={`${stream.id}-${type}`} className={`${idx === 0 ? 'bg-background' : 'bg-card'} hover:bg-accent/10 transition-colors`}>\n                                            {idx === 0 && (\n                                                <td\n                                                    rowSpan={2}\n                                                    className=\"px-4 py-3 whitespace-nowrap text-sm font-bold text-foreground sticky left-0 z-30 border-r border-border/20\"\n                                                    style={{ backgroundColor: 'hsl(var(--background))' }}\n                                                >\n                                                    {stream.stream_name}\n                                                </td>\n                                            )}\n                                            <td\n                                                className=\"px-4 py-3 whitespace-nowrap text-[10px] font-bold text-foreground/40 uppercase sticky left-[140px] z-30 border-r border-border/20\"\n                                                style={{ backgroundColor: idx === 0 ? 'hsl(var(--background))' : 'hsl(var(--card))' }}\n                                            >\n                                                {type.replace('_', ' ')}\n                                            </td>\n                                            {categories.map(cat => {\n                                                const key = `${stream.id}-${type}-${cat.id}`\n                                                return (\n                                                    <td key={cat.id} className=\"px-2 py-3 whitespace-nowrap\">\n                                                        <input\n                                                            type=\"number\"\n                                                            min=\"0\"\n                                                            value={structure[key] || ''}\n                                                            onChange={e => handleAmountChange(stream.id, type, cat.id, e.target.value)}\n                                                            className=\"w-full text-right bg-secondary/30 border border-border/20 rounded-lg px-2 py-1.5 text-sm font-mono text-foreground focus:ring-2 focus:ring-primary/20 transition-all\"\n                                                            placeholder=\"0\"\n                                                        />\n                                                    </td>\n                                                )\n                                            })}\n                                            <td\n                                                className=\"px-4 py-3 whitespace-nowrap text-sm font-bold text-emerald-400 text-right sticky right-0 z-30 border-l border-border/20\"\n                                                style={{ backgroundColor: idx === 0 ? 'hsl(var(--background))' : 'hsl(var(--card))' }}\n                                            >\n                                                {categories.reduce((sum, cat) => {\n                                                    const key = `${stream.id}-${type}-${cat.id}`\n                                                    return sum + (structure[key] || 0)\n                                                }, 0).toLocaleString()}\n                                            </td>\n                                        </tr>\n                                    ))\n                                )}\n                            </tbody>\n                        </table>\n                    </div>\n                </div>\n            )}\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\FinancialReports.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":2,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":58,"column":8,"nodeType":"ArrayExpression","endLine":58,"endColumn":30,"suggestions":[{"desc":"Update the dependencies array to be: [dateRange, loadData, showToast]","fix":{"range":[2288,2310],"text":"[dateRange, loadData, showToast]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\FixedAssets\\AssetRegister.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\FixedAssets\\Depreciation.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Grants\\GrantTracking.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Invoices.tsx","messages":[{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":91,"column":21,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":149,"endColumn":18},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":131,"column":49,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":132,"endColumn":73},{"ruleId":"sonarjs/no-nested-conditional","severity":1,"message":"Extract this nested ternary operation into an independent statement.","line":178,"column":37,"nodeType":"ConditionalExpression","messageId":"extractTernary","endLine":179,"endColumn":61}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { FileText, Plus, Loader2, CheckCircle, AlertCircle, Eye, Printer } from 'lucide-react'\nimport { useEffect, useState, useMemo, useCallback } from 'react'\nimport { useNavigate } from 'react-router-dom'\n\nimport { PageHeader } from '../../components/patterns/PageHeader'\nimport { StatCard } from '../../components/patterns/StatCard'\nimport { Modal } from '../../components/ui/Modal'\nimport { useToast } from '../../contexts/ToastContext'\nimport { type Invoice, type InvoiceItem } from '../../types/electron-api/FinanceAPI'\nimport { formatCurrencyFromCents, formatDate } from '../../utils/format'\nimport { printCurrentView } from '../../utils/print'\n\nexport default function Invoices() {\n    const [invoices, setInvoices] = useState<Invoice[]>([])\n    const [loading, setLoading] = useState(true)\n    const [selectedInvoice, setSelectedInvoice] = useState<Invoice | null>(null)\n    const [invoiceItems, setInvoiceItems] = useState<InvoiceItem[]>([])\n    const navigate = useNavigate()\n    const { showToast } = useToast()\n\n    const loadInvoices = useCallback(async () => {\n        try {\n            const data = await window.electronAPI.getInvoices()\n            setInvoices(data)\n        } catch (error) {\n            console.error('Failed to load invoices:', error)\n            showToast('Failed to load invoices', 'error')\n        } finally {\n            setLoading(false)\n        }\n    }, [showToast])\n\n    useEffect(() => {\n        void loadInvoices()\n    }, [loadInvoices])\n\n    const viewInvoice = async (invoice: Invoice) => {\n        try {\n            const items = await window.electronAPI.getInvoiceItems(invoice.id)\n            setInvoiceItems(items)\n            setSelectedInvoice(invoice)\n        } catch (error) {\n            console.error('Failed to load invoice items:', error)\n        }\n    }\n\n    const stats = useMemo(() => {\n        const total = invoices.reduce((acc, inv) => acc + inv.total_amount, 0)\n        const paid = invoices.reduce((acc, inv) => acc + inv.amount_paid, 0)\n        const balance = total - paid\n\n        return [\n            { label: 'Total Invoiced', value: formatCurrencyFromCents(total), icon: FileText, color: 'from-blue-500/20 to-indigo-500/20 text-indigo-400' },\n            { label: 'Total Collected', value: formatCurrencyFromCents(paid), icon: CheckCircle, color: 'from-emerald-500/20 to-teal-500/20 text-emerald-400' },\n            { label: 'Outstanding Balance', value: formatCurrencyFromCents(balance), icon: AlertCircle, color: 'from-rose-500/20 to-orange-500/20 text-rose-400' },\n        ]\n    }, [invoices])\n\n    return (\n        <div className=\"space-y-6\">\n            <PageHeader\n                title=\"Invoices\"\n                subtitle=\"Manage and track student fee invoices\"\n                breadcrumbs={[\n                    { label: 'Finance', href: '/finance/fee-payment' },\n                    { label: 'Invoices' }\n                ]}\n                actions={\n                    <button\n                        onClick={() => navigate('/fee-structure')}\n                        className=\"btn btn-primary flex items-center gap-2\"\n                    >\n                        <Plus className=\"w-5 h-5\" />\n                        <span>Generate Invoices</span>\n                    </button>\n                }\n            />\n\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                {stats.map((stat, i) => (\n                    <StatCard key={i} {...stat} />\n                ))}\n            </div>\n\n            <div className=\"premium-card\">\n                {loading ? (\n                    <div className=\"text-center py-16 text-foreground/40 flex flex-col items-center gap-2\">\n                        <Loader2 className=\"w-8 h-8 animate-spin text-primary/40\" />\n                        <span>Loading invoices...</span>\n                    </div>\n                ) : invoices.length === 0 ? (\n                    <div className=\"text-center py-16\">\n                        <FileText className=\"w-16 h-16 text-foreground/10 mx-auto mb-4\" />\n                        <h3 className=\"text-lg font-bold text-foreground mb-2\">No Invoices Yet</h3>\n                        <p className=\"text-foreground/40 mb-6\">Generate invoices for students to track fee balances</p>\n                        <button\n                            onClick={() => navigate('/fee-structure')}\n                            className=\"btn btn-primary\"\n                        >\n                            Generate Term Invoices\n                        </button>\n                    </div>\n                ) : (\n                    <div className=\"overflow-x-auto\">\n                        <table className=\"premium-table\">\n                            <thead>\n                                <tr>\n                                    <th>Invoice No</th>\n                                    <th>Student</th>\n                                    <th>Term</th>\n                                    <th>Date</th>\n                                    <th className=\"text-right\">Amount</th>\n                                    <th className=\"text-right\">Paid</th>\n                                    <th className=\"text-right\">Balance</th>\n                                    <th className=\"text-center\">Status</th>\n                                    <th className=\"text-right\">Actions</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                {invoices.map((inv) => (\n                                    <tr key={inv.id}>\n                                        <td className=\"font-mono text-xs font-bold\">{inv.invoice_number}</td>\n                                        <td className=\"font-bold\">{inv.student_name}</td>\n                                        <td>{inv.term_name}</td>\n                                        <td>{formatDate(inv.invoice_date)}</td>\n                                        <td className=\"text-right font-medium\">{formatCurrencyFromCents(inv.total_amount)}</td>\n                                        <td className=\"text-right text-emerald-500 font-medium\">{formatCurrencyFromCents(inv.amount_paid)}</td>\n                                        <td className=\"text-right text-amber-500 font-bold\">{formatCurrencyFromCents(inv.total_amount - inv.amount_paid)}</td>\n                                        <td className=\"text-center\">\n                                            <span className={`status-badge ${inv.status === 'PAID' ? 'status-badge-success' :\n                                                inv.status === 'PARTIAL' ? 'status-badge-warning' :\n                                                    'status-badge-error'\n                                                }`}>{inv.status}</span>\n                                        </td>\n                                        <td className=\"text-right\">\n                                            <button\n                                                onClick={() => viewInvoice(inv)}\n                                                className=\"btn btn-secondary px-3 py-1.5 text-xs hover:border-primary/40 group\"\n                                            >\n                                                <Eye className=\"w-3.5 h-3.5 mr-1.5 opacity-40 group-hover:opacity-100\" />\n                                                Details\n                                            </button>\n                                        </td>\n                                    </tr>\n                                ))}\n                            </tbody>\n                        </table>\n                    </div>\n                )}\n            </div>\n\n            {/* View Invoice Modal */}\n            <Modal\n                isOpen={!!selectedInvoice}\n                onClose={() => setSelectedInvoice(null)}\n                title=\"Invoice Breakdown\"\n                size=\"md\"\n            >\n                {selectedInvoice && (\n                    <div id=\"invoice-print-area\" className=\"space-y-8\">\n                        {/* Header Details */}\n                        <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-6\">\n                            <div>\n                                <p className=\"text-[10px] uppercase tracking-widest font-bold text-foreground/40 mb-1\">Invoice Number</p>\n                                <p className=\"font-mono text-sm font-bold border-l-2 border-primary/40 pl-2\">{selectedInvoice.invoice_number}</p>\n                            </div>\n                            <div>\n                                <p className=\"text-[10px] uppercase tracking-widest font-bold text-foreground/40 mb-1\">Student</p>\n                                <p className=\"font-bold text-foreground\">{selectedInvoice.student_name}</p>\n                            </div>\n                            <div>\n                                <p className=\"text-[10px] uppercase tracking-widest font-bold text-foreground/40 mb-1\">Date Issued</p>\n                                <p className=\"font-medium text-foreground\">{formatDate(selectedInvoice.invoice_date)}</p>\n                            </div>\n                            <div>\n                                <p className=\"text-[10px] uppercase tracking-widest font-bold text-foreground/40 mb-1\">Status</p>\n                                <span className={`status-badge ${selectedInvoice.status === 'PAID' ? 'status-badge-success' :\n                                    selectedInvoice.status === 'PARTIAL' ? 'status-badge-warning' :\n                                        'status-badge-error'\n                                    }`}>{selectedInvoice.status}</span>\n                            </div>\n                        </div>\n\n                        {/* Breakdown Table */}\n                        <div className=\"border border-border/40 rounded-2xl overflow-hidden bg-secondary/10\">\n                            <table className=\"w-full text-left\">\n                                <thead>\n                                    <tr className=\"bg-secondary/40\">\n                                        <th className=\"px-6 py-3 text-[10px] font-bold text-foreground/40 uppercase tracking-widest\">Category Item</th>\n                                        <th className=\"px-6 py-3 text-right text-[10px] font-bold text-foreground/40 uppercase tracking-widest\">Amount</th>\n                                    </tr>\n                                </thead>\n                                <tbody className=\"divide-y divide-border/10\">\n                                    {invoiceItems.map((item, index) => (\n                                        <tr key={index} className=\"hover:bg-primary/5 transition-colors\">\n                                            <td className=\"px-6 py-4 text-sm text-foreground/80\">{item.category_name}</td>\n                                            <td className=\"px-6 py-4 text-sm font-mono text-foreground text-right\">{formatCurrencyFromCents(item.amount)}</td>\n                                        </tr>\n                                    ))}\n                                    <tr className=\"bg-secondary/20 font-bold text-lg\">\n                                        <td className=\"px-6 py-6 text-foreground\">Total Fee</td>\n                                        <td className=\"px-6 py-6 text-foreground text-right\">{formatCurrencyFromCents(selectedInvoice.total_amount)}</td>\n                                    </tr>\n                                </tbody>\n                            </table>\n                        </div>\n\n                        {/* Payment Summary */}\n                        <div className=\"flex justify-between items-center p-6 bg-gradient-to-br from-secondary/40 to-background border border-border/40 rounded-2xl shadow-inner\">\n                            <div>\n                                <p className=\"text-[10px] uppercase tracking-widest font-bold text-foreground/40 mb-1\">Total Paid</p>\n                                <p className=\"text-2xl font-bold text-emerald-500\">{formatCurrencyFromCents(selectedInvoice.amount_paid)}</p>\n                            </div>\n                            <div className=\"text-right\">\n                                <p className=\"text-[10px] uppercase tracking-widest font-bold text-foreground/40 mb-1\">Balance Due</p>\n                                <p className=\"text-2xl font-bold text-amber-500\">{formatCurrencyFromCents(selectedInvoice.total_amount - selectedInvoice.amount_paid)}</p>\n                            </div>\n                        </div>\n\n                        {/* Actions */}\n                        <div className=\"flex gap-3 justify-end pt-4\">\n                            <button\n                                onClick={() => printCurrentView({\n                                    title: `Invoice ${selectedInvoice.invoice_number}`,\n                                    selector: '#invoice-print-area'\n                                })}\n                                className=\"btn btn-secondary flex items-center gap-2 group border-primary/20\"\n                            >\n                                <Printer className=\"w-4 h-4 text-primary group-hover:scale-110 transition-transform\" />\n                                <span>Print Invoice</span>\n                            </button>\n                            <button\n                                onClick={() => setSelectedInvoice(null)}\n                                className=\"btn btn-primary\"\n                            >\n                                Done\n                            </button>\n                        </div>\n                    </div>\n                )}\n            </Modal>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Reconciliation\\ReconcileAccount.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\RecordExpense.tsx","messages":[{"ruleId":"sonarjs/no-identical-functions","severity":1,"message":"Update this function so that its implementation is not identical to the one on line 30.","line":42,"column":37,"nodeType":null,"endLine":42,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Plus, Check, Loader2, ArrowLeftCircle, Receipt, Tag, CreditCard, FileText, Calendar } from 'lucide-react'\nimport React, { useEffect, useState } from 'react'\n\nimport { useToast } from '../../contexts/ToastContext'\nimport { useAuthStore } from '../../stores'\nimport { type TransactionCategory } from '../../types/electron-api/FinanceAPI'\nimport { shillingsToCents } from '../../utils/format'\n\nexport default function RecordExpense() {\n    const { user } = useAuthStore()\n    const { showToast } = useToast()\n\n    const [categories, setCategories] = useState<TransactionCategory[]>([])\n    const [loading, setLoading] = useState(false)\n    const [saving, setSaving] = useState(false)\n    const [newCategory, setNewCategory] = useState('')\n    const [showNewCategoryInput, setShowNewCategoryInput] = useState(false)\n\n    const [formData, setFormData] = useState({\n        transaction_date: new Date().toISOString().slice(0, 10),\n        amount: '',\n        category_id: '',\n        payment_method: 'CASH',\n        payment_reference: '',\n        description: '',\n        transaction_type: 'EXPENSE'\n    })\n\n    useEffect(() => {\n        const loadCategories = async () => {\n            try {\n                const allCats = await window.electronAPI.getTransactionCategories()\n                setCategories(allCats.filter((c: TransactionCategory) => c.category_type === 'EXPENSE'))\n            } catch (error) {\n                console.error('Failed to load categories:', error)\n                showToast('Failed to load categories', 'error')\n            }\n        }\n        void loadCategories()\n    }, [showToast])\n\n    const loadCategories = async () => {\n        try {\n            const allCats = await window.electronAPI.getTransactionCategories()\n            setCategories(allCats.filter((c: TransactionCategory) => c.category_type === 'EXPENSE'))\n        } catch (error) {\n            console.error('Failed to load categories:', error)\n            showToast('Failed to load categories', 'error')\n        }\n    }\n\n    const handleCreateCategory = async () => {\n        if (!newCategory.trim()) {return}\n        try {\n            setLoading(true)\n            await window.electronAPI.createTransactionCategory(newCategory, 'EXPENSE')\n            await loadCategories()\n            setNewCategory('')\n            setShowNewCategoryInput(false)\n            showToast('Category created successfully', 'success')\n        } catch (error) {\n            console.error('Failed to create category:', error)\n            showToast('Failed to create category', 'error')\n        } finally {\n            setLoading(false)\n        }\n    }\n\n    const handleSubmit = async (e: React.FormEvent) => {\n        e.preventDefault()\n        if (!formData.amount || !formData.category_id) {\n            showToast('Please fill in all required fields', 'warning')\n            return\n        }\n\n        setSaving(true)\n        try {\n            await window.electronAPI.createTransaction({\n                transaction_date: formData.transaction_date,\n                amount: shillingsToCents(formData.amount), // Whole currency units\n                category_id: parseInt(formData.category_id),\n                reference: formData.payment_reference,\n                description: formData.description\n            }, user!.id)\n\n            showToast('Expense recorded successfully', 'success')\n            setFormData({\n                transaction_date: new Date().toISOString().slice(0, 10),\n                amount: '',\n                category_id: '',\n                payment_method: 'CASH',\n                payment_reference: '',\n                description: '',\n                transaction_type: 'EXPENSE'\n            })\n        } catch (error) {\n            console.error('Failed to record expense:', error)\n            showToast('Failed to record expense', 'error')\n        } finally {\n            setSaving(false)\n        }\n    }\n\n    return (\n        <div className=\"space-y-8 pb-10 max-w-5xl mx-auto\">\n            <div className=\"flex flex-col md:flex-row md:items-start justify-between gap-6\">\n                <div>\n                    <h1 className=\"text-3xl font-bold font-heading uppercase tracking-tight text-destructive/90\">Record Expense</h1>\n                    <p className=\"text-foreground/50 mt-1 font-medium italic\">Document operational expenditures and institutional payouts</p>\n                </div>\n                <button\n                    onClick={() => window.history.back()}\n                    className=\"flex items-center gap-2 text-foreground/40 text-[10px] font-bold uppercase tracking-widest hover:text-foreground transition-all group\"\n                >\n                    <ArrowLeftCircle className=\"w-5 h-5 group-hover:-translate-x-1 transition-transform\" />\n                    <span>Return to Finance Hub</span>\n                </button>\n            </div>\n\n            <div className=\"card animate-slide-up relative overflow-hidden\">\n                <div className=\"absolute top-0 right-0 p-8 opacity-5 group-hover:opacity-10 transition-opacity pointer-events-none\">\n                    <Receipt className=\"w-32 h-32 rotate-12\" />\n                </div>\n\n                <form onSubmit={handleSubmit} className=\"space-y-8 relative z-10\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\n                        {/* Date */}\n                        <div className=\"space-y-2\">\n                            <label htmlFor=\"transaction_date\" className=\"text-[10px] font-bold text-foreground/40 uppercase tracking-widest ml-1 flex items-center gap-2\">\n                                <Calendar className=\"w-3 h-3\" />\n                                Disbursement Timestamp <span className=\"text-destructive\">*</span>\n                            </label>\n                            <input\n                                id=\"transaction_date\"\n                                type=\"date\"\n                                required\n                                value={formData.transaction_date}\n                                onChange={(e) => setFormData({ ...formData, transaction_date: e.target.value })}\n                                className=\"input w-full bg-secondary/30 h-12 font-bold text-xs uppercase tracking-tight\"\n                            />\n                        </div>\n\n                        {/* Amount */}\n                        <div className=\"space-y-2\">\n                            <label htmlFor=\"amount\" className=\"text-[10px] font-bold text-foreground/40 uppercase tracking-widest ml-1 flex items-center gap-2\">\n                                <Tag className=\"w-3 h-3\" />\n                                Expenditure Magnitude (KES) <span className=\"text-destructive\">*</span>\n                            </label>\n                            <input\n                                id=\"amount\"\n                                type=\"number\"\n                                required\n                                min=\"0\"\n                                step=\"0.01\"\n                                value={formData.amount}\n                                onChange={(e) => setFormData({ ...formData, amount: e.target.value })}\n                                className=\"input w-full bg-secondary/30 h-12 text-lg font-bold\"\n                                placeholder=\"0.00\"\n                            />\n                        </div>\n\n                        {/* Category */}\n                        <div className=\"space-y-2\">\n                            <label htmlFor=\"category_id\" className=\"text-[10px] font-bold text-foreground/40 uppercase tracking-widest ml-1\">Cost Center Vector <span className=\"text-destructive\">*</span></label>\n                            <div className=\"flex gap-2\">\n                                <select\n                                    id=\"category_id\"\n                                    required\n                                    value={formData.category_id}\n                                    onChange={(e) => setFormData({ ...formData, category_id: e.target.value })}\n                                    className=\"input w-full bg-secondary/30 h-12 font-bold text-xs uppercase tracking-tight\"\n                                >\n                                    <option value=\"\">Select Category</option>\n                                    {categories.map(cat => (\n                                        <option key={cat.id} value={cat.id}>{cat.category_name}</option>\n                                    ))}\n                                </select>\n                                <button\n                                    type=\"button\"\n                                    onClick={() => setShowNewCategoryInput(!showNewCategoryInput)}\n                                    className=\"p-3 bg-secondary/50 border border-border/40 hover:bg-destructive/10 hover:border-destructive/40 rounded-xl transition-all\"\n                                    title=\"Add New Category\"\n                                >\n                                    <Plus className=\"w-5 h-5 text-foreground/60\" />\n                                </button>\n                            </div>\n                            {showNewCategoryInput && (\n                                <div className=\"mt-3 flex gap-2 animate-in slide-in-from-top-2 duration-300\">\n                                    <input\n                                        type=\"text\"\n                                        aria-label=\"New Category Name\"\n                                        value={newCategory}\n                                        onChange={(e) => setNewCategory(e.target.value)}\n                                        className=\"input flex-1 bg-secondary/50 h-12\"\n                                        placeholder=\"New Cost Center Identifier\"\n                                    />\n                                    <button\n                                        type=\"button\"\n                                        onClick={handleCreateCategory}\n                                        disabled={loading || !newCategory}\n                                        className=\"btn btn-primary px-4 h-12 bg-destructive hover:bg-destructive/80 border-none\"\n                                        title=\"Confirm Vector\"\n                                    >\n                                        {loading ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Check className=\"w-4 h-4\" />}\n                                    </button>\n                                </div>\n                            )}\n                        </div>\n\n                        {/* Payment Method */}\n                        <div className=\"space-y-2\">\n                            <label htmlFor=\"payment_method\" className=\"text-[10px] font-bold text-foreground/40 uppercase tracking-widest ml-1 flex items-center gap-2\">\n                                <CreditCard className=\"w-3 h-3\" />\n                                Payout Instrument <span className=\"text-destructive\">*</span>\n                            </label>\n                            <select\n                                id=\"payment_method\"\n                                required\n                                value={formData.payment_method}\n                                onChange={(e) => setFormData({ ...formData, payment_method: e.target.value })}\n                                className=\"input w-full bg-secondary/30 h-12 font-bold text-xs uppercase tracking-tight\"\n                            >\n                                <option value=\"CASH\">Liquid Cash</option>\n                                <option value=\"MPESA\">M-Pesa Mobile</option>\n                                <option value=\"BANK_TRANSFER\">Direct EFT/Bank</option>\n                                <option value=\"CHEQUE\">Banker's Cheque</option>\n                            </select>\n                        </div>\n\n                        {/* Reference */}\n                        <div className=\"space-y-2 lg:col-span-2\">\n                            <label htmlFor=\"payment_reference\" className=\"text-[10px] font-bold text-foreground/40 uppercase tracking-widest ml-1\">Audit Reference Number</label>\n                            <input\n                                id=\"payment_reference\"\n                                type=\"text\"\n                                value={formData.payment_reference}\n                                onChange={(e) => setFormData({ ...formData, payment_reference: e.target.value })}\n                                className=\"input w-full bg-secondary/30 h-12 font-mono text-xs tracking-wider\"\n                                placeholder=\"e.g. VOUCHER-99, CHQ-556\"\n                            />\n                        </div>\n                    </div>\n\n                    {/* Description */}\n                    <div className=\"space-y-2\">\n                        <label htmlFor=\"description\" className=\"text-[10px] font-bold text-foreground/40 uppercase tracking-widest ml-1 flex items-center gap-2\">\n                            <FileText className=\"w-3 h-3\" />\n                            Disbursement Narrative\n                        </label>\n                        <textarea\n                            id=\"description\"\n                            rows={3}\n                            value={formData.description}\n                            onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                            className=\"input w-full bg-secondary/30 p-4 min-h-[100px] leading-relaxed italic\"\n                            placeholder=\"Provide detailed narrative or payee identification for this expenditure entry...\"\n                        />\n                    </div>\n\n                    <div className=\"flex justify-end gap-3 pt-8 border-t border-border/10\">\n                        <button\n                            type=\"button\"\n                            onClick={() => window.history.back()}\n                            className=\"btn btn-secondary px-8 py-3 font-bold uppercase tracking-widest text-[10px]\"\n                        >\n                            Discard Draft\n                        </button>\n                        <button\n                            type=\"submit\"\n                            disabled={saving}\n                            className=\"btn btn-primary flex items-center gap-3 px-10 py-3 font-bold uppercase tracking-widest text-[10px] shadow-xl shadow-destructive/10 transition-all hover:-translate-y-1 bg-destructive hover:bg-destructive/80 border-none\"\n                        >\n                            {saving ? (\n                                <>\n                                    <Loader2 className=\"w-4 h-4 animate-spin\" />\n                                    <span>Syncing Record...</span>\n                                </>\n                            ) : (\n                                <>\n                                    <Check className=\"w-4 h-4\" />\n                                    <span>Commit Expenditure Entry</span>\n                                </>\n                            )}\n                        </button>\n                    </div>\n                </form>\n            </div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\RecordIncome.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Reports\\BalanceSheet.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":2,"message":"React Hook useEffect has a missing dependency: 'loadBalanceSheet'. Either include it or remove the dependency array.","line":17,"column":6,"nodeType":"ArrayExpression","endLine":17,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadBalanceSheet]","fix":{"range":[667,669],"text":"[loadBalanceSheet]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Reports\\ProfitAndLoss.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatPercentage' to the outer scope.","line":41,"column":57,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":41,"endColumn":59}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":2,"message":"React Hook useEffect has a missing dependency: 'loadProfitAndLoss'. Either include it or remove the dependency array.","line":20,"column":6,"nodeType":"ArrayExpression","endLine":20,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadProfitAndLoss]","fix":{"range":[797,799],"text":"[loadProfitAndLoss]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { format } from 'date-fns';\nimport { useState, useEffect } from 'react';\n\nimport { formatCurrencyFromCents } from '../../../utils/format';\n\nimport type { ProfitAndLossReport } from '../../../types/electron-api';\n\nexport default function ProfitAndLossPage() {\n  const [startDate, setStartDate] = useState<string>(\n    format(new Date(new Date().getFullYear(), 0, 1), 'yyyy-MM-dd')\n  );\n  const [endDate, setEndDate] = useState<string>(format(new Date(), 'yyyy-MM-dd'));\n  const [profitAndLoss, setProfitAndLoss] = useState<ProfitAndLossReport | null>(null);\n  const [loading, setLoading] = useState<boolean>(false);\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    void loadProfitAndLoss();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const loadProfitAndLoss = async () => {\n    setLoading(true);\n    setError(null);\n\n    try {\n      const result = await window.electronAPI.getProfitAndLoss(startDate, endDate) as { success: boolean; data: ProfitAndLossReport; message?: string };\n\n      if (result.success) {\n        setProfitAndLoss(result.data);\n      } else {\n        setError(result.message || 'Failed to load P&L');\n      }\n    } catch (err) {\n      setError((err as Error).message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const formatPercentage = (percentage: number): string => {\n    return `${percentage.toFixed(1)}%`;\n  };\n\n  if (loading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"text-gray-500\">Loading Profit & Loss statement...</div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 max-w-7xl mx-auto\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-3xl font-bold text-gray-900\">Profit & Loss Statement</h1>\n        <p className=\"text-gray-600 mt-1\">Income Statement</p>\n      </div>\n\n      <div className=\"bg-white rounded-lg shadow p-4 mb-6\">\n        <div className=\"flex items-center gap-4\">\n          <label htmlFor=\"field-64\" className=\"text-sm font-medium text-gray-700\">Period:</label>\n          <input id=\"field-64\"\n            type=\"date\"\n            value={startDate}\n            onChange={(e) => setStartDate(e.target.value)}\n            className=\"px-3 py-2 border border-gray-300 rounded-md\"\n            aria-label=\"Start date\"\n          />\n          <span className=\"text-gray-500\">to</span>\n          <input\n            type=\"date\"\n            value={endDate}\n            onChange={(e) => setEndDate(e.target.value)}\n            className=\"px-3 py-2 border border-gray-300 rounded-md\"\n            aria-label=\"End date\"\n          />\n          <button\n            onClick={loadProfitAndLoss}\n            className=\"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700\"\n          >\n            Generate\n          </button>\n        </div>\n      </div>\n\n      {error && (\n        <div className=\"bg-red-50 border border-red-200 rounded-lg p-4 mb-6\">\n          <p className=\"text-red-800\">{error}</p>\n        </div>\n      )}\n\n      {profitAndLoss && (\n        <div className=\"bg-white rounded-lg shadow\">\n          <div className=\"p-4 border-b bg-gray-50\">\n            <h3 className=\"font-semibold text-lg\">\n              {format(new Date(profitAndLoss.period_start), 'MMM dd, yyyy')} - {' '}\n              {format(new Date(profitAndLoss.period_end), 'MMM dd, yyyy')}\n            </h3>\n          </div>\n\n          <div className=\"p-6\">\n            {/* Revenue Section */}\n            <div className=\"mb-8\">\n              <h2 className=\"text-xl font-bold mb-4 text-green-700\">REVENUE</h2>\n              <div className=\"space-y-2\">\n                {profitAndLoss.revenue_by_category.map((item, index) => (\n                  <div key={index} className=\"flex justify-between py-2 border-b border-gray-100\">\n                    <div className=\"flex-1\">\n                      <span className=\"text-gray-900\">{item.category}</span>\n                      <span className=\"text-gray-500 text-sm ml-2\">({formatPercentage(item.percentage)})</span>\n                    </div>\n                    <div className=\"text-gray-900 font-medium\">\n                      {formatCurrencyFromCents(item.amount)}\n                    </div>\n                  </div>\n                ))}\n                <div className=\"flex justify-between py-3 border-t-2 border-gray-900 font-bold\">\n                  <span>Total Revenue</span>\n                  <span className=\"text-green-700\">{formatCurrencyFromCents(profitAndLoss.total_revenue)}</span>\n                </div>\n              </div>\n            </div>\n\n            {/* Expenses Section */}\n            <div className=\"mb-8\">\n              <h2 className=\"text-xl font-bold mb-4 text-red-700\">EXPENSES</h2>\n              <div className=\"space-y-2\">\n                {profitAndLoss.expenses_by_category.map((item, index) => (\n                  <div key={index} className=\"flex justify-between py-2 border-b border-gray-100\">\n                    <div className=\"flex-1\">\n                      <span className=\"text-gray-900\">{item.category}</span>\n                      <span className=\"text-gray-500 text-sm ml-2\">({formatPercentage(item.percentage)})</span>\n                    </div>\n                    <div className=\"text-gray-900 font-medium\">\n                      {formatCurrencyFromCents(item.amount)}\n                    </div>\n                  </div>\n                ))}\n                <div className=\"flex justify-between py-3 border-t-2 border-gray-900 font-bold\">\n                  <span>Total Expenses</span>\n                  <span className=\"text-red-700\">{formatCurrencyFromCents(profitAndLoss.total_expenses)}</span>\n                </div>\n              </div>\n            </div>\n\n            {/* Net Profit/Loss */}\n            <div className={`p-4 rounded-lg ${profitAndLoss.net_profit >= 0 ? 'bg-green-50' : 'bg-red-50'}`}>\n              <div className=\"flex justify-between items-center\">\n                <h2 className=\"text-xl font-bold\">\n                  {profitAndLoss.net_profit >= 0 ? 'NET PROFIT' : 'NET LOSS'}\n                </h2>\n                <div className={`text-2xl font-bold ${profitAndLoss.net_profit >= 0 ? 'text-green-700' : 'text-red-700'}`}>\n                  {formatCurrencyFromCents(Math.abs(profitAndLoss.net_profit))}\n                </div>\n              </div>\n              {profitAndLoss.total_revenue > 0 && (\n                <div className=\"text-sm text-gray-600 mt-2\">\n                  Profit Margin: {formatPercentage((profitAndLoss.net_profit / profitAndLoss.total_revenue) * 100)}\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Reports\\TrialBalance.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":2,"message":"React Hook useEffect has a missing dependency: 'loadTrialBalance'. Either include it or remove the dependency array.","line":20,"column":6,"nodeType":"ArrayExpression","endLine":20,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadTrialBalance]","fix":{"range":[791,793],"text":"[loadTrialBalance]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Settings\\GLAccountManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Settings\\OpeningBalanceImport.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\StudentCost\\StudentCostAnalysis.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\Transactions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\components\\LedgerHistory.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\components\\PaymentEntryForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Finance\\components\\StudentLedgerSearch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Inventory\\index.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Login.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Operations\\Boarding\\BoardingProfitability.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Operations\\Transport\\TransportRouteManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Payroll\\PayrollRun.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Payroll\\Staff.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Reports\\ReportCards.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Reports\\ScheduledReports.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Reports\\index.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":2,"message":"React Hook useEffect has a missing dependency: 'loadReportData'. Either include it or remove the dependency array.","line":143,"column":8,"nodeType":"ArrayExpression","endLine":143,"endColumn":33,"suggestions":[{"desc":"Update the dependencies array to be: [dateRange, loadReportData, selectedDate]","fix":{"range":[6051,6076],"text":"[dateRange, loadReportData, selectedDate]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Settings\\Integrations.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Settings\\MessageTemplates.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Settings\\index.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\SetupAdmin.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Students\\Promotions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Students\\StudentForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Students\\index.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\pages\\Users\\index.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\stores\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\InvoiceItem.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\TransactionCategory.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\AcademicAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\AccountingAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\ApprovalAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\AuditAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\AuthAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\BackupAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\BankReconciliationAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\BudgetAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\ExemptionAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\FinanceAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\FixedAssetAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\GLAccountAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\HireAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\InventoryAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\JSSAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\MenuEventAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\MessagingAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\NotificationAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\OpeningBalanceAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\OperationsAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\PayrollAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\ReportsAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\SettingsAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\StaffAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\StudentAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\UpdateAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\UserAPI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\electron-api\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\types\\global.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\utils\\__tests__\\format.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\utils\\__tests__\\utilities.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\utils\\__tests__\\validation.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\utils\\cn.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\utils\\constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\utils\\exporters\\excelExporter.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\utils\\exporters\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\utils\\exporters\\pdfExporter.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\utils\\format.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\src\\utils\\print.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\tailwind.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\tests\\e2e\\fee-payment.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\tests\\e2e\\main-workflows.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\verify_credits.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\vite.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lamec\\Documents\\mwingi-school-erp\\vitest.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]