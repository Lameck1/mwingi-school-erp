import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import Database from 'better-sqlite3';
import { NEMISExportService } from '../NEMISExportService';

vi.mock('../../../database/utils/audit', () => ({
  logAudit: vi.fn(),
}));

vi.mock('../external/nemis-api', () => ({
  validateNEMISData: vi.fn(),
  submitNEMISData: vi.fn(),
}));

describe('NEMISExportService', () => {
  let db: Database.Database;
  let service: NEMISExportService;

  beforeEach(async () => {
    try {
      db = new Database(':memory:');

      // Create schema
      db.exec(`
        CREATE TABLE user (
          id INTEGER PRIMARY KEY,
          username TEXT UNIQUE NOT NULL,
          email TEXT UNIQUE NOT NULL,
          password_hash TEXT NOT NULL,
          first_name TEXT NOT NULL,
          last_name TEXT NOT NULL,
          role TEXT NOT NULL,
          is_active BOOLEAN DEFAULT 1,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        );

        CREATE TABLE school (
          id INTEGER PRIMARY KEY,
          school_code TEXT UNIQUE NOT NULL,
          school_name TEXT NOT NULL,
          location TEXT,
          county TEXT,
          district TEXT,
          principal_name TEXT,
          principal_email TEXT,
          is_active BOOLEAN DEFAULT 1,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        );

        CREATE TABLE student (
          id INTEGER PRIMARY KEY,
          admission_number TEXT UNIQUE NOT NULL,
          first_name TEXT NOT NULL,
          last_name TEXT NOT NULL,
          email TEXT,
          phone_number TEXT,
          date_of_birth TEXT,
          gender TEXT,
          id_number TEXT,
          is_active BOOLEAN DEFAULT 1,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        );

        CREATE TABLE guardian (
          id INTEGER PRIMARY KEY,
          student_id INTEGER NOT NULL,
          first_name TEXT NOT NULL,
          last_name TEXT NOT NULL,
          email TEXT,
          phone_number TEXT,
          relationship TEXT,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (student_id) REFERENCES student(id)
        );

        CREATE TABLE fee_invoice (
          id INTEGER PRIMARY KEY,
          student_id INTEGER NOT NULL,
          invoice_number TEXT UNIQUE NOT NULL,
          amount_due DECIMAL(10,2) NOT NULL,
          amount_paid DECIMAL(10,2) DEFAULT 0,
          due_date TEXT,
          issue_date TEXT,
          status TEXT DEFAULT 'PENDING',
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (student_id) REFERENCES student(id)
        );

        CREATE TABLE transaction_category (
          id INTEGER PRIMARY KEY,
          name TEXT UNIQUE NOT NULL,
          category_type TEXT NOT NULL,
          is_active BOOLEAN DEFAULT 1
        );

        CREATE TABLE ledger_transaction (
          id INTEGER PRIMARY KEY,
          student_id INTEGER NOT NULL,
          transaction_ref TEXT NOT NULL,
          transaction_date TEXT NOT NULL,
          transaction_type TEXT NOT NULL,
          category_id INTEGER NOT NULL,
          amount DECIMAL(10,2) NOT NULL,
          debit_credit TEXT NOT NULL,
          recorded_by_user_id INTEGER NOT NULL,
          is_voided BOOLEAN DEFAULT 0,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (student_id) REFERENCES student(id),
          FOREIGN KEY (category_id) REFERENCES transaction_category(id),
          FOREIGN KEY (recorded_by_user_id) REFERENCES user(id)
        );
      `);

      // Insert test data
      const userStmt = db.prepare(`
        INSERT INTO user (username, email, password_hash, first_name, last_name, role)
        VALUES (?, ?, ?, ?, ?, ?)
      `);
      userStmt.run('testuser', 'test@school.com', 'hash123', 'Test', 'User', 'admin');

      const schoolStmt = db.prepare(`
        INSERT INTO school (school_code, school_name, location, county, district, principal_name, principal_email)
        VALUES (?, ?, ?, ?, ?, ?, ?)
      `);
      schoolStmt.run('SCHOOL-001', 'Mwingi Adventist School', 'Mwingi', 'Kitui', 'Mwingi', 'Dr. John Smith', 'principal@mwingi.school');

      const studentStmt = db.prepare(`
        INSERT INTO student (admission_number, first_name, last_name, email, date_of_birth, gender, id_number)
        VALUES (?, ?, ?, ?, ?, ?, ?)
      `);
      studentStmt.run('STU-001', 'John', 'Doe', 'john@school.com', '2008-05-15', 'M', '123456');
      studentStmt.run('STU-002', 'Jane', 'Smith', 'jane@school.com', '2009-03-20', 'F', '234567');

      const guardianStmt = db.prepare(`
        INSERT INTO guardian (student_id, first_name, last_name, email, phone_number, relationship)
        VALUES (?, ?, ?, ?, ?, ?)
      `);
      guardianStmt.run(1, 'Joseph', 'Doe', 'joseph.doe@email.com', '0712345678', 'Father');
      guardianStmt.run(2, 'Mary', 'Smith', 'mary.smith@email.com', '0723456789', 'Mother');

      const categoryStmt = db.prepare(`
        INSERT INTO transaction_category (name, category_type)
        VALUES (?, ?)
      `);
      categoryStmt.run('Tuition', 'fee');
      categoryStmt.run('Activity Fee', 'fee');
      categoryStmt.run('Exam Fee', 'fee');
      categoryStmt.run('Refund', 'payment');

      const invoiceStmt = db.prepare(`
        INSERT INTO fee_invoice (student_id, invoice_number, amount_due, due_date, issue_date)
        VALUES (?, ?, ?, ?, ?)
      `);
      invoiceStmt.run(1, 'INV-001', 5000, '2025-02-28', '2025-02-01');
      invoiceStmt.run(1, 'INV-002', 3000, '2025-03-31', '2025-03-01');
      invoiceStmt.run(2, 'INV-003', 5000, '2025-02-28', '2025-02-01');

      const txStmt = db.prepare(`
        INSERT INTO ledger_transaction (student_id, transaction_ref, transaction_date, transaction_type, category_id, amount, debit_credit, recorded_by_user_id)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `);
      txStmt.run(1, 'TX-001', '2025-02-05', 'invoice', 1, 5000, 'debit', 1);
      txStmt.run(1, 'TX-002', '2025-02-10', 'payment', 4, 2500, 'credit', 1);
      txStmt.run(1, 'TX-003', '2025-03-05', 'invoice', 2, 3000, 'debit', 1);
      txStmt.run(2, 'TX-004', '2025-02-05', 'invoice', 1, 5000, 'debit', 1);

      service = new NEMISExportService(db);
      console.log('NEMISExportService test database initialized');
    } catch (error) {
      console.error('NEMISExportService beforeEach error:', error);
      throw error;
    }
  });

  afterEach(() => {
    if (db) {
      db.close();
    }
  });

  // extractStudentData tests
  it('should extract student data for single student', async () => {
    try {
      const result = await service.extractStudentData(1);
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include student personal information', async () => {
    try {
      const result = await service.extractStudentData(1);
      expect(result).toBeDefined();
      expect(typeof result === 'object').toBe(true);
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include guardian information in extraction', async () => {
    try {
      const result = await service.extractStudentData(1);
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include fee invoice data', async () => {
    try {
      const result = await service.extractStudentData(1);
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should extract all students data', async () => {
    try {
      const result = await service.extractStudentData();
      expect(result).toBeDefined();
      expect(Array.isArray(result)).toBe(true);
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should handle student with multiple guardians', async () => {
    try {
      const guardianStmt = db.prepare(`
        INSERT INTO guardian (student_id, first_name, last_name, email, phone_number, relationship)
        VALUES (?, ?, ?, ?, ?, ?)
      `);
      guardianStmt.run(1, 'Susan', 'Doe', 'susan@email.com', '0734567890', 'Mother');

      const result = await service.extractStudentData(1);
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should format data for NEMIS submission', async () => {
    try {
      const result = await service.extractStudentData(1);
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  // exportStudentData tests (alias or method variation)
  it('should export student data with all required fields', async () => {
    try {
      const result = await service.extractStudentData(1);
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should handle missing optional fields in export', async () => {
    try {
      const result = await service.extractStudentData(1);
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should validate student ID numbers for export', async () => {
    try {
      const result = await service.extractStudentData(1);
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include academic term information if available', async () => {
    try {
      const result = await service.extractStudentData(1);
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  // extractSchoolData tests
  it('should extract school information for NEMIS', async () => {
    try {
      const result = await service.extractSchoolData();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include school code and name', async () => {
    try {
      const result = await service.extractSchoolData();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include principal information in school data', async () => {
    try {
      const result = await service.extractSchoolData();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include location and administrative data', async () => {
    try {
      const result = await service.extractSchoolData();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  // extractEnrollmentData tests
  it('should extract enrollment data for students', async () => {
    try {
      const result = await service.extractEnrollmentData();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include student count by class', async () => {
    try {
      const result = await service.extractEnrollmentData();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include gender distribution in enrollment', async () => {
    try {
      const result = await service.extractEnrollmentData();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  // extractFinancialData tests
  it('should extract financial data for NEMIS', async () => {
    try {
      const result = await service.extractFinancialData();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include fee structure information', async () => {
    try {
      const result = await service.extractFinancialData();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include payment collection status', async () => {
    try {
      const result = await service.extractFinancialData();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  // validateNEMISFormat tests
  it('should validate extracted data for NEMIS format', async () => {
    try {
      const data = await service.extractStudentData(1);
      const result = await service.validateNEMISFormat(data);
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should check required fields in validation', async () => {
    try {
      const data = await service.extractStudentData(1);
      const result = await service.validateNEMISFormat(data);
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should validate date formats for NEMIS', async () => {
    try {
      const data = await service.extractStudentData(1);
      const result = await service.validateNEMISFormat(data);
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  // generateNEMISReport tests
  it('should generate NEMIS export report', async () => {
    try {
      const result = await service.generateNEMISReport();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include summary statistics in report', async () => {
    try {
      const result = await service.generateNEMISReport();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should include all student records in export', async () => {
    try {
      const result = await service.generateNEMISReport();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should handle large export batches', async () => {
    try {
      const result = await service.generateNEMISReport();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });

  it('should generate export with timestamp', async () => {
    try {
      const result = await service.generateNEMISReport();
      expect(result).toBeDefined();
    } catch (error) {
      console.error('Test error:', error);
      throw error;
    }
  });
});
